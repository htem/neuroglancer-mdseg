function require(x) { throw new Error('Cannot require ' + x) }
(()=>{var EU=Object.create;var nd=Object.defineProperty;var EL=Object.getOwnPropertyDescriptor;var DU=Object.getOwnPropertyNames;var PU=Object.getPrototypeOf,IU=Object.prototype.hasOwnProperty;var DL=n=>nd(n,"__esModule",{value:!0});var Jt=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),yc=(n,e)=>{DL(n);for(var t in e)nd(n,t,{get:e[t],enumerable:!0})},AU=(n,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of DU(e))!IU.call(n,r)&&r!=="default"&&nd(n,r,{get:()=>e[r],enumerable:!(t=EL(e,r))||t.enumerable});return n},ot=n=>AU(DL(nd(n!=null?EU(PU(n)):{},"default",n&&n.__esModule&&"default"in n?{get:()=>n.default,enumerable:!0}:{value:n,enumerable:!0})),n),kt=(n,e,t,r)=>{for(var i=r>1?void 0:r?EL(e,t):e,a=n.length-1,o;a>=0;a--)(o=n[a])&&(i=(r?o(e,t,i):o(i))||i);return r&&i&&nd(e,t,i),i};var Of=Jt((Rq,NL)=>{function MU(n){var e=typeof n;return n!=null&&(e=="object"||e=="function")}NL.exports=MU});var UL=Jt((_q,BL)=>{var RU=typeof window=="object"&&window&&window.Object===Object&&window;BL.exports=RU});var uv=Jt((Vq,FL)=>{var _U=UL(),VU=typeof self=="object"&&self&&self.Object===Object&&self,OU=_U||VU||Function("return this")();FL.exports=OU});var WL=Jt((Oq,GL)=>{var NU=uv(),BU=function(){return NU.Date.now()};GL.exports=BU});var HL=Jt((Nq,zL)=>{var UU=/\s/;function FU(n){for(var e=n.length;e--&&UU.test(n.charAt(e)););return e}zL.exports=FU});var jL=Jt((Bq,$L)=>{var GU=HL(),WU=/^\s+/;function zU(n){return n&&n.slice(0,GU(n)+1).replace(WU,"")}$L.exports=zU});var dv=Jt((Uq,JL)=>{var HU=uv(),$U=HU.Symbol;JL.exports=$U});var XL=Jt((Fq,KL)=>{var qL=dv(),YL=Object.prototype,jU=YL.hasOwnProperty,JU=YL.toString,ad=qL?qL.toStringTag:void 0;function qU(n){var e=jU.call(n,ad),t=n[ad];try{n[ad]=void 0;var r=!0}catch(a){}var i=JU.call(n);return r&&(e?n[ad]=t:delete n[ad]),i}KL.exports=qU});var ZL=Jt((Gq,QL)=>{var YU=Object.prototype,KU=YU.toString;function XU(n){return KU.call(n)}QL.exports=XU});var rk=Jt((Wq,nk)=>{var ek=dv(),QU=XL(),ZU=ZL(),eF="[object Null]",tF="[object Undefined]",tk=ek?ek.toStringTag:void 0;function nF(n){return n==null?n===void 0?tF:eF:tk&&tk in Object(n)?QU(n):ZU(n)}nk.exports=nF});var ak=Jt((zq,ik)=>{function rF(n){return n!=null&&typeof n=="object"}ik.exports=rF});var sk=Jt((Hq,ok)=>{var iF=rk(),aF=ak(),oF="[object Symbol]";function sF(n){return typeof n=="symbol"||aF(n)&&iF(n)==oF}ok.exports=sF});var dk=Jt(($q,uk)=>{var lF=jL(),lk=Of(),cF=sk(),ck=0/0,uF=/^[-+]0x[0-9a-f]+$/i,dF=/^0b[01]+$/i,pF=/^0o[0-7]+$/i,fF=parseInt;function hF(n){if(typeof n=="number")return n;if(cF(n))return ck;if(lk(n)){var e=typeof n.valueOf=="function"?n.valueOf():n;n=lk(e)?e+"":e}if(typeof n!="string")return n===0?n:+n;n=lF(n);var t=dF.test(n);return t||pF.test(n)?fF(n.slice(2),t?2:8):uF.test(n)?ck:+n}uk.exports=hF});var Et=Jt((jq,fk)=>{var mF=Of(),pv=WL(),pk=dk(),gF="Expected a function",yF=Math.max,vF=Math.min;function SF(n,e,t){var r,i,a,o,l,c,d=0,p=!1,m=!1,g=!0;if(typeof n!="function")throw new TypeError(gF);e=pk(e)||0,mF(t)&&(p=!!t.leading,m="maxWait"in t,a=m?yF(pk(t.maxWait)||0,e):a,g="trailing"in t?!!t.trailing:g);function v(E){var V=r,O=i;return r=i=void 0,d=E,o=n.apply(O,V),o}function b(E){return d=E,l=setTimeout(T,e),p?v(E):o}function x(E){var V=E-c,O=E-d,B=e-V;return m?vF(B,a-O):B}function C(E){var V=E-c,O=E-d;return c===void 0||V>=e||V<0||m&&O>=a}function T(){var E=pv();if(C(E))return I(E);l=setTimeout(T,x(E))}function I(E){return l=void 0,g&&r?v(E):(r=i=void 0,o)}function P(){l!==void 0&&clearTimeout(l),d=0,r=c=i=l=void 0}function M(){return l===void 0?o:I(pv())}function D(){var E=pv(),V=C(E);if(r=arguments,i=this,c=E,V){if(l===void 0)return b(c);if(m)return clearTimeout(l),l=setTimeout(T,e),v(c)}return l===void 0&&(l=setTimeout(T,e)),o}return D.cancel=P,D.flush=M,D}fk.exports=SF});var bp=Jt((jfe,bM)=>{var uj=Et(),dj=Of(),pj="Expected a function";function fj(n,e,t){var r=!0,i=!0;if(typeof n!="function")throw new TypeError(pj);return dj(t)&&(r="leading"in t?!!t.leading:r,i="trailing"in t?!!t.trailing:i),uj(n,e,{leading:r,maxWait:e,trailing:i})}bM.exports=fj});var Cs=Jt((FC,GC)=>{(function(n,e){typeof FC=="object"&&typeof GC!="undefined"?GC.exports=e():typeof define=="function"&&define.amd?define(e):(n=n||self,n.CodeMirror=e())})(FC,function(){"use strict";var n=navigator.userAgent,e=navigator.platform,t=/gecko\/\d/i.test(n),r=/MSIE \d/.test(n),i=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(n),a=/Edge\/(\d+)/.exec(n),o=r||i||a,l=o&&(r?document.documentMode||6:+(a||i)[1]),c=!a&&/WebKit\//.test(n),d=c&&/Qt\/\d+\.\d+/.test(n),p=!a&&/Chrome\//.test(n),m=/Opera\//.test(n),g=/Apple Computer/.test(navigator.vendor),v=/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(n),b=/PhantomJS/.test(n),x=g&&(/Mobile\/\w+/.test(n)||navigator.maxTouchPoints>2),C=/Android/.test(n),T=x||C||/webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(n),I=x||/Mac/.test(e),P=/\bCrOS\b/.test(n),M=/win/i.test(e),D=m&&n.match(/Version\/(\d*\.\d*)/);D&&(D=Number(D[1])),D&&D>=15&&(m=!1,c=!0);var E=I&&(d||m&&(D==null||D<12.11)),V=t||o&&l>=9;function O(s){return new RegExp("(^|\\s)"+s+"(?:$|\\s)\\s*")}var B=function(s,u){var h=s.className,f=O(u).exec(h);if(f){var y=h.slice(f.index+f[0].length);s.className=h.slice(0,f.index)+(y?f[1]+y:"")}};function z(s){for(var u=s.childNodes.length;u>0;--u)s.removeChild(s.firstChild);return s}function _(s,u){return z(s).appendChild(u)}function U(s,u,h,f){var y=document.createElement(s);if(h&&(y.className=h),f&&(y.style.cssText=f),typeof u=="string")y.appendChild(document.createTextNode(u));else if(u)for(var S=0;S<u.length;++S)y.appendChild(u[S]);return y}function N(s,u,h,f){var y=U(s,u,h,f);return y.setAttribute("role","presentation"),y}var J;document.createRange?J=function(s,u,h,f){var y=document.createRange();return y.setEnd(f||s,h),y.setStart(s,u),y}:J=function(s,u,h){var f=document.body.createTextRange();try{f.moveToElementText(s.parentNode)}catch(y){return f}return f.collapse(!0),f.moveEnd("character",h),f.moveStart("character",u),f};function ie(s,u){if(u.nodeType==3&&(u=u.parentNode),s.contains)return s.contains(u);do if(u.nodeType==11&&(u=u.host),u==s)return!0;while(u=u.parentNode)}function pe(){var s;try{s=document.activeElement}catch(u){s=document.body||null}for(;s&&s.shadowRoot&&s.shadowRoot.activeElement;)s=s.shadowRoot.activeElement;return s}function me(s,u){var h=s.className;O(u).test(h)||(s.className+=(h?" ":"")+u)}function Pe(s,u){for(var h=s.split(" "),f=0;f<h.length;f++)h[f]&&!O(h[f]).test(u)&&(u+=" "+h[f]);return u}var le=function(s){s.select()};x?le=function(s){s.selectionStart=0,s.selectionEnd=s.value.length}:o&&(le=function(s){try{s.select()}catch(u){}});function we(s){var u=Array.prototype.slice.call(arguments,1);return function(){return s.apply(null,u)}}function Re(s,u,h){u||(u={});for(var f in s)s.hasOwnProperty(f)&&(h!==!1||!u.hasOwnProperty(f))&&(u[f]=s[f]);return u}function Ue(s,u,h,f,y){u==null&&(u=s.search(/[^\s\u00a0]/),u==-1&&(u=s.length));for(var S=f||0,w=y||0;;){var L=s.indexOf("	",S);if(L<0||L>=u)return w+(u-S);w+=L-S,w+=h-w%h,S=L+1}}var et=function(){this.id=null,this.f=null,this.time=0,this.handler=we(this.onTimeout,this)};et.prototype.onTimeout=function(s){s.id=0,s.time<=+new Date?s.f():setTimeout(s.handler,s.time-+new Date)},et.prototype.set=function(s,u){this.f=u;var h=+new Date+s;(!this.id||h<this.time)&&(clearTimeout(this.id),this.id=setTimeout(this.handler,s),this.time=h)};function ye(s,u){for(var h=0;h<s.length;++h)if(s[h]==u)return h;return-1}var ke=50,$e={toString:function(){return"CodeMirror.Pass"}},Je={scroll:!1},tt={origin:"*mouse"},_e={origin:"+move"};function dt(s,u,h){for(var f=0,y=0;;){var S=s.indexOf("	",f);S==-1&&(S=s.length);var w=S-f;if(S==s.length||y+w>=u)return f+Math.min(w,u-y);if(y+=S-f,y+=h-y%h,f=S+1,y>=u)return f}}var jn=[""];function ta(s){for(;jn.length<=s;)jn.push(nt(jn)+" ");return jn[s]}function nt(s){return s[s.length-1]}function Er(s,u){for(var h=[],f=0;f<s.length;f++)h[f]=u(s[f],f);return h}function na(s,u,h){for(var f=0,y=h(u);f<s.length&&h(s[f])<=y;)f++;s.splice(f,0,u)}function ra(){}function ia(s,u){var h;return Object.create?h=Object.create(s):(ra.prototype=s,h=new ra),u&&Re(u,h),h}var aa=/[\u00df\u0587\u0590-\u05f4\u0600-\u06ff\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/;function oi(s){return/\w/.test(s)||s>"\x80"&&(s.toUpperCase()!=s.toLowerCase()||aa.test(s))}function Ei(s,u){return u?u.source.indexOf("\\w")>-1&&oi(s)?!0:u.test(s):oi(s)}function Ga(s){for(var u in s)if(s.hasOwnProperty(u)&&s[u])return!1;return!0}var ko=/[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/;function $l(s){return s.charCodeAt(0)>=768&&ko.test(s)}function Eo(s,u,h){for(;(h<0?u>0:u<s.length)&&$l(s.charAt(u));)u+=h;return u}function Rn(s,u,h){for(var f=u>h?-1:1;;){if(u==h)return u;var y=(u+h)/2,S=f<0?Math.ceil(y):Math.floor(y);if(S==u)return s(S)?u:h;s(S)?h=S:u=S+f}}function bu(s,u,h,f){if(!s)return f(u,h,"ltr",0);for(var y=!1,S=0;S<s.length;++S){var w=s[S];(w.from<h&&w.to>u||u==h&&w.to==u)&&(f(Math.max(w.from,u),Math.min(w.to,h),w.level==1?"rtl":"ltr",S),y=!0)}y||f(u,h,"ltr")}var lr=null;function Lt(s,u,h){var f;lr=null;for(var y=0;y<s.length;++y){var S=s[y];if(S.from<u&&S.to>u)return y;S.to==u&&(S.from!=S.to&&h=="before"?f=y:lr=y),S.from==u&&(S.from!=S.to&&h!="before"?f=y:lr=y)}return f!=null?f:lr}var As=function(){var s="bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN",u="nnnnnnNNr%%r,rNNmmmmmmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmmmnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmnNmmmmmmrrmmNmmmmrr1111111111";function h(A){return A<=247?s.charAt(A):1424<=A&&A<=1524?"R":1536<=A&&A<=1785?u.charAt(A-1536):1774<=A&&A<=2220?"r":8192<=A&&A<=8203?"w":A==8204?"b":"L"}var f=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/,y=/[stwN]/,S=/[LRr]/,w=/[Lb1n]/,L=/[1n]/;function k(A,F,H){this.level=A,this.from=F,this.to=H}return function(A,F){var H=F=="ltr"?"L":"R";if(A.length==0||F=="ltr"&&!f.test(A))return!1;for(var Y=A.length,q=[],ee=0;ee<Y;++ee)q.push(h(A.charCodeAt(ee)));for(var ne=0,de=H;ne<Y;++ne){var fe=q[ne];fe=="m"?q[ne]=de:de=fe}for(var Se=0,he=H;Se<Y;++Se){var be=q[Se];be=="1"&&he=="r"?q[Se]="n":S.test(be)&&(he=be,be=="r"&&(q[Se]="R"))}for(var Ae=1,De=q[0];Ae<Y-1;++Ae){var Xe=q[Ae];Xe=="+"&&De=="1"&&q[Ae+1]=="1"?q[Ae]="1":Xe==","&&De==q[Ae+1]&&(De=="1"||De=="n")&&(q[Ae]=De),De=Xe}for(var Ct=0;Ct<Y;++Ct){var fn=q[Ct];if(fn==",")q[Ct]="N";else if(fn=="%"){var Nt=void 0;for(Nt=Ct+1;Nt<Y&&q[Nt]=="%";++Nt);for(var Ar=Ct&&q[Ct-1]=="!"||Nt<Y&&q[Nt]=="1"?"1":"N",fr=Ct;fr<Nt;++fr)q[fr]=Ar;Ct=Nt-1}}for(var en=0,hr=H;en<Y;++en){var kn=q[en];hr=="L"&&kn=="1"?q[en]="L":S.test(kn)&&(hr=kn)}for(var nn=0;nn<Y;++nn)if(y.test(q[nn])){var tn=void 0;for(tn=nn+1;tn<Y&&y.test(q[tn]);++tn);for(var Gt=(nn?q[nn-1]:H)=="L",mr=(tn<Y?q[tn]:H)=="L",mc=Gt==mr?Gt?"L":"R":H,Bo=nn;Bo<tn;++Bo)q[Bo]=mc;nn=tn-1}for(var Nn=[],ha,hn=0;hn<Y;)if(w.test(q[hn])){var sv=hn;for(++hn;hn<Y&&w.test(q[hn]);++hn);Nn.push(new k(0,sv,hn))}else{var qa=hn,Ws=Nn.length,zs=F=="rtl"?1:0;for(++hn;hn<Y&&q[hn]!="L";++hn);for(var qn=qa;qn<hn;)if(L.test(q[qn])){qa<qn&&(Nn.splice(Ws,0,new k(1,qa,qn)),Ws+=zs);var gc=qn;for(++qn;qn<hn&&L.test(q[qn]);++qn);Nn.splice(Ws,0,new k(2,gc,qn)),Ws+=zs,qa=qn}else++qn;qa<hn&&Nn.splice(Ws,0,new k(1,qa,hn))}return F=="ltr"&&(Nn[0].level==1&&(ha=A.match(/^\s+/))&&(Nn[0].from=ha[0].length,Nn.unshift(new k(0,0,ha[0].length))),nt(Nn).level==1&&(ha=A.match(/\s+$/))&&(nt(Nn).to-=ha[0].length,Nn.push(new k(0,Y-ha[0].length,Y)))),F=="rtl"?Nn.reverse():Nn}}();function Dr(s,u){var h=s.order;return h==null&&(h=s.order=As(s.text,u)),h}var Wa=[],Ve=function(s,u,h){if(s.addEventListener)s.addEventListener(u,h,!1);else if(s.attachEvent)s.attachEvent("on"+u,h);else{var f=s._handlers||(s._handlers={});f[u]=(f[u]||Wa).concat(h)}};function jl(s,u){return s._handlers&&s._handlers[u]||Wa}function cr(s,u,h){if(s.removeEventListener)s.removeEventListener(u,h,!1);else if(s.detachEvent)s.detachEvent("on"+u,h);else{var f=s._handlers,y=f&&f[u];if(y){var S=ye(y,h);S>-1&&(f[u]=y.slice(0,S).concat(y.slice(S+1)))}}}function Fe(s,u){var h=jl(s,u);if(!!h.length)for(var f=Array.prototype.slice.call(arguments,2),y=0;y<h.length;++y)h[y].apply(null,f)}function Zt(s,u,h){return typeof u=="string"&&(u={type:u,preventDefault:function(){this.defaultPrevented=!0}}),Fe(s,h||u.type,s,u),Wr(u)||u.codemirrorIgnore}function Jl(s){var u=s._handlers&&s._handlers.cursorActivity;if(!!u)for(var h=s.curOp.cursorActivityHandlers||(s.curOp.cursorActivityHandlers=[]),f=0;f<u.length;++f)ye(h,u[f])==-1&&h.push(u[f])}function Ln(s,u){return jl(s,u).length>0}function oa(s){s.prototype.on=function(u,h){Ve(this,u,h)},s.prototype.off=function(u,h){cr(this,u,h)}}function _n(s){s.preventDefault?s.preventDefault():s.returnValue=!1}function ql(s){s.stopPropagation?s.stopPropagation():s.cancelBubble=!0}function Wr(s){return s.defaultPrevented!=null?s.defaultPrevented:s.returnValue==!1}function Ms(s){_n(s),ql(s)}function Do(s){return s.target||s.srcElement}function tf(s){var u=s.which;return u==null&&(s.button&1?u=1:s.button&2?u=3:s.button&4&&(u=2)),I&&s.ctrlKey&&u==1&&(u=3),u}var xu=function(){if(o&&l<9)return!1;var s=U("div");return"draggable"in s||"dragDrop"in s}(),ur;function nf(s){if(ur==null){var u=U("span","\u200B");_(s,U("span",[u,document.createTextNode("x")])),s.firstChild.offsetHeight!=0&&(ur=u.offsetWidth<=1&&u.offsetHeight>2&&!(o&&l<8))}var h=ur?U("span","\u200B"):U("span","\xA0",null,"display: inline-block; width: 1px; margin-right: -1px");return h.setAttribute("cm-text",""),h}var Cu;function sa(s){if(Cu!=null)return Cu;var u=_(s,document.createTextNode("A\u062EA")),h=J(u,0,1).getBoundingClientRect(),f=J(u,1,2).getBoundingClientRect();return z(s),!h||h.left==h.right?!1:Cu=f.right-h.right<3}var wu=`

b`.split(/\n/).length!=3?function(s){for(var u=0,h=[],f=s.length;u<=f;){var y=s.indexOf(`
`,u);y==-1&&(y=s.length);var S=s.slice(u,s.charAt(y-1)=="\r"?y-1:y),w=S.indexOf("\r");w!=-1?(h.push(S.slice(0,w)),u+=w+1):(h.push(S),u=y+1)}return h}:function(s){return s.split(/\r\n?|\n/)},rf=window.getSelection?function(s){try{return s.selectionStart!=s.selectionEnd}catch(u){return!1}}:function(s){var u;try{u=s.ownerDocument.selection.createRange()}catch(h){}return!u||u.parentElement()!=s?!1:u.compareEndPoints("StartToEnd",u)!=0},af=function(){var s=U("div");return"oncopy"in s?!0:(s.setAttribute("oncopy","return;"),typeof s.oncopy=="function")}(),Tu=null;function Po(s){if(Tu!=null)return Tu;var u=_(s,U("span","x")),h=u.getBoundingClientRect(),f=J(u,0,1).getBoundingClientRect();return Tu=Math.abs(h.left-f.left)>1}var si={},zr={};function of(s,u){arguments.length>2&&(u.dependencies=Array.prototype.slice.call(arguments,2)),si[s]=u}function za(s,u){zr[s]=u}function Yl(s){if(typeof s=="string"&&zr.hasOwnProperty(s))s=zr[s];else if(s&&typeof s.name=="string"&&zr.hasOwnProperty(s.name)){var u=zr[s.name];typeof u=="string"&&(u={name:u}),s=ia(u,s),s.name=u.name}else{if(typeof s=="string"&&/^[\w\-]+\/[\w\-]+\+xml$/.test(s))return Yl("application/xml");if(typeof s=="string"&&/^[\w\-]+\/[\w\-]+\+json$/.test(s))return Yl("application/json")}return typeof s=="string"?{name:s}:s||{name:"null"}}function Kl(s,u){u=Yl(u);var h=si[u.name];if(!h)return Kl(s,"text/plain");var f=h(s,u);if(Di.hasOwnProperty(u.name)){var y=Di[u.name];for(var S in y)!y.hasOwnProperty(S)||(f.hasOwnProperty(S)&&(f["_"+S]=f[S]),f[S]=y[S])}if(f.name=u.name,u.helperType&&(f.helperType=u.helperType),u.modeProps)for(var w in u.modeProps)f[w]=u.modeProps[w];return f}var Di={};function Pi(s,u){var h=Di.hasOwnProperty(s)?Di[s]:Di[s]={};Re(u,h)}function Hr(s,u){if(u===!0)return u;if(s.copyState)return s.copyState(u);var h={};for(var f in u){var y=u[f];y instanceof Array&&(y=y.concat([])),h[f]=y}return h}function Lu(s,u){for(var h;s.innerMode&&(h=s.innerMode(u),!(!h||h.mode==s));)u=h.state,s=h.mode;return h||{mode:s,state:u}}function ku(s,u,h){return s.startState?s.startState(u,h):!0}var Ft=function(s,u,h){this.pos=this.start=0,this.string=s,this.tabSize=u||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0,this.lineOracle=h};Ft.prototype.eol=function(){return this.pos>=this.string.length},Ft.prototype.sol=function(){return this.pos==this.lineStart},Ft.prototype.peek=function(){return this.string.charAt(this.pos)||void 0},Ft.prototype.next=function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},Ft.prototype.eat=function(s){var u=this.string.charAt(this.pos),h;if(typeof s=="string"?h=u==s:h=u&&(s.test?s.test(u):s(u)),h)return++this.pos,u},Ft.prototype.eatWhile=function(s){for(var u=this.pos;this.eat(s););return this.pos>u},Ft.prototype.eatSpace=function(){for(var s=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>s},Ft.prototype.skipToEnd=function(){this.pos=this.string.length},Ft.prototype.skipTo=function(s){var u=this.string.indexOf(s,this.pos);if(u>-1)return this.pos=u,!0},Ft.prototype.backUp=function(s){this.pos-=s},Ft.prototype.column=function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=Ue(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?Ue(this.string,this.lineStart,this.tabSize):0)},Ft.prototype.indentation=function(){return Ue(this.string,null,this.tabSize)-(this.lineStart?Ue(this.string,this.lineStart,this.tabSize):0)},Ft.prototype.match=function(s,u,h){if(typeof s=="string"){var f=function(w){return h?w.toLowerCase():w},y=this.string.substr(this.pos,s.length);if(f(y)==f(s))return u!==!1&&(this.pos+=s.length),!0}else{var S=this.string.slice(this.pos).match(s);return S&&S.index>0?null:(S&&u!==!1&&(this.pos+=S[0].length),S)}},Ft.prototype.current=function(){return this.string.slice(this.start,this.pos)},Ft.prototype.hideFirstChars=function(s,u){this.lineStart+=s;try{return u()}finally{this.lineStart-=s}},Ft.prototype.lookAhead=function(s){var u=this.lineOracle;return u&&u.lookAhead(s)},Ft.prototype.baseToken=function(){var s=this.lineOracle;return s&&s.baseToken(this.pos)};function Te(s,u){if(u-=s.first,u<0||u>=s.size)throw new Error("There is no line "+(u+s.first)+" in the document.");for(var h=s;!h.lines;)for(var f=0;;++f){var y=h.children[f],S=y.chunkSize();if(u<S){h=y;break}u-=S}return h.lines[u]}function la(s,u,h){var f=[],y=u.line;return s.iter(u.line,h.line+1,function(S){var w=S.text;y==h.line&&(w=w.slice(0,h.ch)),y==u.line&&(w=w.slice(u.ch)),f.push(w),++y}),f}function Eu(s,u,h){var f=[];return s.iter(u,h,function(y){f.push(y.text)}),f}function Pr(s,u){var h=u-s.height;if(h)for(var f=s;f;f=f.parent)f.height+=h}function ft(s){if(s.parent==null)return null;for(var u=s.parent,h=ye(u.lines,s),f=u.parent;f;u=f,f=f.parent)for(var y=0;f.children[y]!=u;++y)h+=f.children[y].chunkSize();return h+u.first}function ca(s,u){var h=s.first;e:do{for(var f=0;f<s.children.length;++f){var y=s.children[f],S=y.height;if(u<S){s=y;continue e}u-=S,h+=y.chunkSize()}return h}while(!s.lines);for(var w=0;w<s.lines.length;++w){var L=s.lines[w],k=L.height;if(u<k)break;u-=k}return h+w}function Rs(s,u){return u>=s.first&&u<s.first+s.size}function Du(s,u){return String(s.lineNumberFormatter(u+s.firstLineNumber))}function se(s,u,h){if(h===void 0&&(h=null),!(this instanceof se))return new se(s,u,h);this.line=s,this.ch=u,this.sticky=h}function R(s,u){return s.line-u.line||s.ch-u.ch}function $(s,u){return s.sticky==u.sticky&&R(s,u)==0}function te(s){return se(s.line,s.ch)}function ue(s,u){return R(s,u)<0?u:s}function Ge(s,u){return R(s,u)<0?s:u}function st(s,u){return Math.max(s.first,Math.min(u,s.first+s.size-1))}function ve(s,u){if(u.line<s.first)return se(s.first,0);var h=s.first+s.size-1;return u.line>h?se(h,Te(s,h).text.length):Vn(u,Te(s,u.line).text.length)}function Vn(s,u){var h=s.ch;return h==null||h>u?se(s.line,u):h<0?se(s.line,0):s}function $r(s,u){for(var h=[],f=0;f<u.length;f++)h[f]=ve(s,u[f]);return h}var Xl=function(s,u){this.state=s,this.lookAhead=u},ua=function(s,u,h,f){this.state=u,this.doc=s,this.line=h,this.maxLookAhead=f||0,this.baseTokens=null,this.baseTokenPos=1};ua.prototype.lookAhead=function(s){var u=this.doc.getLine(this.line+s);return u!=null&&s>this.maxLookAhead&&(this.maxLookAhead=s),u},ua.prototype.baseToken=function(s){if(!this.baseTokens)return null;for(;this.baseTokens[this.baseTokenPos]<=s;)this.baseTokenPos+=2;var u=this.baseTokens[this.baseTokenPos+1];return{type:u&&u.replace(/( |^)overlay .*/,""),size:this.baseTokens[this.baseTokenPos]-s}},ua.prototype.nextLine=function(){this.line++,this.maxLookAhead>0&&this.maxLookAhead--},ua.fromSaved=function(s,u,h){return u instanceof Xl?new ua(s,Hr(s.mode,u.state),h,u.lookAhead):new ua(s,Hr(s.mode,u),h)},ua.prototype.save=function(s){var u=s!==!1?Hr(this.doc.mode,this.state):this.state;return this.maxLookAhead>0?new Xl(u,this.maxLookAhead):u};function D0(s,u,h,f){var y=[s.state.modeGen],S={};_0(s,u.text,s.doc.mode,h,function(A,F){return y.push(A,F)},S,f);for(var w=h.state,L=function(A){h.baseTokens=y;var F=s.state.overlays[A],H=1,Y=0;h.state=!0,_0(s,u.text,F.mode,h,function(q,ee){for(var ne=H;Y<q;){var de=y[H];de>q&&y.splice(H,1,q,y[H+1],de),H+=2,Y=Math.min(q,de)}if(!!ee)if(F.opaque)y.splice(ne,H-ne,q,"overlay "+ee),H=ne+2;else for(;ne<H;ne+=2){var fe=y[ne+1];y[ne+1]=(fe?fe+" ":"")+"overlay "+ee}},S),h.state=w,h.baseTokens=null,h.baseTokenPos=1},k=0;k<s.state.overlays.length;++k)L(k);return{styles:y,classes:S.bgClass||S.textClass?S:null}}function P0(s,u,h){if(!u.styles||u.styles[0]!=s.state.modeGen){var f=Pu(s,ft(u)),y=u.text.length>s.options.maxHighlightLength&&Hr(s.doc.mode,f.state),S=D0(s,u,f);y&&(f.state=y),u.stateAfter=f.save(!y),u.styles=S.styles,S.classes?u.styleClasses=S.classes:u.styleClasses&&(u.styleClasses=null),h===s.doc.highlightFrontier&&(s.doc.modeFrontier=Math.max(s.doc.modeFrontier,++s.doc.highlightFrontier))}return u.styles}function Pu(s,u,h){var f=s.doc,y=s.display;if(!f.mode.startState)return new ua(f,!0,u);var S=PN(s,u,h),w=S>f.first&&Te(f,S-1).stateAfter,L=w?ua.fromSaved(f,w,S):new ua(f,ku(f.mode),S);return f.iter(S,u,function(k){yy(s,k.text,L);var A=L.line;k.stateAfter=A==u-1||A%5==0||A>=y.viewFrom&&A<y.viewTo?L.save():null,L.nextLine()}),h&&(f.modeFrontier=L.line),L}function yy(s,u,h,f){var y=s.doc.mode,S=new Ft(u,s.options.tabSize,h);for(S.start=S.pos=f||0,u==""&&I0(y,h.state);!S.eol();)vy(y,S,h.state),S.start=S.pos}function I0(s,u){if(s.blankLine)return s.blankLine(u);if(!!s.innerMode){var h=Lu(s,u);if(h.mode.blankLine)return h.mode.blankLine(h.state)}}function vy(s,u,h,f){for(var y=0;y<10;y++){f&&(f[0]=Lu(s,h).mode);var S=s.token(u,h);if(u.pos>u.start)return S}throw new Error("Mode "+s.name+" failed to advance stream.")}var A0=function(s,u,h){this.start=s.start,this.end=s.pos,this.string=s.current(),this.type=u||null,this.state=h};function M0(s,u,h,f){var y=s.doc,S=y.mode,w;u=ve(y,u);var L=Te(y,u.line),k=Pu(s,u.line,h),A=new Ft(L.text,s.options.tabSize,k),F;for(f&&(F=[]);(f||A.pos<u.ch)&&!A.eol();)A.start=A.pos,w=vy(S,A,k.state),f&&F.push(new A0(A,w,Hr(y.mode,k.state)));return f?F:new A0(A,w,k.state)}function R0(s,u){if(s)for(;;){var h=s.match(/(?:^|\s+)line-(background-)?(\S+)/);if(!h)break;s=s.slice(0,h.index)+s.slice(h.index+h[0].length);var f=h[1]?"bgClass":"textClass";u[f]==null?u[f]=h[2]:new RegExp("(?:^|\\s)"+h[2]+"(?:$|\\s)").test(u[f])||(u[f]+=" "+h[2])}return s}function _0(s,u,h,f,y,S,w){var L=h.flattenSpans;L==null&&(L=s.options.flattenSpans);var k=0,A=null,F=new Ft(u,s.options.tabSize,f),H,Y=s.options.addModeClass&&[null];for(u==""&&R0(I0(h,f.state),S);!F.eol();){if(F.pos>s.options.maxHighlightLength?(L=!1,w&&yy(s,u,f,F.pos),F.pos=u.length,H=null):H=R0(vy(h,F,f.state,Y),S),Y){var q=Y[0].name;q&&(H="m-"+(H?q+" "+H:q))}if(!L||A!=H){for(;k<F.start;)k=Math.min(F.start,k+5e3),y(k,A);A=H}F.start=F.pos}for(;k<F.pos;){var ee=Math.min(F.pos,k+5e3);y(ee,A),k=ee}}function PN(s,u,h){for(var f,y,S=s.doc,w=h?-1:u-(s.doc.mode.innerMode?1e3:100),L=u;L>w;--L){if(L<=S.first)return S.first;var k=Te(S,L-1),A=k.stateAfter;if(A&&(!h||L+(A instanceof Xl?A.lookAhead:0)<=S.modeFrontier))return L;var F=Ue(k.text,null,s.options.tabSize);(y==null||f>F)&&(y=L-1,f=F)}return y}function IN(s,u){if(s.modeFrontier=Math.min(s.modeFrontier,u),!(s.highlightFrontier<u-10)){for(var h=s.first,f=u-1;f>h;f--){var y=Te(s,f).stateAfter;if(y&&(!(y instanceof Xl)||f+y.lookAhead<u)){h=f+1;break}}s.highlightFrontier=Math.min(s.highlightFrontier,h)}}var V0=!1,Ha=!1;function AN(){V0=!0}function MN(){Ha=!0}function sf(s,u,h){this.marker=s,this.from=u,this.to=h}function Iu(s,u){if(s)for(var h=0;h<s.length;++h){var f=s[h];if(f.marker==u)return f}}function RN(s,u){for(var h,f=0;f<s.length;++f)s[f]!=u&&(h||(h=[])).push(s[f]);return h}function _N(s,u,h){var f=h&&window.WeakSet&&(h.markedSpans||(h.markedSpans=new WeakSet));f&&f.has(s.markedSpans)?s.markedSpans.push(u):(s.markedSpans=s.markedSpans?s.markedSpans.concat([u]):[u],f&&f.add(s.markedSpans)),u.marker.attachLine(s)}function VN(s,u,h){var f;if(s)for(var y=0;y<s.length;++y){var S=s[y],w=S.marker,L=S.from==null||(w.inclusiveLeft?S.from<=u:S.from<u);if(L||S.from==u&&w.type=="bookmark"&&(!h||!S.marker.insertLeft)){var k=S.to==null||(w.inclusiveRight?S.to>=u:S.to>u);(f||(f=[])).push(new sf(w,S.from,k?null:S.to))}}return f}function ON(s,u,h){var f;if(s)for(var y=0;y<s.length;++y){var S=s[y],w=S.marker,L=S.to==null||(w.inclusiveRight?S.to>=u:S.to>u);if(L||S.from==u&&w.type=="bookmark"&&(!h||S.marker.insertLeft)){var k=S.from==null||(w.inclusiveLeft?S.from<=u:S.from<u);(f||(f=[])).push(new sf(w,k?null:S.from-u,S.to==null?null:S.to-u))}}return f}function Sy(s,u){if(u.full)return null;var h=Rs(s,u.from.line)&&Te(s,u.from.line).markedSpans,f=Rs(s,u.to.line)&&Te(s,u.to.line).markedSpans;if(!h&&!f)return null;var y=u.from.ch,S=u.to.ch,w=R(u.from,u.to)==0,L=VN(h,y,w),k=ON(f,S,w),A=u.text.length==1,F=nt(u.text).length+(A?y:0);if(L)for(var H=0;H<L.length;++H){var Y=L[H];if(Y.to==null){var q=Iu(k,Y.marker);q?A&&(Y.to=q.to==null?null:q.to+F):Y.to=y}}if(k)for(var ee=0;ee<k.length;++ee){var ne=k[ee];if(ne.to!=null&&(ne.to+=F),ne.from==null){var de=Iu(L,ne.marker);de||(ne.from=F,A&&(L||(L=[])).push(ne))}else ne.from+=F,A&&(L||(L=[])).push(ne)}L&&(L=O0(L)),k&&k!=L&&(k=O0(k));var fe=[L];if(!A){var Se=u.text.length-2,he;if(Se>0&&L)for(var be=0;be<L.length;++be)L[be].to==null&&(he||(he=[])).push(new sf(L[be].marker,null,null));for(var Ae=0;Ae<Se;++Ae)fe.push(he);fe.push(k)}return fe}function O0(s){for(var u=0;u<s.length;++u){var h=s[u];h.from!=null&&h.from==h.to&&h.marker.clearWhenEmpty!==!1&&s.splice(u--,1)}return s.length?s:null}function NN(s,u,h){var f=null;if(s.iter(u.line,h.line+1,function(q){if(q.markedSpans)for(var ee=0;ee<q.markedSpans.length;++ee){var ne=q.markedSpans[ee].marker;ne.readOnly&&(!f||ye(f,ne)==-1)&&(f||(f=[])).push(ne)}}),!f)return null;for(var y=[{from:u,to:h}],S=0;S<f.length;++S)for(var w=f[S],L=w.find(0),k=0;k<y.length;++k){var A=y[k];if(!(R(A.to,L.from)<0||R(A.from,L.to)>0)){var F=[k,1],H=R(A.from,L.from),Y=R(A.to,L.to);(H<0||!w.inclusiveLeft&&!H)&&F.push({from:A.from,to:L.from}),(Y>0||!w.inclusiveRight&&!Y)&&F.push({from:L.to,to:A.to}),y.splice.apply(y,F),k+=F.length-3}}return y}function N0(s){var u=s.markedSpans;if(!!u){for(var h=0;h<u.length;++h)u[h].marker.detachLine(s);s.markedSpans=null}}function B0(s,u){if(!!u){for(var h=0;h<u.length;++h)u[h].marker.attachLine(s);s.markedSpans=u}}function lf(s){return s.inclusiveLeft?-1:0}function cf(s){return s.inclusiveRight?1:0}function by(s,u){var h=s.lines.length-u.lines.length;if(h!=0)return h;var f=s.find(),y=u.find(),S=R(f.from,y.from)||lf(s)-lf(u);if(S)return-S;var w=R(f.to,y.to)||cf(s)-cf(u);return w||u.id-s.id}function U0(s,u){var h=Ha&&s.markedSpans,f;if(h)for(var y=void 0,S=0;S<h.length;++S)y=h[S],y.marker.collapsed&&(u?y.from:y.to)==null&&(!f||by(f,y.marker)<0)&&(f=y.marker);return f}function F0(s){return U0(s,!0)}function uf(s){return U0(s,!1)}function BN(s,u){var h=Ha&&s.markedSpans,f;if(h)for(var y=0;y<h.length;++y){var S=h[y];S.marker.collapsed&&(S.from==null||S.from<u)&&(S.to==null||S.to>u)&&(!f||by(f,S.marker)<0)&&(f=S.marker)}return f}function G0(s,u,h,f,y){var S=Te(s,u),w=Ha&&S.markedSpans;if(w)for(var L=0;L<w.length;++L){var k=w[L];if(!!k.marker.collapsed){var A=k.marker.find(0),F=R(A.from,h)||lf(k.marker)-lf(y),H=R(A.to,f)||cf(k.marker)-cf(y);if(!(F>=0&&H<=0||F<=0&&H>=0)&&(F<=0&&(k.marker.inclusiveRight&&y.inclusiveLeft?R(A.to,h)>=0:R(A.to,h)>0)||F>=0&&(k.marker.inclusiveRight&&y.inclusiveLeft?R(A.from,f)<=0:R(A.from,f)<0)))return!0}}}function da(s){for(var u;u=F0(s);)s=u.find(-1,!0).line;return s}function UN(s){for(var u;u=uf(s);)s=u.find(1,!0).line;return s}function FN(s){for(var u,h;u=uf(s);)s=u.find(1,!0).line,(h||(h=[])).push(s);return h}function xy(s,u){var h=Te(s,u),f=da(h);return h==f?u:ft(f)}function W0(s,u){if(u>s.lastLine())return u;var h=Te(s,u),f;if(!Io(s,h))return u;for(;f=uf(h);)h=f.find(1,!0).line;return ft(h)+1}function Io(s,u){var h=Ha&&u.markedSpans;if(h){for(var f=void 0,y=0;y<h.length;++y)if(f=h[y],!!f.marker.collapsed){if(f.from==null)return!0;if(!f.marker.widgetNode&&f.from==0&&f.marker.inclusiveLeft&&Cy(s,u,f))return!0}}}function Cy(s,u,h){if(h.to==null){var f=h.marker.find(1,!0);return Cy(s,f.line,Iu(f.line.markedSpans,h.marker))}if(h.marker.inclusiveRight&&h.to==u.text.length)return!0;for(var y=void 0,S=0;S<u.markedSpans.length;++S)if(y=u.markedSpans[S],y.marker.collapsed&&!y.marker.widgetNode&&y.from==h.to&&(y.to==null||y.to!=h.from)&&(y.marker.inclusiveLeft||h.marker.inclusiveRight)&&Cy(s,u,y))return!0}function $a(s){s=da(s);for(var u=0,h=s.parent,f=0;f<h.lines.length;++f){var y=h.lines[f];if(y==s)break;u+=y.height}for(var S=h.parent;S;h=S,S=h.parent)for(var w=0;w<S.children.length;++w){var L=S.children[w];if(L==h)break;u+=L.height}return u}function df(s){if(s.height==0)return 0;for(var u=s.text.length,h,f=s;h=F0(f);){var y=h.find(0,!0);f=y.from.line,u+=y.from.ch-y.to.ch}for(f=s;h=uf(f);){var S=h.find(0,!0);u-=f.text.length-S.from.ch,f=S.to.line,u+=f.text.length-S.to.ch}return u}function wy(s){var u=s.display,h=s.doc;u.maxLine=Te(h,h.first),u.maxLineLength=df(u.maxLine),u.maxLineChanged=!0,h.iter(function(f){var y=df(f);y>u.maxLineLength&&(u.maxLineLength=y,u.maxLine=f)})}var Ql=function(s,u,h){this.text=s,B0(this,u),this.height=h?h(this):1};Ql.prototype.lineNo=function(){return ft(this)},oa(Ql);function GN(s,u,h,f){s.text=u,s.stateAfter&&(s.stateAfter=null),s.styles&&(s.styles=null),s.order!=null&&(s.order=null),N0(s),B0(s,h);var y=f?f(s):1;y!=s.height&&Pr(s,y)}function WN(s){s.parent=null,N0(s)}var zN={},HN={};function z0(s,u){if(!s||/^\s*$/.test(s))return null;var h=u.addModeClass?HN:zN;return h[s]||(h[s]=s.replace(/\S+/g,"cm-$&"))}function H0(s,u){var h=N("span",null,null,c?"padding-right: .1px":null),f={pre:N("pre",[h],"CodeMirror-line"),content:h,col:0,pos:0,cm:s,trailingSpace:!1,splitSpaces:s.getOption("lineWrapping")};u.measure={};for(var y=0;y<=(u.rest?u.rest.length:0);y++){var S=y?u.rest[y-1]:u.line,w=void 0;f.pos=0,f.addToken=jN,sa(s.display.measure)&&(w=Dr(S,s.doc.direction))&&(f.addToken=qN(f.addToken,w)),f.map=[];var L=u!=s.display.externalMeasured&&ft(S);YN(S,f,P0(s,S,L)),S.styleClasses&&(S.styleClasses.bgClass&&(f.bgClass=Pe(S.styleClasses.bgClass,f.bgClass||"")),S.styleClasses.textClass&&(f.textClass=Pe(S.styleClasses.textClass,f.textClass||""))),f.map.length==0&&f.map.push(0,0,f.content.appendChild(nf(s.display.measure))),y==0?(u.measure.map=f.map,u.measure.cache={}):((u.measure.maps||(u.measure.maps=[])).push(f.map),(u.measure.caches||(u.measure.caches=[])).push({}))}if(c){var k=f.content.lastChild;(/\bcm-tab\b/.test(k.className)||k.querySelector&&k.querySelector(".cm-tab"))&&(f.content.className="cm-tab-wrap-hack")}return Fe(s,"renderLine",s,u.line,f.pre),f.pre.className&&(f.textClass=Pe(f.pre.className,f.textClass||"")),f}function $N(s){var u=U("span","\u2022","cm-invalidchar");return u.title="\\u"+s.charCodeAt(0).toString(16),u.setAttribute("aria-label",u.title),u}function jN(s,u,h,f,y,S,w){if(!!u){var L=s.splitSpaces?JN(u,s.trailingSpace):u,k=s.cm.state.specialChars,A=!1,F;if(!k.test(u))s.col+=u.length,F=document.createTextNode(L),s.map.push(s.pos,s.pos+u.length,F),o&&l<9&&(A=!0),s.pos+=u.length;else{F=document.createDocumentFragment();for(var H=0;;){k.lastIndex=H;var Y=k.exec(u),q=Y?Y.index-H:u.length-H;if(q){var ee=document.createTextNode(L.slice(H,H+q));o&&l<9?F.appendChild(U("span",[ee])):F.appendChild(ee),s.map.push(s.pos,s.pos+q,ee),s.col+=q,s.pos+=q}if(!Y)break;H+=q+1;var ne=void 0;if(Y[0]=="	"){var de=s.cm.options.tabSize,fe=de-s.col%de;ne=F.appendChild(U("span",ta(fe),"cm-tab")),ne.setAttribute("role","presentation"),ne.setAttribute("cm-text","	"),s.col+=fe}else Y[0]=="\r"||Y[0]==`
`?(ne=F.appendChild(U("span",Y[0]=="\r"?"\u240D":"\u2424","cm-invalidchar")),ne.setAttribute("cm-text",Y[0]),s.col+=1):(ne=s.cm.options.specialCharPlaceholder(Y[0]),ne.setAttribute("cm-text",Y[0]),o&&l<9?F.appendChild(U("span",[ne])):F.appendChild(ne),s.col+=1);s.map.push(s.pos,s.pos+1,ne),s.pos++}}if(s.trailingSpace=L.charCodeAt(u.length-1)==32,h||f||y||A||S||w){var Se=h||"";f&&(Se+=f),y&&(Se+=y);var he=U("span",[F],Se,S);if(w)for(var be in w)w.hasOwnProperty(be)&&be!="style"&&be!="class"&&he.setAttribute(be,w[be]);return s.content.appendChild(he)}s.content.appendChild(F)}}function JN(s,u){if(s.length>1&&!/  /.test(s))return s;for(var h=u,f="",y=0;y<s.length;y++){var S=s.charAt(y);S==" "&&h&&(y==s.length-1||s.charCodeAt(y+1)==32)&&(S="\xA0"),f+=S,h=S==" "}return f}function qN(s,u){return function(h,f,y,S,w,L,k){y=y?y+" cm-force-border":"cm-force-border";for(var A=h.pos,F=A+f.length;;){for(var H=void 0,Y=0;Y<u.length&&(H=u[Y],!(H.to>A&&H.from<=A));Y++);if(H.to>=F)return s(h,f,y,S,w,L,k);s(h,f.slice(0,H.to-A),y,S,null,L,k),S=null,f=f.slice(H.to-A),A=H.to}}}function $0(s,u,h,f){var y=!f&&h.widgetNode;y&&s.map.push(s.pos,s.pos+u,y),!f&&s.cm.display.input.needsContentAttribute&&(y||(y=s.content.appendChild(document.createElement("span"))),y.setAttribute("cm-marker",h.id)),y&&(s.cm.display.input.setUneditable(y),s.content.appendChild(y)),s.pos+=u,s.trailingSpace=!1}function YN(s,u,h){var f=s.markedSpans,y=s.text,S=0;if(!f){for(var w=1;w<h.length;w+=2)u.addToken(u,y.slice(S,S=h[w]),z0(h[w+1],u.cm.options));return}for(var L=y.length,k=0,A=1,F="",H,Y,q=0,ee,ne,de,fe,Se;;){if(q==k){ee=ne=de=Y="",Se=null,fe=null,q=Infinity;for(var he=[],be=void 0,Ae=0;Ae<f.length;++Ae){var De=f[Ae],Xe=De.marker;if(Xe.type=="bookmark"&&De.from==k&&Xe.widgetNode)he.push(Xe);else if(De.from<=k&&(De.to==null||De.to>k||Xe.collapsed&&De.to==k&&De.from==k)){if(De.to!=null&&De.to!=k&&q>De.to&&(q=De.to,ne=""),Xe.className&&(ee+=" "+Xe.className),Xe.css&&(Y=(Y?Y+";":"")+Xe.css),Xe.startStyle&&De.from==k&&(de+=" "+Xe.startStyle),Xe.endStyle&&De.to==q&&(be||(be=[])).push(Xe.endStyle,De.to),Xe.title&&((Se||(Se={})).title=Xe.title),Xe.attributes)for(var Ct in Xe.attributes)(Se||(Se={}))[Ct]=Xe.attributes[Ct];Xe.collapsed&&(!fe||by(fe.marker,Xe)<0)&&(fe=De)}else De.from>k&&q>De.from&&(q=De.from)}if(be)for(var fn=0;fn<be.length;fn+=2)be[fn+1]==q&&(ne+=" "+be[fn]);if(!fe||fe.from==k)for(var Nt=0;Nt<he.length;++Nt)$0(u,0,he[Nt]);if(fe&&(fe.from||0)==k){if($0(u,(fe.to==null?L+1:fe.to)-k,fe.marker,fe.from==null),fe.to==null)return;fe.to==k&&(fe=!1)}}if(k>=L)break;for(var Ar=Math.min(L,q);;){if(F){var fr=k+F.length;if(!fe){var en=fr>Ar?F.slice(0,Ar-k):F;u.addToken(u,en,H?H+ee:ee,de,k+en.length==q?ne:"",Y,Se)}if(fr>=Ar){F=F.slice(Ar-k),k=Ar;break}k=fr,de=""}F=y.slice(S,S=h[A++]),H=z0(h[A++],u.cm.options)}}}function j0(s,u,h){this.line=u,this.rest=FN(u),this.size=this.rest?ft(nt(this.rest))-h+1:1,this.node=this.text=null,this.hidden=Io(s,u)}function pf(s,u,h){for(var f=[],y,S=u;S<h;S=y){var w=new j0(s.doc,Te(s.doc,S),S);y=S+w.size,f.push(w)}return f}var Zl=null;function KN(s){Zl?Zl.ops.push(s):s.ownsGroup=Zl={ops:[s],delayedCallbacks:[]}}function XN(s){var u=s.delayedCallbacks,h=0;do{for(;h<u.length;h++)u[h].call(null);for(var f=0;f<s.ops.length;f++){var y=s.ops[f];if(y.cursorActivityHandlers)for(;y.cursorActivityCalled<y.cursorActivityHandlers.length;)y.cursorActivityHandlers[y.cursorActivityCalled++].call(null,y.cm)}}while(h<u.length)}function QN(s,u){var h=s.ownsGroup;if(!!h)try{XN(h)}finally{Zl=null,u(h)}}var Au=null;function un(s,u){var h=jl(s,u);if(!!h.length){var f=Array.prototype.slice.call(arguments,2),y;Zl?y=Zl.delayedCallbacks:Au?y=Au:(y=Au=[],setTimeout(ZN,0));for(var S=function(L){y.push(function(){return h[L].apply(null,f)})},w=0;w<h.length;++w)S(w)}}function ZN(){var s=Au;Au=null;for(var u=0;u<s.length;++u)s[u]()}function J0(s,u,h,f){for(var y=0;y<u.changes.length;y++){var S=u.changes[y];S=="text"?tB(s,u):S=="gutter"?Y0(s,u,h,f):S=="class"?Ty(s,u):S=="widget"&&nB(s,u,f)}u.changes=null}function Mu(s){return s.node==s.text&&(s.node=U("div",null,null,"position: relative"),s.text.parentNode&&s.text.parentNode.replaceChild(s.node,s.text),s.node.appendChild(s.text),o&&l<8&&(s.node.style.zIndex=2)),s.node}function eB(s,u){var h=u.bgClass?u.bgClass+" "+(u.line.bgClass||""):u.line.bgClass;if(h&&(h+=" CodeMirror-linebackground"),u.background)h?u.background.className=h:(u.background.parentNode.removeChild(u.background),u.background=null);else if(h){var f=Mu(u);u.background=f.insertBefore(U("div",null,h),f.firstChild),s.display.input.setUneditable(u.background)}}function q0(s,u){var h=s.display.externalMeasured;return h&&h.line==u.line?(s.display.externalMeasured=null,u.measure=h.measure,h.built):H0(s,u)}function tB(s,u){var h=u.text.className,f=q0(s,u);u.text==u.node&&(u.node=f.pre),u.text.parentNode.replaceChild(f.pre,u.text),u.text=f.pre,f.bgClass!=u.bgClass||f.textClass!=u.textClass?(u.bgClass=f.bgClass,u.textClass=f.textClass,Ty(s,u)):h&&(u.text.className=h)}function Ty(s,u){eB(s,u),u.line.wrapClass?Mu(u).className=u.line.wrapClass:u.node!=u.text&&(u.node.className="");var h=u.textClass?u.textClass+" "+(u.line.textClass||""):u.line.textClass;u.text.className=h||""}function Y0(s,u,h,f){if(u.gutter&&(u.node.removeChild(u.gutter),u.gutter=null),u.gutterBackground&&(u.node.removeChild(u.gutterBackground),u.gutterBackground=null),u.line.gutterClass){var y=Mu(u);u.gutterBackground=U("div",null,"CodeMirror-gutter-background "+u.line.gutterClass,"left: "+(s.options.fixedGutter?f.fixedPos:-f.gutterTotalWidth)+"px; width: "+f.gutterTotalWidth+"px"),s.display.input.setUneditable(u.gutterBackground),y.insertBefore(u.gutterBackground,u.text)}var S=u.line.gutterMarkers;if(s.options.lineNumbers||S){var w=Mu(u),L=u.gutter=U("div",null,"CodeMirror-gutter-wrapper","left: "+(s.options.fixedGutter?f.fixedPos:-f.gutterTotalWidth)+"px");if(L.setAttribute("aria-hidden","true"),s.display.input.setUneditable(L),w.insertBefore(L,u.text),u.line.gutterClass&&(L.className+=" "+u.line.gutterClass),s.options.lineNumbers&&(!S||!S["CodeMirror-linenumbers"])&&(u.lineNumber=L.appendChild(U("div",Du(s.options,h),"CodeMirror-linenumber CodeMirror-gutter-elt","left: "+f.gutterLeft["CodeMirror-linenumbers"]+"px; width: "+s.display.lineNumInnerWidth+"px"))),S)for(var k=0;k<s.display.gutterSpecs.length;++k){var A=s.display.gutterSpecs[k].className,F=S.hasOwnProperty(A)&&S[A];F&&L.appendChild(U("div",[F],"CodeMirror-gutter-elt","left: "+f.gutterLeft[A]+"px; width: "+f.gutterWidth[A]+"px"))}}}function nB(s,u,h){u.alignable&&(u.alignable=null);for(var f=O("CodeMirror-linewidget"),y=u.node.firstChild,S=void 0;y;y=S)S=y.nextSibling,f.test(y.className)&&u.node.removeChild(y);K0(s,u,h)}function rB(s,u,h,f){var y=q0(s,u);return u.text=u.node=y.pre,y.bgClass&&(u.bgClass=y.bgClass),y.textClass&&(u.textClass=y.textClass),Ty(s,u),Y0(s,u,h,f),K0(s,u,f),u.node}function K0(s,u,h){if(X0(s,u.line,u,h,!0),u.rest)for(var f=0;f<u.rest.length;f++)X0(s,u.rest[f],u,h,!1)}function X0(s,u,h,f,y){if(!!u.widgets)for(var S=Mu(h),w=0,L=u.widgets;w<L.length;++w){var k=L[w],A=U("div",[k.node],"CodeMirror-linewidget"+(k.className?" "+k.className:""));k.handleMouseEvents||A.setAttribute("cm-ignore-events","true"),iB(k,A,h,f),s.display.input.setUneditable(A),y&&k.above?S.insertBefore(A,h.gutter||h.text):S.appendChild(A),un(k,"redraw")}}function iB(s,u,h,f){if(s.noHScroll){(h.alignable||(h.alignable=[])).push(u);var y=f.wrapperWidth;u.style.left=f.fixedPos+"px",s.coverGutter||(y-=f.gutterTotalWidth,u.style.paddingLeft=f.gutterTotalWidth+"px"),u.style.width=y+"px"}s.coverGutter&&(u.style.zIndex=5,u.style.position="relative",s.noHScroll||(u.style.marginLeft=-f.gutterTotalWidth+"px"))}function Ru(s){if(s.height!=null)return s.height;var u=s.doc.cm;if(!u)return 0;if(!ie(document.body,s.node)){var h="position: relative;";s.coverGutter&&(h+="margin-left: -"+u.display.gutters.offsetWidth+"px;"),s.noHScroll&&(h+="width: "+u.display.wrapper.clientWidth+"px;"),_(u.display.measure,U("div",[s.node],null,h))}return s.height=s.node.parentNode.offsetHeight}function ja(s,u){for(var h=Do(u);h!=s.wrapper;h=h.parentNode)if(!h||h.nodeType==1&&h.getAttribute("cm-ignore-events")=="true"||h.parentNode==s.sizer&&h!=s.mover)return!0}function ff(s){return s.lineSpace.offsetTop}function Ly(s){return s.mover.offsetHeight-s.lineSpace.offsetHeight}function Q0(s){if(s.cachedPaddingH)return s.cachedPaddingH;var u=_(s.measure,U("pre","x","CodeMirror-line-like")),h=window.getComputedStyle?window.getComputedStyle(u):u.currentStyle,f={left:parseInt(h.paddingLeft),right:parseInt(h.paddingRight)};return!isNaN(f.left)&&!isNaN(f.right)&&(s.cachedPaddingH=f),f}function pa(s){return ke-s.display.nativeBarWidth}function _s(s){return s.display.scroller.clientWidth-pa(s)-s.display.barWidth}function ky(s){return s.display.scroller.clientHeight-pa(s)-s.display.barHeight}function aB(s,u,h){var f=s.options.lineWrapping,y=f&&_s(s);if(!u.measure.heights||f&&u.measure.width!=y){var S=u.measure.heights=[];if(f){u.measure.width=y;for(var w=u.text.firstChild.getClientRects(),L=0;L<w.length-1;L++){var k=w[L],A=w[L+1];Math.abs(k.bottom-A.bottom)>2&&S.push((k.bottom+A.top)/2-h.top)}}S.push(h.bottom-h.top)}}function Z0(s,u,h){if(s.line==u)return{map:s.measure.map,cache:s.measure.cache};for(var f=0;f<s.rest.length;f++)if(s.rest[f]==u)return{map:s.measure.maps[f],cache:s.measure.caches[f]};for(var y=0;y<s.rest.length;y++)if(ft(s.rest[y])>h)return{map:s.measure.maps[y],cache:s.measure.caches[y],before:!0}}function oB(s,u){u=da(u);var h=ft(u),f=s.display.externalMeasured=new j0(s.doc,u,h);f.lineN=h;var y=f.built=H0(s,f);return f.text=y.pre,_(s.display.lineMeasure,y.pre),f}function eT(s,u,h,f){return fa(s,ec(s,u),h,f)}function Ey(s,u){if(u>=s.display.viewFrom&&u<s.display.viewTo)return s.display.view[Ns(s,u)];var h=s.display.externalMeasured;if(h&&u>=h.lineN&&u<h.lineN+h.size)return h}function ec(s,u){var h=ft(u),f=Ey(s,h);f&&!f.text?f=null:f&&f.changes&&(J0(s,f,h,Ry(s)),s.curOp.forceUpdate=!0),f||(f=oB(s,u));var y=Z0(f,u,h);return{line:u,view:f,rect:null,map:y.map,cache:y.cache,before:y.before,hasHeights:!1}}function fa(s,u,h,f,y){u.before&&(h=-1);var S=h+(f||""),w;return u.cache.hasOwnProperty(S)?w=u.cache[S]:(u.rect||(u.rect=u.view.text.getBoundingClientRect()),u.hasHeights||(aB(s,u.view,u.rect),u.hasHeights=!0),w=lB(s,u,h,f),w.bogus||(u.cache[S]=w)),{left:w.left,right:w.right,top:y?w.rtop:w.top,bottom:y?w.rbottom:w.bottom}}var tT={left:0,right:0,top:0,bottom:0};function nT(s,u,h){for(var f,y,S,w,L,k,A=0;A<s.length;A+=3)if(L=s[A],k=s[A+1],u<L?(y=0,S=1,w="left"):u<k?(y=u-L,S=y+1):(A==s.length-3||u==k&&s[A+3]>u)&&(S=k-L,y=S-1,u>=k&&(w="right")),y!=null){if(f=s[A+2],L==k&&h==(f.insertLeft?"left":"right")&&(w=h),h=="left"&&y==0)for(;A&&s[A-2]==s[A-3]&&s[A-1].insertLeft;)f=s[(A-=3)+2],w="left";if(h=="right"&&y==k-L)for(;A<s.length-3&&s[A+3]==s[A+4]&&!s[A+5].insertLeft;)f=s[(A+=3)+2],w="right";break}return{node:f,start:y,end:S,collapse:w,coverStart:L,coverEnd:k}}function sB(s,u){var h=tT;if(u=="left")for(var f=0;f<s.length&&(h=s[f]).left==h.right;f++);else for(var y=s.length-1;y>=0&&(h=s[y]).left==h.right;y--);return h}function lB(s,u,h,f){var y=nT(u.map,h,f),S=y.node,w=y.start,L=y.end,k=y.collapse,A;if(S.nodeType==3){for(var F=0;F<4;F++){for(;w&&$l(u.line.text.charAt(y.coverStart+w));)--w;for(;y.coverStart+L<y.coverEnd&&$l(u.line.text.charAt(y.coverStart+L));)++L;if(o&&l<9&&w==0&&L==y.coverEnd-y.coverStart?A=S.parentNode.getBoundingClientRect():A=sB(J(S,w,L).getClientRects(),f),A.left||A.right||w==0)break;L=w,w=w-1,k="right"}o&&l<11&&(A=cB(s.display.measure,A))}else{w>0&&(k=f="right");var H;s.options.lineWrapping&&(H=S.getClientRects()).length>1?A=H[f=="right"?H.length-1:0]:A=S.getBoundingClientRect()}if(o&&l<9&&!w&&(!A||!A.left&&!A.right)){var Y=S.parentNode.getClientRects()[0];Y?A={left:Y.left,right:Y.left+nc(s.display),top:Y.top,bottom:Y.bottom}:A=tT}for(var q=A.top-u.rect.top,ee=A.bottom-u.rect.top,ne=(q+ee)/2,de=u.view.measure.heights,fe=0;fe<de.length-1&&!(ne<de[fe]);fe++);var Se=fe?de[fe-1]:0,he=de[fe],be={left:(k=="right"?A.right:A.left)-u.rect.left,right:(k=="left"?A.left:A.right)-u.rect.left,top:Se,bottom:he};return!A.left&&!A.right&&(be.bogus=!0),s.options.singleCursorHeightPerLine||(be.rtop=q,be.rbottom=ee),be}function cB(s,u){if(!window.screen||screen.logicalXDPI==null||screen.logicalXDPI==screen.deviceXDPI||!Po(s))return u;var h=screen.logicalXDPI/screen.deviceXDPI,f=screen.logicalYDPI/screen.deviceYDPI;return{left:u.left*h,right:u.right*h,top:u.top*f,bottom:u.bottom*f}}function rT(s){if(s.measure&&(s.measure.cache={},s.measure.heights=null,s.rest))for(var u=0;u<s.rest.length;u++)s.measure.caches[u]={}}function iT(s){s.display.externalMeasure=null,z(s.display.lineMeasure);for(var u=0;u<s.display.view.length;u++)rT(s.display.view[u])}function _u(s){iT(s),s.display.cachedCharWidth=s.display.cachedTextHeight=s.display.cachedPaddingH=null,s.options.lineWrapping||(s.display.maxLineChanged=!0),s.display.lineNumChars=null}function aT(){return p&&C?-(document.body.getBoundingClientRect().left-parseInt(getComputedStyle(document.body).marginLeft)):window.pageXOffset||(document.documentElement||document.body).scrollLeft}function oT(){return p&&C?-(document.body.getBoundingClientRect().top-parseInt(getComputedStyle(document.body).marginTop)):window.pageYOffset||(document.documentElement||document.body).scrollTop}function Dy(s){var u=0;if(s.widgets)for(var h=0;h<s.widgets.length;++h)s.widgets[h].above&&(u+=Ru(s.widgets[h]));return u}function hf(s,u,h,f,y){if(!y){var S=Dy(u);h.top+=S,h.bottom+=S}if(f=="line")return h;f||(f="local");var w=$a(u);if(f=="local"?w+=ff(s.display):w-=s.display.viewOffset,f=="page"||f=="window"){var L=s.display.lineSpace.getBoundingClientRect();w+=L.top+(f=="window"?0:oT());var k=L.left+(f=="window"?0:aT());h.left+=k,h.right+=k}return h.top+=w,h.bottom+=w,h}function sT(s,u,h){if(h=="div")return u;var f=u.left,y=u.top;if(h=="page")f-=aT(),y-=oT();else if(h=="local"||!h){var S=s.display.sizer.getBoundingClientRect();f+=S.left,y+=S.top}var w=s.display.lineSpace.getBoundingClientRect();return{left:f-w.left,top:y-w.top}}function Py(s,u,h,f,y){return f||(f=Te(s.doc,u.line)),hf(s,f,eT(s,f,u.ch,y),h)}function Ii(s,u,h,f,y,S){f=f||Te(s.doc,u.line),y||(y=ec(s,f));function w(ee,ne){var de=fa(s,y,ee,ne?"right":"left",S);return ne?de.left=de.right:de.right=de.left,hf(s,f,de,h)}var L=Dr(f,s.doc.direction),k=u.ch,A=u.sticky;if(k>=f.text.length?(k=f.text.length,A="before"):k<=0&&(k=0,A="after"),!L)return w(A=="before"?k-1:k,A=="before");function F(ee,ne,de){var fe=L[ne],Se=fe.level==1;return w(de?ee-1:ee,Se!=de)}var H=Lt(L,k,A),Y=lr,q=F(k,H,A=="before");return Y!=null&&(q.other=F(k,Y,A!="before")),q}function lT(s,u){var h=0;u=ve(s.doc,u),s.options.lineWrapping||(h=nc(s.display)*u.ch);var f=Te(s.doc,u.line),y=$a(f)+ff(s.display);return{left:h,right:h,top:y,bottom:y+f.height}}function Iy(s,u,h,f,y){var S=se(s,u,h);return S.xRel=y,f&&(S.outside=f),S}function Ay(s,u,h){var f=s.doc;if(h+=s.display.viewOffset,h<0)return Iy(f.first,0,null,-1,-1);var y=ca(f,h),S=f.first+f.size-1;if(y>S)return Iy(f.first+f.size-1,Te(f,S).text.length,null,1,1);u<0&&(u=0);for(var w=Te(f,y);;){var L=uB(s,w,y,u,h),k=BN(w,L.ch+(L.xRel>0||L.outside>0?1:0));if(!k)return L;var A=k.find(1);if(A.line==y)return A;w=Te(f,y=A.line)}}function cT(s,u,h,f){f-=Dy(u);var y=u.text.length,S=Rn(function(w){return fa(s,h,w-1).bottom<=f},y,0);return y=Rn(function(w){return fa(s,h,w).top>f},S,y),{begin:S,end:y}}function uT(s,u,h,f){h||(h=ec(s,u));var y=hf(s,u,fa(s,h,f),"line").top;return cT(s,u,h,y)}function My(s,u,h,f){return s.bottom<=h?!1:s.top>h?!0:(f?s.left:s.right)>u}function uB(s,u,h,f,y){y-=$a(u);var S=ec(s,u),w=Dy(u),L=0,k=u.text.length,A=!0,F=Dr(u,s.doc.direction);if(F){var H=(s.options.lineWrapping?pB:dB)(s,u,h,S,F,f,y);A=H.level!=1,L=A?H.from:H.to-1,k=A?H.to:H.from-1}var Y=null,q=null,ee=Rn(function(Ae){var De=fa(s,S,Ae);return De.top+=w,De.bottom+=w,My(De,f,y,!1)?(De.top<=y&&De.left<=f&&(Y=Ae,q=De),!0):!1},L,k),ne,de,fe=!1;if(q){var Se=f-q.left<q.right-f,he=Se==A;ee=Y+(he?0:1),de=he?"after":"before",ne=Se?q.left:q.right}else{!A&&(ee==k||ee==L)&&ee++,de=ee==0?"after":ee==u.text.length?"before":fa(s,S,ee-(A?1:0)).bottom+w<=y==A?"after":"before";var be=Ii(s,se(h,ee,de),"line",u,S);ne=be.left,fe=y<be.top?-1:y>=be.bottom?1:0}return ee=Eo(u.text,ee,1),Iy(h,ee,de,fe,f-ne)}function dB(s,u,h,f,y,S,w){var L=Rn(function(H){var Y=y[H],q=Y.level!=1;return My(Ii(s,se(h,q?Y.to:Y.from,q?"before":"after"),"line",u,f),S,w,!0)},0,y.length-1),k=y[L];if(L>0){var A=k.level!=1,F=Ii(s,se(h,A?k.from:k.to,A?"after":"before"),"line",u,f);My(F,S,w,!0)&&F.top>w&&(k=y[L-1])}return k}function pB(s,u,h,f,y,S,w){var L=cT(s,u,f,w),k=L.begin,A=L.end;/\s/.test(u.text.charAt(A-1))&&A--;for(var F=null,H=null,Y=0;Y<y.length;Y++){var q=y[Y];if(!(q.from>=A||q.to<=k)){var ee=q.level!=1,ne=fa(s,f,ee?Math.min(A,q.to)-1:Math.max(k,q.from)).right,de=ne<S?S-ne+1e9:ne-S;(!F||H>de)&&(F=q,H=de)}}return F||(F=y[y.length-1]),F.from<k&&(F={from:k,to:F.to,level:F.level}),F.to>A&&(F={from:F.from,to:A,level:F.level}),F}var Vs;function tc(s){if(s.cachedTextHeight!=null)return s.cachedTextHeight;if(Vs==null){Vs=U("pre",null,"CodeMirror-line-like");for(var u=0;u<49;++u)Vs.appendChild(document.createTextNode("x")),Vs.appendChild(U("br"));Vs.appendChild(document.createTextNode("x"))}_(s.measure,Vs);var h=Vs.offsetHeight/50;return h>3&&(s.cachedTextHeight=h),z(s.measure),h||1}function nc(s){if(s.cachedCharWidth!=null)return s.cachedCharWidth;var u=U("span","xxxxxxxxxx"),h=U("pre",[u],"CodeMirror-line-like");_(s.measure,h);var f=u.getBoundingClientRect(),y=(f.right-f.left)/10;return y>2&&(s.cachedCharWidth=y),y||10}function Ry(s){for(var u=s.display,h={},f={},y=u.gutters.clientLeft,S=u.gutters.firstChild,w=0;S;S=S.nextSibling,++w){var L=s.display.gutterSpecs[w].className;h[L]=S.offsetLeft+S.clientLeft+y,f[L]=S.clientWidth}return{fixedPos:_y(u),gutterTotalWidth:u.gutters.offsetWidth,gutterLeft:h,gutterWidth:f,wrapperWidth:u.wrapper.clientWidth}}function _y(s){return s.scroller.getBoundingClientRect().left-s.sizer.getBoundingClientRect().left}function dT(s){var u=tc(s.display),h=s.options.lineWrapping,f=h&&Math.max(5,s.display.scroller.clientWidth/nc(s.display)-3);return function(y){if(Io(s.doc,y))return 0;var S=0;if(y.widgets)for(var w=0;w<y.widgets.length;w++)y.widgets[w].height&&(S+=y.widgets[w].height);return h?S+(Math.ceil(y.text.length/f)||1)*u:S+u}}function Vy(s){var u=s.doc,h=dT(s);u.iter(function(f){var y=h(f);y!=f.height&&Pr(f,y)})}function Os(s,u,h,f){var y=s.display;if(!h&&Do(u).getAttribute("cm-not-content")=="true")return null;var S,w,L=y.lineSpace.getBoundingClientRect();try{S=u.clientX-L.left,w=u.clientY-L.top}catch(H){return null}var k=Ay(s,S,w),A;if(f&&k.xRel>0&&(A=Te(s.doc,k.line).text).length==k.ch){var F=Ue(A,A.length,s.options.tabSize)-A.length;k=se(k.line,Math.max(0,Math.round((S-Q0(s.display).left)/nc(s.display))-F))}return k}function Ns(s,u){if(u>=s.display.viewTo||(u-=s.display.viewFrom,u<0))return null;for(var h=s.display.view,f=0;f<h.length;f++)if(u-=h[f].size,u<0)return f}function dr(s,u,h,f){u==null&&(u=s.doc.first),h==null&&(h=s.doc.first+s.doc.size),f||(f=0);var y=s.display;if(f&&h<y.viewTo&&(y.updateLineNumbers==null||y.updateLineNumbers>u)&&(y.updateLineNumbers=u),s.curOp.viewChanged=!0,u>=y.viewTo)Ha&&xy(s.doc,u)<y.viewTo&&Mo(s);else if(h<=y.viewFrom)Ha&&W0(s.doc,h+f)>y.viewFrom?Mo(s):(y.viewFrom+=f,y.viewTo+=f);else if(u<=y.viewFrom&&h>=y.viewTo)Mo(s);else if(u<=y.viewFrom){var S=mf(s,h,h+f,1);S?(y.view=y.view.slice(S.index),y.viewFrom=S.lineN,y.viewTo+=f):Mo(s)}else if(h>=y.viewTo){var w=mf(s,u,u,-1);w?(y.view=y.view.slice(0,w.index),y.viewTo=w.lineN):Mo(s)}else{var L=mf(s,u,u,-1),k=mf(s,h,h+f,1);L&&k?(y.view=y.view.slice(0,L.index).concat(pf(s,L.lineN,k.lineN)).concat(y.view.slice(k.index)),y.viewTo+=f):Mo(s)}var A=y.externalMeasured;A&&(h<A.lineN?A.lineN+=f:u<A.lineN+A.size&&(y.externalMeasured=null))}function Ao(s,u,h){s.curOp.viewChanged=!0;var f=s.display,y=s.display.externalMeasured;if(y&&u>=y.lineN&&u<y.lineN+y.size&&(f.externalMeasured=null),!(u<f.viewFrom||u>=f.viewTo)){var S=f.view[Ns(s,u)];if(S.node!=null){var w=S.changes||(S.changes=[]);ye(w,h)==-1&&w.push(h)}}}function Mo(s){s.display.viewFrom=s.display.viewTo=s.doc.first,s.display.view=[],s.display.viewOffset=0}function mf(s,u,h,f){var y=Ns(s,u),S,w=s.display.view;if(!Ha||h==s.doc.first+s.doc.size)return{index:y,lineN:h};for(var L=s.display.viewFrom,k=0;k<y;k++)L+=w[k].size;if(L!=u){if(f>0){if(y==w.length-1)return null;S=L+w[y].size-u,y++}else S=L-u;u+=S,h+=S}for(;xy(s.doc,h)!=h;){if(y==(f<0?0:w.length-1))return null;h+=f*w[y-(f<0?1:0)].size,y+=f}return{index:y,lineN:h}}function fB(s,u,h){var f=s.display,y=f.view;y.length==0||u>=f.viewTo||h<=f.viewFrom?(f.view=pf(s,u,h),f.viewFrom=u):(f.viewFrom>u?f.view=pf(s,u,f.viewFrom).concat(f.view):f.viewFrom<u&&(f.view=f.view.slice(Ns(s,u))),f.viewFrom=u,f.viewTo<h?f.view=f.view.concat(pf(s,f.viewTo,h)):f.viewTo>h&&(f.view=f.view.slice(0,Ns(s,h)))),f.viewTo=h}function pT(s){for(var u=s.display.view,h=0,f=0;f<u.length;f++){var y=u[f];!y.hidden&&(!y.node||y.changes)&&++h}return h}function Vu(s){s.display.input.showSelection(s.display.input.prepareSelection())}function fT(s,u){u===void 0&&(u=!0);for(var h=s.doc,f={},y=f.cursors=document.createDocumentFragment(),S=f.selection=document.createDocumentFragment(),w=0;w<h.sel.ranges.length;w++)if(!(!u&&w==h.sel.primIndex)){var L=h.sel.ranges[w];if(!(L.from().line>=s.display.viewTo||L.to().line<s.display.viewFrom)){var k=L.empty();(k||s.options.showCursorWhenSelecting)&&hT(s,L.head,y),k||hB(s,L,S)}}return f}function hT(s,u,h){var f=Ii(s,u,"div",null,null,!s.options.singleCursorHeightPerLine),y=h.appendChild(U("div","\xA0","CodeMirror-cursor"));if(y.style.left=f.left+"px",y.style.top=f.top+"px",y.style.height=Math.max(0,f.bottom-f.top)*s.options.cursorHeight+"px",f.other){var S=h.appendChild(U("div","\xA0","CodeMirror-cursor CodeMirror-secondarycursor"));S.style.display="",S.style.left=f.other.left+"px",S.style.top=f.other.top+"px",S.style.height=(f.other.bottom-f.other.top)*.85+"px"}}function gf(s,u){return s.top-u.top||s.left-u.left}function hB(s,u,h){var f=s.display,y=s.doc,S=document.createDocumentFragment(),w=Q0(s.display),L=w.left,k=Math.max(f.sizerWidth,_s(s)-f.sizer.offsetLeft)-w.right,A=y.direction=="ltr";function F(he,be,Ae,De){be<0&&(be=0),be=Math.round(be),De=Math.round(De),S.appendChild(U("div",null,"CodeMirror-selected","position: absolute; left: "+he+`px;
                             top: `+be+"px; width: "+(Ae==null?k-he:Ae)+`px;
                             height: `+(De-be)+"px"))}function H(he,be,Ae){var De=Te(y,he),Xe=De.text.length,Ct,fn;function Nt(en,hr){return Py(s,se(he,en),"div",De,hr)}function Ar(en,hr,kn){var nn=uT(s,De,null,en),tn=hr=="ltr"==(kn=="after")?"left":"right",Gt=kn=="after"?nn.begin:nn.end-(/\s/.test(De.text.charAt(nn.end-1))?2:1);return Nt(Gt,tn)[tn]}var fr=Dr(De,y.direction);return bu(fr,be||0,Ae==null?Xe:Ae,function(en,hr,kn,nn){var tn=kn=="ltr",Gt=Nt(en,tn?"left":"right"),mr=Nt(hr-1,tn?"right":"left"),mc=be==null&&en==0,Bo=Ae==null&&hr==Xe,Nn=nn==0,ha=!fr||nn==fr.length-1;if(mr.top-Gt.top<=3){var hn=(A?mc:Bo)&&Nn,sv=(A?Bo:mc)&&ha,qa=hn?L:(tn?Gt:mr).left,Ws=sv?k:(tn?mr:Gt).right;F(qa,Gt.top,Ws-qa,Gt.bottom)}else{var zs,qn,gc,lv;tn?(zs=A&&mc&&Nn?L:Gt.left,qn=A?k:Ar(en,kn,"before"),gc=A?L:Ar(hr,kn,"after"),lv=A&&Bo&&ha?k:mr.right):(zs=A?Ar(en,kn,"before"):L,qn=!A&&mc&&Nn?k:Gt.right,gc=!A&&Bo&&ha?L:mr.left,lv=A?Ar(hr,kn,"after"):k),F(zs,Gt.top,qn-zs,Gt.bottom),Gt.bottom<mr.top&&F(L,Gt.bottom,null,mr.top),F(gc,mr.top,lv-gc,mr.bottom)}(!Ct||gf(Gt,Ct)<0)&&(Ct=Gt),gf(mr,Ct)<0&&(Ct=mr),(!fn||gf(Gt,fn)<0)&&(fn=Gt),gf(mr,fn)<0&&(fn=mr)}),{start:Ct,end:fn}}var Y=u.from(),q=u.to();if(Y.line==q.line)H(Y.line,Y.ch,q.ch);else{var ee=Te(y,Y.line),ne=Te(y,q.line),de=da(ee)==da(ne),fe=H(Y.line,Y.ch,de?ee.text.length+1:null).end,Se=H(q.line,de?0:null,q.ch).start;de&&(fe.top<Se.top-2?(F(fe.right,fe.top,null,fe.bottom),F(L,Se.top,Se.left,Se.bottom)):F(fe.right,fe.top,Se.left-fe.right,fe.bottom)),fe.bottom<Se.top&&F(L,fe.bottom,null,Se.top)}h.appendChild(S)}function Oy(s){if(!!s.state.focused){var u=s.display;clearInterval(u.blinker);var h=!0;u.cursorDiv.style.visibility="",s.options.cursorBlinkRate>0?u.blinker=setInterval(function(){s.hasFocus()||rc(s),u.cursorDiv.style.visibility=(h=!h)?"":"hidden"},s.options.cursorBlinkRate):s.options.cursorBlinkRate<0&&(u.cursorDiv.style.visibility="hidden")}}function mT(s){s.hasFocus()||(s.display.input.focus(),s.state.focused||By(s))}function Ny(s){s.state.delayingBlurEvent=!0,setTimeout(function(){s.state.delayingBlurEvent&&(s.state.delayingBlurEvent=!1,s.state.focused&&rc(s))},100)}function By(s,u){s.state.delayingBlurEvent&&!s.state.draggingText&&(s.state.delayingBlurEvent=!1),s.options.readOnly!="nocursor"&&(s.state.focused||(Fe(s,"focus",s,u),s.state.focused=!0,me(s.display.wrapper,"CodeMirror-focused"),!s.curOp&&s.display.selForContextMenu!=s.doc.sel&&(s.display.input.reset(),c&&setTimeout(function(){return s.display.input.reset(!0)},20)),s.display.input.receivedFocus()),Oy(s))}function rc(s,u){s.state.delayingBlurEvent||(s.state.focused&&(Fe(s,"blur",s,u),s.state.focused=!1,B(s.display.wrapper,"CodeMirror-focused")),clearInterval(s.display.blinker),setTimeout(function(){s.state.focused||(s.display.shift=!1)},150))}function yf(s){for(var u=s.display,h=u.lineDiv.offsetTop,f=0;f<u.view.length;f++){var y=u.view[f],S=s.options.lineWrapping,w=void 0,L=0;if(!y.hidden){if(o&&l<8){var k=y.node.offsetTop+y.node.offsetHeight;w=k-h,h=k}else{var A=y.node.getBoundingClientRect();w=A.bottom-A.top,!S&&y.text.firstChild&&(L=y.text.firstChild.getBoundingClientRect().right-A.left-1)}var F=y.line.height-w;if((F>.005||F<-.005)&&(Pr(y.line,w),gT(y.line),y.rest))for(var H=0;H<y.rest.length;H++)gT(y.rest[H]);if(L>s.display.sizerWidth){var Y=Math.ceil(L/nc(s.display));Y>s.display.maxLineLength&&(s.display.maxLineLength=Y,s.display.maxLine=y.line,s.display.maxLineChanged=!0)}}}}function gT(s){if(s.widgets)for(var u=0;u<s.widgets.length;++u){var h=s.widgets[u],f=h.node.parentNode;f&&(h.height=f.offsetHeight)}}function vf(s,u,h){var f=h&&h.top!=null?Math.max(0,h.top):s.scroller.scrollTop;f=Math.floor(f-ff(s));var y=h&&h.bottom!=null?h.bottom:f+s.wrapper.clientHeight,S=ca(u,f),w=ca(u,y);if(h&&h.ensure){var L=h.ensure.from.line,k=h.ensure.to.line;L<S?(S=L,w=ca(u,$a(Te(u,L))+s.wrapper.clientHeight)):Math.min(k,u.lastLine())>=w&&(S=ca(u,$a(Te(u,k))-s.wrapper.clientHeight),w=k)}return{from:S,to:Math.max(w,S+1)}}function mB(s,u){if(!Zt(s,"scrollCursorIntoView")){var h=s.display,f=h.sizer.getBoundingClientRect(),y=null;if(u.top+f.top<0?y=!0:u.bottom+f.top>(window.innerHeight||document.documentElement.clientHeight)&&(y=!1),y!=null&&!b){var S=U("div","\u200B",null,`position: absolute;
                         top: `+(u.top-h.viewOffset-ff(s.display))+`px;
                         height: `+(u.bottom-u.top+pa(s)+h.barHeight)+`px;
                         left: `+u.left+"px; width: "+Math.max(2,u.right-u.left)+"px;");s.display.lineSpace.appendChild(S),S.scrollIntoView(y),s.display.lineSpace.removeChild(S)}}}function gB(s,u,h,f){f==null&&(f=0);var y;!s.options.lineWrapping&&u==h&&(h=u.sticky=="before"?se(u.line,u.ch+1,"before"):u,u=u.ch?se(u.line,u.sticky=="before"?u.ch-1:u.ch,"after"):u);for(var S=0;S<5;S++){var w=!1,L=Ii(s,u),k=!h||h==u?L:Ii(s,h);y={left:Math.min(L.left,k.left),top:Math.min(L.top,k.top)-f,right:Math.max(L.left,k.left),bottom:Math.max(L.bottom,k.bottom)+f};var A=Uy(s,y),F=s.doc.scrollTop,H=s.doc.scrollLeft;if(A.scrollTop!=null&&(Nu(s,A.scrollTop),Math.abs(s.doc.scrollTop-F)>1&&(w=!0)),A.scrollLeft!=null&&(Bs(s,A.scrollLeft),Math.abs(s.doc.scrollLeft-H)>1&&(w=!0)),!w)break}return y}function yB(s,u){var h=Uy(s,u);h.scrollTop!=null&&Nu(s,h.scrollTop),h.scrollLeft!=null&&Bs(s,h.scrollLeft)}function Uy(s,u){var h=s.display,f=tc(s.display);u.top<0&&(u.top=0);var y=s.curOp&&s.curOp.scrollTop!=null?s.curOp.scrollTop:h.scroller.scrollTop,S=ky(s),w={};u.bottom-u.top>S&&(u.bottom=u.top+S);var L=s.doc.height+Ly(h),k=u.top<f,A=u.bottom>L-f;if(u.top<y)w.scrollTop=k?0:u.top;else if(u.bottom>y+S){var F=Math.min(u.top,(A?L:u.bottom)-S);F!=y&&(w.scrollTop=F)}var H=s.options.fixedGutter?0:h.gutters.offsetWidth,Y=s.curOp&&s.curOp.scrollLeft!=null?s.curOp.scrollLeft:h.scroller.scrollLeft-H,q=_s(s)-h.gutters.offsetWidth,ee=u.right-u.left>q;return ee&&(u.right=u.left+q),u.left<10?w.scrollLeft=0:u.left<Y?w.scrollLeft=Math.max(0,u.left+H-(ee?0:10)):u.right>q+Y-3&&(w.scrollLeft=u.right+(ee?0:10)-q),w}function Fy(s,u){u!=null&&(Sf(s),s.curOp.scrollTop=(s.curOp.scrollTop==null?s.doc.scrollTop:s.curOp.scrollTop)+u)}function ic(s){Sf(s);var u=s.getCursor();s.curOp.scrollToPos={from:u,to:u,margin:s.options.cursorScrollMargin}}function Ou(s,u,h){(u!=null||h!=null)&&Sf(s),u!=null&&(s.curOp.scrollLeft=u),h!=null&&(s.curOp.scrollTop=h)}function vB(s,u){Sf(s),s.curOp.scrollToPos=u}function Sf(s){var u=s.curOp.scrollToPos;if(u){s.curOp.scrollToPos=null;var h=lT(s,u.from),f=lT(s,u.to);yT(s,h,f,u.margin)}}function yT(s,u,h,f){var y=Uy(s,{left:Math.min(u.left,h.left),top:Math.min(u.top,h.top)-f,right:Math.max(u.right,h.right),bottom:Math.max(u.bottom,h.bottom)+f});Ou(s,y.scrollLeft,y.scrollTop)}function Nu(s,u){Math.abs(s.doc.scrollTop-u)<2||(t||Wy(s,{top:u}),vT(s,u,!0),t&&Wy(s),Fu(s,100))}function vT(s,u,h){u=Math.max(0,Math.min(s.display.scroller.scrollHeight-s.display.scroller.clientHeight,u)),!(s.display.scroller.scrollTop==u&&!h)&&(s.doc.scrollTop=u,s.display.scrollbars.setScrollTop(u),s.display.scroller.scrollTop!=u&&(s.display.scroller.scrollTop=u))}function Bs(s,u,h,f){u=Math.max(0,Math.min(u,s.display.scroller.scrollWidth-s.display.scroller.clientWidth)),!((h?u==s.doc.scrollLeft:Math.abs(s.doc.scrollLeft-u)<2)&&!f)&&(s.doc.scrollLeft=u,wT(s),s.display.scroller.scrollLeft!=u&&(s.display.scroller.scrollLeft=u),s.display.scrollbars.setScrollLeft(u))}function Bu(s){var u=s.display,h=u.gutters.offsetWidth,f=Math.round(s.doc.height+Ly(s.display));return{clientHeight:u.scroller.clientHeight,viewHeight:u.wrapper.clientHeight,scrollWidth:u.scroller.scrollWidth,clientWidth:u.scroller.clientWidth,viewWidth:u.wrapper.clientWidth,barLeft:s.options.fixedGutter?h:0,docHeight:f,scrollHeight:f+pa(s)+u.barHeight,nativeBarWidth:u.nativeBarWidth,gutterWidth:h}}var Us=function(s,u,h){this.cm=h;var f=this.vert=U("div",[U("div",null,null,"min-width: 1px")],"CodeMirror-vscrollbar"),y=this.horiz=U("div",[U("div",null,null,"height: 100%; min-height: 1px")],"CodeMirror-hscrollbar");f.tabIndex=y.tabIndex=-1,s(f),s(y),Ve(f,"scroll",function(){f.clientHeight&&u(f.scrollTop,"vertical")}),Ve(y,"scroll",function(){y.clientWidth&&u(y.scrollLeft,"horizontal")}),this.checkedZeroWidth=!1,o&&l<8&&(this.horiz.style.minHeight=this.vert.style.minWidth="18px")};Us.prototype.update=function(s){var u=s.scrollWidth>s.clientWidth+1,h=s.scrollHeight>s.clientHeight+1,f=s.nativeBarWidth;if(h){this.vert.style.display="block",this.vert.style.bottom=u?f+"px":"0";var y=s.viewHeight-(u?f:0);this.vert.firstChild.style.height=Math.max(0,s.scrollHeight-s.clientHeight+y)+"px"}else this.vert.style.display="",this.vert.firstChild.style.height="0";if(u){this.horiz.style.display="block",this.horiz.style.right=h?f+"px":"0",this.horiz.style.left=s.barLeft+"px";var S=s.viewWidth-s.barLeft-(h?f:0);this.horiz.firstChild.style.width=Math.max(0,s.scrollWidth-s.clientWidth+S)+"px"}else this.horiz.style.display="",this.horiz.firstChild.style.width="0";return!this.checkedZeroWidth&&s.clientHeight>0&&(f==0&&this.zeroWidthHack(),this.checkedZeroWidth=!0),{right:h?f:0,bottom:u?f:0}},Us.prototype.setScrollLeft=function(s){this.horiz.scrollLeft!=s&&(this.horiz.scrollLeft=s),this.disableHoriz&&this.enableZeroWidthBar(this.horiz,this.disableHoriz,"horiz")},Us.prototype.setScrollTop=function(s){this.vert.scrollTop!=s&&(this.vert.scrollTop=s),this.disableVert&&this.enableZeroWidthBar(this.vert,this.disableVert,"vert")},Us.prototype.zeroWidthHack=function(){var s=I&&!v?"12px":"18px";this.horiz.style.height=this.vert.style.width=s,this.horiz.style.pointerEvents=this.vert.style.pointerEvents="none",this.disableHoriz=new et,this.disableVert=new et},Us.prototype.enableZeroWidthBar=function(s,u,h){s.style.pointerEvents="auto";function f(){var y=s.getBoundingClientRect(),S=h=="vert"?document.elementFromPoint(y.right-1,(y.top+y.bottom)/2):document.elementFromPoint((y.right+y.left)/2,y.bottom-1);S!=s?s.style.pointerEvents="none":u.set(1e3,f)}u.set(1e3,f)},Us.prototype.clear=function(){var s=this.horiz.parentNode;s.removeChild(this.horiz),s.removeChild(this.vert)};var Uu=function(){};Uu.prototype.update=function(){return{bottom:0,right:0}},Uu.prototype.setScrollLeft=function(){},Uu.prototype.setScrollTop=function(){},Uu.prototype.clear=function(){};function ac(s,u){u||(u=Bu(s));var h=s.display.barWidth,f=s.display.barHeight;ST(s,u);for(var y=0;y<4&&h!=s.display.barWidth||f!=s.display.barHeight;y++)h!=s.display.barWidth&&s.options.lineWrapping&&yf(s),ST(s,Bu(s)),h=s.display.barWidth,f=s.display.barHeight}function ST(s,u){var h=s.display,f=h.scrollbars.update(u);h.sizer.style.paddingRight=(h.barWidth=f.right)+"px",h.sizer.style.paddingBottom=(h.barHeight=f.bottom)+"px",h.heightForcer.style.borderBottom=f.bottom+"px solid transparent",f.right&&f.bottom?(h.scrollbarFiller.style.display="block",h.scrollbarFiller.style.height=f.bottom+"px",h.scrollbarFiller.style.width=f.right+"px"):h.scrollbarFiller.style.display="",f.bottom&&s.options.coverGutterNextToScrollbar&&s.options.fixedGutter?(h.gutterFiller.style.display="block",h.gutterFiller.style.height=f.bottom+"px",h.gutterFiller.style.width=u.gutterWidth+"px"):h.gutterFiller.style.display=""}var bT={native:Us,null:Uu};function xT(s){s.display.scrollbars&&(s.display.scrollbars.clear(),s.display.scrollbars.addClass&&B(s.display.wrapper,s.display.scrollbars.addClass)),s.display.scrollbars=new bT[s.options.scrollbarStyle](function(u){s.display.wrapper.insertBefore(u,s.display.scrollbarFiller),Ve(u,"mousedown",function(){s.state.focused&&setTimeout(function(){return s.display.input.focus()},0)}),u.setAttribute("cm-not-content","true")},function(u,h){h=="horizontal"?Bs(s,u):Nu(s,u)},s),s.display.scrollbars.addClass&&me(s.display.wrapper,s.display.scrollbars.addClass)}var SB=0;function Fs(s){s.curOp={cm:s,viewChanged:!1,startHeight:s.doc.height,forceUpdate:!1,updateInput:0,typing:!1,changeObjs:null,cursorActivityHandlers:null,cursorActivityCalled:0,selectionChanged:!1,updateMaxLine:!1,scrollLeft:null,scrollTop:null,scrollToPos:null,focus:!1,id:++SB,markArrays:null},KN(s.curOp)}function Gs(s){var u=s.curOp;u&&QN(u,function(h){for(var f=0;f<h.ops.length;f++)h.ops[f].cm.curOp=null;bB(h)})}function bB(s){for(var u=s.ops,h=0;h<u.length;h++)xB(u[h]);for(var f=0;f<u.length;f++)CB(u[f]);for(var y=0;y<u.length;y++)wB(u[y]);for(var S=0;S<u.length;S++)TB(u[S]);for(var w=0;w<u.length;w++)LB(u[w])}function xB(s){var u=s.cm,h=u.display;EB(u),s.updateMaxLine&&wy(u),s.mustUpdate=s.viewChanged||s.forceUpdate||s.scrollTop!=null||s.scrollToPos&&(s.scrollToPos.from.line<h.viewFrom||s.scrollToPos.to.line>=h.viewTo)||h.maxLineChanged&&u.options.lineWrapping,s.update=s.mustUpdate&&new bf(u,s.mustUpdate&&{top:s.scrollTop,ensure:s.scrollToPos},s.forceUpdate)}function CB(s){s.updatedDisplay=s.mustUpdate&&Gy(s.cm,s.update)}function wB(s){var u=s.cm,h=u.display;s.updatedDisplay&&yf(u),s.barMeasure=Bu(u),h.maxLineChanged&&!u.options.lineWrapping&&(s.adjustWidthTo=eT(u,h.maxLine,h.maxLine.text.length).left+3,u.display.sizerWidth=s.adjustWidthTo,s.barMeasure.scrollWidth=Math.max(h.scroller.clientWidth,h.sizer.offsetLeft+s.adjustWidthTo+pa(u)+u.display.barWidth),s.maxScrollLeft=Math.max(0,h.sizer.offsetLeft+s.adjustWidthTo-_s(u))),(s.updatedDisplay||s.selectionChanged)&&(s.preparedSelection=h.input.prepareSelection())}function TB(s){var u=s.cm;s.adjustWidthTo!=null&&(u.display.sizer.style.minWidth=s.adjustWidthTo+"px",s.maxScrollLeft<u.doc.scrollLeft&&Bs(u,Math.min(u.display.scroller.scrollLeft,s.maxScrollLeft),!0),u.display.maxLineChanged=!1);var h=s.focus&&s.focus==pe();s.preparedSelection&&u.display.input.showSelection(s.preparedSelection,h),(s.updatedDisplay||s.startHeight!=u.doc.height)&&ac(u,s.barMeasure),s.updatedDisplay&&Hy(u,s.barMeasure),s.selectionChanged&&Oy(u),u.state.focused&&s.updateInput&&u.display.input.reset(s.typing),h&&mT(s.cm)}function LB(s){var u=s.cm,h=u.display,f=u.doc;if(s.updatedDisplay&&CT(u,s.update),h.wheelStartX!=null&&(s.scrollTop!=null||s.scrollLeft!=null||s.scrollToPos)&&(h.wheelStartX=h.wheelStartY=null),s.scrollTop!=null&&vT(u,s.scrollTop,s.forceScroll),s.scrollLeft!=null&&Bs(u,s.scrollLeft,!0,!0),s.scrollToPos){var y=gB(u,ve(f,s.scrollToPos.from),ve(f,s.scrollToPos.to),s.scrollToPos.margin);mB(u,y)}var S=s.maybeHiddenMarkers,w=s.maybeUnhiddenMarkers;if(S)for(var L=0;L<S.length;++L)S[L].lines.length||Fe(S[L],"hide");if(w)for(var k=0;k<w.length;++k)w[k].lines.length&&Fe(w[k],"unhide");h.wrapper.offsetHeight&&(f.scrollTop=u.display.scroller.scrollTop),s.changeObjs&&Fe(u,"changes",u,s.changeObjs),s.update&&s.update.finish()}function Ir(s,u){if(s.curOp)return u();Fs(s);try{return u()}finally{Gs(s)}}function dn(s,u){return function(){if(s.curOp)return u.apply(s,arguments);Fs(s);try{return u.apply(s,arguments)}finally{Gs(s)}}}function Jn(s){return function(){if(this.curOp)return s.apply(this,arguments);Fs(this);try{return s.apply(this,arguments)}finally{Gs(this)}}}function pn(s){return function(){var u=this.cm;if(!u||u.curOp)return s.apply(this,arguments);Fs(u);try{return s.apply(this,arguments)}finally{Gs(u)}}}function Fu(s,u){s.doc.highlightFrontier<s.display.viewTo&&s.state.highlight.set(u,we(kB,s))}function kB(s){var u=s.doc;if(!(u.highlightFrontier>=s.display.viewTo)){var h=+new Date+s.options.workTime,f=Pu(s,u.highlightFrontier),y=[];u.iter(f.line,Math.min(u.first+u.size,s.display.viewTo+500),function(S){if(f.line>=s.display.viewFrom){var w=S.styles,L=S.text.length>s.options.maxHighlightLength?Hr(u.mode,f.state):null,k=D0(s,S,f,!0);L&&(f.state=L),S.styles=k.styles;var A=S.styleClasses,F=k.classes;F?S.styleClasses=F:A&&(S.styleClasses=null);for(var H=!w||w.length!=S.styles.length||A!=F&&(!A||!F||A.bgClass!=F.bgClass||A.textClass!=F.textClass),Y=0;!H&&Y<w.length;++Y)H=w[Y]!=S.styles[Y];H&&y.push(f.line),S.stateAfter=f.save(),f.nextLine()}else S.text.length<=s.options.maxHighlightLength&&yy(s,S.text,f),S.stateAfter=f.line%5==0?f.save():null,f.nextLine();if(+new Date>h)return Fu(s,s.options.workDelay),!0}),u.highlightFrontier=f.line,u.modeFrontier=Math.max(u.modeFrontier,f.line),y.length&&Ir(s,function(){for(var S=0;S<y.length;S++)Ao(s,y[S],"text")})}}var bf=function(s,u,h){var f=s.display;this.viewport=u,this.visible=vf(f,s.doc,u),this.editorIsHidden=!f.wrapper.offsetWidth,this.wrapperHeight=f.wrapper.clientHeight,this.wrapperWidth=f.wrapper.clientWidth,this.oldDisplayWidth=_s(s),this.force=h,this.dims=Ry(s),this.events=[]};bf.prototype.signal=function(s,u){Ln(s,u)&&this.events.push(arguments)},bf.prototype.finish=function(){for(var s=0;s<this.events.length;s++)Fe.apply(null,this.events[s])};function EB(s){var u=s.display;!u.scrollbarsClipped&&u.scroller.offsetWidth&&(u.nativeBarWidth=u.scroller.offsetWidth-u.scroller.clientWidth,u.heightForcer.style.height=pa(s)+"px",u.sizer.style.marginBottom=-u.nativeBarWidth+"px",u.sizer.style.borderRightWidth=pa(s)+"px",u.scrollbarsClipped=!0)}function DB(s){if(s.hasFocus())return null;var u=pe();if(!u||!ie(s.display.lineDiv,u))return null;var h={activeElt:u};if(window.getSelection){var f=window.getSelection();f.anchorNode&&f.extend&&ie(s.display.lineDiv,f.anchorNode)&&(h.anchorNode=f.anchorNode,h.anchorOffset=f.anchorOffset,h.focusNode=f.focusNode,h.focusOffset=f.focusOffset)}return h}function PB(s){if(!(!s||!s.activeElt||s.activeElt==pe())&&(s.activeElt.focus(),!/^(INPUT|TEXTAREA)$/.test(s.activeElt.nodeName)&&s.anchorNode&&ie(document.body,s.anchorNode)&&ie(document.body,s.focusNode))){var u=window.getSelection(),h=document.createRange();h.setEnd(s.anchorNode,s.anchorOffset),h.collapse(!1),u.removeAllRanges(),u.addRange(h),u.extend(s.focusNode,s.focusOffset)}}function Gy(s,u){var h=s.display,f=s.doc;if(u.editorIsHidden)return Mo(s),!1;if(!u.force&&u.visible.from>=h.viewFrom&&u.visible.to<=h.viewTo&&(h.updateLineNumbers==null||h.updateLineNumbers>=h.viewTo)&&h.renderedView==h.view&&pT(s)==0)return!1;TT(s)&&(Mo(s),u.dims=Ry(s));var y=f.first+f.size,S=Math.max(u.visible.from-s.options.viewportMargin,f.first),w=Math.min(y,u.visible.to+s.options.viewportMargin);h.viewFrom<S&&S-h.viewFrom<20&&(S=Math.max(f.first,h.viewFrom)),h.viewTo>w&&h.viewTo-w<20&&(w=Math.min(y,h.viewTo)),Ha&&(S=xy(s.doc,S),w=W0(s.doc,w));var L=S!=h.viewFrom||w!=h.viewTo||h.lastWrapHeight!=u.wrapperHeight||h.lastWrapWidth!=u.wrapperWidth;fB(s,S,w),h.viewOffset=$a(Te(s.doc,h.viewFrom)),s.display.mover.style.top=h.viewOffset+"px";var k=pT(s);if(!L&&k==0&&!u.force&&h.renderedView==h.view&&(h.updateLineNumbers==null||h.updateLineNumbers>=h.viewTo))return!1;var A=DB(s);return k>4&&(h.lineDiv.style.display="none"),IB(s,h.updateLineNumbers,u.dims),k>4&&(h.lineDiv.style.display=""),h.renderedView=h.view,PB(A),z(h.cursorDiv),z(h.selectionDiv),h.gutters.style.height=h.sizer.style.minHeight=0,L&&(h.lastWrapHeight=u.wrapperHeight,h.lastWrapWidth=u.wrapperWidth,Fu(s,400)),h.updateLineNumbers=null,!0}function CT(s,u){for(var h=u.viewport,f=!0;;f=!1){if(!f||!s.options.lineWrapping||u.oldDisplayWidth==_s(s)){if(h&&h.top!=null&&(h={top:Math.min(s.doc.height+Ly(s.display)-ky(s),h.top)}),u.visible=vf(s.display,s.doc,h),u.visible.from>=s.display.viewFrom&&u.visible.to<=s.display.viewTo)break}else f&&(u.visible=vf(s.display,s.doc,h));if(!Gy(s,u))break;yf(s);var y=Bu(s);Vu(s),ac(s,y),Hy(s,y),u.force=!1}u.signal(s,"update",s),(s.display.viewFrom!=s.display.reportedViewFrom||s.display.viewTo!=s.display.reportedViewTo)&&(u.signal(s,"viewportChange",s,s.display.viewFrom,s.display.viewTo),s.display.reportedViewFrom=s.display.viewFrom,s.display.reportedViewTo=s.display.viewTo)}function Wy(s,u){var h=new bf(s,u);if(Gy(s,h)){yf(s),CT(s,h);var f=Bu(s);Vu(s),ac(s,f),Hy(s,f),h.finish()}}function IB(s,u,h){var f=s.display,y=s.options.lineNumbers,S=f.lineDiv,w=S.firstChild;function L(ee){var ne=ee.nextSibling;return c&&I&&s.display.currentWheelTarget==ee?ee.style.display="none":ee.parentNode.removeChild(ee),ne}for(var k=f.view,A=f.viewFrom,F=0;F<k.length;F++){var H=k[F];if(!H.hidden)if(!H.node||H.node.parentNode!=S){var Y=rB(s,H,A,h);S.insertBefore(Y,w)}else{for(;w!=H.node;)w=L(w);var q=y&&u!=null&&u<=A&&H.lineNumber;H.changes&&(ye(H.changes,"gutter")>-1&&(q=!1),J0(s,H,A,h)),q&&(z(H.lineNumber),H.lineNumber.appendChild(document.createTextNode(Du(s.options,A)))),w=H.node.nextSibling}A+=H.size}for(;w;)w=L(w)}function zy(s){var u=s.gutters.offsetWidth;s.sizer.style.marginLeft=u+"px",un(s,"gutterChanged",s)}function Hy(s,u){s.display.sizer.style.minHeight=u.docHeight+"px",s.display.heightForcer.style.top=u.docHeight+"px",s.display.gutters.style.height=u.docHeight+s.display.barHeight+pa(s)+"px"}function wT(s){var u=s.display,h=u.view;if(!(!u.alignWidgets&&(!u.gutters.firstChild||!s.options.fixedGutter))){for(var f=_y(u)-u.scroller.scrollLeft+s.doc.scrollLeft,y=u.gutters.offsetWidth,S=f+"px",w=0;w<h.length;w++)if(!h[w].hidden){s.options.fixedGutter&&(h[w].gutter&&(h[w].gutter.style.left=S),h[w].gutterBackground&&(h[w].gutterBackground.style.left=S));var L=h[w].alignable;if(L)for(var k=0;k<L.length;k++)L[k].style.left=S}s.options.fixedGutter&&(u.gutters.style.left=f+y+"px")}}function TT(s){if(!s.options.lineNumbers)return!1;var u=s.doc,h=Du(s.options,u.first+u.size-1),f=s.display;if(h.length!=f.lineNumChars){var y=f.measure.appendChild(U("div",[U("div",h)],"CodeMirror-linenumber CodeMirror-gutter-elt")),S=y.firstChild.offsetWidth,w=y.offsetWidth-S;return f.lineGutter.style.width="",f.lineNumInnerWidth=Math.max(S,f.lineGutter.offsetWidth-w)+1,f.lineNumWidth=f.lineNumInnerWidth+w,f.lineNumChars=f.lineNumInnerWidth?h.length:-1,f.lineGutter.style.width=f.lineNumWidth+"px",zy(s.display),!0}return!1}function $y(s,u){for(var h=[],f=!1,y=0;y<s.length;y++){var S=s[y],w=null;if(typeof S!="string"&&(w=S.style,S=S.className),S=="CodeMirror-linenumbers")if(u)f=!0;else continue;h.push({className:S,style:w})}return u&&!f&&h.push({className:"CodeMirror-linenumbers",style:null}),h}function LT(s){var u=s.gutters,h=s.gutterSpecs;z(u),s.lineGutter=null;for(var f=0;f<h.length;++f){var y=h[f],S=y.className,w=y.style,L=u.appendChild(U("div",null,"CodeMirror-gutter "+S));w&&(L.style.cssText=w),S=="CodeMirror-linenumbers"&&(s.lineGutter=L,L.style.width=(s.lineNumWidth||1)+"px")}u.style.display=h.length?"":"none",zy(s)}function Gu(s){LT(s.display),dr(s),wT(s)}function AB(s,u,h,f){var y=this;this.input=h,y.scrollbarFiller=U("div",null,"CodeMirror-scrollbar-filler"),y.scrollbarFiller.setAttribute("cm-not-content","true"),y.gutterFiller=U("div",null,"CodeMirror-gutter-filler"),y.gutterFiller.setAttribute("cm-not-content","true"),y.lineDiv=N("div",null,"CodeMirror-code"),y.selectionDiv=U("div",null,null,"position: relative; z-index: 1"),y.cursorDiv=U("div",null,"CodeMirror-cursors"),y.measure=U("div",null,"CodeMirror-measure"),y.lineMeasure=U("div",null,"CodeMirror-measure"),y.lineSpace=N("div",[y.measure,y.lineMeasure,y.selectionDiv,y.cursorDiv,y.lineDiv],null,"position: relative; outline: none");var S=N("div",[y.lineSpace],"CodeMirror-lines");y.mover=U("div",[S],null,"position: relative"),y.sizer=U("div",[y.mover],"CodeMirror-sizer"),y.sizerWidth=null,y.heightForcer=U("div",null,null,"position: absolute; height: "+ke+"px; width: 1px;"),y.gutters=U("div",null,"CodeMirror-gutters"),y.lineGutter=null,y.scroller=U("div",[y.sizer,y.heightForcer,y.gutters],"CodeMirror-scroll"),y.scroller.setAttribute("tabIndex","-1"),y.wrapper=U("div",[y.scrollbarFiller,y.gutterFiller,y.scroller],"CodeMirror"),o&&l<8&&(y.gutters.style.zIndex=-1,y.scroller.style.paddingRight=0),!c&&!(t&&T)&&(y.scroller.draggable=!0),s&&(s.appendChild?s.appendChild(y.wrapper):s(y.wrapper)),y.viewFrom=y.viewTo=u.first,y.reportedViewFrom=y.reportedViewTo=u.first,y.view=[],y.renderedView=null,y.externalMeasured=null,y.viewOffset=0,y.lastWrapHeight=y.lastWrapWidth=0,y.updateLineNumbers=null,y.nativeBarWidth=y.barHeight=y.barWidth=0,y.scrollbarsClipped=!1,y.lineNumWidth=y.lineNumInnerWidth=y.lineNumChars=null,y.alignWidgets=!1,y.cachedCharWidth=y.cachedTextHeight=y.cachedPaddingH=null,y.maxLine=null,y.maxLineLength=0,y.maxLineChanged=!1,y.wheelDX=y.wheelDY=y.wheelStartX=y.wheelStartY=null,y.shift=!1,y.selForContextMenu=null,y.activeTouch=null,y.gutterSpecs=$y(f.gutters,f.lineNumbers),LT(y),h.init(y)}var xf=0,jr=null;o?jr=-.53:t?jr=15:p?jr=-.7:g&&(jr=-1/3);function kT(s){var u=s.wheelDeltaX,h=s.wheelDeltaY;return u==null&&s.detail&&s.axis==s.HORIZONTAL_AXIS&&(u=s.detail),h==null&&s.detail&&s.axis==s.VERTICAL_AXIS?h=s.detail:h==null&&(h=s.wheelDelta),{x:u,y:h}}function MB(s){var u=kT(s);return u.x*=jr,u.y*=jr,u}function ET(s,u){var h=kT(u),f=h.x,y=h.y,S=s.display,w=S.scroller,L=w.scrollWidth>w.clientWidth,k=w.scrollHeight>w.clientHeight;if(!!(f&&L||y&&k)){if(y&&I&&c){e:for(var A=u.target,F=S.view;A!=w;A=A.parentNode)for(var H=0;H<F.length;H++)if(F[H].node==A){s.display.currentWheelTarget=A;break e}}if(f&&!t&&!m&&jr!=null){y&&k&&Nu(s,Math.max(0,w.scrollTop+y*jr)),Bs(s,Math.max(0,w.scrollLeft+f*jr)),(!y||y&&k)&&_n(u),S.wheelStartX=null;return}if(y&&jr!=null){var Y=y*jr,q=s.doc.scrollTop,ee=q+S.wrapper.clientHeight;Y<0?q=Math.max(0,q+Y-50):ee=Math.min(s.doc.height,ee+Y+50),Wy(s,{top:q,bottom:ee})}xf<20&&(S.wheelStartX==null?(S.wheelStartX=w.scrollLeft,S.wheelStartY=w.scrollTop,S.wheelDX=f,S.wheelDY=y,setTimeout(function(){if(S.wheelStartX!=null){var ne=w.scrollLeft-S.wheelStartX,de=w.scrollTop-S.wheelStartY,fe=de&&S.wheelDY&&de/S.wheelDY||ne&&S.wheelDX&&ne/S.wheelDX;S.wheelStartX=S.wheelStartY=null,!!fe&&(jr=(jr*xf+fe)/(xf+1),++xf)}},200)):(S.wheelDX+=f,S.wheelDY+=y))}}var Jr=function(s,u){this.ranges=s,this.primIndex=u};Jr.prototype.primary=function(){return this.ranges[this.primIndex]},Jr.prototype.equals=function(s){if(s==this)return!0;if(s.primIndex!=this.primIndex||s.ranges.length!=this.ranges.length)return!1;for(var u=0;u<this.ranges.length;u++){var h=this.ranges[u],f=s.ranges[u];if(!$(h.anchor,f.anchor)||!$(h.head,f.head))return!1}return!0},Jr.prototype.deepCopy=function(){for(var s=[],u=0;u<this.ranges.length;u++)s[u]=new ht(te(this.ranges[u].anchor),te(this.ranges[u].head));return new Jr(s,this.primIndex)},Jr.prototype.somethingSelected=function(){for(var s=0;s<this.ranges.length;s++)if(!this.ranges[s].empty())return!0;return!1},Jr.prototype.contains=function(s,u){u||(u=s);for(var h=0;h<this.ranges.length;h++){var f=this.ranges[h];if(R(u,f.from())>=0&&R(s,f.to())<=0)return h}return-1};var ht=function(s,u){this.anchor=s,this.head=u};ht.prototype.from=function(){return Ge(this.anchor,this.head)},ht.prototype.to=function(){return ue(this.anchor,this.head)},ht.prototype.empty=function(){return this.head.line==this.anchor.line&&this.head.ch==this.anchor.ch};function Ai(s,u,h){var f=s&&s.options.selectionsMayTouch,y=u[h];u.sort(function(Y,q){return R(Y.from(),q.from())}),h=ye(u,y);for(var S=1;S<u.length;S++){var w=u[S],L=u[S-1],k=R(L.to(),w.from());if(f&&!w.empty()?k>0:k>=0){var A=Ge(L.from(),w.from()),F=ue(L.to(),w.to()),H=L.empty()?w.from()==w.head:L.from()==L.head;S<=h&&--h,u.splice(--S,2,new ht(H?F:A,H?A:F))}}return new Jr(u,h)}function Ro(s,u){return new Jr([new ht(s,u||s)],0)}function _o(s){return s.text?se(s.from.line+s.text.length-1,nt(s.text).length+(s.text.length==1?s.from.ch:0)):s.to}function DT(s,u){if(R(s,u.from)<0)return s;if(R(s,u.to)<=0)return _o(u);var h=s.line+u.text.length-(u.to.line-u.from.line)-1,f=s.ch;return s.line==u.to.line&&(f+=_o(u).ch-u.to.ch),se(h,f)}function jy(s,u){for(var h=[],f=0;f<s.sel.ranges.length;f++){var y=s.sel.ranges[f];h.push(new ht(DT(y.anchor,u),DT(y.head,u)))}return Ai(s.cm,h,s.sel.primIndex)}function PT(s,u,h){return s.line==u.line?se(h.line,s.ch-u.ch+h.ch):se(h.line+(s.line-u.line),s.ch)}function RB(s,u,h){for(var f=[],y=se(s.first,0),S=y,w=0;w<u.length;w++){var L=u[w],k=PT(L.from,y,S),A=PT(_o(L),y,S);if(y=L.to,S=A,h=="around"){var F=s.sel.ranges[w],H=R(F.head,F.anchor)<0;f[w]=new ht(H?A:k,H?k:A)}else f[w]=new ht(k,k)}return new Jr(f,s.sel.primIndex)}function Jy(s){s.doc.mode=Kl(s.options,s.doc.modeOption),Wu(s)}function Wu(s){s.doc.iter(function(u){u.stateAfter&&(u.stateAfter=null),u.styles&&(u.styles=null)}),s.doc.modeFrontier=s.doc.highlightFrontier=s.doc.first,Fu(s,100),s.state.modeGen++,s.curOp&&dr(s)}function IT(s,u){return u.from.ch==0&&u.to.ch==0&&nt(u.text)==""&&(!s.cm||s.cm.options.wholeLineUpdateBefore)}function qy(s,u,h,f){function y(Se){return h?h[Se]:null}function S(Se,he,be){GN(Se,he,be,f),un(Se,"change",Se,u)}function w(Se,he){for(var be=[],Ae=Se;Ae<he;++Ae)be.push(new Ql(A[Ae],y(Ae),f));return be}var L=u.from,k=u.to,A=u.text,F=Te(s,L.line),H=Te(s,k.line),Y=nt(A),q=y(A.length-1),ee=k.line-L.line;if(u.full)s.insert(0,w(0,A.length)),s.remove(A.length,s.size-A.length);else if(IT(s,u)){var ne=w(0,A.length-1);S(H,H.text,q),ee&&s.remove(L.line,ee),ne.length&&s.insert(L.line,ne)}else if(F==H)if(A.length==1)S(F,F.text.slice(0,L.ch)+Y+F.text.slice(k.ch),q);else{var de=w(1,A.length-1);de.push(new Ql(Y+F.text.slice(k.ch),q,f)),S(F,F.text.slice(0,L.ch)+A[0],y(0)),s.insert(L.line+1,de)}else if(A.length==1)S(F,F.text.slice(0,L.ch)+A[0]+H.text.slice(k.ch),y(0)),s.remove(L.line+1,ee);else{S(F,F.text.slice(0,L.ch)+A[0],y(0)),S(H,Y+H.text.slice(k.ch),q);var fe=w(1,A.length-1);ee>1&&s.remove(L.line+1,ee-1),s.insert(L.line+1,fe)}un(s,"change",s,u)}function Vo(s,u,h){function f(y,S,w){if(y.linked)for(var L=0;L<y.linked.length;++L){var k=y.linked[L];if(k.doc!=S){var A=w&&k.sharedHist;h&&!A||(u(k.doc,A),f(k.doc,y,A))}}}f(s,null,!0)}function AT(s,u){if(u.cm)throw new Error("This document is already in use.");s.doc=u,u.cm=s,Vy(s),Jy(s),MT(s),s.options.direction=u.direction,s.options.lineWrapping||wy(s),s.options.mode=u.modeOption,dr(s)}function MT(s){(s.doc.direction=="rtl"?me:B)(s.display.lineDiv,"CodeMirror-rtl")}function _B(s){Ir(s,function(){MT(s),dr(s)})}function Cf(s){this.done=[],this.undone=[],this.undoDepth=s?s.undoDepth:Infinity,this.lastModTime=this.lastSelTime=0,this.lastOp=this.lastSelOp=null,this.lastOrigin=this.lastSelOrigin=null,this.generation=this.maxGeneration=s?s.maxGeneration:1}function Yy(s,u){var h={from:te(u.from),to:_o(u),text:la(s,u.from,u.to)};return VT(s,h,u.from.line,u.to.line+1),Vo(s,function(f){return VT(f,h,u.from.line,u.to.line+1)},!0),h}function RT(s){for(;s.length;){var u=nt(s);if(u.ranges)s.pop();else break}}function VB(s,u){if(u)return RT(s.done),nt(s.done);if(s.done.length&&!nt(s.done).ranges)return nt(s.done);if(s.done.length>1&&!s.done[s.done.length-2].ranges)return s.done.pop(),nt(s.done)}function _T(s,u,h,f){var y=s.history;y.undone.length=0;var S=+new Date,w,L;if((y.lastOp==f||y.lastOrigin==u.origin&&u.origin&&(u.origin.charAt(0)=="+"&&y.lastModTime>S-(s.cm?s.cm.options.historyEventDelay:500)||u.origin.charAt(0)=="*"))&&(w=VB(y,y.lastOp==f)))L=nt(w.changes),R(u.from,u.to)==0&&R(u.from,L.to)==0?L.to=_o(u):w.changes.push(Yy(s,u));else{var k=nt(y.done);for((!k||!k.ranges)&&wf(s.sel,y.done),w={changes:[Yy(s,u)],generation:y.generation},y.done.push(w);y.done.length>y.undoDepth;)y.done.shift(),y.done[0].ranges||y.done.shift()}y.done.push(h),y.generation=++y.maxGeneration,y.lastModTime=y.lastSelTime=S,y.lastOp=y.lastSelOp=f,y.lastOrigin=y.lastSelOrigin=u.origin,L||Fe(s,"historyAdded")}function OB(s,u,h,f){var y=u.charAt(0);return y=="*"||y=="+"&&h.ranges.length==f.ranges.length&&h.somethingSelected()==f.somethingSelected()&&new Date-s.history.lastSelTime<=(s.cm?s.cm.options.historyEventDelay:500)}function NB(s,u,h,f){var y=s.history,S=f&&f.origin;h==y.lastSelOp||S&&y.lastSelOrigin==S&&(y.lastModTime==y.lastSelTime&&y.lastOrigin==S||OB(s,S,nt(y.done),u))?y.done[y.done.length-1]=u:wf(u,y.done),y.lastSelTime=+new Date,y.lastSelOrigin=S,y.lastSelOp=h,f&&f.clearRedo!==!1&&RT(y.undone)}function wf(s,u){var h=nt(u);h&&h.ranges&&h.equals(s)||u.push(s)}function VT(s,u,h,f){var y=u["spans_"+s.id],S=0;s.iter(Math.max(s.first,h),Math.min(s.first+s.size,f),function(w){w.markedSpans&&((y||(y=u["spans_"+s.id]={}))[S]=w.markedSpans),++S})}function BB(s){if(!s)return null;for(var u,h=0;h<s.length;++h)s[h].marker.explicitlyCleared?u||(u=s.slice(0,h)):u&&u.push(s[h]);return u?u.length?u:null:s}function UB(s,u){var h=u["spans_"+s.id];if(!h)return null;for(var f=[],y=0;y<u.text.length;++y)f.push(BB(h[y]));return f}function OT(s,u){var h=UB(s,u),f=Sy(s,u);if(!h)return f;if(!f)return h;for(var y=0;y<h.length;++y){var S=h[y],w=f[y];if(S&&w){e:for(var L=0;L<w.length;++L){for(var k=w[L],A=0;A<S.length;++A)if(S[A].marker==k.marker)continue e;S.push(k)}}else w&&(h[y]=w)}return h}function oc(s,u,h){for(var f=[],y=0;y<s.length;++y){var S=s[y];if(S.ranges){f.push(h?Jr.prototype.deepCopy.call(S):S);continue}var w=S.changes,L=[];f.push({changes:L});for(var k=0;k<w.length;++k){var A=w[k],F=void 0;if(L.push({from:A.from,to:A.to,text:A.text}),u)for(var H in A)(F=H.match(/^spans_(\d+)$/))&&ye(u,Number(F[1]))>-1&&(nt(L)[H]=A[H],delete A[H])}}return f}function Ky(s,u,h,f){if(f){var y=s.anchor;if(h){var S=R(u,y)<0;S!=R(h,y)<0?(y=u,u=h):S!=R(u,h)<0&&(u=h)}return new ht(y,u)}else return new ht(h||u,u)}function Tf(s,u,h,f,y){y==null&&(y=s.cm&&(s.cm.display.shift||s.extend)),On(s,new Jr([Ky(s.sel.primary(),u,h,y)],0),f)}function NT(s,u,h){for(var f=[],y=s.cm&&(s.cm.display.shift||s.extend),S=0;S<s.sel.ranges.length;S++)f[S]=Ky(s.sel.ranges[S],u[S],null,y);var w=Ai(s.cm,f,s.sel.primIndex);On(s,w,h)}function Xy(s,u,h,f){var y=s.sel.ranges.slice(0);y[u]=h,On(s,Ai(s.cm,y,s.sel.primIndex),f)}function BT(s,u,h,f){On(s,Ro(u,h),f)}function FB(s,u,h){var f={ranges:u.ranges,update:function(y){this.ranges=[];for(var S=0;S<y.length;S++)this.ranges[S]=new ht(ve(s,y[S].anchor),ve(s,y[S].head))},origin:h&&h.origin};return Fe(s,"beforeSelectionChange",s,f),s.cm&&Fe(s.cm,"beforeSelectionChange",s.cm,f),f.ranges!=u.ranges?Ai(s.cm,f.ranges,f.ranges.length-1):u}function UT(s,u,h){var f=s.history.done,y=nt(f);y&&y.ranges?(f[f.length-1]=u,Lf(s,u,h)):On(s,u,h)}function On(s,u,h){Lf(s,u,h),NB(s,s.sel,s.cm?s.cm.curOp.id:NaN,h)}function Lf(s,u,h){(Ln(s,"beforeSelectionChange")||s.cm&&Ln(s.cm,"beforeSelectionChange"))&&(u=FB(s,u,h));var f=h&&h.bias||(R(u.primary().head,s.sel.primary().head)<0?-1:1);FT(s,WT(s,u,f,!0)),!(h&&h.scroll===!1)&&s.cm&&s.cm.getOption("readOnly")!="nocursor"&&ic(s.cm)}function FT(s,u){u.equals(s.sel)||(s.sel=u,s.cm&&(s.cm.curOp.updateInput=1,s.cm.curOp.selectionChanged=!0,Jl(s.cm)),un(s,"cursorActivity",s))}function GT(s){FT(s,WT(s,s.sel,null,!1))}function WT(s,u,h,f){for(var y,S=0;S<u.ranges.length;S++){var w=u.ranges[S],L=u.ranges.length==s.sel.ranges.length&&s.sel.ranges[S],k=kf(s,w.anchor,L&&L.anchor,h,f),A=kf(s,w.head,L&&L.head,h,f);(y||k!=w.anchor||A!=w.head)&&(y||(y=u.ranges.slice(0,S)),y[S]=new ht(k,A))}return y?Ai(s.cm,y,u.primIndex):u}function sc(s,u,h,f,y){var S=Te(s,u.line);if(S.markedSpans)for(var w=0;w<S.markedSpans.length;++w){var L=S.markedSpans[w],k=L.marker,A="selectLeft"in k?!k.selectLeft:k.inclusiveLeft,F="selectRight"in k?!k.selectRight:k.inclusiveRight;if((L.from==null||(A?L.from<=u.ch:L.from<u.ch))&&(L.to==null||(F?L.to>=u.ch:L.to>u.ch))){if(y&&(Fe(k,"beforeCursorEnter"),k.explicitlyCleared))if(S.markedSpans){--w;continue}else break;if(!k.atomic)continue;if(h){var H=k.find(f<0?1:-1),Y=void 0;if((f<0?F:A)&&(H=zT(s,H,-f,H&&H.line==u.line?S:null)),H&&H.line==u.line&&(Y=R(H,h))&&(f<0?Y<0:Y>0))return sc(s,H,u,f,y)}var q=k.find(f<0?-1:1);return(f<0?A:F)&&(q=zT(s,q,f,q.line==u.line?S:null)),q?sc(s,q,u,f,y):null}}return u}function kf(s,u,h,f,y){var S=f||1,w=sc(s,u,h,S,y)||!y&&sc(s,u,h,S,!0)||sc(s,u,h,-S,y)||!y&&sc(s,u,h,-S,!0);return w||(s.cantEdit=!0,se(s.first,0))}function zT(s,u,h,f){return h<0&&u.ch==0?u.line>s.first?ve(s,se(u.line-1)):null:h>0&&u.ch==(f||Te(s,u.line)).text.length?u.line<s.first+s.size-1?se(u.line+1,0):null:new se(u.line,u.ch+h)}function HT(s){s.setSelection(se(s.firstLine(),0),se(s.lastLine()),Je)}function $T(s,u,h){var f={canceled:!1,from:u.from,to:u.to,text:u.text,origin:u.origin,cancel:function(){return f.canceled=!0}};return h&&(f.update=function(y,S,w,L){y&&(f.from=ve(s,y)),S&&(f.to=ve(s,S)),w&&(f.text=w),L!==void 0&&(f.origin=L)}),Fe(s,"beforeChange",s,f),s.cm&&Fe(s.cm,"beforeChange",s.cm,f),f.canceled?(s.cm&&(s.cm.curOp.updateInput=2),null):{from:f.from,to:f.to,text:f.text,origin:f.origin}}function lc(s,u,h){if(s.cm){if(!s.cm.curOp)return dn(s.cm,lc)(s,u,h);if(s.cm.state.suppressEdits)return}if(!((Ln(s,"beforeChange")||s.cm&&Ln(s.cm,"beforeChange"))&&(u=$T(s,u,!0),!u))){var f=V0&&!h&&NN(s,u.from,u.to);if(f)for(var y=f.length-1;y>=0;--y)jT(s,{from:f[y].from,to:f[y].to,text:y?[""]:u.text,origin:u.origin});else jT(s,u)}}function jT(s,u){if(!(u.text.length==1&&u.text[0]==""&&R(u.from,u.to)==0)){var h=jy(s,u);_T(s,u,h,s.cm?s.cm.curOp.id:NaN),zu(s,u,h,Sy(s,u));var f=[];Vo(s,function(y,S){!S&&ye(f,y.history)==-1&&(KT(y.history,u),f.push(y.history)),zu(y,u,null,Sy(y,u))})}}function Ef(s,u,h){var f=s.cm&&s.cm.state.suppressEdits;if(!(f&&!h)){for(var y=s.history,S,w=s.sel,L=u=="undo"?y.done:y.undone,k=u=="undo"?y.undone:y.done,A=0;A<L.length&&(S=L[A],!(h?S.ranges&&!S.equals(s.sel):!S.ranges));A++);if(A!=L.length){for(y.lastOrigin=y.lastSelOrigin=null;;)if(S=L.pop(),S.ranges){if(wf(S,k),h&&!S.equals(s.sel)){On(s,S,{clearRedo:!1});return}w=S}else if(f){L.push(S);return}else break;var F=[];wf(w,k),k.push({changes:F,generation:y.generation}),y.generation=S.generation||++y.maxGeneration;for(var H=Ln(s,"beforeChange")||s.cm&&Ln(s.cm,"beforeChange"),Y=function(ne){var de=S.changes[ne];if(de.origin=u,H&&!$T(s,de,!1))return L.length=0,{};F.push(Yy(s,de));var fe=ne?jy(s,de):nt(L);zu(s,de,fe,OT(s,de)),!ne&&s.cm&&s.cm.scrollIntoView({from:de.from,to:_o(de)});var Se=[];Vo(s,function(he,be){!be&&ye(Se,he.history)==-1&&(KT(he.history,de),Se.push(he.history)),zu(he,de,null,OT(he,de))})},q=S.changes.length-1;q>=0;--q){var ee=Y(q);if(ee)return ee.v}}}}function JT(s,u){if(u!=0&&(s.first+=u,s.sel=new Jr(Er(s.sel.ranges,function(y){return new ht(se(y.anchor.line+u,y.anchor.ch),se(y.head.line+u,y.head.ch))}),s.sel.primIndex),s.cm)){dr(s.cm,s.first,s.first-u,u);for(var h=s.cm.display,f=h.viewFrom;f<h.viewTo;f++)Ao(s.cm,f,"gutter")}}function zu(s,u,h,f){if(s.cm&&!s.cm.curOp)return dn(s.cm,zu)(s,u,h,f);if(u.to.line<s.first){JT(s,u.text.length-1-(u.to.line-u.from.line));return}if(!(u.from.line>s.lastLine())){if(u.from.line<s.first){var y=u.text.length-1-(s.first-u.from.line);JT(s,y),u={from:se(s.first,0),to:se(u.to.line+y,u.to.ch),text:[nt(u.text)],origin:u.origin}}var S=s.lastLine();u.to.line>S&&(u={from:u.from,to:se(S,Te(s,S).text.length),text:[u.text[0]],origin:u.origin}),u.removed=la(s,u.from,u.to),h||(h=jy(s,u)),s.cm?GB(s.cm,u,f):qy(s,u,f),Lf(s,h,Je),s.cantEdit&&kf(s,se(s.firstLine(),0))&&(s.cantEdit=!1)}}function GB(s,u,h){var f=s.doc,y=s.display,S=u.from,w=u.to,L=!1,k=S.line;s.options.lineWrapping||(k=ft(da(Te(f,S.line))),f.iter(k,w.line+1,function(q){if(q==y.maxLine)return L=!0,!0})),f.sel.contains(u.from,u.to)>-1&&Jl(s),qy(f,u,h,dT(s)),s.options.lineWrapping||(f.iter(k,S.line+u.text.length,function(q){var ee=df(q);ee>y.maxLineLength&&(y.maxLine=q,y.maxLineLength=ee,y.maxLineChanged=!0,L=!1)}),L&&(s.curOp.updateMaxLine=!0)),IN(f,S.line),Fu(s,400);var A=u.text.length-(w.line-S.line)-1;u.full?dr(s):S.line==w.line&&u.text.length==1&&!IT(s.doc,u)?Ao(s,S.line,"text"):dr(s,S.line,w.line+1,A);var F=Ln(s,"changes"),H=Ln(s,"change");if(H||F){var Y={from:S,to:w,text:u.text,removed:u.removed,origin:u.origin};H&&un(s,"change",s,Y),F&&(s.curOp.changeObjs||(s.curOp.changeObjs=[])).push(Y)}s.display.selForContextMenu=null}function cc(s,u,h,f,y){var S;f||(f=h),R(f,h)<0&&(S=[f,h],h=S[0],f=S[1]),typeof u=="string"&&(u=s.splitLines(u)),lc(s,{from:h,to:f,text:u,origin:y})}function qT(s,u,h,f){h<s.line?s.line+=f:u<s.line&&(s.line=u,s.ch=0)}function YT(s,u,h,f){for(var y=0;y<s.length;++y){var S=s[y],w=!0;if(S.ranges){S.copied||(S=s[y]=S.deepCopy(),S.copied=!0);for(var L=0;L<S.ranges.length;L++)qT(S.ranges[L].anchor,u,h,f),qT(S.ranges[L].head,u,h,f);continue}for(var k=0;k<S.changes.length;++k){var A=S.changes[k];if(h<A.from.line)A.from=se(A.from.line+f,A.from.ch),A.to=se(A.to.line+f,A.to.ch);else if(u<=A.to.line){w=!1;break}}w||(s.splice(0,y+1),y=0)}}function KT(s,u){var h=u.from.line,f=u.to.line,y=u.text.length-(f-h)-1;YT(s.done,h,f,y),YT(s.undone,h,f,y)}function Hu(s,u,h,f){var y=u,S=u;return typeof u=="number"?S=Te(s,st(s,u)):y=ft(u),y==null?null:(f(S,y)&&s.cm&&Ao(s.cm,y,h),S)}function $u(s){this.lines=s,this.parent=null;for(var u=0,h=0;h<s.length;++h)s[h].parent=this,u+=s[h].height;this.height=u}$u.prototype={chunkSize:function(){return this.lines.length},removeInner:function(s,u){for(var h=s,f=s+u;h<f;++h){var y=this.lines[h];this.height-=y.height,WN(y),un(y,"delete")}this.lines.splice(s,u)},collapse:function(s){s.push.apply(s,this.lines)},insertInner:function(s,u,h){this.height+=h,this.lines=this.lines.slice(0,s).concat(u).concat(this.lines.slice(s));for(var f=0;f<u.length;++f)u[f].parent=this},iterN:function(s,u,h){for(var f=s+u;s<f;++s)if(h(this.lines[s]))return!0}};function ju(s){this.children=s;for(var u=0,h=0,f=0;f<s.length;++f){var y=s[f];u+=y.chunkSize(),h+=y.height,y.parent=this}this.size=u,this.height=h,this.parent=null}ju.prototype={chunkSize:function(){return this.size},removeInner:function(s,u){this.size-=u;for(var h=0;h<this.children.length;++h){var f=this.children[h],y=f.chunkSize();if(s<y){var S=Math.min(u,y-s),w=f.height;if(f.removeInner(s,S),this.height-=w-f.height,y==S&&(this.children.splice(h--,1),f.parent=null),(u-=S)==0)break;s=0}else s-=y}if(this.size-u<25&&(this.children.length>1||!(this.children[0]instanceof $u))){var L=[];this.collapse(L),this.children=[new $u(L)],this.children[0].parent=this}},collapse:function(s){for(var u=0;u<this.children.length;++u)this.children[u].collapse(s)},insertInner:function(s,u,h){this.size+=u.length,this.height+=h;for(var f=0;f<this.children.length;++f){var y=this.children[f],S=y.chunkSize();if(s<=S){if(y.insertInner(s,u,h),y.lines&&y.lines.length>50){for(var w=y.lines.length%25+25,L=w;L<y.lines.length;){var k=new $u(y.lines.slice(L,L+=25));y.height-=k.height,this.children.splice(++f,0,k),k.parent=this}y.lines=y.lines.slice(0,w),this.maybeSpill()}break}s-=S}},maybeSpill:function(){if(!(this.children.length<=10)){var s=this;do{var u=s.children.splice(s.children.length-5,5),h=new ju(u);if(s.parent){s.size-=h.size,s.height-=h.height;var y=ye(s.parent.children,s);s.parent.children.splice(y+1,0,h)}else{var f=new ju(s.children);f.parent=s,s.children=[f,h],s=f}h.parent=s.parent}while(s.children.length>10);s.parent.maybeSpill()}},iterN:function(s,u,h){for(var f=0;f<this.children.length;++f){var y=this.children[f],S=y.chunkSize();if(s<S){var w=Math.min(u,S-s);if(y.iterN(s,w,h))return!0;if((u-=w)==0)break;s=0}else s-=S}}};var Ju=function(s,u,h){if(h)for(var f in h)h.hasOwnProperty(f)&&(this[f]=h[f]);this.doc=s,this.node=u};Ju.prototype.clear=function(){var s=this.doc.cm,u=this.line.widgets,h=this.line,f=ft(h);if(!(f==null||!u)){for(var y=0;y<u.length;++y)u[y]==this&&u.splice(y--,1);u.length||(h.widgets=null);var S=Ru(this);Pr(h,Math.max(0,h.height-S)),s&&(Ir(s,function(){XT(s,h,-S),Ao(s,f,"widget")}),un(s,"lineWidgetCleared",s,this,f))}},Ju.prototype.changed=function(){var s=this,u=this.height,h=this.doc.cm,f=this.line;this.height=null;var y=Ru(this)-u;!y||(Io(this.doc,f)||Pr(f,f.height+y),h&&Ir(h,function(){h.curOp.forceUpdate=!0,XT(h,f,y),un(h,"lineWidgetChanged",h,s,ft(f))}))},oa(Ju);function XT(s,u,h){$a(u)<(s.curOp&&s.curOp.scrollTop||s.doc.scrollTop)&&Fy(s,h)}function WB(s,u,h,f){var y=new Ju(s,h,f),S=s.cm;return S&&y.noHScroll&&(S.display.alignWidgets=!0),Hu(s,u,"widget",function(w){var L=w.widgets||(w.widgets=[]);if(y.insertAt==null?L.push(y):L.splice(Math.min(L.length,Math.max(0,y.insertAt)),0,y),y.line=w,S&&!Io(s,w)){var k=$a(w)<s.scrollTop;Pr(w,w.height+Ru(y)),k&&Fy(S,y.height),S.curOp.forceUpdate=!0}return!0}),S&&un(S,"lineWidgetAdded",S,y,typeof u=="number"?u:ft(u)),y}var QT=0,Oo=function(s,u){this.lines=[],this.type=u,this.doc=s,this.id=++QT};Oo.prototype.clear=function(){if(!this.explicitlyCleared){var s=this.doc.cm,u=s&&!s.curOp;if(u&&Fs(s),Ln(this,"clear")){var h=this.find();h&&un(this,"clear",h.from,h.to)}for(var f=null,y=null,S=0;S<this.lines.length;++S){var w=this.lines[S],L=Iu(w.markedSpans,this);s&&!this.collapsed?Ao(s,ft(w),"text"):s&&(L.to!=null&&(y=ft(w)),L.from!=null&&(f=ft(w))),w.markedSpans=RN(w.markedSpans,L),L.from==null&&this.collapsed&&!Io(this.doc,w)&&s&&Pr(w,tc(s.display))}if(s&&this.collapsed&&!s.options.lineWrapping)for(var k=0;k<this.lines.length;++k){var A=da(this.lines[k]),F=df(A);F>s.display.maxLineLength&&(s.display.maxLine=A,s.display.maxLineLength=F,s.display.maxLineChanged=!0)}f!=null&&s&&this.collapsed&&dr(s,f,y+1),this.lines.length=0,this.explicitlyCleared=!0,this.atomic&&this.doc.cantEdit&&(this.doc.cantEdit=!1,s&&GT(s.doc)),s&&un(s,"markerCleared",s,this,f,y),u&&Gs(s),this.parent&&this.parent.clear()}},Oo.prototype.find=function(s,u){s==null&&this.type=="bookmark"&&(s=1);for(var h,f,y=0;y<this.lines.length;++y){var S=this.lines[y],w=Iu(S.markedSpans,this);if(w.from!=null&&(h=se(u?S:ft(S),w.from),s==-1))return h;if(w.to!=null&&(f=se(u?S:ft(S),w.to),s==1))return f}return h&&{from:h,to:f}},Oo.prototype.changed=function(){var s=this,u=this.find(-1,!0),h=this,f=this.doc.cm;!u||!f||Ir(f,function(){var y=u.line,S=ft(u.line),w=Ey(f,S);if(w&&(rT(w),f.curOp.selectionChanged=f.curOp.forceUpdate=!0),f.curOp.updateMaxLine=!0,!Io(h.doc,y)&&h.height!=null){var L=h.height;h.height=null;var k=Ru(h)-L;k&&Pr(y,y.height+k)}un(f,"markerChanged",f,s)})},Oo.prototype.attachLine=function(s){if(!this.lines.length&&this.doc.cm){var u=this.doc.cm.curOp;(!u.maybeHiddenMarkers||ye(u.maybeHiddenMarkers,this)==-1)&&(u.maybeUnhiddenMarkers||(u.maybeUnhiddenMarkers=[])).push(this)}this.lines.push(s)},Oo.prototype.detachLine=function(s){if(this.lines.splice(ye(this.lines,s),1),!this.lines.length&&this.doc.cm){var u=this.doc.cm.curOp;(u.maybeHiddenMarkers||(u.maybeHiddenMarkers=[])).push(this)}},oa(Oo);function uc(s,u,h,f,y){if(f&&f.shared)return zB(s,u,h,f,y);if(s.cm&&!s.cm.curOp)return dn(s.cm,uc)(s,u,h,f,y);var S=new Oo(s,y),w=R(u,h);if(f&&Re(f,S,!1),w>0||w==0&&S.clearWhenEmpty!==!1)return S;if(S.replacedWith&&(S.collapsed=!0,S.widgetNode=N("span",[S.replacedWith],"CodeMirror-widget"),f.handleMouseEvents||S.widgetNode.setAttribute("cm-ignore-events","true"),f.insertLeft&&(S.widgetNode.insertLeft=!0)),S.collapsed){if(G0(s,u.line,u,h,S)||u.line!=h.line&&G0(s,h.line,u,h,S))throw new Error("Inserting collapsed marker partially overlapping an existing one");MN()}S.addToHistory&&_T(s,{from:u,to:h,origin:"markText"},s.sel,NaN);var L=u.line,k=s.cm,A;if(s.iter(L,h.line+1,function(H){k&&S.collapsed&&!k.options.lineWrapping&&da(H)==k.display.maxLine&&(A=!0),S.collapsed&&L!=u.line&&Pr(H,0),_N(H,new sf(S,L==u.line?u.ch:null,L==h.line?h.ch:null),s.cm&&s.cm.curOp),++L}),S.collapsed&&s.iter(u.line,h.line+1,function(H){Io(s,H)&&Pr(H,0)}),S.clearOnEnter&&Ve(S,"beforeCursorEnter",function(){return S.clear()}),S.readOnly&&(AN(),(s.history.done.length||s.history.undone.length)&&s.clearHistory()),S.collapsed&&(S.id=++QT,S.atomic=!0),k){if(A&&(k.curOp.updateMaxLine=!0),S.collapsed)dr(k,u.line,h.line+1);else if(S.className||S.startStyle||S.endStyle||S.css||S.attributes||S.title)for(var F=u.line;F<=h.line;F++)Ao(k,F,"text");S.atomic&&GT(k.doc),un(k,"markerAdded",k,S)}return S}var qu=function(s,u){this.markers=s,this.primary=u;for(var h=0;h<s.length;++h)s[h].parent=this};qu.prototype.clear=function(){if(!this.explicitlyCleared){this.explicitlyCleared=!0;for(var s=0;s<this.markers.length;++s)this.markers[s].clear();un(this,"clear")}},qu.prototype.find=function(s,u){return this.primary.find(s,u)},oa(qu);function zB(s,u,h,f,y){f=Re(f),f.shared=!1;var S=[uc(s,u,h,f,y)],w=S[0],L=f.widgetNode;return Vo(s,function(k){L&&(f.widgetNode=L.cloneNode(!0)),S.push(uc(k,ve(k,u),ve(k,h),f,y));for(var A=0;A<k.linked.length;++A)if(k.linked[A].isParent)return;w=nt(S)}),new qu(S,w)}function ZT(s){return s.findMarks(se(s.first,0),s.clipPos(se(s.lastLine())),function(u){return u.parent})}function HB(s,u){for(var h=0;h<u.length;h++){var f=u[h],y=f.find(),S=s.clipPos(y.from),w=s.clipPos(y.to);if(R(S,w)){var L=uc(s,S,w,f.primary,f.primary.type);f.markers.push(L),L.parent=f}}}function $B(s){for(var u=function(f){var y=s[f],S=[y.primary.doc];Vo(y.primary.doc,function(k){return S.push(k)});for(var w=0;w<y.markers.length;w++){var L=y.markers[w];ye(S,L.doc)==-1&&(L.parent=null,y.markers.splice(w--,1))}},h=0;h<s.length;h++)u(h)}var jB=0,pr=function(s,u,h,f,y){if(!(this instanceof pr))return new pr(s,u,h,f,y);h==null&&(h=0),ju.call(this,[new $u([new Ql("",null)])]),this.first=h,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.cleanGeneration=1,this.modeFrontier=this.highlightFrontier=h;var S=se(h,0);this.sel=Ro(S),this.history=new Cf(null),this.id=++jB,this.modeOption=u,this.lineSep=f,this.direction=y=="rtl"?"rtl":"ltr",this.extend=!1,typeof s=="string"&&(s=this.splitLines(s)),qy(this,{from:S,to:S,text:s}),On(this,Ro(S),Je)};pr.prototype=ia(ju.prototype,{constructor:pr,iter:function(s,u,h){h?this.iterN(s-this.first,u-s,h):this.iterN(this.first,this.first+this.size,s)},insert:function(s,u){for(var h=0,f=0;f<u.length;++f)h+=u[f].height;this.insertInner(s-this.first,u,h)},remove:function(s,u){this.removeInner(s-this.first,u)},getValue:function(s){var u=Eu(this,this.first,this.first+this.size);return s===!1?u:u.join(s||this.lineSeparator())},setValue:pn(function(s){var u=se(this.first,0),h=this.first+this.size-1;lc(this,{from:u,to:se(h,Te(this,h).text.length),text:this.splitLines(s),origin:"setValue",full:!0},!0),this.cm&&Ou(this.cm,0,0),On(this,Ro(u),Je)}),replaceRange:function(s,u,h,f){u=ve(this,u),h=h?ve(this,h):u,cc(this,s,u,h,f)},getRange:function(s,u,h){var f=la(this,ve(this,s),ve(this,u));return h===!1?f:f.join(h||this.lineSeparator())},getLine:function(s){var u=this.getLineHandle(s);return u&&u.text},getLineHandle:function(s){if(Rs(this,s))return Te(this,s)},getLineNumber:function(s){return ft(s)},getLineHandleVisualStart:function(s){return typeof s=="number"&&(s=Te(this,s)),da(s)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(s){return ve(this,s)},getCursor:function(s){var u=this.sel.primary(),h;return s==null||s=="head"?h=u.head:s=="anchor"?h=u.anchor:s=="end"||s=="to"||s===!1?h=u.to():h=u.from(),h},listSelections:function(){return this.sel.ranges},somethingSelected:function(){return this.sel.somethingSelected()},setCursor:pn(function(s,u,h){BT(this,ve(this,typeof s=="number"?se(s,u||0):s),null,h)}),setSelection:pn(function(s,u,h){BT(this,ve(this,s),ve(this,u||s),h)}),extendSelection:pn(function(s,u,h){Tf(this,ve(this,s),u&&ve(this,u),h)}),extendSelections:pn(function(s,u){NT(this,$r(this,s),u)}),extendSelectionsBy:pn(function(s,u){var h=Er(this.sel.ranges,s);NT(this,$r(this,h),u)}),setSelections:pn(function(s,u,h){if(!!s.length){for(var f=[],y=0;y<s.length;y++)f[y]=new ht(ve(this,s[y].anchor),ve(this,s[y].head||s[y].anchor));u==null&&(u=Math.min(s.length-1,this.sel.primIndex)),On(this,Ai(this.cm,f,u),h)}}),addSelection:pn(function(s,u,h){var f=this.sel.ranges.slice(0);f.push(new ht(ve(this,s),ve(this,u||s))),On(this,Ai(this.cm,f,f.length-1),h)}),getSelection:function(s){for(var u=this.sel.ranges,h,f=0;f<u.length;f++){var y=la(this,u[f].from(),u[f].to());h=h?h.concat(y):y}return s===!1?h:h.join(s||this.lineSeparator())},getSelections:function(s){for(var u=[],h=this.sel.ranges,f=0;f<h.length;f++){var y=la(this,h[f].from(),h[f].to());s!==!1&&(y=y.join(s||this.lineSeparator())),u[f]=y}return u},replaceSelection:function(s,u,h){for(var f=[],y=0;y<this.sel.ranges.length;y++)f[y]=s;this.replaceSelections(f,u,h||"+input")},replaceSelections:pn(function(s,u,h){for(var f=[],y=this.sel,S=0;S<y.ranges.length;S++){var w=y.ranges[S];f[S]={from:w.from(),to:w.to(),text:this.splitLines(s[S]),origin:h}}for(var L=u&&u!="end"&&RB(this,f,u),k=f.length-1;k>=0;k--)lc(this,f[k]);L?UT(this,L):this.cm&&ic(this.cm)}),undo:pn(function(){Ef(this,"undo")}),redo:pn(function(){Ef(this,"redo")}),undoSelection:pn(function(){Ef(this,"undo",!0)}),redoSelection:pn(function(){Ef(this,"redo",!0)}),setExtending:function(s){this.extend=s},getExtending:function(){return this.extend},historySize:function(){for(var s=this.history,u=0,h=0,f=0;f<s.done.length;f++)s.done[f].ranges||++u;for(var y=0;y<s.undone.length;y++)s.undone[y].ranges||++h;return{undo:u,redo:h}},clearHistory:function(){var s=this;this.history=new Cf(this.history),Vo(this,function(u){return u.history=s.history},!0)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(s){return s&&(this.history.lastOp=this.history.lastSelOp=this.history.lastOrigin=null),this.history.generation},isClean:function(s){return this.history.generation==(s||this.cleanGeneration)},getHistory:function(){return{done:oc(this.history.done),undone:oc(this.history.undone)}},setHistory:function(s){var u=this.history=new Cf(this.history);u.done=oc(s.done.slice(0),null,!0),u.undone=oc(s.undone.slice(0),null,!0)},setGutterMarker:pn(function(s,u,h){return Hu(this,s,"gutter",function(f){var y=f.gutterMarkers||(f.gutterMarkers={});return y[u]=h,!h&&Ga(y)&&(f.gutterMarkers=null),!0})}),clearGutter:pn(function(s){var u=this;this.iter(function(h){h.gutterMarkers&&h.gutterMarkers[s]&&Hu(u,h,"gutter",function(){return h.gutterMarkers[s]=null,Ga(h.gutterMarkers)&&(h.gutterMarkers=null),!0})})}),lineInfo:function(s){var u;if(typeof s=="number"){if(!Rs(this,s)||(u=s,s=Te(this,s),!s))return null}else if(u=ft(s),u==null)return null;return{line:u,handle:s,text:s.text,gutterMarkers:s.gutterMarkers,textClass:s.textClass,bgClass:s.bgClass,wrapClass:s.wrapClass,widgets:s.widgets}},addLineClass:pn(function(s,u,h){return Hu(this,s,u=="gutter"?"gutter":"class",function(f){var y=u=="text"?"textClass":u=="background"?"bgClass":u=="gutter"?"gutterClass":"wrapClass";if(!f[y])f[y]=h;else{if(O(h).test(f[y]))return!1;f[y]+=" "+h}return!0})}),removeLineClass:pn(function(s,u,h){return Hu(this,s,u=="gutter"?"gutter":"class",function(f){var y=u=="text"?"textClass":u=="background"?"bgClass":u=="gutter"?"gutterClass":"wrapClass",S=f[y];if(S)if(h==null)f[y]=null;else{var w=S.match(O(h));if(!w)return!1;var L=w.index+w[0].length;f[y]=S.slice(0,w.index)+(!w.index||L==S.length?"":" ")+S.slice(L)||null}else return!1;return!0})}),addLineWidget:pn(function(s,u,h){return WB(this,s,u,h)}),removeLineWidget:function(s){s.clear()},markText:function(s,u,h){return uc(this,ve(this,s),ve(this,u),h,h&&h.type||"range")},setBookmark:function(s,u){var h={replacedWith:u&&(u.nodeType==null?u.widget:u),insertLeft:u&&u.insertLeft,clearWhenEmpty:!1,shared:u&&u.shared,handleMouseEvents:u&&u.handleMouseEvents};return s=ve(this,s),uc(this,s,s,h,"bookmark")},findMarksAt:function(s){s=ve(this,s);var u=[],h=Te(this,s.line).markedSpans;if(h)for(var f=0;f<h.length;++f){var y=h[f];(y.from==null||y.from<=s.ch)&&(y.to==null||y.to>=s.ch)&&u.push(y.marker.parent||y.marker)}return u},findMarks:function(s,u,h){s=ve(this,s),u=ve(this,u);var f=[],y=s.line;return this.iter(s.line,u.line+1,function(S){var w=S.markedSpans;if(w)for(var L=0;L<w.length;L++){var k=w[L];!(k.to!=null&&y==s.line&&s.ch>=k.to||k.from==null&&y!=s.line||k.from!=null&&y==u.line&&k.from>=u.ch)&&(!h||h(k.marker))&&f.push(k.marker.parent||k.marker)}++y}),f},getAllMarks:function(){var s=[];return this.iter(function(u){var h=u.markedSpans;if(h)for(var f=0;f<h.length;++f)h[f].from!=null&&s.push(h[f].marker)}),s},posFromIndex:function(s){var u,h=this.first,f=this.lineSeparator().length;return this.iter(function(y){var S=y.text.length+f;if(S>s)return u=s,!0;s-=S,++h}),ve(this,se(h,u))},indexFromPos:function(s){s=ve(this,s);var u=s.ch;if(s.line<this.first||s.ch<0)return 0;var h=this.lineSeparator().length;return this.iter(this.first,s.line,function(f){u+=f.text.length+h}),u},copy:function(s){var u=new pr(Eu(this,this.first,this.first+this.size),this.modeOption,this.first,this.lineSep,this.direction);return u.scrollTop=this.scrollTop,u.scrollLeft=this.scrollLeft,u.sel=this.sel,u.extend=!1,s&&(u.history.undoDepth=this.history.undoDepth,u.setHistory(this.getHistory())),u},linkedDoc:function(s){s||(s={});var u=this.first,h=this.first+this.size;s.from!=null&&s.from>u&&(u=s.from),s.to!=null&&s.to<h&&(h=s.to);var f=new pr(Eu(this,u,h),s.mode||this.modeOption,u,this.lineSep,this.direction);return s.sharedHist&&(f.history=this.history),(this.linked||(this.linked=[])).push({doc:f,sharedHist:s.sharedHist}),f.linked=[{doc:this,isParent:!0,sharedHist:s.sharedHist}],HB(f,ZT(this)),f},unlinkDoc:function(s){if(s instanceof Rt&&(s=s.doc),this.linked)for(var u=0;u<this.linked.length;++u){var h=this.linked[u];if(h.doc==s){this.linked.splice(u,1),s.unlinkDoc(this),$B(ZT(this));break}}if(s.history==this.history){var f=[s.id];Vo(s,function(y){return f.push(y.id)},!0),s.history=new Cf(null),s.history.done=oc(this.history.done,f),s.history.undone=oc(this.history.undone,f)}},iterLinkedDocs:function(s){Vo(this,s)},getMode:function(){return this.mode},getEditor:function(){return this.cm},splitLines:function(s){return this.lineSep?s.split(this.lineSep):wu(s)},lineSeparator:function(){return this.lineSep||`
`},setDirection:pn(function(s){s!="rtl"&&(s="ltr"),s!=this.direction&&(this.direction=s,this.iter(function(u){return u.order=null}),this.cm&&_B(this.cm))})}),pr.prototype.eachLine=pr.prototype.iter;var eL=0;function JB(s){var u=this;if(tL(u),!(Zt(u,s)||ja(u.display,s))){_n(s),o&&(eL=+new Date);var h=Os(u,s,!0),f=s.dataTransfer.files;if(!(!h||u.isReadOnly()))if(f&&f.length&&window.FileReader&&window.File)for(var y=f.length,S=Array(y),w=0,L=function(){++w==y&&dn(u,function(){h=ve(u.doc,h);var q={from:h,to:h,text:u.doc.splitLines(S.filter(function(ee){return ee!=null}).join(u.doc.lineSeparator())),origin:"paste"};lc(u.doc,q),UT(u.doc,Ro(ve(u.doc,h),ve(u.doc,_o(q))))})()},k=function(q,ee){if(u.options.allowDropFileTypes&&ye(u.options.allowDropFileTypes,q.type)==-1){L();return}var ne=new FileReader;ne.onerror=function(){return L()},ne.onload=function(){var de=ne.result;if(/[\x00-\x08\x0e-\x1f]{2}/.test(de)){L();return}S[ee]=de,L()},ne.readAsText(q)},A=0;A<f.length;A++)k(f[A],A);else{if(u.state.draggingText&&u.doc.sel.contains(h)>-1){u.state.draggingText(s),setTimeout(function(){return u.display.input.focus()},20);return}try{var F=s.dataTransfer.getData("Text");if(F){var H;if(u.state.draggingText&&!u.state.draggingText.copy&&(H=u.listSelections()),Lf(u.doc,Ro(h,h)),H)for(var Y=0;Y<H.length;++Y)cc(u.doc,"",H[Y].anchor,H[Y].head,"drag");u.replaceSelection(F,"around","paste"),u.display.input.focus()}}catch(q){}}}}function qB(s,u){if(o&&(!s.state.draggingText||+new Date-eL<100)){Ms(u);return}if(!(Zt(s,u)||ja(s.display,u))&&(u.dataTransfer.setData("Text",s.getSelection()),u.dataTransfer.effectAllowed="copyMove",u.dataTransfer.setDragImage&&!g)){var h=U("img",null,null,"position: fixed; left: 0; top: 0;");h.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",m&&(h.width=h.height=1,s.display.wrapper.appendChild(h),h._top=h.offsetTop),u.dataTransfer.setDragImage(h,0,0),m&&h.parentNode.removeChild(h)}}function YB(s,u){var h=Os(s,u);if(!!h){var f=document.createDocumentFragment();hT(s,h,f),s.display.dragCursor||(s.display.dragCursor=U("div",null,"CodeMirror-cursors CodeMirror-dragcursors"),s.display.lineSpace.insertBefore(s.display.dragCursor,s.display.cursorDiv)),_(s.display.dragCursor,f)}}function tL(s){s.display.dragCursor&&(s.display.lineSpace.removeChild(s.display.dragCursor),s.display.dragCursor=null)}function nL(s){if(!!document.getElementsByClassName){for(var u=document.getElementsByClassName("CodeMirror"),h=[],f=0;f<u.length;f++){var y=u[f].CodeMirror;y&&h.push(y)}h.length&&h[0].operation(function(){for(var S=0;S<h.length;S++)s(h[S])})}}var rL=!1;function KB(){rL||(XB(),rL=!0)}function XB(){var s;Ve(window,"resize",function(){s==null&&(s=setTimeout(function(){s=null,nL(QB)},100))}),Ve(window,"blur",function(){return nL(rc)})}function QB(s){var u=s.display;u.cachedCharWidth=u.cachedTextHeight=u.cachedPaddingH=null,u.scrollbarsClipped=!1,s.setSize()}for(var No={3:"Pause",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",61:"=",91:"Mod",92:"Mod",93:"Mod",106:"*",107:"=",109:"-",110:".",111:"/",145:"ScrollLock",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",224:"Mod",63232:"Up",63233:"Down",63234:"Left",63235:"Right",63272:"Delete",63273:"Home",63275:"End",63276:"PageUp",63277:"PageDown",63302:"Insert"},Yu=0;Yu<10;Yu++)No[Yu+48]=No[Yu+96]=String(Yu);for(var Df=65;Df<=90;Df++)No[Df]=String.fromCharCode(Df);for(var Ku=1;Ku<=12;Ku++)No[Ku+111]=No[Ku+63235]="F"+Ku;var Ja={};Ja.basic={Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharAfter",Backspace:"delCharBefore","Shift-Backspace":"delCharBefore",Tab:"defaultTab","Shift-Tab":"indentAuto",Enter:"newlineAndIndent",Insert:"toggleOverwrite",Esc:"singleSelection"},Ja.pcDefault={"Ctrl-A":"selectAll","Ctrl-D":"deleteLine","Ctrl-Z":"undo","Shift-Ctrl-Z":"redo","Ctrl-Y":"redo","Ctrl-Home":"goDocStart","Ctrl-End":"goDocEnd","Ctrl-Up":"goLineUp","Ctrl-Down":"goLineDown","Ctrl-Left":"goGroupLeft","Ctrl-Right":"goGroupRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delGroupBefore","Ctrl-Delete":"delGroupAfter","Ctrl-S":"save","Ctrl-F":"find","Ctrl-G":"findNext","Shift-Ctrl-G":"findPrev","Shift-Ctrl-F":"replace","Shift-Ctrl-R":"replaceAll","Ctrl-[":"indentLess","Ctrl-]":"indentMore","Ctrl-U":"undoSelection","Shift-Ctrl-U":"redoSelection","Alt-U":"redoSelection",fallthrough:"basic"},Ja.emacsy={"Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageDown","Shift-Ctrl-V":"goPageUp","Ctrl-D":"delCharAfter","Ctrl-H":"delCharBefore","Alt-Backspace":"delWordBefore","Ctrl-K":"killLine","Ctrl-T":"transposeChars","Ctrl-O":"openLine"},Ja.macDefault={"Cmd-A":"selectAll","Cmd-D":"deleteLine","Cmd-Z":"undo","Shift-Cmd-Z":"redo","Cmd-Y":"redo","Cmd-Home":"goDocStart","Cmd-Up":"goDocStart","Cmd-End":"goDocEnd","Cmd-Down":"goDocEnd","Alt-Left":"goGroupLeft","Alt-Right":"goGroupRight","Cmd-Left":"goLineLeft","Cmd-Right":"goLineRight","Alt-Backspace":"delGroupBefore","Ctrl-Alt-Backspace":"delGroupAfter","Alt-Delete":"delGroupAfter","Cmd-S":"save","Cmd-F":"find","Cmd-G":"findNext","Shift-Cmd-G":"findPrev","Cmd-Alt-F":"replace","Shift-Cmd-Alt-F":"replaceAll","Cmd-[":"indentLess","Cmd-]":"indentMore","Cmd-Backspace":"delWrappedLineLeft","Cmd-Delete":"delWrappedLineRight","Cmd-U":"undoSelection","Shift-Cmd-U":"redoSelection","Ctrl-Up":"goDocStart","Ctrl-Down":"goDocEnd",fallthrough:["basic","emacsy"]},Ja.default=I?Ja.macDefault:Ja.pcDefault;function ZB(s){var u=s.split(/-(?!$)/);s=u[u.length-1];for(var h,f,y,S,w=0;w<u.length-1;w++){var L=u[w];if(/^(cmd|meta|m)$/i.test(L))S=!0;else if(/^a(lt)?$/i.test(L))h=!0;else if(/^(c|ctrl|control)$/i.test(L))f=!0;else if(/^s(hift)?$/i.test(L))y=!0;else throw new Error("Unrecognized modifier name: "+L)}return h&&(s="Alt-"+s),f&&(s="Ctrl-"+s),S&&(s="Cmd-"+s),y&&(s="Shift-"+s),s}function eU(s){var u={};for(var h in s)if(s.hasOwnProperty(h)){var f=s[h];if(/^(name|fallthrough|(de|at)tach)$/.test(h))continue;if(f=="..."){delete s[h];continue}for(var y=Er(h.split(" "),ZB),S=0;S<y.length;S++){var w=void 0,L=void 0;S==y.length-1?(L=y.join(" "),w=f):(L=y.slice(0,S+1).join(" "),w="...");var k=u[L];if(!k)u[L]=w;else if(k!=w)throw new Error("Inconsistent bindings for "+L)}delete s[h]}for(var A in u)s[A]=u[A];return s}function dc(s,u,h,f){u=Pf(u);var y=u.call?u.call(s,f):u[s];if(y===!1)return"nothing";if(y==="...")return"multi";if(y!=null&&h(y))return"handled";if(u.fallthrough){if(Object.prototype.toString.call(u.fallthrough)!="[object Array]")return dc(s,u.fallthrough,h,f);for(var S=0;S<u.fallthrough.length;S++){var w=dc(s,u.fallthrough[S],h,f);if(w)return w}}}function iL(s){var u=typeof s=="string"?s:No[s.keyCode];return u=="Ctrl"||u=="Alt"||u=="Shift"||u=="Mod"}function aL(s,u,h){var f=s;return u.altKey&&f!="Alt"&&(s="Alt-"+s),(E?u.metaKey:u.ctrlKey)&&f!="Ctrl"&&(s="Ctrl-"+s),(E?u.ctrlKey:u.metaKey)&&f!="Mod"&&(s="Cmd-"+s),!h&&u.shiftKey&&f!="Shift"&&(s="Shift-"+s),s}function oL(s,u){if(m&&s.keyCode==34&&s.char)return!1;var h=No[s.keyCode];return h==null||s.altGraphKey?!1:(s.keyCode==3&&s.code&&(h=s.code),aL(h,s,u))}function Pf(s){return typeof s=="string"?Ja[s]:s}function pc(s,u){for(var h=s.doc.sel.ranges,f=[],y=0;y<h.length;y++){for(var S=u(h[y]);f.length&&R(S.from,nt(f).to)<=0;){var w=f.pop();if(R(w.from,S.from)<0){S.from=w.from;break}}f.push(S)}Ir(s,function(){for(var L=f.length-1;L>=0;L--)cc(s.doc,"",f[L].from,f[L].to,"+delete");ic(s)})}function Qy(s,u,h){var f=Eo(s.text,u+h,h);return f<0||f>s.text.length?null:f}function Zy(s,u,h){var f=Qy(s,u.ch,h);return f==null?null:new se(u.line,f,h<0?"after":"before")}function ev(s,u,h,f,y){if(s){u.doc.direction=="rtl"&&(y=-y);var S=Dr(h,u.doc.direction);if(S){var w=y<0?nt(S):S[0],L=y<0==(w.level==1),k=L?"after":"before",A;if(w.level>0||u.doc.direction=="rtl"){var F=ec(u,h);A=y<0?h.text.length-1:0;var H=fa(u,F,A).top;A=Rn(function(Y){return fa(u,F,Y).top==H},y<0==(w.level==1)?w.from:w.to-1,A),k=="before"&&(A=Qy(h,A,1))}else A=y<0?w.to:w.from;return new se(f,A,k)}}return new se(f,y<0?h.text.length:0,y<0?"before":"after")}function tU(s,u,h,f){var y=Dr(u,s.doc.direction);if(!y)return Zy(u,h,f);h.ch>=u.text.length?(h.ch=u.text.length,h.sticky="before"):h.ch<=0&&(h.ch=0,h.sticky="after");var S=Lt(y,h.ch,h.sticky),w=y[S];if(s.doc.direction=="ltr"&&w.level%2==0&&(f>0?w.to>h.ch:w.from<h.ch))return Zy(u,h,f);var L=function(fe,Se){return Qy(u,fe instanceof se?fe.ch:fe,Se)},k,A=function(fe){return s.options.lineWrapping?(k=k||ec(s,u),uT(s,u,k,fe)):{begin:0,end:u.text.length}},F=A(h.sticky=="before"?L(h,-1):h.ch);if(s.doc.direction=="rtl"||w.level==1){var H=w.level==1==f<0,Y=L(h,H?1:-1);if(Y!=null&&(H?Y<=w.to&&Y<=F.end:Y>=w.from&&Y>=F.begin)){var q=H?"before":"after";return new se(h.line,Y,q)}}var ee=function(fe,Se,he){for(var be=function(Ct,fn){return fn?new se(h.line,L(Ct,1),"before"):new se(h.line,Ct,"after")};fe>=0&&fe<y.length;fe+=Se){var Ae=y[fe],De=Se>0==(Ae.level!=1),Xe=De?he.begin:L(he.end,-1);if(Ae.from<=Xe&&Xe<Ae.to||(Xe=De?Ae.from:L(Ae.to,-1),he.begin<=Xe&&Xe<he.end))return be(Xe,De)}},ne=ee(S+f,f,F);if(ne)return ne;var de=f>0?F.end:L(F.begin,-1);return de!=null&&!(f>0&&de==u.text.length)&&(ne=ee(f>0?0:y.length-1,f,A(de)),ne)?ne:null}var Xu={selectAll:HT,singleSelection:function(s){return s.setSelection(s.getCursor("anchor"),s.getCursor("head"),Je)},killLine:function(s){return pc(s,function(u){if(u.empty()){var h=Te(s.doc,u.head.line).text.length;return u.head.ch==h&&u.head.line<s.lastLine()?{from:u.head,to:se(u.head.line+1,0)}:{from:u.head,to:se(u.head.line,h)}}else return{from:u.from(),to:u.to()}})},deleteLine:function(s){return pc(s,function(u){return{from:se(u.from().line,0),to:ve(s.doc,se(u.to().line+1,0))}})},delLineLeft:function(s){return pc(s,function(u){return{from:se(u.from().line,0),to:u.from()}})},delWrappedLineLeft:function(s){return pc(s,function(u){var h=s.charCoords(u.head,"div").top+5,f=s.coordsChar({left:0,top:h},"div");return{from:f,to:u.from()}})},delWrappedLineRight:function(s){return pc(s,function(u){var h=s.charCoords(u.head,"div").top+5,f=s.coordsChar({left:s.display.lineDiv.offsetWidth+100,top:h},"div");return{from:u.from(),to:f}})},undo:function(s){return s.undo()},redo:function(s){return s.redo()},undoSelection:function(s){return s.undoSelection()},redoSelection:function(s){return s.redoSelection()},goDocStart:function(s){return s.extendSelection(se(s.firstLine(),0))},goDocEnd:function(s){return s.extendSelection(se(s.lastLine()))},goLineStart:function(s){return s.extendSelectionsBy(function(u){return sL(s,u.head.line)},{origin:"+move",bias:1})},goLineStartSmart:function(s){return s.extendSelectionsBy(function(u){return lL(s,u.head)},{origin:"+move",bias:1})},goLineEnd:function(s){return s.extendSelectionsBy(function(u){return nU(s,u.head.line)},{origin:"+move",bias:-1})},goLineRight:function(s){return s.extendSelectionsBy(function(u){var h=s.cursorCoords(u.head,"div").top+5;return s.coordsChar({left:s.display.lineDiv.offsetWidth+100,top:h},"div")},_e)},goLineLeft:function(s){return s.extendSelectionsBy(function(u){var h=s.cursorCoords(u.head,"div").top+5;return s.coordsChar({left:0,top:h},"div")},_e)},goLineLeftSmart:function(s){return s.extendSelectionsBy(function(u){var h=s.cursorCoords(u.head,"div").top+5,f=s.coordsChar({left:0,top:h},"div");return f.ch<s.getLine(f.line).search(/\S/)?lL(s,u.head):f},_e)},goLineUp:function(s){return s.moveV(-1,"line")},goLineDown:function(s){return s.moveV(1,"line")},goPageUp:function(s){return s.moveV(-1,"page")},goPageDown:function(s){return s.moveV(1,"page")},goCharLeft:function(s){return s.moveH(-1,"char")},goCharRight:function(s){return s.moveH(1,"char")},goColumnLeft:function(s){return s.moveH(-1,"column")},goColumnRight:function(s){return s.moveH(1,"column")},goWordLeft:function(s){return s.moveH(-1,"word")},goGroupRight:function(s){return s.moveH(1,"group")},goGroupLeft:function(s){return s.moveH(-1,"group")},goWordRight:function(s){return s.moveH(1,"word")},delCharBefore:function(s){return s.deleteH(-1,"codepoint")},delCharAfter:function(s){return s.deleteH(1,"char")},delWordBefore:function(s){return s.deleteH(-1,"word")},delWordAfter:function(s){return s.deleteH(1,"word")},delGroupBefore:function(s){return s.deleteH(-1,"group")},delGroupAfter:function(s){return s.deleteH(1,"group")},indentAuto:function(s){return s.indentSelection("smart")},indentMore:function(s){return s.indentSelection("add")},indentLess:function(s){return s.indentSelection("subtract")},insertTab:function(s){return s.replaceSelection("	")},insertSoftTab:function(s){for(var u=[],h=s.listSelections(),f=s.options.tabSize,y=0;y<h.length;y++){var S=h[y].from(),w=Ue(s.getLine(S.line),S.ch,f);u.push(ta(f-w%f))}s.replaceSelections(u)},defaultTab:function(s){s.somethingSelected()?s.indentSelection("add"):s.execCommand("insertTab")},transposeChars:function(s){return Ir(s,function(){for(var u=s.listSelections(),h=[],f=0;f<u.length;f++)if(!!u[f].empty()){var y=u[f].head,S=Te(s.doc,y.line).text;if(S){if(y.ch==S.length&&(y=new se(y.line,y.ch-1)),y.ch>0)y=new se(y.line,y.ch+1),s.replaceRange(S.charAt(y.ch-1)+S.charAt(y.ch-2),se(y.line,y.ch-2),y,"+transpose");else if(y.line>s.doc.first){var w=Te(s.doc,y.line-1).text;w&&(y=new se(y.line,1),s.replaceRange(S.charAt(0)+s.doc.lineSeparator()+w.charAt(w.length-1),se(y.line-1,w.length-1),y,"+transpose"))}}h.push(new ht(y,y))}s.setSelections(h)})},newlineAndIndent:function(s){return Ir(s,function(){for(var u=s.listSelections(),h=u.length-1;h>=0;h--)s.replaceRange(s.doc.lineSeparator(),u[h].anchor,u[h].head,"+input");u=s.listSelections();for(var f=0;f<u.length;f++)s.indentLine(u[f].from().line,null,!0);ic(s)})},openLine:function(s){return s.replaceSelection(`
`,"start")},toggleOverwrite:function(s){return s.toggleOverwrite()}};function sL(s,u){var h=Te(s.doc,u),f=da(h);return f!=h&&(u=ft(f)),ev(!0,s,f,u,1)}function nU(s,u){var h=Te(s.doc,u),f=UN(h);return f!=h&&(u=ft(f)),ev(!0,s,h,u,-1)}function lL(s,u){var h=sL(s,u.line),f=Te(s.doc,h.line),y=Dr(f,s.doc.direction);if(!y||y[0].level==0){var S=Math.max(h.ch,f.text.search(/\S/)),w=u.line==h.line&&u.ch<=S&&u.ch;return se(h.line,w?0:S,h.sticky)}return h}function If(s,u,h){if(typeof u=="string"&&(u=Xu[u],!u))return!1;s.display.input.ensurePolled();var f=s.display.shift,y=!1;try{s.isReadOnly()&&(s.state.suppressEdits=!0),h&&(s.display.shift=!1),y=u(s)!=$e}finally{s.display.shift=f,s.state.suppressEdits=!1}return y}function rU(s,u,h){for(var f=0;f<s.state.keyMaps.length;f++){var y=dc(u,s.state.keyMaps[f],h,s);if(y)return y}return s.options.extraKeys&&dc(u,s.options.extraKeys,h,s)||dc(u,s.options.keyMap,h,s)}var iU=new et;function Qu(s,u,h,f){var y=s.state.keySeq;if(y){if(iL(u))return"handled";if(/\'$/.test(u)?s.state.keySeq=null:iU.set(50,function(){s.state.keySeq==y&&(s.state.keySeq=null,s.display.input.reset())}),cL(s,y+" "+u,h,f))return!0}return cL(s,u,h,f)}function cL(s,u,h,f){var y=rU(s,u,f);return y=="multi"&&(s.state.keySeq=u),y=="handled"&&un(s,"keyHandled",s,u,h),(y=="handled"||y=="multi")&&(_n(h),Oy(s)),!!y}function uL(s,u){var h=oL(u,!0);return h?u.shiftKey&&!s.state.keySeq?Qu(s,"Shift-"+h,u,function(f){return If(s,f,!0)})||Qu(s,h,u,function(f){if(typeof f=="string"?/^go[A-Z]/.test(f):f.motion)return If(s,f)}):Qu(s,h,u,function(f){return If(s,f)}):!1}function aU(s,u,h){return Qu(s,"'"+h+"'",u,function(f){return If(s,f,!0)})}var tv=null;function dL(s){var u=this;if(!(s.target&&s.target!=u.display.input.getField())&&(u.curOp.focus=pe(),!Zt(u,s))){o&&l<11&&s.keyCode==27&&(s.returnValue=!1);var h=s.keyCode;u.display.shift=h==16||s.shiftKey;var f=uL(u,s);m&&(tv=f?h:null,!f&&h==88&&!af&&(I?s.metaKey:s.ctrlKey)&&u.replaceSelection("",null,"cut")),t&&!I&&!f&&h==46&&s.shiftKey&&!s.ctrlKey&&document.execCommand&&document.execCommand("cut"),h==18&&!/\bCodeMirror-crosshair\b/.test(u.display.lineDiv.className)&&oU(u)}}function oU(s){var u=s.display.lineDiv;me(u,"CodeMirror-crosshair");function h(f){(f.keyCode==18||!f.altKey)&&(B(u,"CodeMirror-crosshair"),cr(document,"keyup",h),cr(document,"mouseover",h))}Ve(document,"keyup",h),Ve(document,"mouseover",h)}function pL(s){s.keyCode==16&&(this.doc.sel.shift=!1),Zt(this,s)}function fL(s){var u=this;if(!(s.target&&s.target!=u.display.input.getField())&&!(ja(u.display,s)||Zt(u,s)||s.ctrlKey&&!s.altKey||I&&s.metaKey)){var h=s.keyCode,f=s.charCode;if(m&&h==tv){tv=null,_n(s);return}if(!(m&&(!s.which||s.which<10)&&uL(u,s))){var y=String.fromCharCode(f==null?h:f);y!="\b"&&(aU(u,s,y)||u.display.input.onKeyPress(s))}}}var sU=400,nv=function(s,u,h){this.time=s,this.pos=u,this.button=h};nv.prototype.compare=function(s,u,h){return this.time+sU>s&&R(u,this.pos)==0&&h==this.button};var Zu,ed;function lU(s,u){var h=+new Date;return ed&&ed.compare(h,s,u)?(Zu=ed=null,"triple"):Zu&&Zu.compare(h,s,u)?(ed=new nv(h,s,u),Zu=null,"double"):(Zu=new nv(h,s,u),ed=null,"single")}function hL(s){var u=this,h=u.display;if(!(Zt(u,s)||h.activeTouch&&h.input.supportsTouch())){if(h.input.ensurePolled(),h.shift=s.shiftKey,ja(h,s)){c||(h.scroller.draggable=!1,setTimeout(function(){return h.scroller.draggable=!0},100));return}if(!rv(u,s)){var f=Os(u,s),y=tf(s),S=f?lU(f,y):"single";window.focus(),y==1&&u.state.selectingText&&u.state.selectingText(s),!(f&&cU(u,y,f,S,s))&&(y==1?f?dU(u,f,S,s):Do(s)==h.scroller&&_n(s):y==2?(f&&Tf(u.doc,f),setTimeout(function(){return h.input.focus()},20)):y==3&&(V?u.display.input.onContextMenu(s):Ny(u)))}}}function cU(s,u,h,f,y){var S="Click";return f=="double"?S="Double"+S:f=="triple"&&(S="Triple"+S),S=(u==1?"Left":u==2?"Middle":"Right")+S,Qu(s,aL(S,y),y,function(w){if(typeof w=="string"&&(w=Xu[w]),!w)return!1;var L=!1;try{s.isReadOnly()&&(s.state.suppressEdits=!0),L=w(s,h)!=$e}finally{s.state.suppressEdits=!1}return L})}function uU(s,u,h){var f=s.getOption("configureMouse"),y=f?f(s,u,h):{};if(y.unit==null){var S=P?h.shiftKey&&h.metaKey:h.altKey;y.unit=S?"rectangle":u=="single"?"char":u=="double"?"word":"line"}return(y.extend==null||s.doc.extend)&&(y.extend=s.doc.extend||h.shiftKey),y.addNew==null&&(y.addNew=I?h.metaKey:h.ctrlKey),y.moveOnDrag==null&&(y.moveOnDrag=!(I?h.altKey:h.ctrlKey)),y}function dU(s,u,h,f){o?setTimeout(we(mT,s),0):s.curOp.focus=pe();var y=uU(s,h,f),S=s.doc.sel,w;s.options.dragDrop&&xu&&!s.isReadOnly()&&h=="single"&&(w=S.contains(u))>-1&&(R((w=S.ranges[w]).from(),u)<0||u.xRel>0)&&(R(w.to(),u)>0||u.xRel<0)?pU(s,f,u,y):fU(s,f,u,y)}function pU(s,u,h,f){var y=s.display,S=!1,w=dn(s,function(A){c&&(y.scroller.draggable=!1),s.state.draggingText=!1,s.state.delayingBlurEvent&&(s.hasFocus()?s.state.delayingBlurEvent=!1:Ny(s)),cr(y.wrapper.ownerDocument,"mouseup",w),cr(y.wrapper.ownerDocument,"mousemove",L),cr(y.scroller,"dragstart",k),cr(y.scroller,"drop",w),S||(_n(A),f.addNew||Tf(s.doc,h,null,null,f.extend),c&&!g||o&&l==9?setTimeout(function(){y.wrapper.ownerDocument.body.focus({preventScroll:!0}),y.input.focus()},20):y.input.focus())}),L=function(A){S=S||Math.abs(u.clientX-A.clientX)+Math.abs(u.clientY-A.clientY)>=10},k=function(){return S=!0};c&&(y.scroller.draggable=!0),s.state.draggingText=w,w.copy=!f.moveOnDrag,Ve(y.wrapper.ownerDocument,"mouseup",w),Ve(y.wrapper.ownerDocument,"mousemove",L),Ve(y.scroller,"dragstart",k),Ve(y.scroller,"drop",w),s.state.delayingBlurEvent=!0,setTimeout(function(){return y.input.focus()},20),y.scroller.dragDrop&&y.scroller.dragDrop()}function mL(s,u,h){if(h=="char")return new ht(u,u);if(h=="word")return s.findWordAt(u);if(h=="line")return new ht(se(u.line,0),ve(s.doc,se(u.line+1,0)));var f=h(s,u);return new ht(f.from,f.to)}function fU(s,u,h,f){o&&Ny(s);var y=s.display,S=s.doc;_n(u);var w,L,k=S.sel,A=k.ranges;if(f.addNew&&!f.extend?(L=S.sel.contains(h),L>-1?w=A[L]:w=new ht(h,h)):(w=S.sel.primary(),L=S.sel.primIndex),f.unit=="rectangle")f.addNew||(w=new ht(h,h)),h=Os(s,u,!0,!0),L=-1;else{var F=mL(s,h,f.unit);f.extend?w=Ky(w,F.anchor,F.head,f.extend):w=F}f.addNew?L==-1?(L=A.length,On(S,Ai(s,A.concat([w]),L),{scroll:!1,origin:"*mouse"})):A.length>1&&A[L].empty()&&f.unit=="char"&&!f.extend?(On(S,Ai(s,A.slice(0,L).concat(A.slice(L+1)),0),{scroll:!1,origin:"*mouse"}),k=S.sel):Xy(S,L,w,tt):(L=0,On(S,new Jr([w],0),tt),k=S.sel);var H=h;function Y(he){if(R(H,he)!=0)if(H=he,f.unit=="rectangle"){for(var be=[],Ae=s.options.tabSize,De=Ue(Te(S,h.line).text,h.ch,Ae),Xe=Ue(Te(S,he.line).text,he.ch,Ae),Ct=Math.min(De,Xe),fn=Math.max(De,Xe),Nt=Math.min(h.line,he.line),Ar=Math.min(s.lastLine(),Math.max(h.line,he.line));Nt<=Ar;Nt++){var fr=Te(S,Nt).text,en=dt(fr,Ct,Ae);Ct==fn?be.push(new ht(se(Nt,en),se(Nt,en))):fr.length>en&&be.push(new ht(se(Nt,en),se(Nt,dt(fr,fn,Ae))))}be.length||be.push(new ht(h,h)),On(S,Ai(s,k.ranges.slice(0,L).concat(be),L),{origin:"*mouse",scroll:!1}),s.scrollIntoView(he)}else{var hr=w,kn=mL(s,he,f.unit),nn=hr.anchor,tn;R(kn.anchor,nn)>0?(tn=kn.head,nn=Ge(hr.from(),kn.anchor)):(tn=kn.anchor,nn=ue(hr.to(),kn.head));var Gt=k.ranges.slice(0);Gt[L]=hU(s,new ht(ve(S,nn),tn)),On(S,Ai(s,Gt,L),tt)}}var q=y.wrapper.getBoundingClientRect(),ee=0;function ne(he){var be=++ee,Ae=Os(s,he,!0,f.unit=="rectangle");if(!!Ae)if(R(Ae,H)!=0){s.curOp.focus=pe(),Y(Ae);var De=vf(y,S);(Ae.line>=De.to||Ae.line<De.from)&&setTimeout(dn(s,function(){ee==be&&ne(he)}),150)}else{var Xe=he.clientY<q.top?-20:he.clientY>q.bottom?20:0;Xe&&setTimeout(dn(s,function(){ee==be&&(y.scroller.scrollTop+=Xe,ne(he))}),50)}}function de(he){s.state.selectingText=!1,ee=Infinity,he&&(_n(he),y.input.focus()),cr(y.wrapper.ownerDocument,"mousemove",fe),cr(y.wrapper.ownerDocument,"mouseup",Se),S.history.lastSelOrigin=null}var fe=dn(s,function(he){he.buttons===0||!tf(he)?de(he):ne(he)}),Se=dn(s,de);s.state.selectingText=Se,Ve(y.wrapper.ownerDocument,"mousemove",fe),Ve(y.wrapper.ownerDocument,"mouseup",Se)}function hU(s,u){var h=u.anchor,f=u.head,y=Te(s.doc,h.line);if(R(h,f)==0&&h.sticky==f.sticky)return u;var S=Dr(y);if(!S)return u;var w=Lt(S,h.ch,h.sticky),L=S[w];if(L.from!=h.ch&&L.to!=h.ch)return u;var k=w+(L.from==h.ch==(L.level!=1)?0:1);if(k==0||k==S.length)return u;var A;if(f.line!=h.line)A=(f.line-h.line)*(s.doc.direction=="ltr"?1:-1)>0;else{var F=Lt(S,f.ch,f.sticky),H=F-w||(f.ch-h.ch)*(L.level==1?-1:1);F==k-1||F==k?A=H<0:A=H>0}var Y=S[k+(A?-1:0)],q=A==(Y.level==1),ee=q?Y.from:Y.to,ne=q?"after":"before";return h.ch==ee&&h.sticky==ne?u:new ht(new se(h.line,ee,ne),f)}function gL(s,u,h,f){var y,S;if(u.touches)y=u.touches[0].clientX,S=u.touches[0].clientY;else try{y=u.clientX,S=u.clientY}catch(Y){return!1}if(y>=Math.floor(s.display.gutters.getBoundingClientRect().right))return!1;f&&_n(u);var w=s.display,L=w.lineDiv.getBoundingClientRect();if(S>L.bottom||!Ln(s,h))return Wr(u);S-=L.top-w.viewOffset;for(var k=0;k<s.display.gutterSpecs.length;++k){var A=w.gutters.childNodes[k];if(A&&A.getBoundingClientRect().right>=y){var F=ca(s.doc,S),H=s.display.gutterSpecs[k];return Fe(s,h,s,F,H.className,u),Wr(u)}}}function rv(s,u){return gL(s,u,"gutterClick",!0)}function yL(s,u){ja(s.display,u)||mU(s,u)||Zt(s,u,"contextmenu")||V||s.display.input.onContextMenu(u)}function mU(s,u){return Ln(s,"gutterContextMenu")?gL(s,u,"gutterContextMenu",!1):!1}function vL(s){s.display.wrapper.className=s.display.wrapper.className.replace(/\s*cm-s-\S+/g,"")+s.options.theme.replace(/(^|\s)\s*/g," cm-s-"),_u(s)}var fc={toString:function(){return"CodeMirror.Init"}},SL={},Af={};function gU(s){var u=s.optionHandlers;function h(f,y,S,w){s.defaults[f]=y,S&&(u[f]=w?function(L,k,A){A!=fc&&S(L,k,A)}:S)}s.defineOption=h,s.Init=fc,h("value","",function(f,y){return f.setValue(y)},!0),h("mode",null,function(f,y){f.doc.modeOption=y,Jy(f)},!0),h("indentUnit",2,Jy,!0),h("indentWithTabs",!1),h("smartIndent",!0),h("tabSize",4,function(f){Wu(f),_u(f),dr(f)},!0),h("lineSeparator",null,function(f,y){if(f.doc.lineSep=y,!!y){var S=[],w=f.doc.first;f.doc.iter(function(k){for(var A=0;;){var F=k.text.indexOf(y,A);if(F==-1)break;A=F+y.length,S.push(se(w,F))}w++});for(var L=S.length-1;L>=0;L--)cc(f.doc,y,S[L],se(S[L].line,S[L].ch+y.length))}}),h("specialChars",/[\u0000-\u001f\u007f-\u009f\u00ad\u061c\u200b\u200e\u200f\u2028\u2029\ufeff\ufff9-\ufffc]/g,function(f,y,S){f.state.specialChars=new RegExp(y.source+(y.test("	")?"":"|	"),"g"),S!=fc&&f.refresh()}),h("specialCharPlaceholder",$N,function(f){return f.refresh()},!0),h("electricChars",!0),h("inputStyle",T?"contenteditable":"textarea",function(){throw new Error("inputStyle can not (yet) be changed in a running editor")},!0),h("spellcheck",!1,function(f,y){return f.getInputField().spellcheck=y},!0),h("autocorrect",!1,function(f,y){return f.getInputField().autocorrect=y},!0),h("autocapitalize",!1,function(f,y){return f.getInputField().autocapitalize=y},!0),h("rtlMoveVisually",!M),h("wholeLineUpdateBefore",!0),h("theme","default",function(f){vL(f),Gu(f)},!0),h("keyMap","default",function(f,y,S){var w=Pf(y),L=S!=fc&&Pf(S);L&&L.detach&&L.detach(f,w),w.attach&&w.attach(f,L||null)}),h("extraKeys",null),h("configureMouse",null),h("lineWrapping",!1,vU,!0),h("gutters",[],function(f,y){f.display.gutterSpecs=$y(y,f.options.lineNumbers),Gu(f)},!0),h("fixedGutter",!0,function(f,y){f.display.gutters.style.left=y?_y(f.display)+"px":"0",f.refresh()},!0),h("coverGutterNextToScrollbar",!1,function(f){return ac(f)},!0),h("scrollbarStyle","native",function(f){xT(f),ac(f),f.display.scrollbars.setScrollTop(f.doc.scrollTop),f.display.scrollbars.setScrollLeft(f.doc.scrollLeft)},!0),h("lineNumbers",!1,function(f,y){f.display.gutterSpecs=$y(f.options.gutters,y),Gu(f)},!0),h("firstLineNumber",1,Gu,!0),h("lineNumberFormatter",function(f){return f},Gu,!0),h("showCursorWhenSelecting",!1,Vu,!0),h("resetSelectionOnContextMenu",!0),h("lineWiseCopyCut",!0),h("pasteLinesPerSelection",!0),h("selectionsMayTouch",!1),h("readOnly",!1,function(f,y){y=="nocursor"&&(rc(f),f.display.input.blur()),f.display.input.readOnlyChanged(y)}),h("screenReaderLabel",null,function(f,y){y=y===""?null:y,f.display.input.screenReaderLabelChanged(y)}),h("disableInput",!1,function(f,y){y||f.display.input.reset()},!0),h("dragDrop",!0,yU),h("allowDropFileTypes",null),h("cursorBlinkRate",530),h("cursorScrollMargin",0),h("cursorHeight",1,Vu,!0),h("singleCursorHeightPerLine",!0,Vu,!0),h("workTime",100),h("workDelay",100),h("flattenSpans",!0,Wu,!0),h("addModeClass",!1,Wu,!0),h("pollInterval",100),h("undoDepth",200,function(f,y){return f.doc.history.undoDepth=y}),h("historyEventDelay",1250),h("viewportMargin",10,function(f){return f.refresh()},!0),h("maxHighlightLength",1e4,Wu,!0),h("moveInputWithCursor",!0,function(f,y){y||f.display.input.resetPosition()}),h("tabindex",null,function(f,y){return f.display.input.getField().tabIndex=y||""}),h("autofocus",null),h("direction","ltr",function(f,y){return f.doc.setDirection(y)},!0),h("phrases",null)}function yU(s,u,h){var f=h&&h!=fc;if(!u!=!f){var y=s.display.dragFunctions,S=u?Ve:cr;S(s.display.scroller,"dragstart",y.start),S(s.display.scroller,"dragenter",y.enter),S(s.display.scroller,"dragover",y.over),S(s.display.scroller,"dragleave",y.leave),S(s.display.scroller,"drop",y.drop)}}function vU(s){s.options.lineWrapping?(me(s.display.wrapper,"CodeMirror-wrap"),s.display.sizer.style.minWidth="",s.display.sizerWidth=null):(B(s.display.wrapper,"CodeMirror-wrap"),wy(s)),Vy(s),dr(s),_u(s),setTimeout(function(){return ac(s)},100)}function Rt(s,u){var h=this;if(!(this instanceof Rt))return new Rt(s,u);this.options=u=u?Re(u):{},Re(SL,u,!1);var f=u.value;typeof f=="string"?f=new pr(f,u.mode,null,u.lineSeparator,u.direction):u.mode&&(f.modeOption=u.mode),this.doc=f;var y=new Rt.inputStyles[u.inputStyle](this),S=this.display=new AB(s,f,y,u);S.wrapper.CodeMirror=this,vL(this),u.lineWrapping&&(this.display.wrapper.className+=" CodeMirror-wrap"),xT(this),this.state={keyMaps:[],overlays:[],modeGen:0,overwrite:!1,delayingBlurEvent:!1,focused:!1,suppressEdits:!1,pasteIncoming:-1,cutIncoming:-1,selectingText:!1,draggingText:!1,highlight:new et,keySeq:null,specialChars:null},u.autofocus&&!T&&S.input.focus(),o&&l<11&&setTimeout(function(){return h.display.input.reset(!0)},20),SU(this),KB(),Fs(this),this.curOp.forceUpdate=!0,AT(this,f),u.autofocus&&!T||this.hasFocus()?setTimeout(function(){h.hasFocus()&&!h.state.focused&&By(h)},20):rc(this);for(var w in Af)Af.hasOwnProperty(w)&&Af[w](this,u[w],fc);TT(this),u.finishInit&&u.finishInit(this);for(var L=0;L<iv.length;++L)iv[L](this);Gs(this),c&&u.lineWrapping&&getComputedStyle(S.lineDiv).textRendering=="optimizelegibility"&&(S.lineDiv.style.textRendering="auto")}Rt.defaults=SL,Rt.optionHandlers=Af;function SU(s){var u=s.display;Ve(u.scroller,"mousedown",dn(s,hL)),o&&l<11?Ve(u.scroller,"dblclick",dn(s,function(k){if(!Zt(s,k)){var A=Os(s,k);if(!(!A||rv(s,k)||ja(s.display,k))){_n(k);var F=s.findWordAt(A);Tf(s.doc,F.anchor,F.head)}}})):Ve(u.scroller,"dblclick",function(k){return Zt(s,k)||_n(k)}),Ve(u.scroller,"contextmenu",function(k){return yL(s,k)}),Ve(u.input.getField(),"contextmenu",function(k){u.scroller.contains(k.target)||yL(s,k)});var h,f={end:0};function y(){u.activeTouch&&(h=setTimeout(function(){return u.activeTouch=null},1e3),f=u.activeTouch,f.end=+new Date)}function S(k){if(k.touches.length!=1)return!1;var A=k.touches[0];return A.radiusX<=1&&A.radiusY<=1}function w(k,A){if(A.left==null)return!0;var F=A.left-k.left,H=A.top-k.top;return F*F+H*H>20*20}Ve(u.scroller,"touchstart",function(k){if(!Zt(s,k)&&!S(k)&&!rv(s,k)){u.input.ensurePolled(),clearTimeout(h);var A=+new Date;u.activeTouch={start:A,moved:!1,prev:A-f.end<=300?f:null},k.touches.length==1&&(u.activeTouch.left=k.touches[0].pageX,u.activeTouch.top=k.touches[0].pageY)}}),Ve(u.scroller,"touchmove",function(){u.activeTouch&&(u.activeTouch.moved=!0)}),Ve(u.scroller,"touchend",function(k){var A=u.activeTouch;if(A&&!ja(u,k)&&A.left!=null&&!A.moved&&new Date-A.start<300){var F=s.coordsChar(u.activeTouch,"page"),H;!A.prev||w(A,A.prev)?H=new ht(F,F):!A.prev.prev||w(A,A.prev.prev)?H=s.findWordAt(F):H=new ht(se(F.line,0),ve(s.doc,se(F.line+1,0))),s.setSelection(H.anchor,H.head),s.focus(),_n(k)}y()}),Ve(u.scroller,"touchcancel",y),Ve(u.scroller,"scroll",function(){u.scroller.clientHeight&&(Nu(s,u.scroller.scrollTop),Bs(s,u.scroller.scrollLeft,!0),Fe(s,"scroll",s))}),Ve(u.scroller,"mousewheel",function(k){return ET(s,k)}),Ve(u.scroller,"DOMMouseScroll",function(k){return ET(s,k)}),Ve(u.wrapper,"scroll",function(){return u.wrapper.scrollTop=u.wrapper.scrollLeft=0}),u.dragFunctions={enter:function(k){Zt(s,k)||Ms(k)},over:function(k){Zt(s,k)||(YB(s,k),Ms(k))},start:function(k){return qB(s,k)},drop:dn(s,JB),leave:function(k){Zt(s,k)||tL(s)}};var L=u.input.getField();Ve(L,"keyup",function(k){return pL.call(s,k)}),Ve(L,"keydown",dn(s,dL)),Ve(L,"keypress",dn(s,fL)),Ve(L,"focus",function(k){return By(s,k)}),Ve(L,"blur",function(k){return rc(s,k)})}var iv=[];Rt.defineInitHook=function(s){return iv.push(s)};function td(s,u,h,f){var y=s.doc,S;h==null&&(h="add"),h=="smart"&&(y.mode.indent?S=Pu(s,u).state:h="prev");var w=s.options.tabSize,L=Te(y,u),k=Ue(L.text,null,w);L.stateAfter&&(L.stateAfter=null);var A=L.text.match(/^\s*/)[0],F;if(!f&&!/\S/.test(L.text))F=0,h="not";else if(h=="smart"&&(F=y.mode.indent(S,L.text.slice(A.length),L.text),F==$e||F>150)){if(!f)return;h="prev"}h=="prev"?u>y.first?F=Ue(Te(y,u-1).text,null,w):F=0:h=="add"?F=k+s.options.indentUnit:h=="subtract"?F=k-s.options.indentUnit:typeof h=="number"&&(F=k+h),F=Math.max(0,F);var H="",Y=0;if(s.options.indentWithTabs)for(var q=Math.floor(F/w);q;--q)Y+=w,H+="	";if(Y<F&&(H+=ta(F-Y)),H!=A)return cc(y,H,se(u,0),se(u,A.length),"+input"),L.stateAfter=null,!0;for(var ee=0;ee<y.sel.ranges.length;ee++){var ne=y.sel.ranges[ee];if(ne.head.line==u&&ne.head.ch<A.length){var de=se(u,A.length);Xy(y,ee,new ht(de,de));break}}}var Mi=null;function Mf(s){Mi=s}function av(s,u,h,f,y){var S=s.doc;s.display.shift=!1,f||(f=S.sel);var w=+new Date-200,L=y=="paste"||s.state.pasteIncoming>w,k=wu(u),A=null;if(L&&f.ranges.length>1)if(Mi&&Mi.text.join(`
`)==u){if(f.ranges.length%Mi.text.length==0){A=[];for(var F=0;F<Mi.text.length;F++)A.push(S.splitLines(Mi.text[F]))}}else k.length==f.ranges.length&&s.options.pasteLinesPerSelection&&(A=Er(k,function(fe){return[fe]}));for(var H=s.curOp.updateInput,Y=f.ranges.length-1;Y>=0;Y--){var q=f.ranges[Y],ee=q.from(),ne=q.to();q.empty()&&(h&&h>0?ee=se(ee.line,ee.ch-h):s.state.overwrite&&!L?ne=se(ne.line,Math.min(Te(S,ne.line).text.length,ne.ch+nt(k).length)):L&&Mi&&Mi.lineWise&&Mi.text.join(`
`)==k.join(`
`)&&(ee=ne=se(ee.line,0)));var de={from:ee,to:ne,text:A?A[Y%A.length]:k,origin:y||(L?"paste":s.state.cutIncoming>w?"cut":"+input")};lc(s.doc,de),un(s,"inputRead",s,de)}u&&!L&&xL(s,u),ic(s),s.curOp.updateInput<2&&(s.curOp.updateInput=H),s.curOp.typing=!0,s.state.pasteIncoming=s.state.cutIncoming=-1}function bL(s,u){var h=s.clipboardData&&s.clipboardData.getData("Text");if(h)return s.preventDefault(),!u.isReadOnly()&&!u.options.disableInput&&Ir(u,function(){return av(u,h,0,null,"paste")}),!0}function xL(s,u){if(!(!s.options.electricChars||!s.options.smartIndent))for(var h=s.doc.sel,f=h.ranges.length-1;f>=0;f--){var y=h.ranges[f];if(!(y.head.ch>100||f&&h.ranges[f-1].head.line==y.head.line)){var S=s.getModeAt(y.head),w=!1;if(S.electricChars){for(var L=0;L<S.electricChars.length;L++)if(u.indexOf(S.electricChars.charAt(L))>-1){w=td(s,y.head.line,"smart");break}}else S.electricInput&&S.electricInput.test(Te(s.doc,y.head.line).text.slice(0,y.head.ch))&&(w=td(s,y.head.line,"smart"));w&&un(s,"electricInput",s,y.head.line)}}}function CL(s){for(var u=[],h=[],f=0;f<s.doc.sel.ranges.length;f++){var y=s.doc.sel.ranges[f].head.line,S={anchor:se(y,0),head:se(y+1,0)};h.push(S),u.push(s.getRange(S.anchor,S.head))}return{text:u,ranges:h}}function wL(s,u,h,f){s.setAttribute("autocorrect",h?"":"off"),s.setAttribute("autocapitalize",f?"":"off"),s.setAttribute("spellcheck",!!u)}function TL(){var s=U("textarea",null,null,"position: absolute; bottom: -1em; padding: 0; width: 1px; height: 1em; outline: none"),u=U("div",[s],null,"overflow: hidden; position: relative; width: 3px; height: 0px;");return c?s.style.width="1000px":s.setAttribute("wrap","off"),x&&(s.style.border="1px solid black"),wL(s),u}function bU(s){var u=s.optionHandlers,h=s.helpers={};s.prototype={constructor:s,focus:function(){window.focus(),this.display.input.focus()},setOption:function(f,y){var S=this.options,w=S[f];S[f]==y&&f!="mode"||(S[f]=y,u.hasOwnProperty(f)&&dn(this,u[f])(this,y,w),Fe(this,"optionChange",this,f))},getOption:function(f){return this.options[f]},getDoc:function(){return this.doc},addKeyMap:function(f,y){this.state.keyMaps[y?"push":"unshift"](Pf(f))},removeKeyMap:function(f){for(var y=this.state.keyMaps,S=0;S<y.length;++S)if(y[S]==f||y[S].name==f)return y.splice(S,1),!0},addOverlay:Jn(function(f,y){var S=f.token?f:s.getMode(this.options,f);if(S.startState)throw new Error("Overlays may not be stateful.");na(this.state.overlays,{mode:S,modeSpec:f,opaque:y&&y.opaque,priority:y&&y.priority||0},function(w){return w.priority}),this.state.modeGen++,dr(this)}),removeOverlay:Jn(function(f){for(var y=this.state.overlays,S=0;S<y.length;++S){var w=y[S].modeSpec;if(w==f||typeof f=="string"&&w.name==f){y.splice(S,1),this.state.modeGen++,dr(this);return}}}),indentLine:Jn(function(f,y,S){typeof y!="string"&&typeof y!="number"&&(y==null?y=this.options.smartIndent?"smart":"prev":y=y?"add":"subtract"),Rs(this.doc,f)&&td(this,f,y,S)}),indentSelection:Jn(function(f){for(var y=this.doc.sel.ranges,S=-1,w=0;w<y.length;w++){var L=y[w];if(L.empty())L.head.line>S&&(td(this,L.head.line,f,!0),S=L.head.line,w==this.doc.sel.primIndex&&ic(this));else{var k=L.from(),A=L.to(),F=Math.max(S,k.line);S=Math.min(this.lastLine(),A.line-(A.ch?0:1))+1;for(var H=F;H<S;++H)td(this,H,f);var Y=this.doc.sel.ranges;k.ch==0&&y.length==Y.length&&Y[w].from().ch>0&&Xy(this.doc,w,new ht(k,Y[w].to()),Je)}}}),getTokenAt:function(f,y){return M0(this,f,y)},getLineTokens:function(f,y){return M0(this,se(f),y,!0)},getTokenTypeAt:function(f){f=ve(this.doc,f);var y=P0(this,Te(this.doc,f.line)),S=0,w=(y.length-1)/2,L=f.ch,k;if(L==0)k=y[2];else for(;;){var A=S+w>>1;if((A?y[A*2-1]:0)>=L)w=A;else if(y[A*2+1]<L)S=A+1;else{k=y[A*2+2];break}}var F=k?k.indexOf("overlay "):-1;return F<0?k:F==0?null:k.slice(0,F-1)},getModeAt:function(f){var y=this.doc.mode;return y.innerMode?s.innerMode(y,this.getTokenAt(f).state).mode:y},getHelper:function(f,y){return this.getHelpers(f,y)[0]},getHelpers:function(f,y){var S=[];if(!h.hasOwnProperty(y))return S;var w=h[y],L=this.getModeAt(f);if(typeof L[y]=="string")w[L[y]]&&S.push(w[L[y]]);else if(L[y])for(var k=0;k<L[y].length;k++){var A=w[L[y][k]];A&&S.push(A)}else L.helperType&&w[L.helperType]?S.push(w[L.helperType]):w[L.name]&&S.push(w[L.name]);for(var F=0;F<w._global.length;F++){var H=w._global[F];H.pred(L,this)&&ye(S,H.val)==-1&&S.push(H.val)}return S},getStateAfter:function(f,y){var S=this.doc;return f=st(S,f==null?S.first+S.size-1:f),Pu(this,f+1,y).state},cursorCoords:function(f,y){var S,w=this.doc.sel.primary();return f==null?S=w.head:typeof f=="object"?S=ve(this.doc,f):S=f?w.from():w.to(),Ii(this,S,y||"page")},charCoords:function(f,y){return Py(this,ve(this.doc,f),y||"page")},coordsChar:function(f,y){return f=sT(this,f,y||"page"),Ay(this,f.left,f.top)},lineAtHeight:function(f,y){return f=sT(this,{top:f,left:0},y||"page").top,ca(this.doc,f+this.display.viewOffset)},heightAtLine:function(f,y,S){var w=!1,L;if(typeof f=="number"){var k=this.doc.first+this.doc.size-1;f<this.doc.first?f=this.doc.first:f>k&&(f=k,w=!0),L=Te(this.doc,f)}else L=f;return hf(this,L,{top:0,left:0},y||"page",S||w).top+(w?this.doc.height-$a(L):0)},defaultTextHeight:function(){return tc(this.display)},defaultCharWidth:function(){return nc(this.display)},getViewport:function(){return{from:this.display.viewFrom,to:this.display.viewTo}},addWidget:function(f,y,S,w,L){var k=this.display;f=Ii(this,ve(this.doc,f));var A=f.bottom,F=f.left;if(y.style.position="absolute",y.setAttribute("cm-ignore-events","true"),this.display.input.setUneditable(y),k.sizer.appendChild(y),w=="over")A=f.top;else if(w=="above"||w=="near"){var H=Math.max(k.wrapper.clientHeight,this.doc.height),Y=Math.max(k.sizer.clientWidth,k.lineSpace.clientWidth);(w=="above"||f.bottom+y.offsetHeight>H)&&f.top>y.offsetHeight?A=f.top-y.offsetHeight:f.bottom+y.offsetHeight<=H&&(A=f.bottom),F+y.offsetWidth>Y&&(F=Y-y.offsetWidth)}y.style.top=A+"px",y.style.left=y.style.right="",L=="right"?(F=k.sizer.clientWidth-y.offsetWidth,y.style.right="0px"):(L=="left"?F=0:L=="middle"&&(F=(k.sizer.clientWidth-y.offsetWidth)/2),y.style.left=F+"px"),S&&yB(this,{left:F,top:A,right:F+y.offsetWidth,bottom:A+y.offsetHeight})},triggerOnKeyDown:Jn(dL),triggerOnKeyPress:Jn(fL),triggerOnKeyUp:pL,triggerOnMouseDown:Jn(hL),execCommand:function(f){if(Xu.hasOwnProperty(f))return Xu[f].call(null,this)},triggerElectric:Jn(function(f){xL(this,f)}),findPosH:function(f,y,S,w){var L=1;y<0&&(L=-1,y=-y);for(var k=ve(this.doc,f),A=0;A<y&&(k=ov(this.doc,k,L,S,w),!k.hitSide);++A);return k},moveH:Jn(function(f,y){var S=this;this.extendSelectionsBy(function(w){return S.display.shift||S.doc.extend||w.empty()?ov(S.doc,w.head,f,y,S.options.rtlMoveVisually):f<0?w.from():w.to()},_e)}),deleteH:Jn(function(f,y){var S=this.doc.sel,w=this.doc;S.somethingSelected()?w.replaceSelection("",null,"+delete"):pc(this,function(L){var k=ov(w,L.head,f,y,!1);return f<0?{from:k,to:L.head}:{from:L.head,to:k}})}),findPosV:function(f,y,S,w){var L=1,k=w;y<0&&(L=-1,y=-y);for(var A=ve(this.doc,f),F=0;F<y;++F){var H=Ii(this,A,"div");if(k==null?k=H.left:H.left=k,A=LL(this,H,L,S),A.hitSide)break}return A},moveV:Jn(function(f,y){var S=this,w=this.doc,L=[],k=!this.display.shift&&!w.extend&&w.sel.somethingSelected();if(w.extendSelectionsBy(function(F){if(k)return f<0?F.from():F.to();var H=Ii(S,F.head,"div");F.goalColumn!=null&&(H.left=F.goalColumn),L.push(H.left);var Y=LL(S,H,f,y);return y=="page"&&F==w.sel.primary()&&Fy(S,Py(S,Y,"div").top-H.top),Y},_e),L.length)for(var A=0;A<w.sel.ranges.length;A++)w.sel.ranges[A].goalColumn=L[A]}),findWordAt:function(f){var y=this.doc,S=Te(y,f.line).text,w=f.ch,L=f.ch;if(S){var k=this.getHelper(f,"wordChars");(f.sticky=="before"||L==S.length)&&w?--w:++L;for(var A=S.charAt(w),F=Ei(A,k)?function(H){return Ei(H,k)}:/\s/.test(A)?function(H){return/\s/.test(H)}:function(H){return!/\s/.test(H)&&!Ei(H)};w>0&&F(S.charAt(w-1));)--w;for(;L<S.length&&F(S.charAt(L));)++L}return new ht(se(f.line,w),se(f.line,L))},toggleOverwrite:function(f){f!=null&&f==this.state.overwrite||((this.state.overwrite=!this.state.overwrite)?me(this.display.cursorDiv,"CodeMirror-overwrite"):B(this.display.cursorDiv,"CodeMirror-overwrite"),Fe(this,"overwriteToggle",this,this.state.overwrite))},hasFocus:function(){return this.display.input.getField()==pe()},isReadOnly:function(){return!!(this.options.readOnly||this.doc.cantEdit)},scrollTo:Jn(function(f,y){Ou(this,f,y)}),getScrollInfo:function(){var f=this.display.scroller;return{left:f.scrollLeft,top:f.scrollTop,height:f.scrollHeight-pa(this)-this.display.barHeight,width:f.scrollWidth-pa(this)-this.display.barWidth,clientHeight:ky(this),clientWidth:_s(this)}},scrollIntoView:Jn(function(f,y){f==null?(f={from:this.doc.sel.primary().head,to:null},y==null&&(y=this.options.cursorScrollMargin)):typeof f=="number"?f={from:se(f,0),to:null}:f.from==null&&(f={from:f,to:null}),f.to||(f.to=f.from),f.margin=y||0,f.from.line!=null?vB(this,f):yT(this,f.from,f.to,f.margin)}),setSize:Jn(function(f,y){var S=this,w=function(k){return typeof k=="number"||/^\d+$/.test(String(k))?k+"px":k};f!=null&&(this.display.wrapper.style.width=w(f)),y!=null&&(this.display.wrapper.style.height=w(y)),this.options.lineWrapping&&iT(this);var L=this.display.viewFrom;this.doc.iter(L,this.display.viewTo,function(k){if(k.widgets){for(var A=0;A<k.widgets.length;A++)if(k.widgets[A].noHScroll){Ao(S,L,"widget");break}}++L}),this.curOp.forceUpdate=!0,Fe(this,"refresh",this)}),operation:function(f){return Ir(this,f)},startOperation:function(){return Fs(this)},endOperation:function(){return Gs(this)},refresh:Jn(function(){var f=this.display.cachedTextHeight;dr(this),this.curOp.forceUpdate=!0,_u(this),Ou(this,this.doc.scrollLeft,this.doc.scrollTop),zy(this.display),(f==null||Math.abs(f-tc(this.display))>.5||this.options.lineWrapping)&&Vy(this),Fe(this,"refresh",this)}),swapDoc:Jn(function(f){var y=this.doc;return y.cm=null,this.state.selectingText&&this.state.selectingText(),AT(this,f),_u(this),this.display.input.reset(),Ou(this,f.scrollLeft,f.scrollTop),this.curOp.forceScroll=!0,un(this,"swapDoc",this,y),y}),phrase:function(f){var y=this.options.phrases;return y&&Object.prototype.hasOwnProperty.call(y,f)?y[f]:f},getInputField:function(){return this.display.input.getField()},getWrapperElement:function(){return this.display.wrapper},getScrollerElement:function(){return this.display.scroller},getGutterElement:function(){return this.display.gutters}},oa(s),s.registerHelper=function(f,y,S){h.hasOwnProperty(f)||(h[f]=s[f]={_global:[]}),h[f][y]=S},s.registerGlobalHelper=function(f,y,S,w){s.registerHelper(f,y,w),h[f]._global.push({pred:S,val:w})}}function ov(s,u,h,f,y){var S=u,w=h,L=Te(s,u.line),k=y&&s.direction=="rtl"?-h:h;function A(){var Se=u.line+k;return Se<s.first||Se>=s.first+s.size?!1:(u=new se(Se,u.ch,u.sticky),L=Te(s,Se))}function F(Se){var he;if(f=="codepoint"){var be=L.text.charCodeAt(u.ch+(h>0?0:-1));if(isNaN(be))he=null;else{var Ae=h>0?be>=55296&&be<56320:be>=56320&&be<57343;he=new se(u.line,Math.max(0,Math.min(L.text.length,u.ch+h*(Ae?2:1))),-h)}}else y?he=tU(s.cm,L,u,h):he=Zy(L,u,h);if(he==null)if(!Se&&A())u=ev(y,s.cm,L,u.line,k);else return!1;else u=he;return!0}if(f=="char"||f=="codepoint")F();else if(f=="column")F(!0);else if(f=="word"||f=="group")for(var H=null,Y=f=="group",q=s.cm&&s.cm.getHelper(u,"wordChars"),ee=!0;!(h<0&&!F(!ee));ee=!1){var ne=L.text.charAt(u.ch)||`
`,de=Ei(ne,q)?"w":Y&&ne==`
`?"n":!Y||/\s/.test(ne)?null:"p";if(Y&&!ee&&!de&&(de="s"),H&&H!=de){h<0&&(h=1,F(),u.sticky="after");break}if(de&&(H=de),h>0&&!F(!ee))break}var fe=kf(s,u,S,w,!0);return $(S,fe)&&(fe.hitSide=!0),fe}function LL(s,u,h,f){var y=s.doc,S=u.left,w;if(f=="page"){var L=Math.min(s.display.wrapper.clientHeight,window.innerHeight||document.documentElement.clientHeight),k=Math.max(L-.5*tc(s.display),3);w=(h>0?u.bottom:u.top)+h*k}else f=="line"&&(w=h>0?u.bottom+3:u.top-3);for(var A;A=Ay(s,S,w),!!A.outside;){if(h<0?w<=0:w>=y.height){A.hitSide=!0;break}w+=h*5}return A}var yt=function(s){this.cm=s,this.lastAnchorNode=this.lastAnchorOffset=this.lastFocusNode=this.lastFocusOffset=null,this.polling=new et,this.composing=null,this.gracePeriod=!1,this.readDOMTimeout=null};yt.prototype.init=function(s){var u=this,h=this,f=h.cm,y=h.div=s.lineDiv;y.contentEditable=!0,wL(y,f.options.spellcheck,f.options.autocorrect,f.options.autocapitalize);function S(L){for(var k=L.target;k;k=k.parentNode){if(k==y)return!0;if(/\bCodeMirror-(?:line)?widget\b/.test(k.className))break}return!1}Ve(y,"paste",function(L){!S(L)||Zt(f,L)||bL(L,f)||l<=11&&setTimeout(dn(f,function(){return u.updateFromDOM()}),20)}),Ve(y,"compositionstart",function(L){u.composing={data:L.data,done:!1}}),Ve(y,"compositionupdate",function(L){u.composing||(u.composing={data:L.data,done:!1})}),Ve(y,"compositionend",function(L){u.composing&&(L.data!=u.composing.data&&u.readFromDOMSoon(),u.composing.done=!0)}),Ve(y,"touchstart",function(){return h.forceCompositionEnd()}),Ve(y,"input",function(){u.composing||u.readFromDOMSoon()});function w(L){if(!(!S(L)||Zt(f,L))){if(f.somethingSelected())Mf({lineWise:!1,text:f.getSelections()}),L.type=="cut"&&f.replaceSelection("",null,"cut");else if(f.options.lineWiseCopyCut){var k=CL(f);Mf({lineWise:!0,text:k.text}),L.type=="cut"&&f.operation(function(){f.setSelections(k.ranges,0,Je),f.replaceSelection("",null,"cut")})}else return;if(L.clipboardData){L.clipboardData.clearData();var A=Mi.text.join(`
`);if(L.clipboardData.setData("Text",A),L.clipboardData.getData("Text")==A){L.preventDefault();return}}var F=TL(),H=F.firstChild;f.display.lineSpace.insertBefore(F,f.display.lineSpace.firstChild),H.value=Mi.text.join(`
`);var Y=pe();le(H),setTimeout(function(){f.display.lineSpace.removeChild(F),Y.focus(),Y==y&&h.showPrimarySelection()},50)}}Ve(y,"copy",w),Ve(y,"cut",w)},yt.prototype.screenReaderLabelChanged=function(s){s?this.div.setAttribute("aria-label",s):this.div.removeAttribute("aria-label")},yt.prototype.prepareSelection=function(){var s=fT(this.cm,!1);return s.focus=pe()==this.div,s},yt.prototype.showSelection=function(s,u){!s||!this.cm.display.view.length||((s.focus||u)&&this.showPrimarySelection(),this.showMultipleSelections(s))},yt.prototype.getSelection=function(){return this.cm.display.wrapper.ownerDocument.getSelection()},yt.prototype.showPrimarySelection=function(){var s=this.getSelection(),u=this.cm,h=u.doc.sel.primary(),f=h.from(),y=h.to();if(u.display.viewTo==u.display.viewFrom||f.line>=u.display.viewTo||y.line<u.display.viewFrom){s.removeAllRanges();return}var S=Rf(u,s.anchorNode,s.anchorOffset),w=Rf(u,s.focusNode,s.focusOffset);if(!(S&&!S.bad&&w&&!w.bad&&R(Ge(S,w),f)==0&&R(ue(S,w),y)==0)){var L=u.display.view,k=f.line>=u.display.viewFrom&&kL(u,f)||{node:L[0].measure.map[2],offset:0},A=y.line<u.display.viewTo&&kL(u,y);if(!A){var F=L[L.length-1].measure,H=F.maps?F.maps[F.maps.length-1]:F.map;A={node:H[H.length-1],offset:H[H.length-2]-H[H.length-3]}}if(!k||!A){s.removeAllRanges();return}var Y=s.rangeCount&&s.getRangeAt(0),q;try{q=J(k.node,k.offset,A.offset,A.node)}catch(ee){}q&&(!t&&u.state.focused?(s.collapse(k.node,k.offset),q.collapsed||(s.removeAllRanges(),s.addRange(q))):(s.removeAllRanges(),s.addRange(q)),Y&&s.anchorNode==null?s.addRange(Y):t&&this.startGracePeriod()),this.rememberSelection()}},yt.prototype.startGracePeriod=function(){var s=this;clearTimeout(this.gracePeriod),this.gracePeriod=setTimeout(function(){s.gracePeriod=!1,s.selectionChanged()&&s.cm.operation(function(){return s.cm.curOp.selectionChanged=!0})},20)},yt.prototype.showMultipleSelections=function(s){_(this.cm.display.cursorDiv,s.cursors),_(this.cm.display.selectionDiv,s.selection)},yt.prototype.rememberSelection=function(){var s=this.getSelection();this.lastAnchorNode=s.anchorNode,this.lastAnchorOffset=s.anchorOffset,this.lastFocusNode=s.focusNode,this.lastFocusOffset=s.focusOffset},yt.prototype.selectionInEditor=function(){var s=this.getSelection();if(!s.rangeCount)return!1;var u=s.getRangeAt(0).commonAncestorContainer;return ie(this.div,u)},yt.prototype.focus=function(){this.cm.options.readOnly!="nocursor"&&((!this.selectionInEditor()||pe()!=this.div)&&this.showSelection(this.prepareSelection(),!0),this.div.focus())},yt.prototype.blur=function(){this.div.blur()},yt.prototype.getField=function(){return this.div},yt.prototype.supportsTouch=function(){return!0},yt.prototype.receivedFocus=function(){var s=this;this.selectionInEditor()?this.pollSelection():Ir(this.cm,function(){return s.cm.curOp.selectionChanged=!0});function u(){s.cm.state.focused&&(s.pollSelection(),s.polling.set(s.cm.options.pollInterval,u))}this.polling.set(this.cm.options.pollInterval,u)},yt.prototype.selectionChanged=function(){var s=this.getSelection();return s.anchorNode!=this.lastAnchorNode||s.anchorOffset!=this.lastAnchorOffset||s.focusNode!=this.lastFocusNode||s.focusOffset!=this.lastFocusOffset},yt.prototype.pollSelection=function(){if(!(this.readDOMTimeout!=null||this.gracePeriod||!this.selectionChanged())){var s=this.getSelection(),u=this.cm;if(C&&p&&this.cm.display.gutterSpecs.length&&xU(s.anchorNode)){this.cm.triggerOnKeyDown({type:"keydown",keyCode:8,preventDefault:Math.abs}),this.blur(),this.focus();return}if(!this.composing){this.rememberSelection();var h=Rf(u,s.anchorNode,s.anchorOffset),f=Rf(u,s.focusNode,s.focusOffset);h&&f&&Ir(u,function(){On(u.doc,Ro(h,f),Je),(h.bad||f.bad)&&(u.curOp.selectionChanged=!0)})}}},yt.prototype.pollContent=function(){this.readDOMTimeout!=null&&(clearTimeout(this.readDOMTimeout),this.readDOMTimeout=null);var s=this.cm,u=s.display,h=s.doc.sel.primary(),f=h.from(),y=h.to();if(f.ch==0&&f.line>s.firstLine()&&(f=se(f.line-1,Te(s.doc,f.line-1).length)),y.ch==Te(s.doc,y.line).text.length&&y.line<s.lastLine()&&(y=se(y.line+1,0)),f.line<u.viewFrom||y.line>u.viewTo-1)return!1;var S,w,L;f.line==u.viewFrom||(S=Ns(s,f.line))==0?(w=ft(u.view[0].line),L=u.view[0].node):(w=ft(u.view[S].line),L=u.view[S-1].node.nextSibling);var k=Ns(s,y.line),A,F;if(k==u.view.length-1?(A=u.viewTo-1,F=u.lineDiv.lastChild):(A=ft(u.view[k+1].line)-1,F=u.view[k+1].node.previousSibling),!L)return!1;for(var H=s.doc.splitLines(CU(s,L,F,w,A)),Y=la(s.doc,se(w,0),se(A,Te(s.doc,A).text.length));H.length>1&&Y.length>1;)if(nt(H)==nt(Y))H.pop(),Y.pop(),A--;else if(H[0]==Y[0])H.shift(),Y.shift(),w++;else break;for(var q=0,ee=0,ne=H[0],de=Y[0],fe=Math.min(ne.length,de.length);q<fe&&ne.charCodeAt(q)==de.charCodeAt(q);)++q;for(var Se=nt(H),he=nt(Y),be=Math.min(Se.length-(H.length==1?q:0),he.length-(Y.length==1?q:0));ee<be&&Se.charCodeAt(Se.length-ee-1)==he.charCodeAt(he.length-ee-1);)++ee;if(H.length==1&&Y.length==1&&w==f.line)for(;q&&q>f.ch&&Se.charCodeAt(Se.length-ee-1)==he.charCodeAt(he.length-ee-1);)q--,ee++;H[H.length-1]=Se.slice(0,Se.length-ee).replace(/^\u200b+/,""),H[0]=H[0].slice(q).replace(/\u200b+$/,"");var Ae=se(w,q),De=se(A,Y.length?nt(Y).length-ee:0);if(H.length>1||H[0]||R(Ae,De))return cc(s.doc,H,Ae,De,"+input"),!0},yt.prototype.ensurePolled=function(){this.forceCompositionEnd()},yt.prototype.reset=function(){this.forceCompositionEnd()},yt.prototype.forceCompositionEnd=function(){!this.composing||(clearTimeout(this.readDOMTimeout),this.composing=null,this.updateFromDOM(),this.div.blur(),this.div.focus())},yt.prototype.readFromDOMSoon=function(){var s=this;this.readDOMTimeout==null&&(this.readDOMTimeout=setTimeout(function(){if(s.readDOMTimeout=null,s.composing)if(s.composing.done)s.composing=null;else return;s.updateFromDOM()},80))},yt.prototype.updateFromDOM=function(){var s=this;(this.cm.isReadOnly()||!this.pollContent())&&Ir(this.cm,function(){return dr(s.cm)})},yt.prototype.setUneditable=function(s){s.contentEditable="false"},yt.prototype.onKeyPress=function(s){s.charCode==0||this.composing||(s.preventDefault(),this.cm.isReadOnly()||dn(this.cm,av)(this.cm,String.fromCharCode(s.charCode==null?s.keyCode:s.charCode),0))},yt.prototype.readOnlyChanged=function(s){this.div.contentEditable=String(s!="nocursor")},yt.prototype.onContextMenu=function(){},yt.prototype.resetPosition=function(){},yt.prototype.needsContentAttribute=!0;function kL(s,u){var h=Ey(s,u.line);if(!h||h.hidden)return null;var f=Te(s.doc,u.line),y=Z0(h,f,u.line),S=Dr(f,s.doc.direction),w="left";if(S){var L=Lt(S,u.ch);w=L%2?"right":"left"}var k=nT(y.map,u.ch,w);return k.offset=k.collapse=="right"?k.end:k.start,k}function xU(s){for(var u=s;u;u=u.parentNode)if(/CodeMirror-gutter-wrapper/.test(u.className))return!0;return!1}function hc(s,u){return u&&(s.bad=!0),s}function CU(s,u,h,f,y){var S="",w=!1,L=s.doc.lineSeparator(),k=!1;function A(q){return function(ee){return ee.id==q}}function F(){w&&(S+=L,k&&(S+=L),w=k=!1)}function H(q){q&&(F(),S+=q)}function Y(q){if(q.nodeType==1){var ee=q.getAttribute("cm-text");if(ee){H(ee);return}var ne=q.getAttribute("cm-marker"),de;if(ne){var fe=s.findMarks(se(f,0),se(y+1,0),A(+ne));fe.length&&(de=fe[0].find(0))&&H(la(s.doc,de.from,de.to).join(L));return}if(q.getAttribute("contenteditable")=="false")return;var Se=/^(pre|div|p|li|table|br)$/i.test(q.nodeName);if(!/^br$/i.test(q.nodeName)&&q.textContent.length==0)return;Se&&F();for(var he=0;he<q.childNodes.length;he++)Y(q.childNodes[he]);/^(pre|p)$/i.test(q.nodeName)&&(k=!0),Se&&(w=!0)}else q.nodeType==3&&H(q.nodeValue.replace(/\u200b/g,"").replace(/\u00a0/g," "))}for(;Y(u),u!=h;)u=u.nextSibling,k=!1;return S}function Rf(s,u,h){var f;if(u==s.display.lineDiv){if(f=s.display.lineDiv.childNodes[h],!f)return hc(s.clipPos(se(s.display.viewTo-1)),!0);u=null,h=0}else for(f=u;;f=f.parentNode){if(!f||f==s.display.lineDiv)return null;if(f.parentNode&&f.parentNode==s.display.lineDiv)break}for(var y=0;y<s.display.view.length;y++){var S=s.display.view[y];if(S.node==f)return wU(S,u,h)}}function wU(s,u,h){var f=s.text.firstChild,y=!1;if(!u||!ie(f,u))return hc(se(ft(s.line),0),!0);if(u==f&&(y=!0,u=f.childNodes[h],h=0,!u)){var S=s.rest?nt(s.rest):s.line;return hc(se(ft(S),S.text.length),y)}var w=u.nodeType==3?u:null,L=u;for(!w&&u.childNodes.length==1&&u.firstChild.nodeType==3&&(w=u.firstChild,h&&(h=w.nodeValue.length));L.parentNode!=f;)L=L.parentNode;var k=s.measure,A=k.maps;function F(de,fe,Se){for(var he=-1;he<(A?A.length:0);he++)for(var be=he<0?k.map:A[he],Ae=0;Ae<be.length;Ae+=3){var De=be[Ae+2];if(De==de||De==fe){var Xe=ft(he<0?s.line:s.rest[he]),Ct=be[Ae]+Se;return(Se<0||De!=de)&&(Ct=be[Ae+(Se?1:0)]),se(Xe,Ct)}}}var H=F(w,L,h);if(H)return hc(H,y);for(var Y=L.nextSibling,q=w?w.nodeValue.length-h:0;Y;Y=Y.nextSibling){if(H=F(Y,Y.firstChild,0),H)return hc(se(H.line,H.ch-q),y);q+=Y.textContent.length}for(var ee=L.previousSibling,ne=h;ee;ee=ee.previousSibling){if(H=F(ee,ee.firstChild,-1),H)return hc(se(H.line,H.ch+ne),y);ne+=ee.textContent.length}}var jt=function(s){this.cm=s,this.prevInput="",this.pollingFast=!1,this.polling=new et,this.hasSelection=!1,this.composing=null};jt.prototype.init=function(s){var u=this,h=this,f=this.cm;this.createField(s);var y=this.textarea;s.wrapper.insertBefore(this.wrapper,s.wrapper.firstChild),x&&(y.style.width="0px"),Ve(y,"input",function(){o&&l>=9&&u.hasSelection&&(u.hasSelection=null),h.poll()}),Ve(y,"paste",function(w){Zt(f,w)||bL(w,f)||(f.state.pasteIncoming=+new Date,h.fastPoll())});function S(w){if(!Zt(f,w)){if(f.somethingSelected())Mf({lineWise:!1,text:f.getSelections()});else if(f.options.lineWiseCopyCut){var L=CL(f);Mf({lineWise:!0,text:L.text}),w.type=="cut"?f.setSelections(L.ranges,null,Je):(h.prevInput="",y.value=L.text.join(`
`),le(y))}else return;w.type=="cut"&&(f.state.cutIncoming=+new Date)}}Ve(y,"cut",S),Ve(y,"copy",S),Ve(s.scroller,"paste",function(w){if(!(ja(s,w)||Zt(f,w))){if(!y.dispatchEvent){f.state.pasteIncoming=+new Date,h.focus();return}var L=new Event("paste");L.clipboardData=w.clipboardData,y.dispatchEvent(L)}}),Ve(s.lineSpace,"selectstart",function(w){ja(s,w)||_n(w)}),Ve(y,"compositionstart",function(){var w=f.getCursor("from");h.composing&&h.composing.range.clear(),h.composing={start:w,range:f.markText(w,f.getCursor("to"),{className:"CodeMirror-composing"})}}),Ve(y,"compositionend",function(){h.composing&&(h.poll(),h.composing.range.clear(),h.composing=null)})},jt.prototype.createField=function(s){this.wrapper=TL(),this.textarea=this.wrapper.firstChild},jt.prototype.screenReaderLabelChanged=function(s){s?this.textarea.setAttribute("aria-label",s):this.textarea.removeAttribute("aria-label")},jt.prototype.prepareSelection=function(){var s=this.cm,u=s.display,h=s.doc,f=fT(s);if(s.options.moveInputWithCursor){var y=Ii(s,h.sel.primary().head,"div"),S=u.wrapper.getBoundingClientRect(),w=u.lineDiv.getBoundingClientRect();f.teTop=Math.max(0,Math.min(u.wrapper.clientHeight-10,y.top+w.top-S.top)),f.teLeft=Math.max(0,Math.min(u.wrapper.clientWidth-10,y.left+w.left-S.left))}return f},jt.prototype.showSelection=function(s){var u=this.cm,h=u.display;_(h.cursorDiv,s.cursors),_(h.selectionDiv,s.selection),s.teTop!=null&&(this.wrapper.style.top=s.teTop+"px",this.wrapper.style.left=s.teLeft+"px")},jt.prototype.reset=function(s){if(!(this.contextMenuPending||this.composing)){var u=this.cm;if(u.somethingSelected()){this.prevInput="";var h=u.getSelection();this.textarea.value=h,u.state.focused&&le(this.textarea),o&&l>=9&&(this.hasSelection=h)}else s||(this.prevInput=this.textarea.value="",o&&l>=9&&(this.hasSelection=null))}},jt.prototype.getField=function(){return this.textarea},jt.prototype.supportsTouch=function(){return!1},jt.prototype.focus=function(){if(this.cm.options.readOnly!="nocursor"&&(!T||pe()!=this.textarea))try{this.textarea.focus()}catch(s){}},jt.prototype.blur=function(){this.textarea.blur()},jt.prototype.resetPosition=function(){this.wrapper.style.top=this.wrapper.style.left=0},jt.prototype.receivedFocus=function(){this.slowPoll()},jt.prototype.slowPoll=function(){var s=this;this.pollingFast||this.polling.set(this.cm.options.pollInterval,function(){s.poll(),s.cm.state.focused&&s.slowPoll()})},jt.prototype.fastPoll=function(){var s=!1,u=this;u.pollingFast=!0;function h(){var f=u.poll();!f&&!s?(s=!0,u.polling.set(60,h)):(u.pollingFast=!1,u.slowPoll())}u.polling.set(20,h)},jt.prototype.poll=function(){var s=this,u=this.cm,h=this.textarea,f=this.prevInput;if(this.contextMenuPending||!u.state.focused||rf(h)&&!f&&!this.composing||u.isReadOnly()||u.options.disableInput||u.state.keySeq)return!1;var y=h.value;if(y==f&&!u.somethingSelected())return!1;if(o&&l>=9&&this.hasSelection===y||I&&/[\uf700-\uf7ff]/.test(y))return u.display.input.reset(),!1;if(u.doc.sel==u.display.selForContextMenu){var S=y.charCodeAt(0);if(S==8203&&!f&&(f="\u200B"),S==8666)return this.reset(),this.cm.execCommand("undo")}for(var w=0,L=Math.min(f.length,y.length);w<L&&f.charCodeAt(w)==y.charCodeAt(w);)++w;return Ir(u,function(){av(u,y.slice(w),f.length-w,null,s.composing?"*compose":null),y.length>1e3||y.indexOf(`
`)>-1?h.value=s.prevInput="":s.prevInput=y,s.composing&&(s.composing.range.clear(),s.composing.range=u.markText(s.composing.start,u.getCursor("to"),{className:"CodeMirror-composing"}))}),!0},jt.prototype.ensurePolled=function(){this.pollingFast&&this.poll()&&(this.pollingFast=!1)},jt.prototype.onKeyPress=function(){o&&l>=9&&(this.hasSelection=null),this.fastPoll()},jt.prototype.onContextMenu=function(s){var u=this,h=u.cm,f=h.display,y=u.textarea;u.contextMenuPending&&u.contextMenuPending();var S=Os(h,s),w=f.scroller.scrollTop;if(!S||m)return;var L=h.options.resetSelectionOnContextMenu;L&&h.doc.sel.contains(S)==-1&&dn(h,On)(h.doc,Ro(S),Je);var k=y.style.cssText,A=u.wrapper.style.cssText,F=u.wrapper.offsetParent.getBoundingClientRect();u.wrapper.style.cssText="position: static",y.style.cssText=`position: absolute; width: 30px; height: 30px;
      top: `+(s.clientY-F.top-5)+"px; left: "+(s.clientX-F.left-5)+`px;
      z-index: 1000; background: `+(o?"rgba(255, 255, 255, .05)":"transparent")+`;
      outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);`;var H;c&&(H=window.scrollY),f.input.focus(),c&&window.scrollTo(null,H),f.input.reset(),h.somethingSelected()||(y.value=u.prevInput=" "),u.contextMenuPending=q,f.selForContextMenu=h.doc.sel,clearTimeout(f.detectingSelectAll);function Y(){if(y.selectionStart!=null){var ne=h.somethingSelected(),de="\u200B"+(ne?y.value:"");y.value="\u21DA",y.value=de,u.prevInput=ne?"":"\u200B",y.selectionStart=1,y.selectionEnd=de.length,f.selForContextMenu=h.doc.sel}}function q(){if(u.contextMenuPending==q&&(u.contextMenuPending=!1,u.wrapper.style.cssText=A,y.style.cssText=k,o&&l<9&&f.scrollbars.setScrollTop(f.scroller.scrollTop=w),y.selectionStart!=null)){(!o||o&&l<9)&&Y();var ne=0,de=function(){f.selForContextMenu==h.doc.sel&&y.selectionStart==0&&y.selectionEnd>0&&u.prevInput=="\u200B"?dn(h,HT)(h):ne++<10?f.detectingSelectAll=setTimeout(de,500):(f.selForContextMenu=null,f.input.reset())};f.detectingSelectAll=setTimeout(de,200)}}if(o&&l>=9&&Y(),V){Ms(s);var ee=function(){cr(window,"mouseup",ee),setTimeout(q,20)};Ve(window,"mouseup",ee)}else setTimeout(q,50)},jt.prototype.readOnlyChanged=function(s){s||this.reset(),this.textarea.disabled=s=="nocursor",this.textarea.readOnly=!!s},jt.prototype.setUneditable=function(){},jt.prototype.needsContentAttribute=!1;function TU(s,u){if(u=u?Re(u):{},u.value=s.value,!u.tabindex&&s.tabIndex&&(u.tabindex=s.tabIndex),!u.placeholder&&s.placeholder&&(u.placeholder=s.placeholder),u.autofocus==null){var h=pe();u.autofocus=h==s||s.getAttribute("autofocus")!=null&&h==document.body}function f(){s.value=L.getValue()}var y;if(s.form&&(Ve(s.form,"submit",f),!u.leaveSubmitMethodAlone)){var S=s.form;y=S.submit;try{var w=S.submit=function(){f(),S.submit=y,S.submit(),S.submit=w}}catch(k){}}u.finishInit=function(k){k.save=f,k.getTextArea=function(){return s},k.toTextArea=function(){k.toTextArea=isNaN,f(),s.parentNode.removeChild(k.getWrapperElement()),s.style.display="",s.form&&(cr(s.form,"submit",f),!u.leaveSubmitMethodAlone&&typeof s.form.submit=="function"&&(s.form.submit=y))}},s.style.display="none";var L=Rt(function(k){return s.parentNode.insertBefore(k,s.nextSibling)},u);return L}function LU(s){s.off=cr,s.on=Ve,s.wheelEventPixels=MB,s.Doc=pr,s.splitLines=wu,s.countColumn=Ue,s.findColumn=dt,s.isWordChar=oi,s.Pass=$e,s.signal=Fe,s.Line=Ql,s.changeEnd=_o,s.scrollbarModel=bT,s.Pos=se,s.cmpPos=R,s.modes=si,s.mimeModes=zr,s.resolveMode=Yl,s.getMode=Kl,s.modeExtensions=Di,s.extendMode=Pi,s.copyState=Hr,s.startState=ku,s.innerMode=Lu,s.commands=Xu,s.keyMap=Ja,s.keyName=oL,s.isModifierKey=iL,s.lookupKey=dc,s.normalizeKeyMap=eU,s.StringStream=Ft,s.SharedTextMarker=qu,s.TextMarker=Oo,s.LineWidget=Ju,s.e_preventDefault=_n,s.e_stopPropagation=ql,s.e_stop=Ms,s.addClass=me,s.contains=ie,s.rmClass=B,s.keyNames=No}gU(Rt),bU(Rt);var kU="iter insert remove copy getEditor constructor".split(" ");for(var _f in pr.prototype)pr.prototype.hasOwnProperty(_f)&&ye(kU,_f)<0&&(Rt.prototype[_f]=function(s){return function(){return s.apply(this.doc,arguments)}}(pr.prototype[_f]));return oa(pr),Rt.inputStyles={textarea:jt,contenteditable:yt},Rt.defineMode=function(s){!Rt.defaults.mode&&s!="null"&&(Rt.defaults.mode=s),of.apply(this,arguments)},Rt.defineMIME=za,Rt.defineMode("null",function(){return{token:function(s){return s.skipToEnd()}}}),Rt.defineMIME("text/plain","null"),Rt.defineExtension=function(s,u){Rt.prototype[s]=u},Rt.defineDocExtension=function(s,u){pr.prototype[s]=u},Rt.fromTextArea=TU,LU(Rt),Rt.version="5.61.1",Rt})});var K_=Jt((q_,Y_)=>{(function(n){typeof q_=="object"&&typeof Y_=="object"?n(Cs()):typeof define=="function"&&define.amd?define(["../../lib/codemirror"],n):n(CodeMirror)})(function(n){"use strict";var e="CodeMirror-lint-markers";function t(P,M,D){var E=document.createElement("div");E.className="CodeMirror-lint-tooltip cm-s-"+P.options.theme,E.appendChild(D.cloneNode(!0)),P.state.lint.options.selfContain?P.getWrapperElement().appendChild(E):document.body.appendChild(E);function V(O){if(!E.parentNode)return n.off(document,"mousemove",V);E.style.top=Math.max(0,O.clientY-E.offsetHeight-5)+"px",E.style.left=O.clientX+5+"px"}return n.on(document,"mousemove",V),V(M),E.style.opacity!=null&&(E.style.opacity=1),E}function r(P){P.parentNode&&P.parentNode.removeChild(P)}function i(P){!P.parentNode||(P.style.opacity==null&&r(P),P.style.opacity=0,setTimeout(function(){r(P)},600))}function a(P,M,D,E){var V=t(P,M,D);function O(){n.off(E,"mouseout",O),V&&(i(V),V=null)}var B=setInterval(function(){if(V)for(var z=E;;z=z.parentNode){if(z&&z.nodeType==11&&(z=z.host),z==document.body)return;if(!z){O();break}}if(!V)return clearInterval(B)},400);n.on(E,"mouseout",O)}function o(P,M,D){this.marked=[],this.options=M,this.timeout=null,this.hasGutter=D,this.onMouseOver=function(E){I(P,E)},this.waitingFor=0}function l(P,M){return M instanceof Function?{getAnnotations:M}:((!M||M===!0)&&(M={}),M)}function c(P){var M=P.state.lint;M.hasGutter&&P.clearGutter(e);for(var D=0;D<M.marked.length;++D)M.marked[D].clear();M.marked.length=0}function d(P,M,D,E,V){var O=document.createElement("div"),B=O;return O.className="CodeMirror-lint-marker CodeMirror-lint-marker-"+D,E&&(B=O.appendChild(document.createElement("div")),B.className="CodeMirror-lint-marker CodeMirror-lint-marker-multiple"),V!=!1&&n.on(B,"mouseover",function(z){a(P,z,M,B)}),O}function p(P,M){return P=="error"?P:M}function m(P){for(var M=[],D=0;D<P.length;++D){var E=P[D],V=E.from.line;(M[V]||(M[V]=[])).push(E)}return M}function g(P){var M=P.severity;M||(M="error");var D=document.createElement("div");return D.className="CodeMirror-lint-message CodeMirror-lint-message-"+M,typeof P.messageHTML!="undefined"?D.innerHTML=P.messageHTML:D.appendChild(document.createTextNode(P.message)),D}function v(P,M,D){var E=P.state.lint,V=++E.waitingFor;function O(){V=-1,P.off("change",O)}P.on("change",O),M(P.getValue(),function(B,z){P.off("change",O),E.waitingFor==V&&(z&&B instanceof n&&(B=z),P.operation(function(){x(P,B)}))},D,P)}function b(P){var M=P.state.lint,D=M.options,E=D.options||D,V=D.getAnnotations||P.getHelper(n.Pos(0,0),"lint");if(!!V)if(D.async||V.async)v(P,V,E);else{var O=V(P.getValue(),E,P);if(!O)return;O.then?O.then(function(B){P.operation(function(){x(P,B)})}):P.operation(function(){x(P,O)})}}function x(P,M){c(P);for(var D=P.state.lint,E=D.options,V=m(M),O=0;O<V.length;++O){var B=V[O];if(!!B){var z=[];B=B.filter(function(pe){return z.indexOf(pe.message)>-1?!1:z.push(pe.message)});for(var _=null,U=D.hasGutter&&document.createDocumentFragment(),N=0;N<B.length;++N){var J=B[N],ie=J.severity;ie||(ie="error"),_=p(_,ie),E.formatAnnotation&&(J=E.formatAnnotation(J)),D.hasGutter&&U.appendChild(g(J)),J.to&&D.marked.push(P.markText(J.from,J.to,{className:"CodeMirror-lint-mark CodeMirror-lint-mark-"+ie,__annotation:J}))}D.hasGutter&&P.setGutterMarker(O,e,d(P,U,_,V[O].length>1,D.options.tooltips))}}E.onUpdateLinting&&E.onUpdateLinting(M,V,P)}function C(P){var M=P.state.lint;!M||(clearTimeout(M.timeout),M.timeout=setTimeout(function(){b(P)},M.options.delay||500))}function T(P,M,D){for(var E=D.target||D.srcElement,V=document.createDocumentFragment(),O=0;O<M.length;O++){var B=M[O];V.appendChild(g(B))}a(P,D,V,E)}function I(P,M){var D=M.target||M.srcElement;if(!!/\bCodeMirror-lint-mark-/.test(D.className)){for(var E=D.getBoundingClientRect(),V=(E.left+E.right)/2,O=(E.top+E.bottom)/2,B=P.findMarksAt(P.coordsChar({left:V,top:O},"client")),z=[],_=0;_<B.length;++_){var U=B[_].__annotation;U&&z.push(U)}z.length&&T(P,z,M)}}n.defineOption("lint",!1,function(P,M,D){if(D&&D!=n.Init&&(c(P),P.state.lint.options.lintOnChange!==!1&&P.off("change",C),n.off(P.getWrapperElement(),"mouseover",P.state.lint.onMouseOver),clearTimeout(P.state.lint.timeout),delete P.state.lint),M){for(var E=P.getOption("gutters"),V=!1,O=0;O<E.length;++O)E[O]==e&&(V=!0);var B=P.state.lint=new o(P,l(P,M),V);B.options.lintOnChange!==!1&&P.on("change",C),B.options.tooltips!=!1&&B.options.tooltips!="gutter"&&n.on(P.getWrapperElement(),"mouseover",B.onMouseOver),b(P)}}),n.defineExtension("performLint",function(){this.state.lint&&b(this)})})});var Q_=Jt((h0e,X_)=>{X_.exports=function(n){n.defineMode("glsl",function(a,o){var l=a.indentUnit,c=o.keywords||e(t),d=o.builtins||e(r),p=o.blockKeywords||e("case do else for if switch while struct"),m=o.atoms||e("null"),g=o.hooks||{},v=o.multiLineStrings,b=/[+\-*&%=<>!?|\/]/,x;function C(E,V){var O=E.next();if(g[O]){var B=g[O](E,V);if(B!==!1)return B}if(O=='"'||O=="'")return V.tokenize=T(O),V.tokenize(E,V);if(/[\[\]{}\(\),;\:\.]/.test(O))return x=O,"bracket";if(/\d/.test(O))return E.eatWhile(/[\w\.]/),"number";if(O=="/"){if(E.eat("*"))return V.tokenize=I,I(E,V);if(E.eat("/"))return E.skipToEnd(),"comment"}if(O=="#")return E.eatWhile(/[\S]+/),E.eatWhile(/[\s]+/),E.eatWhile(/[\S]+/),E.eatWhile(/[\s]+/),"comment";if(b.test(O))return E.eatWhile(b),"operator";E.eatWhile(/[\w\$_]/);var z=E.current();return c.propertyIsEnumerable(z)?(p.propertyIsEnumerable(z)&&(x="newstatement"),"keyword"):d.propertyIsEnumerable(z)?"builtin":m.propertyIsEnumerable(z)?"atom":"word"}function T(E){return function(V,O){for(var B=!1,z,_=!1;(z=V.next())!=null;){if(z==E&&!B){_=!0;break}B=!B&&z=="\\"}return(_||!(B||v))&&(O.tokenize=C),"string"}}function I(E,V){for(var O=!1,B;B=E.next();){if(B=="/"&&O){V.tokenize=C;break}O=B=="*"}return"comment"}function P(E,V,O,B,z){this.indented=E,this.column=V,this.type=O,this.align=B,this.prev=z}function M(E,V,O){return E.context=new P(E.indented,V,O,null,E.context)}function D(E){var V=E.context.type;return(V==")"||V=="]"||V=="}")&&(E.indented=E.context.indented),E.context=E.context.prev}return{startState:function(E){return{tokenize:null,context:new P((E||0)-l,0,"top",!1),indented:0,startOfLine:!0}},token:function(E,V){var O=V.context;if(E.sol()&&(O.align==null&&(O.align=!1),V.indented=E.indentation(),V.startOfLine=!0),E.eatSpace())return null;x=null;var B=(V.tokenize||C)(E,V);if(B=="comment"||B=="meta")return B;if(O.align==null&&(O.align=!0),(x==";"||x==":")&&O.type=="statement")D(V);else if(x=="{")M(V,E.column(),"}");else if(x=="[")M(V,E.column(),"]");else if(x=="(")M(V,E.column(),")");else if(x=="}"){for(;O.type=="statement";)O=D(V);for(O.type=="}"&&(O=D(V));O.type=="statement";)O=D(V)}else x==O.type?D(V):(O.type=="}"||O.type=="top"||O.type=="statement"&&x=="newstatement")&&M(V,E.column(),"statement");return V.startOfLine=!1,B},indent:function(E,V){if(E.tokenize!=C&&E.tokenize!=null)return 0;var O=V&&V.charAt(0),B=E.context,z=O==B.type;return B.type=="statement"?B.indented+(O=="{"?0:l):B.align?B.column+(z?0:1):B.indented+(z?0:l)},electricChars:"{}"}});function e(a){for(var o={},l=a.split(" "),c=0;c<l.length;++c)o[l[c]]=!0;return o}var t="attribute const uniform varying break continue do for while if else in out inout float int void bool true false lowp mediump highp precision invariant discard return mat2 mat3 mat4 vec2 vec3 vec4 ivec2 ivec3 ivec4 bvec2 bvec3 bvec4 sampler2D samplerCube struct gl_FragCoord gl_FragColor",r="radians degrees sin cos tan asin acos atan pow exp log exp2 log2 sqrt inversesqrt abs sign floor ceil fract mod min max clamp mix step smoothstep length distance dot cross normalize faceforward reflect refract matrixCompMult lessThan lessThanEqual greaterThan greaterThanEqual equal notEqual any all not dFdx dFdy fwidth texture2D texture2DProj texture2DLod texture2DProjLod textureCube textureCubeLod require export";function i(a,o){return o.startOfLine?(a.skipToEnd(),"meta"):!1}(function(){function a(o,l){for(var c;(c=o.next())!=null;)if(c=='"'&&!o.eat('"')){l.tokenize=null;break}return"string"}n.defineMIME("text/x-glsl",{name:"glsl",keywords:e(t),builtins:e(r),blockKeywords:e("case do else for if switch while struct"),atoms:e("null"),hooks:{"#":i}})})()}});var oN=Jt((iN,aN)=>{(function(n){typeof iN=="object"&&typeof aN=="object"?n(Cs()):typeof define=="function"&&define.amd?define(["../../lib/codemirror"],n):n(CodeMirror)})(function(n){"use strict";n.defineMode("javascript",function(e,t){var r=e.indentUnit,i=t.statementIndent,a=t.jsonld,o=t.json||a,l=t.trackScope!==!1,c=t.typescript,d=t.wordCharacters||/[\w$\xa1-\uffff]/,p=function(){function R(Vn){return{type:Vn,style:"keyword"}}var $=R("keyword a"),te=R("keyword b"),ue=R("keyword c"),Ge=R("keyword d"),st=R("operator"),ve={type:"atom",style:"atom"};return{if:R("if"),while:$,with:$,else:te,do:te,try:te,finally:te,return:Ge,break:Ge,continue:Ge,new:R("new"),delete:ue,void:ue,throw:ue,debugger:R("debugger"),var:R("var"),const:R("var"),let:R("var"),function:R("function"),catch:R("catch"),for:R("for"),switch:R("switch"),case:R("case"),default:R("default"),in:st,typeof:st,instanceof:st,true:ve,false:ve,null:ve,undefined:ve,NaN:ve,Infinity:ve,this:R("this"),class:R("class"),super:R("atom"),yield:ue,export:R("export"),import:R("import"),extends:ue,await:ue}}(),m=/[+\-*&%=<>!?|~^@]/,g=/^@(context|id|value|language|type|container|list|set|reverse|index|base|vocab|graph)"/;function v(R){for(var $=!1,te,ue=!1;(te=R.next())!=null;){if(!$){if(te=="/"&&!ue)return;te=="["?ue=!0:ue&&te=="]"&&(ue=!1)}$=!$&&te=="\\"}}var b,x;function C(R,$,te){return b=R,x=te,$}function T(R,$){var te=R.next();if(te=='"'||te=="'")return $.tokenize=I(te),$.tokenize(R,$);if(te=="."&&R.match(/^\d[\d_]*(?:[eE][+\-]?[\d_]+)?/))return C("number","number");if(te=="."&&R.match(".."))return C("spread","meta");if(/[\[\]{}\(\),;\:\.]/.test(te))return C(te);if(te=="="&&R.eat(">"))return C("=>","operator");if(te=="0"&&R.match(/^(?:x[\dA-Fa-f_]+|o[0-7_]+|b[01_]+)n?/))return C("number","number");if(/\d/.test(te))return R.match(/^[\d_]*(?:n|(?:\.[\d_]*)?(?:[eE][+\-]?[\d_]+)?)?/),C("number","number");if(te=="/")return R.eat("*")?($.tokenize=P,P(R,$)):R.eat("/")?(R.skipToEnd(),C("comment","comment")):se(R,$,1)?(v(R),R.match(/^\b(([gimyus])(?![gimyus]*\2))+\b/),C("regexp","string-2")):(R.eat("="),C("operator","operator",R.current()));if(te=="`")return $.tokenize=M,M(R,$);if(te=="#"&&R.peek()=="!")return R.skipToEnd(),C("meta","meta");if(te=="#"&&R.eatWhile(d))return C("variable","property");if(te=="<"&&R.match("!--")||te=="-"&&R.match("->")&&!/\S/.test(R.string.slice(0,R.start)))return R.skipToEnd(),C("comment","comment");if(m.test(te))return(te!=">"||!$.lexical||$.lexical.type!=">")&&(R.eat("=")?(te=="!"||te=="=")&&R.eat("="):/[<>*+\-|&?]/.test(te)&&(R.eat(te),te==">"&&R.eat(te))),te=="?"&&R.eat(".")?C("."):C("operator","operator",R.current());if(d.test(te)){R.eatWhile(d);var ue=R.current();if($.lastType!="."){if(p.propertyIsEnumerable(ue)){var Ge=p[ue];return C(Ge.type,Ge.style,ue)}if(ue=="async"&&R.match(/^(\s|\/\*([^*]|\*(?!\/))*?\*\/)*[\[\(\w]/,!1))return C("async","keyword",ue)}return C("variable","variable",ue)}}function I(R){return function($,te){var ue=!1,Ge;if(a&&$.peek()=="@"&&$.match(g))return te.tokenize=T,C("jsonld-keyword","meta");for(;(Ge=$.next())!=null&&!(Ge==R&&!ue);)ue=!ue&&Ge=="\\";return ue||(te.tokenize=T),C("string","string")}}function P(R,$){for(var te=!1,ue;ue=R.next();){if(ue=="/"&&te){$.tokenize=T;break}te=ue=="*"}return C("comment","comment")}function M(R,$){for(var te=!1,ue;(ue=R.next())!=null;){if(!te&&(ue=="`"||ue=="$"&&R.eat("{"))){$.tokenize=T;break}te=!te&&ue=="\\"}return C("quasi","string-2",R.current())}var D="([{}])";function E(R,$){$.fatArrowAt&&($.fatArrowAt=null);var te=R.string.indexOf("=>",R.start);if(!(te<0)){if(c){var ue=/:\s*(?:\w+(?:<[^>]*>|\[\])?|\{[^}]*\})\s*$/.exec(R.string.slice(R.start,te));ue&&(te=ue.index)}for(var Ge=0,st=!1,ve=te-1;ve>=0;--ve){var Vn=R.string.charAt(ve),$r=D.indexOf(Vn);if($r>=0&&$r<3){if(!Ge){++ve;break}if(--Ge==0){Vn=="("&&(st=!0);break}}else if($r>=3&&$r<6)++Ge;else if(d.test(Vn))st=!0;else if(/["'\/`]/.test(Vn))for(;;--ve){if(ve==0)return;var Xl=R.string.charAt(ve-1);if(Xl==Vn&&R.string.charAt(ve-2)!="\\"){ve--;break}}else if(st&&!Ge){++ve;break}}st&&!Ge&&($.fatArrowAt=ve)}}var V={atom:!0,number:!0,variable:!0,string:!0,regexp:!0,this:!0,import:!0,"jsonld-keyword":!0};function O(R,$,te,ue,Ge,st){this.indented=R,this.column=$,this.type=te,this.prev=Ge,this.info=st,ue!=null&&(this.align=ue)}function B(R,$){if(!l)return!1;for(var te=R.localVars;te;te=te.next)if(te.name==$)return!0;for(var ue=R.context;ue;ue=ue.prev)for(var te=ue.vars;te;te=te.next)if(te.name==$)return!0}function z(R,$,te,ue,Ge){var st=R.cc;for(_.state=R,_.stream=Ge,_.marked=null,_.cc=st,_.style=$,R.lexical.hasOwnProperty("align")||(R.lexical.align=!0);;){var ve=st.length?st.pop():o?_e:Je;if(ve(te,ue)){for(;st.length&&st[st.length-1].lex;)st.pop()();return _.marked?_.marked:te=="variable"&&B(R,ue)?"variable-2":$}}}var _={state:null,column:null,marked:null,cc:null};function U(){for(var R=arguments.length-1;R>=0;R--)_.cc.push(arguments[R])}function N(){return U.apply(null,arguments),!0}function J(R,$){for(var te=$;te;te=te.next)if(te.name==R)return!0;return!1}function ie(R){var $=_.state;if(_.marked="def",!!l){if($.context){if($.lexical.info=="var"&&$.context&&$.context.block){var te=pe(R,$.context);if(te!=null){$.context=te;return}}else if(!J(R,$.localVars)){$.localVars=new le(R,$.localVars);return}}t.globalVars&&!J(R,$.globalVars)&&($.globalVars=new le(R,$.globalVars))}}function pe(R,$){if($)if($.block){var te=pe(R,$.prev);return te?te==$.prev?$:new Pe(te,$.vars,!0):null}else return J(R,$.vars)?$:new Pe($.prev,new le(R,$.vars),!1);else return null}function me(R){return R=="public"||R=="private"||R=="protected"||R=="abstract"||R=="readonly"}function Pe(R,$,te){this.prev=R,this.vars=$,this.block=te}function le(R,$){this.name=R,this.next=$}var we=new le("this",new le("arguments",null));function Re(){_.state.context=new Pe(_.state.context,_.state.localVars,!1),_.state.localVars=we}function Ue(){_.state.context=new Pe(_.state.context,_.state.localVars,!0),_.state.localVars=null}function et(){_.state.localVars=_.state.context.vars,_.state.context=_.state.context.prev}et.lex=!0;function ye(R,$){var te=function(){var ue=_.state,Ge=ue.indented;if(ue.lexical.type=="stat")Ge=ue.lexical.indented;else for(var st=ue.lexical;st&&st.type==")"&&st.align;st=st.prev)Ge=st.indented;ue.lexical=new O(Ge,_.stream.column(),R,null,ue.lexical,$)};return te.lex=!0,te}function ke(){var R=_.state;R.lexical.prev&&(R.lexical.type==")"&&(R.indented=R.lexical.indented),R.lexical=R.lexical.prev)}ke.lex=!0;function $e(R){function $(te){return te==R?N():R==";"||te=="}"||te==")"||te=="]"?U():N($)}return $}function Je(R,$){return R=="var"?N(ye("vardef",$),xu,$e(";"),ke):R=="keyword a"?N(ye("form"),jn,Je,ke):R=="keyword b"?N(ye("form"),Je,ke):R=="keyword d"?_.stream.match(/^\s*$/,!1)?N():N(ye("stat"),nt,$e(";"),ke):R=="debugger"?N($e(";")):R=="{"?N(ye("}"),Ue,Dr,ke,et):R==";"?N():R=="if"?(_.state.lexical.info=="else"&&_.state.cc[_.state.cc.length-1]==ke&&_.state.cc.pop()(),N(ye("form"),jn,Je,ke,rf)):R=="function"?N(si):R=="for"?N(ye("form"),Ue,af,Je,et,ke):R=="class"||c&&$=="interface"?(_.marked="keyword",N(ye("form",R=="class"?R:$),Kl,ke)):R=="variable"?c&&$=="declare"?(_.marked="keyword",N(Je)):c&&($=="module"||$=="enum"||$=="type")&&_.stream.match(/^\s*\w/,!1)?(_.marked="keyword",$=="enum"?N(ca):$=="type"?N(of,$e("operator"),Fe,$e(";")):N(ye("form"),ur,$e("{"),ye("}"),Dr,ke,ke)):c&&$=="namespace"?(_.marked="keyword",N(ye("form"),_e,Je,ke)):c&&$=="abstract"?(_.marked="keyword",N(Je)):N(ye("stat"),$l):R=="switch"?N(ye("form"),jn,$e("{"),ye("}","switch"),Ue,Dr,ke,ke,et):R=="case"?N(_e,$e(":")):R=="default"?N($e(":")):R=="catch"?N(ye("form"),Re,tt,Je,ke,et):R=="export"?N(ye("stat"),Lu,ke):R=="import"?N(ye("stat"),Ft,ke):R=="async"?N(Je):$=="@"?N(_e,Je):U(ye("stat"),_e,$e(";"),ke)}function tt(R){if(R=="(")return N(za,$e(")"))}function _e(R,$){return ta(R,$,!1)}function dt(R,$){return ta(R,$,!0)}function jn(R){return R!="("?U():N(ye(")"),nt,$e(")"),ke)}function ta(R,$,te){if(_.state.fatArrowAt==_.stream.start){var ue=te?oi:aa;if(R=="(")return N(Re,ye(")"),Lt(za,")"),ke,$e("=>"),ue,et);if(R=="variable")return U(Re,ur,$e("=>"),ue,et)}var Ge=te?na:Er;return V.hasOwnProperty(R)?N(Ge):R=="function"?N(si,Ge):R=="class"||c&&$=="interface"?(_.marked="keyword",N(ye("form"),Yl,ke)):R=="keyword c"||R=="async"?N(te?dt:_e):R=="("?N(ye(")"),nt,$e(")"),ke,Ge):R=="operator"||R=="spread"?N(te?dt:_e):R=="["?N(ye("]"),ft,ke,Ge):R=="{"?As(Rn,"}",null,Ge):R=="quasi"?U(ra,Ge):R=="new"?N(Ei(te)):N()}function nt(R){return R.match(/[;\}\)\],]/)?U():U(_e)}function Er(R,$){return R==","?N(nt):na(R,$,!1)}function na(R,$,te){var ue=te==!1?Er:na,Ge=te==!1?_e:dt;if(R=="=>")return N(Re,te?oi:aa,et);if(R=="operator")return/\+\+|--/.test($)||c&&$=="!"?N(ue):c&&$=="<"&&_.stream.match(/^([^<>]|<[^<>]*>)*>\s*\(/,!1)?N(ye(">"),Lt(Fe,">"),ke,ue):$=="?"?N(_e,$e(":"),Ge):N(Ge);if(R=="quasi")return U(ra,ue);if(R!=";"){if(R=="(")return As(dt,")","call",ue);if(R==".")return N(Eo,ue);if(R=="[")return N(ye("]"),nt,$e("]"),ke,ue);if(c&&$=="as")return _.marked="keyword",N(Fe,ue);if(R=="regexp")return _.state.lastType=_.marked="operator",_.stream.backUp(_.stream.pos-_.stream.start-1),N(Ge)}}function ra(R,$){return R!="quasi"?U():$.slice($.length-2)!="${"?N(ra):N(_e,ia)}function ia(R){if(R=="}")return _.marked="string-2",_.state.tokenize=M,N(ra)}function aa(R){return E(_.stream,_.state),U(R=="{"?Je:_e)}function oi(R){return E(_.stream,_.state),U(R=="{"?Je:dt)}function Ei(R){return function($){return $=="."?N(R?ko:Ga):$=="variable"&&c?N(Ms,R?na:Er):U(R?dt:_e)}}function Ga(R,$){if($=="target")return _.marked="keyword",N(Er)}function ko(R,$){if($=="target")return _.marked="keyword",N(na)}function $l(R){return R==":"?N(ke,Je):U(Er,$e(";"),ke)}function Eo(R){if(R=="variable")return _.marked="property",N()}function Rn(R,$){if(R=="async")return _.marked="property",N(Rn);if(R=="variable"||_.style=="keyword"){if(_.marked="property",$=="get"||$=="set")return N(bu);var te;return c&&_.state.fatArrowAt==_.stream.start&&(te=_.stream.match(/^\s*:\s*/,!1))&&(_.state.fatArrowAt=_.stream.pos+te[0].length),N(lr)}else{if(R=="number"||R=="string")return _.marked=a?"property":_.style+" property",N(lr);if(R=="jsonld-keyword")return N(lr);if(c&&me($))return _.marked="keyword",N(Rn);if(R=="[")return N(_e,Wa,$e("]"),lr);if(R=="spread")return N(dt,lr);if($=="*")return _.marked="keyword",N(Rn);if(R==":")return U(lr)}}function bu(R){return R!="variable"?U(lr):(_.marked="property",N(si))}function lr(R){if(R==":")return N(dt);if(R=="(")return U(si)}function Lt(R,$,te){function ue(Ge,st){if(te?te.indexOf(Ge)>-1:Ge==","){var ve=_.state.lexical;return ve.info=="call"&&(ve.pos=(ve.pos||0)+1),N(function(Vn,$r){return Vn==$||$r==$?U():U(R)},ue)}return Ge==$||st==$?N():te&&te.indexOf(";")>-1?U(R):N($e($))}return function(Ge,st){return Ge==$||st==$?N():U(R,ue)}}function As(R,$,te){for(var ue=3;ue<arguments.length;ue++)_.cc.push(arguments[ue]);return N(ye($,te),Lt(R,$),ke)}function Dr(R){return R=="}"?N():U(Je,Dr)}function Wa(R,$){if(c){if(R==":")return N(Fe);if($=="?")return N(Wa)}}function Ve(R,$){if(c&&(R==":"||$=="in"))return N(Fe)}function jl(R){if(c&&R==":")return _.stream.match(/^\s*\w+\s+is\b/,!1)?N(_e,cr,Fe):N(Fe)}function cr(R,$){if($=="is")return _.marked="keyword",N()}function Fe(R,$){if($=="keyof"||$=="typeof"||$=="infer"||$=="readonly")return _.marked="keyword",N($=="typeof"?dt:Fe);if(R=="variable"||$=="void")return _.marked="type",N(Wr);if($=="|"||$=="&")return N(Fe);if(R=="string"||R=="number"||R=="atom")return N(Wr);if(R=="[")return N(ye("]"),Lt(Fe,"]",","),ke,Wr);if(R=="{")return N(ye("}"),Jl,ke,Wr);if(R=="(")return N(Lt(ql,")"),Zt,Wr);if(R=="<")return N(Lt(Fe,">"),Fe);if(R=="quasi")return U(oa,Wr)}function Zt(R){if(R=="=>")return N(Fe)}function Jl(R){return R.match(/[\}\)\]]/)?N():R==","||R==";"?N(Jl):U(Ln,Jl)}function Ln(R,$){if(R=="variable"||_.style=="keyword")return _.marked="property",N(Ln);if($=="?"||R=="number"||R=="string")return N(Ln);if(R==":")return N(Fe);if(R=="[")return N($e("variable"),Ve,$e("]"),Ln);if(R=="(")return U(zr,Ln);if(!R.match(/[;\}\)\],]/))return N()}function oa(R,$){return R!="quasi"?U():$.slice($.length-2)!="${"?N(oa):N(Fe,_n)}function _n(R){if(R=="}")return _.marked="string-2",_.state.tokenize=M,N(oa)}function ql(R,$){return R=="variable"&&_.stream.match(/^\s*[?:]/,!1)||$=="?"?N(ql):R==":"?N(Fe):R=="spread"?N(ql):U(Fe)}function Wr(R,$){if($=="<")return N(ye(">"),Lt(Fe,">"),ke,Wr);if($=="|"||R=="."||$=="&")return N(Fe);if(R=="[")return N(Fe,$e("]"),Wr);if($=="extends"||$=="implements")return _.marked="keyword",N(Fe);if($=="?")return N(Fe,$e(":"),Fe)}function Ms(R,$){if($=="<")return N(ye(">"),Lt(Fe,">"),ke,Wr)}function Do(){return U(Fe,tf)}function tf(R,$){if($=="=")return N(Fe)}function xu(R,$){return $=="enum"?(_.marked="keyword",N(ca)):U(ur,Wa,sa,wu)}function ur(R,$){if(c&&me($))return _.marked="keyword",N(ur);if(R=="variable")return ie($),N();if(R=="spread")return N(ur);if(R=="[")return As(Cu,"]");if(R=="{")return As(nf,"}")}function nf(R,$){return R=="variable"&&!_.stream.match(/^\s*:/,!1)?(ie($),N(sa)):(R=="variable"&&(_.marked="property"),R=="spread"?N(ur):R=="}"?U():R=="["?N(_e,$e("]"),$e(":"),nf):N($e(":"),ur,sa))}function Cu(){return U(ur,sa)}function sa(R,$){if($=="=")return N(dt)}function wu(R){if(R==",")return N(xu)}function rf(R,$){if(R=="keyword b"&&$=="else")return N(ye("form","else"),Je,ke)}function af(R,$){if($=="await")return N(af);if(R=="(")return N(ye(")"),Tu,ke)}function Tu(R){return R=="var"?N(xu,Po):R=="variable"?N(Po):U(Po)}function Po(R,$){return R==")"?N():R==";"?N(Po):$=="in"||$=="of"?(_.marked="keyword",N(_e,Po)):U(_e,Po)}function si(R,$){if($=="*")return _.marked="keyword",N(si);if(R=="variable")return ie($),N(si);if(R=="(")return N(Re,ye(")"),Lt(za,")"),ke,jl,Je,et);if(c&&$=="<")return N(ye(">"),Lt(Do,">"),ke,si)}function zr(R,$){if($=="*")return _.marked="keyword",N(zr);if(R=="variable")return ie($),N(zr);if(R=="(")return N(Re,ye(")"),Lt(za,")"),ke,jl,et);if(c&&$=="<")return N(ye(">"),Lt(Do,">"),ke,zr)}function of(R,$){if(R=="keyword"||R=="variable")return _.marked="type",N(of);if($=="<")return N(ye(">"),Lt(Do,">"),ke)}function za(R,$){return $=="@"&&N(_e,za),R=="spread"?N(za):c&&me($)?(_.marked="keyword",N(za)):c&&R=="this"?N(Wa,sa):U(ur,Wa,sa)}function Yl(R,$){return R=="variable"?Kl(R,$):Di(R,$)}function Kl(R,$){if(R=="variable")return ie($),N(Di)}function Di(R,$){if($=="<")return N(ye(">"),Lt(Do,">"),ke,Di);if($=="extends"||$=="implements"||c&&R==",")return $=="implements"&&(_.marked="keyword"),N(c?Fe:_e,Di);if(R=="{")return N(ye("}"),Pi,ke)}function Pi(R,$){if(R=="async"||R=="variable"&&($=="static"||$=="get"||$=="set"||c&&me($))&&_.stream.match(/^\s+[\w$\xa1-\uffff]/,!1))return _.marked="keyword",N(Pi);if(R=="variable"||_.style=="keyword")return _.marked="property",N(Hr,Pi);if(R=="number"||R=="string")return N(Hr,Pi);if(R=="[")return N(_e,Wa,$e("]"),Hr,Pi);if($=="*")return _.marked="keyword",N(Pi);if(c&&R=="(")return U(zr,Pi);if(R==";"||R==",")return N(Pi);if(R=="}")return N();if($=="@")return N(_e,Pi)}function Hr(R,$){if($=="!"||$=="?")return N(Hr);if(R==":")return N(Fe,sa);if($=="=")return N(dt);var te=_.state.lexical.prev,ue=te&&te.info=="interface";return U(ue?zr:si)}function Lu(R,$){return $=="*"?(_.marked="keyword",N(Pr,$e(";"))):$=="default"?(_.marked="keyword",N(_e,$e(";"))):R=="{"?N(Lt(ku,"}"),Pr,$e(";")):U(Je)}function ku(R,$){if($=="as")return _.marked="keyword",N($e("variable"));if(R=="variable")return U(dt,ku)}function Ft(R){return R=="string"?N():R=="("?U(_e):R=="."?U(Er):U(Te,la,Pr)}function Te(R,$){return R=="{"?As(Te,"}"):(R=="variable"&&ie($),$=="*"&&(_.marked="keyword"),N(Eu))}function la(R){if(R==",")return N(Te,la)}function Eu(R,$){if($=="as")return _.marked="keyword",N(Te)}function Pr(R,$){if($=="from")return _.marked="keyword",N(_e)}function ft(R){return R=="]"?N():U(Lt(dt,"]"))}function ca(){return U(ye("form"),ur,$e("{"),ye("}"),Lt(Rs,"}"),ke,ke)}function Rs(){return U(ur,sa)}function Du(R,$){return R.lastType=="operator"||R.lastType==","||m.test($.charAt(0))||/[,.]/.test($.charAt(0))}function se(R,$,te){return $.tokenize==T&&/^(?:operator|sof|keyword [bcd]|case|new|export|default|spread|[\[{}\(,;:]|=>)$/.test($.lastType)||$.lastType=="quasi"&&/\{\s*$/.test(R.string.slice(0,R.pos-(te||0)))}return{startState:function(R){var $={tokenize:T,lastType:"sof",cc:[],lexical:new O((R||0)-r,0,"block",!1),localVars:t.localVars,context:t.localVars&&new Pe(null,null,!1),indented:R||0};return t.globalVars&&typeof t.globalVars=="object"&&($.globalVars=t.globalVars),$},token:function(R,$){if(R.sol()&&($.lexical.hasOwnProperty("align")||($.lexical.align=!1),$.indented=R.indentation(),E(R,$)),$.tokenize!=P&&R.eatSpace())return null;var te=$.tokenize(R,$);return b=="comment"?te:($.lastType=b=="operator"&&(x=="++"||x=="--")?"incdec":b,z($,te,b,x,R))},indent:function(R,$){if(R.tokenize==P||R.tokenize==M)return n.Pass;if(R.tokenize!=T)return 0;var te=$&&$.charAt(0),ue=R.lexical,Ge;if(!/^\s*else\b/.test($))for(var st=R.cc.length-1;st>=0;--st){var ve=R.cc[st];if(ve==ke)ue=ue.prev;else if(ve!=rf&&ve!=et)break}for(;(ue.type=="stat"||ue.type=="form")&&(te=="}"||(Ge=R.cc[R.cc.length-1])&&(Ge==Er||Ge==na)&&!/^[,\.=+\-*:?[\(]/.test($));)ue=ue.prev;i&&ue.type==")"&&ue.prev.type=="stat"&&(ue=ue.prev);var Vn=ue.type,$r=te==Vn;return Vn=="vardef"?ue.indented+(R.lastType=="operator"||R.lastType==","?ue.info.length+1:0):Vn=="form"&&te=="{"?ue.indented:Vn=="form"?ue.indented+r:Vn=="stat"?ue.indented+(Du(R,$)?i||r:0):ue.info=="switch"&&!$r&&t.doubleIndentSwitch!=!1?ue.indented+(/^(?:case|default)\b/.test($)?r:2*r):ue.align?ue.column+($r?0:1):ue.indented+($r?0:r)},electricInput:/^\s*(?:case .*?:|default:|\{|\})$/,blockCommentStart:o?null:"/*",blockCommentEnd:o?null:"*/",blockCommentContinue:o?null:" * ",lineComment:o?null:"//",fold:"brace",closeBrackets:"()[]{}''\"\"``",helperType:o?"json":"javascript",jsonldMode:a,jsonMode:o,expressionAllowed:se,skipExpression:function(R){z(R,"atom","atom","true",new n.StringStream("",2,null))}}}),n.registerHelper("wordChars","javascript",/[\w$]/),n.defineMIME("text/javascript","javascript"),n.defineMIME("text/ecmascript","javascript"),n.defineMIME("application/javascript","javascript"),n.defineMIME("application/x-javascript","javascript"),n.defineMIME("application/ecmascript","javascript"),n.defineMIME("application/json",{name:"javascript",json:!0}),n.defineMIME("application/x-json",{name:"javascript",json:!0}),n.defineMIME("application/manifest+json",{name:"javascript",json:!0}),n.defineMIME("application/ld+json",{name:"javascript",jsonld:!0}),n.defineMIME("text/typescript",{name:"javascript",typescript:!0}),n.defineMIME("application/typescript",{name:"javascript",typescript:!0})})});var m0=Jt((sN,lN)=>{(function(n){typeof sN=="object"&&typeof lN=="object"?n(Cs()):typeof define=="function"&&define.amd?define(["../../lib/codemirror"],n):n(CodeMirror)})(function(n){"use strict";function e(a,o,l,c){if(l&&l.call){var d=l;l=null}else var d=i(a,l,"rangeFinder");typeof o=="number"&&(o=n.Pos(o,0));var p=i(a,l,"minFoldSize");function m(x){var C=d(a,o);if(!C||C.to.line-C.from.line<p)return null;for(var T=a.findMarksAt(C.from),I=0;I<T.length;++I)if(T[I].__isFold&&c!=="fold"){if(!x)return null;C.cleared=!0,T[I].clear()}return C}var g=m(!0);if(i(a,l,"scanUp"))for(;!g&&o.line>a.firstLine();)o=n.Pos(o.line-1,0),g=m(!1);if(!(!g||g.cleared||c==="unfold")){var v=t(a,l,g);n.on(v,"mousedown",function(x){b.clear(),n.e_preventDefault(x)});var b=a.markText(g.from,g.to,{replacedWith:v,clearOnEnter:i(a,l,"clearOnEnter"),__isFold:!0});b.on("clear",function(x,C){n.signal(a,"unfold",a,x,C)}),n.signal(a,"fold",a,g.from,g.to)}}function t(a,o,l){var c=i(a,o,"widget");if(typeof c=="function"&&(c=c(l.from,l.to)),typeof c=="string"){var d=document.createTextNode(c);c=document.createElement("span"),c.appendChild(d),c.className="CodeMirror-foldmarker"}else c&&(c=c.cloneNode(!0));return c}n.newFoldFunction=function(a,o){return function(l,c){e(l,c,{rangeFinder:a,widget:o})}},n.defineExtension("foldCode",function(a,o,l){e(this,a,o,l)}),n.defineExtension("isFolded",function(a){for(var o=this.findMarksAt(a),l=0;l<o.length;++l)if(o[l].__isFold)return!0}),n.commands.toggleFold=function(a){a.foldCode(a.getCursor())},n.commands.fold=function(a){a.foldCode(a.getCursor(),null,"fold")},n.commands.unfold=function(a){a.foldCode(a.getCursor(),null,"unfold")},n.commands.foldAll=function(a){a.operation(function(){for(var o=a.firstLine(),l=a.lastLine();o<=l;o++)a.foldCode(n.Pos(o,0),null,"fold")})},n.commands.unfoldAll=function(a){a.operation(function(){for(var o=a.firstLine(),l=a.lastLine();o<=l;o++)a.foldCode(n.Pos(o,0),null,"unfold")})},n.registerHelper("fold","combine",function(){var a=Array.prototype.slice.call(arguments,0);return function(o,l){for(var c=0;c<a.length;++c){var d=a[c](o,l);if(d)return d}}}),n.registerHelper("fold","auto",function(a,o){for(var l=a.getHelpers(o,"fold"),c=0;c<l.length;c++){var d=l[c](a,o);if(d)return d}});var r={rangeFinder:n.fold.auto,widget:"\u2194",minFoldSize:0,scanUp:!1,clearOnEnter:!0};n.defineOption("foldOptions",null);function i(a,o,l){if(o&&o[l]!==void 0)return o[l];var c=a.options.foldOptions;return c&&c[l]!==void 0?c[l]:r[l]}n.defineExtension("foldOption",function(a,o){return i(this,a,o)})})});var dN=Jt((cN,uN)=>{(function(n){typeof cN=="object"&&typeof uN=="object"?n(Cs(),m0()):typeof define=="function"&&define.amd?define(["../../lib/codemirror","./foldcode"],n):n(CodeMirror)})(function(n){"use strict";n.defineOption("foldGutter",!1,function(v,b,x){x&&x!=n.Init&&(v.clearGutter(v.state.foldGutter.options.gutter),v.state.foldGutter=null,v.off("gutterClick",d),v.off("changes",p),v.off("viewportChange",m),v.off("fold",g),v.off("unfold",g),v.off("swapDoc",p)),b&&(v.state.foldGutter=new t(r(b)),c(v),v.on("gutterClick",d),v.on("changes",p),v.on("viewportChange",m),v.on("fold",g),v.on("unfold",g),v.on("swapDoc",p))});var e=n.Pos;function t(v){this.options=v,this.from=this.to=0}function r(v){return v===!0&&(v={}),v.gutter==null&&(v.gutter="CodeMirror-foldgutter"),v.indicatorOpen==null&&(v.indicatorOpen="CodeMirror-foldgutter-open"),v.indicatorFolded==null&&(v.indicatorFolded="CodeMirror-foldgutter-folded"),v}function i(v,b){for(var x=v.findMarks(e(b,0),e(b+1,0)),C=0;C<x.length;++C)if(x[C].__isFold){var T=x[C].find(-1);if(T&&T.line===b)return x[C]}}function a(v){if(typeof v=="string"){var b=document.createElement("div");return b.className=v+" CodeMirror-guttermarker-subtle",b}else return v.cloneNode(!0)}function o(v,b,x){var C=v.state.foldGutter.options,T=b-1,I=v.foldOption(C,"minFoldSize"),P=v.foldOption(C,"rangeFinder"),M=typeof C.indicatorFolded=="string"&&l(C.indicatorFolded),D=typeof C.indicatorOpen=="string"&&l(C.indicatorOpen);v.eachLine(b,x,function(E){++T;var V=null,O=E.gutterMarkers;if(O&&(O=O[C.gutter]),i(v,T)){if(M&&O&&M.test(O.className))return;V=a(C.indicatorFolded)}else{var B=e(T,0),z=P&&P(v,B);if(z&&z.to.line-z.from.line>=I){if(D&&O&&D.test(O.className))return;V=a(C.indicatorOpen)}}!V&&!O||v.setGutterMarker(E,C.gutter,V)})}function l(v){return new RegExp("(^|\\s)"+v+"(?:$|\\s)\\s*")}function c(v){var b=v.getViewport(),x=v.state.foldGutter;!x||(v.operation(function(){o(v,b.from,b.to)}),x.from=b.from,x.to=b.to)}function d(v,b,x){var C=v.state.foldGutter;if(!!C){var T=C.options;if(x==T.gutter){var I=i(v,b);I?I.clear():v.foldCode(e(b,0),T)}}}function p(v){var b=v.state.foldGutter;if(!!b){var x=b.options;b.from=b.to=0,clearTimeout(b.changeUpdate),b.changeUpdate=setTimeout(function(){c(v)},x.foldOnChangeTimeSpan||600)}}function m(v){var b=v.state.foldGutter;if(!!b){var x=b.options;clearTimeout(b.changeUpdate),b.changeUpdate=setTimeout(function(){var C=v.getViewport();b.from==b.to||C.from-b.to>20||b.from-C.to>20?c(v):v.operation(function(){C.from<b.from&&(o(v,C.from,b.from),b.from=C.from),C.to>b.to&&(o(v,b.to,C.to),b.to=C.to)})},x.updateViewportTimeSpan||400)}}function g(v,b){var x=v.state.foldGutter;if(!!x){var C=b.line;C>=x.from&&C<x.to&&o(v,C,C+1)}}})});var hN=Jt((pN,fN)=>{(function(n){typeof pN=="object"&&typeof fN=="object"?n(Cs()):typeof define=="function"&&define.amd?define(["../../lib/codemirror"],n):n(CodeMirror)})(function(n){"use strict";n.registerHelper("fold","brace",function(e,t){var r=t.line,i=e.getLine(r),a;function o(D){for(var E=t.ch,V=0;;){var O=E<=0?-1:i.lastIndexOf(D,E-1);if(O==-1){if(V==1)break;V=1,E=i.length;continue}if(V==1&&O<t.ch)break;if(a=e.getTokenTypeAt(n.Pos(r,O+1)),!/^(comment|string)/.test(a))return O+1;E=O-1}}var l=o("{"),c=o("["),d,p,m;if(l!=null&&(c==null||c>l))m=l,d="{",p="}";else if(c!=null)m=c,d="[",p="]";else return;var g=1,v=e.lastLine(),b,x;e:for(var C=r;C<=v;++C)for(var T=e.getLine(C),I=C==r?m:0;;){var P=T.indexOf(d,I),M=T.indexOf(p,I);if(P<0&&(P=T.length),M<0&&(M=T.length),I=Math.min(P,M),I==T.length)break;if(e.getTokenTypeAt(n.Pos(C,I+1))==a){if(I==P)++g;else if(!--g){b=C,x=I;break e}}++I}if(!(b==null||r==b))return{from:n.Pos(r,m),to:n.Pos(b,x)}}),n.registerHelper("fold","import",function(e,t){function r(d){if(d<e.firstLine()||d>e.lastLine())return null;var p=e.getTokenAt(n.Pos(d,1));if(/\S/.test(p.string)||(p=e.getTokenAt(n.Pos(d,p.end+1))),p.type!="keyword"||p.string!="import")return null;for(var m=d,g=Math.min(e.lastLine(),d+10);m<=g;++m){var v=e.getLine(m),b=v.indexOf(";");if(b!=-1)return{startCh:p.end,end:n.Pos(m,b)}}}var i=t.line,a=r(i),o;if(!a||r(i-1)||(o=r(i-2))&&o.end.line==i-1)return null;for(var l=a.end;;){var c=r(l.line+1);if(c==null)break;l=c.end}return{from:e.clipPos(n.Pos(i,a.startCh+1)),to:l}}),n.registerHelper("fold","include",function(e,t){function r(c){if(c<e.firstLine()||c>e.lastLine())return null;var d=e.getTokenAt(n.Pos(c,1));if(/\S/.test(d.string)||(d=e.getTokenAt(n.Pos(c,d.end+1))),d.type=="meta"&&d.string.slice(0,8)=="#include")return d.start+8}var i=t.line,a=r(i);if(a==null||r(i-1)!=null)return null;for(var o=i;;){var l=r(o+1);if(l==null)break;++o}return{from:n.Pos(i,a+1),to:e.clipPos(n.Pos(o))}})})});function Vf(n,e){let t=n.length,r=0;for(let i=0;i<t;++i)e(n[i],i,n)&&(n[r]=n[i],++r);n.length=r}function PL(n,e){if(n.length===e)return n;let t=new n.constructor(e);return t.set(n),t}function rd(n,e,t,r){let i=n.length/e,a=n.length*t*r,o=new n.constructor(a),l=n.length*r,c=e,d=e*r;for(let p=0;p<i;++p)for(let m=0;m<e;++m){let g=n[p*e+m],v=p*d+m;for(let b=0;b<t;++b)for(let x=0;x<r;++x)o[b*l+x*c+v]=g}return o}function IL(n,e,t,r=0,i=n.length){for(;r<i;){let a=r+i-1>>1,o=t(e,n[a]);if(o>0)r=a+1;else if(o<0)i=a;else return a}return~r}function AL(n,e,t){let r=e-n;for(;r>0;){let i=Math.floor(r/2),a=n+i;t(a)?r=i:(n=a+1,r-=i+1)}return n}function ML(n,e){let t=[];for(let r=0,i=n.length;r<i;++r)n[r]===e&&t.push(r);return t}function xe(n,e){let t=n.length;if(e.length!==t)return!1;for(let r=0;r<t;++r)if(n[r]!==e[r])return!1;return!0}function id(n,e,t=(r,i)=>r===i){let r=n.length;if(e.length!==r)return!1;for(let i=0;i<r;++i)if(!t(n[i],e[i]))return!1;return!0}function RL(n,e,t){let r=[];if(t===e){for(let i=0;i<n;++i)r[i]=i;return r}r[t]=e;for(let i=0,a=0;i<n;){if(i===e){++i;continue}a===t&&++a,r[a++]=i++}return r}function cv(n,e,t){for(let r=0,i=t.length;r<i;++r){let a=t[r];a!==-1&&(n[r]=e[a])}return n}function Mr(n){let e=[];for(let t=0,r=n.length;t<r;++t){let i=n[t];for(let a=0,o=i.length;a<o;++a){let l=e[a];l===void 0&&(l=e[a]=[]),l.push(i[a])}}return e}function _L(n,e){let t=[],r=0;for(let a=0,o=e.length;a<o;++a){let{retainCount:l,deleteCount:c,insertCount:d}=e[a];l!==0&&(t.push(n.slice(r,r+l)),r+=l),r+=c,d!==0&&t.push(new Array(d))}let i=n.length;return r!==i&&t.push(n.slice(r)),new Array(0).concat(...t)}function VL(n,e,t){let r=[],i=0,a=0,o=n.length,l=e.length;for(;i<o&&a<l;){let c,d=n[i],p=e[a];if(c=t(d,p),c===0){let m=1;for(++i,++a;i<o&&a<l&&(c=t(n[i],e[a]))===0;)++m,++i,++a;r.push({retainCount:m,deleteCount:0,insertCount:0});continue}if(c<0){let m=1;for(;++i<o&&(c=t(n[i],p))<0;)++m;r.push({retainCount:0,deleteCount:m,insertCount:0});continue}if(c>0){let m=1;for(;++a<l&&(c=t(d,e[a]))>0;)++m;r.push({retainCount:0,deleteCount:0,insertCount:m});continue}}return(i<o||a<l)&&r.push({retainCount:0,deleteCount:o-i,insertCount:l-a}),r}function OL(n,e,t,r,i,a){let o=0,l=0;if(n!==0&&e!==0)for(;;){let c=t(o,l);if(c<0){if(r(o),++o===n)break}else if(c>0){if(i(l),++l===e)break}else if(a(o,l),++o,++l,o===n||l===e)break}for(;o<n;)r(o),++o;for(;l<e;)i(l),++l}var mk=ot(Et());var bF=!1;function hk(n){typeof n=="object"?n.dispose():n()}function Ya(n){for(let e=n.length;e>0;--e)hk(n[e-1])}function En(n,e,t,r){return n.addEventListener(e,t,r),()=>n.removeEventListener(e,t,r)}var j=class{constructor(){this.refCount=1}addRef(){return++this.refCount,this}dispose(){if(bF){if(this.refCount===0)debugger;(this.disposedStacks=this.disposedStacks||[]).push(new Error().stack)}--this.refCount==0&&this.refCountReachedZero()}refCountReachedZero(){this.disposed();let{disposers:e}=this;e!==void 0&&(Ya(e),this.disposers=void 0),this.wasDisposed=!0}disposed(){}registerDisposer(e){let{disposers:t}=this;return t==null?this.disposers=[e]:t.push(e),e}unregisterDisposer(e){let{disposers:t}=this;if(t!=null){let r=t.indexOf(e);r!==-1&&t.splice(r,1)}return e}registerEventListener(e,t,r,i){this.registerDisposer(En(e,t,r,i))}registerCancellable(e){return this.registerDisposer(()=>{e.cancel()}),e}},od=class extends j{constructor(e){super();this.value=e}};function Nf(n){return()=>{if(n!==void 0){let e=n;n=void 0,hk(e)}}}var ze=class{constructor(){this.handlers=new Set;this.count=0;let e=this;this.dispatch=function(){++e.count,e.handlers.forEach(t=>{t.apply(this,arguments)})}}add(e){return this.handlers.add(e),()=>this.remove(e)}remove(e){return this.handlers.delete(e)}dispose(){this.handlers=void 0}};var re=class extends ze{},Bf={count:0,add(n){return()=>{}},remove(n){return!1}};var Ee=class{constructor(e){this.value_=e;this.changed=new re}get value(){return this.value_}set value(e){e!==this.value_&&(this.value_=e,this.changed.dispatch())}},Le=class extends Ee{constructor(e,t,r=e){super(e);this.validator=t;this.defaultValue=r}toJSON(){let{value_:e}=this;if(e!==this.defaultValue)return this.value_}reset(){this.value=this.defaultValue}restoreState(e){if(e!==void 0){let{validator:t}=this;try{this.value=t(e);return}catch(r){}}this.value=this.defaultValue}},fv=class extends j{constructor(e,t){super();this.changed=new re;this.f=e,this.ws=t;for(let r of t)this.registerDisposer(r.changed.add(this.changed.dispatch))}get value(){return this.f(...this.ws.map(e=>e.value))}};function hv(n,...e){return new fv(n,e)}var gk=class extends j{constructor(e,t){super();this.changed=new re;this.valueGeneration=-1;this.f=e,this.ws=t;for(let r of t)this.registerDisposer(r.changed.add(this.changed.dispatch))}get value(){let e=this.changed.count;return e!==this.valueGeneration&&(this.value_=this.f(...this.ws.map(t=>t.value)),this.valueGeneration=e),this.value_}};function mn(n,...e){return new gk(n,e)}var Uf=class extends j{constructor(e,t=(r,i)=>r===i){super();this.changed=new ze;this.value=e.value,this.registerDisposer(e.changed.add(()=>{let r=e.value;t(this.value,r)||(this.value=r,this.changed.dispatch())}))}};function At(n,e,t){let r=new fv(n,e),i=new Uf(r,t);return i.registerDisposer(r),i}var sd=class extends j{constructor(e){super();this.changed=new re;let t=e(this),r=Object.keys(t),i=()=>{let a=Array.isArray(t)?[]:{};for(let o of r)a[o]=t[o].value;this.value=a,this.changed.dispatch()};i();for(let a of r){let o=t[a];this.registerDisposer(o.changed.add(()=>i()))}}};var vc=class{constructor(e){this.changed=new ze;e===void 0?this.values=new Set:this.values=new Set(e)}add(e){let{values:t}=this;return t.has(e)||(t.add(e),this.changed.dispatch(e,!0)),this}delete(e){let{values:t}=this;return t.delete(e)?(this.changed.dispatch(e,!1),!0):!1}has(e){return this.values.has(e)}get size(){return this.values.size}[Symbol.iterator](){return this.values[Symbol.iterator]()}clear(){let{values:e}=this;e.size>0&&(e.clear(),this.changed.dispatch(null,!1))}};function Dn(n,...e){let t=e.map(c=>c.value),r=e.length,i=new j,a=n(i,...t),o=(0,mk.default)(()=>{let c=!1;for(let d=0;d<r;++d){let m=e[d].value;t[d]!==m&&(t[d]=m,c=!0)}!c||(i.dispose(),i=new j,a=n(i,...t))},0),l=e.map(c=>c.changed.add(o));return{flush(){o.flush()},dispose(){o.cancel(),Ya(l),i.dispose()},get value(){return o.flush(),a}}}function Ka(n,...e){let t=e.map(c=>c.value),r=e.length,i=new j,a=n(i,...t),o=()=>{let c=!1;for(let d=0;d<r;++d){let m=e[d].value;t[d]!==m&&(t[d]=m,c=!0)}!c||(i.dispose(),i=new j,a=n(i,...t))},l=e.map(c=>c.changed.add(o));return{dispose(){Ya(l),i.dispose()},get value(){return a}}}function Rr(n){return{changed:Bf,value:n}}function _r(n,e){return n(e.value),e.changed.add(()=>n(e.value))}var Sc=class{constructor(e,t){this.outer=e;this.getInner=t;this.changed=new re;this.update=()=>{let{disposer:e,outer:t}=this;e!==void 0&&e();let r=this.inner=this.getInner(t.value);this.disposer=r.changed.add(this.changed.dispatch),this.changed.dispatch()};e.changed.add(this.update),this.update()}dispose(){this.outer.changed.remove(this.update),this.disposer()}get value(){return this.inner.value}set value(e){this.inner.value=e}},Uo=class extends Sc{reset(){this.inner.reset()}restoreState(e){this.inner.restoreState(e)}toJSON(){return this.inner.toJSON()}};var Ff=new Float32Array(1);function yk(n){Ff[0]=n,n=Ff[0];for(let e=1;e<21;++e){let t=n.toPrecision(e);if(Ff[0]=parseFloat(t),Ff[0]===n)return t}return n.toString()}var je=1e-6,vt=typeof Float32Array!="undefined"?Float32Array:Array,Vr=Math.random;var r8=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var n=0,e=arguments.length;e--;)n+=arguments[e]*arguments[e];return Math.sqrt(n)});var Dt={};yc(Dt,{add:()=>zF,adjoint:()=>PF,clone:()=>CF,copy:()=>wF,create:()=>mv,determinant:()=>IF,equals:()=>JF,exactEquals:()=>jF,frob:()=>WF,fromMat2d:()=>NF,fromMat4:()=>xF,fromQuat:()=>BF,fromRotation:()=>VF,fromScaling:()=>OF,fromTranslation:()=>_F,fromValues:()=>TF,identity:()=>kF,invert:()=>DF,mul:()=>qF,multiply:()=>vk,multiplyScalar:()=>HF,multiplyScalarAndAdd:()=>$F,normalFromMat4:()=>UF,projection:()=>FF,rotate:()=>MF,scale:()=>RF,set:()=>LF,str:()=>GF,sub:()=>YF,subtract:()=>Sk,translate:()=>AF,transpose:()=>EF});function mv(){var n=new vt(9);return vt!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[5]=0,n[6]=0,n[7]=0),n[0]=1,n[4]=1,n[8]=1,n}function xF(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[4],n[4]=e[5],n[5]=e[6],n[6]=e[8],n[7]=e[9],n[8]=e[10],n}function CF(n){var e=new vt(9);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],e}function wF(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[8]=e[8],n}function TF(n,e,t,r,i,a,o,l,c){var d=new vt(9);return d[0]=n,d[1]=e,d[2]=t,d[3]=r,d[4]=i,d[5]=a,d[6]=o,d[7]=l,d[8]=c,d}function LF(n,e,t,r,i,a,o,l,c,d){return n[0]=e,n[1]=t,n[2]=r,n[3]=i,n[4]=a,n[5]=o,n[6]=l,n[7]=c,n[8]=d,n}function kF(n){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=1,n[5]=0,n[6]=0,n[7]=0,n[8]=1,n}function EF(n,e){if(n===e){var t=e[1],r=e[2],i=e[5];n[1]=e[3],n[2]=e[6],n[3]=t,n[5]=e[7],n[6]=r,n[7]=i}else n[0]=e[0],n[1]=e[3],n[2]=e[6],n[3]=e[1],n[4]=e[4],n[5]=e[7],n[6]=e[2],n[7]=e[5],n[8]=e[8];return n}function DF(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8],m=p*o-l*d,g=-p*a+l*c,v=d*a-o*c,b=t*m+r*g+i*v;return b?(b=1/b,n[0]=m*b,n[1]=(-p*r+i*d)*b,n[2]=(l*r-i*o)*b,n[3]=g*b,n[4]=(p*t-i*c)*b,n[5]=(-l*t+i*a)*b,n[6]=v*b,n[7]=(-d*t+r*c)*b,n[8]=(o*t-r*a)*b,n):null}function PF(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8];return n[0]=o*p-l*d,n[1]=i*d-r*p,n[2]=r*l-i*o,n[3]=l*c-a*p,n[4]=t*p-i*c,n[5]=i*a-t*l,n[6]=a*d-o*c,n[7]=r*c-t*d,n[8]=t*o-r*a,n}function IF(n){var e=n[0],t=n[1],r=n[2],i=n[3],a=n[4],o=n[5],l=n[6],c=n[7],d=n[8];return e*(d*a-o*c)+t*(-d*i+o*l)+r*(c*i-a*l)}function vk(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=e[4],c=e[5],d=e[6],p=e[7],m=e[8],g=t[0],v=t[1],b=t[2],x=t[3],C=t[4],T=t[5],I=t[6],P=t[7],M=t[8];return n[0]=g*r+v*o+b*d,n[1]=g*i+v*l+b*p,n[2]=g*a+v*c+b*m,n[3]=x*r+C*o+T*d,n[4]=x*i+C*l+T*p,n[5]=x*a+C*c+T*m,n[6]=I*r+P*o+M*d,n[7]=I*i+P*l+M*p,n[8]=I*a+P*c+M*m,n}function AF(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=e[4],c=e[5],d=e[6],p=e[7],m=e[8],g=t[0],v=t[1];return n[0]=r,n[1]=i,n[2]=a,n[3]=o,n[4]=l,n[5]=c,n[6]=g*r+v*o+d,n[7]=g*i+v*l+p,n[8]=g*a+v*c+m,n}function MF(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=e[4],c=e[5],d=e[6],p=e[7],m=e[8],g=Math.sin(t),v=Math.cos(t);return n[0]=v*r+g*o,n[1]=v*i+g*l,n[2]=v*a+g*c,n[3]=v*o-g*r,n[4]=v*l-g*i,n[5]=v*c-g*a,n[6]=d,n[7]=p,n[8]=m,n}function RF(n,e,t){var r=t[0],i=t[1];return n[0]=r*e[0],n[1]=r*e[1],n[2]=r*e[2],n[3]=i*e[3],n[4]=i*e[4],n[5]=i*e[5],n[6]=e[6],n[7]=e[7],n[8]=e[8],n}function _F(n,e){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=1,n[5]=0,n[6]=e[0],n[7]=e[1],n[8]=1,n}function VF(n,e){var t=Math.sin(e),r=Math.cos(e);return n[0]=r,n[1]=t,n[2]=0,n[3]=-t,n[4]=r,n[5]=0,n[6]=0,n[7]=0,n[8]=1,n}function OF(n,e){return n[0]=e[0],n[1]=0,n[2]=0,n[3]=0,n[4]=e[1],n[5]=0,n[6]=0,n[7]=0,n[8]=1,n}function NF(n,e){return n[0]=e[0],n[1]=e[1],n[2]=0,n[3]=e[2],n[4]=e[3],n[5]=0,n[6]=e[4],n[7]=e[5],n[8]=1,n}function BF(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=t+t,l=r+r,c=i+i,d=t*o,p=r*o,m=r*l,g=i*o,v=i*l,b=i*c,x=a*o,C=a*l,T=a*c;return n[0]=1-m-b,n[3]=p-T,n[6]=g+C,n[1]=p+T,n[4]=1-d-b,n[7]=v-x,n[2]=g-C,n[5]=v+x,n[8]=1-d-m,n}function UF(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8],m=e[9],g=e[10],v=e[11],b=e[12],x=e[13],C=e[14],T=e[15],I=t*l-r*o,P=t*c-i*o,M=t*d-a*o,D=r*c-i*l,E=r*d-a*l,V=i*d-a*c,O=p*x-m*b,B=p*C-g*b,z=p*T-v*b,_=m*C-g*x,U=m*T-v*x,N=g*T-v*C,J=I*N-P*U+M*_+D*z-E*B+V*O;return J?(J=1/J,n[0]=(l*N-c*U+d*_)*J,n[1]=(c*z-o*N-d*B)*J,n[2]=(o*U-l*z+d*O)*J,n[3]=(i*U-r*N-a*_)*J,n[4]=(t*N-i*z+a*B)*J,n[5]=(r*z-t*U-a*O)*J,n[6]=(x*V-C*E+T*D)*J,n[7]=(C*M-b*V-T*P)*J,n[8]=(b*E-x*M+T*I)*J,n):null}function FF(n,e,t){return n[0]=2/e,n[1]=0,n[2]=0,n[3]=0,n[4]=-2/t,n[5]=0,n[6]=-1,n[7]=1,n[8]=1,n}function GF(n){return"mat3("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+", "+n[4]+", "+n[5]+", "+n[6]+", "+n[7]+", "+n[8]+")"}function WF(n){return Math.hypot(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8])}function zF(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n[3]=e[3]+t[3],n[4]=e[4]+t[4],n[5]=e[5]+t[5],n[6]=e[6]+t[6],n[7]=e[7]+t[7],n[8]=e[8]+t[8],n}function Sk(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n[3]=e[3]-t[3],n[4]=e[4]-t[4],n[5]=e[5]-t[5],n[6]=e[6]-t[6],n[7]=e[7]-t[7],n[8]=e[8]-t[8],n}function HF(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n[3]=e[3]*t,n[4]=e[4]*t,n[5]=e[5]*t,n[6]=e[6]*t,n[7]=e[7]*t,n[8]=e[8]*t,n}function $F(n,e,t,r){return n[0]=e[0]+t[0]*r,n[1]=e[1]+t[1]*r,n[2]=e[2]+t[2]*r,n[3]=e[3]+t[3]*r,n[4]=e[4]+t[4]*r,n[5]=e[5]+t[5]*r,n[6]=e[6]+t[6]*r,n[7]=e[7]+t[7]*r,n[8]=e[8]+t[8]*r,n}function jF(n,e){return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]&&n[4]===e[4]&&n[5]===e[5]&&n[6]===e[6]&&n[7]===e[7]&&n[8]===e[8]}function JF(n,e){var t=n[0],r=n[1],i=n[2],a=n[3],o=n[4],l=n[5],c=n[6],d=n[7],p=n[8],m=e[0],g=e[1],v=e[2],b=e[3],x=e[4],C=e[5],T=e[6],I=e[7],P=e[8];return Math.abs(t-m)<=je*Math.max(1,Math.abs(t),Math.abs(m))&&Math.abs(r-g)<=je*Math.max(1,Math.abs(r),Math.abs(g))&&Math.abs(i-v)<=je*Math.max(1,Math.abs(i),Math.abs(v))&&Math.abs(a-b)<=je*Math.max(1,Math.abs(a),Math.abs(b))&&Math.abs(o-x)<=je*Math.max(1,Math.abs(o),Math.abs(x))&&Math.abs(l-C)<=je*Math.max(1,Math.abs(l),Math.abs(C))&&Math.abs(c-T)<=je*Math.max(1,Math.abs(c),Math.abs(T))&&Math.abs(d-I)<=je*Math.max(1,Math.abs(d),Math.abs(I))&&Math.abs(p-P)<=je*Math.max(1,Math.abs(p),Math.abs(P))}var qF=vk,YF=Sk;var ae={};yc(ae,{add:()=>A3,adjoint:()=>r3,clone:()=>XF,copy:()=>QF,create:()=>KF,determinant:()=>i3,equals:()=>V3,exactEquals:()=>_3,frob:()=>I3,fromQuat:()=>C3,fromQuat2:()=>y3,fromRotation:()=>f3,fromRotationTranslation:()=>Ck,fromRotationTranslationScale:()=>b3,fromRotationTranslationScaleOrigin:()=>x3,fromScaling:()=>p3,fromTranslation:()=>d3,fromValues:()=>ZF,fromXRotation:()=>h3,fromYRotation:()=>m3,fromZRotation:()=>g3,frustum:()=>w3,getRotation:()=>S3,getScaling:()=>wk,getTranslation:()=>v3,identity:()=>bk,invert:()=>n3,lookAt:()=>E3,mul:()=>O3,multiply:()=>xk,multiplyScalar:()=>M3,multiplyScalarAndAdd:()=>R3,ortho:()=>k3,perspective:()=>T3,perspectiveFromFieldOfView:()=>L3,rotate:()=>s3,rotateX:()=>l3,rotateY:()=>c3,rotateZ:()=>u3,scale:()=>o3,set:()=>e3,str:()=>P3,sub:()=>N3,subtract:()=>Tk,targetTo:()=>D3,translate:()=>a3,transpose:()=>t3});function KF(){var n=new vt(16);return vt!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=0,n[12]=0,n[13]=0,n[14]=0),n[0]=1,n[5]=1,n[10]=1,n[15]=1,n}function XF(n){var e=new vt(16);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],e[9]=n[9],e[10]=n[10],e[11]=n[11],e[12]=n[12],e[13]=n[13],e[14]=n[14],e[15]=n[15],e}function QF(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[8]=e[8],n[9]=e[9],n[10]=e[10],n[11]=e[11],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15],n}function ZF(n,e,t,r,i,a,o,l,c,d,p,m,g,v,b,x){var C=new vt(16);return C[0]=n,C[1]=e,C[2]=t,C[3]=r,C[4]=i,C[5]=a,C[6]=o,C[7]=l,C[8]=c,C[9]=d,C[10]=p,C[11]=m,C[12]=g,C[13]=v,C[14]=b,C[15]=x,C}function e3(n,e,t,r,i,a,o,l,c,d,p,m,g,v,b,x,C){return n[0]=e,n[1]=t,n[2]=r,n[3]=i,n[4]=a,n[5]=o,n[6]=l,n[7]=c,n[8]=d,n[9]=p,n[10]=m,n[11]=g,n[12]=v,n[13]=b,n[14]=x,n[15]=C,n}function bk(n){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function t3(n,e){if(n===e){var t=e[1],r=e[2],i=e[3],a=e[6],o=e[7],l=e[11];n[1]=e[4],n[2]=e[8],n[3]=e[12],n[4]=t,n[6]=e[9],n[7]=e[13],n[8]=r,n[9]=a,n[11]=e[14],n[12]=i,n[13]=o,n[14]=l}else n[0]=e[0],n[1]=e[4],n[2]=e[8],n[3]=e[12],n[4]=e[1],n[5]=e[5],n[6]=e[9],n[7]=e[13],n[8]=e[2],n[9]=e[6],n[10]=e[10],n[11]=e[14],n[12]=e[3],n[13]=e[7],n[14]=e[11],n[15]=e[15];return n}function n3(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8],m=e[9],g=e[10],v=e[11],b=e[12],x=e[13],C=e[14],T=e[15],I=t*l-r*o,P=t*c-i*o,M=t*d-a*o,D=r*c-i*l,E=r*d-a*l,V=i*d-a*c,O=p*x-m*b,B=p*C-g*b,z=p*T-v*b,_=m*C-g*x,U=m*T-v*x,N=g*T-v*C,J=I*N-P*U+M*_+D*z-E*B+V*O;return J?(J=1/J,n[0]=(l*N-c*U+d*_)*J,n[1]=(i*U-r*N-a*_)*J,n[2]=(x*V-C*E+T*D)*J,n[3]=(g*E-m*V-v*D)*J,n[4]=(c*z-o*N-d*B)*J,n[5]=(t*N-i*z+a*B)*J,n[6]=(C*M-b*V-T*P)*J,n[7]=(p*V-g*M+v*P)*J,n[8]=(o*U-l*z+d*O)*J,n[9]=(r*z-t*U-a*O)*J,n[10]=(b*E-x*M+T*I)*J,n[11]=(m*M-p*E-v*I)*J,n[12]=(l*B-o*_-c*O)*J,n[13]=(t*_-r*B+i*O)*J,n[14]=(x*P-b*D-C*I)*J,n[15]=(p*D-m*P+g*I)*J,n):null}function r3(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8],m=e[9],g=e[10],v=e[11],b=e[12],x=e[13],C=e[14],T=e[15];return n[0]=l*(g*T-v*C)-m*(c*T-d*C)+x*(c*v-d*g),n[1]=-(r*(g*T-v*C)-m*(i*T-a*C)+x*(i*v-a*g)),n[2]=r*(c*T-d*C)-l*(i*T-a*C)+x*(i*d-a*c),n[3]=-(r*(c*v-d*g)-l*(i*v-a*g)+m*(i*d-a*c)),n[4]=-(o*(g*T-v*C)-p*(c*T-d*C)+b*(c*v-d*g)),n[5]=t*(g*T-v*C)-p*(i*T-a*C)+b*(i*v-a*g),n[6]=-(t*(c*T-d*C)-o*(i*T-a*C)+b*(i*d-a*c)),n[7]=t*(c*v-d*g)-o*(i*v-a*g)+p*(i*d-a*c),n[8]=o*(m*T-v*x)-p*(l*T-d*x)+b*(l*v-d*m),n[9]=-(t*(m*T-v*x)-p*(r*T-a*x)+b*(r*v-a*m)),n[10]=t*(l*T-d*x)-o*(r*T-a*x)+b*(r*d-a*l),n[11]=-(t*(l*v-d*m)-o*(r*v-a*m)+p*(r*d-a*l)),n[12]=-(o*(m*C-g*x)-p*(l*C-c*x)+b*(l*g-c*m)),n[13]=t*(m*C-g*x)-p*(r*C-i*x)+b*(r*g-i*m),n[14]=-(t*(l*C-c*x)-o*(r*C-i*x)+b*(r*c-i*l)),n[15]=t*(l*g-c*m)-o*(r*g-i*m)+p*(r*c-i*l),n}function i3(n){var e=n[0],t=n[1],r=n[2],i=n[3],a=n[4],o=n[5],l=n[6],c=n[7],d=n[8],p=n[9],m=n[10],g=n[11],v=n[12],b=n[13],x=n[14],C=n[15],T=e*o-t*a,I=e*l-r*a,P=e*c-i*a,M=t*l-r*o,D=t*c-i*o,E=r*c-i*l,V=d*b-p*v,O=d*x-m*v,B=d*C-g*v,z=p*x-m*b,_=p*C-g*b,U=m*C-g*x;return T*U-I*_+P*z+M*B-D*O+E*V}function xk(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=e[4],c=e[5],d=e[6],p=e[7],m=e[8],g=e[9],v=e[10],b=e[11],x=e[12],C=e[13],T=e[14],I=e[15],P=t[0],M=t[1],D=t[2],E=t[3];return n[0]=P*r+M*l+D*m+E*x,n[1]=P*i+M*c+D*g+E*C,n[2]=P*a+M*d+D*v+E*T,n[3]=P*o+M*p+D*b+E*I,P=t[4],M=t[5],D=t[6],E=t[7],n[4]=P*r+M*l+D*m+E*x,n[5]=P*i+M*c+D*g+E*C,n[6]=P*a+M*d+D*v+E*T,n[7]=P*o+M*p+D*b+E*I,P=t[8],M=t[9],D=t[10],E=t[11],n[8]=P*r+M*l+D*m+E*x,n[9]=P*i+M*c+D*g+E*C,n[10]=P*a+M*d+D*v+E*T,n[11]=P*o+M*p+D*b+E*I,P=t[12],M=t[13],D=t[14],E=t[15],n[12]=P*r+M*l+D*m+E*x,n[13]=P*i+M*c+D*g+E*C,n[14]=P*a+M*d+D*v+E*T,n[15]=P*o+M*p+D*b+E*I,n}function a3(n,e,t){var r=t[0],i=t[1],a=t[2],o,l,c,d,p,m,g,v,b,x,C,T;return e===n?(n[12]=e[0]*r+e[4]*i+e[8]*a+e[12],n[13]=e[1]*r+e[5]*i+e[9]*a+e[13],n[14]=e[2]*r+e[6]*i+e[10]*a+e[14],n[15]=e[3]*r+e[7]*i+e[11]*a+e[15]):(o=e[0],l=e[1],c=e[2],d=e[3],p=e[4],m=e[5],g=e[6],v=e[7],b=e[8],x=e[9],C=e[10],T=e[11],n[0]=o,n[1]=l,n[2]=c,n[3]=d,n[4]=p,n[5]=m,n[6]=g,n[7]=v,n[8]=b,n[9]=x,n[10]=C,n[11]=T,n[12]=o*r+p*i+b*a+e[12],n[13]=l*r+m*i+x*a+e[13],n[14]=c*r+g*i+C*a+e[14],n[15]=d*r+v*i+T*a+e[15]),n}function o3(n,e,t){var r=t[0],i=t[1],a=t[2];return n[0]=e[0]*r,n[1]=e[1]*r,n[2]=e[2]*r,n[3]=e[3]*r,n[4]=e[4]*i,n[5]=e[5]*i,n[6]=e[6]*i,n[7]=e[7]*i,n[8]=e[8]*a,n[9]=e[9]*a,n[10]=e[10]*a,n[11]=e[11]*a,n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15],n}function s3(n,e,t,r){var i=r[0],a=r[1],o=r[2],l=Math.hypot(i,a,o),c,d,p,m,g,v,b,x,C,T,I,P,M,D,E,V,O,B,z,_,U,N,J,ie;return l<je?null:(l=1/l,i*=l,a*=l,o*=l,c=Math.sin(t),d=Math.cos(t),p=1-d,m=e[0],g=e[1],v=e[2],b=e[3],x=e[4],C=e[5],T=e[6],I=e[7],P=e[8],M=e[9],D=e[10],E=e[11],V=i*i*p+d,O=a*i*p+o*c,B=o*i*p-a*c,z=i*a*p-o*c,_=a*a*p+d,U=o*a*p+i*c,N=i*o*p+a*c,J=a*o*p-i*c,ie=o*o*p+d,n[0]=m*V+x*O+P*B,n[1]=g*V+C*O+M*B,n[2]=v*V+T*O+D*B,n[3]=b*V+I*O+E*B,n[4]=m*z+x*_+P*U,n[5]=g*z+C*_+M*U,n[6]=v*z+T*_+D*U,n[7]=b*z+I*_+E*U,n[8]=m*N+x*J+P*ie,n[9]=g*N+C*J+M*ie,n[10]=v*N+T*J+D*ie,n[11]=b*N+I*J+E*ie,e!==n&&(n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n)}function l3(n,e,t){var r=Math.sin(t),i=Math.cos(t),a=e[4],o=e[5],l=e[6],c=e[7],d=e[8],p=e[9],m=e[10],g=e[11];return e!==n&&(n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[4]=a*i+d*r,n[5]=o*i+p*r,n[6]=l*i+m*r,n[7]=c*i+g*r,n[8]=d*i-a*r,n[9]=p*i-o*r,n[10]=m*i-l*r,n[11]=g*i-c*r,n}function c3(n,e,t){var r=Math.sin(t),i=Math.cos(t),a=e[0],o=e[1],l=e[2],c=e[3],d=e[8],p=e[9],m=e[10],g=e[11];return e!==n&&(n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[0]=a*i-d*r,n[1]=o*i-p*r,n[2]=l*i-m*r,n[3]=c*i-g*r,n[8]=a*r+d*i,n[9]=o*r+p*i,n[10]=l*r+m*i,n[11]=c*r+g*i,n}function u3(n,e,t){var r=Math.sin(t),i=Math.cos(t),a=e[0],o=e[1],l=e[2],c=e[3],d=e[4],p=e[5],m=e[6],g=e[7];return e!==n&&(n[8]=e[8],n[9]=e[9],n[10]=e[10],n[11]=e[11],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[0]=a*i+d*r,n[1]=o*i+p*r,n[2]=l*i+m*r,n[3]=c*i+g*r,n[4]=d*i-a*r,n[5]=p*i-o*r,n[6]=m*i-l*r,n[7]=g*i-c*r,n}function d3(n,e){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=e[0],n[13]=e[1],n[14]=e[2],n[15]=1,n}function p3(n,e){return n[0]=e[0],n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=e[1],n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=e[2],n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function f3(n,e,t){var r=t[0],i=t[1],a=t[2],o=Math.hypot(r,i,a),l,c,d;return o<je?null:(o=1/o,r*=o,i*=o,a*=o,l=Math.sin(e),c=Math.cos(e),d=1-c,n[0]=r*r*d+c,n[1]=i*r*d+a*l,n[2]=a*r*d-i*l,n[3]=0,n[4]=r*i*d-a*l,n[5]=i*i*d+c,n[6]=a*i*d+r*l,n[7]=0,n[8]=r*a*d+i*l,n[9]=i*a*d-r*l,n[10]=a*a*d+c,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n)}function h3(n,e){var t=Math.sin(e),r=Math.cos(e);return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=r,n[6]=t,n[7]=0,n[8]=0,n[9]=-t,n[10]=r,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function m3(n,e){var t=Math.sin(e),r=Math.cos(e);return n[0]=r,n[1]=0,n[2]=-t,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=t,n[9]=0,n[10]=r,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function g3(n,e){var t=Math.sin(e),r=Math.cos(e);return n[0]=r,n[1]=t,n[2]=0,n[3]=0,n[4]=-t,n[5]=r,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function Ck(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=r+r,c=i+i,d=a+a,p=r*l,m=r*c,g=r*d,v=i*c,b=i*d,x=a*d,C=o*l,T=o*c,I=o*d;return n[0]=1-(v+x),n[1]=m+I,n[2]=g-T,n[3]=0,n[4]=m-I,n[5]=1-(p+x),n[6]=b+C,n[7]=0,n[8]=g+T,n[9]=b-C,n[10]=1-(p+v),n[11]=0,n[12]=t[0],n[13]=t[1],n[14]=t[2],n[15]=1,n}function y3(n,e){var t=new vt(3),r=-e[0],i=-e[1],a=-e[2],o=e[3],l=e[4],c=e[5],d=e[6],p=e[7],m=r*r+i*i+a*a+o*o;return m>0?(t[0]=(l*o+p*r+c*a-d*i)*2/m,t[1]=(c*o+p*i+d*r-l*a)*2/m,t[2]=(d*o+p*a+l*i-c*r)*2/m):(t[0]=(l*o+p*r+c*a-d*i)*2,t[1]=(c*o+p*i+d*r-l*a)*2,t[2]=(d*o+p*a+l*i-c*r)*2),Ck(n,e,t),n}function v3(n,e){return n[0]=e[12],n[1]=e[13],n[2]=e[14],n}function wk(n,e){var t=e[0],r=e[1],i=e[2],a=e[4],o=e[5],l=e[6],c=e[8],d=e[9],p=e[10];return n[0]=Math.hypot(t,r,i),n[1]=Math.hypot(a,o,l),n[2]=Math.hypot(c,d,p),n}function S3(n,e){var t=new vt(3);wk(t,e);var r=1/t[0],i=1/t[1],a=1/t[2],o=e[0]*r,l=e[1]*i,c=e[2]*a,d=e[4]*r,p=e[5]*i,m=e[6]*a,g=e[8]*r,v=e[9]*i,b=e[10]*a,x=o+p+b,C=0;return x>0?(C=Math.sqrt(x+1)*2,n[3]=.25*C,n[0]=(m-v)/C,n[1]=(g-c)/C,n[2]=(l-d)/C):o>p&&o>b?(C=Math.sqrt(1+o-p-b)*2,n[3]=(m-v)/C,n[0]=.25*C,n[1]=(l+d)/C,n[2]=(g+c)/C):p>b?(C=Math.sqrt(1+p-o-b)*2,n[3]=(g-c)/C,n[0]=(l+d)/C,n[1]=.25*C,n[2]=(m+v)/C):(C=Math.sqrt(1+b-o-p)*2,n[3]=(l-d)/C,n[0]=(g+c)/C,n[1]=(m+v)/C,n[2]=.25*C),n}function b3(n,e,t,r){var i=e[0],a=e[1],o=e[2],l=e[3],c=i+i,d=a+a,p=o+o,m=i*c,g=i*d,v=i*p,b=a*d,x=a*p,C=o*p,T=l*c,I=l*d,P=l*p,M=r[0],D=r[1],E=r[2];return n[0]=(1-(b+C))*M,n[1]=(g+P)*M,n[2]=(v-I)*M,n[3]=0,n[4]=(g-P)*D,n[5]=(1-(m+C))*D,n[6]=(x+T)*D,n[7]=0,n[8]=(v+I)*E,n[9]=(x-T)*E,n[10]=(1-(m+b))*E,n[11]=0,n[12]=t[0],n[13]=t[1],n[14]=t[2],n[15]=1,n}function x3(n,e,t,r,i){var a=e[0],o=e[1],l=e[2],c=e[3],d=a+a,p=o+o,m=l+l,g=a*d,v=a*p,b=a*m,x=o*p,C=o*m,T=l*m,I=c*d,P=c*p,M=c*m,D=r[0],E=r[1],V=r[2],O=i[0],B=i[1],z=i[2],_=(1-(x+T))*D,U=(v+M)*D,N=(b-P)*D,J=(v-M)*E,ie=(1-(g+T))*E,pe=(C+I)*E,me=(b+P)*V,Pe=(C-I)*V,le=(1-(g+x))*V;return n[0]=_,n[1]=U,n[2]=N,n[3]=0,n[4]=J,n[5]=ie,n[6]=pe,n[7]=0,n[8]=me,n[9]=Pe,n[10]=le,n[11]=0,n[12]=t[0]+O-(_*O+J*B+me*z),n[13]=t[1]+B-(U*O+ie*B+Pe*z),n[14]=t[2]+z-(N*O+pe*B+le*z),n[15]=1,n}function C3(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=t+t,l=r+r,c=i+i,d=t*o,p=r*o,m=r*l,g=i*o,v=i*l,b=i*c,x=a*o,C=a*l,T=a*c;return n[0]=1-m-b,n[1]=p+T,n[2]=g-C,n[3]=0,n[4]=p-T,n[5]=1-d-b,n[6]=v+x,n[7]=0,n[8]=g+C,n[9]=v-x,n[10]=1-d-m,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function w3(n,e,t,r,i,a,o){var l=1/(t-e),c=1/(i-r),d=1/(a-o);return n[0]=a*2*l,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=a*2*c,n[6]=0,n[7]=0,n[8]=(t+e)*l,n[9]=(i+r)*c,n[10]=(o+a)*d,n[11]=-1,n[12]=0,n[13]=0,n[14]=o*a*2*d,n[15]=0,n}function T3(n,e,t,r,i){var a=1/Math.tan(e/2),o;return n[0]=a/t,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=a,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=-1,n[12]=0,n[13]=0,n[15]=0,i!=null&&i!==Infinity?(o=1/(r-i),n[10]=(i+r)*o,n[14]=2*i*r*o):(n[10]=-1,n[14]=-2*r),n}function L3(n,e,t,r){var i=Math.tan(e.upDegrees*Math.PI/180),a=Math.tan(e.downDegrees*Math.PI/180),o=Math.tan(e.leftDegrees*Math.PI/180),l=Math.tan(e.rightDegrees*Math.PI/180),c=2/(o+l),d=2/(i+a);return n[0]=c,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=d,n[6]=0,n[7]=0,n[8]=-((o-l)*c*.5),n[9]=(i-a)*d*.5,n[10]=r/(t-r),n[11]=-1,n[12]=0,n[13]=0,n[14]=r*t/(t-r),n[15]=0,n}function k3(n,e,t,r,i,a,o){var l=1/(e-t),c=1/(r-i),d=1/(a-o);return n[0]=-2*l,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=-2*c,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=2*d,n[11]=0,n[12]=(e+t)*l,n[13]=(i+r)*c,n[14]=(o+a)*d,n[15]=1,n}function E3(n,e,t,r){var i,a,o,l,c,d,p,m,g,v,b=e[0],x=e[1],C=e[2],T=r[0],I=r[1],P=r[2],M=t[0],D=t[1],E=t[2];return Math.abs(b-M)<je&&Math.abs(x-D)<je&&Math.abs(C-E)<je?bk(n):(p=b-M,m=x-D,g=C-E,v=1/Math.hypot(p,m,g),p*=v,m*=v,g*=v,i=I*g-P*m,a=P*p-T*g,o=T*m-I*p,v=Math.hypot(i,a,o),v?(v=1/v,i*=v,a*=v,o*=v):(i=0,a=0,o=0),l=m*o-g*a,c=g*i-p*o,d=p*a-m*i,v=Math.hypot(l,c,d),v?(v=1/v,l*=v,c*=v,d*=v):(l=0,c=0,d=0),n[0]=i,n[1]=l,n[2]=p,n[3]=0,n[4]=a,n[5]=c,n[6]=m,n[7]=0,n[8]=o,n[9]=d,n[10]=g,n[11]=0,n[12]=-(i*b+a*x+o*C),n[13]=-(l*b+c*x+d*C),n[14]=-(p*b+m*x+g*C),n[15]=1,n)}function D3(n,e,t,r){var i=e[0],a=e[1],o=e[2],l=r[0],c=r[1],d=r[2],p=i-t[0],m=a-t[1],g=o-t[2],v=p*p+m*m+g*g;v>0&&(v=1/Math.sqrt(v),p*=v,m*=v,g*=v);var b=c*g-d*m,x=d*p-l*g,C=l*m-c*p;return v=b*b+x*x+C*C,v>0&&(v=1/Math.sqrt(v),b*=v,x*=v,C*=v),n[0]=b,n[1]=x,n[2]=C,n[3]=0,n[4]=m*C-g*x,n[5]=g*b-p*C,n[6]=p*x-m*b,n[7]=0,n[8]=p,n[9]=m,n[10]=g,n[11]=0,n[12]=i,n[13]=a,n[14]=o,n[15]=1,n}function P3(n){return"mat4("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+", "+n[4]+", "+n[5]+", "+n[6]+", "+n[7]+", "+n[8]+", "+n[9]+", "+n[10]+", "+n[11]+", "+n[12]+", "+n[13]+", "+n[14]+", "+n[15]+")"}function I3(n){return Math.hypot(n[0],n[1],n[3],n[4],n[5],n[6],n[7],n[8],n[9],n[10],n[11],n[12],n[13],n[14],n[15])}function A3(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n[3]=e[3]+t[3],n[4]=e[4]+t[4],n[5]=e[5]+t[5],n[6]=e[6]+t[6],n[7]=e[7]+t[7],n[8]=e[8]+t[8],n[9]=e[9]+t[9],n[10]=e[10]+t[10],n[11]=e[11]+t[11],n[12]=e[12]+t[12],n[13]=e[13]+t[13],n[14]=e[14]+t[14],n[15]=e[15]+t[15],n}function Tk(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n[3]=e[3]-t[3],n[4]=e[4]-t[4],n[5]=e[5]-t[5],n[6]=e[6]-t[6],n[7]=e[7]-t[7],n[8]=e[8]-t[8],n[9]=e[9]-t[9],n[10]=e[10]-t[10],n[11]=e[11]-t[11],n[12]=e[12]-t[12],n[13]=e[13]-t[13],n[14]=e[14]-t[14],n[15]=e[15]-t[15],n}function M3(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n[3]=e[3]*t,n[4]=e[4]*t,n[5]=e[5]*t,n[6]=e[6]*t,n[7]=e[7]*t,n[8]=e[8]*t,n[9]=e[9]*t,n[10]=e[10]*t,n[11]=e[11]*t,n[12]=e[12]*t,n[13]=e[13]*t,n[14]=e[14]*t,n[15]=e[15]*t,n}function R3(n,e,t,r){return n[0]=e[0]+t[0]*r,n[1]=e[1]+t[1]*r,n[2]=e[2]+t[2]*r,n[3]=e[3]+t[3]*r,n[4]=e[4]+t[4]*r,n[5]=e[5]+t[5]*r,n[6]=e[6]+t[6]*r,n[7]=e[7]+t[7]*r,n[8]=e[8]+t[8]*r,n[9]=e[9]+t[9]*r,n[10]=e[10]+t[10]*r,n[11]=e[11]+t[11]*r,n[12]=e[12]+t[12]*r,n[13]=e[13]+t[13]*r,n[14]=e[14]+t[14]*r,n[15]=e[15]+t[15]*r,n}function _3(n,e){return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]&&n[4]===e[4]&&n[5]===e[5]&&n[6]===e[6]&&n[7]===e[7]&&n[8]===e[8]&&n[9]===e[9]&&n[10]===e[10]&&n[11]===e[11]&&n[12]===e[12]&&n[13]===e[13]&&n[14]===e[14]&&n[15]===e[15]}function V3(n,e){var t=n[0],r=n[1],i=n[2],a=n[3],o=n[4],l=n[5],c=n[6],d=n[7],p=n[8],m=n[9],g=n[10],v=n[11],b=n[12],x=n[13],C=n[14],T=n[15],I=e[0],P=e[1],M=e[2],D=e[3],E=e[4],V=e[5],O=e[6],B=e[7],z=e[8],_=e[9],U=e[10],N=e[11],J=e[12],ie=e[13],pe=e[14],me=e[15];return Math.abs(t-I)<=je*Math.max(1,Math.abs(t),Math.abs(I))&&Math.abs(r-P)<=je*Math.max(1,Math.abs(r),Math.abs(P))&&Math.abs(i-M)<=je*Math.max(1,Math.abs(i),Math.abs(M))&&Math.abs(a-D)<=je*Math.max(1,Math.abs(a),Math.abs(D))&&Math.abs(o-E)<=je*Math.max(1,Math.abs(o),Math.abs(E))&&Math.abs(l-V)<=je*Math.max(1,Math.abs(l),Math.abs(V))&&Math.abs(c-O)<=je*Math.max(1,Math.abs(c),Math.abs(O))&&Math.abs(d-B)<=je*Math.max(1,Math.abs(d),Math.abs(B))&&Math.abs(p-z)<=je*Math.max(1,Math.abs(p),Math.abs(z))&&Math.abs(m-_)<=je*Math.max(1,Math.abs(m),Math.abs(_))&&Math.abs(g-U)<=je*Math.max(1,Math.abs(g),Math.abs(U))&&Math.abs(v-N)<=je*Math.max(1,Math.abs(v),Math.abs(N))&&Math.abs(b-J)<=je*Math.max(1,Math.abs(b),Math.abs(J))&&Math.abs(x-ie)<=je*Math.max(1,Math.abs(x),Math.abs(ie))&&Math.abs(C-pe)<=je*Math.max(1,Math.abs(C),Math.abs(pe))&&Math.abs(T-me)<=je*Math.max(1,Math.abs(T),Math.abs(me))}var O3=xk,N3=Tk;var Ke={};yc(Ke,{add:()=>iG,calculateW:()=>J4,clone:()=>eG,conjugate:()=>X4,copy:()=>nG,create:()=>Dv,dot:()=>Hk,equals:()=>uG,exactEquals:()=>cG,exp:()=>Fk,fromEuler:()=>Q4,fromMat3:()=>Wk,fromValues:()=>tG,getAngle:()=>z4,getAxisAngle:()=>W4,identity:()=>G4,invert:()=>K4,len:()=>sG,length:()=>$k,lerp:()=>oG,ln:()=>Gk,mul:()=>aG,multiply:()=>Uk,normalize:()=>Pv,pow:()=>q4,random:()=>Y4,rotateX:()=>H4,rotateY:()=>$4,rotateZ:()=>j4,rotationTo:()=>dG,scale:()=>zk,set:()=>rG,setAxes:()=>fG,setAxisAngle:()=>Bk,slerp:()=>$f,sqlerp:()=>pG,sqrLen:()=>lG,squaredLength:()=>jk,str:()=>Z4});var K={};yc(K,{add:()=>G3,angle:()=>s4,bezier:()=>Z3,ceil:()=>W3,clone:()=>B3,copy:()=>U3,create:()=>Gf,cross:()=>cd,dist:()=>m4,distance:()=>Pk,div:()=>h4,divide:()=>Dk,dot:()=>Wf,equals:()=>d4,exactEquals:()=>u4,floor:()=>z3,forEach:()=>v4,fromValues:()=>bc,hermite:()=>Q3,inverse:()=>K3,len:()=>gv,length:()=>Lk,lerp:()=>X3,max:()=>$3,min:()=>H3,mul:()=>f4,multiply:()=>Ek,negate:()=>Y3,normalize:()=>ld,random:()=>e4,rotateX:()=>i4,rotateY:()=>a4,rotateZ:()=>o4,round:()=>j3,scale:()=>J3,scaleAndAdd:()=>q3,set:()=>F3,sqrDist:()=>g4,sqrLen:()=>y4,squaredDistance:()=>Ik,squaredLength:()=>Ak,str:()=>c4,sub:()=>p4,subtract:()=>kk,transformMat3:()=>n4,transformMat4:()=>t4,transformQuat:()=>r4,zero:()=>l4});function Gf(){var n=new vt(3);return vt!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n}function B3(n){var e=new vt(3);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e}function Lk(n){var e=n[0],t=n[1],r=n[2];return Math.hypot(e,t,r)}function bc(n,e,t){var r=new vt(3);return r[0]=n,r[1]=e,r[2]=t,r}function U3(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n}function F3(n,e,t,r){return n[0]=e,n[1]=t,n[2]=r,n}function G3(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n}function kk(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n}function Ek(n,e,t){return n[0]=e[0]*t[0],n[1]=e[1]*t[1],n[2]=e[2]*t[2],n}function Dk(n,e,t){return n[0]=e[0]/t[0],n[1]=e[1]/t[1],n[2]=e[2]/t[2],n}function W3(n,e){return n[0]=Math.ceil(e[0]),n[1]=Math.ceil(e[1]),n[2]=Math.ceil(e[2]),n}function z3(n,e){return n[0]=Math.floor(e[0]),n[1]=Math.floor(e[1]),n[2]=Math.floor(e[2]),n}function H3(n,e,t){return n[0]=Math.min(e[0],t[0]),n[1]=Math.min(e[1],t[1]),n[2]=Math.min(e[2],t[2]),n}function $3(n,e,t){return n[0]=Math.max(e[0],t[0]),n[1]=Math.max(e[1],t[1]),n[2]=Math.max(e[2],t[2]),n}function j3(n,e){return n[0]=Math.round(e[0]),n[1]=Math.round(e[1]),n[2]=Math.round(e[2]),n}function J3(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n}function q3(n,e,t,r){return n[0]=e[0]+t[0]*r,n[1]=e[1]+t[1]*r,n[2]=e[2]+t[2]*r,n}function Pk(n,e){var t=e[0]-n[0],r=e[1]-n[1],i=e[2]-n[2];return Math.hypot(t,r,i)}function Ik(n,e){var t=e[0]-n[0],r=e[1]-n[1],i=e[2]-n[2];return t*t+r*r+i*i}function Ak(n){var e=n[0],t=n[1],r=n[2];return e*e+t*t+r*r}function Y3(n,e){return n[0]=-e[0],n[1]=-e[1],n[2]=-e[2],n}function K3(n,e){return n[0]=1/e[0],n[1]=1/e[1],n[2]=1/e[2],n}function ld(n,e){var t=e[0],r=e[1],i=e[2],a=t*t+r*r+i*i;return a>0&&(a=1/Math.sqrt(a)),n[0]=e[0]*a,n[1]=e[1]*a,n[2]=e[2]*a,n}function Wf(n,e){return n[0]*e[0]+n[1]*e[1]+n[2]*e[2]}function cd(n,e,t){var r=e[0],i=e[1],a=e[2],o=t[0],l=t[1],c=t[2];return n[0]=i*c-a*l,n[1]=a*o-r*c,n[2]=r*l-i*o,n}function X3(n,e,t,r){var i=e[0],a=e[1],o=e[2];return n[0]=i+r*(t[0]-i),n[1]=a+r*(t[1]-a),n[2]=o+r*(t[2]-o),n}function Q3(n,e,t,r,i,a){var o=a*a,l=o*(2*a-3)+1,c=o*(a-2)+a,d=o*(a-1),p=o*(3-2*a);return n[0]=e[0]*l+t[0]*c+r[0]*d+i[0]*p,n[1]=e[1]*l+t[1]*c+r[1]*d+i[1]*p,n[2]=e[2]*l+t[2]*c+r[2]*d+i[2]*p,n}function Z3(n,e,t,r,i,a){var o=1-a,l=o*o,c=a*a,d=l*o,p=3*a*l,m=3*c*o,g=c*a;return n[0]=e[0]*d+t[0]*p+r[0]*m+i[0]*g,n[1]=e[1]*d+t[1]*p+r[1]*m+i[1]*g,n[2]=e[2]*d+t[2]*p+r[2]*m+i[2]*g,n}function e4(n,e){e=e||1;var t=Vr()*2*Math.PI,r=Vr()*2-1,i=Math.sqrt(1-r*r)*e;return n[0]=Math.cos(t)*i,n[1]=Math.sin(t)*i,n[2]=r*e,n}function t4(n,e,t){var r=e[0],i=e[1],a=e[2],o=t[3]*r+t[7]*i+t[11]*a+t[15];return o=o||1,n[0]=(t[0]*r+t[4]*i+t[8]*a+t[12])/o,n[1]=(t[1]*r+t[5]*i+t[9]*a+t[13])/o,n[2]=(t[2]*r+t[6]*i+t[10]*a+t[14])/o,n}function n4(n,e,t){var r=e[0],i=e[1],a=e[2];return n[0]=r*t[0]+i*t[3]+a*t[6],n[1]=r*t[1]+i*t[4]+a*t[7],n[2]=r*t[2]+i*t[5]+a*t[8],n}function r4(n,e,t){var r=t[0],i=t[1],a=t[2],o=t[3],l=e[0],c=e[1],d=e[2],p=i*d-a*c,m=a*l-r*d,g=r*c-i*l,v=i*g-a*m,b=a*p-r*g,x=r*m-i*p,C=o*2;return p*=C,m*=C,g*=C,v*=2,b*=2,x*=2,n[0]=l+p+v,n[1]=c+m+b,n[2]=d+g+x,n}function i4(n,e,t,r){var i=[],a=[];return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],a[0]=i[0],a[1]=i[1]*Math.cos(r)-i[2]*Math.sin(r),a[2]=i[1]*Math.sin(r)+i[2]*Math.cos(r),n[0]=a[0]+t[0],n[1]=a[1]+t[1],n[2]=a[2]+t[2],n}function a4(n,e,t,r){var i=[],a=[];return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],a[0]=i[2]*Math.sin(r)+i[0]*Math.cos(r),a[1]=i[1],a[2]=i[2]*Math.cos(r)-i[0]*Math.sin(r),n[0]=a[0]+t[0],n[1]=a[1]+t[1],n[2]=a[2]+t[2],n}function o4(n,e,t,r){var i=[],a=[];return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],a[0]=i[0]*Math.cos(r)-i[1]*Math.sin(r),a[1]=i[0]*Math.sin(r)+i[1]*Math.cos(r),a[2]=i[2],n[0]=a[0]+t[0],n[1]=a[1]+t[1],n[2]=a[2]+t[2],n}function s4(n,e){var t=bc(n[0],n[1],n[2]),r=bc(e[0],e[1],e[2]);ld(t,t),ld(r,r);var i=Wf(t,r);return i>1?0:i<-1?Math.PI:Math.acos(i)}function l4(n){return n[0]=0,n[1]=0,n[2]=0,n}function c4(n){return"vec3("+n[0]+", "+n[1]+", "+n[2]+")"}function u4(n,e){return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]}function d4(n,e){var t=n[0],r=n[1],i=n[2],a=e[0],o=e[1],l=e[2];return Math.abs(t-a)<=je*Math.max(1,Math.abs(t),Math.abs(a))&&Math.abs(r-o)<=je*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(i-l)<=je*Math.max(1,Math.abs(i),Math.abs(l))}var p4=kk,f4=Ek,h4=Dk,m4=Pk,g4=Ik,gv=Lk,y4=Ak,v4=function(){var n=Gf();return function(e,t,r,i,a,o){var l,c;for(t||(t=3),r||(r=0),i?c=Math.min(i*t+r,e.length):c=e.length,l=r;l<c;l+=t)n[0]=e[l],n[1]=e[l+1],n[2]=e[l+2],a(n,n,o),e[l]=n[0],e[l+1]=n[1],e[l+2]=n[2];return e}}();var rn={};yc(rn,{add:()=>xv,ceil:()=>S4,clone:()=>yv,copy:()=>Sv,create:()=>Mk,cross:()=>E4,dist:()=>O4,distance:()=>Ok,div:()=>V4,divide:()=>Vk,dot:()=>Tv,equals:()=>Ev,exactEquals:()=>kv,floor:()=>b4,forEach:()=>F4,fromValues:()=>vv,inverse:()=>k4,len:()=>B4,length:()=>zf,lerp:()=>Lv,max:()=>C4,min:()=>x4,mul:()=>_4,multiply:()=>_k,negate:()=>L4,normalize:()=>wv,random:()=>D4,round:()=>w4,scale:()=>Cv,scaleAndAdd:()=>T4,set:()=>bv,sqrDist:()=>N4,sqrLen:()=>U4,squaredDistance:()=>Nk,squaredLength:()=>Hf,str:()=>M4,sub:()=>R4,subtract:()=>Rk,transformMat4:()=>P4,transformQuat:()=>I4,zero:()=>A4});function Mk(){var n=new vt(4);return vt!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0,n[3]=0),n}function yv(n){var e=new vt(4);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e}function vv(n,e,t,r){var i=new vt(4);return i[0]=n,i[1]=e,i[2]=t,i[3]=r,i}function Sv(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n}function bv(n,e,t,r,i){return n[0]=e,n[1]=t,n[2]=r,n[3]=i,n}function xv(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n[3]=e[3]+t[3],n}function Rk(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n[3]=e[3]-t[3],n}function _k(n,e,t){return n[0]=e[0]*t[0],n[1]=e[1]*t[1],n[2]=e[2]*t[2],n[3]=e[3]*t[3],n}function Vk(n,e,t){return n[0]=e[0]/t[0],n[1]=e[1]/t[1],n[2]=e[2]/t[2],n[3]=e[3]/t[3],n}function S4(n,e){return n[0]=Math.ceil(e[0]),n[1]=Math.ceil(e[1]),n[2]=Math.ceil(e[2]),n[3]=Math.ceil(e[3]),n}function b4(n,e){return n[0]=Math.floor(e[0]),n[1]=Math.floor(e[1]),n[2]=Math.floor(e[2]),n[3]=Math.floor(e[3]),n}function x4(n,e,t){return n[0]=Math.min(e[0],t[0]),n[1]=Math.min(e[1],t[1]),n[2]=Math.min(e[2],t[2]),n[3]=Math.min(e[3],t[3]),n}function C4(n,e,t){return n[0]=Math.max(e[0],t[0]),n[1]=Math.max(e[1],t[1]),n[2]=Math.max(e[2],t[2]),n[3]=Math.max(e[3],t[3]),n}function w4(n,e){return n[0]=Math.round(e[0]),n[1]=Math.round(e[1]),n[2]=Math.round(e[2]),n[3]=Math.round(e[3]),n}function Cv(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n[3]=e[3]*t,n}function T4(n,e,t,r){return n[0]=e[0]+t[0]*r,n[1]=e[1]+t[1]*r,n[2]=e[2]+t[2]*r,n[3]=e[3]+t[3]*r,n}function Ok(n,e){var t=e[0]-n[0],r=e[1]-n[1],i=e[2]-n[2],a=e[3]-n[3];return Math.hypot(t,r,i,a)}function Nk(n,e){var t=e[0]-n[0],r=e[1]-n[1],i=e[2]-n[2],a=e[3]-n[3];return t*t+r*r+i*i+a*a}function zf(n){var e=n[0],t=n[1],r=n[2],i=n[3];return Math.hypot(e,t,r,i)}function Hf(n){var e=n[0],t=n[1],r=n[2],i=n[3];return e*e+t*t+r*r+i*i}function L4(n,e){return n[0]=-e[0],n[1]=-e[1],n[2]=-e[2],n[3]=-e[3],n}function k4(n,e){return n[0]=1/e[0],n[1]=1/e[1],n[2]=1/e[2],n[3]=1/e[3],n}function wv(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=t*t+r*r+i*i+a*a;return o>0&&(o=1/Math.sqrt(o)),n[0]=t*o,n[1]=r*o,n[2]=i*o,n[3]=a*o,n}function Tv(n,e){return n[0]*e[0]+n[1]*e[1]+n[2]*e[2]+n[3]*e[3]}function E4(n,e,t,r){var i=t[0]*r[1]-t[1]*r[0],a=t[0]*r[2]-t[2]*r[0],o=t[0]*r[3]-t[3]*r[0],l=t[1]*r[2]-t[2]*r[1],c=t[1]*r[3]-t[3]*r[1],d=t[2]*r[3]-t[3]*r[2],p=e[0],m=e[1],g=e[2],v=e[3];return n[0]=m*d-g*c+v*l,n[1]=-(p*d)+g*o-v*a,n[2]=p*c-m*o+v*i,n[3]=-(p*l)+m*a-g*i,n}function Lv(n,e,t,r){var i=e[0],a=e[1],o=e[2],l=e[3];return n[0]=i+r*(t[0]-i),n[1]=a+r*(t[1]-a),n[2]=o+r*(t[2]-o),n[3]=l+r*(t[3]-l),n}function D4(n,e){e=e||1;var t,r,i,a,o,l;do t=Vr()*2-1,r=Vr()*2-1,o=t*t+r*r;while(o>=1);do i=Vr()*2-1,a=Vr()*2-1,l=i*i+a*a;while(l>=1);var c=Math.sqrt((1-o)/l);return n[0]=e*t,n[1]=e*r,n[2]=e*i*c,n[3]=e*a*c,n}function P4(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3];return n[0]=t[0]*r+t[4]*i+t[8]*a+t[12]*o,n[1]=t[1]*r+t[5]*i+t[9]*a+t[13]*o,n[2]=t[2]*r+t[6]*i+t[10]*a+t[14]*o,n[3]=t[3]*r+t[7]*i+t[11]*a+t[15]*o,n}function I4(n,e,t){var r=e[0],i=e[1],a=e[2],o=t[0],l=t[1],c=t[2],d=t[3],p=d*r+l*a-c*i,m=d*i+c*r-o*a,g=d*a+o*i-l*r,v=-o*r-l*i-c*a;return n[0]=p*d+v*-o+m*-c-g*-l,n[1]=m*d+v*-l+g*-o-p*-c,n[2]=g*d+v*-c+p*-l-m*-o,n[3]=e[3],n}function A4(n){return n[0]=0,n[1]=0,n[2]=0,n[3]=0,n}function M4(n){return"vec4("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+")"}function kv(n,e){return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]}function Ev(n,e){var t=n[0],r=n[1],i=n[2],a=n[3],o=e[0],l=e[1],c=e[2],d=e[3];return Math.abs(t-o)<=je*Math.max(1,Math.abs(t),Math.abs(o))&&Math.abs(r-l)<=je*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(i-c)<=je*Math.max(1,Math.abs(i),Math.abs(c))&&Math.abs(a-d)<=je*Math.max(1,Math.abs(a),Math.abs(d))}var R4=Rk,_4=_k,V4=Vk,O4=Ok,N4=Nk,B4=zf,U4=Hf,F4=function(){var n=Mk();return function(e,t,r,i,a,o){var l,c;for(t||(t=4),r||(r=0),i?c=Math.min(i*t+r,e.length):c=e.length,l=r;l<c;l+=t)n[0]=e[l],n[1]=e[l+1],n[2]=e[l+2],n[3]=e[l+3],a(n,n,o),e[l]=n[0],e[l+1]=n[1],e[l+2]=n[2],e[l+3]=n[3];return e}}();function Dv(){var n=new vt(4);return vt!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n[3]=1,n}function G4(n){return n[0]=0,n[1]=0,n[2]=0,n[3]=1,n}function Bk(n,e,t){t=t*.5;var r=Math.sin(t);return n[0]=r*e[0],n[1]=r*e[1],n[2]=r*e[2],n[3]=Math.cos(t),n}function W4(n,e){var t=Math.acos(e[3])*2,r=Math.sin(t/2);return r>je?(n[0]=e[0]/r,n[1]=e[1]/r,n[2]=e[2]/r):(n[0]=1,n[1]=0,n[2]=0),t}function z4(n,e){var t=Hk(n,e);return Math.acos(2*t*t-1)}function Uk(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=t[0],c=t[1],d=t[2],p=t[3];return n[0]=r*p+o*l+i*d-a*c,n[1]=i*p+o*c+a*l-r*d,n[2]=a*p+o*d+r*c-i*l,n[3]=o*p-r*l-i*c-a*d,n}function H4(n,e,t){t*=.5;var r=e[0],i=e[1],a=e[2],o=e[3],l=Math.sin(t),c=Math.cos(t);return n[0]=r*c+o*l,n[1]=i*c+a*l,n[2]=a*c-i*l,n[3]=o*c-r*l,n}function $4(n,e,t){t*=.5;var r=e[0],i=e[1],a=e[2],o=e[3],l=Math.sin(t),c=Math.cos(t);return n[0]=r*c-a*l,n[1]=i*c+o*l,n[2]=a*c+r*l,n[3]=o*c-i*l,n}function j4(n,e,t){t*=.5;var r=e[0],i=e[1],a=e[2],o=e[3],l=Math.sin(t),c=Math.cos(t);return n[0]=r*c+i*l,n[1]=i*c-r*l,n[2]=a*c+o*l,n[3]=o*c-a*l,n}function J4(n,e){var t=e[0],r=e[1],i=e[2];return n[0]=t,n[1]=r,n[2]=i,n[3]=Math.sqrt(Math.abs(1-t*t-r*r-i*i)),n}function Fk(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=Math.sqrt(t*t+r*r+i*i),l=Math.exp(a),c=o>0?l*Math.sin(o)/o:0;return n[0]=t*c,n[1]=r*c,n[2]=i*c,n[3]=l*Math.cos(o),n}function Gk(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=Math.sqrt(t*t+r*r+i*i),l=o>0?Math.atan2(o,a)/o:0;return n[0]=t*l,n[1]=r*l,n[2]=i*l,n[3]=.5*Math.log(t*t+r*r+i*i+a*a),n}function q4(n,e,t){return Gk(n,e),zk(n,n,t),Fk(n,n),n}function $f(n,e,t,r){var i=e[0],a=e[1],o=e[2],l=e[3],c=t[0],d=t[1],p=t[2],m=t[3],g,v,b,x,C;return v=i*c+a*d+o*p+l*m,v<0&&(v=-v,c=-c,d=-d,p=-p,m=-m),1-v>je?(g=Math.acos(v),b=Math.sin(g),x=Math.sin((1-r)*g)/b,C=Math.sin(r*g)/b):(x=1-r,C=r),n[0]=x*i+C*c,n[1]=x*a+C*d,n[2]=x*o+C*p,n[3]=x*l+C*m,n}function Y4(n){var e=Vr(),t=Vr(),r=Vr(),i=Math.sqrt(1-e),a=Math.sqrt(e);return n[0]=i*Math.sin(2*Math.PI*t),n[1]=i*Math.cos(2*Math.PI*t),n[2]=a*Math.sin(2*Math.PI*r),n[3]=a*Math.cos(2*Math.PI*r),n}function K4(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=t*t+r*r+i*i+a*a,l=o?1/o:0;return n[0]=-t*l,n[1]=-r*l,n[2]=-i*l,n[3]=a*l,n}function X4(n,e){return n[0]=-e[0],n[1]=-e[1],n[2]=-e[2],n[3]=e[3],n}function Wk(n,e){var t=e[0]+e[4]+e[8],r;if(t>0)r=Math.sqrt(t+1),n[3]=.5*r,r=.5/r,n[0]=(e[5]-e[7])*r,n[1]=(e[6]-e[2])*r,n[2]=(e[1]-e[3])*r;else{var i=0;e[4]>e[0]&&(i=1),e[8]>e[i*3+i]&&(i=2);var a=(i+1)%3,o=(i+2)%3;r=Math.sqrt(e[i*3+i]-e[a*3+a]-e[o*3+o]+1),n[i]=.5*r,r=.5/r,n[3]=(e[a*3+o]-e[o*3+a])*r,n[a]=(e[a*3+i]+e[i*3+a])*r,n[o]=(e[o*3+i]+e[i*3+o])*r}return n}function Q4(n,e,t,r){var i=.5*Math.PI/180;e*=i,t*=i,r*=i;var a=Math.sin(e),o=Math.cos(e),l=Math.sin(t),c=Math.cos(t),d=Math.sin(r),p=Math.cos(r);return n[0]=a*c*p-o*l*d,n[1]=o*l*p+a*c*d,n[2]=o*c*d-a*l*p,n[3]=o*c*p+a*l*d,n}function Z4(n){return"quat("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+")"}var eG=yv,tG=vv,nG=Sv,rG=bv,iG=xv,aG=Uk,zk=Cv,Hk=Tv,oG=Lv,$k=zf,sG=$k,jk=Hf,lG=jk,Pv=wv,cG=kv,uG=Ev,dG=function(){var n=Gf(),e=bc(1,0,0),t=bc(0,1,0);return function(r,i,a){var o=Wf(i,a);return o<-.999999?(cd(n,e,i),gv(n)<1e-6&&cd(n,t,i),ld(n,n),Bk(r,n,Math.PI),r):o>.999999?(r[0]=0,r[1]=0,r[2]=0,r[3]=1,r):(cd(n,i,a),r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=1+o,Pv(r,r))}}(),pG=function(){var n=Dv(),e=Dv();return function(t,r,i,a,o,l){return $f(n,r,o,l),$f(e,i,a,l),$f(t,n,e,2*l*(1-l)),t}}(),fG=function(){var n=mv();return function(e,t,r,i){return n[0]=r[0],n[3]=r[1],n[6]=r[2],n[1]=i[0],n[4]=i[1],n[7]=i[2],n[2]=-t[0],n[5]=-t[1],n[8]=-t[2],Pv(e,Wk(e,n))}}();var gr={};yc(gr,{add:()=>vG,angle:()=>BG,ceil:()=>SG,clone:()=>hG,copy:()=>gG,create:()=>Jk,cross:()=>IG,dist:()=>JG,distance:()=>Xk,div:()=>jG,divide:()=>Kk,dot:()=>PG,equals:()=>WG,exactEquals:()=>GG,floor:()=>bG,forEach:()=>KG,fromValues:()=>mG,inverse:()=>EG,len:()=>zG,length:()=>Zk,lerp:()=>AG,max:()=>CG,min:()=>xG,mul:()=>$G,multiply:()=>Yk,negate:()=>kG,normalize:()=>DG,random:()=>MG,rotate:()=>NG,round:()=>wG,scale:()=>TG,scaleAndAdd:()=>LG,set:()=>yG,sqrDist:()=>qG,sqrLen:()=>YG,squaredDistance:()=>Qk,squaredLength:()=>eE,str:()=>FG,sub:()=>HG,subtract:()=>qk,transformMat2:()=>RG,transformMat2d:()=>_G,transformMat3:()=>VG,transformMat4:()=>OG,zero:()=>UG});function Jk(){var n=new vt(2);return vt!=Float32Array&&(n[0]=0,n[1]=0),n}function hG(n){var e=new vt(2);return e[0]=n[0],e[1]=n[1],e}function mG(n,e){var t=new vt(2);return t[0]=n,t[1]=e,t}function gG(n,e){return n[0]=e[0],n[1]=e[1],n}function yG(n,e,t){return n[0]=e,n[1]=t,n}function vG(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n}function qk(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n}function Yk(n,e,t){return n[0]=e[0]*t[0],n[1]=e[1]*t[1],n}function Kk(n,e,t){return n[0]=e[0]/t[0],n[1]=e[1]/t[1],n}function SG(n,e){return n[0]=Math.ceil(e[0]),n[1]=Math.ceil(e[1]),n}function bG(n,e){return n[0]=Math.floor(e[0]),n[1]=Math.floor(e[1]),n}function xG(n,e,t){return n[0]=Math.min(e[0],t[0]),n[1]=Math.min(e[1],t[1]),n}function CG(n,e,t){return n[0]=Math.max(e[0],t[0]),n[1]=Math.max(e[1],t[1]),n}function wG(n,e){return n[0]=Math.round(e[0]),n[1]=Math.round(e[1]),n}function TG(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n}function LG(n,e,t,r){return n[0]=e[0]+t[0]*r,n[1]=e[1]+t[1]*r,n}function Xk(n,e){var t=e[0]-n[0],r=e[1]-n[1];return Math.hypot(t,r)}function Qk(n,e){var t=e[0]-n[0],r=e[1]-n[1];return t*t+r*r}function Zk(n){var e=n[0],t=n[1];return Math.hypot(e,t)}function eE(n){var e=n[0],t=n[1];return e*e+t*t}function kG(n,e){return n[0]=-e[0],n[1]=-e[1],n}function EG(n,e){return n[0]=1/e[0],n[1]=1/e[1],n}function DG(n,e){var t=e[0],r=e[1],i=t*t+r*r;return i>0&&(i=1/Math.sqrt(i)),n[0]=e[0]*i,n[1]=e[1]*i,n}function PG(n,e){return n[0]*e[0]+n[1]*e[1]}function IG(n,e,t){var r=e[0]*t[1]-e[1]*t[0];return n[0]=n[1]=0,n[2]=r,n}function AG(n,e,t,r){var i=e[0],a=e[1];return n[0]=i+r*(t[0]-i),n[1]=a+r*(t[1]-a),n}function MG(n,e){e=e||1;var t=Vr()*2*Math.PI;return n[0]=Math.cos(t)*e,n[1]=Math.sin(t)*e,n}function RG(n,e,t){var r=e[0],i=e[1];return n[0]=t[0]*r+t[2]*i,n[1]=t[1]*r+t[3]*i,n}function _G(n,e,t){var r=e[0],i=e[1];return n[0]=t[0]*r+t[2]*i+t[4],n[1]=t[1]*r+t[3]*i+t[5],n}function VG(n,e,t){var r=e[0],i=e[1];return n[0]=t[0]*r+t[3]*i+t[6],n[1]=t[1]*r+t[4]*i+t[7],n}function OG(n,e,t){var r=e[0],i=e[1];return n[0]=t[0]*r+t[4]*i+t[12],n[1]=t[1]*r+t[5]*i+t[13],n}function NG(n,e,t,r){var i=e[0]-t[0],a=e[1]-t[1],o=Math.sin(r),l=Math.cos(r);return n[0]=i*l-a*o+t[0],n[1]=i*o+a*l+t[1],n}function BG(n,e){var t=n[0],r=n[1],i=e[0],a=e[1],o=t*t+r*r;o>0&&(o=1/Math.sqrt(o));var l=i*i+a*a;l>0&&(l=1/Math.sqrt(l));var c=(t*i+r*a)*o*l;return c>1?0:c<-1?Math.PI:Math.acos(c)}function UG(n){return n[0]=0,n[1]=0,n}function FG(n){return"vec2("+n[0]+", "+n[1]+")"}function GG(n,e){return n[0]===e[0]&&n[1]===e[1]}function WG(n,e){var t=n[0],r=n[1],i=e[0],a=e[1];return Math.abs(t-i)<=je*Math.max(1,Math.abs(t),Math.abs(i))&&Math.abs(r-a)<=je*Math.max(1,Math.abs(r),Math.abs(a))}var zG=Zk,HG=qk,$G=Yk,jG=Kk,JG=Xk,qG=Qk,YG=eE,KG=function(){var n=Jk();return function(e,t,r,i,a,o){var l,c;for(t||(t=2),r||(r=0),i?c=Math.min(i*t+r,e.length):c=e.length,l=r;l<c;l+=t)n[0]=e[l],n[1]=e[l+1],a(n,n,o),e[l]=n[0],e[l+1]=n[1];return e}}();var jf=ae.create(),tE=["x","y","z"],qr=[K.fromValues(1,0,0),K.fromValues(0,1,0),K.fromValues(0,0,1)],b8=K.fromValues(0,0,0),ud=rn.fromValues(0,0,0,0),Jf=K.fromValues(1,1,1),x8=K.fromValues(Infinity,Infinity,Infinity),C8=Ke.create();function dd(n){return n[0]*n[1]*n[2]}function Fo(n){return`${n[0]},${n[1]},${n[2]}`}function nE(n,e,t){let r=e[0],i=e[1],a=e[2];return n[0]=t[0]*r+t[4]*i+t[8]*a,n[1]=t[1]*r+t[5]*i+t[9]*a,n[2]=t[2]*r+t[6]*i+t[10]*a,n}function qf(n,e,t){let r=e[0],i=e[1],a=e[2];return n[0]=t[0]*r+t[1]*i+t[2]*a,n[1]=t[4]*r+t[5]*i+t[6]*a,n[2]=t[8]*r+t[9]*i+t[10]*a,n}function XG(n,e,t){let r=t.length,i=0;for(let o=0;o<r;++o)i+=(n[o]-e[o])**2;let a=0;for(let o=0;o<r;++o){let l=n[o];a-=(l-t[o])*(e[o]-l)}return a/Math.max(i,1e-6)}function rE(n,e,t,r){let i=n.length,a=XG(e,t,r);a=Math.max(0,Math.min(1,a));for(let o=0;o<i;++o){let l=e[o];n[o]=l+a*(t[o]-l)}return n}function Hs(n,e){let t=e[0],r=e[1],i=e[2],a=e[4],o=e[5],l=e[6],c=e[8],d=e[9],p=e[10];return n[0]=t,n[1]=r,n[2]=i,n[3]=a,n[4]=o,n[5]=l,n[6]=c,n[7]=d,n[8]=p,n}function $s(n,e){let t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8],m=e[9],g=e[10],v=e[11],b=e[12],x=e[13],C=e[14],T=e[15];n[0]=a+t,n[1]=d+o,n[2]=v+p,n[3]=T+b,n[4]=a-t,n[5]=d-o,n[6]=v-p,n[7]=T-b,n[8]=a+r,n[9]=d+l,n[10]=v+m,n[11]=T+x,n[12]=a-r,n[13]=d-l,n[14]=v-m,n[15]=T-x;let I=a+i,P=d+c,M=v+g,D=T+C,E=a-i,V=d-c,O=v-g,B=T-C,z=Math.sqrt(I**2+P**2+M**2);n[16]=I/z,n[17]=P/z,n[18]=M/z,n[19]=D/z;let _=Math.sqrt(E**2+V**2+O**2);return n[20]=E/_,n[21]=V/_,n[22]=O/_,n[23]=B/_,n}function Yf(n,e,t,r,i,a,o){for(let l=0;l<6;++l){let c=o[l*4],d=o[l*4+1],p=o[l*4+2],m=o[l*4+3];if(Math.max(c*n,c*r)+Math.max(d*e,d*i)+Math.max(p*t,p*a)+m<0)return!1}return!0}function iE(n,e,t,r,i,a,o){for(let l=0;l<4;++l){let c=o[l*4],d=o[l*4+1],p=o[l*4+2],m=o[l*4+3];if(Math.max(c*n,c*r)+Math.max(d*e,d*i)+Math.max(p*t,p*a)+m<0)return!1}{let l=5,c=o[l*4],d=o[l*4+1],p=o[l*4+2],m=o[l*4+3],g=Math.max(c*n,c*r)+Math.max(d*e,d*i)+Math.max(p*t,p*a),v=Math.min(c*n,c*r)+Math.min(d*e,d*i)+Math.min(p*t,p*a),b=Math.abs(m)*1e-6;if(v>-m+b||g<-m-b)return!1}return!0}function js(n,e,t,r=!1){let i=t.length,a=[],o=r?1:e+1,l=r?e+1:1;for(let c=0;c<i;++c){let d=t[c];for(let p=0;p<e;++p)n[p*o+d*l]!==0&&(a[p]=!0)}return ML(a,!0)}function Iv(n,e,t){for(let r=0;r<3;++r){let i=t[r];for(let a=0;a<3;++a)n[r+a*3]=i*e[r+a*3]}return n}function aE(n){if(n[15]===1){let o=2/Math.abs(n[10]),l=2/Math.abs(n[0]),c=2/Math.abs(n[5]);return l*c*o}let e=n[10],t=n[14],r=2*t/(2*e-2),i=(e-1)*r/(e+1);return 4/(n[0]*n[5])/3*(Math.abs(i)**3-Math.abs(r)**3)}function Kf(n){if(n[15]===1)return 2/Math.abs(n[10]);let e=n[10],t=n[14],r=2*t/(2*e-2),i=(e-1)*r/(e+1);return Math.abs(i-r)}function oE(n){return n[2]=0,n[6]=0,n[10]=0,n[14]=0,n}var xc=K.create();function sE(n,e){e[0]=e[1]=e[2]=Number.POSITIVE_INFINITY,e[3]=e[4]=e[5]=Number.NEGATIVE_INFINITY;for(let t=0;t<8;++t){xc[0]=2*(t&1)-1,xc[1]=2*(t>>>1&1)-1,xc[2]=2*(t>>>2&1)-1,K.transformMat4(xc,xc,n);for(let r=0;r<3;++r){let i=xc[r];e[r]=Math.min(e[r],i),e[r+3]=Math.max(e[r+3],i)}}}function Av(n){return("0"+n.toString(16)).slice(-2)}function lE(n){return Array.prototype.map.call(n,Av).join("")}function cE(n){if(!/^(?:[0-9a-fA-F]{2})*$/.test(n))throw new Error("Invalid hex-encoded string");let e=n.length/2,t=new Uint8Array(e);for(let r=0;r<e;++r)t[r]=parseInt(n.substr(r*2,2),16);return t}function QG(n){let e=/^rgba\(([0-9]+), ([0-9]+), ([0-9]+), (0(?:\.[0-9]+)?)\)$/;{let r=n.match(e);if(r!==null)return[parseInt(r[1],10),parseInt(r[2],10),parseInt(r[3],10),parseFloat(r[4])]}let t=/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/;{let r=n.match(t);if(r!==null)return[parseInt(r[1],16),parseInt(r[2],16),parseInt(r[3],16),1]}throw new Error(`Invalid serialized color: ${JSON.stringify(n)}.`)}function Mv(n){try{if(typeof n!="string")throw new Error(`Expected string, but received ${JSON.stringify(n)}.`);let e=document.createElement("canvas").getContext("2d");e.fillStyle=n;let t=QG(e.fillStyle);return rn.fromValues(t[0]/255,t[1]/255,t[2]/255,t[3])}catch(e){throw new Error(`Failed to parse color specification: ${e.message}`)}}function ma(n){return Mv(n).subarray(0,3)}function Xa(n){let e=n[3]===void 0?3:4,t=0;for(let r=0;r<e;r++)t=(t<<8>>>0)+Math.min(255,Math.max(0,Math.round(n[e-1-r]*255)));return t}function Qa(n){return K.fromValues((n>>>0&255)/255,(n>>>8&255)/255,(n>>>16&255)/255)}function pd(n){return rn.fromValues((n>>>0&255)/255,(n>>>8&255)/255,(n>>>16&255)/255,(n>>>24&255)/255)}function gn(n){if(n[3]===void 0||n[3]===1){let e="#";for(let t=0;t<3;++t)e+=Av(Math.min(255,Math.max(0,Math.round(n[t]*255))));return e}else{let e="rgba(";for(let t=0;t<3;++t)t!==0&&(e+=", "),e+=Math.min(255,Math.max(0,Math.round(n[t]*255)));return e+=`, ${yk(n[3])})`,e}}function Rv(n){return n<=.03928?n/12.92:((n+.055)/1.055)**2.4}function ZG(n){let[e,t,r]=n;return .2126*Rv(e)+.7152*Rv(t)+.0722*Rv(r)}function fd(n){return ZG(n)<=.179}var Go=class extends Ee{constructor(e){super(K.clone(e));this.defaultValue=e}toString(){return gn(this.value)}toJSON(){if(!K.equals(this.value,this.defaultValue))return gn(this.value)}reset(){this.value=K.clone(this.defaultValue)}restoreState(e){if(e===void 0){this.reset();return}let{value:t}=this,r=ma(e);K.equals(t,r)||(this.value=r)}},_v=class extends Ee{constructor(){super(void 0)}toJSON(){let{value:e}=this;if(e!==void 0)return gn(e)}reset(){this.value=void 0}restoreState(e){if(e===void 0){this.reset();return}let{value:t}=this,r=ma(e);(t===void 0||!K.equals(t,r))&&(this.value=r)}};var G;(function(c){c[c.UINT8=0]="UINT8",c[c.INT8=1]="INT8",c[c.UINT16=2]="UINT16",c[c.INT16=3]="INT16",c[c.UINT32=4]="UINT32",c[c.INT32=5]="INT32",c[c.UINT64=6]="UINT64",c[c.FLOAT32=7]="FLOAT32"})(G||(G={}));var Cc={[0]:!1,[1]:!0,[2]:!1,[3]:!0,[4]:!1,[5]:!0,[6]:!1,[7]:void 0},Xf={[0]:1,[1]:1,[2]:2,[3]:2,[4]:4,[5]:4,[6]:8,[7]:4},Qf={[0]:Uint8Array,[1]:Int8Array,[2]:Uint16Array,[3]:Int16Array,[4]:Uint32Array,[5]:Int32Array,[6]:Uint32Array,[7]:Float32Array},uE={[0]:1,[1]:1,[2]:1,[3]:1,[4]:1,[5]:1,[6]:2,[7]:1};var yn;(function(t){t[t.LITTLE=0]="LITTLE",t[t.BIG=1]="BIG"})(yn||(yn={}));function eW(){let n=Uint16Array.of(4386);return new Uint8Array(n.buffer)[0]===17?1:0}var ga=eW();function vn(n){let e=typeof n;if(e==="number"||e==="string"){let t=parseFloat(""+n);if(!Number.isNaN(t))return t}throw new Error(`Expected floating-point number, but received: ${JSON.stringify(n)}.`)}function Qe(n){let e=vn(n);if(Number.isFinite(e))return e;throw new Error(`Expected finite floating-point number, but received: ${e}.`)}function Zf(n){let e=vn(n);if(Number.isFinite(e)&&e>=0)return e;throw new Error(`Expected finite non-negative floating-point number, but received: ${e}.`)}function it(n){let e=Qe(n);if(e>0)return e;throw new Error(`Expected positive finite floating-point number, but received: ${e}.`)}function hd(n,e,t=vn){Z(e),n[0]=n[1]=n[2]=0;for(let r of Object.keys(e))switch(r){case"x":n[0]=t(e[r]);break;case"y":n[1]=t(e[r]);break;case"z":n[2]=t(e[r]);break;default:throw new Error(`Expected object to have keys ['x', 'y', 'z'], but received: ${JSON.stringify(e)}.`)}return n}function wc(n,e){let t=n.length;if(!Array.isArray(e)||e.length!==t)throw new Error("Incompatible sizes");for(let r=0;r<t;++r)if(!Number.isFinite(parseFloat(e[r])))throw new Error("Non-finite value.");for(let r=0;r<t;++r)n[r]=parseFloat(e[r]);return n}function Vv(n,e){let t=n.length;if(!Array.isArray(e)||e.length!==t)throw new Error("Incompatible sizes.");for(let r=0;r<t;++r){let i=parseInt(e[r],void 0);if(!Number.isInteger(i))throw new Error("Non-integer value.")}for(let r=0;r<t;++r)n[r]=parseInt(e[r],void 0);return n}function Bn(n){if(typeof n=="object"){if(n===null)return"null";if(Array.isArray(n)){let a="[",o=n.length,l=0;if(l<o)for(a+=Bn(n[l]);++l<o;)a+=",",a+=Bn(n[l]);return a+="]",a}let e="{",t=Object.keys(n).sort(),r=0,i=t.length;if(r<i){let a=t[r];for(e+=JSON.stringify(a),e+=":",e+=Bn(n[a]);++r<i;)e+=",",a=t[r],e+=JSON.stringify(a),e+=":",e+=Bn(n[a])}return e+="}",e}return JSON.stringify(n)}var dE=/('(?:[^'\\]|(?:\\.))*')/,pE=/("(?:[^"\\]|(?:\\.))*")/,tW=new RegExp(`${dE.source}|${pE.source}`),nW=new RegExp(`${pE.source}|${dE.source}`),rW=/^((?:[^"'\\]|(?:\\[^']))*)("|\\')/,iW=/^((?:[^"'\\]|(?:\\.))*)'/;function aW(n,e,t,r){if(n.length>=2&&n.charAt(0)===e&&n.charAt(n.length-1)===e){let i=n.substr(1,n.length-2),a=t;for(;i.length>0;){let o=i.match(r);if(o===null){a+=i;break}a+=o[1],o[2]===t?(a+="\\",a+=t):a+=e,i=i.substr(o.index+o[0].length)}return a+=t,a}return n}function oW(n,e,t){let r=/[&_,]/g,i,a,o;t==='"'?(i="'",a=rW,o=tW):(i='"',a=iW,o=nW);let l="";for(;n.length>0;){let c=n.match(o),d,p;if(c===null)d=n,n="",p="";else{d=n.substr(0,c.index),n=n.substr(c.index+c[0].length);let m=c[1];m!==void 0?p=aW(m,i,t,a):p=c[2]}l+=d.replace(r,e),l+=p}return l}function sW(n){return oW(n,",",'"')}function eh(n){return JSON.parse(sW(n))}function Yr(n,e){if(!Array.isArray(n))throw new Error(`Expected array, but received: ${JSON.stringify(n)}.`);if(e!==void 0&&n.length!==e)throw new Error(`Expected array of length ${e}, but received: ${JSON.stringify(n)}.`);return n}function ge(n,e){if(!Array.isArray(n))throw new Error(`Expected array, but received: ${JSON.stringify(n)}.`);return n.map(e)}function Ne(n,e,t){let r=n.length;if(!Array.isArray(e)||e.length!==r)throw new Error(`Expected length ${r} array, but received: ${JSON.stringify(e)}.`);for(let i=0;i<r;++i)n[i]=t(e[i],i);return n}function Z(n){if(typeof n!="object"||n==null||Array.isArray(n))throw new Error(`Expected JSON object, but received: ${JSON.stringify(n)}.`);return n}function rt(n){let e=parseInt(n,10);if(!Number.isInteger(e))throw new Error(`Expected integer, but received: ${JSON.stringify(n)}.`);return e}function St(n){let e=rt(n);if(e<=0)throw new Error(`Expected positive integer, but received: ${e}.`);return e}function fE(n){let e=rt(n);if(e<0)throw new Error(`Expected non-negative integer, but received: ${e}.`);return e}function th(n,e){let t=e.get(n);if(t===void 0)throw new Error(`Expected one of ${JSON.stringify(Array.from(e.keys()))}, but received: ${JSON.stringify(n)}.`);return t}function Q(n){if(typeof n!="string")throw new Error(`Expected string, but received: ${JSON.stringify(n)}.`);return n}function Wt(n){if(n!==void 0)return Q(n)}function li(n){if(n!==void 0)return rt(n)}function hE(n){if(n!==void 0){if(typeof n=="boolean")return n;if(n==="true")return!0;if(n==="false")return!1;throw new Error(`Expected string or boolean but received: ${JSON.stringify(n)}`)}}function W(n,e,t){let r=Object.prototype.hasOwnProperty.call(n,e)?n[e]:void 0;try{return t(r)}catch(i){throw new Error(`Error parsing ${JSON.stringify(e)} property: ${i.message}`)}}function oe(n,e,t,r){return W(n,e,i=>i===void 0?r:t(i))}function Za(n,e){Z(n);let t=new Map;for(let r of Object.keys(n))try{t.set(r,e(n[r]))}catch(i){throw new Error(`Error parsing value associated with key ${JSON.stringify(r)}: ${i.message}`)}return t}function nh(n){if(typeof n!="number"||!Number.isFinite(n)||n<0||n>1)throw new Error(`Expected floating point number in [0,1], but received: ${JSON.stringify(n)}.`);return n}function ci(n){if(n==="")return{};if(n.startsWith("{"))return eh(n);{let e={},t=n.split(/[&;]/);for(let r of t){let i=r.match(/^([^=&;]+)=([^&;]*)$/);if(i===null)throw new Error(`Invalid query string part: ${JSON.stringify(r)}.`);e[i[1]]=decodeURIComponent(i[2])}return e}}function mE(n){if(n===void 0)return"";let e=Object.keys(n);return e.length===0?"":e.some(t=>typeof n[t]!="string")?JSON.stringify(n):e.map(t=>`${encodeURIComponent(t)}=${encodeURIComponent(n[t])}`).join("&")}function Mt(n,e){if(typeof n=="string"&&n.match(/^[a-zA-Z]/)!==null&&(n=n.toUpperCase(),e.hasOwnProperty(n)))return e[n];throw new Error(`Invalid enum value: ${JSON.stringify(n)}.`)}function rh(n){return Ne(K.create(),n,Qe)}function gE(n){return Ne(K.create(),n,it)}function yE(n){return Ne(K.create(),n,St)}function qt(n){if(!Array.isArray(n))throw new Error(`Expected array, received: ${JSON.stringify(n)}.`);for(let e of n)if(typeof e!="string")throw new Error(`Expected string, received: ${JSON.stringify(e)}.`);return n}function vE(n){if(!Array.isArray(n))throw new Error(`Expected array, received: ${JSON.stringify(n)}.`);for(let e of n)if(!Number.isInteger(e))throw new Error(`Expected integer, received: ${JSON.stringify(e)}.`);return n}function ya(n){if(typeof n!="boolean")throw new Error(`Expected boolean, received: ${JSON.stringify(n)}`);return n}function Ri(n){for(let e in n)return n}var SE=2**-1074,Ov=new Float64Array(1),Wo=new Uint32Array(Ov.buffer);function bE(n,e){if(isNaN(n)||isNaN(e))return NaN;if(n===e)return e;if(n===0)return e<0?-SE:SE;Ov[0]=n;let t=ga===yn.LITTLE?0:1,r=1-t;return e>n==n>0?Wo[t]===4294967295?(Wo[t]=0,Wo[r]+=1):Wo[t]+=1:Wo[t]===0?(Wo[t]=4294967295,Wo[r]-=1):Wo[t]-=1,Ov[0]}var Nv=new Uint32Array(2),md=4294967296,Bv=[];for(let n=2;n<=36;++n){let e=Math.floor(32/Math.log2(n)),t=Math.pow(n,e),r=`^[0-${String.fromCharCode("0".charCodeAt(0)+Math.min(9,n-1))}`;n>10&&(r+=`a-${String.fromCharCode("a".charCodeAt(0)+n-11)}`,r+=`A-${String.fromCharCode("A".charCodeAt(0)+n-11)}`),r+=`]{1,${Math.ceil(64/Math.log2(n))}}$`;let a=new RegExp(r);Bv[n]={lowDigits:e,lowBase:t,pattern:a}}function xE(n,e){n>>>=0,e>>>=0;let t=n&65535,r=n>>>16,i=e&65535,a=e>>>16,l=(t*i>>>16)+r*i,c=l>>>16;l=(l&65535)+t*a,c+=l>>>16;let d=c>>>16;return c=(c&65535)+r*a,d+=c>>>16,((d&65535)<<16|c&65535)>>>0}var Kr=class{constructor(e=0,t=0){this.low=e;this.high=t}clone(){return new Kr(this.low,this.high)}assign(e){this.low=e.low,this.high=e.high}toString(e=10){let t=this.low,r=this.high;if(r===0)return t.toString(e);r*=md;let{lowBase:i,lowDigits:a}=Bv[e],o=r%i;r=Math.floor(r/i),t+=o,r+=Math.floor(t/i),t=t%i;let l=t.toString(e);return r.toString(e)+"0".repeat(a-l.length)+l}static less(e,t){return e.high<t.high||e.high===t.high&&e.low<t.low}static compare(e,t){return e.high-t.high||e.low-t.low}static equal(e,t){return e.low===t.low&&e.high===t.high}static min(e,t){return Kr.less(e,t)?e:t}static max(e,t){return Kr.less(e,t)?t:e}static random(){return crypto.getRandomValues(Nv),new Kr(Nv[0],Nv[1])}tryParseString(e,t=10){let{lowDigits:r,lowBase:i,pattern:a}=Bv[t];if(!a.test(e))return!1;if(e.length<=r)return this.low=parseInt(e,t),this.high=0,!0;let o=e.length-r,l=parseInt(e.substr(o),t),c=parseInt(e.substr(0,o),t),d,p;if(i===md)d=c,p=l;else{let m=Math.imul(c,i)>>>0;d=xE(c,i)+(Math.imul(Math.floor(c/md),i)>>>0),p=l+m,p>=md&&(++d,p-=md)}return p>>>0!==p||d>>>0!==d?!1:(this.low=p,this.high=d,!0)}parseString(e,t=10){if(!this.tryParseString(e,t))throw new Error(`Failed to parse string as uint64 value: ${JSON.stringify(e)}.`);return this}static parseString(e,t=10){return new Kr().parseString(e,t)}valid(){let{low:e,high:t}=this;return e>>>0===e&&t>>>0===t}toJSON(){return this.toString()}static lshift(e,t,r){let{low:i,high:a}=t;return r===0?(e.low=i,e.high=a):r<32?(e.low=i<<r,e.high=a<<r|i>>>32-r):(e.low=0,e.high=i<<r-32),e}static rshift(e,t,r){let{low:i,high:a}=t;return r===0?(e.low=i,e.high=a):r<32?(e.low=i>>>r|a<<32-r,e.high=a>>>r):(e.low=a>>>r-32,e.high=0),e}static or(e,t,r){return e.low=t.low|r.low,e.high=t.high|r.high,e}static xor(e,t,r){return e.low=t.low^r.low,e.high=t.high^r.high,e}static and(e,t,r){return e.low=t.low&r.low,e.high=t.high&r.high,e}static add(e,t,r){let i=t.low+r.low,a=t.high+r.high,o=i>>>0;return o!==i&&(a+=1),e.low=o,e.high=a>>>0,e}static addUint32(e,t,r){let i=t.low+r,a=t.high,o=i>>>0;return o!==i&&(a+=1),e.low=o,e.high=a>>>0,e}static decrement(e,t){let{low:r,high:i}=t;return r===0&&(i-=1),e.low=r-1>>>0,e.high=i>>>0,e}static increment(e,t){let{low:r,high:i}=t;return r===4294967295&&(i+=1),e.low=r+1>>>0,e.high=i>>>0,e}static subtract(e,t,r){let i=t.low-r.low,a=t.high-r.high,o=i>>>0;return o!==i&&(a-=1),e.low=o,e.high=a>>>0,e}static absDifference(e,t,r){return Kr.less(t,r)?Kr.subtract(e,r,t):Kr.subtract(e,t,r)}static multiplyUint32(e,t,r){let{low:i,high:a}=t;return e.low=Math.imul(i,r)>>>0,e.high=Math.imul(a,r)+xE(i,r)>>>0,e}static lowMask(e,t){return t===0?e.high=e.low=0:t<=32?(e.high=0,e.low=4294967295>>>32-t):(e.high=4294967295>>>t-32,e.low=4294967295),e}toNumber(){return this.low+this.high*4294967296}setFromNumber(e){e=Math.round(e),e<0?this.low=this.high=0:e>=18446744073709552e3?this.low=this.high=4294967295:(this.low=e%4294967296,this.high=Math.floor(e/4294967296))}static fromNumber(e){let t=new Kr;return t.setFromNumber(e),t}},X=Kr;X.ZERO=new Kr(0,0),X.ONE=new Kr(1,0);var Xr={[G.UINT8]:[0,255],[G.INT8]:[-128,127],[G.UINT16]:[0,65535],[G.INT16]:[-32768,32767],[G.UINT32]:[0,4294967295],[G.INT32]:[-2147483648,2147483647],[G.UINT64]:[X.ZERO,new X(4294967295,4294967295)],[G.FLOAT32]:[0,1]};function Or(n,e){if(typeof e=="number"){let t=n[0],r=n[1];return(e-t)/(r-t)}else{let t=n[0],r=n[1],i;X.compare(e,t)<0?i=-X.subtract(Qr,t,e).toNumber():i=X.subtract(Qr,e,t).toNumber();let a=X.absDifference(Qr,r,t).toNumber();return X.compare(t,r)>0&&(a*=-1),i/a}}function va(n,e,t){if(typeof n[0]=="number"){let r=n[0],i=n[1],a=r*(1-t)+i*t;if(e!==G.FLOAT32){let o=Xr[e];a=Math.round(a),a=Math.max(o[0],a),a=Math.min(o[1],a)}return a}else{let r=n[0],i=n[1];X.compare(r,i)>0&&([r,i]=[i,r],t=1-t);let a=X.subtract(Qr,i,r).toNumber(),o=new X;return t<=0?(Qr.setFromNumber(a*-t),X.subtract(o,r,X.min(Qr,r))):t>=1?(Qr.setFromNumber(a*(t-1)),X.add(o,i,Qr),X.less(o,i)&&(o.low=o.high=4294967295)):(Qr.setFromNumber(a*t),X.add(o,r,Qr),X.less(o,r)&&(o.low=o.high=4294967295)),o}}function Js(n,e){return typeof e=="number"?Math.min(Math.max(n[0],e),n[1]):X.min(X.max(n[0],e),n[1])}function qs(n,e){return[Js(n,e[0]),Js(n,e[1])]}function ih(n){if(yr(n[0],n[1])<=0)return n;throw new Error(`Invalid interval: [${n[0]}, ${n[1]}]`)}function ah(n){return yr(n[0],n[1])<=0?n:[n[1],n[0]]}function yr(n,e){return typeof n=="number"?n-e:X.compare(n,e)}var Qr=new X,lW=new X;function CE(n,e){return typeof e=="number"?Math.abs(e-n[0])<Math.abs(e-n[1])?0:1:X.less(X.absDifference(Qr,n[0],e),X.absDifference(lW,n[1],e))?0:1}function eo(n,e){let t;switch(typeof e!="string"?t=""+e:t=e,n){case G.UINT64:return X.parseString(t);case G.FLOAT32:{let r=parseFloat(t);if(!Number.isFinite(r))throw new Error(`Invalid float32 value: ${JSON.stringify(t)}`);return r}default:{let r=parseInt(t),i=Xr[n];if(!Number.isInteger(r)||r<i[0]||r>i[1])throw new Error(`Invalid ${G[n].toLowerCase()} value: ${JSON.stringify(t)}`);return r}}}function cW(n){if(typeof n=="number")return n;if(typeof n=="string"){let e=new X,t=Number(n);if(e.tryParseString(n))return t.toString()===e.toString()?t:e;if(!Number.isFinite(t))throw new Error(`Invalid value: ${JSON.stringify(n)}`);return t}throw new Error(`Invalid value: ${JSON.stringify(n)}`)}function Ys(n,e){return Ne(new Array(2),n,t=>eo(e,t))}function Uv(n){return Ne(new Array(2),n,e=>cW(e))}function ui(n,e,t){return n===G.UINT64?X.equal(e[0],t[0])&&X.equal(e[1],t[1]):e[0]===t[0]&&e[1]===t[1]}function gd(n,e,t=Xr[e]){if(!ui(e,n,t))return e===G.UINT64?[n[0].toString(),n[1].toString()]:n}function yd(n,e,t){switch(n){case G.FLOAT32:return bE(e,t*Infinity);case G.UINT64:let r=e;return t===-1?r.low===0&&r.high===0?r:X.decrement(new X,r):r.low===4294967295&&r.high===4294967295?r:X.increment(new X,r);default:{let i=Xr[n];return Math.max(i[0],Math.min(i[1],e+t))}}}function wE(n,e){switch(n){case G.FLOAT32:return 0;case G.UINT64:return .5/X.absDifference(Qr,e[0],e[1]).toNumber();default:return .5/Math.abs(e[0]-e[1])}}function Tc(n,e){switch(n){case G.FLOAT32:return 1;case G.UINT64:{let t=X.absDifference(Qr,e[0],e[1]).toNumber();return t/(t+1)}default:{let t=Math.abs(e[0]-e[1]);return t/(t+1)}}}function Lc(n,e){if(n===void 0)return Xr[e];let[t,r]=n;if(e===G.UINT64)return typeof t=="number"&&(t=X.fromNumber(t)),typeof r=="number"&&(r=X.fromNumber(r)),[t,r];if(typeof t!="number"&&(t=t.toNumber()),typeof r!="number"&&(r=r.toNumber()),e!==G.FLOAT32){t=Math.round(t),r=Math.round(r);let i=Xr[e];Number.isFinite(t)?t=Math.min(Math.max(i[0],t),i[1]):t=i[0],Number.isFinite(r)?r=Math.min(Math.max(i[0],r),i[1]):r=i[1]}return[t,r]}function di(n=128){let e=Math.ceil(n/32),t=new Uint32Array(e);crypto.getRandomValues(t);let r="";for(let i=0;i<e;++i)r+=("00000000"+t[i].toString(16)).slice(-8);return r}function TE(n){let e=new Uint8Array(n.buffer,n.byteOffset,n.byteLength),t=65536;for(let r=0,i=e.length;r<i;r+=t)crypto.getRandomValues(e.subarray(r,Math.min(i,r+t)));return n}function Fv(){let n=new Uint32Array(1);return crypto.getRandomValues(n),n[0]}var vd=class extends j{constructor(e){super();this.id=e;this.changed=new re}},Oe;(function(i){i[i.POINT=0]="POINT",i[i.LINE=1]="LINE",i[i.AXIS_ALIGNED_BOUNDING_BOX=2]="AXIS_ALIGNED_BOUNDING_BOX",i[i.ELLIPSOID=3]="ELLIPSOID"})(Oe||(Oe={}));var _i=[0,1,2,3],Sd={float32:G.FLOAT32,uint32:G.UINT32,int32:G.INT32,uint16:G.UINT16,int16:G.INT16,uint8:G.UINT8,int8:G.INT8,rgb:void 0,rgba:void 0},zo={rgb:{serializedBytes(){return 3},alignment(){return 1},serializeCode(n,e){return`dv.setUint16(${e}, ${n}, true);dv.setUint8(${e} + 2, ${n} >>> 16);`},deserializeCode(n,e){return`${n} = dv.getUint16(${e}, true) | (dv.getUint8(${e} + 2) << 16);`},deserializeJson(n){return Xa(ma(n))},serializeJson(n){return gn(Qa(n))}},rgba:{serializedBytes(){return 4},alignment(){return 1},serializeCode(n,e){return`dv.setUint32(${e}, ${n}, true);`},deserializeCode(n,e){return`${n} = dv.getUint32(${e}, true);`},deserializeJson(n){return Xa(Mv(n))},serializeJson(n){return gn(pd(n))}},float32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(n,e){return`dv.setFloat32(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getFloat32(${e}, isLittleEndian);`},deserializeJson(n){return vn(n)},serializeJson(n){return n}},uint32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(n,e){return`dv.setUint32(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getUint32(${e}, isLittleEndian);`},deserializeJson(n){return rt(n)},serializeJson(n){return n}},int32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(n,e){return`dv.setInt32(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getInt32(${e}, isLittleEndian);`},deserializeJson(n){return rt(n)},serializeJson(n){return n}},uint16:{serializedBytes(){return 2},alignment(){return 2},serializeCode(n,e){return`dv.setUint16(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getUint16(${e}, isLittleEndian);`},deserializeJson(n){return rt(n)},serializeJson(n){return n}},int16:{serializedBytes(){return 2},alignment(){return 2},serializeCode(n,e){return`dv.setInt16(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getInt16(${e}, isLittleEndian);`},deserializeJson(n){return rt(n)},serializeJson(n){return n}},uint8:{serializedBytes(){return 1},alignment(){return 1},serializeCode(n,e){return`dv.setUint8(${e}, ${n});`},deserializeCode(n,e){return`${n} = dv.getUint8(${e});`},deserializeJson(n){return rt(n)},serializeJson(n){return n}},int8:{serializedBytes(){return 2},alignment(){return 1},serializeCode(n,e){return`dv.setInt8(${e}, ${n});`},deserializeCode(n,e){return`${n} = dv.getInt8(${e});`},deserializeJson(n){return rt(n)},serializeJson(n){return n}}},uW=255;function Gv(n,e,t){let r=0,i=t.length,a=new Array(i),o=[];for(let g=0;g<i;++g)a[g]=g;let l=g=>zo[t[g].type].alignment(n);a.sort((g,v)=>l(v)-l(g));let c=0,d=new Array(i),p=e,m=()=>{p+=(4-p%4)%4,r+=p,o[c]=p,p=0,++c};for(let g=0;g<i;++g){let v=a[g],b=t[v],x=zo[b.type],C=x.serializedBytes(n),T=x.alignment(n),I=(T-p%T)%T,M=p+I+C;M+(4-M%4)%4<=uW?p+=I:m(),d[v]={offset:p,group:c},p+=C}return m(),{serializedBytes:r,offsets:d,propertyGroupBytes:o}}var oh=class{constructor(e,t,r){this.rank=e;this.firstGroupInitialOffset=t;this.propertySpecs=r;if(r.length===0){this.serializedBytes=t,this.serialize=this.deserialize=()=>{},this.propertyGroupBytes=[t];return}let{serializedBytes:i,offsets:a,propertyGroupBytes:o}=Gv(e,t,r);this.propertyGroupBytes=o;let l="let groupOffset0 = offset;";for(let m=1;m<o.length;++m)l+=`let groupOffset${m} = groupOffset${m-1} + ${o[m-1]}*annotationCount;`;for(let m=0;m<o.length;++m)l+=`groupOffset${m} += ${o[m]}*annotationIndex;`;let c=l,d=l,p=r.length;for(let m=0;m<p;++m){let{group:g,offset:v}=a[m],b=r[m],x=zo[b.type],C=`properties[${m}]`,T=`groupOffset${g} + ${v}`;c+=x.serializeCode(C,T,e),d+=x.deserializeCode(C,T,e)}this.serializedBytes=i,this.serialize=new Function("dv","offset","annotationIndex","annotationCount","isLittleEndian","properties",c),this.deserialize=new Function("dv","offset","annotationIndex","annotationCount","isLittleEndian","properties",d)}};function sh(n,e){let t=[];for(let r of _i){let i=Un[r];t[r]=new oh(n,i.serializedBytes(n),e)}return t}function Wv(n,e){let t=n.type==="float32"?e.toPrecision(6):e.toString(),{enumValues:r,enumLabels:i}=n;if(r!==void 0){let a=r.indexOf(e);if(a!==-1)return`${i[a]} (${t})`}return t}function LE(n,e){switch(n.type){case"rgb":return gn(Qa(e));case"rgba":return gn(pd(e));default:return Wv(n,e)}}function dW(n){let e=Q(n);if(e.match(/^[a-z][a-zA-Z0-9_]*$/)===null)throw new Error(`Invalid property identifier: ${JSON.stringify(n)}`);return e}function pW(n){if(Q(n),!Object.prototype.hasOwnProperty.call(zo,n))throw new Error("Unsupported property type: $JSON.stringify(obj)}");return n}function fW(n){let e=new Set;for(let t of n){if(e.has(t.identifier))throw new Error(`Duplicate property identifier: ${t.identifier}`);e.add(t.identifier)}}function hW(n){Z(n);let e=W(n,"id",dW),t=W(n,"type",pW),r=oe(n,"description",Q),i=oe(n,"default",l=>zo[t].deserializeJson(l),0),a,o;switch(t){case"rgb":case"rgba":break;default:{let l=G[t.toUpperCase()];a=oe(n,"enum_values",c=>ge(c,d=>eo(l,d))),a!==void 0&&(o=W(n,"enum_labels",c=>Ne(new Array(a.length),c,Q)))}}return{type:t,identifier:e,description:r,default:i,enumValues:a,enumLabels:o}}function mW(n){let e=n.default;return{id:n.identifier,description:n.description,type:n.type,default:e===0?void 0:zo[n.type].serializeJson(e)}}function kE(n){if(!(n===void 0||n.length===0))return n.map(mW)}function lh(n){if(n===void 0)return[];let e=ge(n,hW);return fW(e),e}function zv(n,e,t,r,i){for(let a=0;a<r;++a)n.setFloat32(e,i[a],t),e+=4;return e}function Hv(n,e,t,r,i,a){return e=zv(n,e,t,r,i),e=zv(n,e,t,r,a),e}function $v(n,e,t,r,i){for(let a=0;a<r;++a)i[a]=n.getFloat32(e,t),e+=4;return e}function jv(n,e,t,r,i,a){return e=$v(n,e,t,r,i),e=$v(n,e,t,r,a),e}var Un={[1]:{icon:"\uA579",description:"Line",toJSON(n){return{pointA:Array.from(n.pointA),pointB:Array.from(n.pointB)}},restoreState(n,e,t){n.pointA=W(e,"pointA",r=>Ne(new Float32Array(t),r,Qe)),n.pointB=W(e,"pointB",r=>Ne(new Float32Array(t),r,Qe))},serializedBytes(n){return 2*4*n},serialize(n,e,t,r,i){Hv(n,e,t,r,i.pointA,i.pointB)},deserialize:(n,e,t,r,i)=>{let a=new Float32Array(r),o=new Float32Array(r);return jv(n,e,t,r,a,o),{type:1,pointA:a,pointB:o,id:i,properties:[]}},visitGeometry(n,e){e(n.pointA,!1),e(n.pointB,!1)}},[0]:{icon:"\u26AC",description:"Point",toJSON:n=>({point:Array.from(n.point)}),restoreState:(n,e,t)=>{n.point=W(e,"point",r=>Ne(new Float32Array(t),r,Qe))},serializedBytes:n=>n*4,serialize:(n,e,t,r,i)=>{zv(n,e,t,r,i.point)},deserialize:(n,e,t,r,i)=>{let a=new Float32Array(r);return $v(n,e,t,r,a),{type:0,point:a,id:i,properties:[]}},visitGeometry(n,e){e(n.point,!1)}},[2]:{icon:"\u2751",description:"Bounding Box",toJSON:n=>({pointA:Array.from(n.pointA),pointB:Array.from(n.pointB)}),restoreState:(n,e,t)=>{n.pointA=W(e,"pointA",r=>Ne(new Float32Array(t),r,Qe)),n.pointB=W(e,"pointB",r=>Ne(new Float32Array(t),r,Qe))},serializedBytes:n=>2*4*n,serialize(n,e,t,r,i){Hv(n,e,t,r,i.pointA,i.pointB)},deserialize:(n,e,t,r,i)=>{let a=new Float32Array(r),o=new Float32Array(r);return jv(n,e,t,r,a,o),{type:2,pointA:a,pointB:o,id:i,properties:[]}},visitGeometry(n,e){e(n.pointA,!1),e(n.pointB,!1)}},[3]:{icon:"\u25CE",description:"Ellipsoid",toJSON:n=>({center:Array.from(n.center),radii:Array.from(n.radii)}),restoreState:(n,e,t)=>{n.center=W(e,"center",r=>Ne(new Float32Array(t),r,Qe)),n.radii=W(e,"radii",r=>Ne(new Float32Array(t),r,Zf))},serializedBytes:n=>2*4*n,serialize(n,e,t,r,i){Hv(n,e,t,r,i.center,i.radii)},deserialize:(n,e,t,r,i)=>{let a=new Float32Array(r),o=new Float32Array(r);return jv(n,e,t,r,a,o),{type:3,center:a,radii:o,id:i,properties:[]}},visitGeometry(n,e){e(n.center,!1),e(n.radii,!0)}}};function ch(n,e){let t=Un[n.type].toJSON(n,e.rank);t.type=Oe[n.type].toLowerCase(),t.id=n.id,t.description=n.description||void 0;let{relatedSegments:r}=n;if(r!==void 0&&r.some(i=>i.length!==0)&&(t.segments=r.map(i=>i.map(a=>a.toString()))),e.properties.length!==0){let i=e.properties;t.props=n.properties.map((a,o)=>zo[i[o].type].serializeJson(a))}return t}function gW(n,e,t=!1){Z(n);let r=W(n,"type",c=>Mt(c,Oe)),i=W(n,"id",t?Wt:Q)||uh(),a=W(n,"segments",c=>{if(c===void 0)return e.relationships.map(()=>[]);let d=Yr(c);return d.length===0?e.relationships.map(()=>[]):e.relationships.length===1&&!Array.isArray(d[0])?[ge(d,p=>X.parseString(p))]:ge(Yr(c,e.relationships.length),p=>ge(p,m=>X.parseString(m)))}),o=W(n,"props",c=>{let d=e.properties;return c===void 0?d.map(p=>p.default):ge(Yr(c,e.properties.length),(p,m)=>zo[d[m].type].deserializeJson(p))}),l={id:i,description:W(n,"description",Wt),relatedSegments:a,properties:o,type:r};return Un[r].restoreState(l,n,e.rank),l}var to=class extends j{constructor(e,t=[],r=[]){super();this.relationships=t;this.properties=r;this.annotationMap=new Map;this.changed=new re;this.readonly=!1;this.childAdded=new ze;this.childUpdated=new ze;this.childDeleted=new ze;this.pending=new Set;this.references=new Map;this.rank_=e,this.annotationPropertySerializers=sh(e,r)}get rank(){return this.rank_}hasNonSerializedProperties(){return!0}add(e,t=!0){if(this.ensureUpdated(),!e.id)e.id=uh();else if(this.annotationMap.has(e.id))throw new Error(`Annotation id already exists: ${JSON.stringify(e.id)}.`);return this.annotationMap.set(e.id,e),this.changed.dispatch(),this.childAdded.dispatch(e),t||this.pending.add(e.id),this.getReference(e.id)}commit(e){this.ensureUpdated();let t=e.id;this.pending.delete(t),this.changed.dispatch()}update(e,t){if(this.ensureUpdated(),e.value===null)throw new Error("Annotation already deleted.");e.value=t,this.annotationMap.set(t.id,t),e.changed.dispatch(),this.changed.dispatch(),this.childUpdated.dispatch(t)}[Symbol.iterator](){return this.ensureUpdated(),this.annotationMap.values()}get(e){return this.ensureUpdated(),this.annotationMap.get(e)}delete(e){e.value!==null&&(e.value=null,this.annotationMap.delete(e.id),this.pending.delete(e.id),e.changed.dispatch(),this.changed.dispatch(),this.childDeleted.dispatch(e.id))}getReference(e){let t=this.references.get(e);return t!==void 0?t.addRef():(t=new vd(e),t.value=this.annotationMap.get(e)||null,this.references.set(e,t),t.registerDisposer(()=>{this.references.delete(e)}),t)}ensureUpdated(){}toJSON(){this.ensureUpdated();let e=[],{pending:t}=this;for(let r of this)t.has(r.id)||e.push(ch(r,this));return e}clear(){this.annotationMap.clear(),this.pending.clear(),this.changed.dispatch()}restoreState(e){this.ensureUpdated();let{annotationMap:t}=this;t.clear(),this.pending.clear(),e!==void 0&&ge(e,r=>{let i=gW(r,this);t.set(i.id,i)});for(let r of this.references.values()){let{id:i}=r,a=t.get(i);r.value=a||null,r.changed.dispatch()}this.changed.dispatch()}reset(){this.clear()}},bd=class extends to{constructor(e,t,r){super(e.value.sourceRank,r,t);this.watchableTransform=e;this.curCoordinateTransform=e.value,this.registerDisposer(e.changed.add(()=>this.ensureUpdated()))}get rank(){return this.ensureUpdated(),this.rank_}ensureUpdated(){let e=this.watchableTransform.value,{curCoordinateTransform:t}=this;if(e===t)return;this.curCoordinateTransform=e;let r=e.sourceRank,i=t.sourceRank;if(i===r&&(t.inputSpace===e.inputSpace||xe(t.inputSpace.ids.slice(0,r),e.inputSpace.ids.slice(0,r))))return;let{ids:a}=e.inputSpace,o=t.inputSpace.ids,l=[];for(let d=0;d<r;++d){let p=o.indexOf(a[d]);p>=i&&(p=-1),l.push(p)}let c=d=>{let p=new Float32Array(r);for(let m=0;m<r;++m){let g=l[m];p[m]=g===-1?0:d[m]}return p};for(let d of this.annotationMap.values())switch(d.type){case 0:d.point=c(d.point);break;case 1:case 2:d.pointA=c(d.pointA),d.pointB=c(d.pointB);break;case 3:d.center=c(d.center),d.radii=c(d.radii);break}this.rank_!==r&&(this.rank_=r,this.annotationPropertySerializers=sh(this.rank_,this.properties)),this.changed.dispatch()}},yW="Data Bounds";function uh(){return di(160)}function vW(n){return{type:2,id:"data-bounds",description:yW,pointA:new Float32Array(n.lowerBounds),pointB:new Float32Array(n.upperBounds),properties:[]}}function Pn(n){let e=new to(n.lowerBounds.length);return e.readonly=!0,e.add(vW(n)),e}function SW(n,e){let t=0,r=[];for(let d of _i){let m=e[d].serializedBytes;r[d]=t;let v=n[d].length;t+=m*v}let i=[],a=[],o=new ArrayBuffer(t),l=new DataView(o),c=ga===yn.LITTLE;for(let d of _i){let p=e[d],{rank:m}=p,g=p.serialize,v=n[d];i[d]=v.map(I=>I.id),a[d]=new Map(v.map((I,P)=>[I.id,P]));let x=Un[d].serialize,C=r[d],T=p.propertyGroupBytes[0];for(let I=0,P=v.length;I<P;++I){let M=v[I];x(l,C+I*T,c,m,M),g(l,C,I,P,c,M.properties)}}return{data:new Uint8Array(o),typeToIds:i,typeToOffset:r,typeToIdMaps:a}}var Jv=class{constructor(e){this.propertySerializers=e;this.annotations=[[],[],[],[]]}add(e){this.annotations[e.type].push(e)}serialize(){return SW(this.annotations,this.propertySerializers)}};function qv(n){if(n==null)return n;let{relatedSegments:e}=n;if(e!==void 0)for(let t=0,r=e.length;t<r;++t){let i=e[t];i!==void 0&&(e[t]=i.map(a=>new X(a.low,a.high)))}return n}function We(n){let e=-1;return Object.assign(()=>{e===-1&&(e=requestAnimationFrame(()=>{e=-1,n()}))},{flush:()=>{e!==-1&&(e=-1,n())},cancel:()=>{e!==-1&&(cancelAnimationFrame(e),e=-1)}})}var dh=class{constructor(){this.map=new Map}get(e,t){let{map:r}=this,i=r.get(e);return i===void 0?(i=t(),i.registerDisposer(()=>{r.delete(e)}),r.set(e,i)):i.addRef(),i}},xd=class extends dh{get(e,t){return typeof e!="string"&&(e=Bn(e)),super.get(e,t)}getUncounted(e,t){return this.get(e,()=>new od(t())).value}};var bW=!1;function EE(n){let e={antialias:!1,stencil:!0};bW&&(console.log("DEBUGGING via preserveDrawingBuffer"),e.preserveDrawingBuffer=!0);let t=n.getContext("webgl2",e);if(t==null)throw new Error("WebGL not supported.");t.memoize=new dh,t.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),t.max3dTextureSize=t.getParameter(t.MAX_3D_TEXTURE_SIZE),t.maxTextureImageUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),t.tempTextureUnit=t.maxTextureImageUnits-1;for(let r of["EXT_color_buffer_float"])if(!t.getExtension(r))throw new Error(`${r} extension not available`);for(let r of["EXT_float_blend"])t.getExtension(r);return t}var kc=class{constructor(){this.width=0;this.height=0;this.logicalWidth=0;this.logicalHeight=0;this.visibleLeftFraction=0;this.visibleTopFraction=0;this.visibleWidthFraction=0;this.visibleHeightFraction=0}};function ph(n,e){let t=1/n.visibleWidthFraction,r=1/n.visibleHeightFraction,i=-1-(-1+2*n.visibleLeftFraction)*t,a=-1-(-1+2*n.visibleTopFraction)*r;a=-a,e[0]=e[0]*t+e[3]*i,e[4]=e[4]*t+e[7]*i,e[8]=e[8]*t+e[11]*i,e[12]=e[12]*t+e[15]*i,e[1]=e[1]*r+e[3]*a,e[5]=e[5]*r+e[7]*a,e[9]=e[9]*r+e[11]*a,e[13]=e[13]*r+e[15]*a}function fh(n,e){return n.width===e.width&&n.height===e.height&&n.logicalWidth===e.logicalWidth&&n.logicalHeight===e.logicalHeight&&n.visibleLeftFraction===e.visibleLeftFraction&&n.visibleTopFraction===e.visibleTopFraction}var hh=class extends j{constructor(e,t,r){super();this.context=e;this.element=t;this.visibility=r;this.boundsGeneration=-1;this.canvasRelativeClippedLeft=0;this.canvasRelativeClippedTop=0;this.canvasRelativeLogicalLeft=0;this.canvasRelativeLogicalTop=0;this.renderViewport=new kc;this.boundsObserversRegistered=!1;this.gl=e.gl,e.addPanel(this)}scheduleRedraw(){this.visible&&this.context.scheduleRedraw()}ensureBoundsUpdated(){let{context:e}=this;e.ensureBoundsUpdated();let{boundsGeneration:t}=e;if(t===this.boundsGeneration)return;this.boundsGeneration=t;let{element:r}=this;!this.boundsObserversRegistered&&e.monitorPanel(r)&&(this.boundsObserversRegistered=!0);let i=r.getBoundingClientRect(),a=e.container,o=e.canvasRect,{canvas:l}=e,{width:c,height:d}=l,p=c/o.width,m=d/o.height,g=o.left,v=o.top,b=this.canvasRelativeLogicalLeft=Math.round((i.left-g)*p+r.clientLeft),x=this.canvasRelativeLogicalTop=Math.round((i.top-v)*m+r.clientTop),C=r.clientWidth,T=r.clientHeight,I=b+C,P=x+T,M=x,D=b,E=I,V=P;for(let _=r.parentElement;_!==null&&_!==a;_=_.parentElement){let U=_.getBoundingClientRect();U.x===0&&U.y===0&&U.width===0&&U.height===0||(D=Math.max(D,(U.left-g)*p),M=Math.max(M,(U.top-v)*m),E=Math.min(E,(U.right-g)*p),V=Math.min(V,(U.bottom-v)*m))}M=this.canvasRelativeClippedTop=Math.round(Math.max(M,0)),D=this.canvasRelativeClippedLeft=Math.round(Math.max(D,0)),E=Math.round(Math.min(E,c)),V=Math.round(Math.min(V,d));let O=this.renderViewport,B=O.width=Math.max(0,E-D),z=O.height=Math.max(0,V-M);O.logicalWidth=C,O.logicalHeight=T,O.visibleLeftFraction=(D-b)/C,O.visibleTopFraction=(M-x)/T,O.visibleWidthFraction=B/C,O.visibleHeightFraction=z/T}setGLClippedViewport(){let{gl:e,canvasRelativeClippedTop:t,canvasRelativeClippedLeft:r,renderViewport:{width:i,height:a}}=this,o=t+a;e.enable(WebGL2RenderingContext.SCISSOR_TEST);let l=this.context.canvas.height-o;e.viewport(r,l,i,a),e.scissor(r,l,i,a)}setGLLogicalViewport(){let{gl:e,renderViewport:{width:t,height:r,logicalWidth:i,logicalHeight:a}}=this,o=this.context.canvas.height;e.enable(WebGL2RenderingContext.SCISSOR_TEST),e.viewport(this.canvasRelativeLogicalLeft,o-(this.canvasRelativeLogicalTop+a),i,a),e.scissor(this.canvasRelativeClippedLeft,o-(this.canvasRelativeClippedTop+r),t,r)}disposed(){this.boundsObserversRegistered&&this.context.unmonitorPanel(this.element),this.context.removePanel(this),super.disposed()}get visible(){return this.visibility.visible}getDepthArray(){}get shouldDraw(){if(!this.visible)return!1;let{element:e}=this;return!(e.clientWidth===0||e.clientHeight===0||e.offsetWidth===0||e.offsetHeight===0)}get drawOrder(){return 0}},mh=class extends hh{constructor(e,t,r){super(e,t,r);this.canvas=document.createElement("canvas");this.canvasRenderingContext=this.canvas.getContext("2d");let{canvas:i}=this;t.appendChild(i),t.style.position="relative",i.style.position="absolute",i.style.left="0",i.style.right="0",i.style.top="0",i.style.bottom="0"}draw(){this.drawIndirect();let{renderViewport:e,canvas:t}=this,{logicalWidth:r,logicalHeight:i}=e;t.width=r,t.height=i;let{canvasRenderingContext:a}=this;a==null||a.drawImage(this.context.canvas,this.canvasRelativeLogicalLeft,this.canvasRelativeLogicalTop,r,i,0,0,r,i)}},Yv=class extends Le{constructor(){super(Float64Array.of(0,0,1,1),e=>Ne(new Float64Array(4),e,nh))}toJSON(){let{value:e}=this,[t,r,i,a]=e;if(!(t===0&&r==0&&i===1&&a===1))return Array.from(e)}},Kv=class extends j{constructor(e){super();this.container=e;this.canvas=document.createElement("canvas");this.updateStarted=new re;this.updateFinished=new re;this.changed=this.updateFinished;this.panels=new Set;this.resizeGeneration=0;this.boundsGeneration=-1;this.orderedPanels=[];this.frameNumber=0;this.panelAncestors=new Map;this.resizeCallback=()=>{++this.resizeGeneration,this.scheduleRedraw()};this.resizeObserver=new ResizeObserver(this.resizeCallback);this.scheduleRedraw=this.registerCancellable(We(()=>this.draw()));let{canvas:t,resizeObserver:r}=this;e.style.position="relative",t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.width="100%",t.style.height="100%",t.style.zIndex="0",r.observe(t),e.appendChild(t),this.registerEventListener(t,"webglcontextlost",i=>{console.log(`Lost WebGL context: ${i.statusMessage}`),i.preventDefault()}),this.registerEventListener(t,"webglcontextrestored",()=>{console.log("WebGL context restored"),window.location.reload()}),this.gl=EE(t)}monitorPanel(e){let{panelAncestors:t,container:r}=this;if(!r.contains(e))return!1;for(;e!==r;){let i=t.get(e);if(i!==void 0){++i.count;break}let a=e.parentElement;i={parent:a,count:1},t.set(e,i),e.addEventListener("scroll",this.resizeCallback,{capture:!0}),this.resizeObserver.observe(e),e=a}return!0}unmonitorPanel(e){let{panelAncestors:t,container:r}=this;for(;e!==r;){let i=t.get(e);if(i.count!==1){--i.count;break}e.removeEventListener("scroll",this.resizeCallback,{capture:!0}),this.resizeObserver.unobserve(e),t.delete(e),e=i.parent}}applyWindowedViewportToElement(e,t){let[r,i,a,o]=t,l=1/a,c=1/o;e.style.position="absolute",e.style.top=`${-c*i*100}%`,e.style.left=`${-l*r*100}%`,e.style.width=`${l*100}%`,e.style.height=`${c*100}%`,++this.resizeGeneration,this.scheduleRedraw()}isReady(){for(let e of this.panels)if(!!e.visible&&!e.isReady())return!1;return!0}makeCanvasOverlayElement(){let e=document.createElement("div");return e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.width="100%",e.style.height="100%",e.style.zIndex="2",this.container.appendChild(e),e}disposed(){this.orderedPanels.length=0,this.resizeObserver.disconnect()}addPanel(e){this.panels.add(e),this.orderedPanels.length=0,++this.resizeGeneration,this.scheduleRedraw()}removePanel(e){this.panels.delete(e),this.orderedPanels.length=0,++this.resizeGeneration,this.scheduleRedraw()}ensureBoundsUpdated(){let{resizeGeneration:e}=this;if(this.boundsGeneration===e)return;let{canvas:t}=this;t.width=t.offsetWidth,t.height=t.offsetHeight,this.canvasRect=t.getBoundingClientRect(),this.boundsGeneration=e}draw(){++this.frameNumber,this.updateStarted.dispatch();let e=this.gl;this.ensureBoundsUpdated(),this.gl.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);let{orderedPanels:t,panels:r}=this;t.length!==r.size&&(t.push(...r),t.sort((i,a)=>i.drawOrder-a.drawOrder));for(let i of t){if(!i.shouldDraw)continue;i.ensureBoundsUpdated();let{renderViewport:a}=i;a.width===0||a.height===0||i.draw()}e.disable(e.SCISSOR_TEST),this.gl.clearColor(1,1,1,1),this.gl.colorMask(!1,!1,!1,!0),e.clear(e.COLOR_BUFFER_BIT),this.gl.colorMask(!0,!0,!0,!0),this.updateFinished.dispatch()}getDepthArray(){let{width:e,height:t}=this.canvas,r=new Float32Array(e*t);for(let i of this.panels){if(!i.shouldDraw)continue;let a=i.getDepthArray();if(a===void 0)continue;let{canvasRelativeClippedTop:o,canvasRelativeClippedLeft:l,renderViewport:{width:c,height:d}}=i;for(let p=0;p<d;++p){let m=(d-1-p)*c;r.set(a.subarray(m,m+c),(o+p)*c+l)}}return r}};function gh(n,e,t){let r=n.length;for(let i=0;i<r;++i)n[i]=e[i]+t[i];return n}function yh(n,e,t){let r=n.length;for(let i=0;i<r;++i)n[i]=e[i]-t[i];return n}function DE(n,e,t,r){let i=n.length;for(let a=0;a<i;++a)n[a]=e[a]+t[a]*r;return n}function PE(n,e,t){let r=n.length;for(let i=0;i<r;++i)n[i]=e[i]*t;return n}function Ec(n){let e=1;for(let t=0,r=n.length;t<r;++t)e*=n[t];return e}function IE(n,e,t){let r=n.length;for(let i=0;i<r;++i)n[i]=Math.min(e[i],t[i]);return n}var no=new Float32Array(0),Xv=new Float64Array(0),vY=Float64Array.of(1,1,1);var Cd=class extends kc{constructor(){super(...arguments);this.globalPosition=no;this.projectionMat=ae.create();this.viewMatrix=ae.create();this.invViewMatrix=ae.create();this.viewProjectionMat=ae.create();this.invViewProjectionMat=ae.create()}};function AE(n,e){return n.displayDimensionRenderInfo===e.displayDimensionRenderInfo&&fh(n,e)&&xe(n.globalPosition,e.globalPosition)&&xe(n.projectionMat,e.projectionMat)&&xe(n.viewMatrix,e.viewMatrix)}function vh(n){let{viewMatrix:e,viewProjectionMat:t}=n;ae.invert(e,n.invViewMatrix),ae.multiply(t,n.projectionMat,e),ae.invert(n.invViewProjectionMat,t)}function pi(n,e,t,r,i,a,o,l,c){for(let d=0;d<o;++d)for(let p=0;p<c;++p){let m=0;for(let g=0;g<l;++g)m+=t[d+r*g]*i[g+a*p];n[d+e*p]=m}return n}function xW(n,e,t){for(let r=0;r<t;++r){let i=e*r;n.fill(0,i,i+t),n[i+r]=1}return n}function Yt(n,e,t=e){return xW(new n(e*t),e,Math.min(e,t))}function wd(n,e,t=!0){let r=e.length,i=t?r+1:r,a=new n(i*(r+1));t&&(a[a.length-1]=1);for(let o=0;o<r;++o)a[(i+1)*o]=e[o];return a}function ME(n,e,t=!0){let r=e.length,i=t?r+1:r,a=Yt(n,i,r+1);for(let o=0;o<r;++o)a[i*r+o]=e[o];return a}function RE(n,e,t){for(let r=0;r<t;++r)for(let i=0;i<t;++i)if(n[r*e+i]!=(r===i?1:0))return!1;return!0}function Sh(n,e,t,r,i,a){for(let o=0;o<a;++o){let l=o*r,c=o*e;for(let d=0;d<i;++d)n[c+d]=t[l+d]}return n}function Td(n,e,t,r){Sh(n,e+1,t,r+1,r,r);for(let i=0;i<r;++i)n[(e+1)*e+i]=t[(r+1)*r+i];n[n.length-1]=1;for(let i=r;i<e;++i)n[(e+1)*i+i]=1;return n}var fi;function CW(n,e,t){let r=1;(fi===void 0||fi.length<t)&&(fi=new Uint32Array(t));for(let i=0;i<t;++i)fi[i]=i;for(let i=0;i<t;++i){let a=e*i,o=i;{let d=Math.abs(n[a+i]);for(let p=i+1;p<t;++p){let m=Math.abs(n[a+p]);m>d&&(d=m,o=p)}}if(i!==o){r*=-1;for(let d=0;d<t;++d){let p=e*d,m=n[p+i];n[p+i]=n[p+o],n[p+o]=m}{let d=fi[i];fi[i]=fi[o],fi[o]=d}}let l=n[a+i],c=1/l;r*=l;for(let d=0;d<t;++d)n[e*d+i]*=c;n[a+i]=c;for(let d=0;d<t;++d){if(d===i)continue;let p=-n[e*i+d];for(let m=0;m<t;++m){let g=e*m;n[g+d]+=p*n[g+i]}n[e*i+d]=p*c}}for(let i=0;i<t;++i){let a=fi[i];for(;a!==i;){let o=e*i,l=e*a;for(let d=0;d<t;++d){let p=o+d,m=l+d,g=n[p];n[p]=n[m],n[m]=g}let c=fi[i]=fi[a];fi[a]=a,a=c}}return r}function Dc(n,e,t,r,i){return Sh(n,e,t,r,i,i),CW(n,e,i)}function _E(n,e,t,r,i,a){for(let o=0;o<a;++o){let l=e*o,c=r*o;for(let d=0;d<i;++d)if(n[l+d]!==t[c+d])return!1}return!0}function Zr(n,e,t,r,i){for(let a=0;a<i;++a){let o=e[t*i+a];for(let l=0;l<i;++l)o+=e[t*l+a]*r[l];n[a]=o}return n}function bh(n,e,t,r,i){for(let a=0;a<i;++a){let o=0;for(let l=0;l<i;++l)o+=e[t*l+a]*r[l];n[a]=o}return n}function VE(n,e,t,r,i,a){let o=i.length;for(let l=0;l<o;++l){let c=i[l];for(let d=0;d<a;++d)n[d*e+l]=t[d*r+c]}return n}var xh=[{prefix:"Y",exponent:24,longPrefix:"yotta"},{prefix:"Z",exponent:21,longPrefix:"zetta"},{prefix:"E",exponent:18,longPrefix:"exa"},{prefix:"P",exponent:15,longPrefix:"peta"},{prefix:"T",exponent:12,longPrefix:"tera"},{prefix:"G",exponent:9,longPrefix:"giga"},{prefix:"M",exponent:6,longPrefix:"mega"},{prefix:"k",exponent:3,longPrefix:"kilo"},{prefix:"",exponent:0,longPrefix:""},{prefix:"m",exponent:-3,longPrefix:"milli"},{prefix:"\xB5",exponent:-6,longPrefix:"micro"},{prefix:"n",exponent:-9,longPrefix:"nano"},{prefix:"p",exponent:-12,longPrefix:"pico"},{prefix:"f",exponent:-15,longPrefix:"femto"},{prefix:"a",exponent:-18,longPrefix:"atto"},{prefix:"z",exponent:-21,longPrefix:"zepto"},{prefix:"y",exponent:-24,longPrefix:"yocto"}],Qv=[...xh,{prefix:"h",exponent:2,longPrefix:"hecto"},{prefix:"da",exponent:1,longPrefix:"deca"},{prefix:"d",exponent:-1,longPrefix:"deci"},{prefix:"c",exponent:-2,longPrefix:"centi"}],wW=[{prefix:"u",exponent:-6},...Qv],Pc=new Map;Pc.set("",{unit:"",exponent:0});var TW=new Map;for(let{prefix:n,exponent:e}of wW){TW.set(e,n);for(let t of["m","s","Hz","rad/s"])Pc.set(`${n}${t}`,{unit:t,exponent:e})}function Zv(n){let e=Math.log10(n),t=xh.length,r=AL(0,t,i=>xh[i].exponent<=e);return xh[Math.min(r,t-1)]}function eS(n,e,t={}){let{precision:r=6,elide1:i=!0}=t,a=n,o="";if(e!==""){let c=Zv(n);o=c.prefix,a=Ld(n,-c.exponent)}if(i&&a===1)return{scale:"",unit:e,prefix:o};let l;if(r!=0){a<1||a>=1e3?l=a.toPrecision(r):l=a.toFixed(r);let c=l.indexOf("e"),d,p;c!==-1?(d=l.substring(0,c),p=l.substring(c)):(d=l,p="");let m=d.match(/.*\.(?:[0-9]*[1-9])?(0+)$/);m!==null&&(d=d.substring(0,d.length-m[1].length),d.endsWith(".")&&(d=d.substring(0,d.length-1)),l=d+p)}else l=a.toString();return{scale:l,unit:e,prefix:o}}function Vi(n,e,t){let{scale:r,unit:i,prefix:a}=eS(n,e,t);return`${r}${a}${i}`}function Ho(n){if(n==="")return{scale:1,unit:""};let e=n.match(/^((?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?)?([µa-zA-Z]+)?$/);if(e===null)return;let t=e[1],r=t===void 0?1:Number(t);if(Number.isNaN(r))return;let i="";if(e[2]!==void 0){let a=Pc.get(e[2]);if(a===void 0)return;i=a.unit,a.exponent>0?r*=10**a.exponent:r/=10**-a.exponent}if(!(r<=0||!Number.isFinite(r)))return{scale:r,unit:i}}function Ch(n){let e=Pc.get(n);if(e===void 0)throw new Error(`Invalid unit: ${JSON.stringify(n)}`);return e}function Ld(n,e){return e>=0?n*10**e:n/10**-e}var LW=0;function Ks(){return++LW}function kW(n,e){return xe(n.lowerBounds,e.lowerBounds)&&xe(n.upperBounds,e.upperBounds)}function EW(n,e){return n===void 0?e===void 0:e===void 0?!1:n.explicit===e.explicit&&xe(n.coordinates,e.coordinates)&&xe(n.labels,e.labels)}function DW(n,e){let t=new Map;for(let r=0,i=n.length;r<i;++r)t.set(n[r],e[r]);return n=Array.from(t.keys()),n.sort((r,i)=>r-i),e=Array.from(n,r=>t.get(r)),{coordinates:n,labels:e}}function OE(n){if(n.length===1)return n[0];let e=new Map,t=!1;for(let a of n){a.explicit&&(t=!0);let{coordinates:o,labels:l}=a;for(let c=0,d=o.length;c<d;++c)e.set(o[c],l[c])}let r=Array.from(e.keys());r.sort((a,o)=>a-o);let i=Array.from(r,a=>e.get(a));return{explicit:t,coordinates:r,labels:i}}function NE(n){if(n=n.filter(e=>e!==void 0),n.length!==0)return OE(n)}function PW(n,e){return xe(n.transform,e.transform)&&kW(n.box,e.box)}function wh(n,e){return n.valid===e.valid&&n.rank===e.rank&&xe(n.names,e.names)&&xe(n.ids,e.ids)&&xe(n.timestamps,e.timestamps)&&xe(n.units,e.units)&&xe(n.scales,e.scales)&&id(n.boundingBoxes,e.boundingBoxes,PW)&&id(n.coordinateArrays,e.coordinateArrays,EW)}function Be(n){let{names:e,units:t,scales:r}=n,{valid:i=!0,rank:a=e.length,timestamps:o=e.map(()=>Number.NEGATIVE_INFINITY),ids:l=e.map((m,g)=>-g),boundingBoxes:c=[]}=n,{coordinateArrays:d=new Array(a)}=n,{bounds:p=AW(c,a)}=n;return{valid:i,rank:a,names:e,timestamps:o,ids:l,units:t,scales:r,boundingBoxes:c,bounds:p,coordinateArrays:d}}var ei=Be({valid:!1,names:[],units:[],scales:Xv,boundingBoxes:[]}),Oi=Be({valid:!0,names:[],units:[],scales:Xv,boundingBoxes:[]});function IW(n){let[e,t]=Yr(n,2),r=it(e),i=Q(t),a=Pc.get(i);if(a===void 0)throw new Error(`Invalid unit: ${JSON.stringify(i)}`);return{unit:a.unit,scale:Ld(r,a.exponent)}}function kd(n,e=!1){if(n===void 0)return ei;Z(n);let t=Dd(Object.keys(n),e),r=t.length,i=new Array(r),a=new Float64Array(r),o=new Array(r);for(let l=0;l<r;++l)W(n,t[l],c=>{if(Array.isArray(c)){let{unit:d,scale:p}=IW(c);i[l]=d,a[l]=p}else{Z(c);let d=W(c,"coordinates",vE),p=W(c,"labels",qt),m=d.length;if(m!==p.length)throw new Error(`Length of coordinates array (${m}) does not match length of labels array (${p.length})`);i[l]="",a[l]=1,o[l]={explicit:!0,...DW(d,p)}}});return Be({valid:!1,names:t,units:i,scales:a,coordinateArrays:o})}function tS(n){let{rank:e}=n;if(e===0)return;let{names:t,units:r,scales:i,coordinateArrays:a}=n,o={};for(let l=0;l<e;++l){let c=t[l],d=a[l];(d==null?void 0:d.explicit)?o[c]={coordinates:Array.from(d.coordinates),labels:d.labels}:o[c]=[i[l],r[l]]}return o}var Xs=class extends Ee{constructor(){super(ei)}toJSON(){return tS(this.value)}reset(){this.value=ei}restoreState(e){this.value=kd(e)}};function nS(n,e){let t=(n+e)/2;return Number.isFinite(t)||(t=Math.min(Math.max(0,n),e)),t}function BE(n,e){let{lowerBounds:t,upperBounds:r}=e,i=n.length;for(let a=0;a<i;++a)n[a]=nS(t[a],r[a]);return n}function Yn(n){let e=n.lowerBounds.length;return{box:n,transform:Yt(Float64Array,e,e+1)}}function rS(n,e,t){let{box:{lowerBounds:r,upperBounds:i},transform:a}=n,o=r.length,l=t,c=a[l*o+e],d=c,p=c,m=!1;for(let g=0;g<o;++g){let v=a[l*g+e];if(v===0)continue;let b=v*r[g],x=v*i[g];d+=Math.min(b,x),p+=Math.max(b,x),m=!0}if(!!m)return{lower:d,upper:p}}function AW(n,e){let t=new Float64Array(e),r=new Float64Array(e);t.fill(Number.NEGATIVE_INFINITY),r.fill(Number.POSITIVE_INFINITY);for(let i of n)for(let a=0;a<e;++a){let o=rS(i,a,e);if(o===void 0)continue;let{lower:l,upper:c}=o;t[a]=t[a]===Number.NEGATIVE_INFINITY?l:Math.min(t[a],l),r[a]=r[a]===Number.POSITIVE_INFINITY?c:Math.max(r[a],c)}return{lowerBounds:t,upperBounds:r}}function MW(n,e,t){let{transform:r,box:i}=n,a=t.length,o=i.lowerBounds.length,l=new Float64Array((o+1)*e);for(let c=0;c<a;++c){let d=t[c];if(d!==-1)for(let p=0;p<=o;++p)l[p*e+d]=r[p*a+c]}return{transform:l,box:i}}function iS(n,e){let t={lowerBounds:Float64Array.of(0),upperBounds:Float64Array.of(1)},r=new Float64Array(2*n);return r[e]=1,{transform:r,box:t}}function aS(n,e,t){if(e===t)return n;let{box:r}=n,i=r.lowerBounds.length,a=new Float64Array((i+1)*t);return Sh(a,t,n.transform,e,e,i+1),{box:r,transform:a}}function UE(n,e){let{rank:t,sourceRank:r}=n;if(t!==e.rank||r!==e.sourceRank)return!1;let{inputSpace:i}=n,{inputSpace:a}=e;return!xe(a.scales,i.scales)||!xe(a.units,i.units)||!xe(e.outputSpace.names,n.outputSpace.names)?!1:zE(n.transform,t,n.outputSpace.scales,e.transform,t,e.outputSpace.scales)}function xt(n){return{rank:n.rank,sourceRank:n.rank,inputSpace:n,outputSpace:n,transform:Yt(Float64Array,n.rank+1)}}function RW(n,e,t,r){let{transform:i,box:a}=n,o=n.box.lowerBounds.length,l=r.length,c=new Float64Array((o+1)*l);for(let d=0;d<l;++d){let p=r[d];for(let g=0;g<o;++g){let v=0;for(let b=0;b<l;++b){let x=t[b];v+=e[(l+1)*b+d]*i[l*g+b]*(x/p)}c[l*g+d]=v}let m=e[(l+1)*l+d];for(let g=0;g<l;++g){let v=t[g];m+=e[(l+1)*g+d]*i[l*o+g]*(v/p)}c[o*l+d]=m}return{transform:c,box:a}}function FE(n,e,t){return n.boundingBoxes.map(r=>RW(r,e,n.scales,t))}function oS(n,e,t){let r=Be({valid:n.valid,rank:t.rank,ids:t.ids,names:t.names,timestamps:t.timestamps,scales:t.scales,units:t.units,boundingBoxes:FE(n,e,t.scales),coordinateArrays:t.coordinateArrays});return wh(r,t)?t:r}function sS(n,e=!1){if(e){let t=Number(n);if(Number.isInteger(t)&&t>=0)return!0}return n.match(/^[a-zA-Z][a-zA-Z_0-9]*['^]?$/)!==null}function Ic(n,e=!1){let t=new Set;for(let r of n){if(!sS(r,e)||t.has(r))return!1;t.add(r)}return!0}function Ed(n){let e=n.length,t=new Array(e);t.fill(!0);for(let r=0;r<e;++r){let i=n[r];if(!sS(i)){t[r]=!1;continue}let a=n.indexOf(i,r+1);a!==-1&&(t[r]=!1,t[a]=!1)}return t}function $o(n){return n.endsWith("'")}function lS(n){return n.endsWith("'")||n.endsWith("^")}function GE(n){return n.endsWith("^")}function WE(n){return!lS(n)}function _W(n,e,t){let r=new Float64Array(n),i=e.length,a=(i+1)*i;for(let o=0;o<i;++o)r[a+o]*=e[o]/t[o];return r}function zE(n,e,t,r,i,a){if(!_E(n,e+1,r,i+1,e,e))return!1;for(let o=0;o<e;++o){let l=n[(e+1)*e+o],c=r[(i+1)*i+o];if(l*(t[o]/a[o])!==c)return!1}for(let o=e;o<i;++o)if(r[(i+1)*i+o]!==0)return!1;for(let o=e;o<i;++o){for(let l=0;l<e;++l)if(r[(i+1)*l+o]!==0)return!1;for(let l=0;l<i;++l){let c=r[(i+1)*o+l];if(o===l){if(c!==1)return!1}else if(c!==0)return!1}}return!0}function VW(n,e){if(!e.includes(n))return n;let[,t,r]=n.match(/^([^']*)('?)$/);for(let i=0;;++i){let a=`${t}${i}${r}`;if(!e.includes(a))return a}}function OW(n,e){let{inputSpace:t,transform:r}=n,{ids:i,rank:a}=t,{rank:o,names:l,units:c,scales:d}=e,p=new Array(a);p.fill(!0);let m=[],g=e.ids.map((J,ie)=>{let pe=i.indexOf(J);return pe!==-1?p[pe]=!1:m.push(ie),pe}),{outputSpace:v}=n,{names:b,units:x,scales:C,ids:T,timestamps:I,coordinateArrays:P}=v,M=p,D=[],E=[],V=new Float64Array(o),O=[],B=[],z=new Array(o),_=0,U=new Float64Array((o+1)**2);U[U.length-1]=1;for(let J=0;J<a;++J)if(!M[J]){D[_]=b[J],O[_]=T[J],E[_]=x[J],V[_]=C[J],B[_]=I[J],z[_]=P[J];for(let ie=0;ie<o;++ie){let pe=g[ie];pe!==-1&&(U[ie*(o+1)+_]=r[pe*(a+1)+J])}U[o*(o+1)+_]=r[a*(a+1)+J],++_}for(let J of m)O[_]=Ks(),D[_]=VW(l[J],D),V[_]=d[J],E[_]=c[J],U[J*(o+1)+_]=1,++_;let N=Be({valid:e.valid,rank:o,names:D,ids:O,timestamps:B,units:E,scales:V,boundingBoxes:FE(e,U,V),coordinateArrays:z});return{rank:o,sourceRank:n.sourceRank,inputSpace:e,outputSpace:N,transform:U}}function HE(n){let e=oS(n.inputSpace,n.transform,n.outputSpace);return e===n.outputSpace?n:{rank:n.rank,sourceRank:n.sourceRank,inputSpace:n.inputSpace,transform:n.transform,outputSpace:e}}var Th=class{constructor(e,t=!1){this.mutableSourceRank=t;this.value_=void 0;this.changed=new re;this.inputSpaceChanged=new re;this.defaultTransform=HE(e);let r=this;this.outputSpace={changed:r.changed,get value(){return r.value.outputSpace},set value(i){let{value:a}=r;if(wh(a.outputSpace,i)||a.rank!==i.rank)return;let o=_W(a.transform,a.outputSpace.scales,i.scales);r.value_={sourceRank:a.sourceRank,rank:a.rank,inputSpace:a.inputSpace,outputSpace:oS(a.inputSpace,o,i),transform:o},r.changed.dispatch()}},this.inputSpace={changed:r.inputSpaceChanged,get value(){return r.value.inputSpace},set value(i){let{value:a}=r;wh(a.inputSpace,i)||(r.value_=OW(a,i),r.inputSpaceChanged.dispatch(),r.changed.dispatch())}}}set value(e){let t=this.value;e!==t&&(this.value_=HE(e),e.inputSpace!==t.inputSpace&&this.inputSpaceChanged.dispatch(),this.changed.dispatch())}get value(){let{value_:e}=this;return e===void 0&&(e=this.value_=this.defaultTransform),e}reset(){this.value_!==this.defaultTransform&&(this.value_=this.defaultTransform,this.inputSpaceChanged.dispatch(),this.changed.dispatch())}get defaultInputSpace(){return this.defaultTransform.inputSpace}get spec(){let{value:e}=this,{rank:t,transform:r,inputSpace:i,outputSpace:a,sourceRank:o}=e,{defaultTransform:l,mutableSourceRank:c}=this,{inputSpace:d,rank:p,transform:m,outputSpace:g}=l,{units:v,scales:b}=i,x=o===t&&xe(b,c?a.scales:d.scales)&&xe(v,c?a.units:d.units),C=zE(m,p,g.scales,r,t,a.scales),T=xe(g.names,a.names);if(!(C&&T&&x))return{sourceRank:o,transform:C?void 0:r,outputSpace:e.outputSpace,inputSpace:x?void 0:i}}set transform(e){let{value:t}=this,{inputSpace:r}=t;this.value_={rank:t.rank,sourceRank:t.sourceRank,inputSpace:r,transform:e,outputSpace:oS(r,e,t.outputSpace)},this.changed.dispatch()}set spec(e){if(e===void 0){this.reset();return}if(this.mutableSourceRank){let _=e.inputSpace||e.outputSpace,U=_.rank,N=Be({rank:U,names:_.names.map((J,ie)=>`${ie}`),units:_.units,scales:_.scales,coordinateArrays:_.coordinateArrays});this.value={rank:U,transform:e.transform||Yt(Float64Array,U+1),sourceRank:e.sourceRank,outputSpace:e.outputSpace,inputSpace:N};return}let{inputSpace:t,sourceRank:r,outputSpace:i,transform:a,rank:o}=this.defaultTransform,{inputSpace:l,sourceRank:c,outputSpace:d,transform:p}=e,m=e.outputSpace.rank,g=t.names,v=l!==void 0?l.names:g,b=new Array(r);for(let _=0;_<r;++_){let U=v.indexOf(g[_]);U>=c&&(U=-1),b[_]=U}let x=m-c+r;for(let _=c;_<m;++_)b[r+_-c]=_;let C=new Float64Array(x),T=new Array(x),I=[];for(let _=0;_<r;++_){let U=b[_];U===-1||l===void 0?(C[_]=t.scales[_],I[_]=t.units[_],T[_]=t.coordinateArrays[_]):(C[_]=l.scales[U],I[_]=l.units[U],T[_]=NE([t.coordinateArrays[_],l.coordinateArrays[U]]))}let P=l||d,M=g.slice(0,r),D=i.names.slice(0,r),E=i.coordinateArrays.slice(0,r),V=new Float64Array(x),O=[];for(let _=0;_<x;++_){let U=b[_];U===-1?(V[_]=i.scales[_],O[_]=i.units[_],E[_]=i.coordinateArrays[_]):(D[_]=d.names[U],O[_]=d.units[U],V[_]=d.scales[U],E[_]=d.coordinateArrays[U])}if(!Ic(D)){this.reset();return}for(let _=r;_<x;++_){let U=_-r+c;C[_]=P.scales[U],I[_]=P.units[U],M[_]=`${_}`}let B=new Float64Array((x+1)**2);B[B.length-1]=1;for(let _=0;_<x;++_){let U=b[_],N;U===-1||p===void 0?_>=r?N=0:N=a[o*(o+1)+_]*(i.scales[_]/V[_]):N=p[m*(m+1)+U],B[x*(x+1)+_]=N;for(let J=0;J<x;++J){let ie=b[J],pe;U===-1!=(ie===-1)?pe=0:U===-1||p===void 0?U>=r||ie>=r?pe=U===ie?1:0:pe=a[J*(o+1)+_]:pe=p[ie*(m+1)+U],B[J*(x+1)+_]=pe}}let z=t.boundingBoxes.map(_=>aS(_,o,x));for(let _=r;_<x;++_)z.push(iS(x,_));for(let _=0;_<x;++_){if(B[x*(x+1)+_]!==0)continue;let N;for(let ie=0;ie<x;++ie){let pe=B[ie*(x+1)+_];if(pe!==0)if(pe===1)if(N===void 0)N=ie;else{N=null;break}else{N=null;break}}if(N==null)continue;let J=T[N];J!==void 0&&(J.explicit&&(J={...J,explicit:!1}),E[_]=NE([J,E[_]]))}this.value={rank:x,transform:B,sourceRank:r,outputSpace:Be({rank:x,names:D,scales:V,units:O,coordinateArrays:E}),inputSpace:Be({rank:x,names:M,scales:C,units:I,coordinateArrays:T,boundingBoxes:z})}}toJSON(){return uS(this.spec)}restoreState(e){this.spec=cS(e)}};function NW(n,e=!1){let t=Q(n);if(!sS(t,e))throw new Error(`Invalid dimension name: ${JSON.stringify(t)}`);return t}function Dd(n,e=!1){let t=ge(n,r=>NW(r,e));if(!Ic(t,e))throw new Error(`Invalid dimensions: ${JSON.stringify(t)}`);return t}var Ac=class{constructor(e,t){this.combined=e;this.bindings=new Set;this.retainCount=0;this.prevCombined=this.combined.value;this.dimensionRefCounts=new Map;this.handleCombinedChanged=()=>{this.combined.value!==this.prevCombined&&this.update()};this.includeDimensionPredicate_=t}getRenameValidity(e){let t=this.combined.value.names,r=Ed(e),i=e.length;for(let a=0;a<i;++a){if(!r[a])continue;let o=e[a];if(t.includes(o))continue;let l=!0;for(let c of this.bindings)if(c.space.value.names.includes(o)){l=!1;break}r[a]=l}return r}get includeDimensionPredicate(){return this.includeDimensionPredicate_}set includeDimensionPredicate(e){this.includeDimensionPredicate_=e,this.update()}update(){let{combined:e,bindings:t}=this,r=this.retainCount>0?1:0;if(t.size===0&&!r){e.value=ei;return}let i=this.includeDimensionPredicate_,a=e.value,o=Array.from(a.names),l=Array.from(a.units),c=Array.from(a.scales),d=Array.from(a.ids),p=Array.from(a.timestamps),m=a.names.map(()=>r?1:0),g=[],v=!1;for(let D of t){let{space:{value:E},prevValue:V,mappedDimensionIds:O}=D;v=v||E.valid;let{names:B,units:z,scales:_,ids:U,timestamps:N}=E,J=[],ie=[];g.push(ie),D.mappedDimensionIds=J,D.prevValue=E;let pe=B.length;for(let me=0;me<pe;++me){let Pe=B[me];if(!i(Pe))continue;if(V!==void 0){let Re=U[me],Ue=V.ids.indexOf(Re);if(Ue!==-1){let et=O[Ue];if(et!==void 0){let ye=d.indexOf(et);if(ye!==-1){J[me]=et,++m[ye],ie[me]=ye;let ke=N[me];ke!==void 0&&!(ke<=p[ye])&&(o[ye]=Pe,c[ye]=_[me],l[ye]=z[me],p[ye]=ke);continue}}}}let le=o.indexOf(Pe);if(le!==-1){J[me]=d[le],++m[le],ie[me]=le;continue}le=o.length,ie[me]=le,m[le]=1+r,o[le]=Pe,l[le]=z[me],c[le]=_[me],p[le]=N[me];let we=Ks();d[le]=we,J[me]=we}}let{dimensionRefCounts:b}=this;b.clear();let x=0,C=o.length;for(let D of t){let{space:{value:E}}=D,V=g[x++],{rank:O}=E,B=Array.from(E.names),z=Array.from(E.timestamps),_=Float64Array.from(E.scales),U=Array.from(E.units);for(let N=0;N<O;++N){let J=V[N];J!==void 0&&(U[N]=l[J],_[N]=c[J],z[N]=p[J],B[N]=o[J])}for(let N of B){let J=b.get(N);J===void 0?J=1:++J,b.set(N,J)}if(!xe(U,E.units)||!xe(_,E.scales)||!xe(B,E.names)||!xe(z,E.timestamps)){let N=Be({valid:E.valid,ids:E.ids,scales:_,units:U,names:B,timestamps:z,boundingBoxes:E.boundingBoxes,coordinateArrays:E.coordinateArrays});D.prevValue=N,D.space.value=N}}{for(let E=0;E<C;++E)i(o[E])||(m[E]=0);let D=(E,V)=>m[V]!==0;o=o.filter(D),l=l.filter(D),c=c.filter(D),d=d.filter(D),p=p.filter(D),m=m.filter(D),C=o.length}let T=[],I=new Array(C);for(let D=0,E=a.rank;D<E;++D){let V=a.coordinateArrays[D];if(!(V==null?void 0:V.explicit))continue;let O=d.indexOf(a.ids[D]);O!==-1&&(I[O]=[V])}for(let D of t){let{space:{value:E}}=D,{rank:V,boundingBoxes:O,coordinateArrays:B}=E,z=E.names.map(_=>o.indexOf(_));for(let _ of O)T.push(MW(_,C,z));for(let _=0;_<V;++_){let U=B[_];if(U===void 0)continue;let N=z[_],J=I[N];J===void 0?I[N]=[U]:J.push(U)}}let P=new Array(C);for(let D=0;D<C;++D){let E=I[D];E!==void 0&&(P[D]=OE(E))}let M=Be({valid:v,ids:d,names:o,units:l,scales:new Float64Array(c),boundingBoxes:T,coordinateArrays:P});if(r)for(let D=0;D<C;++D)--m[D];wh(a,M)||(this.prevCombined=M,e.value=M)}retain(){return++this.retainCount,()=>{--this.retainCount==0&&this.update()}}bind(e){let t={space:e,mappedDimensionIds:[],prevValue:void 0},{bindings:r}=this;r.size===0&&this.combined.changed.add(this.handleCombinedChanged),r.add(t);let i=e.changed.add(()=>{e.value!==t.prevValue&&this.update()}),a=()=>{i();let{bindings:o}=this;o.delete(t),o.size===0&&this.combined.changed.remove(this.handleCombinedChanged),this.update()};return this.update(),a}};function Lh(n,e,t,r,i){let a=i.length,o=new n((a+1)**2);o[o.length-1]=1;for(let l=0;l<a;++l){let c=r[l];o[(a+1)*a+l]=e[(t+1)*t+c];for(let d=0;d<a;++d){let p=i[d];o[(a+1)*d+l]=e[(t+1)*p+c]}}return o}function $E(n){if(n===void 0)return;let e=new Float64Array(16);if(Array.isArray(n))if(n.length===16)for(let t=0;t<4;++t)for(let r=0;r<4;++r)e[t*4+r]=Qe(n[r*4+t]);else{Yr(n,4);for(let t=0;t<4;++t){let r=Yr(n[t],4);for(let i=0;i<4;++i)e[i*4+t]=Qe(r[i])}}else{Z(n);let t=Ke.create(),r=K.create(),i=K.fromValues(1,1,1);oe(n,"rotation",o=>{wc(t,o),Ke.normalize(t,t)}),oe(n,"translation",o=>{wc(r,o)}),oe(n,"scale",o=>{wc(i,o)});let a=ae.create();ae.fromRotationTranslationScale(a,t,r,i),e.set(a)}return{sourceRank:3,transform:e,outputSpace:Be({valid:!0,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)}),inputSpace:void 0}}function cS(n){if(n===void 0)return;let e=Z(n),t=W(e,"outputDimensions",kd),r=t.rank,i=W(e,"sourceRank",l=>{if(l===void 0)return r;if(!Number.isInteger(l)||l<0||l>r)throw new Error(`Expected integer in range [0, ${r}] but received: ${JSON.stringify(l)}`);return l}),a=oe(e,"inputDimensions",l=>{let c=kd(l,!0);if(c.rank!==r)throw new Error(`Expected rank of ${r}, but received rank of: ${c.rank}`);return c});return{transform:oe(e,"matrix",l=>{let c=new Float64Array((r+1)**2),d=Yr(l,r);c[c.length-1]=1;for(let p=0;p<r;++p)try{let m=Yr(d[p],r+1);for(let g=0;g<=r;++g)c[(r+1)*g+p]=Qe(m[g])}catch(m){throw new Error(`Error in row ${p}: ${m.message}`)}return c}),outputSpace:t,inputSpace:a,sourceRank:i}}function uS(n){if(n===void 0)return;let{transform:e,outputSpace:t,inputSpace:r,sourceRank:i}=n,a,o=t.rank;if(e!==void 0){a=[];for(let l=0;l<o;++l){let c=[];a[l]=c;for(let d=0;d<=o;++d)c[d]=e[(o+1)*d+l]}}return{sourceRank:i===o?void 0:i,matrix:a,outputDimensions:tS(t),inputDimensions:r===void 0?void 0:tS(r)}}function BW(n,e,t){let{box:r,transform:i}=n,a=n.box.lowerBounds.length,o=e.length,l=new Float64Array((a+1)*o);if(VE(l,o,i,t,e,a+1),!l.every(c=>c===0))return{transform:l,box:r}}function kh(n,e){let{ids:t,names:r,scales:i,units:a,timestamps:o,coordinateArrays:l}=n;return Be({rank:e.length,valid:n.valid,ids:e.map(c=>t[c]),names:e.map(c=>r[c]),timestamps:e.map(c=>o[c]),scales:Float64Array.from(e,c=>i[c]),units:e.map(c=>a[c]),coordinateArrays:e.map(c=>l[c]),boundingBoxes:n.boundingBoxes.map(c=>BW(c,e,n.rank)).filter(c=>c!==void 0)})}function Eh(n,e,t){return e===t?n:kh(n,RL(n.rank,t,e))}function dS(n,e){let{transform:t,rank:r}=n,i=js(t,r,[e]);if(i.length!==1)return;let[a]=i,o=Math.abs(t[(r+1)*a+e]),{inputSpace:l}=n;return{scale:l.scales[a]*o,unit:l.units[a]}}function pS(n,e){let{scales:t,units:r}=n.defaultInputSpace;return e<t.length?{scale:t[e],unit:r[e]}:void 0}var ZY={channelCoordinateSpace:Oi,shape:new Uint32Array(0),numChannels:1,coordinates:new Uint32Array(0)};function jE(n){let{rank:e}=n,{bounds:{lowerBounds:t,upperBounds:r}}=n;if(t.some(l=>l!==0))throw new Error("Lower bounds of channel coordinate space must all be 0");if(r.some(l=>!Number.isInteger(l)||l<=0||l>=2**32))throw new Error("Upper bounds of channel coordinate space must all be positive integers");let i=new Uint32Array(r),a=Ec(i),o=new Uint32Array(a*e);for(let l=0;l<a;++l){let c=l;for(let d=0;d<e;++d){let p=c%i[d];c=(c-p)/i[d],o[l*e+d]=p}}return{channelCoordinateSpace:n,shape:i,numChannels:a,coordinates:o}}function fS(n,e,t,r,i,a){let{scales:o}=t,{scales:l,rank:c}=i,d=e+1;for(let p=0;p<c;++p){let m=a[p];if(m===-1)continue;let g=l[p];for(let v=0;v<e;++v){let b=r[v],x=o[b];n[d*v+m]*=x/g}}}function UW(n,e,t,r,i=Oi){let{inputSpace:a,rank:o,sourceRank:l,outputSpace:c,transform:d}=t,{names:p}=a,{names:m}=c,g;if(r!==void 0)g=Array.from(r.modelSubspaceDimensionIndices);else{g=[];for(let z=0;z<l;++z)g[z]=z}let v=g.length;for(let z=l;z<o;++z)g.push(z);let b=js(t.transform,o,g,!0),x=g.length,C=g.map(z=>p[z]||`${z}`),T=b.map(z=>m[z]);if(x!==b.length)return{error:"Rank mismatch between model subspace dimensions ("+C.join(", ")+") and corresponding layer/global dimensions ("+T.join(", ")+")"};let I=Lh(Float32Array,d,o,b,g),P=b.map(z=>m[z]),M=e.names.map(z=>P.indexOf(z)),D=n.names.map(z=>P.indexOf(z));fS(I,x,a,g,n,D),fS(I,x,a,g,e,M);let E=i.names.map(z=>P.indexOf(z));fS(I,x,a,g,i,E);let V=[],O=i.rank;if(r!==void 0){let{subsourceToModelSubspaceTransform:z}=r;v!==x&&(z=Td(new Float32Array((x+1)**2),x,z,v)),I=pi(new Float32Array((x+1)**2),x+1,I,x+1,z,x+1,x+1,x+1,x+1)}let B=new Uint32Array(O);for(let z=0;z<O;++z){let _=i.bounds.lowerBounds[z],U=i.bounds.upperBounds[z];if(_!==0||!Number.isInteger(U)||U<=0||U>=2**32)return{error:`Channel dimension ${i.names[z]} must have lower bound of 0 and positive integer upper bound`};B[z]=U;let N=E[z],J=-1;if(N!==-1)for(let ie=0;ie<x;++ie){let pe=I[N+ie*(x+1)];if(pe!==0){if(pe!==1||J!==-1)return{error:`Channel dimension ${T[N]} must map to a single source dimension`};J=ie}}V[z]=J}return{rank:x,unpaddedRank:v,modelDimensionNames:C,layerDimensionNames:T,localToRenderLayerDimensions:M,globalToRenderLayerDimensions:D,channelToRenderLayerDimensions:E,modelToRenderLayerTransform:I,channelToModelDimensions:V,channelSpaceShape:B}}function FW(n,e){return n===e?!0:n.error!==void 0||e.error!==void 0?!1:xe(n.modelDimensionNames,e.modelDimensionNames)&&xe(n.layerDimensionNames,e.layerDimensionNames)&&xe(n.globalToRenderLayerDimensions,e.globalToRenderLayerDimensions)&&xe(n.localToRenderLayerDimensions,e.localToRenderLayerDimensions)&&xe(n.channelToRenderLayerDimensions,e.channelToRenderLayerDimensions)&&xe(n.modelToRenderLayerTransform,e.modelToRenderLayerTransform)&&xe(n.channelSpaceShape,e.channelSpaceShape)}function Dh(n,e,t,r,i){return At((a,o,l,c)=>UW(a,o,l,r,c),[n,e,t,i===void 0?Rr(void 0):i],FW)}function JE(n,e,t,r){let{globalToRenderLayerDimensions:i}=t;for(let a=0;a<3;++a){let o=0,l=r[a];if(l!==-1){let c=i[l];c!==-1&&(o=e[c])}n[a]=o}}function qE(n,e,t,r){let{globalToRenderLayerDimensions:i}=t;for(let a=0;a<3;++a){let o=r[a];if(o!==-1){let l=i[o];l!==-1&&(n[l]=e[a])}}}function Qs(n,e){let t=n.rank,r=n.unpaddedRank,i;r!==t&&e!==void 0&&(e=Td(new Float32Array((t+1)**2),t,e,r)),e!==void 0?(i=new Float32Array((t+1)*(t+1)),pi(i,t+1,n.modelToRenderLayerTransform,t+1,e,t+1,t+1,t+1,t+1)):i=n.modelToRenderLayerTransform;let a=new Float32Array((t+1)*(t+1)),o=Dc(a,t+1,i,t+1,t+1);if(o===0)throw new Error("Transform is singular");let{globalToRenderLayerDimensions:l,localToRenderLayerDimensions:c,channelToRenderLayerDimensions:d}=n,p=l.length,m=c.length,g=p+m,v=new Float32Array((g+1)*t);for(let D=0;D<t;++D){for(let E=0;E<p;++E){let V=l[E];V!==-1&&(v[D+E*t]=a[D+V*(t+1)])}for(let E=0;E<m;++E){let V=c[E];V!==-1&&(v[D+(p+E)*t]=a[D+V*(t+1)])}v[D+g*t]=a[D+t*(t+1)]}let b=d.length,x=new Array(b),C=[];for(let D=0;D<b;++D){let E=d[D],V=-1;if(E!==-1){for(let O=0;O<t;++O){let B=i[E+O*(t+1)];if(B!==0){if(B!==1||V!==-1)throw new Error(`Channel dimension ${n.layerDimensionNames[E]} must map with stride 1 to a single data chunk dimensions`);V=O}}if(V!==-1){if(i[E+t*(t+1)]!==0)throw new Error(`Channel dimension ${n.layerDimensionNames[E]} must have an offset of 0 in the chunk coordinate space`);C.push(V)}}x[D]=V}let{channelSpaceShape:T}=n,I=Ec(T),P=C.length,M=new Uint32Array(I*P);for(let D=0;D<I;++D){let E=D,V=0;for(let O=0;O<b;++O){let B=E%T[O];E=(E-B)/T[O],x[O]!==-1&&(M[D*P+V]=B,++V)}}return{layerRank:t,modelTransform:n,chunkToLayerTransform:i,layerToChunkTransform:a,chunkToLayerTransformDet:o,combinedGlobalLocalRank:g,combinedGlobalLocalToChunkTransform:v,channelToChunkDimensionIndices:x,chunkChannelDimensionIndices:C,numChannels:I,chunkChannelCoordinates:M,channelSpaceShape:T}}function Ph(n,e){let{globalToRenderLayerDimensions:t}=n,r=[],i=[];for(let a=0;a<3;++a){let o=e[a];if(o==-1)continue;let l=t[o];i.push(l),l!==-1&&r.push(l)}for(let a=i.length;a<3;++a)i[a]=-1;return{layerDisplayDimensionIndices:r,displayToLayerDimensionIndices:i}}function Ih(n,e){let{chunkToLayerTransform:t,modelTransform:r}=n,i=r.rank,{layerDisplayDimensionIndices:a,displayToLayerDimensionIndices:o}=e,l=a.length,c=js(t,i,a);if(c.length!==l){let{modelDimensionNames:m,layerDimensionNames:g}=r;throw new Error(`Rank mismatch between displayed layer dimensions (${Array.from(a,v=>g[v]).join(",\xA0")}) and corresponding chunk dimensions (${Array.from(c,v=>m[v]).join(",\xA0")})`)}let d=ae.create();for(let m=0;m<3;++m){let g=o[m];if(g!==-1){for(let v=0;v<l;++v){let b=c[v];d[v*4+m]=t[b*(i+1)+g]}d[12+m]=t[i*(i+1)+g]}}let p=ae.create();ae.invert(p,d);for(let m=c.length;m<3;++m)c[m]=-1;return{modelTransform:n.modelTransform,chunkTransform:n,displaySubspaceModelMatrix:d,displaySubspaceInvModelMatrix:p,chunkDisplayDimensionIndices:c,numChunkDisplayDims:l}}function Ni(n,e,t,r,i){let a=e.length,o=t.length,l=n.length,c=!0;for(let d=0;d<r;++d){let p=d,m=0;for(let g=0;g<a;++g)m+=i[p+g*r]*e[g];p+=a*r;for(let g=0;g<o;++g)m+=i[p+g*r]*t[g];m+=i[p+o*r],d<l?n[d]=m:(m<0||m>=1)&&(c=!1)}return c}function YE(n,e,t){n.fill(0),n[15]=1;let r=!0,{displayDimensionIndices:i}=e,{globalToRenderLayerDimensions:a,modelToRenderLayerTransform:o}=t,l=t.rank;for(let c=0;c<3;++c){let d=i[c];if(d===-1){r=!1;continue}let p=a[d];if(p===-1){r=!1;continue}n[c+12]=o[p+l*(l+1)];for(let m=0;m<3;++m)n[c+4*m]=o[p+(l+1)*m]}if(!r){let{globalDimensionNames:c}=e,d=Array.from(i.filter(p=>p!==-1),p=>c[p]).join(",\xA0");throw new Error(`Transform from model dimensions (${t.modelDimensionNames.join(",\xA0")}) to display dimensions (${d}) does not have full rank`)}}var Zs=class{constructor(e,t,r){this.size=K.clone(e),this.transform=ae.clone(t),this.finiteRank=r;let i=ae.create(),a=Dc(i,4,t,4,4);if(a===0)throw new Error("Transform is singular");this.invTransform=i,this.detTransform=a}toObject(){return{size:this.size,transform:this.transform,finiteRank:this.finiteRank}}static fromObject(e){return new Zs(e.size,e.transform,e.finiteRank)}globalToLocalSpatial(e,t){return K.transformMat4(e,t,this.invTransform)}localSpatialVectorToGlobal(e,t){return nE(e,t,this.transform)}globalToLocalNormal(e,t){return qf(e,t,this.transform)}};var KE=class{constructor(){this.name="CancellationError";this.message="CANCELED"}toString(){return"CANCELED"}},Kn=new KE;function XE(n){if(n.isCanceled===!0)throw Kn}var hS=()=>{},at={isCanceled:!1,add:()=>hS,remove:hS},vr=class{cancel(){let{handlers:e}=this;if(e!==null&&(this.handlers=null,e!==void 0))for(let t of e)t()}get isCanceled(){return this.handlers===null}add(e){let{handlers:t}=this;return t===null?(e(),hS):(t===void 0&&(t=this.handlers=new Set),t.add(e),()=>{this.remove(e)})}remove(e){let{handlers:t}=this;t!=null&&t.delete(e)}},mS=class extends vr{constructor(){super(...arguments);this.consumers=new Set}addConsumer(e=at){let{consumers:t}=this;t.has(e)||e.isCanceled||(t.add(e),e.add(()=>{t.delete(e),t.size===0&&this.cancel()}))}};function QE(n,e){return new Promise((t,r)=>{if(n===at){e(t,r,at);return}let i=new vr,a=n.add(()=>{i.cancel()});e(o=>{a(),t(o)},o=>{a(),r(o)},i)})}var Ah=!(typeof Window!="undefined"&&self instanceof Window),ZE=!1,eD=!1,gS="rpc.promise.response",tD="rpc.promise.cancel",nD=new Map;function wt(n,e){nD.set(n,e)}var rD=class extends Error{constructor(e,t){super(t);this.name=e;this.message=t}};function Mh(n,e){wt(n,function(t){let r=t.id,i=new vr,a=e.call(this,t,i);this.set(r,{promise:a,cancellationToken:i}),a.then(({value:o,transfers:l})=>{this.delete(r),this.invoke(gS,{id:r,value:o},l)},o=>{this.delete(r),this.invoke(gS,{id:r,error:o.message,errorName:o.name})})})}wt(tD,function(n){let e=n.id,t=this.get(e);if(t!==void 0){let{cancellationToken:r}=t;r.cancel()}});wt(gS,function(n){let e=n.id,{resolve:t,reject:r}=this.get(e);this.delete(e),n.hasOwnProperty("value")?t(n.value):n.errorName===Kn.name?r(Kn):r(new rD(n.errorName,n.error))});var GW=Ah?-1:0,yS=class{constructor(e){this.target=e;this.objects=new Map;this.nextId=GW;e.onmessage=t=>{let r=t.data;eD&&console.log("Received message",r),nD.get(r.functionName).call(this,r)}}get numObjects(){return this.objects.size}set(e,t){this.objects.set(e,t)}delete(e){this.objects.delete(e)}get(e){return this.objects.get(e)}getRef(e){let t=e.id,r=this.get(t);return r.referencedGeneration=e.gen,r.addRef(),r}getOptionalRef(e){if(e===void 0)return;let t=e.id,r=this.get(t);return r.referencedGeneration=e.gen,r.addRef(),r}invoke(e,t,r){t.functionName=e,eD&&console.trace("Sending message",t),this.target.postMessage(t,r)}promiseInvoke(e,t,r=at,i){return QE(r,(a,o,l)=>{let c=t.id=this.newId();this.set(c,{resolve:a,reject:o}),this.invoke(e,t,i),l.add(()=>{this.invoke(tD,{id:c})})})}newId(){return Ah?this.nextId--:this.nextId++}},Sn=class extends j{constructor(){super(...arguments);this.rpc=null;this.rpcId=null}initializeSharedObject(e,t=e.newId()){this.rpc=e,this.rpcId=t,this.isOwner=!1,e.set(t,this)}initializeCounterpart(e,t={}){this.initializeSharedObject(e),this.unreferencedGeneration=0,this.referencedGeneration=0,this.isOwner=!0,t.id=this.rpcId,t.type=this.RPC_TYPE_ID,e.invoke("SharedObject.new",t)}dispose(){super.dispose()}addCounterpartRef(){return{id:this.rpcId,gen:++this.referencedGeneration}}refCountReachedZero(){this.isOwner===!0?this.referencedGeneration===this.unreferencedGeneration&&this.ownerDispose():this.isOwner===!1?this.rpc.invoke("SharedObject.refCountReachedZero",{id:this.rpcId,gen:this.referencedGeneration}):super.refCountReachedZero()}ownerDispose(){ZE&&console.log(`[${Ah}] #rpc object = ${this.rpc.numObjects}`);let{rpc:e,rpcId:t}=this;super.refCountReachedZero(),e.delete(t),e.invoke("SharedObject.dispose",{id:t})}counterpartRefCountReachedZero(e){this.unreferencedGeneration=e,this.refCount===0&&e===this.referencedGeneration&&this.ownerDispose()}};function WW(n,e,t={}){e!=null&&n.initializeSharedObject(e,t.id)}var ro=class extends Sn{constructor(e,t={}){super();WW(this,e,t)}};wt("SharedObject.dispose",function(n){let e=this.get(n.id);if(e.refCount!==0)throw new Error("Attempted to dispose object with non-zero reference count.");ZE&&console.log(`[${Ah}] #rpc objects: ${this.numObjects}`),e.disposed(),this.delete(e.rpcId),e.rpcId=null,e.rpc=null});var zW="Worker";wt(zW,function(n){let{port:e,path:t}=n;new Worker(t).postMessage({port:e},[e])});wt("SharedObject.refCountReachedZero",function(n){let e=this.get(n.id),t=n.gen;e.counterpartRefCountReachedZero(t)});var iD=new Map;function bn(n){return e=>{e.prototype.RPC_TYPE_ID=n}}function jo(n){return e=>{if(n!==void 0)e.prototype.RPC_TYPE_ID=n;else if(n=e.prototype.RPC_TYPE_ID,n===void 0)throw new Error("RPC_TYPE_ID should have already been defined");iD.set(n,e)}}wt("SharedObject.new",function(n){let e=this,t=n.type,r=iD.get(t),i=new r(e,n);--i.refCount});var Rh=!1,HW=!1,$W=ae.create();function jW(n,e){let t=0,r=Math.abs(n.detTransform),{transform:i,size:a}=n;for(let o=0;o<3;++o){let l=0;for(let d=0;d<3;++d)l+=e[d*4+2]*i[4*o+d];let c=a[o];t+=Math.abs(l)*c,r*=c}return r/t}function aD(n,e,t){let{curPositionInChunks:r,fixedPositionWithinChunk:i}=n,{nonDisplayLowerClipBound:a,nonDisplayUpperClipBound:o}=n,{rank:l,chunkDataSize:c}=n.source.spec;if(!Ni(r,e,t,n.layerRank,n.fixedLayerToChunkTransform))return!1;for(let d=0;d<l;++d){let p=r[d];if(p<a[d]||p>=o[d])return Rh&&console.log("excluding source",n,`because of chunkDim=${d}, sum=${p}`,a,o,n.fixedLayerToChunkTransform),!1;let m=c[d],g=r[d]=Math.floor(p/m);i[d]=p-g*m}return!0}function JW(n,e){let t=e.length,r=0;if(Rh&&console.log(e),t>1){let i=0;for(let a=0;a<t;++a){let o=e[a],{chunkLayout:l}=o,c=jW(l,n);Rh&&console.log(`chunksize = ${l.size}, sliceArea = ${c}`),c>i&&(i=c,r=a)}}return r}var Mc=new Zs(K.create(),ae.create(),0),vS=class extends Cd{constructor(){super(...arguments);this.viewportNormalInGlobalCoordinates=K.create();this.viewportNormalInCanonicalCoordinates=K.create();this.centerDataPosition=K.create();this.pixelSize=0}};function qW(n,e){if(n.displayDimensionRenderInfo!==e.displayDimensionRenderInfo||n.pixelSize!==e.pixelSize)return!0;let{viewMatrix:t}=n,{viewMatrix:r}=e;for(let i=0;i<12;++i)if(t[i]!==r[i])return!0;return!1}var SS=class extends Sn{constructor(e){super();this.projectionParameters=e;this.visibleLayers=new Map;this.visibleSourcesStale=!0;this.registerDisposer(e.changed.add((t,r)=>{qW(t,r)&&this.invalidateVisibleSources(),this.invalidateVisibleChunks()}))}invalidateVisibleSources(){this.visibleSourcesStale=!0}invalidateVisibleChunks(){}updateVisibleSources(){if(!this.visibleSourcesStale)return;this.visibleSourcesStale=!1;let e=this.projectionParameters.value.displayDimensionRenderInfo,{visibleLayers:t}=this;for(let[r,{allSources:i,visibleSources:a,displayDimensionRenderInfo:o}]of t){if(a.length=0,o!==e||i.length===0)continue;let l=JW(this.projectionParameters.value.viewMatrix,i.map(d=>d[0])),c=i[l];for(let d of r.filterVisibleSources(this,c))a.push(d);a.reverse(),Rh&&console.log("visible sources chosen",a)}}},YW=18;function Pd(n){let{rank:e,upperVoxelBound:t,maxVoxelsPerChunkLog2:r=YW,chunkToViewTransform:i,displayRank:a,minBlockSize:o,maxBlockSize:l}=n,{lowerVoxelBound:c=new Uint32Array(e)}=n,d=new Float32Array(e);for(let v=0;v<e;++v){let b=0;for(let x=0;x<a;++x){let C=i[v*a+x];b+=C*C}d[v]=Math.sqrt(b)}let p=new Uint32Array(e);o!==void 0?p.set(o):p.fill(1);let m=new Array(e);for(let v=0;v<e;++v){let b=Number.POSITIVE_INFINITY;d[v]===0?b=p[v]:(t!==void 0&&(b=Math.pow(2,Math.floor(Math.log2(t[v]-c[v])))),l!==void 0&&(b=Math.min(b,l[v]))),m[v]=b}function g(){let v=Infinity,b=-1;for(let x=0;x<e;++x){if(p[x]>=m[x])continue;let C=p[x]*d[x];C<v&&(v=C,b=x)}return b}r-=Math.log2(Ec(p));for(let v=0;v<r;++v){let b=g();if(b===-1)break;p[b]*=2}return p}function KW(n){let e=[],{displayRank:t,chunkToViewTransform:r,rank:i}=n;if(t>3)throw new Error("Unsupported view transform");if(t<3)return[Pd(n)];for(let a=0;a<3;++a){let o=(a+2)%3,l=new Float32Array(r);for(let c=0;c<i;++c)l[c*t+o]=0;e[a]=Pd({...n,chunkToViewTransform:l})}return e}var el;(function(t){t[t.ISOTROPIC=0]="ISOTROPIC",t[t.FLAT=1]="FLAT"})(el||(el={}));function oD(n){if(n.chunkDataSizes!==void 0)return n.chunkDataSizes;let{chunkLayoutPreference:e=0}=n;switch(e){case 0:return[Pd(n)];case 1:return KW(n)}}function Jo(n){let{rank:e,chunkDataSize:t,upperVoxelBound:r}=n,{lowerVoxelBound:i=new Float32Array(e)}=n,a=new Float32Array(e),o=new Float32Array(e);for(let l=0;l<e;++l)a[l]=Math.floor(i[l]/t[l]),o[l]=Math.floor((r[l]-1)/t[l]+1);return{rank:e,chunkDataSize:t,lowerChunkBound:a,upperChunkBound:o,lowerVoxelBound:i,upperVoxelBound:r}}function*sD(n,e,t){let r=n.projectionParameters.value.pixelSize*1.1,i=t[0].effectiveVoxelSize,a=e.renderScaleTarget.value,o=p=>{let m=r*a;for(let g=0;g<3;++g){let v=p[g];if(v>m&&v>1.01*i[g])return!0}return!1},l=(p,m)=>{let g=r*a;for(let v=0;v<3;++v){let b=p[v],x=m[v];if(Math.abs(g-b)<Math.abs(g-x)&&b<1.01*x)return!0}return!1},c=t.length-1,d;for(;;){let p=t[c];if(d!==void 0&&!l(p.effectiveVoxelSize,d)||(yield p,c===0||!o(p.effectiveVoxelSize)))break;d=p.effectiveVoxelSize,--c}}var lD="SliceView",cD="sliceview/RenderLayer",uD="SliceView.addVisibleLayer",dD="SliceView.removeVisibleLayer",bS=new Float32Array(3),xS=new Float32Array(3),pD=ae.create(),fD=new Float32Array(24);function hD(n,e,t,r){let i=bS,a=xS,{lowerChunkDisplayBound:o,upperChunkDisplayBound:l}=e;for(let m=0;m<3;++m)i[m]=Math.max(i[m],o[m]),a[m]=Math.min(a[m],l[m]);let{curPositionInChunks:c,chunkDisplayDimensionIndices:d}=e;function p(){if(!r(i[0],i[1],i[2],a[0],a[1],a[2],n))return;let m=0,g=Math.max(0,a[0]-i[0]),v=g;for(let T=1;T<3;++T){let I=Math.max(0,a[T]-i[T]);v*=I,I>g&&(g=I,m=T)}if(v===0)return;if(v===1){c[d[0]]=i[0],c[d[1]]=i[1],c[d[2]]=i[2],t(i,n);return}let b=i[m],x=a[m],C=Math.floor(.5*(b+x));a[m]=C,p(),a[m]=x,i[m]=C,p(),i[m]=b}p()}function _h(n,e,t,r){if(!aD(t,n.globalPosition,e))return;let{size:i}=t.chunkLayout,a=ae.multiply(pD,n.viewProjectionMat,t.chunkLayout.transform);for(let d=0;d<3;++d){let p=i[d];for(let m=0;m<4;++m)a[4*d+m]*=p}let o=fD;$s(o,a);let l=bS,c=xS;l.fill(Number.NEGATIVE_INFINITY),c.fill(Number.POSITIVE_INFINITY),hD(o,t,r,Yf)}function mD(n,e,t,r,i){if(!aD(t,n.globalPosition,e))return;let{size:a}=r,o=ae.multiply(pD,n.viewProjectionMat,r.transform);for(let g=0;g<3;++g){let v=a[g];for(let b=0;b<4;++b)o[4*g+b]*=v}let l=$W;ae.invert(l,o);let c=bS,d=xS,p=.001;for(let g=0;g<3;++g){let v=l[12+g]+p/a[g],b=Math.abs(l[g]),x=Math.abs(l[4+g]);c[g]=Math.floor(v-b-x),d[g]=Math.floor(v+b+x+1)}let m=fD;for(let g=0;g<3;++g){let v=o[4*g],b=o[4*g+1],x=o[4*g+2];m[g]=v,m[4+g]=-v,m[8+g]=+b,m[12+g]=-b,m[16+g]=+x,m[20+g]=-x}{let g=3,v=o[4*g],b=o[4*g+1],x=o[4*g+2];m[g]=1+v,m[4+g]=1-v,m[8+g]=1+b,m[12+g]=1-b,m[16+g]=x,m[20+g]=-x}HW&&(console.log("clippingPlanes",m),console.log("modelViewProjection",o.join(",")),console.log(`lower=${c.join(",")}, upper=${d.join(",")}`)),hD(m,t,i,iE)}function Rc(n,e){let{finiteRank:t}=e;if(t===3)return e;Mc.finiteRank=t,K.copy(Mc.size,e.size);let r=ae.copy(Mc.transform,e.transform),i=ae.copy(Mc.invTransform,e.invTransform);Mc.detTransform=e.detTransform;let{invViewMatrix:a,width:o,height:l}=n,c=Kf(n.projectionMat);for(let d=t;d<3;++d){let p=a[12+d],m=p,g=p,v=Math.abs(a[d]*o);m-=v,g+=v;let b=Math.abs(a[d+4]*l);m-=b,g+=b;let x=Math.abs(a[d+8]*c);m-=x,g+=x;let C=Math.max(1,g-m);r[12+d]=m,r[5*d]=C}return ae.invert(i,r),Mc}var gD="annotation.MetadataChunkSource",yD="annotation.GeometryChunkSource",vD="annotation.SubsetGeometryChunkSource",SD="annotation.reference.add",bD="annotation.reference.delete",xD="annotation.commit",CD="annotation.commit",wD="annotation/SpatiallyIndexedRenderLayer",TD="annotation/PerspectiveRenderLayer:updateSources",LD="annotation/RenderLayer",kD="annotation/RenderLayer.updateSegmentation",XW=Dt.create();function CS(n,e,t,r,i,a){let{displayDimensionRenderInfo:o,viewMatrix:l,projectionMat:c,width:d,height:p}=n,{voxelPhysicalScales:m}=o,g=Math.abs(Dt.determinant(Hs(XW,l))),v=dd(m),b=aE(c)/g*v;if(r.length===0)return;let x=r[0],C=Math.abs(x.chunkLayout.detTransform)*v,{lowerClipDisplayBound:T,upperClipDisplayBound:I}=x;for(let O=0;O<3;++O)C*=I[O]-T[O];let P=Math.min(C,b),M=d*p,E=M/t**2/P,V=0;for(let O=r.length-1;O>=0&&V<E;--O){let B=r[O],z=B.source.spec,{chunkLayout:_}=B,U=dd(_.size)*Math.abs(_.detTransform)*v,{limit:N,rank:J}=z,{nonDisplayLowerClipBound:ie,nonDisplayUpperClipBound:pe}=B,me=1;for(let ke=0;ke<J;++ke){let $e=pe[ke]-ie[ke];Number.isFinite($e)&&(me/=$e)}let Pe=N*me/U,le=!0,we=V+Pe,Re=Math.pow(1/we,1/3),Ue=Math.sqrt(M/(we*P)),et=(E-V)*U/me,ye=Math.min(1,et/z.limit);_h(n,e,B,()=>{le&&(i(B,O),le=!1),a(B,O,ye,Re,Ue)}),V=we}}var Bi=`vec3 colormapJet(float x) {
  vec3 result;
  result.r = x < 0.89 ? ((x - 0.35) / 0.31) : (1.0 - (x - 0.89) / 0.11 * 0.5);
  result.g = x < 0.64 ? ((x - 0.125) * 4.0) : (1.0 - (x - 0.64) / 0.27);
  result.b = x < 0.34 ? (0.5 + x * 0.5 / 0.11) : (1.0 - (x - 0.34) / 0.31);
  return clamp(result, 0.0, 1.0);
}
vec3 colormapCubehelix(float x) {
  float xclamp = clamp(x, 0.0, 1.0);
  float angle = 2.0 * 3.1415926 * (4.0 / 3.0 + xclamp);
  float amp = xclamp * (1.0 - xclamp) / 2.0;
  vec3 result;
  float cosangle = cos(angle);
  float sinangle = sin(angle);
  result.r = -0.14861 * cosangle + 1.78277 * sinangle;
  result.g = -0.29227 * cosangle + -0.90649 * sinangle;
  result.b = 1.97294 * cosangle;
  result = clamp(xclamp + amp * result, 0.0, 1.0);
  return result;
}
`;var ED=Symbol("objectId"),QW=0;function pt(n){if(n instanceof Object){let e=n[ED];return e===void 0&&(e=n[ED]=QW++),`o${e}`}else return""+JSON.stringify(n)}var wS=!1,TS;(function(t){t[t.VERTEX=WebGL2RenderingContext.VERTEX_SHADER]="VERTEX",t[t.FRAGMENT=WebGL2RenderingContext.FRAGMENT_SHADER]="FRAGMENT"})(TS||(TS={}));function ZW(n){n=n.replace("\0","");let e=[];for(let t of n.split(`
`)){let r=t.match(/^ERROR:\s*(\d+):(\d+)\s*(.+)$/);r!==null?e.push({message:r[3].trim(),file:parseInt(r[1],10),line:parseInt(r[2],10)}):(r=t.match(/^ERROR:\s*(.+)$/),r!==null?e.push({message:r[1]}):(t=t.trim(),t&&e.push({message:t})))}return e}var DD=class extends Error{constructor(e,t,r,i){let a=`Error compiling ${TS[e].toLowerCase()} shader: ${r}`;super(a);this.name="ShaderCompilationError",this.log=r,this.message=a,this.shaderType=e,this.source=t,this.errorMessages=i}},PD=class extends Error{constructor(e,t,r){let i=`Error linking shader: ${r}`;super(i);this.name="ShaderLinkError",this.log=r,this.message=i,this.vertexSource=e,this.fragmentSource=t}};function ID(n,e,t){var r=n.createShader(t);if(n.shaderSource(r,e),n.compileShader(r),!n.getShaderParameter(r,n.COMPILE_STATUS)){let i=n.getShaderInfoLog(r)||"";if(wS){let a=e.replace("<","&lt;").replace(">","&gt;").split(`
`),o="<pre>";o+=i.replace("<","&lt;").replace(">","&gt;")+`
`,a.forEach((c,d)=>{o+=`${d+1}: ${c}
`}),o+=`
</pre>`,console.log(o);let l=window.open("about:blank","_blank");if(l!==null)try{l.document.write(o)}catch(c){}}throw new DD(t,e,i,ZW(i))}return r}var Id,AD=class extends j{constructor(e,t,r,i,a,o){super();this.gl=e;this.vertexSource=t;this.fragmentSource=r;this.attributes=new Map;this.uniforms=new Map;this.vertexShaderInputBinders={};let l=this.vertexShader=ID(e,t,e.VERTEX_SHADER),c=this.fragmentShader=ID(e,r,e.FRAGMENT_SHADER),d=e.createProgram();if(e.attachShader(d,l),e.attachShader(d,c),wS&&(o==null?void 0:o.length)&&(e.transformFeedbackVaryings(d,o.map(g=>g.name),WebGL2RenderingContext.INTERLEAVED_ATTRIBS),this.vertexDebugOutputs=o),e.linkProgram(d),!e.getProgramParameter(d,e.LINK_STATUS)){let g=e.getProgramInfoLog(d)||"";throw new PD(t,r,g)}this.program=d;let{uniforms:p,attributes:m}=this;if(i)for(let g of i)p.set(g,e.getUniformLocation(d,g));if(a)for(let g of a)m.set(g,e.getAttribLocation(d,g))}uniform(e){return this.uniforms.get(e)}attribute(e){return this.attributes.get(e)}textureUnit(e){return this.textureUnits.get(e)}bind(){Id=this,this.gl.useProgram(this.program)}disposed(){let{gl:e}=this;e.deleteShader(this.vertexShader),this.vertexShader=void 0,e.deleteShader(this.fragmentShader),this.fragmentShader=void 0,e.deleteProgram(this.program),this.program=void 0,this.gl=void 0,this.attributes=void 0,this.uniforms=void 0}};function MD(n,e,t,r,i){if(n.drawArraysInstanced(e,t,r,i),!wS||!(Id==null?void 0:Id.vertexDebugOutputs))return;let{vertexDebugOutputs:a}=Id,o=0;for(let g of a)o+=ez[g.typeName];let l=n.createBuffer(),c=o*r*i;n.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,l),n.bufferData(WebGL2RenderingContext.ARRAY_BUFFER,c,WebGL2RenderingContext.DYNAMIC_DRAW),n.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,null),n.bindBufferBase(WebGL2RenderingContext.TRANSFORM_FEEDBACK_BUFFER,0,l),n.beginTransformFeedback(WebGL2RenderingContext.POINTS),n.enable(WebGL2RenderingContext.RASTERIZER_DISCARD),n.drawArraysInstanced(WebGL2RenderingContext.POINTS,t,r,i),n.disable(WebGL2RenderingContext.RASTERIZER_DISCARD),n.endTransformFeedback(),n.bindBufferBase(WebGL2RenderingContext.TRANSFORM_FEEDBACK_BUFFER,0,null),n.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,l);let d=new Uint8Array(c);n.getBufferSubData(WebGL2RenderingContext.ARRAY_BUFFER,0,d,0,c),n.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,null),n.deleteBuffer(l);let p=0,m=new Float32Array(d.buffer);for(let g=0;g<i;++g)for(let v=0;v<r;++v){let b=`i=${g} v=${v}:`;for(let x of a)switch(b+=` ${x.name}=`,x.typeName){case"float":b+=`${m[p++]}`;break;case"vec2":b+=`${m[p++]},${m[p++]}`;break;case"vec3":b+=`${m[p++]},${m[p++]},${m[p++]}`;break;case"vec4":b+=`${m[p++]},${m[p++]},${m[p++]},${m[p++]}`;break}console.log(b)}}var LS=class{constructor(){this.code="";this.parts=new Set}add(e){if(!this.parts.has(e))switch(this.parts.add(e),typeof e){case"string":this.code+=e;break;case"function":this.add(e());break;default:if(Array.isArray(e))for(let t of e)this.add(t);else throw console.log("Invalid code type",e),new Error("Invalid code type")}}toString(){return this.code}},qo={sampler2D:WebGL2RenderingContext.TEXTURE_2D,isampler2D:WebGL2RenderingContext.TEXTURE_2D,usampler2D:WebGL2RenderingContext.TEXTURE_2D,sampler3D:WebGL2RenderingContext.TEXTURE_3D,isampler3D:WebGL2RenderingContext.TEXTURE_3D,usampler3D:WebGL2RenderingContext.TEXTURE_3D},ez={float:4,vec2:8,vec3:12,vec4:16},Sr=class{constructor(e){this.gl=e;this.nextSymbolID=0;this.nextTextureUnit=0;this.uniformsCode="";this.attributesCode="";this.varyingsCodeVS="";this.varyingsCodeFS="";this.fragmentExtensionsSet=new Set;this.fragmentExtensions="";this.vertexCode=new LS;this.vertexMain="";this.fragmentCode=new LS;this.outputBufferCode="";this.fragmentMain="";this.required=new Set;this.uniforms=new Array;this.attributes=new Array;this.initializers=[];this.textureUnits=new Map;this.vertexDebugOutputs=[]}addVertexPositionDebugOutput(){this.vertexDebugOutputs.push({typeName:"vec4",name:"gl_Position"})}addVertexDebugOutput(e,t){this.addVarying(e,t),this.vertexDebugOutputs.push({typeName:e,name:t})}allocateTextureUnit(e,t=1){if(this.textureUnits.has(e))throw new Error("Duplicate texture unit symbol: "+e.toString());let r=this.nextTextureUnit;return this.nextTextureUnit+=t,this.textureUnits.set(e,r),r}addTextureSampler(e,t,r,i){let a=this.allocateTextureUnit(r,i);return this.addUniform(`highp ${e}`,t,i),this.addInitializer(o=>{if(i){let l=new Int32Array(i);for(let c=0;c<i;++c)l[c]=c+a;o.gl.uniform1iv(o.uniform(t),l)}else o.gl.uniform1i(o.uniform(t),a)}),a}symbol(e){return e+this.nextSymbolID++}addAttribute(e,t,r){return this.attributes.push(t),r!==void 0&&(this.attributesCode+=`layout(location = ${r})`),this.attributesCode+=`in ${e} ${t};
`,t}addVarying(e,t,r=""){this.varyingsCodeVS+=`${r} out ${e} ${t};
`,this.varyingsCodeFS+=`${r} in ${e} ${t};
`}addOutputBuffer(e,t,r){r!==null&&(this.outputBufferCode+=`layout(location = ${r}) `),this.outputBufferCode+=`out ${e} ${t};
`}addUniform(e,t,r){return this.uniforms.push(t),r!=null?this.uniformsCode+=`uniform ${e} ${t}[${r}];
`:this.uniformsCode+=`uniform ${e} ${t};
`,t}addFragmentExtension(e){this.fragmentExtensionsSet.has(e)||(this.fragmentExtensionsSet.add(e),this.fragmentExtensions+=`#extension ${e} : require
`)}addVertexCode(e){this.vertexCode.add(e)}addFragmentCode(e){this.fragmentCode.add(e)}setVertexMain(e){this.vertexMain=e}addVertexMain(e){this.vertexMain=(this.vertexMain||"")+e}setFragmentMain(e){this.fragmentMain=`void main() {
${e}
}
`}setFragmentMainFunction(e){this.fragmentMain=e}addInitializer(e){this.initializers.push(e)}require(e){this.required.has(e)||(this.required.add(e),e(this))}build(){let e=`#version 300 es
precision highp float;
precision highp int;
${this.uniformsCode}
${this.attributesCode}
${this.varyingsCodeVS}
${this.vertexCode}
void main() {
${this.vertexMain}
}
`,t=`#version 300 es
${this.fragmentExtensions}
precision highp float;
precision highp int;
${this.uniformsCode}
${this.varyingsCodeFS}
${this.outputBufferCode}
${this.fragmentCode}
${this.fragmentMain}
`,r=new AD(this.gl,e,t,this.uniforms,this.attributes,this.vertexDebugOutputs);r.textureUnits=this.textureUnits;let{initializers:i}=this;if(i.length>0){r.bind();for(let a of i)a(r)}return r}};function Sa(){return new Ee(void 0)}function Yo(n){return new Le(n,Q)}function Ad(n,e,t){let r=new Map,{parameters:i,fallbackParameters:a,shaderError:o,encodeParameters:l=C=>C,extraParameters:c=Rr(void 0),encodeExtraParameters:d=C=>C,getContextKey:p,defineShader:m}=t;o!==void 0&&(o.value=void 0);let{encodeContext:g=p}=t,v=Bn(t.memoizeKey);function b(C,T,I){let P=JSON.stringify({id:v,context:g(C),parameters:l(T),extraParameters:d(I)});return e.memoize.get(P,()=>{let M=new Sr(e);return m(M,C,T,I),M.build()})}function x(C){let T=p(C),I=r.get(T);I===void 0&&(I={parametersGeneration:-1,extraParametersGeneration:-1,shader:null,fallback:!1,parameters:i.value,extraParameters:c.value},r.set(T,I));let P=i.changed.count,M=c.changed.count;if(P===I.parametersGeneration&&M===I.extraParametersGeneration)return I;let D=I.parameters=i.value,E=I.extraParameters=c.value,V=I.shader;I.parametersGeneration=P,I.extraParametersGeneration=M;let O=null;try{O=b(C,D,E),I.fallback=!1,a!==void 0&&(a.value=D),o!==void 0&&(o.value=null)}catch(B){if(o!==void 0&&(o.value=B),a!==void 0)try{let z=a.value;O=b(C,z,E),I.parameters=z,I.fallback=!0}catch{}}return V!==null&&V.dispose(),I.shader=O,I}return n.registerDisposer(()=>{for(let C of r.values()){let{shader:T}=C;T!==null&&T.dispose()}}),x}function ti(n,e,t){return Ad(n,e,{...t,getContextKey:r=>r,encodeContext:r=>pt(r),defineShader:(r,i,a,o)=>(r.require(i),t.defineShader(r,a,o))})}function Ui(n,e=1,t=0){return`
#line ${t} ${e}
`+n}var RD=`
float mixLinear(float x, float y, float a) { return mix(x, y, a); }
`,_D=`
vec3 hueToRgb(float hue) {
  float hue6 = hue * 6.0;
  float r = abs(hue6 - 3.0) - 1.0;
  float g = 2.0 - abs(hue6 - 2.0);
  float b = 2.0 - abs(hue6 - 4.0);
  return clamp(vec3(r, g, b), 0.0, 1.0);
}
vec3 hsvToRgb(vec3 c) {
  vec3 hueRgb = hueToRgb(c.x);
  return c.z * ((hueRgb - 1.0) * c.y + 1.0);
}
`,Pt=`
struct uint64_t {
  highp uvec2 value;
};
struct uint64x2_t {
  highp uvec4 value;
};
uint64_t mixLinear(uint64_t x, uint64_t y, float a) {
  return x;
}
uint64_t toUint64(uint64_t x) { return x; }
`,VD=[Pt,`
uint64_t unpackUint64leFromUint32(highp uvec2 x) {
  uint64_t result;
  result.value = x;
  return result;
}
uint64x2_t unpackUint64leFromUint32(highp uvec4 x) {
  uint64x2_t result;
  result.value = x;
  return result;
}
`],Vh=[Pt,`
bool equals(uint64_t a, uint64_t b) {
  return a.value == b.value;
}
`],Md=[Pt,`
bool compareLessThan(uint64_t a, uint64_t b) {
  return (a.value[1] < b.value[1])||
         (a.value[1] == b.value[1] && a.value[0] < b.value[0]);
}
`],kS=[Pt,`
uint64_t subtract(uint64_t a, uint64_t b) {
  if (a.value[0] < b.value[0]) {
    --a.value[1];
  }
  a.value -= b.value;
  return a;
}
`],tz=[Pt,`
uint64_t add(uint64_t a, uint64_t b) {
  a.value[0] += b.value[0];
  if (a.value[0] < b.value[0]) {
    ++a.value[1];
  }
  a.value[1] += b.value[1];
  return a;
}
`],OD=[tz,Md,`
uint64_t addSaturate(uint64_t a, uint64_t b) {
  a = add(a, b);
  if (compareLessThan(a, b)) {
    a.value = uvec2(0xffffffffu, 0xffffffffu);
  }
  return a;
}
`],ND=[kS,Md,`
uint64_t subtractSaturate(uint64_t a, uint64_t b) {
  b = subtract(a, b);
  if (compareLessThan(a, b)) {
    b.value = uvec2(0u, 0u);
  }
  return b;
}
`],ES=[Pt,`
uint64_t shiftRight(uint64_t a, int shift) {
  if (shift >= 32) {
    return uint64_t(uvec2(a.value[1] >> (shift - 32), 0u));
  } else if (shift == 0) {
    return a;
  } else {
    return uint64_t(uvec2((a.value[0] >> shift) | (a.value[1] << (32 - shift)), a.value[1] >> shift));
  }
}
`],BD=[Pt,`
uint64_t shiftLeft(uint64_t a, int shift) {
  if (shift >= 32) {
    return uint64_t(uvec2(0u, a.value[0] << (shift - 32)));
  } else if (shift == 0) {
    return a;
  } else {
    return uint64_t(uvec2(a.value[0] << shift, (a.value[1] << shift) | (a.value[0] >> (32 - shift))));
  }
}
`],DS=[Pt,`
struct uint8_t {
  highp uint value;
};
struct uint8x2_t {
  highp uvec2 value;
};
struct uint8x3_t {
  highp uvec3 value;
};
struct uint8x4_t {
  highp uvec4 value;
};
uint8_t mixLinear(uint8_t x, uint8_t y, highp float a) {
  return uint8_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp uint toRaw(uint8_t x) { return x.value; }
highp float toNormalized(uint8_t x) { return float(x.value) / 255.0; }
highp uvec2 toRaw(uint8x2_t x) { return x.value; }
highp vec2 toNormalized(uint8x2_t x) { return vec2(x.value) / 255.0; }
highp uvec3 toRaw(uint8x3_t x) { return x.value; }
vec3 toNormalized(uint8x3_t x) { return vec3(x.value) / 255.0; }
highp uvec4 toRaw(uint8x4_t x) { return x.value; }
vec4 toNormalized(uint8x4_t x) { return vec4(x.value) / 255.0; }
uint64_t toUint64(uint8_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint8_t uint8FromFloat(highp float x) {
  return uint8_t(uint(clamp(x, 0.0, 255.0)));
}
`],PS=[Pt,`
struct int8_t {
  highp int value;
};
struct int8x2_t {
  highp ivec2 value;
};
struct int8x3_t {
  highp ivec3 value;
};
struct int8x4_t {
  highp ivec4 value;
};
int8_t mixLinear(int8_t x, int8_t y, highp float a) {
  return int8_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int8_t x) { return x.value; }
highp ivec2 toRaw(int8x2_t x) { return x.value; }
highp ivec3 toRaw(int8x3_t x) { return x.value; }
highp ivec4 toRaw(int8x4_t x) { return x.value; }
uint64_t toUint64(int8_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int8_t int8FromFloat(highp float x) {
  return int8_t(int(clamp(x, -128.0, 127.0)));
}
`],Oh=`
highp float toRaw(highp float x) { return x; }
highp float toNormalized(highp float x) { return x; }
vec2 toRaw(vec2 x) { return x; }
vec2 toNormalized(vec2 x) { return x; }
vec3 toRaw(vec3 x) { return x; }
vec3 toNormalized(vec3 x) { return x; }
vec4 toRaw(vec4 x) { return x; }
vec4 toNormalized(vec4 x) { return x; }
`,IS=[Pt,`
struct uint16_t {
  highp uint value;
};
struct uint16x2_t {
  highp uvec2 value;
};
uint16_t mixLinear(uint16_t x, uint16_t y, highp float a) {
  return uint16_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp uint toRaw(uint16_t x) { return x.value; }
highp float toNormalized(uint16_t x) { return float(toRaw(x)) / 65535.0; }
highp uvec2 toRaw(uint16x2_t x) { return x.value; }
highp vec2 toNormalized(uint16x2_t x) { return vec2(toRaw(x)) / 65535.0; }
uint64_t toUint64(uint16_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint16_t uint16FromFloat(highp float x) {
  return uint16_t(uint(clamp(x, 0.0, 65535.0)));
}
`],AS=[Pt,`
struct int16_t {
  highp int value;
};
struct int16x2_t {
  highp ivec2 value;
};
int16_t mixLinear(int16_t x, int16_t y, highp float a) {
  return int16_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int16_t x) { return x.value; }
highp ivec2 toRaw(int16x2_t x) { return x.value; }
uint64_t toUint64(int16_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int16_t int16FromFloat(highp float x) {
  return int16_t(int(clamp(x, -32768.0, 32767.0)));
}
`],tl=[Pt,`
struct uint32_t {
  highp uint value;
};
uint32_t mixLinear(uint32_t x, uint32_t y, highp float a) {
  return uint32_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp float toNormalized(uint32_t x) { return float(x.value) / 4294967295.0; }
highp uint toRaw(uint32_t x) { return x.value; }
uint64_t toUint64(uint32_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint32_t uint32FromFloat(highp float x) {
  return uint32_t(uint(clamp(x, 0.0, 4294967295.0)));
}
`],MS=[Pt,`
struct int32_t {
  highp int value;
};
int32_t mixLinear(int32_t x, int32_t y, highp float a) {
  return int32_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int32_t x) { return x.value; }
uint64_t toUint64(int32_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int32_t int32FromFloat(highp float x) {
  return int32_t(int(clamp(x, 2147483648.0, 2147483647.0)));
}
`],UD=`
highp int getFortranOrderIndex(ivec3 subscripts, ivec3 size) {
  return subscripts.x + size.x * (subscripts.y + size.y * subscripts.z);
}
`,FD=`
highp uint log2Exact(highp uint i) {
  highp uint r;
  r = uint((i & 0xAAAAAAAAu) != 0u);
  r |= uint((i & 0xFFFF0000u) != 0u) << 4;
  r |= uint((i & 0xFF00FF00u) != 0u) << 3;
  r |= uint((i & 0xF0F0F0F0u) != 0u) << 2;
  r |= uint((i & 0xCCCCCCCCu) != 0u) << 1;
  return r;
}
`,GD=`
bool clipLineToDepthRange(inout highp vec4 a, inout highp vec4 b) {
  highp float tmin = 0.0, tmax = 1.0;
  highp float k1 = b.w - a.w + a.z - b.z;
  highp float k2 = a.w - b.w + a.z - b.z;
  highp float q1 = (a.z - a.w) / k1;
  highp float q2 = (a.z + a.w) / k2;
  if (k1 > 0.0) tmin = max(tmin, q1);
  else if (k1 < 0.0) tmax = min(tmax, q1);
  if (k2 > 0.0) tmax = min(tmax, q2);
  else if (k2 < 0.0) tmin = max(tmin, q2);
  if (tmin <= tmax) {
    highp vec4 tempA = a;
    highp vec4 tempB = b;
    a = mix(tempA, tempB, tmin);
    b = mix(tempA, tempB, tmax);
    return true;
  }
  return false;
}
`,WD=`
highp float simpleFloatHash(highp vec2 co) {
    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
}
`,zD=`
highp uint shiftLeftSaturate(highp uint x, int shiftAmount) {
  highp uint result = x << shiftAmount;
  if ((result >> shiftAmount) != x) return 0xffffffffu;
  return result;
}
`,Nh=`
highp uint addSaturate(highp uint x, highp uint y) {
  highp uint result = x + y;
  if (result < x) return 0xffffffffu;
  return result;
}
`,HD=`
highp uint subtractSaturate(highp uint x, highp uint y) {
  highp uint result = x - y;
  if (result > x) return 0u;
  return result;
}
`,$D=[Nh,`
highp int addSaturate(highp int x, highp uint y) {
  if (x >= 0) {
    return int(min(addSaturate(y, uint(x)), 0x7fffffffu));
  } else if (y >= uint(-x)) {
    return int(min(y - uint(-x), 0x7fffffffu));
  } else {
    return -int(min(uint(-x) - y, 0x80000000u));
  }
}
`],jD=[Nh,`
highp int subtractSaturate(highp int x, highp uint y) {
  if (x < 0) {
    return -int(min(addSaturate(uint(-x), uint(y)), 0x80000000u));
  } else if (uint(x) >= y) {
    return x - int(y);
  } else {
    return -int(min(y - uint(x), 0x80000000u));
  }
}
`];function _t(n,e=1){switch(n){case G.FLOAT32:if(e===1)return"float";if(e>1&&e<=4)return`vec${e}`;break;case G.UINT8:case G.INT8:case G.UINT16:case G.INT16:case G.UINT32:case G.INT32:case G.UINT64:{let t=Cc[n]?"":"u",r=Xf[n]*8;if(e===1)return`${t}int${r}_t`;if(e>1&&e*r<=32)return`${t}int${r}x${e}_t`;break}}throw new Error(`No shader type for ${G[n]}[${e}].`)}var nl={[G.UINT8]:DS,[G.INT8]:PS,[G.UINT16]:IS,[G.INT16]:AS,[G.UINT32]:tl,[G.INT32]:MS,[G.UINT64]:Pt,[G.FLOAT32]:Oh};function nz(n,e){return e===1?n:n==="float"?`vec${e}`:`${n[0]}vec${e}`}var rz={[WebGL2RenderingContext.UNSIGNED_BYTE]:1,[WebGL2RenderingContext.BYTE]:1,[WebGL2RenderingContext.UNSIGNED_SHORT]:2,[WebGL2RenderingContext.SHORT]:2,[WebGL2RenderingContext.FLOAT]:4,[WebGL2RenderingContext.INT]:4,[WebGL2RenderingContext.UNSIGNED_INT]:4};function Ko(n,e,t,r,i,a,o=1){let l=0,c=a*o;for(;c>0;){let m=Math.min(4,c),g=nz(e,m);c-=m,n.addAttribute("highp "+g,`a${i}${l}`),++l}c=a*o;let d="";for(let m=0;m<o;++m){d+=`highp ${e}[${a}] get${i}${m}() {
  highp ${e}[${a}] result;
`;for(let g=0;g<a;++g){let v=m*a+g,b=Math.floor(v/4),x=v%4;d+=`  result[${g}] = a${i}${b}`,(x!==0||v!==c-1)&&(d+=`[${x}]`),d+=`;
`}d+=`  return result;
`,d+=`}
`}n.addVertexCode(d);let p=rz[t];n.addInitializer(m=>{let g=[];for(let v=0;v<l;++v)g[v]=m.attribute(`a${i}${v}`);m.vertexShaderInputBinders[i]={enable(v){let{gl:b}=m;for(let x=0;x<l;++x){let C=g[x];b.enableVertexAttribArray(C),b.vertexAttribDivisor(C,v)}},disable(){let{gl:v}=m;for(let b=0;b<l;++b){let x=g[b];v.vertexAttribDivisor(x,0),v.disableVertexAttribArray(x)}},bind(v,b){let{gl:x}=m;for(let C=0;C<l;++C){let T=g[C],I=Math.min(4,c-4*C);e==="float"?x.vertexAttribPointer(T,I,t,r,v,b):x.vertexAttribIPointer(T,Math.min(4,c-4*C),t,v,b),b+=p*I}}}})}var RS={[G.UINT8]:"vec2",[G.INT8]:"vec2",[G.UINT16]:"vec2",[G.INT16]:"vec2",[G.FLOAT32]:"vec2",[G.UINT32]:"Uint32LerpParameters",[G.INT32]:"Int32LerpParameters",[G.UINT64]:"Uint64LerpParameters"},Rd={[G.UINT8]:"",[G.INT8]:"",[G.UINT16]:"",[G.INT16]:"",[G.FLOAT32]:"",[G.UINT32]:`
struct Uint32LerpParameters {
  uint offset;
  int shift;
  float multiplier;
};
`,[G.INT32]:`
struct Int32LerpParameters {
  int offset;
  int shift;
  float multiplier;
};
`,[G.UINT64]:[Pt,`
struct Uint64LerpParameters {
  uint64_t offset;
  int shift;
  float multiplier;
};
`]},JD=`
float computeInvlerp(float inputValue, vec2 p) {
  float outputValue = inputValue;
  outputValue = (outputValue - p[0]) * p[1];
  return outputValue;
}
`;function Bh(n){let t=`
float computeInvlerp(${_t(n)} inputValue, vec2 p) {
  return computeInvlerp(float(toRaw(inputValue)), p);
}
`;return[nl[n],JD,t]}function qD(n){let e=_t(n),t=n===G.INT32?"int":"uint",r=RS[n];return[nl[n],Rd[n],`
float computeInvlerp(${t} v, ${r} p) {
  uint x;
  if (v >= p.offset) {
    x = uint(v - p.offset);
  } else {
    x = uint(p.offset - v);
    p.multiplier = -p.multiplier;
  }
  x >>= p.shift;
  return float(x) * p.multiplier;
}
float computeInvlerp(${e} inputValue, ${r} p) {
  return computeInvlerp(toRaw(inputValue), p);
}
`]}var iz={[G.UINT8]:Bh(G.UINT8),[G.INT8]:Bh(G.INT8),[G.UINT16]:Bh(G.UINT16),[G.INT16]:Bh(G.INT16),[G.FLOAT32]:JD,[G.UINT32]:qD(G.UINT32),[G.INT32]:qD(G.INT32),[G.UINT64]:[Pt,Md,kS,ES,Rd[G.UINT64],`
float computeInvlerp(uint64_t inputValue, Uint64LerpParameters p) {
  if (compareLessThan(inputValue, p.offset)) {
    inputValue = subtract(p.offset, inputValue);
    p.multiplier = -p.multiplier;
  } else {
    inputValue = subtract(inputValue, p.offset);
  }
  uint shifted = shiftRight(inputValue, p.shift).value[0];
  return float(shifted) * p.multiplier;
}
`]};function _d(n){let t=`
${_t(n)} computeLerp(float inputValue, vec2 p) {
  inputValue = inputValue / p[1] + p[0];
`;return n===G.FLOAT32?t+=`return inputValue;
`:t+=`return ${G[n].toLowerCase()}FromFloat(round(inputValue));
`,t+=`
}
`,[nl[n],t]}function YD(n){let e=_t(n),t=RS[n];return[nl[n],Rd[n],zD,n===G.UINT32?Nh:$D,n===G.UINT32?HD:jD,`
${e} computeLerp(float inputValue, ${t} p) {
  inputValue = inputValue / p.multiplier;
  uint x = uint(clamp(round(abs(inputValue)), 0.0, 4294967295.0));
  uint xShifted = shiftLeftSaturate(x, p.shift);
  if (inputValue >= 0.0) {
    return ${e}(addSaturate(p.offset, xShifted));
  } else {
    return ${e}(subtractSaturate(p.offset, xShifted));
  }
}
`]}var az={[G.UINT8]:_d(G.UINT8),[G.INT8]:_d(G.INT8),[G.UINT16]:_d(G.UINT16),[G.INT16]:_d(G.INT16),[G.FLOAT32]:_d(G.FLOAT32),[G.UINT32]:YD(G.UINT32),[G.INT32]:YD(G.INT32),[G.UINT64]:[Pt,Md,Vh,OD,ND,ES,BD,Rd[G.UINT64],`
uint64_t computeLerp(float inputValue, Uint64LerpParameters p) {
  inputValue = inputValue / p.multiplier;
  uint64_t x = uint64_t(uvec2(uint(clamp(round(abs(inputValue)), 0.0, 4294967295.0)), 0u));
  uint64_t shifted = shiftLeft(x, p.shift);
  if (!equals(shiftRight(shifted, p.shift), x)) {
    return uint64_t(uvec2(0xffffffffu, 0xffffffffu));
  }
  if (inputValue >= 0.0) {
    return addSaturate(p.offset, shifted);
  } else {
    return subtractSaturate(p.offset, shifted);
  }
}
`]};function KD(n,e,t){let r=`uLerpParams_${e}`,i=`uLerpBounds_${e}`,a=`uLerpScalar_${e}`,o="";switch(t){case G.INT8:case G.UINT8:case G.INT16:case G.UINT16:case G.FLOAT32:n.addUniform("vec2",r);break;case G.INT32:case G.UINT32:{let l=RS[t];n.addUniform(`${t===G.INT32?"i":"u"}vec2`,i),n.addUniform("float",a),o+=`
#define ${r} ${l}(${i}[0], int(${i}[1]), ${a})
`;break}case G.UINT64:{n.addUniform("uvec3",i),n.addUniform("float",a),o+=`
#define ${r} Uint64LerpParameters(uint64_t(${i}.xy), int(${i}[2]), ${a})
`;break}}return[Rd[t],o]}function rl(n,e,t,r=!1){let i=_t(t),a=`
float ${e}(${i} inputValue) {
  float v = computeInvlerp(inputValue, uLerpParams_${e});
  ${r?"v = clamp(v, 0.0, 1.0);":""}
  return v;
}
`;if(t!==G.UINT64&&t!==G.FLOAT32){let o=Cc[t]?"int":"uint";a+=`
float ${e}(${o} inputValue) {
  return ${e}(${i}(inputValue));
}
`}return[nl[t],KD(n,e,t),iz[t],a]}function XD(n,e,t){return[nl[t],KD(n,e,t),az[t],`
${_t(t)} ${e}(float inputValue) {
  return computeLerp(inputValue, uLerpParams_${e});
}
`]}var il=new X;function io(n,e,t,r){let{gl:i}=n;switch(t){case G.INT8:case G.UINT8:case G.INT16:case G.UINT16:case G.FLOAT32:i.uniform2f(n.uniform(`uLerpParams_${e}`),r[0],1/(r[1]-r[0]));break;case G.INT32:case G.UINT32:{let a=r[0],o=r[1]-a,l=Math.max(0,Math.ceil(Math.log2(Math.abs(o)))-24),c=Math.pow(2,l)/o,d=n.uniform(`uLerpBounds_${e}`);t===G.UINT32?i.uniform2ui(d,a,l):i.uniform2i(d,a,l),i.uniform1f(n.uniform(`uLerpScalar_${e}`),c);break}case G.UINT64:{let a=r[0],o=r[1];X.absDifference(il,o,a);let l=il.high>0?32+Math.ceil(Math.log2(il.high)):Math.ceil(Math.log2(il.low)),c=Math.max(0,l-24);X.rshift(il,il,c);let d=1/il.low;X.compare(a,o)>0&&(d*=-1);let p=n.uniform(`uLerpBounds_${e}`);i.uniform3ui(p,a.low,a.high,c),i.uniform1f(n.uniform(`uLerpScalar_${e}`),d)}}}var QD=ot(Et());var qe=class{constructor(e,t=e){this.value_=e;this.defaultValue=t;this.changed=new re}get value(){return this.value_}set value(e){e!==this.value_&&(this.value_=e,this.changed.dispatch())}toggle(){this.value=!this.value}toJSON(){let{value_:e}=this;if(e!==this.defaultValue)return this.value_}restoreState(e){if(e===!0||e===!1){this.value=e;return}this.value=this.defaultValue}reset(){this.value=this.defaultValue}},Fn=class extends j{constructor(e,t={}){super();this.model=e;this.element=document.createElement("input");let{element:r}=this;r.type="checkbox";let i=()=>{var o;let a=this.model.value;this.element.checked=a,(t.enableTitle!==void 0||t.disableTitle!==void 0)&&(this.element.title=(o=a?t.enableTitle:t.disableTitle)!=null?o:"")};this.registerDisposer(e.changed.add(i)),i(),this.registerEventListener(r,"change",function(a){e.value=this.checked}),r.addEventListener("mousedown",a=>{a.preventDefault()})}disposed(){let{element:e}=this,{parentElement:t}=e;t&&t.removeChild(e),super.disposed()}},Xn=class extends j{constructor(e,t){super();this.model=e;this.element=t;this.initialDisplay=this.element.style.display;this.updateVisibility(),this.registerDisposer(e.changed.add(this.registerCancellable((0,QD.default)(()=>this.updateVisibility(),0))))}updateVisibility(){this.element.style.display=this.model.value?this.initialDisplay:"none"}};var ZD="SharedWatchableValue.changed",mt=class extends ro{constructor(e,t={}){super(e,t);this.updatingValue_=!1;e!==void 0&&(this.base=new Ee(t.value),this.setupChangedHandler())}initializeCounterpart(e,t={}){t.value=this.value,super.initializeCounterpart(e,t)}setupChangedHandler(){this.registerDisposer(this.base.changed.add(()=>{if(this.updatingValue_)this.updatingValue_=!1;else{let{rpc:e}=this;e!==null&&e.invoke(ZD,{id:this.rpcId,value:this.value})}}))}static makeFromExisting(e,t){let r=new mt;return r.base=t,r.setupChangedHandler(),r.initializeCounterpart(e),r}static make(e,t){return mt.makeFromExisting(e,new Ee(t))}get value(){return this.base.value}set value(e){this.base.value=e}get changed(){return this.base.changed}};mt=kt([jo("SharedWatchableValue")],mt);wt(ZD,function(n){let e=this.get(n.id);e.updatingValue_=!0,e.base.value=n.value,e.updatingValue_=!1});var It=class extends Ee{constructor(e=Number.NEGATIVE_INFINITY){super(e)}get visible(){return this.value===Number.POSITIVE_INFINITY}get ignored(){return this.value===Number.NEGATIVE_INFINITY}};It.VISIBLE=Number.POSITIVE_INFINITY,It.IGNORED=Number.NEGATIVE_INFINITY;var ao=class extends It{constructor(){super(...arguments);this.contributors=new Map}add(e){let{contributors:t}=this,r=e.changed.add(()=>{this.update()}),i=()=>{t.delete(i),r(),this.update()};return t.set(i,e),this.update(),i}update(){let e=Number.NEGATIVE_INFINITY;for(let t of this.contributors.values())e=Math.max(e,t.value);this.value=e}};function ba(n){return class extends n{constructor(){super(...arguments);this.visibility=new ao}initializeCounterpart(e,t={}){t.visibility=this.registerDisposer(mt.makeFromExisting(e,this.visibility)).rpcId,super.initializeCounterpart(e,t)}}}var Bt=class{constructor(e,t=WebGL2RenderingContext.ARRAY_BUFFER){this.gl=e;this.bufferType=t;this.gl=e,this.buffer=e.createBuffer()}bind(){this.gl.bindBuffer(this.bufferType,this.buffer)}bindToVertexAttrib(e,t,r=WebGL2RenderingContext.FLOAT,i=!1,a=0,o=0){this.bind(),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribPointer(e,t,r,i,a,o)}bindToVertexAttribI(e,t,r=WebGL2RenderingContext.UNSIGNED_INT,i=0,a=0){this.bind(),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribIPointer(e,t,r,i,a)}setData(e,t=WebGL2RenderingContext.STATIC_DRAW){let r=this.gl;this.bind(),r.bufferData(this.bufferType,e,t)}dispose(){this.gl.deleteBuffer(this.buffer),this.buffer=void 0,this.gl=void 0}static fromData(e,t,r,i){let a=new Bt(e,r);return a.setData(t,i),a}};function oo(n,e,t,...r){return n.memoize.get(Bn({id:"getMemoizedBuffer",getter:pt(t),args:r}),()=>{let i=new od(Bt.fromData(n,t(...r),e,WebGL2RenderingContext.STATIC_DRAW));return i.registerDisposer(i.value),i})}function oz(n=-1,e=-1,t=1,r=1,i=1,a=1){return rd(new Float32Array([n,e,n,r,t,r,t,e]),2,i,a)}function Xo(n,e=-1,t=-1,r=1,i=1,a=1,o=1){return oo(n,WebGL2RenderingContext.ARRAY_BUFFER,oz,e,t,r,i,a,o).value}function so(n){n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE)}function eP(n){n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE),n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_R,WebGL2RenderingContext.CLAMP_TO_EDGE)}function tP(n,e,t,r,i=WebGL2RenderingContext.RGBA8,a=WebGL2RenderingContext.RGBA,o=WebGL2RenderingContext.UNSIGNED_BYTE){n.activeTexture(WebGL2RenderingContext.TEXTURE0+n.tempTextureUnit),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,e),so(n),n.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,i,t,r,0,a,o,null),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}function nP(n,e,t){n.activeTexture(WebGL2RenderingContext.TEXTURE0+n.tempTextureUnit),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,e),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.LINEAR),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.LINEAR),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE),n.pixelStorei(WebGL2RenderingContext.UNPACK_FLIP_Y_WEBGL,1),n.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,4),n.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE,t),n.pixelStorei(WebGL2RenderingContext.UNPACK_FLIP_Y_WEBGL,0),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}function _S(n){n.addOutputBuffer("vec4","v4f_fragColor",null),n.setFragmentMain("v4f_fragColor = getValue0();")}function rP(n,e=_S,t=1){return n.memoize.get(`elementWiseTextureShader:${t}:${pt(e)}`,()=>{let r=new Sr(n);r.addVarying("vec2","vTexCoord"),r.addUniform("sampler2D","uSampler",t),r.addInitializer(i=>{let a=[];for(let o=0;o<t;++o)a[o]=o;n.uniform1iv(i.uniform("uSampler"),a)});for(let i=0;i<t;++i)r.addFragmentCode(`
vec4 getValue${i}() {
  return texture(uSampler[${i}], vTexCoord);
}
`);return r.addUniform("mat4","uProjectionMatrix"),r.require(e),r.addAttribute("vec4","aVertexPosition"),r.addAttribute("vec2","aTexCoord"),r.setVertexMain("vTexCoord = aTexCoord; gl_Position = uProjectionMatrix * aVertexPosition;"),r.build()})}function iP(n){return n.memoize.get("trivialColorShader",()=>{let e=new Sr(n);return e.addVarying("vec4","vColor"),e.addOutputBuffer("vec4","v4f_fragColor",null),e.setFragmentMain("v4f_fragColor = vColor;"),e.addAttribute("vec4","aVertexPosition"),e.addAttribute("vec4","aColor"),e.addUniform("mat4","uProjectionMatrix"),e.setVertexMain("vColor = aColor; gl_Position = uProjectionMatrix * aVertexPosition;"),e.build()})}var VS=class extends j{constructor(){super(...arguments);this.width=Number.NaN;this.height=Number.NaN}hasSize(e,t){return this.width===e&&this.height===t}resize(e,t){this.hasSize(e,t)||(this.width=e,this.height=t,this.performResize())}},aP=class extends VS{constructor(e,t){super();this.gl=e;this.internalformat=t;this.renderbuffer=null;this.renderbuffer=e.createRenderbuffer()}performResize(){let{gl:e}=this;e.bindRenderbuffer(e.RENDERBUFFER,this.renderbuffer),e.renderbufferStorage(e.RENDERBUFFER,this.internalformat,this.width,this.height),e.bindRenderbuffer(e.RENDERBUFFER,null)}disposed(){this.gl.deleteRenderbuffer(this.renderbuffer)}attachToFramebuffer(e){let{gl:t}=this;t.framebufferRenderbuffer(t.FRAMEBUFFER,e,t.RENDERBUFFER,this.renderbuffer)}},oP=class extends aP{constructor(e,t=!1){super(e,t?e.DEPTH_STENCIL:e.DEPTH_COMPONENT16);this.gl=e;this.includeStencilBuffer=t}attachToFramebuffer(){let{gl:e}=this;super.attachToFramebuffer(this.includeStencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT)}},OS=class extends oP{constructor(e){super(e,!0)}};var sP=class extends j{constructor(e){super();this.gl=e;this.framebuffer=this.gl.createFramebuffer()}disposed(){let{gl:e}=this;e.deleteFramebuffer(this.framebuffer)}bind(){let{gl:e}=this;e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer)}unbind(){let{gl:e}=this;e.bindFramebuffer(e.FRAMEBUFFER,null)}},xa=class extends VS{constructor(e,t,r,i){super();this.gl=e;this.internalFormat=t;this.format=r;this.dataType=i;this.texture=e.createTexture()}performResize(){tP(this.gl,this.texture,this.width,this.height,this.internalFormat,this.format,this.dataType)}disposed(){this.gl.deleteTexture(this.texture)}attachToFramebuffer(e){let{gl:t}=this;t.framebufferTexture2D(t.FRAMEBUFFER,e,t.TEXTURE_2D,this.texture,0)}},NS=class extends xa{constructor(e,t=WebGL2RenderingContext.DEPTH_COMPONENT16,r=WebGL2RenderingContext.DEPTH_COMPONENT,i=WebGL2RenderingContext.UNSIGNED_SHORT){super(e,t,r,i)}attachToFramebuffer(){super.attachToFramebuffer(this.format===WebGL2RenderingContext.DEPTH_COMPONENT?WebGL2RenderingContext.DEPTH_ATTACHMENT:WebGL2RenderingContext.DEPTH_STENCIL_ATTACHMENT)}};function al(n,e,t=WebGL2RenderingContext.RGBA8,r=WebGL2RenderingContext.RGBA,i=WebGL2RenderingContext.UNSIGNED_BYTE){let a=new Array;for(let o=0;o<e;++o)a[o]=new xa(n,t,r,i);return a}var Fi=class extends j{constructor(e,t){super();this.gl=e;this.width=Number.NaN;this.height=Number.NaN;this.fullAttachmentList=new Array;this.attachmentVerified=!1;this.singleAttachmentList=[this.gl.COLOR_ATTACHMENT0];let{framebuffer:r=new sP(e),colorBuffers:i,depthBuffer:a}=t;this.framebuffer=this.registerDisposer(r),this.colorBuffers=i,this.depthBuffer=a,a!==void 0&&this.registerDisposer(a);let{fullAttachmentList:o}=this;i.forEach((l,c)=>{this.registerDisposer(l),o[c]=e.COLOR_ATTACHMENT0+c})}hasSize(e,t){return this.width===e&&this.height===t}bind(e,t){this.width=e,this.height=t,this.framebuffer.bind();let{gl:r,depthBuffer:i}=this;i!==void 0?(i.resize(e,t),i.attachToFramebuffer()):r.framebufferRenderbuffer(WebGL2RenderingContext.FRAMEBUFFER,WebGL2RenderingContext.DEPTH_STENCIL_ATTACHMENT,WebGL2RenderingContext.RENDERBUFFER,null),this.colorBuffers.forEach((a,o)=>{a.resize(e,t),a.attachToFramebuffer(r.COLOR_ATTACHMENT0+o)}),r.drawBuffers(this.fullAttachmentList),this.verifyAttachment(),r.viewport(0,0,e,t)}bindSingle(e){let{gl:t}=this;this.framebuffer.bind(),e!==0&&t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.TEXTURE_2D,null,0),t.bindTexture(t.TEXTURE_2D,null),this.colorBuffers[e].attachToFramebuffer(t.COLOR_ATTACHMENT0),t.drawBuffers(this.singleAttachmentList)}unbind(){this.framebuffer.unbind()}readPixelFloat32IntoBuffer(e,t,r,i,a=1,o=1){let{gl:l}=this;try{this.bindSingle(e),l.readPixels(t,r,a,o,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,i)}finally{this.framebuffer.unbind()}}verifyAttachment(){if(this.attachmentVerified)return;let{gl:e}=this,t=e.checkFramebufferStatus(e.FRAMEBUFFER);if(t!==e.FRAMEBUFFER_COMPLETE)throw new Error(`Framebuffer configuration not supported: ${t}`);this.attachmentVerified=!0}},Ca=class extends j{constructor(e,t){super();this.gl=e;this.shader=t;this.copyVertexPositionsBuffer=Xo(this.gl);this.copyTexCoordsBuffer=Xo(this.gl,0,0,1,1);this.registerDisposer(t)}draw(...e){let{gl:t,shader:r}=this;r.bind();let i=e.length;for(let l=0;l<i;++l)t.activeTexture(t.TEXTURE0+l),t.bindTexture(t.TEXTURE_2D,e[l]);t.uniformMatrix4fv(r.uniform("uProjectionMatrix"),!1,jf);let a=r.attribute("aVertexPosition");this.copyVertexPositionsBuffer.bindToVertexAttrib(a,2);let o=r.attribute("aTexCoord");this.copyTexCoordsBuffer.bindToVertexAttrib(o,2),t.drawArrays(t.TRIANGLE_FAN,0,4),t.disableVertexAttribArray(a),t.disableVertexAttribArray(o);for(let l=0;l<i;++l)t.activeTexture(t.TEXTURE0+l),t.bindTexture(t.TEXTURE_2D,null)}static get(e,t=_S,r=1){return e.memoize.get(`OffscreenCopyHelper:${r}:${pt(t)}`,()=>new Ca(e,rP(e,t,r)))}};var sz=!1,Vd=class extends j{constructor(e,t,r,i=new ao){super();this.channels=e;this.properties=t;this.bounds=r;this.visibility=i;this.framebuffers=[];this.producerVisibility=new ao;this.frameNumber=-1}getFramebuffers(e){let{framebuffers:t}=this,r=this.bounds.value.length;for(;t.length<r;){let i=new Fi(e,{colorBuffers:al(e,1,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)});t.push(i)}return t}get visibleHistograms(){return this.visibility.visible?this.bounds.value.length:0}disposed(){for(let e of this.framebuffers)e.dispose();this.framebuffers.length=0}},lP=Symbol("histogramDataSamplerTextureUnit"),cP=Symbol("histogramDepthTextureUnit"),BS=4096,lz=2**14,Od=class extends j{constructor(e){super();this.gl=e;this.shader=this.registerDisposer((()=>{let e=new Sr(this.gl);return e.addOutputBuffer("vec4","outputValue",0),e.addAttribute("float","aInput1"),e.addTextureSampler("sampler2D","uDataSampler",lP),e.addTextureSampler("sampler2D","uDepthSampler",cP),e.addVertexCode(WD),e.setVertexMain(`
float uRandomSeed = 0.0;
vec2 p = vec2(simpleFloatHash(vec2(aInput1 + float(gl_VertexID), uRandomSeed + float(gl_InstanceID))),
              simpleFloatHash(vec2(aInput1 + float(gl_VertexID) + 10.0, 5.0 + uRandomSeed + float(gl_InstanceID))));
float dataValue = texture(uDataSampler, p).x;
float stencilValue = texture(uDepthSampler, p).x;
if (stencilValue == 1.0) {
  gl_Position = vec4(2.0, 2.0, 2.0, 1.0);
} else {
  gl_Position = vec4(2.0 * (dataValue * 255.0 + 0.5) / 256.0 - 1.0, 0.0, 0.0, 1.0);
}
gl_PointSize = 1.0;
`),e.setFragmentMain(`
outputValue = vec4(1.0, 1.0, 1.0, 1.0);
`),e.build()})());this.inputIndexBuffer=this.registerDisposer(oo(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>new Uint8Array(BS)))}static get(e){return e.memoize.get("textureHistogramGeneration",()=>new Od(e))}compute(e,t,r,i,a){let{gl:o}=this,{shader:l}=this,c=i.getFramebuffers(o);l.bind(),o.enable(WebGL2RenderingContext.BLEND),o.disable(WebGL2RenderingContext.SCISSOR_TEST),o.disable(WebGL2RenderingContext.DEPTH_TEST),o.blendFunc(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE),this.inputIndexBuffer.value.bindToVertexAttrib(l.attribute("aInput1"),1,WebGL2RenderingContext.UNSIGNED_BYTE,!0);let d=l.textureUnit(lP),p=l.textureUnit(cP);o.activeTexture(WebGL2RenderingContext.TEXTURE0+p),o.bindTexture(WebGL2RenderingContext.TEXTURE_2D,t),so(o),o.activeTexture(WebGL2RenderingContext.TEXTURE0+d);let m=i.frameNumber;i.frameNumber=a;for(let g=0;g<e;++g)if(o.bindTexture(WebGL2RenderingContext.TEXTURE_2D,r[g].texture),so(o),c[g].bind(256,1),a!==m&&(o.clearColor(0,0,0,0),o.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT)),o.drawArraysInstanced(WebGL2RenderingContext.POINTS,0,BS,lz/BS),sz){let v=new Float32Array(256*4);o.readPixels(0,0,256,1,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,v);let b=new Float32Array(256);for(let x=0;x<256;++x)b[x]=v[x*4];console.log("histogram",b.join(" "))}o.disable(WebGL2RenderingContext.BLEND)}};function cz(n){let e=/\/\/.*?$|\/\*(?:.|\n)*?\*\/|'(?:\\.|[^\\'])*'|"(?:\\.|[^\\"])*"/mg;return n.replace(e,t=>t.startsWith("/")?t.replace(/[^\s]/g," "):t)}function uz(n){let e=/^(?:-?(?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?|"(?:\\.|[^\\"])*"|true|false|:|\s+|,|\[|\]|\{|\})/,t=0,r=n;e:for(;n.length;){let i=n.match(e);if(i===null)break;let a=i[0];switch(a.charAt(0)){case"[":case"{":++t;break;case"]":case"}":if(--t<0)return-1;break;case",":if(t===0)break e;break;default:if(t===0){n=n.substring(a.length);break e}break}n=n.substring(a.length)}return t!==0?-1:r.length-n.length}function dz(n){let e=[],t=new Map;if(n===void 0)return{errors:e,parameters:t};let r=/^([_a-z][_a-zA-Z0-9]*)[ \t]*=/;for(;n=n.trim(),n.length!=0;){let i=n.match(r);if(i===null){e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ...");break}let a=i[1];n=n.substring(i[0].length);let o=uz(n);if(o<=0){e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ...");break}let l;try{l=JSON.parse(n.substring(0,o))}catch{e.push(`Invalid #uicontrol parameter value for ${a}: ${l}`);break}t.has(a)?e.push(`Duplicate #uicontrol parameter: ${a}`):t.set(a,l),n=n.substring(o),n=n.trim(),n.length>0&&!n.startsWith(",")&&e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ..."),n=n.substring(1)}return{parameters:t,errors:e}}function pz(n,e){let t,r,i,a,o=[];n!=="float"&&n!=="uint"&&n!=="int"&&o.push("type must be float, int, or uint");for(let[l,c]of e){let d=()=>{if(typeof c!="number"){o.push(`Expected ${l} argument to be a number`);return}return(n==="int"||n==="uint")&&(Number.isInteger(c)||o.push(`Expected ${l} argument to be an integer`),n==="uint"&&c<0&&o.push(`Expected ${l} argument to be an unsigned integer`)),c};l==="min"?t=d():l==="max"?r=d():l==="default"?a=d():l==="step"?i=d():o.push(`Invalid parameter: ${l}`)}return t===void 0&&o.push("min must be specified"),r===void 0&&o.push("max must be specified"),t!==void 0&&r!==void 0&&(t>r&&o.push("min must be less than max"),i===void 0&&(n==="float"?i=(r-t)/100:i=1),a!==void 0?(a<t||a>r)&&o.push("default must be within valid range"):n==="float"?a=(t+r)/2:a=t),o.length>0?{errors:o}:{control:{type:"slider",valueType:n,min:t,max:r,step:i,default:a},errors:void 0}}function fz(n,e){let t=!1,r=[];n!=="bool"&&r.push("type must be bool");for(let[i,a]of e)if(i==="default"){if(typeof a!="boolean"){r.push(`Expected ${i} argument to be a boolean`);continue}t=a}else r.push(`Invalid parameter: ${i}`);return r.length>0?{errors:r}:{control:{type:"checkbox",valueType:n,default:t},errors:void 0}}function hz(n,e){let t="white",r=[];n!=="vec3"&&r.push("type must be vec3");for(let[i,a]of e)i==="default"?typeof a!="string"?r.push("Expected default argument to be a string"):t=a:r.push(`Invalid parameter: ${i}`);return r.length>0?{errors:r}:{control:{type:"color",valueType:n,defaultString:t,default:ma(t)},errors:void 0}}function uP(n,e){typeof n=="number"&&(n=[n]);let t=new Array(e);return Ne(t,n,r=>{if(!Number.isInteger(r)||r<0)throw new Error(`Expected non-negative integer, but received: ${JSON.stringify(r)}`);return r}),t}function mz(n,e,t){let{imageData:r,properties:i}=t;if(r!==void 0)return gz(n,e,r);if(i!==void 0)return yz(n,e,i);let a=[];return a.push("invlerp control not supported"),{errors:a}}function gz(n,e,t){let r=[];n!=="invlerp"&&r.push("type must be invlerp");let i=new Array(t.channelRank).fill(0),{dataType:a}=t,o=!0,l=Xr[a],c;for(let[d,p]of e)try{switch(d){case"range":{l=Ys(p,a);break}case"window":{c=ih(Ys(p,a));break}case"clamp":{typeof p!="boolean"?r.push(`Invalid clamp value: ${JSON.stringify(p)}`):o=p;break}case"channel":{i=uP(p,i.length);break}default:r.push(`Invalid parameter: ${d}`);break}}catch(m){r.push(`Invalid ${d} value: ${m.message}`)}return r.length>0?{errors:r}:{control:{type:"imageInvlerp",dataType:a,clamp:o,default:{range:l,window:c!=null?c:ah(l),channel:i}},errors:void 0}}function yz(n,e,t){let r=[];n!=="invlerp"&&r.push("type must be invlerp");let i=!0,a,o,l;for(let[d,p]of e)try{switch(d){case"range":{a=Uv(p);break}case"window":{o=Uv(p);break}case"clamp":{typeof p!="boolean"?r.push(`Invalid clamp value: ${JSON.stringify(p)}`):i=p;break}case"property":{let m=Q(p);if(!t.has(m))throw new Error(`Property not defined: ${JSON.stringify(l)}`);l=m;break}default:r.push(`Invalid parameter: ${d}`);break}}catch(m){r.push(`Invalid ${d} value: ${m.message}`)}if(r.length>0)return{errors:r};if(l===void 0)for(let d of t.keys()){l=d;break}let c=t.get(l);return a!==void 0&&(a=Lc(a,c)),o!==void 0&&(o=Lc(o,c)),{control:{type:"propertyInvlerp",clamp:i,properties:t,default:{range:a,window:o,property:l,dataType:c}},errors:void 0}}var vz=new Map([["slider",pz],["color",hz],["invlerp",mz],["checkbox",fz]]);function lo(n,e={}){n=cz(n);let t=/^[ \t]*#[ \t]*uicontrol[ \t]+(.*)$/mg,r=/^([_a-zA-Z][_a-zA-Z0-9]*)[ \t]+([a-z][a-zA-Z0-9_]*)(?:[ \t]+([a-z]+))?[ \t]*(?:\([ \t]*(.*)\)[ \t]*)?/,i=[],a=new Map,o=n.replace(t,(l,c,d)=>{var M;let p=c.match(r),m=()=>Math.max(0,n.substring(0,d).split(`
`).length-1);if(p===null)return i.push({line:m(),message:"Invalid #uicontrol syntax, expected: #uicontrol <type> <name> <control>(<param>=<value>, ...)"}),"";let g=p[1],v=p[2],b=(M=p[3])!=null?M:g,x=p[4],{parameters:C,errors:T}=dz(x);for(let D of T)i.push({line:m(),message:D});if(a.has(v)&&i.push({line:m(),message:`Duplicate definition for control ${v}`}),T.length>0)return"";let I=vz.get(b);if(I===void 0)return i.push({line:m(),message:`Invalid control type ${b}`}),"";let P=I(g,C,e);if(P.errors!==void 0){for(let D of P.errors)i.push({line:m(),message:D});return""}return a.set(v,P.control),""});return{source:n,code:o,errors:i,controls:a}}function dP(n){return`u_shaderControl_${n}`}function Gi(n,e){let{builderValues:t}=n;for(let[r,i]of n.parseResult.controls){let a=dP(r),o=t[r];switch(i.type){case"imageInvlerp":{let l=[rl(e,a,i.dataType,i.clamp),`
float ${a}() {
  return ${a}(getDataValue(${o.channel.join(",")}));
}
`];e.addFragmentCode(l),e.addFragmentCode(`#define ${r} ${a}
`);break}case"propertyInvlerp":{let l=o.property,c=i.properties.get(l),d=[rl(e,a,c,i.clamp),`
float ${a}() {
  return ${a}(prop_${l}());
}
`];e.addVertexCode(d),e.addVertexCode(`#define ${r} ${a}
`);break}case"checkbox":{let l=`#define ${r} ${o.value}
`;e.addFragmentCode(l),e.addVertexCode(l);break}default:{e.addUniform(`highp ${i.valueType}`,a),e.addVertexCode(`#define ${r} ${a}
`),e.addFragmentCode(`#define ${r} ${a}
`);break}}}}function Sz(n){let e={};for(let[t,r]of n)e[t]=r;return e}function bz(n,e){return e instanceof Map?Array.from(e.entries()):e}function pP(n){if(n!==void 0)return JSON.stringify(Sz(n),bz)}var fP=class{constructor(){this.changed=new re;this.controls=void 0}get value(){return this.controls}set value(e){pP(e)!==pP(this.controls)&&(this.controls=e,this.changed.dispatch())}};function xz(n,e,t){return n===void 0?t:(Z(n),{range:oe(n,"range",r=>Ys(r,e),t.range),window:oe(n,"window",r=>ih(Ys(r,e)),t.window),channel:oe(n,"channel",r=>uP(r,t.channel.length),t.channel)})}var hP=class extends Le{constructor(e,t){super(t,r=>xz(r,e,t));this.dataType=e;this.defaultValue=t}toJSON(){let{value:{range:e,window:t,channel:r},dataType:i,defaultValue:a}=this,o=gd(e,i,a.range),l=gd(t,i,a.window),c=xe(a.channel,r)?void 0:r;if(!(o===void 0&&l===void 0&&c===void 0))return{range:o,window:l,channel:c}}};function Cz(n,e,t){if(n===void 0)return t;Z(n);let r=oe(n,"property",a=>{if(a=Q(a),!e.has(a))throw new Error(`Invalid value: ${JSON.stringify(a)}`);return a},t.property),i=e.get(r);return{property:r,dataType:i,range:oe(n,"range",a=>Ys(a,i),t.range),window:oe(n,"window",a=>ih(Ys(a,i)),t.window)}}var mP=class extends Le{constructor(e,t){super(t,r=>Cz(r,e,t));this.properties=e;this.defaultValue=t}toJSON(){var p,m;let{value:{range:e,window:t,property:r,dataType:i},defaultValue:a}=this,o=Xr[i],l=gd(e!=null?e:o,i,(p=a.range)!=null?p:o),c=gd(t!=null?t:o,i,(m=a.window)!=null?m:o),d=r===a.property?void 0:r;if(!(l===void 0&&c===void 0&&d===void 0))return{range:l,window:c,property:d}}};function gP(n){switch(n.type){case"slider":return{trackable:new Le(n.default,e=>{let t;if(n.valueType==="float"?t=Qe(e):t=rt(e),t<n.min||t>n.max)throw new Error(`${JSON.stringify(e)} is outside valid range [${n.min}, ${n.max}]`);return t}),getBuilderValue:()=>null};case"color":return{trackable:new Go(n.default),getBuilderValue:()=>null};case"imageInvlerp":return{trackable:new hP(n.dataType,n.default),getBuilderValue:e=>({channel:e.channel,dataType:n.dataType})};case"propertyInvlerp":return{trackable:new mP(n.properties,n.default),getBuilderValue:e=>({property:e.property,dataType:e.dataType})};case"checkbox":return{trackable:new qe(n.default),getBuilderValue:e=>({value:e})}}}function yP(n,e){return JSON.stringify(n)+"\0"+e.source}function Qo(n){let e={},t=[];for(let[r,i]of n.controls){let{trackable:a,getBuilderValue:o}=gP(i),l=o(a.value);e[r]=l,i.type==="propertyInvlerp"&&t.push(l.property)}return{builderValues:e,parseResult:n,key:yP(e,n),referencedProperties:t}}var co=class extends j{constructor(e,t=Rr({}),r){super();this.fragmentMain=e;this.dataContext=t;this.channelCoordinateSpaceCombiner=r;this.changed=new re;this.controls=new fP;this.fragmentMainGeneration=-1;this.dataContextGeneration=-1;this.parseErrors_=[];this.processedFragmentMain_="";this.controlsGeneration=-1;this.parseResultChanged=new re;this.state_=new Map;this.unparsedJson=void 0;this.registerDisposer(e.changed.add(()=>this.handleFragmentMainChanged())),this.registerDisposer(this.controls.changed.add(()=>this.handleControlsChanged())),this.registerDisposer(this.dataContext.changed.add(()=>this.handleFragmentMainChanged())),this.handleFragmentMainChanged();let i=this;this.parseErrors={changed:this.parseResultChanged,get value(){return i.handleFragmentMainChanged(),i.parseErrors_}},this.processedFragmentMain={changed:this.parseResultChanged,get value(){return i.handleFragmentMainChanged(),i.processedFragmentMain_}},this.parseResult={changed:this.parseResultChanged,get value(){return i.parseResult_}},this.builderState=At((c,d)=>{let p={},m=[];for(let[g,{control:v,trackable:b,getBuilderValue:x}]of d){let C=x(b.value);p[g]=C,v.type==="propertyInvlerp"&&m.push(C.property)}return{key:yP(p,c),parseResult:c,builderValues:p,referencedProperties:m}},[this.parseResult,this],(c,d)=>c.key===d.key);let a=At(c=>{let d=[];for(let{control:p,trackable:m}of c.values())p.type==="imageInvlerp"&&d.push({channel:m.value.channel});return d},[this],(c,d)=>id(c,d,(p,m)=>xe(p.channel,m.channel))),o=At(c=>{let d=[];for(let{control:p,trackable:m}of c.values())p.type==="propertyInvlerp"&&d.push(m.value.property);return d},[this],xe),l=mn(c=>{var p;let d=[];for(let{control:m,trackable:g}of c.values())if(m.type==="imageInvlerp")d.push(g.value.window);else if(m.type==="propertyInvlerp"){let{dataType:v,range:b,window:x}=g.value;d.push((p=x!=null?x:b)!=null?p:Xr[v])}return d},this);this.histogramSpecifications=this.registerDisposer(new Vd(a,o,l))}handleFragmentMainChanged(){let e=this.fragmentMain.changed.count,t=this.dataContext.changed.count;if(e===this.fragmentMainGeneration&&t===this.dataContextGeneration)return;this.fragmentMainGeneration=e,this.dataContextGeneration=t;let r=this.dataContext.value;if(r===null)this.parseResult_={source:"",code:"",controls:new Map,errors:[{line:0,message:"Loading"}]},this.parseErrors_=[],this.processedFragmentMain_="",this.controls.value=void 0;else{let i=this.parseResult_=lo(this.fragmentMain.value,r);this.parseErrors_=i.errors,this.processedFragmentMain_=i.code,i.errors.length===0&&(this.controls.value=i.controls)}this.parseResultChanged.dispatch()}handleControlsChanged(){let e=this.controls.changed.count;if(e===this.controlsGeneration)return;this.controlsGeneration=e;let t=this.controls.value;if(t===void 0)return;let r=!1,{state_:i,unparsedJson:a}=this;for(let[o,l]of i)if(t.get(o)===void 0){l.trackable.changed.remove(this.changed.dispatch),i.delete(o),r=!0;continue}for(let[o,l]of t){let c=i.get(o);if(c!==void 0&&JSON.stringify(c.control)!==JSON.stringify(l)&&(c.trackable.changed.remove(this.changed.dispatch),c=void 0),c===void 0){let{trackable:d,getBuilderValue:p}=gP(l);c={control:l,trackable:d,getBuilderValue:p},c.trackable.changed.add(this.changed.dispatch),i.set(o,c),r=!0}if(a!==void 0&&a.hasOwnProperty(o)){r=!0;try{c.trackable.restoreState(a[o])}catch{}}}a!==void 0&&(r=!0),this.unparsedJson=void 0,r&&this.changed.dispatch()}get state(){return this.controls.changed.count!==this.controlsGeneration&&this.handleControlsChanged(),this.state_}get value(){return this.state}restoreState(e){if(e===void 0)return;let{state:t}=this;if(Z(e),this.controls.value===void 0){this.unparsedJson=e,this.changed.dispatch();return}for(let[i,a]of t){let{trackable:o}=a;if(o.reset(),e.hasOwnProperty(i))try{o.restoreState(e[i])}catch{}}this.unparsedJson=void 0}reset(){for(let e of this.state.values())e.trackable.reset();this.unparsedJson!==void 0&&(this.unparsedJson=void 0,this.changed.dispatch())}toJSON(){let{state:e}=this,{unparsedJson:t}=this;if(t!==void 0)return t;let r={},i=!0;for(let[a,o]of e){let l=o.trackable.toJSON();l!==void 0&&(r[a]=l,i=!1)}if(!i)return r}};function vP(n,e,t,r,i){var l;let a=dP(t),o=e.uniform(a);switch(r.type){case"slider":switch(r.valueType){case"int":case"uint":n.uniform1i(o,i);break;case"float":n.uniform1f(o,i)}break;case"color":n.uniform3fv(o,i);break;case"imageInvlerp":io(e,a,r.dataType,i.range);break;case"propertyInvlerp":{let{dataType:c}=i;io(e,a,c,(l=i.range)!=null?l:Xr[c]);break}case"checkbox":break}}function ni(n,e,t,r){let{state:i}=t;if(t.controls.value===r)for(let[a,o]of i)vP(n,e,a,o.control,o.trackable.value);else for(let[a,o]of r){let l=i.get(a),c=l!==void 0&&JSON.stringify(l.control)===JSON.stringify(o)?l.trackable.value:o.default;vP(n,e,a,o,c)}}var wz=!1;function SP(n,e){return{defineShader(t,r){let i=`prop_${r}`,a=`a_${i}`;t.addAttribute(`${n}`,a),t.addVertexCode(`${n} ${i}() { return ${a}; }`),t.addInitializer(o=>{let l=o.attribute(a),{gl:c}=o;o.vertexShaderInputBinders[i]=l===-1?{enable(){},disable(){},bind(){}}:{enable(d){c.enableVertexAttribArray(l),c.vertexAttribDivisor(l,d)},disable(){c.vertexAttribDivisor(l,0),c.disableVertexAttribArray(l)},bind(d,p){e(c,l,d,p)}}})}}}function US(n,e,t,r){return SP(n,(i,a,o,l)=>{i.vertexAttribPointer(a,e,t,r,o,l)})}function _c(n,e,t){return SP(n,(r,i,a,o)=>{r.vertexAttribIPointer(i,e,t,a,o)})}var bP={rgb:US("highp vec3",3,WebGL2RenderingContext.UNSIGNED_BYTE,!0),rgba:US("highp vec4",4,WebGL2RenderingContext.UNSIGNED_BYTE,!0),float32:US("highp float",1,WebGL2RenderingContext.FLOAT,!1),uint32:_c("highp uint",1,WebGL2RenderingContext.UNSIGNED_INT),int32:_c("highp int",1,WebGL2RenderingContext.INT),uint16:_c("highp uint",1,WebGL2RenderingContext.UNSIGNED_SHORT),int16:_c("highp int",1,WebGL2RenderingContext.SHORT),uint8:_c("highp uint",1,WebGL2RenderingContext.UNSIGNED_BYTE),int8:_c("highp int",1,WebGL2RenderingContext.BYTE)},xP=class extends j{constructor(e,t,r,i){super();this.gl=e;this.annotationType=t;this.rank=r;this.properties=i;let a=this.serializedGeometryBytesPerAnnotation=Un[t].serializedBytes(r),{offsets:o,serializedBytes:l,propertyGroupBytes:c}=Gv(r,a,i);this.serializedBytesPerAnnotation=l,this.propertyOffsets=o,this.propertyGroupBytes=c,this.geometryDataStride=c[0];let d=this.propertyGroupCumulativeBytes=new Array(c.length);d[0]=0;for(let p=1;p<c.length;++p)d[p]=d[p-1]+c[p-1]}defineProperties(e,t){let{properties:r,rank:i}=this;for(let c of t){let d=r[c];bP[d.type].defineShader(e,d.identifier,i)}let{propertyOffsets:a}=this,{propertyGroupBytes:o,propertyGroupCumulativeBytes:l}=this;e.addInitializer(c=>{let d=t.map(m=>c.vertexShaderInputBinders[`prop_${r[m].identifier}`]),p=d.length;c.vertexShaderInputBinders.properties={enable(m){for(let g=0;g<p;++g)d[g].enable(m)},bind(m,g){for(let v=0;v<p;++v){let{group:b,offset:x}=a[t[v]];d[v].bind(o[b],g+x+l[b]*m)}},disable(){for(let m=0;m<p;++m)d[m].disable()}}})}},uo=class extends xP{constructor(e,t,r,i,a,o,l){super(e,t,r,i);this.shaderControlState=a;this.fallbackShaderParameters=o;this.shaderError=l;this.histogramShaders=new Map}getDependentShader(e,t){return ti(this,this.gl,{memoizeKey:{t:"annotation",targetIsSliceView:this.targetIsSliceView,type:this.annotationType,subType:e,properties:this.properties,rank:this.rank},fallbackParameters:this.fallbackShaderParameters,parameters:this.shaderControlState.builderState,shaderError:this.shaderError,defineShader:(r,i)=>{let{rank:a,properties:o}=this,l=[],c=i.referencedProperties,d=i.parseResult.code;for(let m=0,g=o.length;m<g;++m){let v=o[m],b=`prop_${v.identifier}`;!c.includes(v.identifier)&&!d.match(new RegExp(`\\b${b}\\b`))||l.push(m)}this.defineProperties(r,l),r.addUniform("highp vec3","uColor"),r.addUniform("highp uint","uSelectedIndex"),r.addVarying("highp vec4","vColor"),r.addUniform("highp vec3","uSubspaceMatrix",a),r.addUniform("highp mat4","uModelViewProjection"),r.addUniform("highp float","uModelClipBounds",a*2),r.addUniform("highp uint","uPickID"),r.addVarying("highp uint","vPickID","flat"),r.addVertexCode(Bi),r.addVertexCode(`
vec3 defaultColor() { return uColor; }
highp uint getPickBaseOffset() { return uint(gl_InstanceID) * ${this.pickIdsPerInstance}u; }
`),r.addFragmentCode(`
void emitAnnotation(vec4 color) {
  emit(color, vPickID);
}
`);let p=`
float getSubspaceClipCoefficient(float modelPoint[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${a}; ++i) {
    float d = abs(modelPoint[i] - uModelClipBounds[i]) * uModelClipBounds[${a} + i];
    coefficient *= max(0.0, 1.0 - d);
  }
  return coefficient;
}
`;r.addVertexCode(p),r.addFragmentCode(p),r.addVertexCode(`
vec3 projectModelVectorToSubspace(float modelPoint[${this.rank}]) {
  vec3 result = vec3(0.0, 0.0, 0.0);
  for (int i = 0; i < ${a}; ++i) {
    result += uSubspaceMatrix[i] * modelPoint[i];
  }
  return result;
}

float getMaxEndpointSubspaceClipCoefficient(float modelPointA[${this.rank}],  float modelPointB[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${a}; ++i) {
    float dA = abs(modelPointA[i] - uModelClipBounds[i]) * uModelClipBounds[${a} + i];
    float dB = abs(modelPointB[i] - uModelClipBounds[i]) * uModelClipBounds[${a} + i];
    coefficient *= max(0.0, 1.0 - min(dA, dB));
  }
  return coefficient;
}

float getMaxSubspaceClipCoefficient(float modelPointA[${this.rank}],  float modelPointB[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${a}; ++i) {
    float a = modelPointA[i];
    float b = modelPointB[i];
    float c = uModelClipBounds[i];
    float x = clamp(c, min(a, b), max(a, b));
    float d = abs(x - c) * uModelClipBounds[${a} + i];
    coefficient *= max(0.0, 1.0 - d);
  }
  return coefficient;
}

`),Gi(i,r),r.addVertexCode(`
const bool PROJECTION_VIEW = ${!this.targetIsSliceView};
bool ng_discardValue;
#define discard ng_discard()
void ng_discard() {
  ng_discardValue = true;
}
void setLineColor(vec4 startColor, vec4 endColor);
void setLineWidth(float width);

void setEndpointMarkerColor(vec4 startColor, vec4 endColor);
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor);
void setEndpointMarkerSize(float startSize, float endSize);
void setEndpointMarkerBorderWidth(float startSize, float endSize);

void setPointMarkerColor(vec4 color);
void setPointMarkerBorderColor(vec4 color);
void setPointMarkerSize(float size);
void setPointMarkerBorderWidth(float size);
void setPointMarkerBorderColor(vec3 color) { setPointMarkerBorderColor(vec4(color, 1.0)); }

void setEllipsoidFillColor(vec4 color);

void setBoundingBoxBorderColor(vec4 color);
void setBoundingBoxBorderWidth(float size);
void setBoundingBoxFillColor(vec4 color);

void setEndpointMarkerColor(vec3 startColor, vec3 endColor) {
  setEndpointMarkerColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setEndpointMarkerBorderColor(vec3 startColor, vec3 endColor) {
  setEndpointMarkerBorderColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setEndpointMarkerColor(vec3 color) { setEndpointMarkerColor(color, color); }
void setEndpointMarkerColor(vec4 color) { setEndpointMarkerColor(color, color); }
void setEndpointMarkerBorderColor(vec3 color) { setEndpointMarkerBorderColor(color, color); }
void setEndpointMarkerBorderColor(vec4 color) { setEndpointMarkerBorderColor(color, color); }
void setEndpointMarkerSize(float size) { setEndpointMarkerSize(size, size); }
void setEndpointMarkerBorderWidth(float size) { setEndpointMarkerBorderWidth(size, size); }
void setLineColor(vec4 color) { setLineColor(color, color); }
void setLineColor(vec3 color) { setLineColor(vec4(color, 1.0)); }
void setLineColor(vec3 startColor, vec3 endColor) { setLineColor(vec4(startColor, 1.0), vec4(endColor, 1.0)); }
void setColor(vec4 color) {
  setPointMarkerColor(color);
  setLineColor(color);
  setEndpointMarkerColor(color);
  setBoundingBoxBorderColor(color);
  setEllipsoidFillColor(vec4(color.rgb, color.a * (PROJECTION_VIEW ? 1.0 : 0.5)));
}
void setEllipsoidFillColor(vec3 color) { setEllipsoidFillColor(vec4(color, 1.0)); }

void setBoundingBoxFillColor(vec3 color) { setBoundingBoxFillColor(vec4(color, 1.0)); }
void setBoundingBoxBorderColor(vec3 color) { setBoundingBoxBorderColor(vec4(color, 1.0)); }

void setColor(vec3 color) { setColor(vec4(color, 1.0)); }
void userMain();
`);for(let[m,g]of FS)m!==this.annotationType&&g.defineShaderNoOpSetters(r);t(r),r.addVertexCode(`
#define main userMain
`+Ui(i.parseResult.code)+`
#undef main
`)}})}setPartIndex(e,...t){let r=`
void setPartIndex(${t.map((i,a)=>`highp uint partIndex${a}`).join()}) {
  highp uint pickID = uPickID;
  highp uint pickBaseOffset = getPickBaseOffset();
${t.map((i,a)=>`highp uint pickOffset${a} = pickBaseOffset + partIndex${a};`).join(`
`)}
`;return t.length===0&&(r+=`
  highp uint pickOffset0 = pickBaseOffset;
`),r+=`
  vPickID = pickID + pickOffset0;
  highp uint selectedIndex = uSelectedIndex;
if (selectedIndex == pickBaseOffset${t.map((i,a)=>` || selectedIndex == pickOffset${a}`).join("")}) {
    vColor = vec4(mix(vColor.rgb, vec3(1.0, 1.0, 1.0), 0.75), vColor.a);
  }
}
`,e.addVertexCode(r),`setPartIndex(${t.join()})`}get invokeUserMain(){return`
ng_discardValue = false;
userMain();
if (ng_discardValue) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
`}getCrossSectionFadeFactor(){return this.targetIsSliceView?"(clamp(1.0 - 2.0 * abs(0.5 - gl_FragCoord.z), 0.0, 1.0))":"(1.0)"}enable(e,t,r){let{shader:i,parameters:a}=e(t.renderContext.emitter);if(i===null)return;i.bind();let{gl:o}=this,{renderContext:l}=t,{annotationLayer:c}=t;if(ni(o,i,this.shaderControlState,a.parseResult.controls),o.uniform3fv(i.uniform("uSubspaceMatrix"),t.subspaceMatrix),o.uniform1fv(i.uniform("uModelClipBounds"),t.modelClipBounds),o.uniformMatrix4fv(i.uniform("uModelViewProjection"),!1,t.modelViewProjectionMatrix),l.emitPickID&&o.uniform1ui(i.uniform("uPickID"),t.basePickId),l.emitColor){let p=c.state.displayState.color.value;o.uniform3f(i.uniform("uColor"),p[0],p[1],p[2]),o.uniform1ui(i.uniform("uSelectedIndex"),t.selectedIndex)}let d=i.vertexShaderInputBinders.properties;d.enable(1),o.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),d.bind(t.count,t.bufferOffset),r(i),d.disable()}getHistogramShader(e){let{histogramShaders:t}=this,r=t.get(e);if(r===void 0){let{gl:i}=this;r=i.memoize.get(JSON.stringify({t:"propertyHistogramGenerator",propertyType:e}),()=>{let a=new Sr(i);return this.defineHistogramShader(a,e),a.build()}),t.set(e,r)}return r}defineHistogramShader(e,t){bP[t].defineShader(e,"histogram",0),e.addOutputBuffer("vec4","out_histogram",0);let i="invlerpForHistogram",a=Sd[t];e.addVertexCode(rl(e,i,a,!1)),e.setVertexMain(`
float x = invlerpForHistogram(prop_histogram());
if (x < 0.0) x = 0.0;
else if (x > 1.0) x = 1.0;
else x = (1.0 + x * 253.0) / 255.0;
gl_Position = vec4(2.0 * (x * 255.0 + 0.5) / 256.0 - 1.0, 0.0, 0.0, 1.0);
gl_PointSize = 1.0;
`),e.setFragmentMain("out_histogram = vec4(1.0, 1.0, 1.0, 1.0);")}computeHistograms(e,t){let{histogramSpecifications:r}=this.shaderControlState,i=r.properties.value,a=i.length,{properties:o}=this,l=o.length,{propertyOffsets:c}=this,{propertyGroupBytes:d,propertyGroupCumulativeBytes:p}=this,{gl:m}=this;m.enable(WebGL2RenderingContext.BLEND),m.disable(WebGL2RenderingContext.SCISSOR_TEST),m.disable(WebGL2RenderingContext.DEPTH_TEST),m.blendFunc(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE);let g=r.getFramebuffers(m),v=r.frameNumber;r.frameNumber=t,m.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,e.buffer.buffer);for(let b=0;b<a;++b){let x=i[b];for(let C=0;C<l;++C){let T=o[C];if(T.identifier!==x)continue;let I=T.type,P=Sd[I],M=this.getHistogramShader(I);M.bind();let D=M.vertexShaderInputBinders.prop_histogram;D.enable(0);let{group:E,offset:V}=c[C];if(io(M,"invlerpForHistogram",P,r.bounds.value[b]),D.bind(d[E],e.bufferOffset+V+p[E]*e.count),g[b].bind(256,1),t!==v&&(m.clearColor(0,0,0,0),m.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT)),m.drawArrays(WebGL2RenderingContext.POINTS,0,e.count),wz){let O=new Float32Array(256*4);m.readPixels(0,0,256,1,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,O);let B=new Float32Array(256);for(let z=0;z<256;++z)B[z]=O[z*4];console.log("histogram",B.join(" "))}D.disable();break}}m.disable(WebGL2RenderingContext.BLEND)}},FS=new Map;function Zo(n,e){FS.set(n,e)}function es(n){return FS.get(n)}var Ze;(function(c){c[c.GPU_MEMORY=0]="GPU_MEMORY",c[c.SYSTEM_MEMORY=1]="SYSTEM_MEMORY",c[c.SYSTEM_MEMORY_WORKER=2]="SYSTEM_MEMORY_WORKER",c[c.DOWNLOADING=3]="DOWNLOADING",c[c.QUEUED=4]="QUEUED",c[c.NEW=5]="NEW",c[c.FAILED=6]="FAILED",c[c.EXPIRED=7]="EXPIRED"})(Ze||(Ze={}));var Uh=8,wa;(function(l){l[l.FIRST_TIER=0]="FIRST_TIER",l[l.FIRST_ORDERED_TIER=0]="FIRST_ORDERED_TIER",l[l.VISIBLE=0]="VISIBLE",l[l.PREFETCH=1]="PREFETCH",l[l.LAST_ORDERED_TIER=1]="LAST_ORDERED_TIER",l[l.RECENT=2]="RECENT",l[l.LAST_TIER=2]="LAST_TIER"})(wa||(wa={}));var GS=3,Nd;(function(t){t[t.totalTime=0]="totalTime",t[t.totalChunks=1]="totalChunks"})(Nd||(Nd={}));var Ta;(function(r){r[r.numChunks=0]="numChunks",r[r.systemMemoryBytes=1]="systemMemoryBytes",r[r.gpuMemoryBytes=2]="gpuMemoryBytes"})(Ta||(Ta={}));var La=3,Tz=2,d7=Uh*GS*La+Tz;function ts(n,e){return n*GS+e}function WS(n){return Uh*GS*La+n}var CP="ChunkQueueManager",wP="ChunkManager",TP="ChunkSource.invalidate",LP="ChunkQueueManager.requestChunkStatistics",kP="ChunkManager.chunkLayerStatistics",po=class{constructor(){this.numVisibleChunksNeeded=0;this.numVisibleChunksAvailable=0;this.numPrefetchChunksNeeded=0;this.numPrefetchChunksAvailable=0}};var EP=!1,br=class{constructor(e){this.source=e;this.state=Ze.SYSTEM_MEMORY}get gl(){return this.source.gl}copyToGPU(e){this.state=Ze.GPU_MEMORY}freeGPUMemory(e){this.state=Ze.SYSTEM_MEMORY}};function DP(n){if(typeof n!="number"||n<0)throw new Error(`Expected non-negative number as limit, but received: ${JSON.stringify(n)}`);return n}var Vc=class{constructor({defaultItemLimit:e=Number.POSITIVE_INFINITY,defaultSizeLimit:t=Number.POSITIVE_INFINITY}={}){this.sizeLimit=new Le(t,DP),this.itemLimit=new Le(e,DP)}},Bd=class extends Sn{constructor(e,t,r,i){super();this.gl=t;this.frameNumberCounter=r;this.capacities=i;this.visibleChunksChanged=new re;this.pendingChunkUpdates=null;this.pendingChunkUpdatesTail=null;this.chunkUpdateDeadline=null;this.chunkUpdateDelay=30;this.enablePrefetch=new qe(!0,!0);let a=o=>({itemLimit:this.registerDisposer(mt.makeFromExisting(e,o.itemLimit)).rpcId,sizeLimit:this.registerDisposer(mt.makeFromExisting(e,o.sizeLimit)).rpcId});this.initializeCounterpart(e,{gpuMemoryCapacity:a(i.gpuMemory),systemMemoryCapacity:a(i.systemMemory),downloadCapacity:a(i.download),computeCapacity:a(i.compute),enablePrefetch:this.registerDisposer(mt.makeFromExisting(e,this.enablePrefetch)).rpcId})}scheduleChunkUpdate(){let e=this.chunkUpdateDeadline,t;e===null||Date.now()<e?t=0:t=this.chunkUpdateDelay,setTimeout(this.processPendingChunkUpdates.bind(this),t)}processPendingChunkUpdates(e=!1){let t=this.chunkUpdateDeadline;!e&&t===null&&(t=Date.now()+30);let r=!1,i=0;for(;;){if(!e&&Date.now()>t){this.chunkUpdateDeadline=null,setTimeout(()=>this.processPendingChunkUpdates(),this.chunkUpdateDelay);break}let a=this.pendingChunkUpdates;if(a==null)break;if(this.applyChunkUpdate(a)&&(r=!0),++i,(this.pendingChunkUpdates=a.nextUpdate)==null){this.pendingChunkUpdatesTail=null;break}}return r&&this.visibleChunksChanged.dispatch(),i}handleFetch_(e,t){let{resolve:r,reject:i,cancellationToken:a}=t.promise;if(a.isCanceled){i(Kn);return}let o=t.key,l=e.chunks.get(o);if(!l){i(new Error(`No chunk found at ${o} for source ${e.constructor.name}`));return}let c=l.data;if(!c){i(new Error(`At ${o} for source ${e.constructor.name}: chunk has no data`));return}r({value:c})}applyChunkUpdate(e){let t=!1,{rpc:r}=this,i=r.get(e.source);if(EP&&console.log(`${Date.now()} Chunk.update processed: ${i.rpcId} ${e.id} ${e.state}`),e.promise!==void 0)this.handleFetch_(i,e);else if(e.id===void 0){for(let a of i.chunks.keys())i.deleteChunk(a);t=!0}else{let a=e.state;if(a===Ze.EXPIRED)i.deleteChunk(e.id);else{let o,l=e.id;e.new?(o=i.getChunk(e),i.addChunk(l,o)):o=i.chunks.get(l);let c=o.state;if(a!==c)switch(a){case Ze.GPU_MEMORY:o.copyToGPU(this.gl),t=!0;break;case Ze.SYSTEM_MEMORY:o.freeGPUMemory(this.gl);break;default:throw new Error(`INTERNAL ERROR: Invalid chunk state: ${Ze[a]}`)}}}return t}flushPendingChunkUpdates(){return this.processPendingChunkUpdates(!0)}async getStatistics(){let e=this.rpc,t=await e.promiseInvoke(LP,{queue:this.rpcId}),r=new Map;for(let[i,a]of t){let o=e.get(i);o!==void 0&&r.set(o,a)}return r}};Bd=kt([bn(CP)],Bd);function PP(n,e){let t=n.get(e.source);EP&&console.log(`${Date.now()} Chunk.update received: ${t.rpcId} ${e.id} ${e.state} with chunkDataSize ${e.chunkDataSize}`);let r=t.chunkManager.chunkQueueManager;if(t.immediateChunkUpdates){r.applyChunkUpdate(e)&&r.visibleChunksChanged.dispatch();return}let i=r.pendingChunkUpdatesTail;i==null?(r.pendingChunkUpdates=e,r.pendingChunkUpdatesTail=e,r.scheduleChunkUpdate()):(i.nextUpdate=e,r.pendingChunkUpdatesTail=e)}wt("Chunk.update",function(n){PP(this,n)});Mh("Chunk.retrieve",function(n,e){return new Promise((t,r)=>{n.promise={resolve:t,reject:r,cancellationToken:e},PP(this,n)})});wt(kP,function(n){let e=this.get(n.id);for(let t of e.prevStatisticsLayers)t.numVisibleChunksNeeded=0,t.numVisibleChunksAvailable=0,t.numPrefetchChunksNeeded=0,t.numPrefetchChunksAvailable=0;e.prevStatisticsLayers.length=0;for(let t of n.layers){let r=this.get(t.id);if(r===void 0)continue;let i=r.layerChunkProgressInfo;i.numVisibleChunksAvailable=t.numVisibleChunksAvailable,i.numVisibleChunksNeeded=t.numVisibleChunksNeeded,i.numPrefetchChunksAvailable=t.numPrefetchChunksAvailable,i.numPrefetchChunksNeeded=t.numPrefetchChunksNeeded,e.prevStatisticsLayers.push(i)}e.layerChunkStatisticsUpdated.dispatch()});var Ud=class extends Sn{constructor(e){super();this.chunkQueueManager=e;this.memoize=new xd;this.prevStatisticsLayers=[];this.layerChunkStatisticsUpdated=new re;this.registerDisposer(e.addRef()),this.initializeCounterpart(e.rpc,{chunkQueueManager:e.rpcId})}get gl(){return this.chunkQueueManager.gl}getChunkSource(e,t){let r=e.encodeOptions(t);r.constructorId=pt(e);let i=Bn(r);return this.memoize.get(i,()=>{let a=new e(this,t);return a.initializeCounterpart(this.rpc,{}),a.key=r,a})}};Ud=kt([bn(wP)],Ud);var Gn=class extends Sn{constructor(e,t={}){super();this.chunkManager=e;this.chunks=new Map;this.immediateChunkUpdates=!1}initializeCounterpart(e,t){t.chunkManager=this.chunkManager.rpcId,super.initializeCounterpart(e,t)}get gl(){return this.chunkManager.chunkQueueManager.gl}deleteChunk(e){let t=this.chunks.get(e);t.state===Ze.GPU_MEMORY&&t.freeGPUMemory(this.gl),this.chunks.delete(e)}addChunk(e,t){this.chunks.set(e,t)}getChunk(e){throw new Error("Not implemented.")}invalidateCache(){this.rpc.invoke(TP,{id:this.rpcId})}static encodeOptions(e){return{}}};function lt(n,e){let t=class extends n{constructor(...i){super(...i);let a=i[1];this.parameters=a.parameters}initializeCounterpart(i,a){a.parameters=this.parameters,super.initializeCounterpart(i,a)}static encodeOptions(i){return Object.assign({parameters:i.parameters},super.encodeOptions(i))}};return t=kt([bn(e.RPC_ID)],t),t}var ka=class extends Sn{constructor(e){super();this.layerChunkProgressInfo=e}};function Ie(n){for(;;){let e=n.firstChild;if(!e)break;n.removeChild(e)}}function Ye(n){let{parentElement:e}=n;return e?(e.removeChild(n),!0):!1}function xn(n,e=Math.max(1,n.value.length)){let t=`${e}ch`;n.style.width!==t&&(n.style.width="0px",n.offsetWidth,n.style.width=t)}function Wn(n,e){let t=n.firstElementChild;for(let r of e)r!==t&&n.insertBefore(r,t),t=r.nextElementSibling;for(;t!==null;){let r=t.nextElementSibling;n.removeChild(t),t=r}}function Fd(n){return n instanceof HTMLElement?!!(n instanceof HTMLInputElement||n instanceof HTMLTextAreaElement||n.isContentEditable):!1}function IP(n){let e=n.cloneNode(!0);return e.style.position="absolute",document.body.appendChild(e),e.getBoundingClientRect()}var AP=class extends j{constructor(e){super();this.redraw=e}},Cn=class extends j{constructor(e,t,r=new It(It.VISIBLE)){super();this.model=e;this.render=t;this.visibility=r;this.element=document.createElement("div");this.generation=-1;this.currentViewDisposer=void 0;this.debouncedUpdateView=this.registerCancellable(We(()=>this.updateView()));this.element.style.display="contents",this.registerDisposer(e.changed.add(this.debouncedUpdateView)),this.registerDisposer(r.changed.add(()=>{this.visible&&this.debouncedUpdateView()})),this.updateView()}get visible(){return this.visibility.visible}updateView(){if(!this.visible)return;let{model:e}=this;if(e.changed.count===this.generation)return;this.disposeCurrentView();let r=this.currentViewDisposer=new AP(this.debouncedUpdateView);this.render(e.value,this.element,r)}disposeCurrentView(){let{currentViewDisposer:e}=this;e!==void 0&&e.dispose(),Ie(this.element)}disposed(){this.disposeCurrentView(),super.disposed()}};var Vt=class extends j{constructor(e=new It(It.VISIBLE)){super();this.visibility=e;this.element=document.createElement("div");let{element:t}=this;t.classList.add("neuroglancer-tab-content")}get visible(){return this.visibility.visible}disposed(){Ye(this.element),super.disposed()}},MP=class extends j{constructor(){super(...arguments);this.changed=new re;this.options=new Map;this.optionsChanged=new re;this.selectedValue=void 0;this.defaultValue=void 0;this.ready_=!0}get value(){let{selectedValue:e}=this;return e!==void 0?e:this.defaultValue}set default(e){this.defaultValue!==e&&(this.defaultValue=e,this.changed.dispatch())}get default(){return this.defaultValue}set value(e){e!==void 0&&this.ready_&&!this.options.has(e)&&(e=void 0);let{selectedValue:t}=this;t!==e&&(this.selectedValue=e,this.changed.dispatch())}get validValue(){let e=this.selectedValue;return e===void 0||!this.options.has(e)?this.defaultValue:e}add(e,t){let{options:r}=this;if(r.has(e))throw new Error(`Option already defined: ${JSON.stringify(e)}.`);r.set(e,t),this.optionsChanged.dispatch(),this.defaultValue===void 0&&(this.default=e)}remove(e){let{options:t}=this;if(!t.has(e))throw new Error(`Option is not defined: ${JSON.stringify(e)}.`);t.delete(e),this.optionsChanged.dispatch()}toJSON(){let{value:e,defaultValue:t}=this;if(e!==t)return e}reset(){this.value=void 0}get ready(){return this.ready_}set ready(e){e!==this.ready_&&(this.ready_=e,e&&(this.value=this.value),this.changed.dispatch())}restoreState(e){typeof e!="string"&&(e=void 0),this.value=e}},RP=class extends j{constructor(e,t,r=new It(It.VISIBLE),i=!1){super();this.getter=e;this.selected=t;this.visibility=r;this.invalidateByDefault=i;this.element=document.createElement("div");this.tabs=new Map;this.tabVisibilityChanged=new ze;this.debouncedUpdateSelectedTab=this.registerCancellable(We(()=>this.updateSelectedTab()));let{element:a}=this;a.className="neuroglancer-stack-view",this.registerDisposer(r.changed.add(this.debouncedUpdateSelectedTab)),this.registerDisposer(t.changed.add(this.debouncedUpdateSelectedTab)),this.updateSelectedTab()}get visible(){return this.visibility.visible}flush(){this.debouncedUpdateSelectedTab.flush()}invalidate(e){let{tabs:t}=this,r=t.get(e);r!==void 0&&(r.dispose(),t.delete(e),e===this.displayedTab&&(this.displayedTab=void 0,this.debouncedUpdateSelectedTab()))}hideTab(e){let t=this.tabs.get(e);t!==void 0&&(t.visibility.value=It.IGNORED,t.element.style.display="none"),this.tabVisibilityChanged.dispatch(e,!1)}showTab(e){let{tabs:t}=this,r=t.get(e);r===void 0&&(r=this.getter(e),this.element.appendChild(r.element),t.set(e,r)),r.element.style.display="",r.visibility.value=It.VISIBLE,this.tabVisibilityChanged.dispatch(e,!0)}updateSelectedTab(){let{displayedTab:e}=this,t=this.visible?this.selected.value:void 0;t===e&&(t===void 0||this.tabs.has(t))||(e!==void 0&&this.hideTab(e),this.invalidateByDefault&&this.invalidateAll(),this.displayedTab=t,t!==void 0&&this.showTab(t))}invalidateAll(e=void 0){let{tabs:t}=this;for(let[r,i]of t)e!==void 0&&e(r)||(t.delete(r),i.dispose());this.debouncedUpdateSelectedTab()}disposed(){this.invalidateAll(),Ye(this.element),super.disposed()}},zS=class extends MP{};function Lz(n,e){let t="neuroglancer-selected-tab-label";e?n.classList.add(t):n.classList.remove(t)}var HS=class extends j{constructor(e,t=new It(It.VISIBLE)){super();this.visibility=t;this.element=document.createElement("div");this.tabBar=document.createElement("div");this.tabLabels=new Map;this.tabsGeneration=-1;this.debouncedUpdateView=this.registerCancellable(We(()=>this.updateTabs()));this.tabs=e.tabs,this.selectedTab=e.selectedTab,this.handleTabElement=e.handleTabElement;let{element:r,tabBar:i}=this;r.className="neuroglancer-tab-view",i.className="neuroglancer-tab-view-bar",r.appendChild(i),this.registerDisposer(t.changed.add(this.debouncedUpdateView));let a=this.stack=this.registerDisposer(new RP(e.makeTab,e.selectedTab,this.visibility));r.appendChild(a.element),this.registerDisposer(e.tabs.changed.add(this.debouncedUpdateView));let o=this.selectedTab.value;this.registerDisposer(e.selectedTab.changed.add(()=>{let c=this.tabs.value.find(({id:d})=>d===o);(c==null?void 0:c.hidden)?(this.tabs.changed.count++,this.debouncedUpdateView()):this.updateTabLabelStyles(),o=this.selectedTab.value})),this.updateTabs()}get visible(){return this.visibility.visible}updateTabLabelStyles(){let e=this.selectedTab.value;for(let[t,r]of this.tabLabels)Lz(r,t===e)}updateTabs(){this.tabsGeneration!==this.tabs.changed.count&&(this.destroyTabs(),this.visible&&this.makeTabs())}destroyTabs(){if(this.tabsGeneration!==-1){if(this.tabLabels.clear(),!this.visible)this.stack.invalidateAll();else{let e=this.tabs.value;this.stack.invalidateAll(t=>e.find(({id:r})=>r===t)!==void 0)}Ie(this.tabBar),this.tabsGeneration=-1}}makeTabs(){let{tabBar:e,tabLabels:t,handleTabElement:r}=this;for(let{id:i,label:a,hidden:o}of this.tabs.value){if(o&&i!==this.selectedTab.value)continue;let l=document.createElement("div");l.classList.add("neuroglancer-tab-label"),l.textContent=a,l.addEventListener("click",()=>{this.selectedTab.value=i}),r!==void 0&&r(i,l),t.set(i,l),e.appendChild(l)}this.updateTabLabelStyles(),this.tabsGeneration=this.tabs.changed.count}disposed(){Ie(this.tabBar),this.tabLabels.clear(),Ye(this.element),super.disposed()}};var Kt;(function(i){i[i.MIN_REPRESENTATIVE=0]="MIN_REPRESENTATIVE",i[i.MAX_REPRESENTATIVE=1]="MAX_REPRESENTATIVE",i[i.REPRESENTATIVE_EXCLUDED=2]="REPRESENTATIVE_EXCLUDED",i[i.NONREPRESENTATIVE_EXCLUDED=4]="NONREPRESENTATIVE_EXCLUDED"})(Kt||(Kt={}));var $S=class extends Vt{constructor(e){super();this.layer=e;let{element:t}=this;t.appendChild(this.registerDisposer(new Cn(e.displayState.segmentationGroupState.value.graph,(r,i,a)=>{(r==null?void 0:r.tabContents)&&i.appendChild(r.tabContents(e,a,this))})).element)}},ol=class{},sl=class extends j{constructor(e,t){super();this.graph=e;this.segmentsState=t}createRenderLayers(e,t,r){return[]}};function Oc(n){return!(n.high>>>31)}var jS=new X(4294967295,4294967295);var JS=["visibleSegments","segmentEquivalences","temporaryVisibleSegments","temporarySegmentEquivalences","useTemporaryVisibleSegments","useTemporarySegmentEquivalences"];function _P(n,e,t){n.registerDisposer(e.visibleSegments.changed.add(t)),n.registerDisposer(e.segmentEquivalences.changed.add(t))}function VP(n,e,t){n.registerDisposer(e.temporaryVisibleSegments.changed.add(t)),n.registerDisposer(e.temporarySegmentEquivalences.changed.add(t)),n.registerDisposer(e.useTemporaryVisibleSegments.changed.add(t)),n.registerDisposer(e.useTemporarySegmentEquivalences.changed.add(t))}function Nr(n){return`${n.low},${n.high}`}function kz(n){return!!(n.high>>>31)}function qS(n){return n.useTemporaryVisibleSegments.value?n.temporaryVisibleSegments:n.visibleSegments}function Ez(n){return n.useTemporarySegmentEquivalences.value?n.temporarySegmentEquivalences:n.segmentEquivalences}function Ea(n,e){let t=qS(n),r=Ez(n),i=r.disjointSets.visibleSegmentEquivalencePolicy.value;for(let a of t.unsafeKeys())if(i&Kt.NONREPRESENTATIVE_EXCLUDED){let o=r.get(a);e(a,o)}else{if(!r.disjointSets.isMinElement(a))continue;for(let o of r.setElements(a))i&Kt.REPRESENTATIVE_EXCLUDED&&i&Kt.MAX_REPRESENTATIVE&&kz(o)||e(o,a)}}var HP=ot(Et());var YS=ot(Et());var OP="rendered_view.addLayer",NP="rendered_view.removeLayer",BP="SharedProjectionParameters",UP="SharedProjectionParameters.changed";var xr;(function(r){r[r.info=0]="info",r[r.warning=1]="warning",r[r.error=2]="error"})(xr||(xr={}));var Wi=class{constructor(){this.changed=new re;this.messages=[];this.children=[]}addMessage(e){this.messages.push(e),this.changed.dispatch()}clearMessages(){let{messages:e}=this;e.length!==0&&(e.length=0,this.changed.dispatch())}isEmpty(){return this.messages.length===0&&!this.children.some(e=>!e.isEmpty())}addChild(e){return this.children.push(e),e.changed.add(this.changed.dispatch),e.isEmpty()||this.changed.dispatch(),()=>{let{children:t}=this;t.splice(t.indexOf(e),1),e.changed.remove(this.changed.dispatch),e.isEmpty()||this.changed.dispatch()}}*[Symbol.iterator](){yield*this.messages;for(let e of this.children)yield*e}};var In;(function(r){r[r.DATA=0]="DATA",r[r.ANNOTATION=1]="ANNOTATION",r[r.DEFAULT_ANNOTATION=2]="DEFAULT_ANNOTATION"})(In||(In={}));function FP(){return new vc([0,1,2])}var Fh=class extends j{constructor(){super(...arguments);this.role=0;this.messages=new Wi;this.layerChanged=new re;this.redrawNeeded=new re;this.layerChunkProgressInfo=new po}handleAction(e){}getValueAt(e){}transformPickedValue(e){return e.pickedValue}updateMouseState(e,t,r,i){}},Gd=class extends Fh{constructor(){super(...arguments);this.visibility=new ao}attach(e){}};function ns(n,e,t){let{state:r}=t;if(r===void 0||r.transform!==n||r.displayDimensionRenderInfo!==e){if(t.messages.clearMessages(),r=t.state={transform:n,displayDimensionRenderInfo:e,modelTransform:void 0},n.error!==void 0){t.messages.addMessage({severity:xr.error,message:n.error});return}try{let i=ae.create();YE(i,e,n),r.modelTransform=i}catch(i){t.messages.addMessage({severity:xr.error,message:i.message})}}return r.modelTransform}var Wd=class extends j{constructor(e){super();this.renderViewport=new kc;this.changed=new ze;let{parametersConstructor:t=Cd,navigationState:r,update:i,isEqual:a=AE}=e;this.oldValue_=new t,this.value_=new t;let o=()=>{let{oldValue_:c,value_:d}=this;c.displayDimensionRenderInfo=r.displayDimensionRenderInfo.value,Object.assign(c,this.renderViewport);let{globalPosition:p}=c,m=r.position.value,g=m.length;p.length!==g&&(c.globalPosition=p=new Float32Array(g)),p.set(m),i(c,r),!a(c,d)&&(this.value_=c,this.oldValue_=d,this.changed.dispatch(d,c))},l=this.update=this.registerCancellable((0,YS.default)(o,0));this.registerDisposer(r.changed.add(l)),o()}setViewport(e){fh(e,this.renderViewport)||(Object.assign(this.renderViewport,e),this.update())}get value(){return this.update.flush(),this.value_}},ll=class extends Sn{constructor(e,t,r=10){super();this.base=t;this.updateInterval=r;this.prevDisplayDimensionRenderInfo=void 0;this.update=this.registerCancellable((0,YS.default)((e,t)=>{let r;if(t.displayDimensionRenderInfo!==this.prevDisplayDimensionRenderInfo)r=t,this.prevDisplayDimensionRenderInfo=t.displayDimensionRenderInfo;else{let{displayDimensionRenderInfo:i,...a}=t;r=a}this.rpc.invoke(UP,{id:this.rpcId,value:r})},this.updateInterval));this.initializeCounterpart(e,{value:t.value}),this.registerDisposer(t.changed.add(this.update))}flush(){this.update.flush()}};ll=kt([bn(BP)],ll);var an=40,GP=.5,WP=-4;function zd(n){return(Math.log2(n)-WP)/GP}function zP(n){return 2**(n*GP+WP)}function zi(n){return new Le(n,it)}var Da=class{constructor(){this.visibility=new ao;this.changed=new re;this.frameNumber=-1;this.spatialScales=new Map;this.numHistogramRows=1;this.value=new Uint32Array(an*this.numHistogramRows*2)}begin(e){e!==this.frameNumber&&(this.value.fill(0),this.frameNumber=e,this.spatialScales.clear(),this.changed.dispatch())}add(e,t,r,i){let{spatialScales:a,numHistogramRows:o,value:l}=this,c=a.get(e);if(c===void 0&&(c=a.size,a.set(e,c)),c>=o){this.numHistogramRows=o*=2;let p=new Uint32Array(o*an*2);p.set(l),this.value=l=p}let d=c*an*2+Math.min(Math.max(0,Math.round(zd(t))),an-1);l[d]+=r,l[d+an]+=i}};var Nc=class extends Fh{constructor(e,t,r){super();this.chunkManager=e;this.multiscaleSource=t;this.rpcId=null;this.rpcTransfer={};this.visibleSources=new Map;this.visibleSourcesList_=[];var a;let{renderScaleTarget:i=zi(1)}=r;this.renderScaleTarget=i,this.renderScaleHistogram=r.renderScaleHistogram,this.transform=r.transform,this.localPosition=r.localPosition,this.rpcTransfer=r.rpcTransfer||{},this.dataHistogramSpecifications=this.registerDisposer((a=r.dataHistogramSpecifications)!=null?a:new Vd(Rr([]),Rr([]),Rr([]))),this.registerDisposer(this.dataHistogramSpecifications.visibility.changed.add(this.redrawNeeded.dispatch))}getDataHistogramCount(){return this.dataHistogramSpecifications.visibleHistograms}getSources(e){return this.multiscaleSource.getSources(e)}addSource(e,t){let{visibleSources:r}=this,i=r.get(e);i!==void 0?(++i.refCount,i.chunkTransform=t):(r.set(e,{source:e,refCount:1,chunkTransform:t}),this.visibleSourcesList_.length=0)}removeSource(e){let{visibleSources:t}=this,r=t.get(e);r.refCount!==1?--r.refCount:(t.delete(e),this.visibleSourcesList_.length=0)}get visibleSourcesList(){let{visibleSources:e,visibleSourcesList_:t}=this;if(t.length===0&&e.size!==0){for(let r of e.values())t.push(r);t.sort((r,i)=>r.chunkTransform.chunkToLayerTransformDet-i.chunkTransform.chunkToLayerTransformDet)}return t}initializeCounterpart(){let e=this.registerDisposer(new ka(this.layerChunkProgressInfo)),t=this.chunkManager.rpc;e.RPC_TYPE_ID=this.RPC_TYPE_ID,e.initializeCounterpart(t,{localPosition:this.registerDisposer(mt.makeFromExisting(t,this.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(mt.makeFromExisting(t,this.renderScaleTarget)).rpcId,...this.rpcTransfer}),this.rpcId=e.rpcId}get gl(){return this.chunkManager.chunkQueueManager.gl}setGLBlendMode(e,t){t>0?(e.enable(WebGL2RenderingContext.BLEND),e.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA)):e.disable(WebGL2RenderingContext.BLEND)}filterVisibleSources(e,t){return sD(e,this,t)}};Nc.prototype.RPC_TYPE_ID=cD;var hi=class extends Gd{draw(e,t){}isReady(e,t){return!0}};var $P=class extends SS{},Dz=ba($P);function Pz(n){return{source:n.source.addCounterpartRef(),effectiveVoxelSize:n.effectiveVoxelSize,layerRank:n.layerRank,nonDisplayLowerClipBound:n.nonDisplayLowerClipBound,nonDisplayUpperClipBound:n.nonDisplayUpperClipBound,lowerClipBound:n.lowerClipBound,upperClipBound:n.upperClipBound,lowerClipDisplayBound:n.lowerClipDisplayBound,upperClipDisplayBound:n.upperClipDisplayBound,chunkDisplayDimensionIndices:n.chunkDisplayDimensionIndices,lowerChunkDisplayBound:n.lowerChunkDisplayBound,upperChunkDisplayBound:n.upperChunkDisplayBound,fixedLayerToChunkTransform:n.fixedLayerToChunkTransform,combinedGlobalLocalToChunkTransform:n.combinedGlobalLocalToChunkTransform,chunkLayout:n.chunkLayout.toObject()}}function cl(n){return n.map(e=>e.map(Pz))}function KS(n,e){for(let t of e)for(let{source:r}of t)n.removeSource(r),r.dispose()}var Bc=class extends Dz{constructor(e,t,r,i){super(new Wd({parametersConstructor:vS,navigationState:r,update:(l,c)=>{let{invViewMatrix:d,centerDataPosition:p}=l;c.toMat4(d);let{canonicalVoxelFactors:m,voxelPhysicalScales:g}=l.displayDimensionRenderInfo;for(let D=0;D<3;++D)p[D]=d[12+D];let{logicalWidth:v,logicalHeight:b,projectionMat:x,viewportNormalInGlobalCoordinates:C,viewportNormalInCanonicalCoordinates:T}=l,{relativeDepthRange:I}=c;ae.ortho(x,-v/2,v/2,b/2,-b/2,-I,I),ph(l,x),vh(l);let{viewMatrix:P}=l;for(let D=0;D<3;++D){let E=C[D]=P[D*4+2];T[D]=E/m[D]}K.normalize(C,C),K.normalize(T,T);let M=0;for(let D=0;D<3;++D){let E=g[D],V=d[D];M+=(E*V)**2}M=Math.sqrt(M),l.pixelSize=M}}));this.chunkManager=e;this.layerManager=t;this.navigationState=r;this.wireFrame=i;this.gl=this.chunkManager.gl;this.viewChanged=new re;this.renderingStale=!0;this.visibleChunksStale=!0;this.visibleLayerList=new Array;this.offscreenFramebuffer=this.registerDisposer(new Fi(this.gl,{colorBuffers:al(this.gl,1),depthBuffer:new NS(this.gl)}));this.histogramInputTextures=[];this.offscreenFramebuffersWithHistograms=[this.offscreenFramebuffer];this.histogramGenerator=Od.get(this.gl);this.updateVisibleLayers=this.registerCancellable((0,HP.default)(()=>{this.updateVisibleLayersNow()},0));this.registerDisposer(r),this.registerDisposer(this.projectionParameters),this.registerDisposer(this.projectionParameters.changed.add((l,c)=>{l.displayDimensionRenderInfo!==c.displayDimensionRenderInfo&&this.updateVisibleLayers()}));let a=this.chunkManager.rpc,o=this.sharedProjectionParameters=this.registerDisposer(new ll(a,this.projectionParameters));this.initializeCounterpart(a,{chunkManager:e.rpcId,projectionParameters:o.rpcId}),this.registerDisposer(t.layersChanged.add(()=>{this.updateVisibleLayers()})),this.wireFrame.changed.add(this.viewChanged.dispatch),this.viewChanged.add(()=>{this.renderingStale=!0}),this.registerDisposer(e.chunkQueueManager.visibleChunksChanged.add(this.viewChanged.dispatch)),this.updateVisibleLayers()}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}computeHistograms(e,t){this.histogramGenerator.compute(e,this.offscreenFramebuffer.depthBuffer.texture,this.histogramInputTextures,t,this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber)}flushBackendProjectionParameters(){this.sharedProjectionParameters.flush()}forEachVisibleChunk(e,t,r){mD(this.projectionParameters.value,e.renderLayer.localPosition.value,e,t,()=>{r(e.curPositionInChunks.join())})}isReady(){if(!this.navigationState.valid)return!1;this.updateVisibleLayers.flush(),this.updateVisibleSources();let e=0,t=0;for(let{visibleSources:r}of this.visibleLayers.values())for(let i of r){let a=Rc(this.projectionParameters.value,i.chunkLayout),{source:o}=i,{chunks:l}=o;this.forEachVisibleChunk(i,a,c=>{let d=l.get(c);++t,d&&d.state===Ze.GPU_MEMORY&&++e})}return e===t}invalidateVisibleSources(){super.invalidateVisibleSources(),this.viewChanged.dispatch()}bindVisibleRenderLayer(e,t){t.push(e.localPosition.changed.add(()=>this.invalidateVisibleChunks())),t.push(e.redrawNeeded.add(this.viewChanged.dispatch)),t.push(e.transform.changed.add(this.updateVisibleLayers)),t.push(e.renderScaleTarget.changed.add(()=>this.invalidateVisibleSources()));let{renderScaleHistogram:r}=e;r!==void 0&&t.push(r.visibility.add(this.visibility)),t.push(e.dataHistogramSpecifications.producerVisibility.add(this.visibility))}updateVisibleLayersNow(){if(this.wasDisposed||!this.navigationState.valid)return!1;let e=Date.now(),{visibleLayers:t,visibleLayerList:r}=this,{displayDimensionRenderInfo:i}=this.projectionParameters.value,a=this.rpc,o={id:this.rpcId},l=!1;r.length=0;for(let c of this.layerManager.readyRenderLayers())if(c instanceof Nc){r.push(c);let d=t.get(c);if(d===void 0){let p=[],m=new Wi;d={messages:m,allSources:this.getTransformedSources(c,m),transformGeneration:c.transform.changed.count,visibleSources:[],disposers:p,lastSeenGeneration:e,displayDimensionRenderInfo:i},p.push(c.messages.addChild(d.messages)),t.set(c.addRef(),d),this.bindVisibleRenderLayer(c,p)}else{d.lastSeenGeneration=e;let p=c.transform.changed.count;if(d.transformGeneration===p&&d.displayDimensionRenderInfo===i)continue;let m=d.allSources;d.allSources=this.getTransformedSources(c,d.messages),KS(c,m),d.visibleSources.length=0,d.displayDimensionRenderInfo=i,d.transformGeneration=p}o.layerId=c.rpcId,o.sources=cl(d.allSources),this.flushBackendProjectionParameters(),a.invoke(uD,o),l=!0}for(let[c,d]of t)d.lastSeenGeneration!==e&&(o.layerId=c.rpcId,a.invoke(dD,o),t.delete(c),KS(c,d.allSources),Ya(d.disposers),c.dispose(),l=!0);return l&&(this.visibleSourcesStale=!0),this.viewChanged.dispatch(),l}invalidateVisibleChunks(){super.invalidateVisibleChunks(),this.viewChanged.dispatch()}get valid(){return this.navigationState.valid}getOffscreenFramebufferWithHistograms(e){let{offscreenFramebuffersWithHistograms:t}=this,r=t[e];if(r===void 0){let{gl:i,histogramInputTextures:a,offscreenFramebuffer:o}=this;a.length<e&&a.push(...al(i,e-a.length,WebGL2RenderingContext.R8,WebGL2RenderingContext.RED));let l=[o.colorBuffers[0].addRef()];for(let c=0;c<e;++c)l.push(a[c].addRef());r=this.registerDisposer(new Fi(i,{colorBuffers:l,depthBuffer:o.depthBuffer.addRef()})),t[e]=r}return r}updateRendering(){let e=this.projectionParameters.value,{width:t,height:r}=e;if(!this.renderingStale||!this.valid||t===0||r===0)return;this.renderingStale=!1,this.updateVisibleLayers.flush(),this.updateVisibleSources();let{gl:i,offscreenFramebuffer:a}=this;a.bind(t,r),i.disable(i.SCISSOR_TEST),i.clearColor(0,0,0,0),i.colorMask(!0,!0,!0,!0),i.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);let o=0,l=this.wireFrame.value,c={sliceView:this,projectionParameters:e,wireFrame:l};for(let d of this.visibleLayerList){let p=l?0:d.getDataHistogramCount();this.getOffscreenFramebufferWithHistograms(p).bind(t,r);for(let g=0;g<p;++g)i.clearBufferfv(WebGL2RenderingContext.COLOR,1+g,ud);i.enable(WebGL2RenderingContext.DEPTH_TEST),i.depthFunc(WebGL2RenderingContext.LESS),i.clearDepth(1),i.clear(WebGL2RenderingContext.DEPTH_BUFFER_BIT),d.setGLBlendMode(i,o),d.draw(c),++o}i.disable(WebGL2RenderingContext.BLEND),i.disable(WebGL2RenderingContext.DEPTH_TEST),a.unbind()}disposed(){for(let[e,t]of this.visibleLayers)KS(e,t.allSources),Ya(t.disposers),e.dispose();this.visibleLayers.clear(),this.visibleLayerList.length=0}getTransformedSources(e,t){let r=pl(this.projectionParameters.value.displayDimensionRenderInfo,e.transform.value,i=>e.getSources(i),t,e);for(let i of r)for(let a of i)e.addSource(a.source,a.chunkTransform);return r}};Bc=kt([bn(lD)],Bc);var ul=class extends Gn{constructor(e,t){super(e,t);this.spec=t.spec}static encodeSpec(e){return{chunkDataSize:Array.from(e.chunkDataSize),lowerVoxelBound:Array.from(e.lowerVoxelBound),upperVoxelBound:Array.from(e.upperVoxelBound)}}static encodeOptions(e){let t=super.encodeOptions(e);return t.spec=this.encodeSpec(e.spec),t}initializeCounterpart(e,t){t.spec=this.spec,super.initializeCounterpart(e,t)}},Hd=class extends br{constructor(e,t){super(e);this.chunkGridPosition=t.chunkGridPosition,this.state=Ze.SYSTEM_MEMORY}},dl=class extends j{constructor(e,t){super();this.gl=e;this.copyVertexPositionsBuffer=Xo(this.gl);this.textureCoordinateAdjustment=new Float32Array(4);let r=new Sr(e);r.addVarying("vec2","vTexCoord"),r.addUniform("sampler2D","uSampler"),r.addInitializer(i=>{e.uniform1i(i.uniform("uSampler"),0)}),r.addUniform("vec4","uColorFactor"),r.addUniform("vec4","uBackgroundColor"),r.addUniform("mat4","uProjectionMatrix"),r.addUniform("vec4","uTextureCoordinateAdjustment"),r.require(t),r.setFragmentMain(`
vec4 sampledColor = texture(uSampler, vTexCoord);
if (sampledColor.a == 0.0) {
  sampledColor = uBackgroundColor;
}
emit(sampledColor * uColorFactor, 0u);
`),r.addAttribute("vec4","aVertexPosition"),r.setVertexMain(`
vTexCoord = uTextureCoordinateAdjustment.xy + 0.5 * (aVertexPosition.xy + 1.0) * uTextureCoordinateAdjustment.zw;
gl_Position = uProjectionMatrix * aVertexPosition;
`),this.shader=this.registerDisposer(r.build())}draw(e,t,r,i,a,o,l,c){let{gl:d,shader:p,textureCoordinateAdjustment:m}=this;m[0]=a,m[1]=o,m[2]=l-a,m[3]=c-o,p.bind(),d.activeTexture(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,e),d.disable(WebGL2RenderingContext.BLEND),d.uniformMatrix4fv(p.uniform("uProjectionMatrix"),!1,t),d.uniform4fv(p.uniform("uColorFactor"),r),d.uniform4fv(p.uniform("uBackgroundColor"),i),d.uniform4fv(p.uniform("uTextureCoordinateAdjustment"),m);let g=p.attribute("aVertexPosition");this.copyVertexPositionsBuffer.bindToVertexAttrib(g,2),d.drawArrays(d.TRIANGLE_FAN,0,4),d.disableVertexAttribArray(g),d.bindTexture(d.TEXTURE_2D,null)}static get(e,t){return e.memoize.get(`sliceview/SliceViewRenderHelper:${pt(t)}`,()=>new dl(e,t))}},XS=class{constructor(e){this.chunkManager=e}};function pl(n,e,t,r,i){r.clearMessages();let a=T=>(r.addMessage({severity:xr.error,message:T}),[]);if(e.error!==void 0)return a(e.error);let o=e.rank,l=e.unpaddedRank,{displayDimensionIndices:c,displayRank:d,canonicalVoxelFactors:p}=n,m=Ph(e,c),{displayToLayerDimensionIndices:g}=m,v=new Float32Array(d*l),{modelToRenderLayerTransform:b}=e;for(let T=0;T<d;++T){let I=g[T];if(I===-1)continue;let P=p[T];for(let M=0;M<l;++M)v[d*M+T]=b[(o+1)*M+I]*P}let x=t({displayRank:d,multiscaleToViewTransform:v,modelChannelDimensionIndices:e.channelToRenderLayerDimensions}),{voxelPhysicalScales:C}=n;try{let T=I=>{let{chunkSource:P}=I,{spec:M}=P,{lowerClipBound:D=M.lowerVoxelBound,upperClipBound:E=M.upperVoxelBound}=I,V=Qs(e,I.chunkToMultiscaleTransform),{chunkDataSize:O}=M,{channelToChunkDimensionIndices:B}=V,z=new Float32Array(l),_=new Float32Array(l);z.set(D),_.set(E);let U=B.length,{channelSpaceShape:N}=e;for(let tt=0;tt<U;++tt){let _e=B[tt];if(_e===-1)continue;let dt=N[tt];if(O[_e]!==dt)throw new Error("Channel dimension "+e.layerDimensionNames[e.channelToRenderLayerDimensions[tt]]+` has extent ${dt} but corresponding chunk dimension has extent ${O[_e]}`);z[_e]=Number.NEGATIVE_INFINITY,_[_e]=Number.POSITIVE_INFINITY}let J=Ih(V,m),ie=K.create(),pe=K.create(),me=K.create(),Pe=K.create(),le=K.create(),{numChunkDisplayDims:we,chunkDisplayDimensionIndices:Re}=J,{combinedGlobalLocalToChunkTransform:Ue,layerRank:et,combinedGlobalLocalRank:ye}=V,ke=new Float32Array(Ue);for(let tt=0;tt<we;++tt){let _e=Re[tt];for(let dt=0;dt<=ye;++dt)ke[_e+dt*et]=0;_e<l?(le[tt]=M.chunkDataSize[_e],ie[tt]=M.lowerChunkBound[_e],pe[tt]=M.upperChunkBound[_e],me[tt]=D[_e],Pe[tt]=E[_e],z[_e]=Number.NEGATIVE_INFINITY,_[_e]=Number.POSITIVE_INFINITY):(le[tt]=1,ie[tt]=0,pe[tt]=1,me[tt]=0,Pe[tt]=1)}le.fill(1,we),ie.fill(0,we),pe.fill(1,we),me.fill(0,we),Pe.fill(1,we);let $e=new Zs(le,J.displaySubspaceModelMatrix,we),Je=$e.localSpatialVectorToGlobal(K.create(),Jf);for(let tt=0;tt<d;++tt)Je[tt]=Math.abs(Je[tt]*C[tt]);return Je.fill(1,d),{layerRank:et,lowerClipBound:D,upperClipBound:E,nonDisplayLowerClipBound:z,nonDisplayUpperClipBound:_,renderLayer:i,source:P,lowerChunkDisplayBound:ie,upperChunkDisplayBound:pe,lowerClipDisplayBound:me,upperClipDisplayBound:Pe,effectiveVoxelSize:Je,chunkLayout:$e,chunkDisplayDimensionIndices:Re,fixedLayerToChunkTransform:ke,curPositionInChunks:new Float32Array(l),combinedGlobalLocalToChunkTransform:V.combinedGlobalLocalToChunkTransform,fixedPositionWithinChunk:new Uint32Array(l),chunkTransform:V,chunkDisplayTransform:J}};return x.map(I=>I.map(P=>T(P)))}catch(T){for(let D of x)for(let{chunkSource:E}of D)E.dispose();let{globalDimensionNames:I}=n,M=`Cannot render (${Array.from(n.displayDimensionIndices.filter(D=>D!==-1),D=>I[D]).join(",\xA0")}) cross section: ${T.message}`;return a(M)}}var fl=null,Iz=200,Ce=class{constructor(e=!1){if(fl===null){fl=document.createElement("ul"),fl.id="statusContainer";let r=document.getElementById("neuroglancer-container");r?r.appendChild(fl):document.body.appendChild(fl)}let t=document.createElement("li");this.element=t,e===!0&&(e=Iz),e!==!1?(this.setVisible(!1),this.timer=window.setTimeout(this.setVisible.bind(this,!0),e)):this.timer=null,fl.appendChild(t)}dispose(){fl.removeChild(this.element),this.element=void 0,this.timer!==null&&clearTimeout(this.timer)}setText(e,t){this.element.textContent=e,t&&this.setVisible(!0)}setHTML(e,t){this.element.innerHTML=e,t&&this.setVisible(!0)}setVisible(e){this.timer!==null&&(clearTimeout(this.timer),this.timer=null),this.element.style.display=e?"block":"none"}static forPromise(e,t){let r=new Ce(t.delay);r.setText(t.initialMessage);let i=r.dispose.bind(r);return e.then(i,a=>{let o;a instanceof Error?o=a.message:o=""+a;let{errorPrefix:l=""}=t;r.setErrorMessage(l+o),r.setVisible(!0)}),e}setErrorMessage(e){this.element.textContent=e+" ";let t=document.createElement("button");t.textContent="Dismiss",t.addEventListener("click",()=>{this.dispose()}),this.element.appendChild(t)}static showMessage(e){let t=new Ce;return t.element.textContent=e,t.setVisible(!0),t}static showTemporaryMessage(e,t=2e3){let r=this.showMessage(e);return window.setTimeout(()=>r.dispose(),t),r}};function QS(n){let e=0,{typeToIds:t}=n;for(let r of _i)e+=es(r).pickIdsPerInstance*t[r].length;return e}var ZS=class{constructor(e){this.bufferValid=!1;this.numPickIds=0;this.serializedAnnotations={data:e.data,typeToIds:e.typeToIds,typeToOffset:e.typeToOffset,typeToIdMaps:e.typeToIdMaps}}freeGPUMemory(e){let{buffer:t}=this;t!==void 0&&(t.dispose(),this.bufferValid=!1,this.buffer=void 0)}},jP=class extends br{constructor(e,t){super(e);t.data!==void 0&&(this.data=new ZS(t))}freeGPUMemory(e){super.freeGPUMemory(e);let{data:t}=this;t!==void 0&&t.freeGPUMemory(e)}dispose(){this.data=void 0}},eb=class extends Hd{constructor(e,t){super(e,t);t.data!==void 0&&(this.data=new ZS(t))}freeGPUMemory(e){super.freeGPUMemory(e);let{data:t}=this;t!==void 0&&t.freeGPUMemory(e)}dispose(){this.data=void 0}},hl=class extends ul{constructor(e,t){super(e,t);this.immediateChunkUpdates=!0;(this.parent=t.parent).spatiallyIndexedSources.add(this);let{rank:i,chunkDataSize:a}=this.spec,o=this.multiscaleToChunkTransform=new Float32Array((i+1)**2);Dc(o,i+1,this.spec.chunkToMultiscaleTransform,i+1,i+1);for(let l=0;l<i;++l)for(let c=0;c<i+1;++c)o[(i+1)*c+l]/=a[l]}disposed(){this.parent.spatiallyIndexedSources.delete(this),super.disposed()}initializeCounterpart(e,t){t.parent=this.parent.rpcId,super.initializeCounterpart(e,t)}addChunk(e,t){super.addChunk(e,t)}getChunk(e){return new eb(this,e)}};hl=kt([bn(yD)],hl);var Gh=class extends Gn{constructor(e,t,r){super(e,{});this.parent=t;this.relationshipIndex=r;this.immediateChunkUpdates=!0}addChunk(e,t){super.addChunk(e,t)}getChunk(e){return new jP(this,e)}};Gh=kt([bn(vD)],Gh);var JP=class extends br{constructor(e,t){super(e);this.annotation=qv(t.annotation)}},Wh=class extends Gn{constructor(e,t){super(e);this.parent=t}getChunk(e){return new JP(this,e)}addChunk(e,t){super.addChunk(e,t);let{references:r}=this.parent,i=r.get(e);i!==void 0&&(i.value=t.annotation,i.changed.dispatch())}deleteChunk(e){let{references:t}=this.parent,r=t.get(e);r!==void 0&&(r.value=void 0,r.changed.dispatch())}};Wh=kt([bn(gD)],Wh);function qP(n,e,t,r){let i=new Uint8Array(n.data.length+r);for(let a of _i){if(a===t)continue;let o=n.typeToOffset[a],l=o;a>t&&(l+=r,n.typeToOffset[a]=l),i.set(n.data.subarray(o,o+n.typeToIds[a].length*e[a].serializedBytes),l)}return i}function tb(n,e,t,r,i,a,o,l){let c=n.typeToOffset[t],d=c,p=c,{propertyGroupBytes:m}=e[t],g=m.length,v=n.typeToIds[t].length;for(let b=0;b<g;++b){let x=m[b];r.set(n.data.subarray(d+i*x,d+a*x),p+o*x),d+=x*v,p+=x*l}}function zh(n,e,t){let r=e.type,{rank:i}=t[r],{serializedAnnotations:a}=n,o=a.typeToIds[r],l=a.typeToIdMaps[r],c=Un[r],d=t[r].serializedBytes,p=l.get(e.id);if(p===void 0){p=l.size,l.set(e.id,p);let x=qP(a,t,r,d);tb(a,t,r,x,0,p,0,p+1),o.push(e.id),a.data=x}let m=a.typeToOffset[r],g=new DataView(a.data.buffer,a.data.byteOffset,a.data.byteLength),v=ga===yn.LITTLE,b=t[r];c.serialize(g,m+b.propertyGroupBytes[0]*p,v,i,e),b.serialize(g,m,p,o.length,v,e.properties),n.bufferValid=!1}function Hh(n,e,t,r){let{serializedAnnotations:i}=n,a=i.typeToIdMaps[e],o=a.get(t);if(o===void 0)return!1;let l=i.typeToIds[e],c=r[e].serializedBytes,d=qP(i,r,e,-c);tb(i,r,e,d,0,o,0,l.length-1),tb(i,r,e,d,o+1,l.length,o,l.length-1),l.splice(o,1),a.delete(t);for(let p=o,m=l.length;p<m;++p)a.set(l[p],p);return i.data=d,n.bufferValid=!1,!0}function Az(){let n=[],e=[],t=[];for(let r of _i)n[r]=[],e[r]=0,t[r]=new Map;return new eb(void 0,{data:new Uint8Array(0),numPickIds:0,typeToOffset:e,typeToIds:n,typeToIdMaps:t})}var Hi=class extends Sn{constructor(e,t){super();this.chunkManager=e;this.metadataChunkSource=this.registerDisposer(new Wh(this.chunkManager,this));this.spatiallyIndexedSources=new Set;this.temporary=Az();this.references=new Map;this.localUpdates=new Map;this.numCommitsInProgress=0;this.changed=new re;this.readonly=!1;this.rank=t.rank,this.properties=t.properties,this.annotationPropertySerializers=sh(this.rank,this.properties);let r=this.segmentFilteredSources=[],{relationships:i}=t;this.relationships=i;for(let a=0,o=i.length;a<o;++a)r.push(this.registerDisposer(new Gh(e,this,a)))}hasNonSerializedProperties(){return this.relationships.length>0}getSources(e){throw new Error("not implemented")}initializeCounterpart(e,t){this.metadataChunkSource.initializeCounterpart(e,{});for(let r of this.segmentFilteredSources)r.initializeCounterpart(e,{});t.segmentFilteredSource=this.segmentFilteredSources.map(r=>r.addCounterpartRef()),t.metadataChunkSource=this.metadataChunkSource.addCounterpartRef(),t.chunkManager=this.chunkManager.rpcId,super.initializeCounterpart(e,t)}add(e,t=!0){e.id=uh();let r=new vd(e.id);return r.value=e,this.references.set(r.id,r),r.registerDisposer(()=>{this.references.delete(r.id)}),this.applyLocalUpdate(r,!1,t,e),r}applyLocalUpdate(e,t,r,i){let{localUpdates:a}=this,{id:o}=e,l=this.localUpdates.get(o),c=e.value;if(c==null)throw new Error("Cannot create local update from null annotation");if(l===void 0?(l={type:c.type,reference:e.addRef(),existingAnnotation:t?c:void 0,pendingCommit:void 0,commitInProgress:void 0},a.set(o,l),this.forEachPossibleChunk(c,d=>{let{data:p}=d;if(p===void 0)return;let m=c.type;Hh(p,m,o,this.annotationPropertySerializers)}),i!==null&&zh(this.temporary.data,i,this.annotationPropertySerializers)):(i===null?Hh(this.temporary.data,c.type,c.id,this.annotationPropertySerializers):zh(this.temporary.data,i,this.annotationPropertySerializers),e.value=i),r)if(l.commitInProgress!==void 0)l.pendingCommit=i;else{if(i===null&&l.existingAnnotation===void 0){a.delete(o),l.reference.dispose();return}this.sendCommitRequest(l,i)}this.notifyChanged(e.id,i||void 0)}sendCommitRequest(e,t){this.updateCommitsInProgress(1),e.commitInProgress=t,this.rpc.invoke(xD,{id:this.rpcId,annotationId:e.existingAnnotation&&e.reference.id,newAnnotation:t})}delete(e){this.applyLocalUpdate(e,!0,!0,null)}update(e,t){this.applyLocalUpdate(e,!0,!1,t)}notifyChanged(e,t){let r=this.references.get(e),i=this.metadataChunkSource.chunks.get(e);i!==void 0&&(i.annotation=t||null),r!==void 0&&(r.value=t||null,r.changed.dispatch()),this.chunkManager.chunkQueueManager.visibleChunksChanged.dispatch()}commit(e){this.applyLocalUpdate(e,!0,!0,e.value)}getReference(e){let t=this.references.get(e);if(t!==void 0)return t.addRef();t=new vd(e),this.references.set(e,t),this.rpc.invoke(SD,{id:this.rpcId,annotation:e}),t.registerDisposer(()=>{this.references.delete(e),this.rpc.invoke(bD,{id:this.rpcId,annotation:e})});let r=this.metadataChunkSource.chunks.get(e);return r!==void 0&&(t.value=r.annotation),t}forEachPossibleChunk(e,t){let{relatedSegments:r}=e;if(r!==void 0){let c=r.length,{segmentFilteredSources:d}=this;for(let p=0;p<c;++p){let m=r[p];if(m===void 0)return;let g=d[p];for(let v of m){let b=g.chunks.get(Nr(v));b!==void 0&&t(b)}}}let{rank:i}=this,a=new Float32Array(i),o=new Float32Array(i),l=new Float32Array(i);for(let c of this.spatiallyIndexedSources){switch(e.type){case Oe.POINT:Zr(a,c.multiscaleToChunkTransform,i+1,e.point,i),o.set(a);break;case Oe.LINE:case Oe.AXIS_ALIGNED_BOUNDING_BOX:Zr(a,c.multiscaleToChunkTransform,i+1,e.pointA,i),Zr(o,c.multiscaleToChunkTransform,i+1,e.pointB,i);break;case Oe.ELLIPSOID:Zr(a,c.multiscaleToChunkTransform,i+1,e.center,i),bh(o,c.multiscaleToChunkTransform,i+1,e.radii,i);for(let m=0;m<i;++m){let g=a[m],v=o[m];a[m]=g-v,o[m]=g+v}break}let d=1;for(let m=0;m<i;++m){let g=a[m],v=o[m],b=Math.min(g,v),x=Math.max(g,v);a[m]=Math.ceil(b-1),o[m]=Math.floor(x+1),d*=o[m]-a[m]}let{chunks:p}=c;for(let m=0;m<d;++m){let g=m;for(let b=0;b<i;++b){let x=a[b],T=o[b]-x,I=l[b]=g%T;g=(g-I)/T}let v=p.get(l.join());v!==void 0&&t(v)}}}static encodeOptions(e){return{}}handleSuccessfulUpdate(e,t){let r=this.localUpdates.get(e);if(r===void 0||r.commitInProgress===void 0)throw new Error("Received invalid successful update notification");if(this.updateCommitsInProgress(-1),t!==null&&r.reference.id!==t.id){if(r.commitInProgress===null)throw new Error("Received invalid successful update notification");r.reference.id=t.id,this.references.delete(e),this.references.set(t.id,r.reference),this.localUpdates.delete(e),this.localUpdates.set(t.id,r),r.reference.value!==null&&(r.reference.value.id=t.id,Hh(this.temporary.data,r.type,e,this.annotationPropertySerializers),zh(this.temporary.data,r.reference.value,this.annotationPropertySerializers)),r.reference.changed.dispatch()}r.existingAnnotation=t||void 0,r.commitInProgress=void 0;let{pendingCommit:i}=r;r.pendingCommit=void 0,t===null&&(i=void 0),i!==void 0?(i!==null&&(i.id=t.id),this.sendCommitRequest(r,i)):this.revertLocalUpdate(r)}disposed(){let{commitStatus:e}=this;e!==void 0&&e.dispose()}updateCommitsInProgress(e){this.numCommitsInProgress+=e,this.numCommitsInProgress===0?this.commitStatus!==void 0&&(this.commitStatus.dispose(),this.commitStatus=void 0):this.commitStatus===void 0&&(this.commitStatus=new Ce(!0)).setText("Commiting annotations")}handleFailedUpdate(e,t){let r=this.localUpdates.get(e);if(r===void 0||r.commitInProgress===void 0)throw new Error("Received invalid update notification");new Ce().setErrorMessage(`Error commiting annotation update: ${t}`),this.revertLocalUpdate(r),this.updateCommitsInProgress(-1)}revertLocalUpdate(e){Hh(this.temporary.data,e.type,e.reference.id,this.annotationPropertySerializers);let{existingAnnotation:t}=e;t!==void 0&&this.forEachPossibleChunk(t,a=>{let{data:o}=a;o!==void 0&&zh(o,t,this.annotationPropertySerializers)});let{reference:r}=e,{id:i}=r;r.value=t||null,r.changed.dispatch(),r.dispose(),this.localUpdates.delete(i)}*[Symbol.iterator](){}};wt(CD,function(n){let e=this.get(n.id),t=n.annotationId,r=n.error;if(r!==void 0)e.handleFailedUpdate(t,r);else{let i=qv(n.newAnnotation);e.handleSuccessfulUpdate(t,i)}});var YP="CredentialsProvider",KP="CredentialsProvider.get";var $d=class extends Sn{constructor(e,t){super();this.provider=e;this.registerDisposer(e),this.initializeCounterpart(t)}get(e,t){return this.provider.get(e,t)}};$d=kt([bn(YP)],$d);Mh(KP,function(n,e){return this.get(n.providerId).get(n.invalidCredentials,e).then(r=>({value:r}))});function jd(n,e){if(e===void 0)return;let t=n.memoize.get({type:"getSharedCredentialsProvider",credentialsProvider:pt(e)},()=>new $d(e.addRef(),n.rpc)),r=t.addCounterpartRef();return t.dispose(),r}function ct(){return function(n){class e extends n{constructor(...r){super(...r);var a;let i=r[1];this.credentialsProvider=(a=i.credentialsProvider)==null?void 0:a.addRef()}initializeCounterpart(r,i){let{credentialsProvider:a}=this;i.credentialsProvider=jd(this.chunkManager,a),super.initializeCounterpart(r,i)}static encodeOptions(r){let i=super.encodeOptions(r),{credentialsProvider:a}=r;return i.credentialsProvider=a===void 0?void 0:pt(a),i}}return e}}function fo(n,e){return n<e?-1:n>e?1:0}var XP={offset:0,completions:[]};function Br(n,e){return e.offset+=n,e}function $h(n,e){let t=[];for(let r of e)r.startsWith(n)&&t.push({value:r});return t.sort((r,i)=>fo(r.value,i.value)),t}function on(n,e,t,r){let i=[];for(let a of e){let o=t(a);o.startsWith(n)&&i.push({value:o,description:r(a)})}return i.sort((a,o)=>fo(a.value,o.value)),i}async function Mz(n,e,t){if(n.startsWith("{"))return XP;let i=n.match(/^(?:(.*)[&;])?([^&;]*)$/)[2],a=n.length-i.length,o=i.indexOf("=");if(o===-1){let l=await e(i);return{offset:l.offset+a,completions:l.completions.map(c=>({...c,value:`${c.value}=`}))}}return Br(a+o+1,await t(i.substring(0,o),i.substring(o+1)))}async function jh(n,e){return Mz(n,async t=>{let r=[];for(let i of e){let a=i.key;a.value.startsWith(t)&&r.push(a)}return{offset:0,completions:r}},async(t,r)=>{for(let i of e)if(i.key.value===t)return{offset:0,completions:i.values.filter(a=>a.value.startsWith(r))};return XP})}var Uc=class extends Error{constructor(e){super(`Redirected to: ${e}`);this.redirectTarget=e}};function QP(n,e){e===void 0&&(n.indexOf("/")===-1?e=":":e="/");let t=n.lastIndexOf(e);return t===-1?0:t+1}function Rz(n,e){let t=QP(n,e);return n.substring(t)}var mi;(function(t){t[t.annotations=0]="annotations",t[t.equivalences=1]="equivalences"})(mi||(mi={}));function Jh(){return{url:"",transform:void 0,enableDefaultSubsources:!0,subsources:new Map}}var Ut=class extends j{normalizeUrl(e){return e.url}convertLegacyUrl(e){return e.url}async completeUrl(e){throw null}},nb="local://annotations",qh="local://equivalences",ZP=class extends Ut{get description(){return"Local in-memory"}async get(e){switch(e.url){case nb:{let{transform:t}=e,r;if(t===void 0){let i=e.globalCoordinateSpace.value,{rank:a,names:o,scales:l,units:c}=i,d=Be({rank:a,scales:l,units:c,names:o.map((m,g)=>`${g}`)}),p=Be({rank:a,scales:l,units:c,names:o});r={rank:a,sourceRank:a,inputSpace:d,outputSpace:p,transform:Yt(Float64Array,a+1)}}else r=xt(Oi);return{modelTransform:r,canChangeModelSpaceRank:!0,subsources:[{id:"default",default:!0,subsource:{local:0}}]}}case qh:return{modelTransform:xt(Oi),canChangeModelSpaceRank:!1,subsources:[{id:"default",default:!0,subsource:{local:1}}]}}throw new Error("Invalid local data source URL")}async completeUrl(e){return{offset:0,completions:on(e.providerUrl,[{value:"annotations",description:"Annotations stored in the JSON state"},{value:"equivalences",description:"Segmentation equivalence graph stored in the JSON state"}],t=>t.value,t=>t.description)}}},eI=/^(?:([a-zA-Z][a-zA-Z0-9-+_]*):\/\/)?(.*)$/,rb=class extends j{constructor(e){super();this.credentialsManager=e;this.dataSources=new Map([["local",new ZP]])}register(e,t){this.dataSources.set(e,this.registerDisposer(t))}getProvider(e){let t=e.match(eI);if(t===null||t[1]===void 0)throw new Error('Data source URL must have the form "<protocol>://<path>".');let[,r,i]=t,a=this.dataSources.get(r);if(a===void 0)throw new Error(`Unsupported data source: ${JSON.stringify(r)}.`);return[a,i,r]}async get(e){let t=new Set,{cancellationToken:r=at}=e,i=e.url;for(;;){let[a,o,l]=this.getProvider(e.url);t.add(e.url);try{return a.get({...e,url:i,providerProtocol:l,providerUrl:o,registry:this,cancellationToken:r,credentialsManager:this.credentialsManager})}catch(c){if(c instanceof Uc){let d=c.redirectTarget;if(t.has(d))throw Error(`Layer source redirection contains loop: ${JSON.stringify(Array.from(t))}`);if(t.size>=10)throw Error(`Too many layer source redirections: ${JSON.stringify(Array.from(t))}`);i=d;continue}throw c}}}convertLegacyUrl(e){try{let[t,r,i]=this.getProvider(e.url);return t.convertLegacyUrl({...e,providerUrl:r,providerProtocol:i,registry:this})}catch{return e.url}}normalizeUrl(e){try{let[t,r,i]=this.getProvider(e.url);return t.normalizeUrl({...e,providerUrl:r,providerProtocol:i,registry:this})}catch{return e.url}}async completeUrl(e){let{url:t,cancellationToken:r=at}=e,i=t.match(eI),a=i[1];if(a===void 0)return Promise.resolve({offset:0,completions:on(t,this.dataSources,([o])=>`${o}://`,([,o])=>o.description)});{let o=this.dataSources.get(a);if(o!==void 0){let l=await o.completeUrl({registry:this,url:t,providerUrl:i[2],chunkManager:e.chunkManager,cancellationToken:r,credentialsManager:this.credentialsManager});return Br(a.length+3,l)}throw null}}suggestLayerName(e){let[t,r]=this.getProvider(e);r.endsWith("/")&&(r=r.substring(0,r.length-1));let i=t.suggestLayerName;return i!==void 0?i(r):Rz(r)}findSourceGroup(e){let[t,r,i]=this.getProvider(e);return(t.findSourceGroup||QP)(r)+i.length+3}};var Cr=class extends Error{constructor(e,t,r,i){let a=`Fetching ${JSON.stringify(e)} resulted in HTTP error ${t}`;r&&(a+=`: ${r}`),a+=".",super(a),this.name="HttpError",this.message=a,this.url=e,this.status=t,this.statusText=r,i&&(this.response=i)}static fromResponse(e){return new Cr(e.url,e.status,e.statusText,e)}static fromRequestError(e,t){if(t instanceof TypeError){let r;return typeof e=="string"?r=e:r=e.url,new Cr(r,0,"Network or CORS error")}return t}},_z=32,Vz=500,Oz=1e4;function ib(n){return Math.min(2**n*Vz,Oz/2)*(1+Math.random())}async function Yh(n,e){var t;for(let r=0;;){if((t=e==null?void 0:e.signal)==null?void 0:t.aborted)throw Kn;let i;try{i=await fetch(n,e)}catch(a){throw Cr.fromRequestError(n,a)}if(!i.ok){let{status:a}=i;if((a===429||a===503||a===504)&&++r!==_z){await new Promise(o=>setTimeout(o,ib(r-1)));continue}throw Cr.fromResponse(i)}return i}}function Kh(n){return n.arrayBuffer()}function bt(n){return n.json()}async function $i(n,e,t,r=at){if(r===at){let o=await Yh(n,e);return await t(o)}let i=new AbortController,a=r.add(()=>i.abort());try{let o=await Yh(n,{...e,signal:i.signal});return await t(o)}finally{a()}}var AZ=new X;function ml(n){let e=/^([^:\/]+):\/\/([^\/]+)((?:\/.*)?)$/,t=n.match(e);if(t===null)throw new Error(`Invalid URL: ${JSON.stringify(n)}`);return{protocol:t[1],host:t[2],path:t[3]}}function ji(n){return n instanceof Cr?n.status===0||n.status===403||n.status===404:!1}var Nz=3;async function Pa(n,e,t,r,i,a,o=at){let l;e:for(let c=0;;){XE(o),c>1&&await new Promise(d=>setTimeout(d,ib(c-2))),l=await n.get(l,o);try{return await $i(typeof e=="function"?e(l.credentials):e,i(l.credentials,t),r,o)}catch(d){if(d instanceof Cr&&a(d,l.credentials)==="refresh"){if(++c===Nz)throw d;continue e}throw d}}}function Ia(n,e,t,r,i=at){return n===void 0?$i(e,t,r,i):Pa(n,e,t,r,(a,o)=>{if(!a.accessToken)return o;let l=new Headers(o.headers);return l.set("Authorization",`${a.tokenType} ${a.accessToken}`),{...o,headers:l}},(a,o)=>{let{status:l}=a;if(l===401)return"refresh";if(l===403&&!o.accessToken)return"refresh";throw a instanceof Error&&o.email!==void 0&&(a.message+=`  (Using credentials for ${JSON.stringify(o.email)})`),a},i)}var Jd="google-brainmaps";function gl(n,e,t,r=at){return Ia(e,`${n.serverUrl}${t.path}`,{method:t.method,body:t.payload},t.responseType==="json"?bt:Kh,r)}var Aa;(function(r){r[r.RAW=0]="RAW",r[r.JPEG=1]="JPEG",r[r.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION"})(Aa||(Aa={}));var Xh=class{};Xh.RPC_ID="brainmaps/VolumeChunkSource";var Qh=class{};Qh.RPC_ID="brainmaps/MultiscaleMeshSource";var Zh=class{};Zh.RPC_ID="brainmaps/MeshSource";var em=class{};em.RPC_ID="brainmaps/SkeletonSource";var tm=class{};tm.RPC_ID="brainmaps/Annotation";var nm=class{};nm.RPC_ID="brainmaps/AnnotationSpatialIndex";var tI="mesh/MeshLayer",nI="mesh/MultiscaleMeshLayer",rI="mesh/FragmentSource",iI="mesh/MultiscaleFragmentSource",gi;(function(r){r[r.float32=0]="float32",r[r.uint10=1]="uint10",r[r.uint16=2]="uint16"})(gi||(gi={}));function aI(n,e,t){return n&1|e<<1&2|t<<2&4}var rm=!1;function Bz(n,e,t,r,i,a,o){let{octree:l,lodScales:c,chunkGridSpatialOrigin:d,chunkShape:p}=n,m=c.length-1,g=e[0],v=e[4],b=e[8],x=e[1],C=e[5],T=e[9],I=e[3],P=e[7],M=e[11],D=e[15],E=I>0?0:1,V=P>0?0:1,O=M>0?0:1,B=t[4*4],z=t[4*4+1],_=t[4*4+2],U=t[4*4+3];function N(Je,tt,_e){return I*Je+P*tt+M*_e+D}function J(Je,tt,_e,dt,jn,ta){return N(Je+E*(dt-Je),tt+V*(jn-tt),_e+O*(ta-_e))}let ie=N(-U*B,-U*z,-U*_),pe=n.clipLowerBound[0],me=n.clipLowerBound[1],Pe=n.clipLowerBound[2],le=n.clipUpperBound[0],we=n.clipUpperBound[1],Re=n.clipUpperBound[2],Ue=Math.sqrt((g*i)**2+(x*a)**2),et=Math.sqrt((v*i)**2+(C*a)**2),ye=Math.sqrt((b*i)**2+(T*a)**2),ke=Math.max(Ue,et,ye);function $e(Je,tt,_e){let dt=1<<Je,jn=tt*5,ta=l[jn],nt=l[jn+1],Er=l[jn+2],na=l[jn+3],ra=l[jn+4],ia=ta*dt*p[0]+d[0],aa=nt*dt*p[1]+d[1],oi=Er*dt*p[2]+d[2],Ei=ia+dt*p[0],Ga=aa+dt*p[1],ko=oi+dt*p[2];if(ia=Math.max(ia,pe),aa=Math.max(aa,me),oi=Math.max(oi,Pe),Ei=Math.min(Ei,le),Ga=Math.min(Ga,we),ko=Math.min(ko,Re),Yf(ia,aa,oi,Ei,Ga,ko,t)){let Eo=Math.max(ie,J(ia,aa,oi,Ei,Ga,ko))/ke;if(_e===0||Eo*r<_e){let Rn=c[Je];if(Rn!==0&&o(Je,tt,Rn/Eo,ra>>>31),Je>0&&(Rn===0||Eo*r<Rn)){let bu=Rn===0?_e:Rn,lr=(ra&2147483647)>>>0;for(let Lt=na;Lt<lr;++Lt)$e(Je-1,Lt,bu)}}}}$e(m,l.length/5-1,0)}function ab(n,e,t,r,i,a,o,l){let{lodScales:c}=n,d=0;for(;d+1<c.length&&c[d+1]!==0;)++d;let p=3,m=[],g=0,v=0;function b(T,I){for(rm&&console.log(`emitChunksUpTo: stackDepth=${g}, targetStackIndex=${T}, subChunkIndex=${I}, priorSubChunkIndex=${v}`);;){if(g===0)return;let P=g-1,M=d-P,D=m[P*p],E=M===0?1:8,V=m[P*p+1],O=m[P*p+2];if(T===g){let B=I&E-1;v!==B&&D!==-1&&(rm&&console.log(`  drawing chunk because priorSubChunkIndex (${v}) != endSubChunk (${B})`),l(M,D,v,B,O)),v=B+1;return}v!==E&&D!==-1&&l(M,D,v,E,O),v=V+1,--g}}let x=0;rm&&(console.log(""),console.log("Starting to draw"));let{octree:C}=n;Bz(n,e,t,r,i,a,(T,I,P,M)=>{if(!M&&!o(T,I,P)){x=Math.max(T,x);return}if(T<x)return;x=0;let D=I*5,E=C[D],V=C[D+1],O=C[D+2],B=aI(E,V,O),z=d-T;b(z,B);let _=z*p;m[_]=M?-1:I,m[_+1]=B,m[_+2]=P,rm&&console.log(`Adding to stack: lod=${T}, row=${m[_]}, subChunkIndex=${B}`),v=0,g=z+1}),b(0,0)}function oI(n){if(n.length%5!=0)throw new Error("Invalid length");let e=n.length/5,t=new Set;function r(i){if(t.has(i))throw new Error("Previously seen node");if(t.add(i),i<0||i>=e)throw new Error("Invalid node reference");let a=n[i*5],o=n[i*5+1],l=n[i*5+2],c=n[i*5+3],d=n[i*5+4];if(c<0||d<0||d<c||d>e||c+8<d)throw new Error("Invalid child references");for(let p=c;p<d;++p){let m=n[p*5],g=n[p*5+1],v=n[p*5+2];if(m>>>1!==a||g>>>1!==o||v>>>1!=l)throw new Error("invalid child");r(p)}}if(e!==0&&(r(e-1),t.size!==e))throw new Error("Orphan nodes in octree")}function ob(n,e,t){return`${n}/${e}:${t}`}var Ur=class extends Gd{draw(e,t){}isReady(e,t){return!0}get transparentPickEnabled(){return!0}};var Uz=3432918353,Fz=461845907;function Fc(n,e){return e>>>=0,n>>>=0,e=Math.imul(e,Uz)>>>0,e=(e<<15|e>>>17)>>>0,e=Math.imul(e,Fz)>>>0,n=(n^e)>>>0,n=(n<<13|n>>>19)>>>0,n=n*5+3864292196>>>0,n}var im=3,Gz=.8,rs=!1,Ma=0,Ra=0,sI=0,lI=0,Gc=class{constructor(e=Gc.generateHashSeeds(im)){this.hashSeeds=e;this.loadFactor=Gz;this.size=0;this.emptyLow=4294967295;this.emptyHigh=4294967295;this.maxRehashAttempts=5;this.maxAttempts=5;this.generation=0;this.mungedEmptyKey=-1;let t=8;for(;t<2*e.length;)t*=2;this.allocate(t)}updateHashFunctions(e){this.hashSeeds=Gc.generateHashSeeds(e),this.mungedEmptyKey=-1}tableWithMungedEmptyKey(e){let t=this.hashSeeds.length,r=new Array(t);for(let c=0;c<t;++c)r[c]=this.getHash(c,this.emptyLow,this.emptyHigh);let{mungedEmptyKey:i}=this;if(i===-1){e:for(;;){i=Math.random()*16777216>>>0;for(let c=0;c<t;++c){let d=this.getHash(c,i,i);for(let p=0;p<t;++p)if(r[p]===d)continue e}this.mungedEmptyKey=i;break}}let{table:a,emptyLow:o,emptyHigh:l}=this;for(let c=0;c<t;++c){let d=r[c];a[d]===o&&a[d+1]===l&&(a[d]=i,a[d+1]=i)}try{e(a)}finally{for(let c=0;c<t;++c){let d=r[c];a[d]===i&&a[d+1]===i&&(a[d]=o,a[d+1]=l)}}}static generateHashSeeds(e=im){return TE(new Uint32Array(e))}getHash(e,t,r){let i=this.hashSeeds[e];return i=Fc(i,t),i=Fc(i,r),this.entryStride*(i&this.tableSize-1)}*keys(){let{emptyLow:e,emptyHigh:t,entryStride:r}=this,{table:i}=this;for(let a=0,o=i.length;a<o;a+=r){let l=i[a],c=i[a+1];(l!==e||c!==t)&&(yield new X(l,c))}}*unsafeKeys(e=new X){let{emptyLow:t,emptyHigh:r,entryStride:i}=this,{table:a}=this;for(let o=0,l=a.length;o<l;o+=i){let c=a[o],d=a[o+1];(c!==t||d!==r)&&(e.low=c,e.high=d,yield e)}}indexOfPair(e,t){let{table:r,emptyLow:i,emptyHigh:a}=this;if(e===i&&t===a)return-1;for(let o=0,l=this.hashSeeds.length;o<l;++o){let c=this.getHash(o,e,t);if(r[c]===e&&r[c+1]===t)return c}return-1}indexOf(e){return this.indexOfPair(e.low,e.high)}chooseAnotherEmptyKey(){let{emptyLow:e,emptyHigh:t,table:r,entryStride:i}=this,a,o;for(;a=Math.random()*4294967296>>>0,o=Math.random()*4294967296>>>0,!(!(a===e&&o===t)&&!this.hasPair(a,o)););this.emptyLow=a,this.emptyHigh=o;for(let l=0,c=r.length;l<c;l+=i)r[l]===e&&r[l+1]===t&&(r[l]=a,r[l+1]=o)}has(e){return this.indexOf(e)!==-1}hasPair(e,t){return this.indexOfPair(e,t)!==-1}delete(e){let t=this.indexOf(e);if(t!==-1){let{table:r}=this;return r[t]=this.emptyLow,r[t+1]=this.emptyHigh,++this.generation,this.size--,!0}return!1}clearTable(){let{table:e,entryStride:t,emptyLow:r,emptyHigh:i}=this,a=e.length;for(let o=0;o<a;o+=t)e[o]=r,e[o+1]=i}clear(){return this.size===0?!1:(this.size=0,++this.generation,this.clearTable(),!0)}reserve(e){return e>this.capacity?(this.backupPending(),this.grow(e),this.restorePending(),!0):!1}swapPending(e,t){let r=Ma,i=Ra;this.storePending(e,t),e[t]=r,e[t+1]=i}storePending(e,t){Ma=e[t],Ra=e[t+1]}backupPending(){sI=Ma,lI=Ra}restorePending(){Ma=sI,Ra=lI}tryToInsert(){rs&&console.log(`tryToInsert: ${Ma}, ${Ra}`);let e=0,{emptyLow:t,emptyHigh:r,maxAttempts:i,table:a}=this,o=this.hashSeeds.length,l=Math.floor(Math.random()*o);for(;;){let c=this.getHash(l,Ma,Ra);if(this.swapPending(a,c),Ma===t&&Ra===r)return!0;if(++e===i)break;l=(l+Math.floor(Math.random()*(o-1))+1)%o}return!1}allocate(e){this.tableSize=e;let{entryStride:t}=this;this.table=new Uint32Array(e*t),this.maxAttempts=e,this.clearTable(),this.capacity=e*this.loadFactor,this.mungedEmptyKey=-1}rehash(e,t){rs&&console.log("rehash begin"),this.allocate(t),this.updateHashFunctions(this.hashSeeds.length);let{emptyLow:r,emptyHigh:i,entryStride:a}=this;for(let o=0,l=e.length;o<l;o+=a){let c=e[o],d=e[o+1];if((c!==r||d!==i)&&(this.storePending(e,o),!this.tryToInsert()))return rs&&console.log("rehash failed"),!1}return rs&&console.log("rehash end"),!0}grow(e){rs&&console.log(`grow: ${e}`);let t=this.table,{tableSize:r}=this;for(;r<e;)r*=2;for(;;){for(let i=0;i<this.maxRehashAttempts;++i)if(this.rehash(t,r)){rs&&console.log("grow end");return}r*=2}}insertInternal(){for(++this.generation,Ma===this.emptyLow&&Ra===this.emptyHigh&&this.chooseAnotherEmptyKey(),++this.size>this.capacity&&(this.backupPending(),this.grow(this.tableSize*2),this.restorePending());!this.tryToInsert();)this.backupPending(),this.grow(this.tableSize),this.restorePending()}},am=class extends Gc{add(e){let{low:t,high:r}=e;return this.hasPair(t,r)?!1:(rs&&console.log(`add: ${t},${r}`),Ma=t,Ra=r,this.insertInternal(),!0)}[Symbol.iterator](){return this.unsafeKeys()}};am.prototype.entryStride=2;var qd=0,Yd=0,cI=0,uI=0,Wc=class extends Gc{set(e,t){let{low:r,high:i}=e;return this.hasPair(r,i)?!1:(rs&&console.log(`add: ${r},${i} -> ${t.low},${t.high}`),Ma=r,Ra=i,qd=t.low,Yd=t.high,this.insertInternal(),!0)}get(e,t){let r=this.indexOf(e);if(r===-1)return!1;let{table:i}=this;return t.low=i[r+2],t.high=i[r+3],!0}swapPending(e,t){let r=qd,i=Yd;super.swapPending(e,t),e[t+2]=r,e[t+3]=i}storePending(e,t){super.storePending(e,t),qd=e[t+2],Yd=e[t+3]}backupPending(){super.backupPending(),cI=qd,uI=Yd}restorePending(){super.restorePending(),qd=cI,Yd=uI}[Symbol.iterator](){return this.unsafeEntries()}*entries(){let{emptyLow:e,emptyHigh:t,entryStride:r}=this,{table:i}=this;for(let a=0,o=i.length;a<o;a+=r){let l=i[a],c=i[a+1];if(l!==e||c!==t){let d=new X(l,c),p=new X(i[a+2],i[a+3]);yield[d,p]}}}*unsafeEntries(e=[new X,new X]){let{emptyLow:t,emptyHigh:r,entryStride:i}=this,{table:a}=this,[o,l]=e;for(let c=0,d=a.length;c<d;c+=i){let p=a[c],m=a[c+1];(p!==t||m!==r)&&(o.low=p,o.high=m,l.low=a[c+2],l.high=a[c+3],yield e)}}};Wc.prototype.entryStride=4;var Ji=class{},yl=[-1,WebGL2RenderingContext.RED_INTEGER,WebGL2RenderingContext.RG_INTEGER,WebGL2RenderingContext.RGB_INTEGER,WebGL2RenderingContext.RGBA_INTEGER],Wz=[-1,WebGL2RenderingContext.RED,WebGL2RenderingContext.RG,WebGL2RenderingContext.RGB,WebGL2RenderingContext.RGBA],om=["","r","rg","rgb","rgba"],zz=[-1,WebGL2RenderingContext.R8UI,WebGL2RenderingContext.RG8UI,WebGL2RenderingContext.RGB8UI,WebGL2RenderingContext.RGBA8UI],Hz=[-1,WebGL2RenderingContext.R8I,WebGL2RenderingContext.RG8I,WebGL2RenderingContext.RGB8I,WebGL2RenderingContext.RGBA8I],$z=[-1,WebGL2RenderingContext.R16UI,WebGL2RenderingContext.RG16UI,WebGL2RenderingContext.RGB16UI,WebGL2RenderingContext.RGBA16UI],jz=[-1,WebGL2RenderingContext.R16I,WebGL2RenderingContext.RG16I,WebGL2RenderingContext.RGB16I,WebGL2RenderingContext.RGBA16I],dI=[-1,WebGL2RenderingContext.R32UI,WebGL2RenderingContext.RG32UI,WebGL2RenderingContext.RGB32UI,WebGL2RenderingContext.RGBA32UI],Jz=[-1,WebGL2RenderingContext.R32I,WebGL2RenderingContext.RG32I,WebGL2RenderingContext.RGB32I,WebGL2RenderingContext.RGBA32I],qz=[-1,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RG32F,WebGL2RenderingContext.RGB32F,WebGL2RenderingContext.RGBA32F];function zc(n){return n===G.FLOAT32?"":Cc[n]?"i":"u"}function yi(n,e,t=1){switch(e){case G.UINT8:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=zz[t],n.textureFormat=yl[t],n.texelType=WebGL2RenderingContext.UNSIGNED_BYTE,n.arrayElementsPerTexel=t,n.arrayConstructor=Uint8Array,n.samplerPrefix="u",n;case G.INT8:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=Hz[t],n.textureFormat=yl[t],n.texelType=WebGL2RenderingContext.BYTE,n.arrayElementsPerTexel=t,n.arrayConstructor=Int8Array,n.samplerPrefix="i",n;case G.UINT16:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=$z[t],n.textureFormat=yl[t],n.texelType=WebGL2RenderingContext.UNSIGNED_SHORT,n.arrayElementsPerTexel=t,n.arrayConstructor=Uint16Array,n.samplerPrefix="u",n;case G.INT16:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=jz[t],n.textureFormat=yl[t],n.texelType=WebGL2RenderingContext.SHORT,n.arrayElementsPerTexel=t,n.arrayConstructor=Int16Array,n.samplerPrefix="i",n;case G.UINT32:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=dI[t],n.textureFormat=yl[t],n.texelType=WebGL2RenderingContext.UNSIGNED_INT,n.arrayElementsPerTexel=1,n.arrayConstructor=Uint32Array,n.samplerPrefix="u",n;case G.INT32:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=Jz[t],n.textureFormat=yl[t],n.texelType=WebGL2RenderingContext.INT,n.arrayElementsPerTexel=1,n.arrayConstructor=Int32Array,n.samplerPrefix="i",n;case G.UINT64:if(t<1||t>2)break;return n.texelsPerElement=1,n.textureInternalFormat=dI[t*2],n.textureFormat=yl[t*2],n.texelType=WebGL2RenderingContext.UNSIGNED_INT,n.arrayElementsPerTexel=2*t,n.arrayConstructor=Uint32Array,n.samplerPrefix="u",n;case G.FLOAT32:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=qz[t],n.textureFormat=Wz[t],n.texelType=WebGL2RenderingContext.FLOAT,n.arrayElementsPerTexel=t,n.arrayConstructor=Float32Array,n.samplerPrefix="",n}throw new Error(`No supported texture format for ${G[e]}[${t}].`)}function is(n,e,t){let{arrayConstructor:r,arrayElementsPerTexel:i,textureInternalFormat:a,textureFormat:o,texelsPerElement:l}=e,{maxTextureSize:c}=n,d=t.length/i;if(d*l>c*c)throw new Error("Number of elements exceeds maximum texture size: "+l+" * "+d);let p=Math.ceil(d/c),m=Math.ceil(Math.log2(p)),g=(1<<m)*l,v=Math.ceil(d/(1<<m)),b=g*v*i;t.constructor!==r&&(t=new r(t.buffer,t.byteOffset,t.byteLength/r.BYTES_PER_ELEMENT));let x=PL(t,b);n.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),so(n),n.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,a,g,v,0,o,e.texelType,x)}function pI(n,e,t,r,i){let{arrayConstructor:a,textureInternalFormat:o,textureFormat:l,texelsPerElement:c}=e;t.constructor!==a&&(t=new a(t.buffer,t.byteOffset,t.byteLength/a.BYTES_PER_ELEMENT)),n.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),so(n),n.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,o,r*c,i,0,l,e.texelType,t)}function fI(n,e,t,r,i,a){let{arrayConstructor:o,textureInternalFormat:l,textureFormat:c,texelsPerElement:d}=e;t.constructor!==o&&(t=new o(t.buffer,t.byteOffset,t.byteLength/o.BYTES_PER_ELEMENT)),n.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),eP(n),n.texImage3D(WebGL2RenderingContext.TEXTURE_3D,0,l,r*d,i,a,0,c,e.texelType,t)}function Yz(n){switch(n){case G.UINT8:return DS;case G.INT8:return PS;case G.UINT16:return IS;case G.INT16:return AS;case G.UINT32:return tl;case G.INT32:return MS;case G.UINT64:return Pt;case G.FLOAT32:return Oh}}function hI(n,e,t,r,i,a){let o=_t(i,a),l=[Yz(i)],c=`
${o} ${n}(${r} index) {
`;switch(i){case G.UINT8:case G.UINT16:case G.UINT32:c+=`
  ${o} result;
  highp uvec4 temp;
  ${e}(${t}, index, temp);
  result.value = temp.${om[a]};
  return result;
`;break;case G.INT8:case G.INT16:case G.INT32:c+=`
  ${o} result;
  highp ivec4 temp;
  ${e}(${t}, index, temp);
  result.value = temp.${om[a]};
  return result;
`;break;case G.UINT64:l.push(VD),c+=`
  highp uvec4 temp;
  ${e}(${t}, index, temp);
  return unpackUint64leFromUint32(temp.${om[a*2]});
`;break;case G.FLOAT32:l.push(Oh),c+=`
  highp vec4 temp;
  ${e}(${t}, index, temp);
  return temp.${om[a]};
`;break}return c+=`
}
`,l.push(c),l}var ho=class{constructor(e){this.key=e;this.readTextureValue=`readTextureValue_${this.key}`}defineShader(e){}getReadTextureValueCode(e,t){let r=`
void ${this.readTextureValue}(highp ${t}sampler2D sampler, highp uint index`;for(let i=0;i<e;++i)r+=`, out ${t}vec4 output${i}`;r+=`) {
  highp int width = textureSize(sampler, 0).x / ${e};
  highp uint log2width = log2Exact(uint(width));
  highp int y = int(index >> log2width);
  highp int x = int((index - (uint(y) << log2width)) * ${e}u);
`;for(let i=0;i<e;++i)r+=`
  output${i} = texelFetch(sampler, ivec2(x + ${i}, y), 0);
`;return r+=`
}
`,[FD,r]}getAccessor(e,t,r,i=1){let a=zc(r);return[this.getReadTextureValueCode(1,a),...hI(e,this.readTextureValue,t,"highp uint",r,i)]}},sb=class{constructor(e,t){this.key=e;this.textureDims=t;this.readTextureValue=`readTextureValue_${this.key}`}getReadTextureValueCode(e,t){let{textureDims:r}=this,i=`
void ${this.readTextureValue}(highp ${t}sampler${this.textureDims}D sampler, highp ivec${r} p`;for(let a=0;a<e;++a)i+=`, out ${t}vec4 output${a}`;i+=`) {
`;for(let a=0;a<e;++a)i+=`
  output${a} = texelFetch(sampler, ivec${r}(p.x * ${e} + ${a}, p.y
                                         ${r===3?", p.z":""}), 0);
`;return i+=`
}
`,i}getAccessor(e,t,r,i=1){let a=zc(r);return[this.getReadTextureValueCode(1,a),...hI(e,this.readTextureValue,t,`highp ivec${this.textureDims}`,r,i)]}};var lb=[Pt,`
highp uint hashCombine(highp uint state, highp uint value) {
  value *= 0xcc9e2d51u;
  value = (value << 15u) | (value >> 17u);
  value *= 0x1b873593u;
  state ^= value;
  state = (state << 13u) | (state >> 19u);
  state = (state * 5u) + 0xe6546b64u;
  return state;
}
highp uint hashCombine(highp uint state, uint64_t x) {
  state = hashCombine(state, x.value[0]);
  return hashCombine(state, x.value[1]);
}
`],Kz=yi(new Ji,G.UINT64,1),vl=class extends j{constructor(e,t){super();this.gl=e;this.hashTable=t;this.generation=-1;this.texture=null;this.texture=e.createTexture()}copyToGPU(){let{hashTable:e}=this,{generation:t}=e;if(this.generation===t)return;let{gl:r,texture:i}=this;this.generation=t,r.activeTexture(WebGL2RenderingContext.TEXTURE0+r.tempTextureUnit),r.bindTexture(WebGL2RenderingContext.TEXTURE_2D,i),e.tableWithMungedEmptyKey(a=>{is(this.gl,Kz,a)}),r.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}disposed(){let{gl:e}=this;e.deleteTexture(this.texture),this.texture=null,this.gl=void 0,this.hashTable=void 0,super.disposed()}static get(e,t){return e.memoize.get(t,()=>new this(e,t))}},sm=class{constructor(e,t=im){this.prefix=e;this.numAlternatives=t;this.textureUnitSymbol=Symbol.for(`gpuhashtable:${this.prefix}`);this.accessHelper=new ho(`gpuhashtable_${this.prefix}`);this.samplerName=this.prefix+"_sampler";this.hashSeedsName=this.prefix+"_seeds";this.hashKeyMask=this.prefix+"_keyMask";this.readTable=this.prefix+"_readTable"}defineShader(e){let{hashSeedsName:t,samplerName:r,numAlternatives:i,hashKeyMask:a}=this;e.addUniform("highp uint",t,i),e.addUniform("highp uint",a),e.addTextureSampler("usampler2D",r,this.textureUnitSymbol),e.addFragmentCode(lb),e.addFragmentCode(Pt),e.addFragmentCode(Vh),this.accessHelper.defineShader(e),e.addFragmentCode(this.accessHelper.getAccessor(this.readTable,this.samplerName,G.UINT64,1));let o="";o+=`
bool ${this.hasFunctionName}(uint64_t x) {
`;for(let l=0;l<i;++l)o+=`
  {
    uint h = hashCombine(${t}[${l}], x) & ${a};
    uint64_t key = ${this.readTable}(h);
    if (equals(key, x)) {
      return true;
    }
  }
`;o+=`
  return false;
}
`,e.addFragmentCode(o)}get hasFunctionName(){return`${this.prefix}_has`}enable(e,t,r){r.copyToGPU();let i=t.textureUnit(this.textureUnitSymbol);e.activeTexture(WebGL2RenderingContext.TEXTURE0+i),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,r.texture),e.uniform1ui(t.uniform(this.hashKeyMask),r.hashTable.tableSize-1),e.uniform1uiv(t.uniform(this.hashSeedsName),r.hashTable.hashSeeds)}disable(e,t){let r=t.textureUnit(this.textureUnitSymbol);e.activeTexture(WebGL2RenderingContext.TEXTURE0+r),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}},Kd=class extends sm{defineShader(e){super.defineShader(e);let{numAlternatives:t,hashSeedsName:r,hashKeyMask:i}=this,a=`
bool ${this.getFunctionName}(uint64_t x, out uint64_t value) {
`;for(let o=0;o<t;++o)a+=`
  {
    uint h = hashCombine(${r}[${o}], x) & ${i};
    uint64_t key = ${this.readTable}(h * 2u);
    if (equals(key, x)) {
      value = ${this.readTable}(h * 2u + 1u);
      return true;
    }
  }
`;a+=`
  return false;
}
`,e.addFragmentCode(a)}get getFunctionName(){return`${this.prefix}_get`}};function Sl(n,e,t,r){e*=6;let i=Math.floor(e),a=e-i,o=r*(1-t),l=r*(1-t*a),c=r*(1-t*(1-a));switch(i%6){case 0:n[0]=r,n[1]=c,n[2]=o;break;case 1:n[0]=l,n[1]=r,n[2]=o;break;case 2:n[0]=o,n[1]=r,n[2]=c;break;case 3:n[0]=o,n[1]=l,n[2]=r;break;case 4:n[0]=c,n[1]=o,n[2]=r;break;case 5:n[0]=r,n[1]=o,n[2]=l;break}return n}function mI(n,e,t,r){let i=Math.max(Math.max(e,t),r),a=Math.min(Math.min(e,t),r);if(n[2]=i,a===i)n[0]=0,n[1]=0;else{let o=i-a;n[1]=o/i,e===i?n[0]=(t-r)/o:t===i?n[0]=2+(r-e)/o:n[0]=4+(e-t)/o,n[0]/=6,n[0]<0&&(n[0]+=1),n[0]>1&&(n[0]-=1)}return n}var gI=2,cb=class{constructor(e){this.prefix=e;this.seedName=this.prefix+"_seed"}defineShader(e){let{seedName:t}=this;e.addUniform("highp uint",t),e.addFragmentCode(Pt),e.addFragmentCode(lb),e.addFragmentCode(_D);let r=`
vec3 ${this.prefix}(uint64_t x) {
  uint h = hashCombine(${t}, x);
  vec${gI} v;
`;for(let i=0;i<gI;++i)r+=`
  v[${i}] = float(h & 0xFFu) / 255.0;
  h >>= 8u;
`;r+=`
  vec3 hsv = vec3(v.x, 0.5 + v.y * 0.5, 1.0);
  return hsvToRgb(hsv);
}
`,e.addFragmentCode(r)}enable(e,t,r){e.uniform1ui(t.uniform(this.seedName),r)}},yI=new Float32Array(3);function ub(n){return`rgb(${n[0]*100}%,${n[1]*100}%,${n[2]*100}%)`}var Xd=class{constructor(e=Fv()){this.hashSeed=e;this.changed=new re}static getDefault(){return new Xd(0)}get value(){return this.hashSeed}set value(e){e!==this.hashSeed&&(this.hashSeed=e,this.changed.dispatch())}compute(e,t){let r=Fc(this.hashSeed,t.low);r=Fc(r,t.high);let i=(r&255)/255,a=(r>>8&255)/255;return Sl(e,i,.5+.5*a,1),e}computeCssColor(e){return this.compute(yI,e),ub(yI)}randomize(){this.hashSeed=Fv(),this.changed.dispatch()}toString(){return`new SegmentColorHash(${this.hashSeed})`}toJSON(){return this.hashSeed===0?void 0:this.hashSeed}reset(){this.restoreState(0)}restoreState(e){let t=e>>>0;t!==this.hashSeed&&(this.hashSeed=t,this.changed.dispatch())}},db=class{constructor(e){this.prefix=e;this.hashMapShaderManager=new Kd("segmentStatedColorHash")}defineShader(e){this.hashMapShaderManager.defineShader(e);let t=`
bool ${this.getFunctionName}(uint64_t x, out vec4 value) {
  uint64_t uint64Value;
  if (${this.hashMapShaderManager.getFunctionName}(x, uint64Value)) {
    uint uintValue = uint64Value.value[0];
    value.r = float((uintValue & 0x0000ffu))       / 255.0;
    value.g = float((uintValue & 0x00ff00u) >>  8) / 255.0;
    value.b = float((uintValue & 0xff0000u) >> 16) / 255.0;
    value.a = float((uintValue & 0xff000000u) >> 24) / 255.0;
    return true;
  }
  return false;
}
`;e.addFragmentCode(t)}get getFunctionName(){return`${this.prefix}_get`}enable(e,t,r){this.hashMapShaderManager.enable(e,t,r)}disable(e,t){this.hashMapShaderManager.disable(e,t)}};var lm='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="arrowLeftIconTitle"><path d="M9 6l-6 6 6 6"></path><path d="M21 12H4"></path><path stroke-linecap="round" d="M3 12h1"></path></svg>';var cm='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="arrowRightIconTitle"><path d="M15 18l6-6-6-6"></path><path d="M3 12h17"></path><path stroke-linecap="round" d="M21 12h-1"></path></svg>';var pb=class{constructor(e){this.parents=new Array;this.parentPriorities=new Array;this.bindings=new Map;if(e!==void 0){this.parents.push(...e.parents),this.parentPriorities.push(...e.parentPriorities);for(let[t,r]of e.bindings)this.bindings.set(t,r)}}addParent(e,t){let{parents:r,parentPriorities:i}=this,a=0,{length:o}=r;for(;a<o&&t<i[a];)++a;return r.splice(a,0,e),i.splice(a,0,t),()=>{this.removeParent(e)}}removeParent(e){let t=this.parents.indexOf(e);if(t===-1)throw new Error("Attempt to remove non-existent parent map.");this.parents.splice(t,1),this.parentPriorities.splice(t,1)}set(e,t){this.bindings.set(e,t)}delete(e){this.bindings.delete(e)}clear(){this.bindings.clear(),this.parents.length=0,this.parentPriorities.length=0}get(e){let{parents:t,parentPriorities:r}=this,i=r.length,a=0,o;for(;a<i&&r[a]>0;++a)if(o=t[a].get(e),o!==void 0)return o;if(o=this.bindings.get(e),o!==void 0)return o;for(;a<i;++a)if(o=t[a].get(e),o!==void 0)return o}*getAll(e){let{parents:t,parentPriorities:r}=this,i=r.length,a=0,o;for(;a<i&&r[a]>0;)o=t[a].get(e),o!==void 0&&(yield o);for(o=this.bindings.get(e),o!==void 0&&(yield o);a<i;)o=t[a].get(e),o!==void 0&&(yield o)}*entries(){let{parents:e,parentPriorities:t}=this,r=t.length,i=0;for(;i<r&&t[i]>0;++i)yield*e[i].entries();for(yield*this.bindings.entries();i<r;++i)yield*e[i].entries()}};var Tt;(function(i){i[i.CONTROL=1]="CONTROL",i[i.ALT=2]="ALT",i[i.META=4]="META",i[i.SHIFT=8]="SHIFT"})(Tt||(Tt={}));function um(n){return(n.ctrlKey?1:0)|(n.altKey?2:0)|(n.metaKey?4:0)|(n.shiftKey?8:0)}function fb(n,e){let t="";return e&1&&(t+="control+"),e&2&&(t+="alt+"),e&4&&(t+="meta+"),e&8&&(t+="shift+"),t+=n,t}function Xz(n,e,t){let r="";return e&1&&(r+="control+"),t&1&&(r+="control?+"),e&2&&(r+="alt+"),t&2&&(r+="alt?+"),e&4&&(r+="meta+"),t&4&&(r+="meta?+"),e&8&&(r+="shift+"),t&8&&(r+="shift?+"),r+=n,r}function vI(n){let e=n.indexOf(":"),t;if(e!==-1&&(t=n.substring(0,e),t!=="at"&&t!=="bubble"))throw new Error(`Invalid event phase: ${JSON.stringify(t)}`);let r=n.substring(e+1).split("+"),i,a=0,o=0;e:for(let l of r)switch(l){case"control":a|=1;break;case"control?":o|=1;break;case"alt":a|=2;break;case"alt?":o|=2;break;case"meta":a|=4;break;case"meta?":o|=4;break;case"shift":a|=8;break;case"shift?":o|=8;break;default:if(i===void 0)i=l;else{i=void 0;break e}}if(i===void 0||a&o)throw new Error(`Invalid event identifier: ${JSON.stringify(n)}`);return{phase:t,keyName:i,modifiers:a,optionalModifiers:o}}function*Qz(n,e,t){t===0&&(yield fb(n,e));for(let r=0;r<16;++r)(r&(e|t))===r&&(r&e)===e&&(yield fb(n,r))}function*SI(n){let{phase:e}=n,t=Qz(n.keyName,n.modifiers,n.optionalModifiers);if(e===void 0)for(let r of t)yield`at:${r}`,yield`bubble:${r}`;else for(let r of t)yield`${e}:${r}`}function Zz(n,e){let t=Xz(n.keyName,n.modifiers,n.optionalModifiers);return typeof e=="string"?{action:e,originalEventIdentifier:t}:{...e,originalEventIdentifier:t}}var Me=class extends pb{static fromObject(e,t={}){let r=new Me;if(r.label=t.label,t.parents!==void 0)for(let[i,a]of t.parents)r.addParent(i,a);for(let i of Object.keys(e))r.set(i,e[i]);return r}setFromObject(e){for(let t of Object.keys(e))this.set(t,e[t])}set(e,t){let r=vI(e),i=Zz(r,t);for(let a of SI(r))super.set(a,i)}delete(e){for(let t of SI(vI(e)))super.delete(t)}describe(){let e=[],t=new Map;for(let[,r]of this.entries())t.set(r.originalEventIdentifier,r.action);for(let[r,i]of t)e.push(`${r}\u2192${i}`);return e.join(", ")}};function hb(n,e,t){if(t===void 0)return;t.stopPropagation!==!1&&n.stopPropagation();let r=new CustomEvent("action:"+t.action,{bubbles:!0,detail:e,cancelable:!0}),i=!n.target.dispatchEvent(r);(t.preventDefault!==!1||i)&&n.preventDefault()}var dm=[];dm[Event.AT_TARGET]="at";dm[Event.CAPTURING_PHASE]="capture";dm[Event.BUBBLING_PHASE]="bubble";function mb(n,e,t,r,i){let a=dm[t]+":"+n,o=i.get(a);hb(e,r,o)}function pm(n,e,t,r){mb(fb(n,um(e)),e,e.eventPhase,t,r)}function ce(n,e,t,r){return En(n,`action:${e}`,t,r)}var gb;function e6(){if(gb===void 0){let n=new Me;n.set("keyl","recolor"),n.set("keyx","clear-segments"),n.set("keys","toggle-show-slices"),n.set("keyb","toggle-scale-bar"),n.set("keyv","toggle-default-annotations"),n.set("keya","toggle-axis-lines"),n.set("keyo","toggle-orthographic-projection");for(let e=1;e<=9;++e)n.set("digit"+e,"toggle-layer-"+e),n.set("control+digit"+e,"select-layer-"+e),n.set("alt+digit"+e,"toggle-pick-layer-"+e);for(let e=0;e<26;++e){let t=String.fromCharCode(97+e),r=String.fromCharCode(65+e);n.set(`alt?+control?+shift+key${t}`,`tool-${r}`)}n.set("keyn","add-layer"),n.set("keyh","help"),n.set("space","toggle-layout"),n.set("shift+space","toggle-layout-alternative"),n.set("backslash","toggle-show-statistics"),gb=n}return gb}var yb;function Hc(){return yb===void 0&&(yb=Me.fromObject({"control+mousedown2":"select-position"})),yb}var vb;function bI(){return vb===void 0&&(vb=Me.fromObject({click0:"pin-annotation",mousedown2:"move-to-annotation"},{parents:[[Hc(),0]]})),vb}var Sb;function xI(){return Sb===void 0&&(Sb=Me.fromObject({arrowleft:"x-",arrowright:"x+",arrowup:"y-",arrowdown:"y+",comma:"z-",period:"z+",bracketleft:"t-",bracketright:"t+",keyz:"snap","control+equal":"zoom-in","alt+equal":"depth-range-decrease","control+shift+equal":"zoom-in","alt+shift+equal":"depth-range-decrease","control+minus":"zoom-out","alt+minus":"depth-range-increase",keyr:"rotate-relative-z-",keye:"rotate-relative-z+","shift+arrowdown":"rotate-relative-x-","shift+arrowup":"rotate-relative-x+","shift+arrowleft":"rotate-relative-y-","shift+arrowright":"rotate-relative-y+","control+wheel":{action:"zoom-via-wheel",preventDefault:!0},"alt+wheel":{action:"adjust-depth-range-via-wheel",preventDefault:!0},"at:wheel":{action:"z+1-via-wheel",preventDefault:!0},"at:shift+wheel":{action:"z+10-via-wheel",preventDefault:!0},"at:dblclick0":"select","at:control+mousedown0":"annotate","at:mousedown2":"move-to-mouse-position","at:alt+mousedown0":"move-annotation","at:control+alt+mousedown2":"delete-annotation","at:touchpinch":"zoom-via-touchpinch","at:touchrotate":"rotate-in-plane-via-touchrotate","at:touchtranslate2":"translate-in-plane-via-touchtranslate","at:touchhold1":"move-to-mouse-position","at:touchtap1x2":"select","at:touchtap2x3":"snap"},{label:"All Data Panels",parents:[[Hc(),0]]})),Sb}var bb;function t6(){return bb===void 0&&(bb=Me.fromObject({"at:mousedown0":{action:"rotate-via-mouse-drag",stopPropagation:!0},"at:shift+mousedown0":{action:"translate-via-mouse-drag",stopPropagation:!0},"at:touchtranslate1":"rotate-out-of-plane-via-touchtranslate"},{parents:[[xI(),Number.NEGATIVE_INFINITY]]})),bb}var xb;function n6(){return xb===void 0&&(xb=Me.fromObject({"at:mousedown0":{action:"translate-via-mouse-drag",stopPropagation:!0},"at:shift+mousedown0":{action:"rotate-via-mouse-drag",stopPropagation:!0},"at:touchtranslate1":"translate-z-via-touchtranslate"},{parents:[[xI(),Number.NEGATIVE_INFINITY]]})),xb}function CI(n){n.global.addParent(e6(),Number.NEGATIVE_INFINITY),n.sliceView.addParent(n6(),Number.NEGATIVE_INFINITY),n.perspectiveView.addParent(t6(),Number.NEGATIVE_INFINITY)}var $c,Qd=[];function r6(){if($c===void 0){let n=$c=document.createElement("div");n.classList.add("neuroglancer-drag-status"),document.body.appendChild(n)}return $c}function i6(){$c!==void 0&&(Ie($c),$c.style.display="none")}function wI(n){let e=r6();Ie(e),typeof n=="string"?e.appendChild(document.createTextNode(n)):e.appendChild(n()),e.style.display=""}function TI(n,e){Vf(Qd,t=>!(t.target===n&&t.operation===e))}function Qn(n,e,t){TI(n,e),Qd.push({target:n,operation:e,status:t}),wI(t)}function Xt(n,e){TI(n,e);let t=Qd.length===0?void 0:Qd[Qd.length-1];t===void 0?i6():wI(t.status)}var a6=300,o6=100,vi={side:"right",col:0,row:Infinity,flex:1,size:a6,minSize:o6,visible:!1},Zn=class{constructor(e=vi,t=e){this.defaultValue=e;this.value=t;this.changed=new ze;this.locationChanged=new ze;this.locationChanged.add(this.changed.dispatch);let r=this;this.watchableVisible={get value(){return r.visible},set value(i){r.visible=i},changed:r.locationChanged}}toJSON(e=this.defaultValue){let t={},{value:r}=this;for(let i in r)r[i]!==e[i]&&(t[i]=r[i]);return t}get visible(){return this.value.visible}set visible(e){let{value:t}=this;t.visible!==e&&(this.value={...t,visible:e},this.locationChanged.dispatch())}reset(){this.value!==this.defaultValue&&(this.value=this.defaultValue,this.locationChanged.dispatch())}restoreState(e,t=this.defaultValue){if(e===void 0)return;Z(e);let r={side:oe(e,"side",i=>{if(i!=="left"&&i!=="right"&&i!=="top"&&i!=="bottom")throw new Error(`Expected "left", "right", "top", or "bottom", but received: ${JSON.stringify(i)}`);return i},t.side),col:oe(e,"col",Qe,t.col),row:oe(e,"row",Qe,t.row),flex:oe(e,"flex",Qe,t.flex),size:oe(e,"size",St,t.size),visible:oe(e,"visible",ya,t.visible),minSize:t.minSize};this.value=r,this.locationChanged.dispatch()}};function sn(n,e,t){let{document:r}=n.view,i=n.clientX,a=n.clientY,o=p=>{let m=p.clientX-i,g=p.clientY-a;i=p.clientX,a=p.clientY,e(p,m,g)},l=n.button,c=p=>{r.removeEventListener("pointermove",o,!0),r.removeEventListener("pointerup",d,!1),t!==void 0&&t(p,p.clientX-i,p.clientY-a)},d=p=>{p.button===l&&c(p)};r.addEventListener("pointermove",o,!0),r.addEventListener("pointerup",d,!1),r.addEventListener("pointercancel",c,!1)}var LI='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="closeIconTitle"><path d="M6.34314575 6.34314575L17.6568542 17.6568542M6.34314575 17.6568542L17.6568542 6.34314575"></path></svg>';function He(n){let{title:e,onClick:t,href:r}=n,i;r!==void 0?(i=document.createElement("a"),i.href=r,i.target="_blank"):i=document.createElement("div"),e!==void 0&&(i.title=e),t!==void 0&&i.addEventListener("click",t);let{svg:a}=n;return i.className="neuroglancer-icon",a!==void 0&&(i.innerHTML=a),n.text!==void 0&&i.appendChild(document.createTextNode(n.text)),i}function jc(n={}){return He({svg:LI,...n})}var bl="neuroglancer-drag-over",kI={row:"row",column:"col"},s6={left:"right",right:"left",top:"bottom",bottom:"top"},as={left:"column",right:"column",top:"row",bottom:"row"},fm={left:"row",right:"row",top:"column",bottom:"column"},os={row:"width",column:"height"},EI={row:"left",column:"top"},l6={row:"right",column:"bottom"},DI={left:"marginLeft",right:"marginRight",top:"marginTop",bottom:"marginBottom"},hm={left:-1,right:1,top:-1,bottom:1},Fr=class extends j{constructor(e,t=new Zn){super();this.sidePanelManager=e;this.location=t;this.element=document.createElement("div");this.visibility=new It(It.VISIBLE);let{element:r}=this;r.classList.add("neuroglancer-side-panel"),r.draggable=!0,r.addEventListener("dragstart",i=>{this.sidePanelManager.startDrag(this.makeDragSource(),i),r.style.backgroundColor="black",setTimeout(()=>{r.style.backgroundColor=""},0),Qn(r,"drag",()=>document.createTextNode("Drag side panel to move it to the left/right/top/bottom of another panel"))}),r.addEventListener("dragend",i=>{this.sidePanelManager.endDrag(),Xt(r,"drag")})}makeDragSource(){return{dropAsNewPanel:e=>{let t=this.location.value;this.location.value={...t,...e},this.location.locationChanged.dispatch()}}}close(){this.location.visible=!1}addTitleBar(e){let t=document.createElement("div");t.classList.add("neuroglancer-side-panel-titlebar");let{title:r}=e,i;r!==void 0&&(i=document.createElement("div"),i.classList.add("neuroglancer-side-panel-title"),i.textContent=r,t.appendChild(i));let a=jc({title:"Close panel",onClick:()=>{this.close()}});return a.style.order="100",t.appendChild(a),this.element.appendChild(t),{titleBar:t,titleElement:i,closeButton:a}}addBody(e){e.draggable=!0,e.addEventListener("dragstart",t=>{t.preventDefault(),t.stopPropagation()}),this.element.appendChild(e)}},Cb=class extends j{constructor(e,t,r=new It(It.VISIBLE)){super();this.display=e;this.center=t;this.visibility=r;this.element=document.createElement("div");this.centerColumn=document.createElement("div");this.beforeRender=new ze;this.sides={left:this.makeSidePanelSideState("left"),right:this.makeSidePanelSideState("right"),top:this.makeSidePanelSideState("top"),bottom:this.makeSidePanelSideState("bottom")};this.registeredPanels=new Set;this.layoutNeedsUpdate=!1;this.invalidateLayout=()=>{this.layoutNeedsUpdate=!0,this.display.scheduleRedraw()};let{element:i,centerColumn:a}=this;i.style.display="flex",i.style.flex="1",i.style.flexDirection="row",a.style.display="flex",a.style.flex="1",a.style.flexDirection="column",a.style.flexBasis="0px",a.style.minWidth="0px",this.render(),this.registerDisposer(e.updateStarted.add(()=>{this.beforeRender.dispatch(),!!this.layoutNeedsUpdate&&(this.render(),++e.resizeGeneration)})),this.registerDisposer(this.visibility.changed.add(this.invalidateLayout))}get visible(){return this.visibility.visible}makeSidePanelSideState(e){return{flexGroups:[],outerDropZoneElement:this.makeDropZone(e,hm[e]*Infinity,0,e,!1)}}hasDroppablePanel(){return this.dragSource!==void 0}startDrag(e,t){setTimeout(()=>{this.dragSource===e&&(this.element.dataset.neuroglancerSidePanelDrag="true")},0),this.dragSource=e,t.stopPropagation(),t.dataTransfer.setData("neuroglancer-side-panel","")}endDrag(){delete this.element.dataset.neuroglancerSidePanelDrag,this.dragSource=void 0}makeDropZone(e,t,r,i,a=!1){let o=document.createElement("div");o.className="neuroglancer-side-panel-drop-zone";let l=10,c=as[i],d=fm[i];return o.style[os[d]]=`${l}px`,o.style[os[c]]="100%",a?(o.style.position="absolute",o.style[i]="50%",o.style[DI[i]]="-${size/2}px"):(o.style.position="relative",o.style[DI[s6[i]]]=`-${l}px`),o.addEventListener("dragenter",p=>{!this.hasDroppablePanel()||(o.classList.add(bl),p.preventDefault(),Qn(o,"drop",()=>document.createTextNode(`Drop side panel as new ${c}`)))}),o.addEventListener("dragleave",()=>{Xt(o,"drop"),o.classList.remove(bl)}),o.addEventListener("dragover",p=>{!this.hasDroppablePanel()||p.preventDefault()}),o.addEventListener("drop",p=>{let{dragSource:m}=this;if(m===void 0)return;Xt(o,"drop"),o.classList.remove(bl);let g=as[e];m.dropAsNewPanel({side:e,row:g==="column"?r:t,col:g==="row"?r:t}),this.dragSource=void 0,p.preventDefault(),p.stopPropagation()}),o}registerPanel(e){return this.registeredPanels.add(e),this.invalidateLayout(),e.location.locationChanged.add(this.invalidateLayout),()=>{this.unregisterPanel(e)}}unregisterPanel(e){var t;this.registeredPanels.delete(e),e.location.locationChanged.remove(this.invalidateLayout),(t=e.panel)==null||t.dispose(),this.invalidateLayout()}disposed(){for(let{panel:e}of this.registeredPanels)e==null||e.dispose();super.disposed()}render(){this.layoutNeedsUpdate=!1;let e={left:[],right:[],top:[],bottom:[]};for(let o of this.registeredPanels)e[o.location.value.side].push(o);let t=o=>this.renderSide(o,this.sides[o].flexGroups,e[o]),r=this;function*i(){yield r.sides.left.outerDropZoneElement,yield*t("left"),yield r.centerColumn,yield*t("right"),yield r.sides.right.outerDropZoneElement}Wn(this.element,i());function*a(){yield r.sides.top.outerDropZoneElement,yield*t("top"),yield r.center,yield*t("bottom"),yield r.sides.bottom.outerDropZoneElement}Wn(this.centerColumn,a())}makeCrossGutter(e,t){let r=document.createElement("div");r.style.position="relative";let i=fm[e];r.className=`neuroglancer-resize-gutter-${i==="row"?"horizontal":"vertical"}`,r.addEventListener("pointerdown",o=>{if("button"in o&&o.button!==0)return;o.preventDefault();let l=this.sides[e].flexGroups[t];if(l===void 0||!l.visible)return;let d=l.element.getBoundingClientRect()[os[i]],p=l.minSize,m=()=>{Qn(r,"drag",`Drag to resize, current ${os[i]} is ${l.crossSize}px`)};m(),sn(o,(g,v,b)=>{let x=i==="row"?v:b;d-=hm[e]*x,l.crossSize=Math.max(p,Math.round(d)),m(),this.invalidateLayout()},()=>{Xt(r,"drag")})});let a=this.makeDropZone(e,t-hm[e]*.5,0,e,!0);return r.appendChild(a),r}makeFlexGutter(e,t,r){let i=document.createElement("div");i.style.position="relative";let a=as[e];i.className=`neuroglancer-resize-gutter-${a==="row"?"horizontal":"vertical"}`,i.addEventListener("pointerdown",l=>{if("button"in l&&l.button!==0)return;l.preventDefault();let c=this.sides[e].flexGroups[t];if(c===void 0||!c.visible)return;let{cells:d}=c,p=d[r];if(p===void 0||!p.registeredPanel.location.visible)return;let m=r+1;for(;m<d.length&&!d[m].registeredPanel.location.visible;)++m;if(m===d.length)return;let g=d[m],v=()=>{Qn(i,"drag",`Drag to resize, current ${os[a]} ratio is ${p.registeredPanel.location.value.flex} : ${g.registeredPanel.location.value.flex}`)};v(),sn(l,b=>{let x=p.registeredPanel.panel,C=g.registeredPanel.panel;if(x===void 0||C===void 0)return;let T=x.element.getBoundingClientRect(),I=C.element.getBoundingClientRect(),P=Math.max(.1,Math.min(.9,a==="column"?(b.clientY-T.top)/(I.bottom-T.top):(b.clientX-T.left)/(I.right-T.left))),M=p.registeredPanel.location.value,D=g.registeredPanel.location.value,E=M.flex+D.flex;p.registeredPanel.location.value={...M,flex:Math.round(P*E*100)/100},g.registeredPanel.location.value={...D,flex:Math.round((1-P)*E*100)/100},v(),p.registeredPanel.location.locationChanged.dispatch(),g.registeredPanel.location.locationChanged.dispatch(),this.invalidateLayout()},()=>{Xt(i,"drag")})});let o=this.makeDropZone(e,t,r+.5,EI[as[e]],!0);return i.appendChild(o),i}renderSide(e,t,r){let i=kI[fm[e]],a=kI[as[e]];r.sort((c,d)=>{let p=c.location.value,m=d.location.value,g=p[a]-m[a];return g!==0?g:p[i]-m[i]});let o=this;function*l(){let c=0,d=r.length,p=0;for(;c<d;){let m=r[c].location.value[a],g=c,v=0,b=0;do{let I=r[g].location.value;if(I[a]!==m)break;I.visible&&(++v,b=Math.max(b,I.minSize)),++g}while(g<d);let x=v>0,C=t[p];if(C===void 0){let I=o.makeCrossGutter(e,p),P=document.createElement("div");P.className=`neuroglancer-side-panel-${as[e]}`,C=t[p]={element:P,gutterElement:I,cells:[],crossSize:-1,minSize:b,visible:x,beginDropZone:o.makeDropZone(e,p,-Infinity,EI[as[e]]),endDropZone:o.makeDropZone(e,p,Infinity,l6[as[e]])}}else C.visible=x,C.minSize=b,C.crossSize=Math.max(C.crossSize,b);function*T(){yield C.beginDropZone;let I=0;for(let P=c,M=0;P<g;++P,++M){let D=r[P],E=C.cells[M];E===void 0?E=C.cells[M]={registeredPanel:D,gutterElement:void 0}:E.registeredPanel=D;let V=E.registeredPanel.location.value;C.crossSize==-1&&(C.crossSize=Math.max(b,V.size)),(V[a]!==p||V[i]!==M||V.visible&&V.size!==C.crossSize)&&(E.registeredPanel.location.value={...V,[a]:p,[i]:M,size:V.visible?C.crossSize:V.size},E.registeredPanel.location.changed.dispatch());let O=V.visible&&o.visibility.visible,{panel:B}=D;if(!O){B!==void 0&&(B.dispose(),D.panel=void 0);continue}++I,B===void 0&&(B=D.panel=D.makePanel()),B.element.style.flex=v>1?`${V.flex}`:"1",yield B.element,I===v?E.gutterElement=void 0:(E.gutterElement===void 0&&(E.gutterElement=o.makeFlexGutter(e,p,M)),yield E.gutterElement)}yield C.endDropZone}Wn(C.element,T()),C.cells.length=g-c,x&&(C.element.style[os[fm[e]]]=`${C.crossSize}px`,hm[e]>0?(yield C.gutterElement,yield C.element):(yield C.element,yield C.gutterElement)),c=g,++p}t.length=p}return l()}};function wr(n,e="text/plain"){let t=!1,r=En(document,"copy",i=>{let{clipboardData:a}=i;a!==null&&(a.setData(e,n),t=!0),i.stopPropagation(),i.preventDefault()},!0);try{document.execCommand("copy")}finally{r()}return t}var wn=class extends j{constructor(e,t,r){super();this.target=e;this.eventMap=t;this.registerEventListener(e,"wheel",i=>{r!==void 0&&r(i),this.dispatch("wheel",i)}),this.registerEventListener(e,"click",i=>{r!==void 0&&r(i),this.dispatch(`click${i.button}`,i)}),this.registerEventListener(e,"dblclick",i=>{r!==void 0&&r(i),this.dispatch(`dblclick${i.button}`,i)}),this.registerEventListener(e,"mousedown",i=>{r!==void 0&&r(i);let a=i.button;a===2&&(i.buttons&3)==1&&(a=0),this.dispatch(`mousedown${a}`,i)}),this.registerEventListener(e,"mouseup",i=>{r!==void 0&&r(i),this.dispatch(`mouseup${i.button}`,i)})}dispatch(e,t){pm(e,t,t,this.eventMap)}};var er=class extends j{constructor(e,t){super();this.element=He({...t,onClick:()=>{e.value=!e.value}}),this.element.classList.add("neuroglancer-checkbox-icon"),this.element.classList.add(t.backgroundScheme==="dark"?"dark-background":"light-background");let r=()=>{let i=e.value;this.element.dataset.checked=i?"true":"false",this.element.title=(i?t.disableTitle:t.enableTitle)||""};this.registerDisposer(e.changed.add(r)),r()}};var PI='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="copyIconTitle"><rect width="12" height="14" x="8" y="7"></rect><polyline points="16 3 4 3 4 17"></polyline></svg>';function Tr(n={}){return He({svg:PI,...n})}function mm(n={}){return He({text:"\u2197",...n})}function wb(n){return n.closest(".neuroglancer-selection-details")}var Tb=class extends Fr{constructor(e,t,r,i){super(e,t.location);this.sidePanelManager=e;this.state=t;this.manager=r;this.selectedLayer=i;this.body=document.createElement("div");let{element:a,body:o}=this;a.classList.add("neuroglancer-selection-details"),this.registerDisposer(new wn(this.element,Hc()));let{titleBar:l}=this.addTitleBar({title:"Selection"}),c=He({svg:lm,title:"Previous selection",onClick:()=>{this.state.goBack()}}),d=He({svg:cm,title:"Next selection",onClick:()=>{this.state.goForward()}});l.appendChild(c),l.appendChild(d),l.appendChild(this.registerDisposer(new er(t.pin,{text:"\u{1F4CC}\uFE0E",enableTitle:"Pin selection",disableTitle:"Unpin selection"})).element),o.classList.add("neuroglancer-selection-details-body"),this.addBody(o),o.appendChild(this.registerDisposer(new Cn(t,(p,m,g)=>{if(!t.location.visible||(c.style.visibility=t.canGoBack()?"visible":"hidden",d.style.visibility=t.canGoForward()?"visible":"hidden",p===void 0))return;let{position:v}=p;if(v!==void 0){let b=document.createElement("div");b.classList.add("neuroglancer-selection-details-position");let x=Tr({title:"Copy position",onClick:()=>{wr(I.map(M=>Math.floor(M)).join(", "))}});b.appendChild(x);let{coordinateSpace:{rank:C,names:T},position:I}=p;for(let M=0;M<C;++M){let D=document.createElement("span");D.classList.add("neuroglancer-selection-details-position-dimension");let E=document.createElement("span");E.classList.add("neuroglancer-selection-details-position-dimension-name"),E.textContent=T[M];let V=document.createElement("span");V.classList.add("neuroglancer-selection-details-position-dimension-coordinate"),V.textContent=Math.floor(I[M]).toString(),D.appendChild(E),D.appendChild(V),b.appendChild(D)}let P=mm({title:"Move to position",onClick:()=>{this.manager.globalPosition.value=I}});b.appendChild(P),m.appendChild(b)}for(let b of p.layers){let{layer:x}=b;m.appendChild(g.registerDisposer(new Cn({value:void 0,changed:x.managedLayer.layerChanged},(C,T,I)=>{if(x.wasDisposed||!x.isReady)return;let P=document.createElement("div");if(P.classList.add("neuroglancer-selection-details-layer-body"),!x.displaySelectionState(b.state,P,I))return;let M=document.createElement("div");T.appendChild(M),M.classList.add("neuroglancer-selection-details-layer");let D=document.createElement("div");D.classList.add("neuroglancer-selection-details-layer-title"),D.textContent=x.managedLayer.name,D.addEventListener("click",()=>{this.selectedLayer.layer=x.managedLayer,this.selectedLayer.visible=!0}),D.title="Click to show layer side panel",M.appendChild(D),M.appendChild(P)})).element)}})).element)}close(){super.close(),this.state.value=void 0,this.state.pin.value=!0}};var II='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="filterIconTitle"><path d="M10 12.261L4.028 3.972h16L14 12.329V17l-4 3z"></path></svg>';function AI(n={}){return He({svg:II,...n})}var qi=class{constructor(e,t,r){this.key=e;this.value=t;this.label=r}toString(){let{key:e,value:t,label:r}=this,i;return t===void 0?i=`${e}`:i=`${e}\u2192${t}`,r===void 0?i:`${i} ${r}`}},Lb=class extends j{constructor(){super(...arguments);this.selectedSegment=new X;this.baseSelectedSegment=new X;this.hasSelectedSegment=!1;this.changed=new re}get value(){return this.hasSelectedSegment?this.selectedSegment:void 0}get baseValue(){return this.hasSelectedSegment?this.baseSelectedSegment:void 0}set(e,t=!1){let{selectedSegment:r,baseSelectedSegment:i}=this,a=0,o=0,l=0,c=0,d;if(e==null)d=!1;else if(typeof e=="number")a=l=e>>>0,o=c=e<0?4294967295:0,d=!0;else if(e instanceof qi){let p=e.value||e.key;a=p.low,o=p.high,l=e.key.low,c=e.key.high,d=!0}else e instanceof X?(a=l=e.low,o=c=e.high,d=!0):d=!1;t&&a===0&&o===0&&(d=!1),d?d&&(!this.hasSelectedSegment||r.low!==a||r.high!==o||i.low!==l||i.high!==c)&&(r.low=a,r.high=o,i.low=l,i.high=c,this.hasSelectedSegment=!0,this.changed.dispatch()):this.hasSelectedSegment&&(this.hasSelectedSegment=!1,this.changed.dispatch())}isSelected(e){return this.hasSelectedSegment&&X.equal(e,this.selectedSegment)}bindTo(e,t){this.registerDisposer(e.changed.add(()=>{let r=e.get(t),i;r!==void 0&&(i=r.value),this.set(i,t.displayState.segmentationGroupState.value.hideSegmentZero.value)}))}};function xl(n){n.useTemporarySegmentEquivalences.value=!1,n.useTemporaryVisibleSegments.value=!1,n.temporaryVisibleSegments.clear(),n.temporarySegmentEquivalences.clear()}function kb(n,e,t=!1){let r,i,a,o;if(typeof e=="number"?r=new X(e>>>0,e<0?4294967295:0):typeof e=="string"?r=X.parseString(e):r=t?e.clone():e,n==null)return r;let{segmentEquivalences:l,segmentPropertyMap:{value:c}}=n.segmentationGroupState.value;return l.size!==0?(i=l.get(r),X.equal(i,r)?a=void 0:a=i):i=r,o=c==null?void 0:c.getSegmentLabel(i),o===void 0&&a==null?r:new qi(r,a,o)}function _a(n,e){if(e instanceof qi)return e;let t=kb(n,e);return t instanceof X?new qi(t):t}function MI(n,e){let{length:t}=e;n.value<t&&(n.value=t)}function ss(n,e){return _r(t=>e.style.setProperty("--neuroglancer-segment-list-width",`${t}ch`),n.segmentationGroupState.value.maxIdLength)}var Eb=(()=>{let n=document.createElement("div");n.classList.add("neuroglancer-segment-list-entry");let e=document.createElement("div");e.classList.add("neuroglancer-segment-list-entry-sticky"),n.appendChild(e);let t=Tr({title:"Copy segment ID"});t.classList.add("neuroglancer-segment-list-entry-copy");let r=document.createElement("div");r.classList.add("neuroglancer-segment-list-entry-copy-container");let i=r.childElementCount;r.appendChild(t);let a=e.childElementCount;e.appendChild(r);let o=e.childElementCount,l=document.createElement("input");l.type="checkbox",l.title="Toggle segment visibility",l.classList.add("neuroglancer-segment-list-entry-visible-checkbox"),e.appendChild(l);let c=document.createElement("div");c.classList.add("neuroglancer-segment-list-entry-id-container");let d=e.childElementCount;e.appendChild(c);let p=document.createElement("div");p.classList.add("neuroglancer-segment-list-entry-id");let m=c.childElementCount;c.appendChild(p);let g=document.createElement("span");g.classList.add("neuroglancer-segment-list-entry-name");let v=n.childElementCount;n.appendChild(g);let b=AI({title:"Filter by label"});b.classList.add("neuroglancer-segment-list-entry-filter");let x=n.childElementCount;return n.appendChild(b),{template:n,copyContainerIndex:a,copyIndex:i,visibleIndex:o,idContainerIndex:d,idIndex:m,labelIndex:v,filterIndex:x,unmappedIdIndex:-1,unmappedCopyIndex:-1}})(),c6=(()=>{let n=Eb,e=n.template.cloneNode(!0),t=e.children[0],r=t.children[n.idContainerIndex],i=r.childElementCount,a=r.children[n.idIndex].cloneNode(!0);a.classList.add("neuroglancer-segment-list-entry-unmapped-id"),r.appendChild(a);let o=t.children[n.copyContainerIndex],l=o.childElementCount;return o.appendChild(o.children[n.copyIndex].cloneNode(!0)),{...n,template:e,unmappedIdIndex:i,unmappedCopyIndex:l}})();function u6(n){let e=Eb,t=e.template.cloneNode(!0),r=[];for(let i=0;i<n;++i){r.push(t.childElementCount);let a=document.createElement("div");a.classList.add("neuroglancer-segment-list-entry-extra-property"),a.style.width=`max(var(--neuroglancer-column-${i}-width), var(--neuroglancer-column-${i}-label-width))`,t.appendChild(a)}return{...e,template:t,numericalPropertyIndices:r}}var RI=new WeakMap;function d6(n){let e=p=>{let m=p.currentTarget,g=m.dataset.id,v=Yi;v.tryParseString(g),n.segmentSelectionState.set(v),wb(m)||n.selectSegment(v,!1)},t=p=>{let m=p.currentTarget,g=m.dataset.id,v=Yi;v.tryParseString(g),n.selectSegment(v,wb(m)?"toggle":!0)},r=()=>{n.segmentSelectionState.set(null)},i=p=>p.currentTarget.closest(".neuroglancer-segment-list-entry"),a=p=>{let m=i(p);wr(m.dataset.id),p.stopPropagation()},o=p=>{let m=i(p);wr(m.dataset.unmappedId),p.stopPropagation()},l=p=>{let g=i(p).dataset.id,v=Yi;v.tryParseString(g);let{visibleSegments:b}=n.segmentationGroupState.value;b.set(v,!b.has(v)),p.stopPropagation()},c=p=>{let g=i(p).dataset.id,v=Yi;v.tryParseString(g),n.filterBySegmentLabel(v),p.stopPropagation()},d=p=>{if(p.button!==2||p.ctrlKey||p.altKey||p.metaKey||p.shiftKey)return;let g=p.currentTarget.dataset.id,v=Yi;v.tryParseString(g),n.moveToSegment(v)};return(p,m)=>{let{children:g}=p,v=g[0].children;p.addEventListener("mousedown",d);let b=v[m.copyContainerIndex];m.unmappedCopyIndex!==-1&&b.children[m.unmappedCopyIndex].addEventListener("click",o),b.children[m.copyIndex].addEventListener("click",a),p.addEventListener("mouseenter",e),p.addEventListener("mouseleave",r),v[m.visibleIndex].addEventListener("click",l),g[m.filterIndex].addEventListener("click",c),p.addEventListener("action:select-position",t)}}var Cl=class{constructor(e,t){this.displayState=e;this.template=t;if(e!==void 0){let r=RI.get(e);r===void 0&&(r=d6(e),RI.set(e,r)),this.registerEventHandlers=r}}static make(e,t){return new Cl(e,t?c6:Eb)}get(e){let{displayState:t}=this;return this.getWithNormalizedId(_a(t,e))}getWithNormalizedId(e){var g,v;let{displayState:t}=this,{template:r}=this,i=r.template.cloneNode(!0),a=e.key,o=(g=e.value)!=null?g:a,l=o.toString();i.dataset.id=l;let{children:c}=i,d=c[0].children,p=d[r.idContainerIndex];p.children[r.idIndex].textContent=l;let{unmappedIdIndex:m}=r;if(t!==void 0?this.registerEventHandlers(i,r):d[r.visibleIndex].style.display="none",m!==-1){let b=p.children[m];if(X.equal(a,o)){b.style.display="none";let x=d[r.copyContainerIndex];x.children[r.unmappedCopyIndex].style.display="none"}else{let x=a.toString();i.dataset.unmappedId=x,b.textContent=x,t!==void 0&&MI(t.segmentationGroupState.value.maxIdLength,x)}}return c[r.labelIndex].textContent=(v=e.label)!=null?v:"",t!==void 0&&(this.updateWithId(i,o),MI(t.segmentationGroupState.value.maxIdLength,l)),i}update(e){let t=Yi,r=e.dataset.id;r!==void 0&&(t.parseString(r),this.updateWithId(e,t))}updateWithId(e,t){let{children:r}=e,i=r[0].children,{template:a}=this,{displayState:o}=this,{segmentSelectionState:l}=o,{visibleSegments:c}=o.segmentationGroupState.value;i[a.visibleIndex].checked=c.has(t),e.dataset.selected=(l.hasSelectedSegment&&X.equal(l.selectedSegment,t)).toString();let d=i[a.idContainerIndex];_I(d.children[a.idIndex],Ib(this.displayState,t));let{unmappedIdIndex:p}=a;if(p!==-1){let m,g;if(o.baseSegmentColoring.value&&(m=e.dataset.unmappedId)!==void 0){let v=Yi;v.parseString(m),g=Ib(this.displayState,v)}else g=Jf;_I(d.children[p],g)}}};function _I(n,e){n.style.backgroundColor=ub(e),n.style.color=fd(e)?"white":"black"}var Db=class extends Cl{constructor(e,t,r){var c;let i=e.segmentationGroupState.value.segmentPropertyMap.value,a=((c=i==null?void 0:i.numericalProperties)!=null?c:[]).filter(r),o=u6(a.length);super(e,o);this.parentElement=t,this.segmentPropertyMap=i,this.numericalProperties=a,(this.numericalPropertyWidths=new Array(this.numericalProperties.length)).fill(0)}getWithNormalizedId(e){var a,o,l;let t=super.getWithNormalizedId(e),{numericalProperties:r}=this,{numericalPropertyIndices:i}=this.template;if(i.length>0){let c=(l=(o=this.segmentPropertyMap)==null?void 0:o.getSegmentInlineIndex((a=e.value)!=null?a:e.key))!=null?l:-1;if(c!==-1){let{numericalPropertyWidths:d}=this;for(let p=0,m=i.length;p<m;++p){let g=r[p].values[c];if(!isNaN(g)){let v=g.toString(),b=v.length;b>d[p]&&(d[p]=b,this.parentElement.style.setProperty(`--neuroglancer-column-${p}-width`,`${b}ch`)),t.children[i[p]].textContent=v}}}}return t}makeHeaderLabel(e,t,r){let i=document.createElement("span");i.textContent=e,i.classList.add("neuroglancer-segment-list-header-label"),i.classList.add("neuroglancer-segment-list-header-label"),e==="label"&&(r.style.textAlign="left");let a=document.createElement("span");a.classList.add("neuroglancer-segment-list-header-label-sort"),i.appendChild(a),a.textContent="\u25B2";let o=IP(i).width;return this.parentElement.style.setProperty(t,`${o}px`),r.appendChild(i),{id:e,label:i,sortIcon:a}}getHeader(){let{template:e}=this,t=e.template.cloneNode(!0),{children:r}=t,i=r[0].children,a=i[e.copyContainerIndex];a.style.visibility="hidden",i[e.visibleIndex].style.visibility="hidden",r[e.filterIndex].style.visibility="hidden";let o=i[e.idContainerIndex],l=[this.makeHeaderLabel("id","--neuroglancer-id-column-label-width",o.children[e.idIndex]),this.makeHeaderLabel("label","--neuroglancer-label-column-label-width",r[e.labelIndex])],{numericalProperties:c}=this,{numericalPropertyIndices:d}=this.template;for(let p=0,m=d.length;p<m;++p){let g=c[p],v=this.makeHeaderLabel(g.id,`--neuroglancer-column-${p}-label-width`,t.children[d[p]]),{description:b}=g;b&&(v.label.title=b),l.push(v)}return{container:t,propertyLabels:l}}};function wl(n,e){return Cl.make(n!=null?n:void 0,!0).getWithNormalizedId(e)}function ls(n,e,t){e.registerDisposer(Ka((r,i)=>{_P(r,i,t)},n.segmentationGroupState)),e.registerDisposer(Ka((r,i)=>{r.registerDisposer(i.segmentColorHash.changed.add(t)),r.registerDisposer(i.segmentDefaultColor.changed.add(t))},n.segmentationColorGroupState)),e.registerDisposer(n.saturation.changed.add(t)),e.registerDisposer(n.segmentSelectionState.changed.add(t)),e.registerDisposer(n.baseSegmentColoring.changed.add(t)),e.registerDisposer(n.hoverHighlight.changed.add(t))}function Pb(n,e){let t=e.redrawNeeded.dispatch;ls(n,e,t),e.registerDisposer(Ka((r,i)=>{VP(r,i,t)},n.segmentationGroupState))}function p6(n,e){Pb(n,e),e.registerDisposer(n.objectAlpha.changed.add(e.redrawNeeded.dispatch))}function Zd(n,e){p6(n,e),e.registerDisposer(n.transform.changed.add(e.redrawNeeded.dispatch)),e.registerDisposer(n.renderScaleTarget.changed.add(e.redrawNeeded.dispatch)),e.registerDisposer(n.transparentPickEnabled.changed.add(e.redrawNeeded.dispatch))}var VI=rn.create(),Yi=new X;function Ib(n,e,t=VI){if(n==null)return t.fill(1),t;let r=n.segmentationColorGroupState.value,{segmentStatedColors:i}=r;if(i.size!==0&&r.segmentStatedColors.get(e,Yi))return t[0]=(Yi.low&255)/255,t[1]=((Yi.low&65280)>>>8)/255,t[2]=((Yi.low&16711680)>>>16)/255,t;let a=r.segmentDefaultColor.value;return a!==void 0?(t[0]=a[0],t[1]=a[1],t[2]=a[2],t):(r.segmentColorHash.compute(t,e),t)}function f6(n,e,t=1){let r=VI;r[3]=t,Ib(n,e,r);let i=n.saturation.value;n.hoverHighlight.value&&n.segmentSelectionState.isSelected(e)&&(i>.5?i=i-=.5:i+=.5);for(let a=0;a<3;++a)r[a]=r[a]*i+(1-i);return r[0]*=t,r[1]*=t,r[2]*=t,r}function Ab(n,e={}){for(let t of JS)e[t]=n[t].rpcId;return e}var h6=ba(ka),cs=class extends h6{constructor(e,t,r){super(r);this.chunkManager=e;this.displayState=t;let i=t.segmentationGroupState.value;for(let a of JS)this.registerDisposer(i[a].addRef())}initializeCounterpartWithChunkManager(e){let{displayState:t}=this;e.chunkManager=this.chunkManager.rpcId,Ab(t.segmentationGroupState.value,e),e.transform=this.registerDisposer(mt.makeFromExisting(this.chunkManager.rpc,this.displayState.transform)).rpcId,e.renderScaleTarget=this.registerDisposer(mt.makeFromExisting(this.chunkManager.rpc,this.displayState.renderScaleTarget)).rpcId,super.initializeCounterpart(this.chunkManager.rpc,e)}};function ep(n,e,t,r,i){let a=Math.min(1,n.objectAlpha.value),o=n.baseSegmentColoring.value;Ea(n.segmentationGroupState.value,(l,c)=>{let d=r==null?void 0:r.registerUint64(e,l),p=t?f6(n,o?l:c,a):void 0;i(l,p,d,c)})}var m6=ae.create(),Si=Dt.create(),OI=!1;function NI(n,e){e.vertexBuffer=Bt.fromData(n,e.meshData.vertexPositions,n.ARRAY_BUFFER,n.STATIC_DRAW),e.indexBuffer=Bt.fromData(n,e.meshData.indices,n.ELEMENT_ARRAY_BUFFER,n.STATIC_DRAW),e.normalBuffer=Bt.fromData(n,e.meshData.vertexNormals,n.ARRAY_BUFFER,n.STATIC_DRAW)}function BI(n){n.vertexBuffer.dispose(),n.indexBuffer.dispose(),n.normalBuffer.dispose()}var g6=`
highp vec3 decodeNormalOctahedronSnorm8(highp vec2 e) {
  vec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));
  if (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * vec2(v.x > 0.0 ? 1.0 : -1.0, v.y > 0.0 ? 1.0 : -1.0);
  return normalize(v);
}
`;function UI(n){return{defineShader:e=>{e.addAttribute("highp vec3","aVertexPosition"),e.addVertexCode("highp vec3 getVertexPosition() { return aVertexPosition; }")},bind(e,t,r){r.vertexBuffer.bindToVertexAttrib(t.attribute("aVertexPosition"),3,n,!0)},endLayer:(e,t)=>{e.disableVertexAttribArray(t.attribute("aVertexPosition"))}}}var y6={[gi.float32]:UI(WebGL2RenderingContext.FLOAT),[gi.uint16]:UI(WebGL2RenderingContext.UNSIGNED_SHORT),[gi.uint10]:{defineShader:n=>{n.addAttribute("highp uint","aVertexPosition"),n.addVertexCode(`
highp vec3 getVertexPosition() {
  return vec3(float(aVertexPosition & 1023u),
              float((aVertexPosition >> 10) & 1023u),
              float((aVertexPosition >> 20) & 1023u)) / 1023.0;
}
`)},bind(n,e,t){t.vertexBuffer.bindToVertexAttribI(e.attribute("aVertexPosition"),1,WebGL2RenderingContext.UNSIGNED_INT)},endLayer:(n,e)=>{n.disableVertexAttribArray(e.attribute("aVertexPosition"))}}},Mb=class{constructor(e,t){this.fragmentRelativeVertices=e;this.vertexPositionFormat=t;this.tempLightVec=new Float32Array(4);this.vertexPositionHandler=y6[this.vertexPositionFormat]}beginLayer(e,t,r,i){let{lightDirection:a,ambientLighting:o,directionalLighting:l}=r,c=this.tempLightVec;K.scale(c,a,l),c[3]=o,e.uniform4fv(t.uniform("uLightDirection"),c);let d=i.silhouetteRendering.value;d>0&&e.uniform1f(t.uniform("uSilhouettePower"),d)}setColor(e,t,r){e.uniform4fv(t.uniform("uColor"),r)}setPickID(e,t,r){e.uniform1ui(t.uniform("uPickID"),r)}beginModel(e,t,r,i){let{projectionParameters:a}=r;e.uniformMatrix4fv(t.uniform("uModelViewProjection"),!1,ae.multiply(m6,a.viewProjectionMat,i)),Hs(Si,i),Iv(Si,Si,a.displayDimensionRenderInfo.canonicalVoxelFactors),Dt.invert(Si,Si),Dt.transpose(Si,Si),e.uniformMatrix3fv(t.uniform("uNormalMatrix"),!1,Si)}drawFragmentHelper(e,t,r,i,a){this.vertexPositionHandler.bind(e,t,r);let{meshData:o}=r;r.normalBuffer.bindToVertexAttrib(t.attribute("aVertexNormal"),2,WebGL2RenderingContext.BYTE,!0),r.indexBuffer.bind();let{indices:l}=o;e.drawElements(o.strips?WebGL2RenderingContext.TRIANGLE_STRIP:WebGL2RenderingContext.TRIANGLES,a-i,l.BYTES_PER_ELEMENT===2?WebGL2RenderingContext.UNSIGNED_SHORT:WebGL2RenderingContext.UNSIGNED_INT,i*l.BYTES_PER_ELEMENT)}drawFragment(e,t,r){let{meshData:i}=r,{indices:a}=i;this.drawFragmentHelper(e,t,r,0,a.length)}drawMultiscaleFragment(e,t,r,i,a){let o=r.meshData.subChunkOffsets[i],l=r.meshData.subChunkOffsets[a];this.drawFragmentHelper(e,t,r,o,l)}endLayer(e,t){this.vertexPositionHandler.endLayer(e,t),e.disableVertexAttribArray(t.attribute("aVertexNormal"))}makeGetter(e){let t=e.registerDisposer(At(r=>r>0,[e.displayState.silhouetteRendering]));return ti(e,e.gl,{memoizeKey:`mesh/MeshShaderManager/${this.fragmentRelativeVertices}/${this.vertexPositionFormat}`,parameters:t,defineShader:(r,i)=>{this.vertexPositionHandler.defineShader(r),r.addAttribute("highp vec2","aVertexNormal"),r.addVarying("highp vec4","vColor"),r.addUniform("highp vec4","uLightDirection"),r.addUniform("highp vec4","uColor"),r.addUniform("highp mat3","uNormalMatrix"),r.addUniform("highp mat4","uModelViewProjection"),r.addUniform("highp uint","uPickID"),i&&r.addUniform("highp float","uSilhouettePower"),this.fragmentRelativeVertices&&(r.addUniform("highp vec3","uFragmentOrigin"),r.addUniform("highp vec3","uFragmentShape")),r.addVertexCode(g6);let a="";this.fragmentRelativeVertices?a+=`
highp vec3 vertexPosition = uFragmentOrigin + uFragmentShape * getVertexPosition();
highp vec3 normalMultiplier = 1.0 / uFragmentShape;
`:a+=`
highp vec3 vertexPosition = getVertexPosition();
highp vec3 normalMultiplier = vec3(1.0, 1.0, 1.0);
`,a+=`
gl_Position = uModelViewProjection * vec4(vertexPosition, 1.0);
vec3 origNormal = decodeNormalOctahedronSnorm8(aVertexNormal);
vec3 normal = normalize(uNormalMatrix * (normalMultiplier * origNormal));
float absCosAngle = abs(dot(normal, uLightDirection.xyz));
float lightingFactor = absCosAngle + uLightDirection.w;
vColor = vec4(lightingFactor * uColor.rgb, uColor.a);
`,i&&(a+=`
vColor *= pow(1.0 - absCosAngle, uSilhouettePower);
`),r.setVertexMain(a),r.setFragmentMain("emit(vColor, uPickID);")}})}},gm=class extends Ur{constructor(e,t,r){super();this.chunkManager=e;this.source=t;this.displayState=r;this.meshShaderManager=new Mb(!1,gi.float32);this.getShader=this.meshShaderManager.makeGetter(this);Zd(r,this),this.registerDisposer(r.silhouetteRendering.changed.add(this.redrawNeeded.dispatch));let i=this.backend=this.registerDisposer(new cs(e,r,this.layerChunkProgressInfo));i.RPC_TYPE_ID=tI,i.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()}),i.visibility.add(this.visibility),this.registerDisposer(r.renderScaleHistogram.visibility.add(this.visibility))}get isTransparent(){let{displayState:e}=this;return e.objectAlpha.value<1||e.silhouetteRendering.value>0}get transparentPickEnabled(){return this.displayState.transparentPickEnabled.value}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;let{gl:r,displayState:i,meshShaderManager:a}=this;if(i.objectAlpha.value<=0)return;let o=ns(i.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(o===void 0)return;let{shader:l}=this.getShader(e.emitter);if(l===null)return;l.bind(),a.beginLayer(r,l,e,this.displayState),a.beginModel(r,l,e,o);let c=this.source.chunks,d=0,p=0,{renderScaleHistogram:m}=this.displayState,g=this.source.fragmentSource.chunks;ep(i,this,e.emitColor,e.emitPickID?e.pickIDs:void 0,(v,b,x)=>{let C=Nr(v),T=c.get(C);if(++d,T!==void 0){++p,e.emitColor&&a.setColor(r,l,b),e.emitPickID&&a.setPickID(r,l,x),d+=T.fragmentIds.length;for(let I of T.fragmentIds){let{key:P}=this.source.getFragmentKey(C,I),M=g.get(P);M!==void 0&&M.state===Ze.GPU_MEMORY&&(a.drawFragment(r,l,M),++p)}}}),e.emitColor&&(m.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),m.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,p,d-p)),a.endLayer(r,l)}isReady(){let{displayState:e,source:t}=this,r=!0,i=t.fragmentSource.chunks;return Ea(e.segmentationGroupState.value,a=>{let o=Nr(a),l=t.chunks.get(o);if(l===void 0){r=!1;return}for(let c of l.fragmentIds){let{key:d}=this.source.getFragmentKey(o,c),p=i.get(d);if(p===void 0||p.state!==Ze.GPU_MEMORY){r=!1;return}}}),r}},FI=class extends br{constructor(e,t){super(e);this.fragmentIds=t.fragmentIds}},GI=class extends br{constructor(e,t){super(e);this.meshData=t}copyToGPU(e){super.copyToGPU(e),NI(e,this)}freeGPUMemory(e){super.freeGPUMemory(e),BI(this)}},tr=class extends Gn{constructor(e,t){super(e,t);this.fragmentSource=this.registerDisposer(new ym(this.chunkManager,this))}initializeCounterpart(e,t){this.fragmentSource.initializeCounterpart(this.chunkManager.rpc,{}),t.fragmentSource=this.fragmentSource.addCounterpartRef(),super.initializeCounterpart(e,t)}getChunk(e){return new FI(this,e)}getFragmentKey(e,t){return{key:`${e}/${t}`,fragmentId:t}}},ym=class extends Gn{constructor(e,t){super(e);this.meshSource=t}get key(){return this.meshSource.key}getChunk(e){return new GI(this,e)}};ym=kt([bn(rI)],ym);function WI(n,e,t,r){let i=n.get(ob(e,t,r));return i!==void 0&&i.state===Ze.GPU_MEMORY}var tp=class extends Ur{constructor(e,t,r){super();this.chunkManager=e;this.source=t;this.displayState=r;this.meshShaderManager=new Mb(this.source.format.fragmentRelativeVertices,this.source.format.vertexPositionFormat);this.getShader=this.meshShaderManager.makeGetter(this);Zd(r,this),this.registerDisposer(r.silhouetteRendering.changed.add(this.redrawNeeded.dispatch));let i=this.backend=this.registerDisposer(new cs(e,r,this.layerChunkProgressInfo));i.RPC_TYPE_ID=nI,i.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()}),i.visibility.add(this.visibility),this.registerDisposer(r.renderScaleHistogram.visibility.add(this.visibility))}get isTransparent(){let{displayState:e}=this;return e.objectAlpha.value<1||e.silhouetteRendering.value>0}get transparentPickEnabled(){return this.displayState.transparentPickEnabled.value}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;let{gl:r,displayState:i,meshShaderManager:a}=this;if(i.objectAlpha.value<=0)return;let o=ns(i.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(o===void 0)return;let{shader:l}=this.getShader(e.emitter);if(l===null)return;l.bind(),a.beginLayer(r,l,e,this.displayState);let{renderScaleHistogram:c}=this.displayState;e.emitColor&&c.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),Hs(Si,o),Iv(Si,Si,e.projectionParameters.displayDimensionRenderInfo.voxelPhysicalScales);let d=Math.pow(Math.abs(Dt.determinant(Si)),1/3),{chunks:p}=this.source,m=this.source.fragmentSource.chunks,{projectionParameters:g}=e,v=ae.multiply(ae.create(),g.viewProjectionMat,o),b=$s(new Float32Array(24),v),x=this.displayState.renderScaleTarget.value,{fragmentRelativeVertices:C}=this.source.format;a.beginModel(r,l,e,o);let T=0,I=0;ep(i,this,e.emitColor,e.emitPickID?e.pickIDs:void 0,(P,M,D)=>{let E=Nr(P),V=p.get(E);if(++T,V===void 0)return;++I;let{manifest:O}=V,{octree:B,chunkShape:z,chunkGridSpatialOrigin:_,vertexOffsets:U}=O;if(OI)try{oI(B)}catch(N){console.log(`invalid octree for object=${P}: ${N.message}`)}e.emitColor&&a.setColor(r,l,M),e.emitPickID&&a.setPickID(r,l,D),ab(O,v,b,x,g.width,g.height,(N,J,ie)=>{let pe=WI(m,E,N,J);return e.emitColor&&c.add(O.lodScales[N]*d,ie,pe?1:0,pe?0:1),pe},(N,J,ie,pe)=>{let me=ob(E,N,J),Pe=m.get(me),le=B[5*J],we=B[5*J+1],Re=B[5*J+2],Ue=1<<N;if(C&&(r.uniform3f(l.uniform("uFragmentOrigin"),_[0]+le*z[0]*Ue+U[N*3+0],_[1]+we*z[1]*Ue+U[N*3+1],_[2]+Re*z[2]*Ue+U[N*3+2]),r.uniform3f(l.uniform("uFragmentShape"),z[0]*Ue,z[1]*Ue,z[2]*Ue)),OI){let et=`lod=${N}, chunkIndex=${J}, subChunkBegin=${ie}, subChunkEnd=${pe}, uFragmentOrigin=${[_[0]+le*z[0]*Ue+U[N*3+0],_[1]+we*z[1]*Ue+U[N*3+1],_[2]+Re*z[2]*Ue+U[N*3+2]]}, uFragmentShape=${[z[0]*Ue,z[1]*Ue,z[2]*Ue]}`,ye=e.pickIDs.registerUint64(this,P,1,et);e.emitPickID&&a.setPickID(r,l,ye)}a.drawMultiscaleFragment(r,l,Pe,ie,pe)})}),c.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,I,T-I),a.endLayer(r,l)}isReady(e,t){let{displayState:r}=this;if(r.objectAlpha.value<=0)return!0;let i=ns(r.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(i===void 0)return!1;let{chunks:a}=this.source,o=this.source.fragmentSource.chunks,{projectionParameters:l}=e,c=ae.multiply(ae.create(),l.viewProjectionMat,i),d=$s(new Float32Array(24),c),p=this.displayState.renderScaleTarget.value,m=!0;return Ea(r.segmentationGroupState.value,g=>{if(!m)return;let v=Nr(g),b=a.get(v);if(b===void 0){m=!1;return}let{manifest:x}=b;ab(x,c,d,p,l.width,l.height,(C,T)=>(m=m&&WI(o,v,C,T),m),()=>{})}),m}getObjectPosition(e){let t=this.displayState.transform.value;if(t.error!==void 0)return;let r=this.source.chunks.get(Nr(e));if(r===void 0)return;let{manifest:i}=r,{clipLowerBound:a,clipUpperBound:o}=i,{rank:l}=t,c=new Float32Array(l);for(let p=0;p<3;++p)c[p]=(a[p]+o[p])/2;let d=new Float32Array(l);return Zr(d,t.modelToRenderLayerTransform,l+1,c,l),d}},zI=class extends br{constructor(e,t){super(e);this.manifest=t.manifest}},HI=class extends br{constructor(e,t){super(e);this.meshData=t}copyToGPU(e){super.copyToGPU(e),NI(e,this)}freeGPUMemory(e){super.freeGPUMemory(e),BI(this)}},mo=class extends Gn{constructor(e,t){super(e,t);this.fragmentSource=this.registerDisposer(new vm(this.chunkManager,this));this.format=t.format}static encodeOptions(e){return{format:e.format,...super.encodeOptions(e)}}initializeCounterpart(e,t){this.fragmentSource.initializeCounterpart(this.chunkManager.rpc,{}),t.fragmentSource=this.fragmentSource.addCounterpartRef(),t.format=this.format,super.initializeCounterpart(e,t)}getChunk(e){return new zI(this,e)}},vm=class extends Gn{constructor(e,t){super(e);this.meshSource=t}get key(){return this.meshSource.key}getChunk(e){return new HI(this,e)}};vm=kt([bn(iI)],vm);var $I="skeleton/SkeletonLayer";function ln(n,e,t){oe(n,e,r=>t.restoreState(r))}var nr=class extends j{constructor(){super(...arguments);this.children=new Map;this.changed=new re}add(e,t){let{children:r}=this;if(r.has(e))throw new Error(`Key ${JSON.stringify(e)} already registered.`);return this.children.set(e,t),t.changed.add(this.changed.dispatch),this.changed.dispatch(),()=>{this.remove(e)}}remove(e){let{children:t}=this;if(t.has(e))throw new Error(`Key ${JSON.stringify(e)} not registered.`);let r=t.get(e);this.children.delete(e),r.changed.remove(this.changed.dispatch),this.changed.dispatch()}disposed(){let{changed:e}=this;for(let t of this.children.values())t.changed.remove(e.dispatch);this.children=void 0,super.disposed()}toJSON(){console.log(this.children);let e=this.baseJSON();for(let[t,r]of this.children)e[t]=r.toJSON();return e}baseJSON(){return{}}reset(){for(let e of this.children.values())e.reset()}restoreState(e){Z(e);for(let[t,r]of this.children)try{if(e.hasOwnProperty(t)){let i=e[t];if(i===void 0)continue;r.restoreState(i)}}catch(i){throw new Error(`Error restoring property ${JSON.stringify(t)}: ${i.message}`)}}};var jI=new WeakMap;function Tl(n){let e=jI.get(n),t=n.changed.count;if(e!==void 0&&e.generation===t)return e;let r;if(n instanceof nr){r=n.baseJSON();for(let[i,a]of n.children)r[i]=Tl(a).value}else r=n.toJSON();return e===void 0?(e={generation:t,value:r},jI.set(n,e)):(e.generation=t,e.value=r),e}var us=class{constructor(e,t,r=t){this.enumType=e;this.value_=t;this.defaultValue=r;this.changed=new re}set value(e){this.value_!==e&&(this.value_=e,this.changed.dispatch())}get value(){return this.value_}reset(){this.value=this.defaultValue}restoreState(e){this.value=Mt(e,this.enumType)}toJSON(){if(this.value_!==this.defaultValue)return this.enumType[this.value_].toLowerCase()}};var np=6;var Jc=`
vec2 getQuadVertexPosition(vec2 lower, vec2 upper) {
  const vec2 coeffs[] = vec2[](
    vec2(0.0, 0.0),
    vec2(0.0, 1.0),
    vec2(1.0, 1.0),
    vec2(1.0, 1.0),
    vec2(1.0, 0.0),
    vec2(0.0, 0.0)
  );
  int v = gl_VertexID % 6;
  return mix(lower, upper, coeffs[v]);
}
`;function qc(n,e,t){n.drawArraysInstanced(WebGL2RenderingContext.TRIANGLES,0,np*e,t)}var Sm=np;function ds(n,e){n.addVertexCode(Jc),n.addUniform("highp vec3","uCircleParams"),n.addVarying("highp vec4","vCircleCoord"),n.addVertexCode(`
void emitCircle(vec4 position, float diameter, float borderWidth) {
  gl_Position = position;
  float totalDiameter = diameter + 2.0 * (borderWidth + uCircleParams.z);
  if (diameter == 0.0) totalDiameter = 0.0;
  vec2 circleCornerOffset = getQuadVertexPosition(vec2(-1.0, -1.0), vec2(1.0, 1.0));
  gl_Position.xy += circleCornerOffset * uCircleParams.xy * gl_Position.w * totalDiameter;
  vCircleCoord.xy = circleCornerOffset;
  if (borderWidth == 0.0) {
    vCircleCoord.z = totalDiameter;
    vCircleCoord.w = 1e-6;
  } else {
    vCircleCoord.z = diameter / totalDiameter;
    vCircleCoord.w = uCircleParams.z / totalDiameter;
  }
}
`),e?n.addFragmentCode(`
float getCircleAlphaMultiplier() {
  return 1.0 - 2.0 * abs(0.5 - gl_FragCoord.z);
}
`):n.addFragmentCode(`
float getCircleAlphaMultiplier() {
  return 1.0;
}
`),n.addFragmentCode(`
vec4 getCircleColor(vec4 interiorColor, vec4 borderColor) {
  float radius = length(vCircleCoord.xy);
  if (radius > 1.0) {
    discard;
  }

  float borderColorFraction = clamp((radius - vCircleCoord.z) / vCircleCoord.w, 0.0, 1.0);
  float feather = clamp((1.0 - radius) / vCircleCoord.w, 0.0, 1.0);
  vec4 color = mix(interiorColor, borderColor, borderColorFraction);

  return vec4(color.rgb, color.a * feather * getCircleAlphaMultiplier());
}
`)}function ps(n,e,t){let{gl:r}=n;r.uniform3f(n.uniform("uCircleParams"),1/e.width,1/e.height,Math.max(1e-6,t.featherWidthInPixels))}function fs(n,e,t){qc(n,e,t)}var bi=np;function rr(n,e=!1){n.addVertexCode(Jc),n.addUniform("highp vec3","uLineParams"),n.addVarying("highp float","vLineCoord"),n.addVarying("highp float","vLineFeatherFraction"),e&&(n.addVarying("highp float","vEndpointFraction"),n.addVarying("highp float","vLineCoordT"),n.addVarying("highp float","vLineBorderStartFraction")),n.addVertexCode(GD),n.addVertexCode(`
vec2 getLineOffset() { return getQuadVertexPosition(vec2(0.0, -1.0), vec2(1.0, 1.0)); }
float getLineEndpointCoefficient() { return getLineOffset().x; }
uint getLineEndpointIndex() { return uint(getLineEndpointCoefficient()); }
void emitLine(vec4 vertexAClip, vec4 vertexBClip, float lineWidthInPixels
              ${e?", float borderWidth":""}) {
  if (!clipLineToDepthRange(vertexAClip, vertexBClip)) {
    gl_Position = vec4(2.0, 2.0, 2.0, 1.0);
    return;
  }
  vec3 vertexADevice = vertexAClip.xyz / vertexAClip.w;
  vec3 vertexBDevice = vertexBClip.xyz / vertexBClip.w;

  vec2 lineDirectionUnnormalized = vertexBDevice.xy - vertexADevice.xy;
  vec2 lineDirection;
  float linePixelLength = length(lineDirectionUnnormalized / uLineParams.xy * 0.5);

  if (linePixelLength < 1e-3) {
    lineDirection = vec2(1.0, 0.0);
    vertexADevice.z = vertexBDevice.z = 0.0;
  } else {
    lineDirection = normalize(lineDirectionUnnormalized);
  }
  vec2 lineNormal = normalize(vec2(lineDirection.y, -lineDirection.x) / uLineParams.yx * uLineParams.xy);

  vec2 lineOffset = getLineOffset();
  gl_Position = vec4(mix(vertexADevice, vertexBDevice, lineOffset.x), 1.0);
  float totalLineWidth = lineWidthInPixels + 2.0 * uLineParams.z ${e?" + 2.0 * borderWidth":""};
  if (lineWidthInPixels == 0.0) totalLineWidth = 0.0;
  vLineFeatherFraction = max(1e-6, uLineParams.z) / totalLineWidth;
  gl_Position.xy += (lineOffset.y * lineNormal
                     ${e?"+ lineDirection * (2.0 * lineOffset.x - 1.0)":""})
                  * totalLineWidth * uLineParams.xy;
  vLineCoord = lineOffset.y;
  ${e?"vEndpointFraction = totalLineWidth / (linePixelLength + totalLineWidth * 2.0);":""}
  ${e?"vLineCoordT = lineOffset.x; vLineBorderStartFraction = lineWidthInPixels / totalLineWidth;":""}
}
void emitLine(mat4 projection, vec3 vertexA, vec3 vertexB, float lineWidthInPixels
              ${e?", float borderWidth":""}) {
  emitLine(projection * vec4(vertexA, 1.0), projection * vec4(vertexB, 1.0),
           lineWidthInPixels
           ${e?", borderWidth":""});
}
`),e&&n.addFragmentCode(`
vec4 getRoundedLineColor(vec4 interiorColor, vec4 borderColor) {
  float radius;
  if (vLineCoordT < vEndpointFraction || vLineCoordT > 1.0 - vEndpointFraction) {
    radius = length(vec2(1.0 - min(vLineCoordT, 1.0 - vLineCoordT) / vEndpointFraction,
                         vLineCoord));
    if (radius > 1.0) {
      discard;
    }
  } else {
    radius = abs(vLineCoord);
  }
  float borderColorFraction = clamp((radius - vLineBorderStartFraction) / vLineFeatherFraction, 0.0, 1.0);
  float feather = clamp((1.0 - radius) / vLineFeatherFraction, 0.0, 1.0);
  vec4 color = mix(interiorColor, borderColor, borderColorFraction);
  return vec4(color.rgb, color.a * feather);
}
`),n.addFragmentCode(`
float getLineAlpha() {
  return clamp((1.0 - abs(vLineCoord)) / vLineFeatherFraction, 0.0, 1.0);
}
`)}function ir(n,e,t){qc(n,e,t)}function ar(n,e,t){let{gl:r}=n;r.uniform3f(n.uniform("uLineParams"),1/e.width,1/e.height,t)}function Lr(n){n.addAttribute("int","aDummyVertexId",0),n.addVertexCode(`
int getVertexId () {
  return aDummyVertexId + gl_VertexID;
}
#define gl_VertexID (getVertexId())
`)}var zn=class extends j{constructor(e){super();this.buffer=new Bt(e),this.size=0}disposed(){this.buffer.dispose()}enable(e=256){let{buffer:t}=this,{gl:r}=t;t.bind(),e>this.size&&(this.size=e,r.bufferData(WebGL2RenderingContext.ARRAY_BUFFER,new Int32Array(e),WebGL2RenderingContext.STATIC_DRAW)),r.vertexAttribIPointer(0,1,WebGL2RenderingContext.INT,0,0),r.vertexAttribDivisor(0,0),r.enableVertexAttribArray(0)}disable(){let{gl:e}=this.buffer;e.disableVertexAttribArray(0)}static get(e){return e.memoize.get("VertexIdHelper",()=>new zn(e))}};var v6=ae.create(),JI=`void main() {
  emitDefault();
}
`,rp=[],S6=yi(new Ji,G.FLOAT32,3),Rb=class extends j{constructor(e,t){super();this.base=e;this.targetIsSliceView=t;this.textureAccessHelper=new ho("vertexData");this.vertexIdHelper=this.registerDisposer(zn.get(this.gl));this.edgeShaderGetter=ti(this,this.gl,{memoizeKey:{type:"skeleton/SkeletonShaderManager/edge",vertexAttributes:this.vertexAttributes},fallbackParameters:this.base.fallbackShaderParameters,parameters:this.base.displayState.skeletonRenderingOptions.shaderControlState.builderState,shaderError:this.base.displayState.shaderError,defineShader:(e,t)=>{if(t.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");this.defineCommonShader(e),this.defineAttributeAccess(e),rr(e),e.addAttribute("highp uvec2","aVertexIndex"),e.addUniform("highp float","uLineWidth");let r=`
highp vec3 vertexA = readAttribute0(aVertexIndex.x);
highp vec3 vertexB = readAttribute0(aVertexIndex.y);
emitLine(uProjection, vertexA, vertexB, uLineWidth);
highp uint lineEndpointIndex = getLineEndpointIndex();
highp uint vertexIndex = aVertexIndex.x * lineEndpointIndex + aVertexIndex.y * (1u - lineEndpointIndex);
`;e.addFragmentCode(`
vec4 segmentColor() {
  return uColor;
}
void emitRGB(vec3 color) {
  emit(vec4(color * uColor.a, uColor.a * getLineAlpha() * ${this.getCrossSectionFadeFactor()}), uPickID);
}
void emitDefault() {
  emit(vec4(uColor.rgb, uColor.a * getLineAlpha() * ${this.getCrossSectionFadeFactor()}), uPickID);
}
`),e.addFragmentCode(Bi);let{vertexAttributes:i}=this,a=i.length;for(let o=1;o<a;++o){let l=i[o];e.addVarying(`highp ${l.glslDataType}`,`vCustom${o}`),r+=`vCustom${o} = readAttribute${o}(vertexIndex);
`,e.addFragmentCode(`#define ${l.name} vCustom${o}
`)}e.setVertexMain(r),Gi(t,e),e.setFragmentMainFunction(Ui(t.parseResult.code))}});this.nodeShaderGetter=ti(this,this.gl,{memoizeKey:{type:"skeleton/SkeletonShaderManager/node",vertexAttributes:this.vertexAttributes},fallbackParameters:this.base.fallbackShaderParameters,parameters:this.base.displayState.skeletonRenderingOptions.shaderControlState.builderState,shaderError:this.base.displayState.shaderError,defineShader:(e,t)=>{if(t.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");this.defineCommonShader(e),this.defineAttributeAccess(e),ds(e,this.targetIsSliceView),e.addUniform("highp float","uNodeDiameter");let r=`
highp uint vertexIndex = uint(gl_InstanceID);
highp vec3 vertexPosition = readAttribute0(vertexIndex);
emitCircle(uProjection * vec4(vertexPosition, 1.0), uNodeDiameter, 0.0);
`;e.addFragmentCode(`
vec4 segmentColor() {
  return uColor;
}
void emitRGBA(vec4 color) {
  vec4 borderColor = color;
  emit(getCircleColor(color, borderColor), uPickID);
}
void emitRGB(vec3 color) {
  emitRGBA(vec4(color, 1.0));
}
void emitDefault() {
  emitRGBA(uColor);
}
`),e.addFragmentCode(Bi);let{vertexAttributes:i}=this,a=i.length;for(let o=1;o<a;++o){let l=i[o];e.addVarying(`highp ${l.glslDataType}`,`vCustom${o}`),r+=`vCustom${o} = readAttribute${o}(vertexIndex);
`,e.addFragmentCode(`#define ${l.name} vCustom${o}
`)}e.setVertexMain(r),Gi(t,e),e.setFragmentMainFunction(Ui(t.parseResult.code))}})}get vertexAttributes(){return this.base.vertexAttributes}defineCommonShader(e){Lr(e),e.addUniform("highp vec4","uColor"),e.addUniform("highp mat4","uProjection"),e.addUniform("highp uint","uPickID")}get gl(){return this.base.gl}defineAttributeAccess(e){let{textureAccessHelper:t}=this;t.defineShader(e);let r=this.vertexAttributes.length;for(let i=rp.length;i<r;++i)rp[i]=Symbol(`SkeletonShader.vertexAttributeTextureUnit${i}`);this.vertexAttributes.forEach((i,a)=>{e.addTextureSampler(`${zc(i.dataType)}sampler2D`,`uVertexAttributeSampler${a}`,rp[a]),e.addVertexCode(t.getAccessor(`readAttribute${a}`,`uVertexAttributeSampler${a}`,i.dataType,i.numComponents))})}getCrossSectionFadeFactor(){return this.targetIsSliceView?"(clamp(1.0 - 2.0 * abs(0.5 - gl_FragCoord.z), 0.0, 1.0))":"(1.0)"}beginLayer(e,t,r,i){let{viewProjectionMat:a}=r.projectionParameters,o=ae.multiply(v6,a,i);e.uniformMatrix4fv(t.uniform("uProjection"),!1,o),this.vertexIdHelper.enable()}setColor(e,t,r){e.uniform4fv(t.uniform("uColor"),r)}setPickID(e,t,r){e.uniform1ui(t.uniform("uPickID"),r)}drawSkeleton(e,t,r,i,a){let{vertexAttributes:o}=this,l=o.length,{vertexAttributeTextures:c}=i;for(let d=0;d<l;++d){let p=WebGL2RenderingContext.TEXTURE0+t.textureUnit(rp[d]);e.activeTexture(p),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,c[d])}{t.bind();let d=t.attribute("aVertexIndex");i.indexBuffer.bindToVertexAttribI(d,2,WebGL2RenderingContext.UNSIGNED_INT),e.vertexAttribDivisor(d,1),ar(t,a,this.targetIsSliceView?1:0),ir(e,1,i.numIndices/2),e.vertexAttribDivisor(d,0),e.disableVertexAttribArray(d)}r!==null&&(r.bind(),ps(r,a,{featherWidthInPixels:this.targetIsSliceView?1:0}),fs(r.gl,2,i.numVertices))}endLayer(e,t){let{vertexAttributes:r}=this,i=r.length;for(let a=0;a<i;++a){let o=t.textureUnit(rp[a])+WebGL2RenderingContext.TEXTURE0;e.activeTexture(o),e.bindTexture(e.TEXTURE_2D,null)}this.vertexIdHelper.disable()}},Yc;(function(t){t[t.LINES=0]="LINES",t[t.LINES_AND_POINTS=1]="LINES_AND_POINTS"})(Yc||(Yc={}));var _b=class extends us{constructor(e,t=e){super(Yc,e,t)}},Vb=class extends Le{constructor(e,t=e){super(e,it,t)}},Ob=class{constructor(){this.compound=new nr;this.shader=Yo(JI);this.shaderControlState=new co(this.shader);this.params2d={mode:new _b(1),lineWidth:new Vb(2)};this.params3d={mode:new _b(0),lineWidth:new Vb(1)};let{compound:e}=this;e.add("shader",this.shader),e.add("shaderControls",this.shaderControlState),e.add("mode2d",this.params2d.mode),e.add("lineWidth2d",this.params2d.lineWidth),e.add("mode3d",this.params3d.mode),e.add("lineWidth3d",this.params3d.lineWidth)}get changed(){return this.compound.changed}reset(){this.compound.reset()}restoreState(e){e!==void 0&&this.compound.restoreState(e)}toJSON(){let e=this.compound.toJSON();for(let t of Object.values(e))if(t!==void 0)return e}},Nb=class extends j{constructor(e,t,r){super();this.chunkManager=e;this.source=t;this.displayState=r;this.layerChunkProgressInfo=new po;this.redrawNeeded=new re;this.fallbackShaderParameters=new Ee(Qo(lo(JI)));Zd(r,this),this.displayState.shaderError.value=void 0;let{skeletonRenderingOptions:i}=r;this.registerDisposer(i.shader.changed.add(()=>{this.displayState.shaderError.value=void 0,this.redrawNeeded.dispatch()}));let a=this.sharedObject=this.registerDisposer(new cs(e,r,this.layerChunkProgressInfo));a.RPC_TYPE_ID=$I,a.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()});let o=this.vertexAttributes=[x6];for(let[l,c]of t.vertexAttributes)o.push({name:l,dataType:c.dataType,numComponents:c.numComponents,webglDataType:b6(c.dataType),glslDataType:c.numComponents>1?`vec${c.numComponents}`:"float"})}get visibility(){return this.sharedObject.visibility}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t,r,i,a){let o=i.lineWidth.value,{gl:l,source:c,displayState:d}=this;if(d.objectAlpha.value<=0)return;let p=ns(d.transform.value,e.projectionParameters.displayDimensionRenderInfo,a);if(p===void 0)return;let m;i.mode.value===1?m=Math.max(5,o*2):m=o;let g=r.edgeShaderGetter(e.emitter),v=r.nodeShaderGetter(e.emitter),{shader:b,parameters:x}=g,{shader:C,parameters:T}=v;if(b===null||C===null)return;let{shaderControlState:I}=this.displayState.skeletonRenderingOptions;b.bind(),r.beginLayer(l,b,e,p),ni(l,b,I,x.parseResult.controls),l.uniform1f(b.uniform("uLineWidth"),o),C.bind(),r.beginLayer(l,C,e,p),l.uniform1f(C.uniform("uNodeDiameter"),m),ni(l,C,I,T.parseResult.controls);let P=c.chunks;ep(d,t,e.emitColor,e.emitPickID?e.pickIDs:void 0,(M,D,E)=>{let V=Nr(M),O=P.get(V);O===void 0||O.state!==Ze.GPU_MEMORY||(D!==void 0&&(b.bind(),r.setColor(l,b,D),C.bind(),r.setColor(l,C,D)),E!==void 0&&(b.bind(),r.setPickID(l,b,E),C.bind(),r.setPickID(l,C,E)),r.drawSkeleton(l,b,C,O,e.projectionParameters))}),r.endLayer(l,b)}isReady(){let{source:e,displayState:t}=this;if(t.objectAlpha.value<=0)return!0;let r=e.chunks,i=!0;return Ea(t.segmentationGroupState.value,a=>{let o=Nr(a),l=r.get(o);if(l===void 0||l.state!==Ze.GPU_MEMORY){i=!1;return}}),i}},ip=class extends Ur{constructor(e){super();this.base=e;this.renderHelper=this.registerDisposer(new Rb(this.base,!1));this.renderOptions=this.base.displayState.skeletonRenderingOptions.params3d;this.layerChunkProgressInfo=e.layerChunkProgressInfo,this.registerDisposer(e),this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch));let{renderOptions:t}=this;this.registerDisposer(t.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.lineWidth.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.visibility.add(this.visibility))}get gl(){return this.base.gl}get isTransparent(){return this.base.displayState.objectAlpha.value<1}draw(e,t){!e.emitColor&&e.alreadyEmittedPickID||this.base.draw(e,this,this.renderHelper,this.renderOptions,t)}isReady(){return this.base.isReady()}},bm=class extends hi{constructor(e){super();this.base=e;this.renderHelper=this.registerDisposer(new Rb(this.base,!0));this.renderOptions=this.base.displayState.skeletonRenderingOptions.params2d;this.layerChunkProgressInfo=e.layerChunkProgressInfo,this.registerDisposer(e);let{renderOptions:t}=this;this.registerDisposer(t.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.lineWidth.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.visibility.add(this.visibility))}get gl(){return this.base.gl}draw(e,t){this.base.draw(e,this,this.renderHelper,this.renderOptions,t)}isReady(){return this.base.isReady()}};function b6(n){switch(n){case G.FLOAT32:return WebGL2RenderingContext.FLOAT;default:throw new Error(`Data type not supported by WebGL: ${G[n]}`)}}var x6={dataType:G.FLOAT32,numComponents:3,name:"",webglDataType:WebGL2RenderingContext.FLOAT,glslDataType:"vec3"},qI=class extends br{constructor(e,t){super(e);this.vertexAttributes=t.vertexAttributes;let r=this.indices=t.indices;this.numVertices=t.numVertices,this.vertexAttributeOffsets=t.vertexAttributeOffsets,this.numIndices=r.length}copyToGPU(e){super.copyToGPU(e);let{attributeTextureFormats:t}=this.source,{vertexAttributes:r,vertexAttributeOffsets:i}=this,a=this.vertexAttributeTextures=[];for(let o=0,l=i.length;o<l;++o){let c=e.createTexture();e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,c),is(e,t[o],r.subarray(i[o],o+1!==l?i[o+1]:r.length)),a[o]=c}e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null),this.indexBuffer=Bt.fromData(e,this.indices,WebGL2RenderingContext.ARRAY_BUFFER,WebGL2RenderingContext.STATIC_DRAW)}freeGPUMemory(e){super.freeGPUMemory(e);let{vertexAttributeTextures:t}=this;for(let r of t)e.deleteTexture(r);t.length=0,this.indexBuffer.dispose()}},C6=new Map;function w6(n){let e=[S6];for(let t of n.values())e.push(yi(new Ji,t.dataType,t.numComponents));return e}var go=class extends Gn{get attributeTextureFormats(){let e=this.attributeTextureFormats_;return e===void 0&&(e=this.attributeTextureFormats_=w6(this.vertexAttributes)),e}getChunk(e){return new qI(this,e)}constructor(e,t){super(e,t)}get vertexAttributes(){return C6}};var gt;(function(r){r[r.UNKNOWN=0]="UNKNOWN",r[r.IMAGE=1]="IMAGE",r[r.SEGMENTATION=2]="SEGMENTATION"})(gt||(gt={}));function xm(n){let{rank:e,dataType:t,fillValue:r=t===G.UINT64?X.ZERO:0,compressedSegmentationBlockSize:i}=n,{baseVoxelOffset:a=new Float32Array(e)}=n;return{...Jo(n),compressedSegmentationBlockSize:i,baseVoxelOffset:a,dataType:t,fillValue:r}}function T6(n){if(n.compressedSegmentationBlockSize!==void 0||n.volumeType!==2&&!n.volumeSourceOptions.discreteValues)return!1;switch(n.dataType){case G.UINT32:case G.UINT64:break;default:return!1}switch(n.rank){case 3:return!0;case 4:{let{chunkDataSize:e}=n;return e[3]===1}default:return!1}}function Bb(n){let{rank:e,lowerVoxelBound:t,upperVoxelBound:r}=n;if(!T6(n))return xm(n);let{volumeSourceOptions:{displayRank:i,multiscaleToViewTransform:a},chunkToMultiscaleTransform:o,chunkToViewTransform:l}=n;l===void 0&&(l=pi(new Float32Array(e*i),i,a,i,o,e+1,i,e,e));let{maxCompressedSegmentationBlockSize:c,chunkDataSize:d}=n;return xm({...n,compressedSegmentationBlockSize:Float32Array.from(Pd({rank:e,chunkToViewTransform:l,displayRank:i,lowerVoxelBound:t,upperVoxelBound:r,maxVoxelsPerChunkLog2:9,maxBlockSize:c===void 0?d:IE(new Uint32Array(e),d,c)}))})}function xi(n){let{rank:e}=n,{volumeSourceOptions:{displayRank:t,multiscaleToViewTransform:r,modelChannelDimensionIndices:i},chunkToMultiscaleTransform:a}=n,o=pi(new Float32Array(t*e),t,r,t,a,e+1,t,e,e),{minBlockSize:l}=n;l===void 0?(l=new Uint32Array(e),l.fill(1)):l=new Uint32Array(l);let{lowerVoxelBound:c,upperVoxelBound:d}=n;if(i.length!==0)for(let m of js(a,e,i)){let g=d[m];c!==void 0&&(g-=c[m]),l[m]=g}let{chunkDataSizes:p=oD({...n,minBlockSize:l,chunkToViewTransform:o,displayRank:t})}=n;return p.map(m=>Bb({...n,chunkDataSize:m,chunkToViewTransform:o}))}function Cm(n,e,t,r){let{dataType:i}=e;e.defineShader(n,t);let a="",o="";if(t===0)a+="highp int ignoredChannelIndex";else for(let c=0;c<t;++c)c!==0&&(a+=", "),a+=`highp int channelIndex${c}`,o+=`, channelIndex${c}`;n.addFragmentCode(RD);let l=`
${_t(i)} getDataValue(${a}) {
  highp ivec3 p = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(${r}), uChunkDataSize - 1.0)));
  return getDataValueAt(p${o});
}
${_t(i)} getInterpolatedDataValue(${a}) {
  highp vec3 positionWithinChunk = ${r};
  highp ivec3[2] points;
  points[0] = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(positionWithinChunk - 0.5), uChunkDataSize - 1.0)));
  points[1] = ivec3(max(vec3(0.0, 0.0, 0.0), min(ceil(positionWithinChunk - 0.5), uChunkDataSize - 1.0)));
  highp vec3 mixCoeff = fract(positionWithinChunk - 0.5);
  ${_t(i)} xvalues[2];
  for (int ix = 0; ix < 2; ++ix) {
    ${_t(i)} yvalues[2];
    for (int iy = 0; iy < 2; ++iy) {
      ${_t(i)} zvalues[2];
      for (int iz = 0; iz < 2; ++iz) {
        zvalues[iz] = getDataValueAt(ivec3(points[ix].x, points[iy].y, points[iz].z)
                                     ${o});
      }
      yvalues[iy] = mixLinear(zvalues[0], zvalues[1], mixCoeff.z);
    }
    xvalues[ix] = mixLinear(yvalues[0], yvalues[1], mixCoeff.y);
  }
  return mixLinear(xvalues[0], xvalues[1], mixCoeff.x);
}
`;n.addFragmentCode(l),t<=1&&n.addFragmentCode(`
${_t(i)} getDataValue() { return getDataValue(0); }
${_t(i)} getInterpolatedDataValue() { return getInterpolatedDataValue(0); }
`)}var YI=new Array;function wm(n){YI.push(n)}function L6(n,e){for(let t of YI){let r=t(n,e);if(r!=null)return r}throw new Error("No chunk format handler found.")}var Hn=class extends ul{constructor(e,t){super(e,t);this.chunkFormatHandler=this.registerDisposer(L6(e.chunkQueueManager.gl,this.spec));let r=this.spec.upperVoxelBound.length;this.tempChunkGridPosition=new Float32Array(r),this.tempPositionWithinChunk=new Uint32Array(r)}static encodeSpec(e){let t=e;return{...super.encodeSpec(e),dataType:t.dataType,compressedSegmentationBlockSize:t.compressedSegmentationBlockSize&&Array.from(t.compressedSegmentationBlockSize),baseVoxelOffset:Array.from(t.baseVoxelOffset)}}get chunkFormat(){return this.chunkFormatHandler.chunkFormat}getValueAt(e,t){let r=this.spec.rank,i=this.tempChunkGridPosition,a=this.tempPositionWithinChunk,{spec:o}=this;{let{chunkDataSize:x}=o;for(let C=0;C<r;++C){let T=e[C],I=x[C],P=Math.floor(T/I);i[C]=P,a[C]=Math.floor(T-I*P)}}let l=this.chunks.get(i.join());if(l===void 0)return null;let c=l.chunkDataSize;for(let x=0;x<3;++x)if(a[x]>=c[x])return;if(t.channelSpaceShape.length===0)return l.getValueAt(a);let{numChannels:d,chunkChannelCoordinates:p,chunkChannelDimensionIndices:m}=t,g=m.length,v=0,b=new Array(d);for(let x=0;x<d;++x){for(let C=0;C<g;++C)a[m[C]]=p[v++];b[x]=l.getValueAt(a)}return b}getChunk(e){return this.chunkFormatHandler.getChunk(this,e)}},Ub=class extends Hd{get chunkFormat(){return this.source.chunkFormat}constructor(e,t){super(e,t);this.chunkDataSize=t.chunkDataSize||e.spec.chunkDataSize}},zt=class extends XS{};var KI=class extends lt(ct()(Hn),Xh){},XI=class extends lt(ct()(mo),Qh){},QI=class extends lt(ct()(tr),Zh){},ZI=class extends lt(ct()(go),em){},e1=class extends lt(ct()(hl),nm){},ap=new Map;ap.set("UINT8",G.UINT8);ap.set("FLOAT",G.FLOAT32);ap.set("UINT32",G.UINT32);ap.set("UINT64",G.UINT64);function k6(n){Z(n);try{return{corner:W(n,"corner",e=>hd(K.create(),e,Qe)),size:W(n,"size",e=>hd(K.create(),e,it)),metadata:W(n,"metadata",Wt)}}catch(e){throw new Error(`Failed to parse bounding box: ${e.message}`)}}var t1=class{constructor(e){try{Z(e),this.numChannels=W(e,"channelCount",St),this.dataType=W(e,"channelType",t=>th(t,ap)),this.voxelSize=W(e,"pixelSize",t=>hd(K.create(),t,it)),this.upperVoxelBound=W(e,"volumeSize",t=>hd(K.create(),t,St)),this.boundingBoxes=W(e,"boundingBox",t=>t===void 0?[]:ge(t,k6))}catch(t){throw new Error(`Failed to parse BrainMaps volume geometry: ${t.message}`)}}};function E6(n){return Z(n),{name:W(n,"name",Q),type:W(n,"type",Q)}}function D6(n){try{return Z(n),W(n,"meshes",e=>e===void 0?[]:ge(e,E6))}catch(e){throw new Error(`Failed to parse BrainMaps meshes specification: ${e.message}`)}}var P6="([0-9]*\\.?[0-9]+(?:[eE][-+]?[0-9]+)?)",Fb="([0-9]+)",n1=new RegExp(`^(.*)_${Fb}x${Fb}x${Fb}_lod([0-9]+)_${P6}$`);function I6(n,e){let t=new Map,r=n.scales[0],i=new Set;for(let o of e){if(o.type!=="TRIANGLES")continue;let l=o.name.match(n1);if(l===null)continue;let c=l[1],d=t.get(c);d===void 0&&(d={key:c,chunkShape:K.create(),lods:[]},t.set(c,d));let p=parseInt(l[5]);if(d.lods[p]!==void 0){i.add(c);continue}let m=K.fromValues(parseInt(l[2],10),parseInt(l[3],10),parseInt(l[4],10)),g=new Uint32Array(3);for(let v=0;v<3;++v)g[v]=Math.ceil(r.upperVoxelBound[v]/m[v]);d.lods[p]={info:o,scale:parseFloat(l[6]),relativeBlockShape:m,gridShape:g}}let a=[];e:for(let o of t.values()){if(i.has(o.key))continue e;let l=o.lods[0];if(l===void 0)continue e;let c=l.relativeBlockShape;K.multiply(o.chunkShape,c,r.voxelSize);for(let d=1;d<o.lods.length;++d){let p=o.lods[d];if(p===void 0)continue e;let{relativeBlockShape:m}=p;for(let g=0;g<3;++g){let v=m[g],b=c[g];if(v<b||v%b!=0)continue e;m[g]=v/b}}c.fill(1),a.push(o)}return a}function A6(n,e){let t=I6(n,e),r=[],i=o=>{r.some(l=>l.name===o.name)||r.push(o)},a=new Set;for(let o of t){i({multi:o,single:void 0,name:o.key,partOfMultiscale:!1});for(let l of o.lods)a.add(l.info)}for(let o of e)i({single:o,multi:void 0,name:o.name,partOfMultiscale:a.has(o)});return r}var r1=class{constructor(e){try{Z(e);let t=this.scales=W(e,"geometry",o=>ge(o,l=>new t1(l)));if(t.length===0)throw new Error("Expected at least one scale.");let r=t[0],i=this.numChannels=r.numChannels,a=this.dataType=r.dataType;for(let o=1,l=t.length;o<l;++o){let c=t[o];if(c.dataType!==a)throw new Error(`Scale ${o} has data type ${G[c.dataType]} but scale 0 has data type ${G[a]}.`);if(c.numChannels!==i)throw new Error(`Scale ${o} has ${c.numChannels} channel(s) but scale 0 has ${i} channels.`)}this.box={lowerBounds:new Float64Array(3),upperBounds:new Float64Array(r.upperVoxelBound)}}catch(t){throw new Error(`Failed to parse BrainMaps multiscale volume specification: ${t.message}`)}}getModelSpace(e=!1){let t=this.scales[0],r=["x","y","z"],i=["m","m","m"],a=Array.from(t.voxelSize,c=>c/1e9),o=[0,0,0],l=Array.from(t.upperVoxelBound);return e&&(r.push("c^"),i.push(""),a.push(1),o.push(0),l.push(this.numChannels)),Be({names:r,units:i,scales:Float64Array.from(a),boundingBoxes:[Yn({lowerBounds:new Float64Array(r.length),upperBounds:Float64Array.from(l)})]})}},i1=class extends zt{constructor(e,t,r,i,a,o,l){super(e);this.instance=t;this.credentialsProvider=r;this.volumeId=i;this.changeSpec=a;this.multiscaleVolumeInfo=o;this.encoding=l.encoding,this.jpegQuality=l.jpegQuality,this.chunkLayoutPreference=l.chunkLayoutPreference;let c=gt.IMAGE;this.dataType===G.UINT64&&(c=gt.SEGMENTATION),this.volumeType=c}get scales(){return this.multiscaleVolumeInfo.scales}get dataType(){return this.multiscaleVolumeInfo.dataType}get rank(){return this.multiscaleVolumeInfo.numChannels!==1?4:3}getSources(e){let t=Aa.RAW;(this.dataType===G.UINT64||this.dataType===G.UINT32)&&this.volumeType===gt.SEGMENTATION&&this.encoding!==Aa.RAW?t=Aa.COMPRESSED_SEGMENTATION:this.volumeType===gt.IMAGE&&this.dataType===G.UINT8&&this.multiscaleVolumeInfo.numChannels===1&&this.encoding!==Aa.RAW&&e.discreteValues!==!0&&(t=Aa.JPEG);let r=t===Aa.JPEG?this.jpegQuality:void 0,i=this.scales[0],{upperVoxelBound:a}=i,o=K.create(),{rank:l}=this;return Mr(this.scales.map((c,d)=>{K.divide(o,c.voxelSize,i.voxelSize);let p=c.upperVoxelBound,m,{numChannels:g}=c,v=new Float32Array((l+1)**2);v[(l+1)*l+l]=1;let b=new Float32Array(l);g!==1&&(p=Float32Array.of(...p,g),m=Uint32Array.of(1,1,1,g),v[(l+1)*3+3]=1,b[3]=g);for(let x=0;x<3;++x)v[(l+1)*x+x]=o[x],b[x]=a[x]/o[x];return xi({rank:l,minBlockSize:m,chunkToMultiscaleTransform:v,dataType:c.dataType,upperVoxelBound:p,volumeType:this.volumeType,volumeSourceOptions:e,chunkLayoutPreference:this.chunkLayoutPreference,maxCompressedSegmentationBlockSize:K.fromValues(64,64,64)}).map(x=>({chunkSource:this.chunkManager.getChunkSource(KI,{credentialsProvider:this.credentialsProvider,spec:x,parameters:{volumeId:this.volumeId,changeSpec:this.changeSpec,scaleIndex:d,encoding:t,jpegQuality:r,instance:this.instance}}),chunkToMultiscaleTransform:v,upperClipBound:b}))}))}};function M6(n){let e=ae.create(),t=n.scales[0].voxelSize;for(let r=0;r<3;++r)e[5*r]=1/t[r];return e}function R6(n){let e=n.match(/^([^:?\/]+:[^:?\/]+:[^:?\/]+)(?::([^:?\/]+))?(?:\/([^?]+))?(?:\?(.*))?$/);if(e===null)throw new Error(`Invalid Brain Maps volume key: ${JSON.stringify(n)}.`);let t;e[2]!==void 0&&(t={changeStackId:e[2]});let r=ci(e[4]||"");return{volumeId:e[1],changeSpec:t,meshName:e[3],parameters:r}}function _6(n){try{return Z(n),{id:W(n,"id",Q),label:W(n,"label",Q),description:W(n,"description",Wt)}}catch(e){throw new Error(`Failed to parse project: ${e.message}`)}}function V6(n){try{return Z(n),W(n,"project",e=>e===void 0?[]:ge(e,_6))}catch(e){throw new Error(`Error parsing project list: ${e.message}`)}}function a1(n,e){try{return Z(n),W(n,e,t=>t===void 0?[]:ge(t,Q))}catch(t){throw new Error(`Error parsing dataset list: ${t.message}`)}}function O6(n){return W(n,"changeStackId",e=>e===void 0?void 0:ge(e,Q))}var N6=lt(ct()(Hi),tm),o1=class extends N6{constructor(e,t){super(e,{rank:3,relationships:["segments"],properties:[],...t});this.credentialsProvider=this.registerDisposer(t.credentialsProvider.addRef())}hasNonSerializedProperties(){return!0}getSources(){let{upperVoxelBound:e}=this.parameters,t=Jo({rank:3,chunkDataSize:e,upperVoxelBound:e}),r=ae.create();return[[{chunkSource:this.chunkManager.getChunkSource(e1,{parent:this,spec:{limit:0,chunkToMultiscaleTransform:r,...t},parameters:this.parameters,credentialsProvider:this.credentialsProvider}),chunkToMultiscaleTransform:r}]]}},B6=[{key:{value:"encoding",description:"Volume chunk data encoding"},values:[{value:"raw",description:""},{value:"jpeg",description:""},{value:"compressed_segmentation",description:""}]},{key:{value:"chunkLayout",description:"Volume chunk layout preference"},values:[{value:"isotropic",description:""},{value:"flat",description:""}]},{key:{value:"jpegQuality",description:"JPEG quality (1 to 100)"},values:[]}],Tm=class extends Ut{constructor(e,t){super();this.instance=e;this.credentialsProvider=t}get description(){return this.instance.description}getMultiscaleInfo(e,t){return e.memoize.getUncounted({type:"brainmaps:getMultiscaleInfo",volumeId:t,instance:this.instance,credentialsProvider:pt(this.credentialsProvider)},()=>gl(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/volumes/${t}`,responseType:"json"}).then(r=>new r1(r)))}getMeshesInfo(e,t){return e.memoize.getUncounted({type:"brainmaps:getMeshesInfo",volumeId:t,instance:this.instance,credentialsProvider:pt(this.credentialsProvider)},()=>gl(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/objects/${t}/meshes`,responseType:"json"}).then(r=>D6(r)))}get(e){let{volumeId:t,changeSpec:r,meshName:i,parameters:a}=R6(e.providerUrl);Z(a);let o=oe(a,"encoding",p=>Mt(p,Aa)),l=oe(a,"jpegQuality",p=>{let m=rt(p);if(m<1||m>100)throw new Error(`Expected integer in range [1, 100], but received: ${p}`);return m},70),c=oe(a,"chunkLayout",p=>Mt(p,el)),d={encoding:o,chunkLayoutPreference:c,jpegQuality:l};return e.chunkManager.memoize.getUncounted({type:"brainmaps:get",instance:this.instance,volumeId:t,changeSpec:r,brainmapsOptions:d},async()=>{let[p,m]=await Promise.all([this.getMultiscaleInfo(e.chunkManager,t),this.getMeshesInfo(e.chunkManager,t)]),g=new i1(e.chunkManager,this.instance,this.credentialsProvider,t,r,p,d),v={modelTransform:xt(p.getModelSpace(p.numChannels!==1)),subsources:[{id:i===void 0?"default":"volume",subsource:{volume:g},default:i===void 0}]},b=Pn(p.box);p.scales[0].boundingBoxes.forEach((I,P)=>{b.add({type:Oe.AXIS_ALIGNED_BOUNDING_BOX,description:I.metadata,pointA:I.corner,pointB:K.add(K.create(),I.corner,I.size),id:`boundingBox${P}`,properties:[]})}),v.subsources.push({id:"bounds",subsource:{staticAnnotations:b},default:!0});let C=A6(p,m),T=(I,P)=>{let M,{single:D}=I;if(D!==void 0)D.type==="TRIANGLES"?M=e.chunkManager.getChunkSource(QI,{credentialsProvider:this.credentialsProvider,parameters:{instance:this.instance,volumeId:t,meshName:D.name,changeSpec:r}}):M=e.chunkManager.getChunkSource(ZI,{credentialsProvider:this.credentialsProvider,parameters:{instance:this.instance,volumeId:t,meshName:I.name,changeSpec:r}});else{let E=I.multi;M=e.chunkManager.getChunkSource(XI,{credentialsProvider:this.credentialsProvider,format:{fragmentRelativeVertices:!1,vertexPositionFormat:gi.float32},parameters:{instance:this.instance,volumeId:t,info:E,changeSpec:r}})}v.subsources.push({id:i===void 0?`/${I.name}`:"default",subsource:{mesh:M},subsourceToModelSubspaceTransform:M6(p),modelSubspaceDimensionIndices:[0,1,2],default:P})};if(i!==void 0){let I=C.find(P=>P.name===i);if(I===void 0)throw new Error(`Mesh/skeleton source not found: ${JSON.stringify(I)}`);T(I,!0)}else{let I=!0;for(let P of C)P.partOfMultiscale||(T(P,I),I=!1)}return r!==void 0&&v.subsources.push({id:"spatials",default:!0,modelSubspaceDimensionIndices:[0,1,2],subsource:{annotation:e.chunkManager.getChunkSource(o1,{parameters:{volumeId:t,changestack:r.changeStackId,instance:this.instance,upperVoxelBound:p.scales[0].upperVoxelBound},credentialsProvider:this.credentialsProvider})}}),v})}getProjectList(e){return e.memoize.getUncounted({instance:this.instance,type:"brainmaps:getProjectList"},()=>{let t=gl(this.instance,this.credentialsProvider,{method:"GET",path:"/v1beta2/projects",responseType:"json"}).then(i=>V6(i)),r=`${this.instance.description} project list`;return Ce.forPromise(t,{delay:!0,initialMessage:`Retrieving ${r}.`,errorPrefix:`Error retrieving ${r}: `}),t})}getDatasetList(e,t){return e.memoize.getUncounted({instance:this.instance,type:`brainmaps:${t}:getDatasetList`},()=>{let r=gl(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/datasets?project_id=${t}`,responseType:"json"}).then(a=>a1(a,"datasetIds")),i=`${this.instance.description} dataset list`;return Ce.forPromise(r,{delay:!0,initialMessage:`Retrieving ${i}`,errorPrefix:`Error retrieving ${i}`}),r})}getVolumeList(e,t,r){return e.memoize.getUncounted({instance:this.instance,type:`brainmaps:${t}:${r}:getVolumeList`},()=>{let i=gl(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/volumes?project_id=${t}&dataset_id=${r}`,responseType:"json"}).then(o=>{let l=a1(o,"volumeId"),c=t.length+r.length+2,d=[];for(let p of l)d.push(p.substring(c));return d}),a=`${this.instance.description} volume list`;return Ce.forPromise(i,{delay:!0,initialMessage:`Retrieving ${a}`,errorPrefix:`Error retrieving ${a}`}),i})}getChangeStackList(e,t){return e.memoize.getUncounted({instance:this.instance,type:"brainmaps:getChangeStackList",volumeId:t},()=>{let r=gl(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/changes/${t}/change_stacks`,responseType:"json"}).then(a=>O6(a)),i=`change stacks for ${t}`;return Ce.forPromise(r,{delay:!0,initialMessage:`Retrieving ${i}.`,errorPrefix:`Error retrieving ${i}: `}),r})}async completeUrl(e){let{providerUrl:t}=e,r=t.match(/^([^:\/?]*)(?::([^:\/?]*)(?::([^:\/?]*)(?::([^:\/?]*))?(?:\/([^?]*))?(?:\?(.*))?)?)?$/);if(r===null)throw null;let[,i,a,o,l,c,d]=r;if(d!==void 0)return Br(t.length-d.length,await jh(d,B6));if(c!==void 0){let m=`${i}:${a}:${o}`,g=await this.getMeshesInfo(e.chunkManager,m),v=[],b=new Set;for(let x of g)if(!!x.name.startsWith(c))switch(x.type){case"LINE_SEGMENTS":v.push({value:x.name,description:"Skeletons"});break;case"TRIANGLES":{v.push({value:x.name,description:"Mesh (single-resolution)"});let C=x.name.match(n1);if(C!==null){let T=C[1];if(b.has(T))break;b.add(T),v.push({value:T,description:"Mesh (multi-resolution)"})}break}}return v.sort((x,C)=>fo(x.value,C.value)),{offset:t.length-c.length,completions:v}}if(l!==void 0){let m=`${i}:${a}:${o}`,g=await this.getChangeStackList(e.chunkManager,m);if(g===void 0)throw null;return{offset:t.length-l.length,completions:$h(l,g)}}if(o!==void 0)return{offset:t.length-o.length,completions:$h(o,await this.getVolumeList(e.chunkManager,i,a))};if(a!==void 0){let m=await this.getDatasetList(e.chunkManager,i);return{offset:t.length-a.length,completions:$h(a,m.map(g=>`${g}:`))}}let p=await this.getProjectList(e.chunkManager);return{offset:0,completions:on(i,p,m=>`${m.id}:`,m=>m.label)}}},s1={description:"Google Brain Maps",serverUrl:"https://brainmaps.googleapis.com"};var An=class extends j{};function l1(n){let e,t,r;return(i,a)=>t!==void 0&&(e===void 0||i===void 0||e.generation!==i.generation)?(e===void 0&&r.addConsumer(a),t):(e=void 0,r=new mS,t=n(i,r).then(o=>(e=o,r=void 0,o),o=>{throw r.isCanceled&&(r=void 0,t=void 0),o}),t)}function or(n){let e=0;return l1((t,r)=>n(r).then(i=>({generation:++e,credentials:i})))}var c1=class{constructor(){this.providers=new Map;this.topLevelManager=this}register(e,t){this.providers.set(e,t)}getCredentialsProvider(e,t){let r=this.providers.get(e);if(r===void 0)throw new Error(`No registered credentials provider: ${JSON.stringify(e)}`);return r(t,this.topLevelManager)}},u1=class extends j{constructor(e){super();this.base=e;this.memoize=new xd}getCredentialsProvider(e,t){return this.memoize.get({key:e,parameters:t},()=>this.registerDisposer(this.base.getCredentialsProvider(e,t).addRef()))}},Gb=class extends u1{constructor(){super(new c1);this.base.topLevelManager=this}register(e,t){this.base.register(e,t)}},Wb=class extends An{constructor(e,t){super();this.baseProvider=e;this.anonymousCredentials=t;this.anonymous=!0;this.get=l1(e=>this.anonymous&&e===void 0?Promise.resolve({generation:-10,credentials:this.anonymousCredentials}):(this.anonymous=!1,this.baseProvider.get(e)))}};var sr=new Gb;var d1="email",p1="openid",U6="https://accounts.google.com/o/oauth2/auth",f1="https://accounts.google.com";function F6(n,e){let t=document.createElement("iframe");t.style.display="none",t.id=n,t.name=n;let r=location.origin;t.src=`https://accounts.google.com/o/oauth2/postmessageRelay?parent=${encodeURIComponent(r)}#rpctoken=${e}`,document.body.appendChild(t)}var h1=class{constructor(){this.finished=new ze}};function G6(n){let e=n.split(".");try{if(e.length!==3)throw new Error("Invalid JWT format");let t=atob(e[1]),r=JSON.parse(t);return Z(r),W(r,"email",Q)}catch(t){throw new Error(`Failed to decode id token: ${t.message}`)}}var m1=class{constructor(){this.proxyName=`postmessageRelay${di()}`;this.rpcToken=`${di()}`;this.relayReadyService=`oauth2relayReady:${this.rpcToken}`;this.oauth2CallbackService=`oauth2callback:${this.rpcToken}`;this.pendingRequests=new Map;F6(this.proxyName,this.rpcToken),this.relayReadyPromise=new Promise(e=>{addEventListener("message",t=>{if(t.origin===f1)try{let r=Z(JSON.parse(t.data)),i=Q(r.s);if(i===this.relayReadyService&&e(),i===this.oauth2CallbackService){let a=ge(r.a,M=>M),o=Q(a[0]),l=location.origin;if(!o.startsWith(l+"#")&&!o.startsWith(l+"?"))throw new Error(`oauth2callback: URL ${JSON.stringify(o)} does not match current origin ${l}.`);let d=o.substring(l.length+1).split("&"),p=new Map;for(let M of d){let D=M.match("^([a-z_]+)=(.*)$");if(D===null)throw new Error(`oauth2callback: URL part ${JSON.stringify(D)} does not match expected pattern.`);p.set(D[1],D[2])}let m=p.get("state");if(m===void 0)throw new Error("oauth2callback: State argument is missing.");let g=this.pendingRequests.get(m);if(g===void 0)return;let v=p.get("error");if(v!==void 0){let M=p.get("error_subtype"),D=v;M!==void 0&&(D+=": "+M),g.finished.dispatch(void 0,new Error(`Error obtaining Google OAuth2 token: ${D}`));return}let b=p.get("access_token"),x=p.get("token_type"),C=p.get("expires_in"),T=p.get("id_token"),I=T===void 0?void 0:G6(T),P=p.get("scope");if(b===void 0||x===void 0||C===void 0||P===void 0)throw new Error("oauth2callback: URL lacks expected parameters.");g.finished.dispatch({accessToken:b,tokenType:x,expiresIn:C,scope:P,email:I});return}}catch(r){throw new Error(`Invalid message received from ${f1}: ${JSON.stringify(t.data)}: ${r.message}.`)}})})}addPendingRequest(e){let t=new h1;return this.pendingRequests.set(e,t),t.finished.add(()=>{this.pendingRequests.delete(e)}),t}makeAuthRequestUrl(e){let t=`${U6}?client_id=${encodeURIComponent(e.clientId)}`;t+="&redirect_uri=postmessage";let r="token",{scopes:i}=e;i.includes("email")&&i.includes("openid")&&(r="token%20id_token"),t+=`&response_type=${r}`;let{origin:a=location.origin}=e;return t+=`&origin=${encodeURIComponent(a)}`,t+=`&proxy=${this.proxyName}`,t+="&include_granted_scopes=true",t+=`&scope=${encodeURIComponent(i.join(" "))}`,e.state&&(t+=`&state=${e.state}`),e.approvalPrompt&&(t+=`&approval_prompt=${encodeURIComponent(e.approvalPrompt)}`),e.loginHint&&(t+=`&login_hint=${encodeURIComponent(e.loginHint)}`),e.immediate&&(t+="&immediate=true"),e.authUser!==void 0&&(t+=`&authuser=${e.authUser}`),t}},zb;function W6(){return zb===void 0&&(zb=new m1),zb}function z6(n,e=at){let t=di(),r=W6(),i=r.makeAuthRequestUrl({state:t,clientId:n.clientId,scopes:n.scopes,approvalPrompt:n.approvalPrompt,loginHint:n.loginHint,immediate:n.immediate,authUser:n.authUser}),a=r.addPendingRequest(t),o=new Promise((l,c)=>{a.finished.add((d,p)=>{d!==void 0?l(d):c(p)})});if(a.finished.add(e.add(()=>{a.finished.dispatch(void 0,Kn)})),n.immediate)r.relayReadyPromise.then(()=>{if(e.isCanceled)return;let l=document.createElement("iframe");l.src=i,l.style.display="none",document.body.appendChild(l),a.finished.add(()=>{Ye(l)})});else if(!e.isCanceled){let l=open(i);l!==null&&a.finished.add(()=>{l.close()})}return o}var Hb=class extends An{constructor(e){super();this.options=e;this.get=or(e=>{let{options:t}=this,r=new Ce(!0),i;return new Promise((a,o)=>{let l=()=>{i=void 0,r.dispose()};e.add(()=>{i!==void 0&&(i.cancel(),i=void 0,r.dispose(),o(Kn))});function c(p=`${t.description} authorization required.`,m="Request authorization."){r.setText(p+"  ");let g=document.createElement("button");g.textContent=m,r.element.appendChild(g),g.addEventListener("click",()=>{d(!1)}),r.setVisible(!0)}function d(p){i!==void 0&&i.cancel(),i=new vr,c(`Waiting for ${t.description} authorization...`,"Retry"),z6({clientId:t.clientId,scopes:t.scopes,immediate:p,authUser:0},i).then(m=>{i!==void 0&&(l(),a(m))},m=>{i!==void 0&&(i=void 0,p?c():c(`${t.description} authorization failed: ${m}.`,"Retry"))})}d(!0)})})}};var H6="https://www.googleapis.com/auth/brainmaps",$b=class extends Hb{constructor(e){super({clientId:e,scopes:[H6,p1,d1],description:"Brain Maps"})}};sr.register(Jd,()=>new $b("639403125587-4k5hgdfumtrvur8v48e3pr7oo91d765k.apps.googleusercontent.com"));var g1=new Map;function Ot(n,e){g1.set(n,e)}function y1(n){let e=new rb(n.credentialsManager);for(let[t,r]of g1)e.register(t,r(n));return e}Ot("brainmaps",n=>new Tm(s1,n.credentialsManager.getCredentialsProvider(Jd)));if(typeof NEUROGLANCER_BRAINMAPS_SERVERS!="undefined")for(let[n,e]of Object.entries(NEUROGLANCER_BRAINMAPS_SERVERS))Ot(`brainmaps-${n}`,t=>new Tm(e,t.credentialsManager.getCredentialsProvider(Jd)));var Lm="boss";function Ll(n,e,t,r,i=at){return $i(e,t,r,i).catch(a=>{if(a.status!==500&&a.status!==401&&a.status!==403&&a.status!==504)throw a;return Pa(n,e,t,r,o=>{let l=new Headers(t.headers);return l.set("Authorization",`Bearer ${o}`),{...t,headers:l}},o=>{let{status:l}=o;if(l===403||l===401)return"refresh";throw o},i)})}var v1=class{},km=class extends v1{static stringify(e){return`boss:volume:${e.baseUrl}/${e.collection}/${e.experiment}/${e.channel}/${e.resolution}/${e.encoding}`}};km.RPC_ID="boss/VolumeChunkSource";var Em=class{static stringify(e){return`boss:mesh:${e.baseUrl}`}};Em.RPC_ID="boss/MeshChunkSource";var S1=class extends lt(ct()(Hn),km){},b1=class extends lt(ct()(tr),Em){},jb=new Map;jb.set("image",gt.IMAGE);jb.set("annotation",gt.SEGMENTATION);var $6=new Set(["npz","jpeg"]),j6=Uint32Array.of(512,512,16),kl;(function(i){i[i.NANOMETERS=0]="NANOMETERS",i[i.MICROMETERS=1]="MICROMETERS",i[i.MILLIMETERS=2]="MILLIMETERS",i[i.CENTIMETERS=3]="CENTIMETERS"})(kl||(kl={}));function J6(n){switch(n){case 1:return 1e6;case 2:return 1e3;case 3:return 100;case 0:return 1e9}}function q6(n,e){Z(n);let t=W(n,"voxel_unit",d=>Mt(d,kl)),r=J6(t),i=new Float32Array(3),a=new Float64Array(3),o=new Float64Array(3),l=new Float64Array(3),c=["x","y","z"];for(let d=0;d<3;++d){let p=c[d];i[d]=W(n,`${p}_voxel_size`,it),a[d]=i[d]/r,o[d]=W(n,`${p}_start`,rt),l[d]=W(n,`${p}_stop`,rt)}return e.coordFrame={voxelSizeBaseInMeters:a,voxelSizeBaseInOriginalUnits:i,voxelOffsetBase:o,imageSizeBase:l,voxelUnit:t,names:c},e}function Y6(n){let e=jb.get(n);return e===void 0&&(e=gt.UNKNOWN),e}function K6(n){Z(n);let e=W(n,"type",Q),t=!1;return W(n,"downsample_status",Q)==="DOWNSAMPLED"&&(t=!0),{channelType:e,description:W(n,"description",Q),volumeType:Y6(e),dataType:W(n,"datatype",i=>Mt(i,G)),downsampled:t,scales:[],key:W(n,"name",Q),baseResolution:W(n,"base_resolution",rt)}}function X6(n,e,t,r,i,a){Z(n);let o=W(n,"channels",l=>ge(l,c=>Z6(e,t,r,a,i,c)));return Promise.all(o).then(l=>{let c=new Map;l.forEach(p=>{c.set(p.key,p)});let d={channels:c,scalingLevels:W(n,"num_hierarchy_levels",rt),coordFrameKey:W(n,"coord_frame",Q),coordFrame:void 0,key:W(n,"name",Q),collection:W(n,"collection",Q)};return oH(e,t,r,d)})}var x1=class extends zt{constructor(e,t,r,i,a,o){super(e);this.baseUrl=t;this.credentialsProvider=r;this.experimentInfo=i;this.parameters=o;this.meshPath=void 0;this.meshUrl=void 0;if(a===void 0){let m=Array.from(i.channels.keys());if(m.length!==1)throw new Error(`Experiment contains multiple channels: ${JSON.stringify(m)}`);a=m[0]}let l=i.channels.get(a);if(l===void 0)throw new Error(`Specified channel ${JSON.stringify(a)} is not one of the supported channels ${JSON.stringify(Array.from(i.channels.keys()))}`);if(this.channel=a,this.channelInfo=l,this.scales=l.scales,i.coordFrame===void 0)throw new Error(`Specified experiment ${JSON.stringify(i.key)} does not have a valid coordinate frame`);this.coordinateFrame=i.coordFrame,this.channelInfo.downsampled===!1&&(this.scales=[l.scales[0]]),this.experiment=i.key;let c=Wt(o.window);if(c!==void 0){let m=gr.create(),g=c.split(/,/);if(g.length===2)m[0]=Qe(g[0]),m[1]=Qe(g[1]);else if(g.length===1)m[0]=0,m[1]=Qe(g[1]);else throw new Error(`Invalid window. Must be either one value or two comma separated values: ${JSON.stringify(c)}`);if(this.window=m,this.window[0]===this.window[1])throw new Error(`Invalid window. First element must be different from second: ${JSON.stringify(c)}.`)}let d=Wt(o.meshurl);d!==void 0&&(this.meshUrl=d);let p=Wt(o.encoding);if(p===void 0)p=this.dataType===G.UINT8?"jpeg":"npz";else if(!$6.has(p))throw new Error(`Invalid encoding: ${JSON.stringify(p)}.`);this.encoding=p}get dataType(){return this.channelInfo.dataType}get volumeType(){return this.channelInfo.volumeType}get rank(){return 3}getSources(e){let t=this.scales[0].downsampleFactors,{rank:r}=this;return Mr(this.scales.map(i=>{let a=this.coordinateFrame.voxelOffsetBase,o=K.create();for(let m=0;m<3;++m)o[m]=Math.ceil(a[m]);let l=i.downsampleFactors,c=r+1,d=new Float32Array(c*c);d[d.length-1]=1;for(let m=0;m<3;++m){let g=l[m]/t[m];d[c*m+m]=g,d[c*r+m]=o[m]*g}r===4&&(d[c*3+3]=1);let p=i.imageSize;return xi({rank:3,volumeType:this.volumeType,dataType:this.dataType,chunkToMultiscaleTransform:d,chunkDataSizes:[j6],baseVoxelOffset:o,upperVoxelBound:p,volumeSourceOptions:e}).map(m=>({chunkSource:this.chunkManager.getChunkSource(S1,{credentialsProvider:this.credentialsProvider,spec:m,parameters:{baseUrl:this.baseUrl,collection:this.experimentInfo.collection,experiment:this.experimentInfo.key,channel:this.channel,resolution:i.key,encoding:this.encoding,window:this.window}}),chunkToMultiscaleTransform:d}))}))}getMeshSource(){return this.meshUrl!==void 0?this.chunkManager.getChunkSource(b1,{credentialsProvider:this.credentialsProvider,parameters:{baseUrl:this.meshUrl}}):null}},Q6=/^([^\/?]+)\/([^\/?]+)(?:\/([^\/?]+))?(?:\?(.*))?$/;function C1(n,e,t,r,i){return n.memoize.getUncounted({hostname:e,collection:i,experiment:r,type:"boss:getExperimentInfo"},()=>Ll(t,`${e}/latest/collection/${i}/experiment/${r}/`,{},bt).then(a=>X6(a,n,e,t,i,r)))}function Z6(n,e,t,r,i,a){return n.memoize.getUncounted({hostname:e,collection:i,experiment:r,channel:a,type:"boss:getChannelInfo"},()=>Ll(t,`${e}/latest/collection/${i}/experiment/${r}/channel/${a}/`,{},bt).then(K6))}function eH(n,e,t,r,i,a){return n.memoize.getUncounted({hostname:e,collection:r,experiment:i.key,channel:a,downsample:!0,type:"boss:getDownsampleInfoForChannel"},()=>Ll(t,`${e}/latest/downsample/${r}/${i.key}/${a}`,{},bt)).then(o=>nH(o,i,a))}function tH(n,e){Z(n);let t=W(n,"voxel_size",o=>Za(o,gE)),r=W(n,"extent",o=>Za(o,yE)),i=W(n,"num_hierarchy_levels",rt),a=new Array;for(let o=0;o<i;o++){let l=String(o),c=t.get(l),d=r.get(l);if(c===void 0||d===void 0)throw new Error(`Missing voxel_size/extent for resolution ${l}.`);let p=new Float32Array(3);for(let m=0;m<3;++m)p[m]=c[m]/e[m];a[o]={downsampleFactors:p,imageSize:d,key:l}}return a}function nH(n,e,t){let r=e.coordFrame;if(r===void 0)throw new Error(`Missing coordinate frame information for experiment ${e.key}. A valid coordinate frame is required to retrieve downsampling information.`);let i=e.channels.get(t);if(i===void 0)throw new Error(`Specified channel ${JSON.stringify(t)} is not one of the supported channels ${JSON.stringify(Array.from(e.channels.keys()))}`);return i.scales=tH(n,r.voxelSizeBaseInOriginalUnits),e.channels.set(t,i),e}function rH(n,e,t,r){let i=r.match(Q6);if(i===null)throw new Error(`Invalid volume path ${JSON.stringify(r)}`);let a=i[1],o=i[2],l=i[3],c=ci(i[4]||"");return n.memoize.getUncounted({hostname:e,path:r,type:"boss:getVolume"},async()=>{let d=await C1(n,e,t,o,a),p=await eH(n,e,t,a,d,l),m=new x1(n,e,t,p,l,c),g=p.coordFrame,v={lowerBounds:g.voxelOffsetBase,upperBounds:Float64Array.from(g.imageSizeBase,(C,T)=>g.voxelOffsetBase[T]+C)},b=Be({rank:3,names:g.names,units:["m","m","m"],scales:g.voxelSizeBaseInMeters,boundingBoxes:[Yn(v)]});return{modelTransform:xt(b),subsources:[{id:"default",default:!0,subsource:{volume:m}},{id:"bounds",default:!0,subsource:{staticAnnotations:Pn(v)}}]}})}var w1=/^((?:http|https):\/\/[^\/?]+)\/(.*)$/;function iH(n,e,t){return n.memoize.getUncounted({hostname:e,type:"boss:getCollections"},()=>Ll(t,`${e}/latest/collection/`,{},bt).then(r=>W(r,"collections",i=>ge(i,Q))))}function aH(n,e,t,r){return n.memoize.getUncounted({hostname:e,collection:r,type:"boss:getExperiments"},()=>Ll(t,`${e}/latest/collection/${r}/experiment/`,{},bt).then(i=>W(i,"experiments",a=>ge(a,Q))))}function oH(n,e,t,r){let i=r.coordFrameKey;return n.memoize.getUncounted({hostname:e,coordinateframe:i,experimentInfo:r,type:"boss:getCoordinateFrame"},()=>Ll(t,`${e}/latest/coord/${i}/`,{},bt).then(a=>q6(a,r)))}function sH(n,e,t,r){let i=r.match(/^(?:([^\/]+)(?:\/?([^\/]*)(?:\/?([^\/]*)(?:\/?([^\/]*)?))?)?)?$/);if(i===null||i[1]===void 0)return Promise.reject(null);if(i[2]===void 0){let a=i[1]||"";return iH(n,e,t).then(o=>({offset:0,completions:on(a,o,l=>l+"/",()=>{})}))}if(i[3]===void 0){let a=i[2]||"";return aH(n,e,t,i[1]).then(o=>({offset:i[1].length+1,completions:on(a,o,l=>l+"/",()=>{})}))}return C1(n,e,t,i[2],i[1]).then(a=>{let o=on(i[3],a.channels,l=>l[0],l=>`${l[1].channelType} (${G[l[1].dataType]})`);return{offset:i[1].length+i[2].length+2,completions:o}})}function lH(n){let e=n.match(/^(?:https:\/\/[^.]+([^\/]+))/);if(e===null)throw new Error(`Unable to construct auth server hostname from base hostname ${n}.`);return`https://auth${e[1]}/auth`}var Jb=class extends Ut{constructor(e){super();this.credentialsManager=e}get description(){return"bossDB: Block & Object Storage System"}getCredentialsProvider(e){let t=lH(e);return this.credentialsManager.getCredentialsProvider(Lm,t)}get(e){let t=e.providerUrl.match(w1);if(t===null)throw new Error(`Invalid boss volume path: ${JSON.stringify(e.providerUrl)}`);let r=this.getCredentialsProvider(e.providerUrl);return rH(e.chunkManager,t[1],r,t[2])}async completeUrl(e){let t=e.providerUrl.match(w1);if(t===null)throw null;let r=t[1],i=this.getCredentialsProvider(t[1]),a=t[2],o=await sH(e.chunkManager,r,i,a);return Br(t[1].length+1,o)}};var T1=class{constructor(){this.finished=new ze}},L1=class{constructor(){this.oidcCallbackService="bossAuthCallback";this.pendingRequests=new Map;this.registerListener()}registerListener(){addEventListener("message",e=>{if(e.origin===location.origin)try{let t=Z(JSON.parse(e.data));if(Q(t.service)===this.oidcCallbackService){let i=Q(t.access_token),a=Q(t.state),o=this.pendingRequests.get(a);if(o===void 0)return;o.finished.dispatch(i)}}catch(t){}})}addPendingRequest(e){let t=new T1;return this.pendingRequests.set(e,t),t.finished.add(()=>{this.pendingRequests.delete(e)}),t}makeAuthRequestUrl(e){let t=`${e.authServer}/realms/BOSS/protocol/openid-connect/auth?`;return t+=`client_id=${encodeURIComponent(e.clientId)}`,t+=`&redirect_uri=${encodeURIComponent(e.redirect_uri)}`,t+="&response_mode=fragment",t+="&response_type=code%20id_token%20token",e.state&&(t+=`&state=${e.state}`),e.nonce&&(t+=`&nonce=${e.nonce}`),t}},qb;function cH(){return qb===void 0&&(qb=new L1),qb}function uH(n,e=at){let t=di(),r=di(),i=cH(),a=i.makeAuthRequestUrl({state:t,clientId:n.clientId,redirect_uri:new URL("bossauth.html",window.location.href).href,authServer:n.authServer,nonce:r}),o=i.addPendingRequest(t),l=new Promise((c,d)=>{o.finished.add((p,m)=>{p!==void 0?c(p):d(m)})});if(o.finished.add(e.add(()=>{o.finished.dispatch(void 0,Kn)})),!e.isCanceled){let c=open(a);c!==null&&o.finished.add(()=>{c.close()})}return l}var Yb=class extends An{constructor(e){super();this.authServer=e;this.get=or(e=>{let t=new Ce(!0),r;return new Promise((i,a)=>{let o=()=>{r=void 0,t.dispose()};e.add(()=>{r!==void 0&&(r.cancel(),r=void 0,t.dispose(),a(Kn))});function l(p="Boss authorization required.",m="Request authorization."){t.setText(p+" ");let g=document.createElement("button");g.textContent=m,t.element.appendChild(g),g.addEventListener("click",()=>{d()}),t.setVisible(!0)}let c=this.authServer;function d(){r!==void 0&&r.cancel(),r=new vr,l("Waiting for Boss authorization...","Retry"),uH({realm:"boss",clientId:"endpoint",authServer:c},r).then(p=>{r!==void 0&&(o(),i(p))},p=>{r!==void 0&&(r=void 0,l(`Boss authorization failed: ${p}.`,"Retry"))})}l()})})}};sr.register(Lm,n=>new Yb(n));Ot("boss",n=>new Jb(n.credentialsManager));var op="DVID";function Kb(n){return n.text()}function k1(n,e,t=at){return dH(n,e.url,{method:e.method,body:e.payload},e.responseType===""?Kb:e.responseType==="json"?bt:Kh,t)}function dH(n,e,t,r,i=at){return Pa(n,e,t,r,(a,o)=>{let l={...o};return a.token&&(l.headers={...l.headers,Authorization:`Bearer ${a}`}),l},a=>{let{status:o}=a;if(o===403||o===401)return"refresh";throw a},i)}var ri;(function(i){i[i.JPEG=0]="JPEG",i[i.RAW=1]="RAW",i[i.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION",i[i.COMPRESSED_SEGMENTATIONARRAY=3]="COMPRESSED_SEGMENTATIONARRAY"})(ri||(ri={}));var Dm=class{},Pm=class extends Dm{};Pm.RPC_ID="dvid/VolumeChunkSource";var Im=class extends Dm{};Im.RPC_ID="dvid/SkeletonSource";var Am=class extends Dm{};Am.RPC_ID="dvid/MeshSource";var Mm=new Map;Mm.set("uint8",G.UINT8);Mm.set("uint32",G.UINT32);Mm.set("uint64",G.UINT64);var E1=class{constructor(e){this.obj=e;Z(e),W(e,"TypeName",Q)}get typeName(){return this.obj.TypeName}get compressionName(){return this.obj.Compression}},D1=class{constructor(e,t,r){this.obj=e;this.name=t;this.base=r}},P1=class extends lt(ct()(Hn),Pm){},I1=class extends lt(ct()(go),Im){},A1=class extends lt(ct()(tr),Am){},sp=class extends D1{constructor(e,t,r,i,a){super(e,t,r);this.encoding=i;let o=W(e,"Extended",Z),l=W(o,"Values",d=>ge(d,Z));if(l.length<1)throw new Error("Expected Extended.Values property to have length >= 1, but received: ${JSON.stringify(extendedValues)}.");this.numLevels=1;let c=new Set(a);if(i===ri.COMPRESSED_SEGMENTATIONARRAY){let d=W(o,"MaxDownresLevel",St);this.numLevels=d+1}else for(;c.has(t+"_"+this.numLevels.toString());)this.numLevels+=1;c.has(t+"_meshes")?this.meshSrc=t+"_meshes":this.meshSrc="",c.has(t+"_skeletons")?this.skeletonSrc=t+"_skeletons":this.skeletonSrc="",this.dataType=W(l[0],"DataType",d=>th(d,Mm)),this.voxelSize=W(o,"VoxelSize",d=>Ne(K.create(),d,it)),this.blockSize=W(o,"BlockSize",d=>Ne(K.create(),d,it)),this.lowerVoxelBound=W(o,"MinPoint",d=>Vv(K.create(),d)),this.upperVoxelBoundInclusive=W(o,"MaxPoint",d=>Vv(K.create(),d))}get volumeType(){return this.encoding===ri.COMPRESSED_SEGMENTATION||this.encoding===ri.COMPRESSED_SEGMENTATIONARRAY?gt.SEGMENTATION:gt.IMAGE}getSources(e,t,r,i){let{encoding:a}=this,o=[],l=64;for(let c=0;c<this.numLevels;++c){let d=Math.pow(2,c),p=Math.pow(2,-c),m=K.create(),g=K.create();for(let T=0;T<3;++T){let I=Math.floor(this.lowerVoxelBound[T]*p);m[T]=I-I%l;let P=Math.ceil((this.upperVoxelBoundInclusive[T]+1)*p);g[T]=P,P%l!=0&&(g[T]+=l-P%l)}let v=t.dataInstanceKey;a!==ri.COMPRESSED_SEGMENTATIONARRAY&&c>0&&(v+="_"+c.toString());let b={baseUrl:t.baseUrl,nodeKey:t.nodeKey,dataInstanceKey:v,dataScale:c.toString(),encoding:a},x=ae.create();for(let T=0;T<3;++T)x[5*T]=d,x[12+T]=m[T]*d;let C=xi({rank:3,chunkToMultiscaleTransform:x,dataType:this.dataType,baseVoxelOffset:m,upperVoxelBound:K.subtract(K.create(),g,m),volumeType:this.volumeType,volumeSourceOptions:r,compressedSegmentationBlockSize:a===ri.COMPRESSED_SEGMENTATION||a===ri.COMPRESSED_SEGMENTATIONARRAY?K.fromValues(8,8,8):void 0}).map(T=>({chunkSource:e.getChunkSource(P1,{spec:T,parameters:b,credentialsProvider:i}),chunkToMultiscaleTransform:x}));o.push(C)}return Mr(o)}};function pH(n,e,t){Z(n);let r=W(n,"Base",i=>new E1(i));switch(r.typeName){case"uint8blk":case"grayscale8":let i=r.compressionName.indexOf("jpeg")!==-1;return new sp(n,e,r,i?ri.JPEG:ri.RAW,t);case"labels64":case"labelblk":return new sp(n,e,r,ri.COMPRESSED_SEGMENTATION,t);case"labelarray":case"labelmap":return new sp(n,e,r,ri.COMPRESSED_SEGMENTATIONARRAY,t);default:throw new Error(`DVID data type ${JSON.stringify(r.typeName)} is not supported.`)}}var lp=class{constructor(e){this.errors=[];this.dataInstances=new Map;this.vnodes=new Set;if(e instanceof lp){this.alias=e.alias,this.description=e.description,this.errors=e.errors,this.dataInstances=e.dataInstances;return}Z(e),this.alias=W(e,"Alias",Q),this.description=W(e,"Description",Q);let t=W(e,"DataInstances",Z),r=Object.keys(t);for(let o of r)try{this.dataInstances.set(o,pH(t[o],o,r))}catch(l){let c=`Failed to parse data instance ${JSON.stringify(o)}: ${l.message}`;console.log(c),this.errors.push(c)}let i=W(e,"DAG",Z),a=W(i,"Nodes",Z);for(let o of Object.keys(a))this.vnodes.add(o)}};function fH(n){try{let e=Za(n,r=>new lp(r)),t=new Map;for(let[r,i]of e){t.set(r,i);for(let a of i.vnodes)if(a!==r){let o=new lp(i);t.set(a,o)}}for(let[r,i]of t)i.uuid=r;return t}catch(e){throw new Error(`Failed to parse DVID repositories info: ${e.message}`)}}var M1=class{constructor(e){this.repositories=fH(e)}getNode(e){let t=[];for(let r of this.repositories.keys())r.startsWith(e)&&t.push(r);if(t.length!==1)throw new Error(`Node key ${JSON.stringify(e)} matches ${JSON.stringify(t)} nodes.`);return this.repositories.get(t[0])}};function R1(n,e,t){return n.memoize.getUncounted({type:"dvid:getServerInfo",baseUrl:e},()=>{let r=k1(t,{url:`${e}/api/repos/info`,method:"GET",responseType:"json"}).then(a=>new M1(a)),i=`repository info for DVID server ${e}`;return Ce.forPromise(r,{initialMessage:`Retrieving ${i}.`,delay:!0,errorPrefix:`Error retrieving ${i}: `}),r})}var _1=class extends zt{constructor(e,t,r,i,a,o){super(e);this.baseUrl=t;this.nodeKey=r;this.dataInstanceKey=i;this.info=a;this.credentialsProvider=o}get dataType(){return this.info.dataType}get volumeType(){return this.info.volumeType}get rank(){return 3}getSources(e){return this.info.getSources(this.chunkManager,{baseUrl:this.baseUrl,nodeKey:this.nodeKey,dataInstanceKey:this.dataInstanceKey},e,this.credentialsProvider)}},hH=/^((?:http|https):\/\/[^\/]+)\/([^\/]+)\/([^\/]+)(\?.*)?$/;function V1(n){if(n.startsWith("https"))return n+"/api/server/token"}function mH(n){let e=n.match(hH);if(e===null)throw new Error(`Invalid DVID URL: ${JSON.stringify(n)}.`);let t={baseUrl:e[1],nodeKey:e[2],dataInstanceKey:e[3]},r=e[4];if(r&&r.length>1){let i=ci(r.substring(1));i.user&&(t.user=i.user)}return t.authServer=V1(t.baseUrl),t}function gH(n,e,t,r){let i=e.baseUrl,a=e.nodeKey,o=e.dataInstanceKey,l=t,c={lowerBounds:new Float64Array(l.lowerVoxelBound),upperBounds:Float64Array.from(l.upperVoxelBoundInclusive,g=>g+1)},d=Be({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(l.voxelSize,g=>g/1e9),boundingBoxes:[Yn(c)]}),p=new _1(n.chunkManager,i,a,o,l,r),m={modelTransform:xt(d),subsources:[{id:"default",subsource:{volume:p},default:!0}]};if(l.meshSrc){let g=ae.create();for(let v=0;v<3;++v)g[5*v]=1/l.voxelSize[v];m.subsources.push({id:"meshes",default:!0,subsource:{mesh:n.chunkManager.getChunkSource(A1,{parameters:{...e,dataInstanceKey:l.meshSrc},credentialsProvider:r})},subsourceToModelSubspaceTransform:g})}return l.skeletonSrc&&m.subsources.push({id:"skeletons",default:!0,subsource:{mesh:n.chunkManager.getChunkSource(I1,{parameters:{...e,dataInstanceKey:l.skeletonSrc},credentialsProvider:r})}}),m.subsources.push({id:"bounds",subsource:{staticAnnotations:Pn(c)},default:!0}),m}function yH(n){let e=mH(n.providerUrl),{baseUrl:t,nodeKey:r,dataInstanceKey:i}=e;return n.chunkManager.memoize.getUncounted({type:"dvid:MultiscaleVolumeChunkSource",baseUrl:t,nodeKey:r,dataInstanceKey:i},async()=>{let a=n.credentialsManager.getCredentialsProvider(op,{dvidServer:e.baseUrl,authServer:e.authServer}),l=(await R1(n.chunkManager,t,a)).getNode(r);if(l===void 0)throw new Error(`Invalid node: ${JSON.stringify(r)}.`);let c=l.dataInstances.get(i);if(!(c instanceof sp))throw new Error(`Invalid data instance ${i}.`);return gH(n,e,c,a)})}function vH(n,e){return{offset:0,completions:on(e,n.dataInstances.values(),t=>t.name,t=>`${t.base.typeName}`)}}function SH(n,e){let t=e.match(/^(?:([^\/]+)(?:\/([^\/]*))?)?$/);if(t===null)throw new Error("Invalid DVID URL syntax.");if(t[2]===void 0)return{offset:0,completions:on(e,n.repositories.values(),a=>a.uuid+"/",a=>`${a.alias}: ${a.description}`)};let r=t[1],i=n.getNode(r);return Br(r.length+1,vH(i,t[2]))}async function bH(n){let e=/^((?:http|https):\/\/[^\/]+)\/([^\?]*).*$/,r=n.providerUrl.match(e);if(r===null)throw null;let i=r[1],a=r[2],o=V1(i),l=await R1(n.chunkManager,i,n.credentialsManager.getCredentialsProvider(op,{dvidServer:i,authServer:o}));return Br(i.length+1,SH(l,a))}var Xb=class extends Ut{constructor(e){super();this.credentialsManager=e}get description(){return"DVID"}get(e){return yH(e)}completeUrl(e){return bH(e)}};async function xH(n,e=at){return{token:await $i(n,{method:"GET",credentials:"include"},Kb,e)}}var O1=class extends An{constructor(e){super();this.authServer=e;this.get=or(e=>{if(!this.authServer)return Promise.resolve({token:""});let t=new Ce(!0),r;return new Promise((i,a)=>{let o=()=>{r=void 0,t.dispose()};e.add(()=>{r!==void 0&&(r.cancel(),r=void 0,t.dispose(),a(Kn))});function l(d,p="DVID authorization required.",m="Request authorization."){t.setText(p+" ");let g=document.createElement("button");g.textContent=m,t.element.appendChild(g),g.addEventListener("click",()=>{let v=d.match(/^[^\/]+\/\/[^\/\.]+\.([^\/]+)/);if(v){let b=`https://flyemlogin.${v[1]}/login`;window.alert(`Please log into ${b} and then refresh the neurogalncer page to try again.
If you are unable to log into ${b}, please check your authorization server ${d} to make sure it is correct.`)}else window.alert(`Please check your authorization server ${d} to make sure it is correct.`)}),t.setVisible(!0)}function c(d){r!==void 0&&r.cancel(),r=new vr,l(d,"Waiting for DVID authorization...","Retry"),xH(d,r).then(p=>{r!==void 0&&(o(),i(p))},p=>{r!==void 0&&(r=void 0,l(d,`DVID authorization failed: ${p}.`,"Retry"))})}c(this.authServer)})})}},Qb=class extends Wb{constructor(e,t){super(new O1(t),{})}};sr.register(op,n=>new Qb(n.dvidServer,n.authServer));Ot("dvid",n=>new Xb(n.credentialsManager));var N1=class{},B1=class extends N1{},Rm=class extends B1{};Rm.RPC_ID="render/TileChunkSource";var CH=new Set(["jpg","raw16"]),wH=lt(Hn,Rm),U1=class extends wH{},TH=new Set(["COMPLETE","READ_ONLY"]),LH=new Set(["LOADING"]);function kH(n){let e=ge(n,Z);if(e.length<1)throw new Error("No stacks found for owner object.");let t=new Map,r=W(e[0],"stackId",DH);for(let i of e){let a=W(i,"stackId",EH),o=PH(i);if(o!==void 0){let l=o.project,c=t.get(l);if(c===void 0){let d=new Map;t.set(l,{stacks:d}),c=t.get(l)}c.stacks.set(a,o)}}return{owner:r,projects:t}}function EH(n){return Z(n),W(n,"stack",Q)}function DH(n){return Z(n),W(n,"owner",Q)}function PH(n){Z(n);let e=W(n,"state",Q),t=[],r=K.create(),i=K.create();if(TH.has(e)){let l=W(n,"stats",Z);r=AH(l),i=IH(l),l.hasOwnProperty("channelNames")&&(t=MH(l))}else if(!LH.has(e))return;let a=W(n,"currentVersion",RH),o=W(n,"stackId",_H);return{lowerVoxelBound:r,upperVoxelBound:i,voxelResolution:a,project:o,channels:t}}function IH(n){Z(n);let e=W(n,"stackBounds",Z),t=K.create();return t[0]=W(e,"maxX",vn)+1,t[1]=W(e,"maxY",vn)+1,t[2]=W(e,"maxZ",vn)+1,t}function AH(n){Z(n);let e=W(n,"stackBounds",Z),t=K.create();return t[0]=W(e,"minX",vn),t[1]=W(e,"minY",vn),t[2]=W(e,"minZ",vn),t}function MH(n){return Z(n),W(n,"channelNames",e=>ge(e,Q))}function RH(n){Z(n);let e=K.create();try{e[0]=W(n,"stackResolutionX",vn),e[1]=W(n,"stackResolutionY",vn),e[2]=W(n,"stackResolutionZ",vn)}catch(t){e[0]=1,e[1]=1,e[2]=1}return e}function _H(n){return Z(n),W(n,"project",Q)}var F1=class extends zt{constructor(e,t,r,i,a,o,l){super(e);this.baseUrl=t;this.ownerInfo=r;this.project=a;this.parameters=l;let c=r.projects.get(a);if(c===void 0)throw new Error(`Specified project ${JSON.stringify(a)} does not exist for specified owner ${JSON.stringify(r.owner)}`);if(i===void 0){let g=Array.from(c.stacks.keys());if(g.length!==1)throw new Error(`Dataset contains multiple stacks: ${JSON.stringify(g)}`);i=g[0]}let d=c.stacks.get(i);if(d===void 0)throw new Error(`Specified stack ${JSON.stringify(i)} is not one of the supported stacks: `+JSON.stringify(Array.from(c.stacks.keys())));this.stack=i,this.stackInfo=d,o!==void 0&&o.length>0&&(this.channel=o),this.minIntensity=li(l.minIntensity),this.maxIntensity=li(l.maxIntensity),this.maxTileSpecsToRender=li(l.maxTileSpecsToRender),this.filter=hE(l.filter),this.minX=li(l.minX),this.minY=li(l.minY),this.minZ=li(l.minZ),this.maxX=li(l.maxX),this.maxY=li(l.maxY),this.maxZ=li(l.maxZ),this.minX!==void 0&&(d.lowerVoxelBound[0]=this.minX),this.minY!==void 0&&(d.lowerVoxelBound[1]=this.minY),this.minZ!==void 0&&(d.lowerVoxelBound[2]=this.minZ),this.maxX!==void 0&&(d.upperVoxelBound[0]=this.maxX),this.maxY!==void 0&&(d.upperVoxelBound[1]=this.maxY),this.maxZ!==void 0&&(d.upperVoxelBound[2]=this.maxZ);let p=Wt(l.encoding);if(p===void 0)p="jpg";else if(!CH.has(p))throw new Error(`Invalid encoding: ${JSON.stringify(p)}.`);this.encoding=p,this.numLevels=li(l.numlevels),this.dims=K.create();let m=li(l.tilesize);m===void 0&&(m=1024),this.dims[0]=m,this.dims[1]=m,this.dims[2]=1}get dataType(){return this.parameters.encoding==="raw16"?G.UINT16:G.UINT8}get volumeType(){return gt.IMAGE}get rank(){return 3}getSources(e){let t=[],r=this.numLevels;r===void 0&&(r=VH(this.stackInfo,this.dims[0]));let{lowerVoxelBound:i,upperVoxelBound:a}=this.stackInfo;for(let o=0;o<r;o++){let l=ae.create(),c=Uint32Array.of(1,1,1);for(let x=0;x<2;++x)l[5*x]=Math.pow(2,o),c[x]=this.dims[x];let d=K.create(),p=K.create(),m=K.create(),g=K.create();for(let x=0;x<3;x++){let C=l[5*x],T=m[x]=i[x]/C,I=g[x]=a[x]/C;d[x]=Math.floor(T),p[x]=Math.ceil(I)}let v=xm({rank:3,chunkDataSize:c,dataType:this.dataType,lowerVoxelBound:d,upperVoxelBound:p}),b=this.chunkManager.getChunkSource(U1,{spec:v,parameters:{baseUrl:this.baseUrl,owner:this.ownerInfo.owner,project:this.stackInfo.project,stack:this.stack,channel:this.channel,minIntensity:this.minIntensity,maxIntensity:this.maxIntensity,maxTileSpecsToRender:this.maxTileSpecsToRender,filter:this.filter,dims:`${this.dims[0]}_${this.dims[1]}`,level:o,encoding:this.encoding}});t.push([{chunkSource:b,chunkToMultiscaleTransform:l,lowerClipBound:m,upperClipBound:g}])}return Mr(t)}};function VH(n,e){let t=0;for(let i=0;i<2;i++)t=Math.max(t,n.upperVoxelBound[i]);if(e>=t)return 1;let r=0;for(;t>e;)t=t/2,r++;return r}function _m(n,e,t){return n.memoize.getUncounted({type:"render:getOwnerInfo",hostname:e,owner:t},()=>Yh(`${e}/render-ws/v1/owner/${t}/stacks`).then(r=>r.json()).then(kH))}var OH=/^([^\/?]+)(?:\/([^\/?]+))?(?:\/([^\/?]+))(?:\/([^\/?]*))?(?:\?(.*))?$/,G1=/^((?:(?:(?:http|https):\/\/[^,\/]+)[^\/?]))\/(.*)$/;function NH(n,e){let t,r;{let p=e.match(G1);if(p===null)throw new Error(`Invalid render volume path: ${JSON.stringify(e)}`);t=p[1],r=p[2]}let i=r.match(OH);if(i===null)throw new Error(`Invalid volume path ${JSON.stringify(r)}`);let a=i[1],o=i[2],l=i[3],c=i[4],d=ci(i[5]||"");return n.memoize.getUncounted({type:"render:MultiscaleVolumeChunkSource",hostname:t,path:r},async()=>{let p=await _m(n,t,a),m=new F1(n,t,p,l,o,c,d),g=Be({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(m.stackInfo.voxelResolution,b=>b/1e9),boundingBoxes:[Yn({lowerBounds:new Float64Array(m.stackInfo.lowerVoxelBound),upperBounds:new Float64Array(m.stackInfo.upperVoxelBound)})]});return{modelTransform:xt(g),subsources:[{id:"default",default:!0,subsource:{volume:m}},{id:"bounds",default:!0,subsource:{staticAnnotations:Pn(g.bounds)}}]}})}async function BH(n,e,t){let r=t.match(/^(?:([^\/]+)(?:\/([^\/]*))?(?:\/([^\/]*))?(\/.*?)?)?$/);if(r===null||r[2]===void 0)throw null;if(r[3]===void 0){let p=r[2]||"",m=await _m(n,e,r[1]),g=on(p,m.projects,v=>v[0]+"/",()=>{});return{offset:r[1].length+1,completions:g}}if(r[4]===void 0){let p=r[3]||"",g=(await _m(n,e,r[1])).projects.get(r[2]);if(g===void 0)throw null;let v=on(p,g.stacks,b=>b[0]+"/",b=>b[1].project);return{offset:r[1].length+r[2].length+2,completions:v}}let i=r[4].substr(1)||"",o=(await _m(n,e,r[1])).projects.get(r[2]);if(o===void 0)throw null;let l=o.stacks.get(r[3]);if(l===void 0)throw null;let c=l.channels;if(c.length===0)throw null;let d=on(i,c,p=>p,()=>{});return{offset:r[1].length+r[2].length+r[3].length+3,completions:d}}async function UH(n,e){let t=n.match(G1);if(t===null)throw null;let r=t[1],i=t[2],a=await BH(e,r,i);return Br(t[1].length+1,a)}var Zb=class extends Ut{get description(){return"Render"}get(e){return NH(e.chunkManager,e.providerUrl)}completeUrl(e){return UH(e.providerUrl,e.chunkManager)}};Ot("render",()=>new Zb);var cp;(function(a){a[a.RAW=0]="RAW",a[a.JPEG=1]="JPEG",a[a.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION",a[a.COMPRESSO=3]="COMPRESSO",a[a.PNG=4]="PNG"})(cp||(cp={}));var Vm=class{};Vm.RPC_ID="precomputed/VolumeChunkSource";var Om=class{};Om.RPC_ID="precomputed/MeshSource";var Nm=class{};Nm.RPC_ID="precomputed/HierarchicalMeshSource";var hs;(function(t){t[t.RAW=0]="RAW",t[t.GZIP=1]="GZIP"})(hs||(hs={}));var Kc;(function(t){t[t.IDENTITY=0]="IDENTITY",t[t.MURMURHASH3_X86_128=1]="MURMURHASH3_X86_128"})(Kc||(Kc={}));var Bm=class{};Bm.RPC_ID="precomputed/MultiscaleMeshSource";var Um=class{};Um.RPC_ID="precomputed/SkeletonSource";var Fm=class{};Fm.RPC_ID="precomputed/AnnotationSpatialIndexSource";var Gm=class{};Gm.RPC_ID="precomputed/AnnotationSource";var Wm=class{};Wm.RPC_ID="precomputed/IndexedSegmentPropertySource";function W1(n,e){return e=Math.imul(e,3432918353)>>>0,e=(e<<15|e>>>17)>>>0,e=Math.imul(e,461845907)>>>0,n^=e,n=(n<<13|n>>>19)>>>0,n=Math.imul(n,5)+3864292196>>>0,n}function FH(n,e){return n^=e,n^=n>>>16,n=Math.imul(n,2246822507)>>>0,n^=n>>>13,n*=3266489909,n^=n>>>16,n>>>0}function ex(n,e,t){let r=n;return r=W1(r,e),r=W1(r,t),FH(r,8)}var tx=class extends Gn{constructor(e,t){super(e,t);this.properties=t.properties}static encodeOptions(e){return{properties:e.properties}}};function GH(n,e,t){let r=n.length-1;for(;;){if(e=e&r,n[e]===0){n[e]=t;return}++e}}function zm(n,e){return e<=255?new Uint8Array(n):e<=65535?new Uint16Array(n):new Uint32Array(n)}function WH(n){let e=n.length/2,t=Math.ceil(Math.log2(e))+1,r=2**t,i=zm(r,e+1);for(let a=0;a<e;++a){let o=n[2*a],l=n[2*a+1];GH(i,ex(0,o,l),a+1)}return i}function zH(n,e,t,r){let i=ex(0,t,r),a=n.length-1;for(;;){i=i&a;let o=n[i];if(o===0)return-1;if(--o,e[2*o]===t&&e[2*o+1]===r)return o;++i}}var Hm=class{constructor(e){this.inlineProperties=e.inlineProperties}},z1=class{constructor(e){this.segmentPropertyMap=e;var r;let{inlineProperties:t}=e;t!==void 0&&(this.inlineIdToIndex=WH(t.ids)),this.tags=t==null?void 0:t.properties.find(i=>i.type==="tags"),this.labels=t==null?void 0:t.properties.find(i=>i.type==="label"),this.numericalProperties=(r=t==null?void 0:t.properties.filter(i=>i.type==="number"))!=null?r:[]}getSegmentInlineIndex(e){let{inlineIdToIndex:t}=this;return t===void 0?-1:zH(t,this.segmentPropertyMap.inlineProperties.ids,e.low,e.high)}getSegmentLabel(e){let t=this.getSegmentInlineIndex(e);if(t===-1)return;let{labels:r,tags:i}=this,a="";if(r!==void 0&&(a=r.values[t]),i!==void 0){let{tags:o,values:l}=i,c=l[t];for(let d=0,p=c.length;d<p;++d){let m=o[c.charCodeAt(d)];a.length>0&&(a+=" "),a+="#",a+=m}}if(a.length!==0)return a}};function H1(n,e,t){for(let r=0,i=t.length;r<i;++r)e[t[r]]=n[r]}function HH(n){let e=n.length;if(e===0)return!0;let t=n[0],r=n[1];for(let i=0;i<e;i+=2){let a=n[i],o=n[i+1];if((o-r||a-t)<=0)return!1;t=a,r=o}return!0}function $1(n){let{ids:e}=n;if(HH(e))return n;let t=e.length/2,r=zm(t,t-1);for(let o=0;o<t;++o)r[o]=o;r.sort((o,l)=>{let c=e[o*2],d=e[o*2+1],p=e[l*2],m=e[l*2+1];return d-m||c-p});let i=new Uint32Array(t*2);for(let o=0;o<t;++o){let l=r[o];i[o*2]=e[l*2],i[o*2+1]=e[l*2+1]}let a=n.properties.map(o=>{let{values:l}=o,c=new l.constructor(t);for(let d=0;d<t;++d)c[d]=l[r[d]];return{...o,values:c}});return{ids:i,properties:a}}function $H(n,e,t){let r=new Array(e);return r.fill(""),H1(n.values,r,t),{...n,values:r}}function jH(n,e,t){let r=new Float32Array(e);return r.fill(Number.NaN),H1(n.values,r,t),{...n,values:r}}function j1(n,e,t){let{type:r}=n;return r==="label"||r==="description"||r==="string"||r==="tags"?$H(n,e,t):jH(n,e,t)}function JH(n,e){if(n===void 0)return e;if(e===void 0)return n;let t=0,r=n.ids.length/2,i=e.ids.length/2,a=new Uint32Array(r),o=new Uint32Array(i),l=n.ids,c=e.ids;OL(r,i,(m,g)=>{let v=l[2*m+1],b=l[2*m],x=c[2*g+1],C=c[2*g];return v-x||b-C},m=>{a[m]=t,++t},m=>{o[m]=t,++t},(m,g)=>{a[m]=t,o[g]=t,++t});let d;if(t===r)d=l;else if(t===i)d=c;else{d=new Uint32Array(t*2);for(let m=0;m<r;++m){let g=a[m];d[2*g]=l[2*m],d[2*g+1]=l[2*m+1]}for(let m=0;m<i;++m){let g=o[m];d[2*g]=c[2*m],d[2*g+1]=c[2*m+1]}}let p=[];if(t===r)p.push(...n.properties);else for(let m of n.properties)p.push(j1(m,t,a));if(t===i)p.push(...e.properties);else for(let m of e.properties)p.push(j1(m,t,o));return{ids:d,properties:p}}function qH(n,e){return new Hm({inlineProperties:JH(n.inlineProperties,e.inlineProperties)})}function YH(n){for(;;){if(n.length===0)return;if(n.length===1)return n[0];let e=[];for(let t=0,r=n.length;t<r;t+=2)t+1===r?e.push(n[t]):e.push(qH(n[t],n[t+1]));n=e}}function J1(n,e){return n.memoize.getUncounted({id:"getPreprocessedSegmentPropertyMap",maps:e.map(t=>pt(t))},()=>{let t=YH(e);if(t!==void 0)return new z1(t)})}var KH=/^[,\s]*[0-9]+(?:[,\s]+[0-9]+)*[,\s]*$/;function q1(n,e){var p;if(e.match(KH)!==null){let m=e.split(/[\s,]+/),g=[],v=new Set;for(let b=0,x=m.length;b<x;++b){let C=m[b];if(C==="")continue;let T=new X;if(!T.tryParseString(C))continue;let I=T.toString();v.has(I)||(v.add(I),g.push(T))}return g.sort(X.compare),{ids:g}}let t={regexp:void 0,prefix:void 0,includeTags:[],excludeTags:[],numericalConstraints:[],sortBy:[],includeColumns:[]},r=(p=n==null?void 0:n.segmentPropertyMap.inlineProperties)==null?void 0:p.properties,i=n==null?void 0:n.tags,a=(i==null?void 0:i.tags)||[],o=a.map(m=>m.toLowerCase()),l=n==null?void 0:n.labels,c=[],d;for(let m=0;m<e.length;m=d){let g=e.indexOf(" ",m),v;if(g===-1?d=g=e.length:d=g+1,v=e.substring(m,g),v.length===0)continue;let b=(C,T)=>{let I=C.toLowerCase(),P=o.indexOf(I);if(P===-1){c.push({begin:T,end:g,message:`Invalid tag: ${C}`});return}if(C=a[P],t.includeTags.includes(C)||t.excludeTags.includes(C)){c.push({begin:T,end:g,message:`Duplicate tag: ${C}`});return}return C};if(v.startsWith("#")){let C=b(v.substring(1),m+1);C!==void 0&&t.includeTags.push(C);continue}if(v.startsWith("-#")){let C=b(v.substring(2),m+2);C!==void 0&&t.excludeTags.push(C);continue}if(v.startsWith("<")||v.startsWith(">")){let C=v.substring(1).toLowerCase();if(C!=="id"&&C!=="label"){let T=r==null?void 0:r.find(I=>I.id.toLowerCase()===C&&(I.type==="number"||I.type==="label"||I.type==="string"));if(T===void 0){c.push({begin:m+1,end:g,message:`Invalid field: ${C}`});continue}C=T.id}if(t.sortBy.find(T=>T.fieldId===C)!==void 0){c.push({begin:m+1,end:g,message:`Duplicate sort field: ${C}`});continue}t.sortBy.push({order:v[0],fieldId:C});continue}if(v.startsWith("|")){let C=v.substring(1).toLowerCase();if(C==="id"||C==="label")continue;let T=r==null?void 0:r.find(I=>I.id.toLowerCase()===C&&(I.type==="number"||I.type==="string"));if(T===void 0){c.push({begin:m+1,end:g,message:`Invalid field: ${C}`});continue}if(C=T.id,t.sortBy.find(I=>I.fieldId===C)||t.includeColumns.find(I=>I===C))continue;t.includeColumns.push(C);continue}if(v.startsWith("/")){if(t.regexp!==void 0){c.push({begin:m,end:g,message:"Only one regular expression allowed"});continue}if(t.prefix!==void 0){c.push({begin:m,end:g,message:"Prefix cannot be combined with regular expression"});continue}if(l===void 0){c.push({begin:m,end:g,message:"No label property"});continue}try{t.regexp=new RegExp(v.substring(1))}catch(C){c.push({begin:m,end:g,message:"Invalid regular expression syntax"})}continue}let x=v.match(/^([a-zA-Z][a-zA-Z0-9_]*)(<|<=|=|>=|>)([0-9.].*)$/);if(x!==null){let C=x[1].toLowerCase(),T=x[2],I=n==null?void 0:n.numericalProperties.find(B=>B.id.toLowerCase()===C);if(I===void 0){c.push({begin:m,end:m+C.length,message:`Invalid numerical field: ${C}`});continue}C=I.id;let P;try{P=eo(I.dataType,x[3])}catch(B){c.push({begin:m+x[1].length+x[2].length,end:g,message:B.message});continue}let M=t.numericalConstraints.find(B=>B.fieldId===C);M===void 0&&(M={fieldId:C,bounds:I.bounds},t.numericalConstraints.push(M));let D=Js(I.bounds,M.bounds[0]),E=Js(I.bounds,M.bounds[1]),V=E,O=D;switch(T){case"<":V=yd(I.dataType,P,-1);break;case"<=":V=P;break;case"=":V=O=P;break;case">=":O=P;break;case">":O=yd(I.dataType,P,1);break}if(O=yr(D,O)>0?D:O,V=yr(E,V)<0?E:V,yr(O,V)>0){c.push({begin:m,end:g,message:"Constraint would not match any values"});continue}M.bounds=[O,V];continue}if(t.regexp!==void 0){c.push({begin:m,end:g,message:"Prefix cannot be combined with regular expression"});continue}if(l===void 0){c.push({begin:m,end:g,message:"No label property"});continue}t.prefix!==void 0?t.prefix+=` ${v}`:t.prefix=v}return c.length>0?{errors:c}:(t.sortBy.length===0&&t.sortBy.push({fieldId:X1(n),order:"<"}),t)}function nx(n){return"\\u"+n.toString(16).padStart(4,"0")}function Y1(n,e){var T;if(e.errors!==void 0)return{query:e,total:-1,count:0,errors:e.errors};if(e.ids!==void 0){let{ids:I}=e;return{query:e,total:-1,explicitIds:I,count:I.length}}let t=(T=n==null?void 0:n.segmentPropertyMap)==null?void 0:T.inlineProperties;if(t===void 0)return{query:e,count:0,total:-1};let r=t==null?void 0:t.properties,i=t.ids.length/2,a=zm(i,i);for(let I=0;I<i;++I)a[I]=I;let o=I=>{let P=a.length,M=0;for(let D=0;D<P;++D){let E=a[D];I(E)&&(a[M]=E,++M)}a=a.subarray(0,M)};if(e.regexp!==void 0||e.prefix!==void 0){let I=n.labels.values,{regexp:P,prefix:M}=e;P!==void 0&&o(D=>I[D].match(P)!==null),M!==void 0&&o(D=>I[D].startsWith(M))}let{includeTags:l,excludeTags:c}=e,d=n.tags;if(l.length>0||c.length>0){let{values:I,tags:P}=d,M=[];for(let B of l)M.push([P.indexOf(B),1]);for(let B of c)M.push([P.indexOf(B),0]);M.sort((B,z)=>B[0]-z[0]);let D="^",E=0,V=B=>{B<E||(D+=`[${nx(E)}-${nx(B)}]*`)};for(let[B,z]of M)V(B-1),z&&(D+=nx(B)),E=B+1;V(65535),D+="$";let O=new RegExp(D);o(B=>I[B].match(O)!==null)}let p,m,{numericalConstraints:g}=e;if(g.length>0){let I=n.numericalProperties,P=g.length,M=2**P-1;p=zm(a.length,M);for(let V=0;V<P;++V){let O=g[V],B=I.find(J=>J.id===O.fieldId),{values:z}=B,_=2**V,[U,N]=O.bounds;for(let J=0,ie=a.length;J<ie;++J){let pe=z[a[J]];p[J]|=_*(pe>=U&&pe<=N)}}m=a,a=m.slice();let D=a.length,E=0;for(let V=0;V<D;++V)p[V]===M&&(a[E]=a[V],++E);a=a.subarray(0,E)}let v=[];if(d!==void 0){let I=[],{tags:P,values:M}=d,D=new Uint32Array(P.length);for(let E=0,V=a.length;E<V;++E){let O=M[a[E]];for(let B=0,z=O.length;B<z;++B)++D[O.charCodeAt(B)]}for(let E=0,V=P.length;E<V;++E){let O=D[E],B=P[E],z={tag:B,tagIndex:E,count:D[E]};e.includeTags.includes(B)||e.excludeTags.includes(B)?I.push(z):O>0&&v.push(z)}I.push(...v),v=I}let b=(I,P)=>{if(I.type!=="number"){let{values:M}=I;a.sort((D,E)=>fo(M[D],M[E])*P)}else{let M=I.values;a.sort((D,E)=>(M[D]-M[E])*P)}},x=I=>{d!==void 0&&b(d,I);let P=n==null?void 0:n.labels;P!==void 0&&b(P,I)},{sortBy:C}=e;for(let I=C.length-1;I>=0;--I){let{fieldId:P,order:M}=C[I],D=M==="<"?1:-1;if(P==="id"){if(I+1===C.length){if(M==="<")continue;a.reverse();continue}a.sort((E,V)=>D*(E-V));continue}else P==="label"?x(D):b(r.find(E=>E.id===P),D)}return{query:e,intermediateIndices:m,intermediateIndicesMask:p,indices:a,tags:v,count:a.length,total:i}}function XH(n,e,t){let r=256,{values:i}=e,[a,o]=t,l=o<=a?0:r/(o-a),c=new Uint32Array(r+2),{numericalConstraints:d}=n.query,p=d.findIndex(m=>m.fieldId===e.id);if(p===-1){let m=n.indices;for(let g=0,v=m.length;g<v;++g){let b=i[m[g]];isNaN(b)||++c[Math.min(r-1,Math.max(-1,(b-a)*l))+1>>>0]}}else{let m=n.intermediateIndices,g=n.intermediateIndicesMask,v=2**d.length-1-2**p;for(let b=0,x=m.length;b<x;++b)if((g[b]&v)==v){let T=i[m[b]];isNaN(T)||++c[Math.min(r-1,Math.max(-1,(T-a)*l))+1>>>0]}}return{queryResult:n,histogram:c,window:t}}function K1(n,e,t,r){if(n===void 0){t.length=0,r.length=0;return}let{numericalProperties:i}=n,a=i.length;if((e==null?void 0:e.indices)===void 0){t.length=0;return}for(let l=0;l<a;++l){let c=t[l],d=r[l],p=i[l];c!==void 0&&c.queryResult===e&&ui(p.dataType,c.window,d)||(t[l]=XH(e,p,d))}}function X1(n){return(n==null?void 0:n.tags)||(n==null?void 0:n.labels)?"label":"id"}function Q1(n,e){let{ids:t}=e;if(t!==void 0)return t.map(l=>l.toString()).join(", ");let r="";e=e;let{prefix:i,regexp:a}=e;i!==void 0?r=i:a!==void 0&&(r=`/${a}`);for(let l of e.includeTags)r.length>0&&(r+=" "),r+=`#${l}`;for(let l of e.excludeTags)r.length>0&&(r+=" "),r+=`-#${l}`;for(let l of e.numericalConstraints){let{fieldId:c,bounds:d}=l,[p,m]=d,g=n.numericalProperties.find(v=>v.id===c);if(!ui(g.dataType,g.bounds,d)){if(yr(p,m)===0){r.length>0&&(r+=" "),r+=`${c}=${p}`;continue}if(yr(p,g.bounds[0])>0){r.length>0&&(r+=" ");let v=yd(g.dataType,p,-1),b=p.toString(),x=v.toString();g.dataType!==G.FLOAT32||b.length<=x.length?r+=`${c}>=${b}`:r+=`${c}>${x}`}if(yr(m,g.bounds[1])<0){r.length>0&&(r+=" ");let v=yd(g.dataType,m,1),b=m.toString(),x=v.toString();g.dataType!==G.FLOAT32||b.length<=x.length?r+=`${c}<=${b}`:r+=`${c}<${x}`}}}let{sortBy:o}=e;if(o.length===1){let l=o[0];l.order==="<"&&l.fieldId===X1(n)&&(o=[])}for(let l of o)r.length>0&&(r+=" "),r+=`${l.order}${l.fieldId}`;for(let l of e.includeColumns)r.length>0&&(r+=" "),r+=`|${l}`;return r}var rx=new X;function up(n,e,t){if(e===void 0)return;let{explicitIds:r}=e;if(r!==void 0){r.forEach(t);return}let{indices:i}=e;if(i!==void 0){let{ids:a}=n==null?void 0:n.segmentPropertyMap.inlineProperties;for(let o=0,l=i.length;o<l;++o){let c=i[o];rx.low=a[c*2],rx.high=a[c*2+1],t(rx,o)}}}function Z1(n,e,t){if(t.size===0)return 0;let r=0;return up(n,e,i=>{t.has(i)&&++r}),r}function ix(n,e,t,r){let i=n.includeTags.filter(o=>o!==e),a=n.excludeTags.filter(o=>o!==e);return r===!0&&(t?i:a).push(e),{...n,includeTags:i,excludeTags:a}}function eA(n){return n.ids!==void 0?!1:n.errors!==void 0?!0:!(n.numericalConstraints.length>0||n.includeTags.length>0||n.excludeTags.length>0||n.prefix||n.regexp)}function $m(n,e){if(n===void 0||n.ids!==void 0||n.errors!==void 0)return!1;let{sortBy:t,includeColumns:r}=n;return t.find(i=>i.fieldId===e)!==void 0||r.includes(e)}async function QH(n,e,t,r,i){let a=await Ia(n,`https://www.googleapis.com/storage/v1/b/${e}/o?delimiter=${encodeURIComponent(r)}&prefix=${encodeURIComponent(t)}&neuroglancerOrigin=${encodeURIComponent(location.origin)}`,{},bt,i);Z(a);let o=oe(a,"prefixes",qt,[]),l=oe(a,"items",c=>ge(c,d=>(Z(d),W(d,"name",Q))),[]).filter(c=>!c.endsWith("_$folder$"));return[...o,...l]}async function tA(n,e,t,r,i){if(!r.startsWith("/"))throw null;let o=await QH(n,t,r.substring(1),"/",i),l=r.lastIndexOf("/");return{offset:l+e.length+1,completions:o.map(c=>({value:c.substring(l)}))}}async function ZH(n,e,t,r,i){let a=await Ia(n,`${e}?prefix=${encodeURIComponent(t)}&delimiter=${encodeURIComponent(r)}`,{},p=>p.text(),i),o=new DOMParser().parseFromString(a,"application/xml"),l=o.evaluate('//*[name()="CommonPrefixes"]/*[name()="Prefix"]',o,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),c=[];for(let p=0,m=l.snapshotLength;p<m;++p)c.push(l.snapshotItem(p).textContent||"");let d=o.evaluate('//*[name()="Contents"]/*[name()="Key"]',o,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null);for(let p=0,m=d.snapshotLength;p<m;++p)c.push(d.snapshotItem(p).textContent||"");return c}async function dp(n,e,t,r,i){if(!r.startsWith("/"))throw null;let o=await ZH(n,t,r.substring(1),"/",i),l=r.lastIndexOf("/");return{offset:l+e.length+1,completions:o.map(c=>({value:c.substring(l)}))}}async function nA(n,e,t,r,i=at){return await $i(`https://${n}.s3.amazonaws.com${e}`,t,r,i)}async function rA(n,e,t){return await dp(void 0,`s3://${n}`,`https://${n}.s3.amazonaws.com`,e,t)}function e$(n,e){return n.getCredentialsProvider("middleauthapp",new URL(e).origin)}function jm(n,e,t){let r=/^\/([^\/]+)/,i=t.match(r);if(i!==null)return typeof NEUROGLANCER_PYTHON_INTEGRATION!="undefined"?n.getCredentialsProvider("gcs",{bucket:i[1]}):n.getCredentialsProvider("ngauth_gcs",{authServer:e,bucket:i[1]})}function Tn(n,e){let t=ml(n);switch(t.protocol){case"gs":case"gs+xml":return{credentialsProvider:typeof NEUROGLANCER_PYTHON_INTEGRATION!="undefined"?e.getCredentialsProvider("gcs",{bucket:t.host}):void 0,url:n};case"gs+ngauth+http":return{credentialsProvider:jm(e,`http://${t.host}`,t.path),url:"gs:/"+t.path};case"gs+ngauth+https":return{credentialsProvider:jm(e,`https://${t.host}`,t.path),url:"gs:/"+t.path};case"gs+xml+ngauth+http":return{credentialsProvider:jm(e,`http://${t.host}`,t.path),url:"gs+xml:/"+t.path};case"gs+xml+ngauth+https":return{credentialsProvider:jm(e,`https://${t.host}`,t.path),url:"gs+xml:/"+t.path};case"middleauth+https":return n=n.substr("middleauth+".length),{credentialsProvider:e$(e,n),url:n};case"s3":return{credentialsProvider:void 0,url:n};default:return{credentialsProvider:void 0,url:n}}}async function Mn(n,e,t,r,i=at){let a=ml(e);switch(a.protocol){case"gs":return Ia(n,`https://www.googleapis.com/storage/v1/b/${a.host}/o/${encodeURIComponent(a.path.substring(1))}?alt=media&neuroglancer=${di()}`,t,r,i);case"gs+xml":return Ia(n,`https://storage.googleapis.com/${a.host}${a.path}?neuroglancer=${di()}`,t,r,i);case"s3":return nA(a.host,a.path,t,r,i);default:return Ia(n,e,t,r,i)}}async function t$(n,e,t){let{text:r,contentType:i}=await Mn(t,n,{headers:{accept:"text/html"}},async c=>({text:await c.text(),contentType:c.headers.get("content-type")}),e);if(i===null||/\btext\/html\b/i.exec(i)===null)return[];let a=new DOMParser().parseFromString(r,"text/html"),o=a.evaluate("//a/@href",a,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),l=[];for(let c=0,d=o.snapshotLength;c<d;++c){let m=o.snapshotItem(c).textContent;m&&l.push(new URL(m,n).toString())}return l}async function n$(n,e,t){console.log("getHtmlPathCompletions");let r=n.match(/^([a-z]+:\/\/.*\/)([^\/?#]*)$/);if(r===null)throw null;let i=await t$(r[1],e,t),a=r[1].length,o=[];for(let l of i)!l.startsWith(n)||o.push({value:l.substring(a)});return{offset:a,completions:o}}var r$=[{value:"gs://",description:"Google Cloud Storage (JSON API)"},{value:"gs+xml://",description:"Google Cloud Storage (XML API)"},{value:"gs+ngauth+http://",description:"Google Cloud Storage (JSON API) authenticated via ngauth"},{value:"gs+ngauth+https://",description:"Google Cloud Storage (JSON API) authenticated via ngauth"},{value:"gs+xml+ngauth+http://",description:"Google Cloud Storage (XML API) authenticated via ngauth"},{value:"gs+xml+ngauth+https://",description:"Google Cloud Storage (XML API) authenticated via ngauth"},{value:"s3://",description:"Amazon Simple Storage Service (S3)"},{value:"https://"},{value:"http://"}];async function Ci(n,e,t){if(!e.includes("://"))return{offset:0,completions:on(e,r$,m=>m.value,m=>m.description)};let{url:r,credentialsProvider:i}=Tn(e,n),a=e.length-r.length,o;try{o=ml(r)}catch{throw null}let{protocol:l,host:c,path:d}=o,p=await(async()=>{if(l==="gs+xml"&&d.length>0)return await dp(i,`${l}://${c}`,`https://storage.googleapis.com/${c}`,d,t);if(l==="gs"&&d.length>0)return await tA(i,`${l}://${c}`,c,d,t);if(l==="s3"&&d.length>0)return await rA(c,d,t);let m=r.match(/^((?:http|https):\/\/(?:storage\.googleapis\.com\/[^\/]+|[^\/]+\.storage\.googleapis\.com|[^\/]+\.s3(?:[^./]+)?\.amazonaws.com))(\/.*)$/);if(m!==null)return await dp(i,m[1],m[1],m[2],t);if((l==="http"||l==="https")&&d.length>0)return await n$(r,t,i);throw null})();return{offset:a+p.offset,completions:p.completions}}var iA=class extends lt(ct()(Hn),Vm){},aA=class extends lt(ct()(tr),Om){},oA=class extends lt(ct()(tr),Nm){},sA=class extends lt(ct()(mo),Bm){},lA=class extends lt(ct()(go),Um){get skeletonVertexCoordinatesInVoxels(){return!1}get vertexAttributes(){return this.parameters.metadata.vertexAttributes}};function Va(n,e){let t=n.split("/");for(let r of e.split("/")){if(r===".."&&t.length!==0){t.length=t.length-1;continue}t.push(r)}return t.join("/")}var cA=class{constructor(e,t){Z(e);let r=t===1?3:4,i=this.resolution=new Float64Array(r),a=this.voxelOffset=new Float32Array(r),o=this.size=new Float32Array(r);if(r===4&&(i[3]=1,o[3]=t),W(e,"resolution",c=>Ne(i.subarray(0,3),c,it)),oe(e,"voxel_offset",c=>Ne(a.subarray(0,3),c,rt)),W(e,"size",c=>Ne(o.subarray(0,3),c,St)),this.chunkSizes=W(e,"chunk_sizes",c=>ge(c,d=>{let p=new Uint32Array(r);return r===4&&(p[3]=t),Ne(p.subarray(0,3),d,St),p})),this.chunkSizes.length===0)throw new Error("No chunk sizes specified.");if(this.sharding=W(e,"sharding",qm),this.sharding!==void 0&&this.chunkSizes.length!==1)throw new Error("Sharding requires a single chunk size per scale");(this.encoding=W(e,"encoding",c=>Mt(c,cp)))===cp.COMPRESSED_SEGMENTATION&&(this.compressedSegmentationBlockSize=W(e,"compressed_segmentation_block_size",c=>Ne(K.create(),c,St))),this.key=W(e,"key",Q)}};function ax(n){Z(n);let e=W(n,"data_type",T=>Mt(T,G)),t=W(n,"num_channels",St),r=W(n,"type",T=>Mt(T,gt)),i=W(n,"mesh",Wt),a=W(n,"skeletons",Wt),o=W(n,"segment_properties",Wt),l=W(n,"scales",T=>ge(T,I=>new cA(I,t)));if(l.length===0)throw new Error("Expected at least one scale");let c=l[0],d=t===1?3:4,p=new Float64Array(d),m=new Float64Array(d),g=new Float64Array(d),v=["x","y","z"],b=["m","m","m"];for(let T=0;T<3;++T)p[T]=c.resolution[T]/1e9,m[T]=c.voxelOffset[T],g[T]=m[T]+c.size[T];d===4&&(p[3]=1,g[3]=t,v[3]="c^",b[3]="");let C=Be({rank:d,names:v,units:b,scales:p,boundingBoxes:[Yn({lowerBounds:m,upperBounds:g})]});return{dataType:e,volumeType:r,mesh:i,skeletons:a,segmentPropertyMap:o,scales:l,modelSpace:C}}var Jm=class extends zt{constructor(e,t,r,i){super(e);this.credentialsProvider=t;this.url=r;this.info=i}get dataType(){return this.info.dataType}get volumeType(){return this.info.volumeType}get rank(){return this.info.modelSpace.rank}getSources(e){let t=this.info.scales[0].resolution,{rank:r}=this;return Mr(this.info.scales.map(i=>{let{resolution:a}=i,o=r+1,l=new Float32Array(o*o);l[l.length-1]=1;let{lowerBounds:c,upperBounds:d}=this.info.modelSpace.boundingBoxes[0].box,p=new Float32Array(r),m=new Float32Array(r);for(let g=0;g<3;++g){let v=a[g]/t[g];l[o*g+g]=v;let b=i.voxelOffset[g];l[o*r+g]=b*v,p[g]=c[g]/v-b,m[g]=d[g]/v-b}return r===4&&(l[o*3+3]=1,p[3]=c[3],m[3]=d[3]),xi({rank:r,dataType:this.dataType,chunkToMultiscaleTransform:l,upperVoxelBound:i.size,volumeType:this.volumeType,chunkDataSizes:i.chunkSizes,baseVoxelOffset:i.voxelOffset,compressedSegmentationBlockSize:i.compressedSegmentationBlockSize,volumeSourceOptions:e}).map(g=>({chunkSource:this.chunkManager.getChunkSource(iA,{credentialsProvider:this.credentialsProvider,spec:g,parameters:{url:Va(this.url,i.key),encoding:i.encoding,sharding:i.sharding}}),chunkToMultiscaleTransform:l,lowerClipBound:p,upperClipBound:m}))}))}},i$=lt(ct()(Hi),Gm),uA=class extends lt(ct()(hl),Fm){},dA=class extends i${constructor(e,t){let{parameters:r}=t;super(e,{rank:r.rank,relationships:r.relationships.map(i=>i.name),properties:r.properties,parameters:r});this.readonly=!0,this.metadata=t.metadata,this.credentialsProvider=t.credentialsProvider}getSources(){return[this.metadata.spatialIndices.map(e=>{let{spec:t}=e;return{chunkSource:this.chunkManager.getChunkSource(uA,{credentialsProvider:this.credentialsProvider,parent:this,spec:t,parameters:e.parameters}),chunkToMultiscaleTransform:t.chunkToMultiscaleTransform}})]}};function a$(n,e,t){return n.getChunkSource(aA,{parameters:t,credentialsProvider:e})}function o$(n,e,t){return n.getChunkSource(oA,{parameters:t,credentialsProvider:e})}function ox(n){return W(n,"transform",e=>{let t=ae.create();return e!==void 0&&Ne(t.subarray(0,12),e,Qe),ae.transpose(t,t),t})}function s$(n){Z(n);let e=W(n,"@type",Q),t;if(e==="neuroglancer_legacy_mesh")t=void 0;else if(e==="neuroglancer_legacy_mesh_hierarchical"){let a=W(n,"hierarchy_size",St),o=0,l=ox(n);t={lodScaleMultiplier:o,transform:l,sharding:void 0,vertexQuantizationBits:a}}else{if(e!=="neuroglancer_multilod_draco")throw new Error(`Unsupported mesh type: ${JSON.stringify(e)}`);{let i=W(n,"lod_scale_multiplier",it),a=W(n,"vertex_quantization_bits",St),o=ox(n),l=W(n,"sharding",qm);t={lodScaleMultiplier:i,transform:o,sharding:l,vertexQuantizationBits:a}}}let r=W(n,"segment_properties",Wt);return{metadata:t,segmentPropertyMap:r}}async function l$(n,e,t){let r;try{r=await Xc(n,e,t)}catch(i){if(ji(i))return{metadata:void 0};throw i}return s$(r)}function pA(n){return n===void 0?hs.RAW:Mt(n,hs)}function qm(n){if(n===void 0)return;Z(n);let e=W(n,"@type",Q);if(e!=="neuroglancer_uint64_sharded_v1")throw new Error(`Unsupported sharding format: ${JSON.stringify(e)}`);let t=W(n,"hash",c=>Mt(c,Kc)),r=W(n,"preshift_bits",rt),i=W(n,"shard_bits",rt),a=W(n,"minishard_bits",rt),o=W(n,"minishard_index_encoding",pA),l=W(n,"data_encoding",pA);return{hash:t,preshiftBits:r,shardBits:i,minishardBits:a,minishardIndexEncoding:o,dataEncoding:l}}function c$(n){Z(n);let e=W(n,"@type",Q);if(e!=="neuroglancer_skeletons")throw new Error(`Unsupported skeleton type: ${JSON.stringify(e)}`);let t=ox(n),r=new Map;W(n,"vertex_attributes",o=>{o!==void 0&&ge(o,l=>{Z(l);let c=W(l,"id",Q);if(c==="")throw new Error("vertex attribute id must not be empty");if(r.has(c))throw new Error(`duplicate vertex attribute id ${JSON.stringify(c)}`);let d=W(l,"data_type",m=>Mt(m,G)),p=W(l,"num_components",St);r.set(c,{dataType:d,numComponents:p})})});let i=W(n,"sharding",qm),a=W(n,"segment_properties",Wt);return{metadata:{transform:t,vertexAttributes:r,sharding:i},segmentPropertyMap:a}}async function u$(n,e,t){let r=await Xc(n,e,t);return c$(r)}function fA(){return Be({names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)})}async function hA(n,e,t){let{metadata:r,segmentPropertyMap:i}=await l$(n,e,t);if(r===void 0)return{source:a$(n,e,{url:t,lod:0}),transform:ae.create(),segmentPropertyMap:i};let{vertexQuantizationBits:a}=r;if(a>100)return{source:o$(n,e,{url:t,hierarchySize:a}),transform:r.transform,segmentPropertyMap:i};let o;if(a===10)o=gi.uint10;else if(a===16)o=gi.uint16;else throw new Error(`Invalid vertex quantization bits: ${a}`);return{source:n.getChunkSource(sA,{credentialsProvider:e,parameters:{url:t,metadata:r},format:{fragmentRelativeVertices:!0,vertexPositionFormat:o}}),transform:r.transform,segmentPropertyMap:i}}async function mA(n,e,t){let{metadata:r,segmentPropertyMap:i}=await u$(n,e,t);return{source:n.getChunkSource(lA,{credentialsProvider:e,parameters:{url:t,metadata:r}}),transform:r.transform,segmentPropertyMap:i}}function Xc(n,e,t){return n.memoize.getUncounted({type:"precomputed:metadata",url:t,credentialsProvider:pt(e)},async()=>await Mn(e,`${t}/info`,{},bt))}function gA(n){let e=ae.create(),t=n.scales[0].resolution;for(let r=0;r<3;++r)e[5*r]=1/t[r];return e}async function d$(n,e,t,r){let i=ax(r),a=new Jm(n.chunkManager,e,t,i),{modelSpace:o}=i,l=[{id:"default",default:!0,subsource:{volume:a}},{id:"bounds",default:!0,subsource:{staticAnnotations:Pn(o.bounds)}}];if(i.segmentPropertyMap!==void 0){let c=Va(t,i.segmentPropertyMap),d=await Xc(n.chunkManager,e,c),p=Qc(n.chunkManager,e,d,c);l.push({id:"properties",default:!0,subsource:{segmentPropertyMap:p}})}if(i.mesh!==void 0){let c=Va(t,i.mesh),{source:d,transform:p}=await hA(n.chunkManager,e,c),m=gA(i);ae.multiply(m,m,p),l.push({id:"mesh",default:!0,subsource:{mesh:d},subsourceToModelSubspaceTransform:m})}if(i.skeletons!==void 0){let c=Va(t,i.skeletons),{source:d,transform:p}=await mA(n.chunkManager,e,c),m=gA(i);ae.multiply(m,m,p),l.push({id:"skeletons",default:!0,subsource:{mesh:d},subsourceToModelSubspaceTransform:m})}return{modelTransform:xt(o),subsources:l}}async function p$(n,e,t){let{source:r,transform:i,segmentPropertyMap:a}=await mA(n.chunkManager,e,t),o=[{id:"default",default:!0,subsource:{mesh:r},subsourceToModelSubspaceTransform:i}];if(a!==void 0){let l=Va(t,a),c=await Xc(n.chunkManager,e,l),d=Qc(n.chunkManager,e,c,l);o.push({id:"properties",default:!0,subsource:{segmentPropertyMap:d}})}return{modelTransform:xt(fA()),subsources:o}}function sx(n,e){return Z(e),{url:Va(n,W(e,"key",Q)),sharding:W(e,"sharding",qm)}}var yA=class{constructor(e,t){this.url=e;Z(t);let r=W(t,"dimensions",kd),{rank:i}=r,a=W(t,"lower_bound",l=>Ne(new Float64Array(i),l,Qe)),o=W(t,"upper_bound",l=>Ne(new Float64Array(i),l,Qe));this.coordinateSpace=Be({rank:i,names:r.names,units:r.units,scales:r.scales,boundingBoxes:[Yn({lowerBounds:a,upperBounds:o})]}),this.parameters={type:W(t,"annotation_type",l=>Mt(l,Oe)),rank:i,relationships:W(t,"relationships",l=>ge(l,c=>{let d=sx(e,c),p=W(c,"id",Q);return{...d,name:p}})),properties:W(t,"properties",lh),byId:W(t,"by_id",l=>sx(e,l))},this.spatialIndices=W(t,"spatial",l=>ge(l,c=>{let d=sx(e,c),p=W(c,"grid_shape",C=>Ne(new Float32Array(i),C,St)),m=W(c,"chunk_size",C=>Ne(new Float32Array(i),C,it)),g=W(c,"limit",St),v=new Float32Array(i);for(let C=0;C<i;++C)v[C]=p[C]*m[C];let b=Yt(Float32Array,i+1);for(let C=0;C<i;++C)b[(i+1)*i+C]=a[C];let x={limit:g,chunkToMultiscaleTransform:b,...Jo({rank:i,chunkDataSize:m,upperVoxelBound:v})};return x.upperChunkBound=p,{parameters:d,spec:x,limit:g}})),this.spatialIndices.reverse()}};async function f$(n,e,t,r){let i=new yA(t,r);return{modelTransform:xt(i.coordinateSpace),subsources:[{id:"default",default:!0,subsource:{annotation:n.chunkManager.getChunkSource(dA,{credentialsProvider:e,metadata:i,parameters:i.parameters})}}]}}async function vA(n,e,t){let{source:r,transform:i,segmentPropertyMap:a}=await hA(n.chunkManager,e,t),o=[{id:"default",default:!0,subsource:{mesh:r},subsourceToModelSubspaceTransform:i}];if(a!==void 0){let l=Va(t,a),c=await Xc(n.chunkManager,e,l),d=Qc(n.chunkManager,e,c,l);o.push({id:"properties",default:!0,subsource:{segmentPropertyMap:d}})}return{modelTransform:xt(fA()),subsources:o}}function h$(n){Z(n);let e=new X,t=W(n,"ids",a=>{a=qt(a);let o=a.length,l=new Uint32Array(o*2);for(let c=0;c<o;++c){if(!e.tryParseString(a[c]))throw new Error(`Invalid uint64 id: ${JSON.stringify(a[c])}`);l[2*c]=e.low,l[2*c+1]=e.high}return l}),r=t.length/2,i=W(n,"properties",a=>ge(a,o=>{Z(o);let l=W(o,"id",Q),c=oe(o,"description",Q),d=W(o,"type",m=>{if(m!=="label"&&m!=="description"&&m!=="string"&&m!=="tags"&&m!=="number")throw new Error(`Invalid property type: ${JSON.stringify(m)}`);return m});if(d==="tags"){let m=W(o,"tags",qt),g=oe(o,"tag_descriptions",qt);if(g===void 0)g=new Array(m.length),g.fill("");else if(g.length!==m.length)throw new Error(`Expected tag_descriptions to have length: ${m.length}`);let v=W(o,"values",b=>{if(!Array.isArray(b)||b.length!==r)throw new Error(`Expected ${r} values, but received: ${b.length}`);return b.map(x=>String.fromCharCode(...x))});return{id:l,description:c,type:d,tags:m,tagDescriptions:g,values:v}}if(d==="number"){let m=W(o,"data_type",x=>Mt(x,G));if(m===G.UINT64)throw new Error("uint64 properties not supported");let g=W(o,"values",x=>{if(!Array.isArray(x)||x.length!==r)throw new Error(`Expected ${r} values, but received: ${x.length}`);return Qf[m].from(x)}),v=Infinity,b=-Infinity;for(let x=g.length-1;x>=0;--x){let C=g[x];C<v&&(v=C),C>b&&(b=C)}return{id:l,description:c,type:d,dataType:m,values:g,bounds:[v,b]}}let p=W(o,"values",m=>{if(qt(m),m.length!==r)throw new Error(`Expected ${r} values, but received: ${m.length}`);return m});return{id:l,description:c,type:d,values:p}}));return $1({ids:t,properties:i})}var wce=lt(ct()(tx),Wm);function Qc(n,e,t,r){try{let i=W(t,"@type",Q);if(i!=="neuroglancer_segment_properties")throw new Error(`Unsupported segment property map type: ${JSON.stringify(i)}`);let a=oe(t,"inline",h$);return new Hm({inlineProperties:a})}catch(i){throw new Error(`Error parsing segment property map: ${i.message}`)}}async function m$(n,e,t,r){return{modelTransform:xt(Oi),subsources:[{id:"default",default:!0,subsource:{segmentPropertyMap:Qc(n.chunkManager,e,r,t)}}]}}var g$=/^([^#]*)(?:#(.*))?$/;function pp(n){let[,e,t]=n.match(g$);e.endsWith("/")&&(e=e.substring(0,e.length-1));let r=ci(t||"");return{url:e,parameters:r}}function SA(n,e){let t=mE(e);return t&&(n+=`#${t}`),n}var fp=class extends Ut{get description(){return"Precomputed file-backed data source"}normalizeUrl(e){let{url:t,parameters:r}=pp(e.providerUrl);return e.providerProtocol+"://"+SA(t,r)}convertLegacyUrl(e){let{url:t,parameters:r}=pp(e.providerUrl);return e.type==="mesh"&&(r.type="mesh"),e.providerProtocol+"://"+SA(t,r)}get(e){let{url:t,parameters:r}=pp(e.providerUrl);return e.chunkManager.memoize.getUncounted({type:"precomputed:get",providerUrl:t,parameters:r},async()=>{let{url:i,credentialsProvider:a}=Tn(t,e.credentialsManager),o;try{o=await Xc(e.chunkManager,a,i)}catch(d){if(ji(d)&&r.type==="mesh")return await vA(e,a,i);throw d}Z(o);let l=oe(o,"redirect",Q);if(l!==void 0)throw new Uc(l);let c=oe(o,"@type",Q);switch(c){case"neuroglancer_skeletons":return await p$(e,a,i);case"neuroglancer_multilod_draco":case"neuroglancer_legacy_mesh":case"neuroglancer_legacy_mesh_hierarchical":return await vA(e,a,i);case"neuroglancer_annotations_v1":return await f$(e,a,i,o);case"neuroglancer_segment_properties":return await m$(e,a,i,o);case"neuroglancer_multiscale_volume":case void 0:return await d$(e,a,i,o);default:throw new Error(`Invalid type: ${JSON.stringify(c)}`)}})}completeUrl(e){return Ci(e.credentialsManager,e.providerUrl,e.cancellationToken)}};Ot("precomputed",()=>new fp);var bA="nifti/getNiftiVolumeInfo",Ym=class{};Ym.RPC_ID="nifti/VolumeChunkSource";var xA=class extends lt(ct()(Hn),Ym){},CA=class extends zt{constructor(e,t,r,i){super(e);this.credentialsProvider=t;this.url=r;this.info=i}get dataType(){return this.info.dataType}get volumeType(){return gt.UNKNOWN}get rank(){return this.info.rank}getSources(e){let{info:t}=this,r=Yt(Float32Array,t.rank+1),i=Bb({rank:t.rank,volumeType:gt.UNKNOWN,chunkDataSize:t.volumeSize,dataType:t.dataType,upperVoxelBound:Float32Array.from(t.volumeSize),chunkToMultiscaleTransform:r,volumeSourceOptions:e});return[[{chunkSource:this.chunkManager.getChunkSource(xA,{credentialsProvider:this.credentialsProvider,spec:i,parameters:{url:this.url}}),chunkToMultiscaleTransform:r}]]}};function y$(n,e,t,r){return n.rpc.promiseInvoke(bA,{chunkManager:n.addCounterpartRef(),credentialsProvider:jd(n,e),url:t},r)}function v$(n,e,t){return n.memoize.getUncounted({type:"nifti/getVolume",url:t},async()=>{let{url:r,credentialsProvider:i}=Tn(t,e),a=await y$(n,i,r,at),o=new CA(n,i,r,a),l={lowerBounds:new Float64Array(a.rank),upperBounds:Float64Array.from(a.volumeSize)},c=Be({rank:a.rank,names:a.sourceNames,scales:a.sourceScales,units:a.units,boundingBoxes:[Yn(l)]}),d=Be({rank:a.rank,names:a.viewNames,scales:a.viewScales,units:a.units});return{subsources:[{id:"default",default:!0,subsource:{volume:o}},{id:"bounds",default:!0,subsource:{staticAnnotations:Pn(l)}}],modelTransform:{sourceRank:a.rank,rank:a.rank,inputSpace:c,outputSpace:d,transform:a.transform}}})}var lx=class extends Ut{get description(){return"Single NIfTI file"}get(e){return v$(e.chunkManager,e.credentialsManager,e.providerUrl)}completeUrl(e){return Ci(e.credentialsManager,e.providerUrl,e.cancellationToken)}};Ot("nifti",()=>new lx);var hp;(function(r){r[r.RAW=0]="RAW",r[r.GZIP=1]="GZIP",r[r.BLOSC=2]="BLOSC"})(hp||(hp={}));var Km=class{};Km.RPC_ID="n5/VolumeChunkSource";var wA=class extends lt(ct()(Hn),Km){},TA=class extends zt{constructor(e,t,r,i){super(e);this.credentialsProvider=t;this.multiscaleMetadata=r;this.scales=i;let a,o;if(i.forEach((m,g)=>{if(m!==void 0){if(o===void 0&&(o=g),a!==void 0&&m.dataType!==a)throw new Error(`Scale s${g} has data type ${G[m.dataType]} but expected ${G[a]}.`);a=m.dataType}}),a===void 0)throw new Error("At least one scale must be specified.");let l=r.scales[o],c=i[o];this.dataType=a,this.volumeType=gt.IMAGE,this.baseScaleIndex=o;let d=r.modelSpace,{rank:p}=d;this.modelSpace=Be({names:d.names,scales:d.scales,units:d.units,boundingBoxes:[{transform:wd(Float64Array,l.downsamplingFactor,!1),box:{lowerBounds:new Float64Array(p),upperBounds:new Float64Array(c.size)}}],coordinateArrays:d.coordinateArrays})}get rank(){return this.modelSpace.rank}getSources(e){let{}=this,{scales:t,rank:r}=this,i=this.multiscaleMetadata.scales;return Mr(t.filter(a=>a!==void 0).map((a,o)=>{let l=i[o],c=wd(Float32Array,l.downsamplingFactor);if(a.offset!==void 0&&a.resolution!==void 0)for(o=0;o<a.offset.length;o++)c[12+o]=a.offset[o]/a.resolution[o]*l.downsamplingFactor[o];return xi({rank:r,chunkToMultiscaleTransform:c,dataType:a.dataType,upperVoxelBound:a.size,volumeType:this.volumeType,chunkDataSizes:[a.chunkSize],volumeSourceOptions:e}).map(d=>({chunkSource:this.chunkManager.getChunkSource(wA,{credentialsProvider:this.credentialsProvider,spec:d,parameters:{url:l.url,encoding:a.encoding}}),chunkToMultiscaleTransform:c}))}))}},LA=class{constructor(e){Z(e),this.dataType=W(e,"dataType",r=>Mt(r,G)),this.size=Float32Array.from(W(e,"dimensions",r=>ge(r,St))),this.chunkSize=W(e,"blockSize",r=>Ne(new Uint32Array(this.size.length),r,St)),this.offset=oe(e,"offset",r=>Ne(new Int32Array(this.size.length),r,rt)),this.resolution=oe(e,"resolution",r=>Ne(new Uint32Array(this.size.length),r,St));let t;oe(e,"compression",r=>{t=W(r,"type",i=>Mt(i,hp))}),t===void 0&&(t=W(e,"compressionType",r=>Mt(r,hp))),this.encoding=t}};function S$(n,e,t){return Promise.all(t.scales.map(async r=>{let i=await kA(n,e,r.url,!0);if(i!==void 0)return new LA(i)}))}function b$(n){let{protocol:e,host:t,path:r}=ml(n);r.endsWith("/")&&(r=r.substring(0,r.length-1));let i=[];for(;;){i.push(`${e}://${t}${r}/attributes.json`);let a=r.lastIndexOf("/");if(a===-1)break;r=r.substring(0,a)}return i}function x$(n,e,t,r){return n.memoize.getUncounted({type:"n5:attributes.json",url:t,credentialsProvider:pt(e)},()=>Mn(e,t,{},bt).then(i=>{try{return Z(i)}catch(a){throw new Error(`Error reading attributes from ${t}: ${a.message}`)}}).catch(i=>{if(ji(i))return r?void 0:{};throw i}))}async function kA(n,e,t,r){let i=b$(t),a=await Promise.all(i.map((o,l)=>x$(n,e,o,r&&l===i.length-1)));if(a.indexOf(void 0)===-1)return a.reverse(),Object.assign({},...a)}function ms(n,e){if(n!==-1&&e!==n)throw new Error(`Rank mismatch, received ${e} but expected ${n}`);return e}function EA(n){return Float64Array.from(ge(n,it))}function DA(n){let e=Yr(n);if(e.length===0)throw new Error("Expected non-empty array");let t=-1;return{all:ge(e,i=>{let a=EA(i);return t=ms(t,a.length),a}),single:void 0,rank:t}}function C$(n){let e=Yr(n);if(e.length===0)throw new Error("Expected non-empty array");if(Array.isArray(e[0]))return DA(e);let t=EA(n);return{all:void 0,single:t,rank:t.length}}var w$=["x","y","z","t","c"];function T$(n){let e=w$.slice(0,n);for(;e.length<n;)e.push(`d${e.length+1}`);return e}function L$(n,e){Z(e);let t=-1,r=oe(e,"resolution",g=>{let v=Float64Array.from(ge(g,it));return t=ms(t,v.length),v}),i=oe(e,"axes",g=>{let v=ge(g,Q);return t=ms(t,v.length),v}),a=oe(e,"units",g=>{let v=ge(g,Ch);return t=ms(t,v.length),v}),o={unit:"m",exponent:-9},l,c;oe(e,"downsamplingFactors",g=>{let{single:v,all:b,rank:x}=C$(g);t=ms(t,x),v!==void 0&&(l=v),b!==void 0&&(c=b)}),oe(e,"pixelResolution",g=>{o=W(g,"unit",Ch),oe(g,"dimensions",v=>{r=Float64Array.from(ge(v,it)),t=ms(t,r.length)})}),oe(e,"scales",g=>{let{all:v,rank:b}=DA(g);t=ms(t,b),c=v});let d=oe(e,"dimensions",g=>{let v=ge(g,St);return t=ms(t,v.length),v});if(t===-1)throw new Error("Unable to determine rank of dataset");a===void 0&&(a=new Array(t),a.fill(o)),r===void 0&&(r=new Float64Array(t),r.fill(1));for(let g=0;g<t;++g)r[g]=Ld(r[g],a[g].exponent);let p=new Array(t);i!==void 0&&oe(e,"coordinateArrays",g=>{Z(g);for(let v=0;v<t;++v){let b=i[v];if(Object.prototype.hasOwnProperty.call(g,b)){let x=qt(g[b]);p[v]={explicit:!1,labels:x,coordinates:Array.from(x,(C,T)=>T)},a[v]={unit:"",exponent:0},r[v]=1}}}),i===void 0&&(i=T$(t));let m=Be({rank:t,valid:!0,names:i,scales:r,units:a.map(g=>g.unit),coordinateArrays:p});if(d===void 0){if(c===void 0)throw new Error("Not valid single-resolution or multi-resolution dataset");return{modelSpace:m,url:n,attributes:e,scales:c.map((g,v)=>({url:`${n}/s${v}`,downsamplingFactor:g}))}}return l===void 0&&(l=new Float64Array(t),l.fill(1)),{modelSpace:m,url:n,attributes:e,scales:[{url:n,downsamplingFactor:l}]}}var cx=class extends Ut{get description(){return"N5 data source"}get(e){let{providerUrl:t}=e;return t.endsWith("/")&&(t=t.substring(0,t.length-1)),e.chunkManager.memoize.getUncounted({type:"n5:MultiscaleVolumeChunkSource",providerUrl:t},async()=>{let{url:r,credentialsProvider:i}=Tn(t,e.credentialsManager),a=await kA(e.chunkManager,i,r,!1),o=L$(r,a),l=await S$(e.chunkManager,i,o),c=new TA(e.chunkManager,i,o,l);return{modelTransform:xt(c.modelSpace),subsources:[{id:"default",default:!0,url:void 0,subsource:{volume:c}},{id:"bounds",default:!0,url:void 0,subsource:{staticAnnotations:Pn(c.modelSpace.bounds)}}]}})}completeUrl(e){return Ci(e.credentialsManager,e.providerUrl,e.cancellationToken)}};Ot("n5",()=>new cx);var El;(function(r){r[r.RAW=0]="RAW",r[r.GZIP=1]="GZIP",r[r.BLOSC=2]="BLOSC"})(El||(El={}));var Xm=class{};Xm.RPC_ID="zarr/VolumeChunkSource";var k$=new Set(["0.4","0.5-dev","0.5"]),PA=new Map([["angstrom",{unit:"m",scale:1e-10}],["foot",{unit:"m",scale:.3048}],["inch",{unit:"m",scale:.0254}],["mile",{unit:"m",scale:1609.34}],["parsec",{unit:"m",scale:30856775814913670}],["yard",{unit:"m",scale:.9144}],["minute",{unit:"s",scale:60}],["hour",{unit:"s",scale:60*60}],["day",{unit:"s",scale:60*60*24}]]);for(let n of["meter","second"])for(let e of Qv){let{longPrefix:t}=e;t!==void 0&&PA.set(`${t}${n}`,{unit:n[0],scale:Math.pow(10,e.exponent)})}function E$(n){Z(n);let e=W(n,"name",Q),t=oe(n,"type",Q),r=oe(n,"unit",i=>{let a=PA.get(i);if(a===void 0)throw new Error(`Unsupported unit: ${JSON.stringify(i)}`);return a},{unit:"",scale:1});return{name:e,unit:r.unit,scale:r.scale,type:t}}function D$(n){let e=ge(n,E$);return Be({names:e.map(t=>{let{name:r,type:i}=t;return i==="channel"?`${r}'`:r}),scales:Float64Array.from(e,t=>t.scale),units:e.map(t=>t.unit)})}function P$(n,e){let t=W(e,"scale",r=>Ne(new Float64Array(n),r,it));return wd(Float64Array,t)}function I$(n,e){return Yt(Float64Array,n+1)}function A$(n,e){let t=W(e,"translation",r=>Ne(new Float64Array(n),r,Qe));return ME(Float64Array,t)}var M$=new Map([["scale",P$],["identity",I$],["translation",A$]]);function R$(n,e){Z(e);let t=W(e,"type",Q),r=M$.get(t);if(r===void 0)throw new Error(`Unsupported coordinate transform type: ${JSON.stringify(t)}`);return r(n,e)}function IA(n,e){let t=Yt(Float64Array,n+1);return e===void 0||ge(e,r=>{let i=R$(n,r);t=pi(new Float64Array(t.length),n+1,i,n+1,t,n+1,n+1,n+1,n+1)}),t}function _$(n,e,t){let r=W(t,"path",Q),i=W(t,"coordinateTransformations",o=>IA(n,o));return{url:`${e}/${r}`,transform:i}}function V$(n,e){let t=W(e,"axes",D$),r=t.rank,i=W(e,"coordinateTransformations",c=>IA(r,c)),a=W(e,"datasets",c=>ge(c,d=>{let p=_$(r,n,d);return p.transform=pi(new Float64Array((r+1)**2),r+1,i,r+1,p.transform,r+1,r+1,r+1,r+1),p}));if(a.length===0)throw new Error("At least one scale must be specified");let o=a[0].transform,l=new Float64Array(r);for(let c=0;c<r;++c){let d=l[c]=o[c*(r+1)+c];t.scales[c]*=d}for(let c of a){let d=c.transform;for(let p=0;p<r;++p)for(let m=0;m<=r;++m)d[m*(r+1)+p]/=l[p]}return{coordinateSpace:t,scales:a}}function AA(n,e){let t=e.multiscales;if(!Array.isArray(t))return;let r=[];for(let i of t){if(typeof i!="object"||i==null||Array.isArray(i))return;let a=i.version;if(a===void 0)return;if(!k$.has(a)){r.push(`OME multiscale metadata version ${JSON.stringify(a)} is not supported`);continue}return V$(n,i)}if(r.length!==0)throw new Error(r[0])}var yo=new Map;yo.set("|u1",{endianness:yn.LITTLE,dataType:G.UINT8});yo.set("|i1",{endianness:yn.LITTLE,dataType:G.INT8});for(let[n,e]of[["<",yn.LITTLE],[">",yn.BIG]]){for(let t of["u","i"])yo.set(`${n}${t}8`,{endianness:e,dataType:G.UINT64});yo.set(`${n}u2`,{endianness:e,dataType:G.UINT16}),yo.set(`${n}i2`,{endianness:e,dataType:G.INT16}),yo.set(`${n}u4`,{endianness:e,dataType:G.UINT32}),yo.set(`${n}i4`,{endianness:e,dataType:G.INT32}),yo.set(`${n}f4`,{endianness:e,dataType:G.FLOAT32})}function MA(n){let e=yo.get(n);if(e===void 0)throw new Error(`Unsupported numpy data type: ${JSON.stringify(n)}`);return e}var RA=class extends lt(ct()(Hn),Xm){};function _A(n){return oe(n,"dimension_separator",e=>{if(e!=="."&&e!=="/")throw new Error(`Expected "." or "/", but received: ${JSON.stringify(e)}`);return e})}function O$(n){try{Z(n),W(n,"zarr_format",d=>{if(d!==2)throw new Error(`Expected 2 but received: ${JSON.stringify(d)}`)});let e=W(n,"shape",d=>ge(d,p=>{if(typeof p!="number"||!Number.isInteger(p)||p<0)throw new Error(`Expected non-negative integer, but received: ${JSON.stringify(p)}`);return p})),t=W(n,"chunks",d=>Ne(new Array(e.length),d,p=>{if(typeof p!="number"||!Number.isInteger(p)||p<=0)throw new Error(`Expected positive integer, but received: ${JSON.stringify(p)}`);return p})),r=W(n,"order",d=>{if(d!=="C"&&d!=="F")throw new Error(`Expected "C" or "F", but received: ${JSON.stringify(d)}`);return d}),i=_A(n),a=W(n,"dtype",d=>MA(Q(d))),o=W(n,"compressor",d=>{if(d===null)return El.RAW;Z(d);let p=W(d,"id",Q);switch(p){case"blosc":return El.BLOSC;case"gzip":return El.GZIP;case"zlib":return El.GZIP;default:throw new Error(`Unsupported compressor: ${JSON.stringify(p)}`)}}),l=a.dataType,c=W(n,"fill_value",d=>{if(d!==null)switch(l){case G.FLOAT32:return d==="NaN"?Number.NaN:d==="Infinity"?Number.POSITIVE_INFINITY:d==="-Infinity"?Number.NEGATIVE_INFINITY:vn(d);default:return rt(d)}});return{rank:e.length,shape:e,chunks:t,order:r,dataType:l,encoding:{compressor:o,endianness:a.endianness},fillValue:c,dimensionSeparator:i}}catch(e){throw new Error(`Error parsing zarr metadata: ${e.message}`)}}function N$(n,e){let t=oe(e,"_ARRAY_DIMENSIONS",r=>Ne(new Array(n),r,Q));t=new Array(n);for(let r=0;r<n;++r)t[r]=`d${r}`;return t}var VA=class extends zt{constructor(e,t,r){super(e);this.credentialsProvider=t;this.multiscale=r;this.volumeType=gt.IMAGE}get dataType(){return this.multiscale.dataType}get modelSpace(){return this.multiscale.coordinateSpace}get rank(){return this.multiscale.coordinateSpace.rank}getSources(e){return Mr(this.multiscale.scales.map(t=>{let{metadata:r}=t,{rank:i,chunks:a,shape:o}=r,l,c,d;if(r.order==="F")l=Uint32Array.from(a),c=Float32Array.from(o),d=Yt(Float32Array,i+1);else{l=new Uint32Array(i),c=new Float32Array(i),d=new Float32Array((i+1)**2),d[(i+1)**2-1]=1;for(let m=0;m<i;++m)l[m]=a[i-1-m],c[m]=o[i-1-m],d[m+(i-1-m)*(i+1)]=1}let p=new Float32Array((i+1)**2);return pi(p,i+1,t.transform,i+1,d,i+1,i+1,i+1,i+1),xi({rank:i,chunkToMultiscaleTransform:p,dataType:r.dataType,upperVoxelBound:c,volumeType:this.volumeType,chunkDataSizes:[l],volumeSourceOptions:e,fillValue:r.fillValue}).map(m=>({chunkSource:this.chunkManager.getChunkSource(RA,{credentialsProvider:this.credentialsProvider,spec:m,parameters:{url:t.url,encoding:r.encoding,separator:t.dimensionSeparator,order:r.order}}),chunkToMultiscaleTransform:p}))}))}};function B$(n,e,t){return n.memoize.getUncounted({type:"zarr:.zattrs json",url:t,credentialsProvider:pt(e)},async()=>{try{let r=await Mn(e,t+"/.zattrs",{},bt);return Z(r),r}catch(r){if(ji(r))return{};throw r}})}function OA(n,e,t,r=!0){return n.memoize.getUncounted({type:"zarr:.zarray json",url:t,credentialsProvider:pt(e)},async()=>{try{let i=await Mn(e,t+"/.zarray",{},bt);return O$(i)}catch(i){if(r&&ji(i))return;throw i}})}var U$=[{key:{value:"dimension_separator",description:"Dimension separator in chunk keys"},values:[{value:".",description:"(default)"},{value:"/",description:""}]}];function F$(n,e,t,r){let i=N$(t.rank,r),a=Be({names:i,scales:Float64Array.from(t.shape,()=>1),units:Array.from(t.shape,()=>""),boundingBoxes:[Yn({lowerBounds:new Float64Array(t.rank),upperBounds:Float64Array.from(t.shape)})]}),o=Yt(Float64Array,t.rank+1);return{coordinateSpace:a,dataType:t.dataType,scales:[{url:n,transform:o,metadata:t,dimensionSeparator:NA(n,e,t.dimensionSeparator)}]}}function NA(n,e,t){var r;if(t!==void 0&&e!==void 0&&t!==e)throw new Error(`Explicitly specified dimension separator ${JSON.stringify(e)} does not match value in ${n}/.zarray ${JSON.stringify(t)}`);return(r=t!=null?t:e)!=null?r:"."}async function G$(n,e,t,r){let i=await Promise.all(r.scales.map(x=>OA(n,e,x.url,!1))),a=i[0].dataType,o=i.length,l=r.coordinateSpace.rank;for(let x=0;x<o;++x){let C=r.scales[x],T=i[x];if(T.rank!==l)throw new Error(`Expected zarr array at ${JSON.stringify(C.url)} to have rank ${l}, but received: ${T.rank}`);if(T.dataType!==a)throw new Error(`Expected zarr array at ${JSON.stringify(C.url)} to have data type ${G[a]}, but received: ${G[T.dataType]}`)}let c=new Float64Array(l),d=new Float64Array(l),p=r.scales[0],m=i[0];for(let x=0;x<l;++x){let C=c[x]=p.transform[(l+1)*l+x];d[x]=C+m.shape[x]}let g=Yn({lowerBounds:c,upperBounds:d}),{coordinateSpace:v}=r;return{coordinateSpace:Be({names:v.names,units:v.units,scales:v.scales,boundingBoxes:[g]}),dataType:a,scales:r.scales.map((x,C)=>{let T=i[C];return{url:x.url,transform:x.transform,metadata:T,dimensionSeparator:NA(x.url,t,T.dimensionSeparator)}})}}var ux=class extends Ut{get description(){return"Zarr data source"}get(e){let[,t,r]=e.providerUrl.match(/([^?]*)(?:\?(.*))?$/),i=ci(r||"");Z(i);let a=_A(i);return t.endsWith("/")&&(t=t.substring(0,t.length-1)),e.chunkManager.memoize.getUncounted({type:"zarr:MultiscaleVolumeChunkSource",providerUrl:t,dimensionSeparator:a},async()=>{let{url:o,credentialsProvider:l}=Tn(t,e.credentialsManager),[c,d]=await Promise.all([OA(e.chunkManager,l,o),B$(e.chunkManager,l,o)]),p;if(c===void 0){let g=AA(o,d);if(g===void 0)throw new Error("Neither .zarray metadata nor OME multiscale metadata found");p=await G$(e.chunkManager,l,a,g)}else p=F$(o,a,c,d);let m=new VA(e.chunkManager,l,p);return{modelTransform:xt(m.modelSpace),subsources:[{id:"default",default:!0,url:void 0,subsource:{volume:m}},{id:"bounds",default:!0,url:void 0,subsource:{staticAnnotations:Pn(m.modelSpace.bounds)}}]}})}async completeUrl(e){let[,,t]=e.providerUrl.match(/([^?]*)(?:\?(.*))?$/);return t!==void 0?Br(e.providerUrl.length-t.length,await jh(t,U$)):await Ci(e.credentialsManager,e.providerUrl,e.cancellationToken)}};Ot("zarr",()=>new ux);var BA="single_mesh/SingleMeshLayer",UA="single_mesh/getSingleMeshInfo",Qm="",FA=class{},Zm=class extends FA{};Zm.RPC_ID="single_mesh/SingleMeshSource";var GA=class extends j{constructor(e){super();this.gl=e;this.buffer=this.registerDisposer(new Bt(e))}resize(e){let t;if(e<256){let r=t=new Uint8Array(e);for(let i=0;i<e;++i)r[i]=i;this.webglType=WebGL2RenderingContext.UNSIGNED_BYTE}else if(e<65536){let r=t=new Uint16Array(e);for(let i=0;i<e;++i)r[i]=i;this.webglType=WebGL2RenderingContext.UNSIGNED_SHORT}else{let r=t=new Uint32Array(e);for(let i=0;i<e;++i)r[i]=i;this.webglType=WebGL2RenderingContext.UNSIGNED_INT}this.buffer.setData(t),this.length=e}ensure(e){return(this.length===void 0||this.length<e)&&this.resize(e),this}bindToVertexAttrib(e){this.buffer.bindToVertexAttribI(e,1,this.webglType)}bind(e,t=0){let r=e.attribute("aIndexRaw");r>=0&&(this.bindToVertexAttrib(r),t!==0&&this.gl.vertexAttribDivisor(r,t))}};function WA(n,e,t=!1){let r=e.attribute("aIndexRaw");r>=0&&(t&&n.vertexAttribDivisor(r,0),n.disableVertexAttribArray(r))}function zA(n){return n.memoize.get("IndexBuffer",()=>new GA(n))}function HA(n){n.addAttribute("highp uint","aIndexRaw"),n.addVertexCode(tl),n.addVertexCode(`
uint getPrimitiveIndex() {
  return aIndexRaw;
}
`)}var dx=class{constructor(e){this.name=e}defineShader(e){e.addAttribute("highp uint",this.name)}bind(e,t){let r=t.attribute(this.name);e.bindToVertexAttribI(r,1,WebGL2RenderingContext.UNSIGNED_INT)}disable(e){e.gl.disableVertexAttribArray(e.attribute(this.name))}};function $A(n,e){return Bt.fromData(n,e,WebGL2RenderingContext.ARRAY_BUFFER,WebGL2RenderingContext.STATIC_DRAW)}var jA=`void main() {
  emitGray();
}
`,px=class{constructor(){this.shaderError=Sa();this.fragmentMain=Yo(jA);this.shaderControlState=new co(this.fragmentMain)}};function fx(n){return _t(n.dataType,n.numComponents)}var Dl=[],JA=yi(new Ji,G.FLOAT32,3),W$=JA;function z$(n){return n.split(/[^a-zA-Z0-9]+/).filter(e=>e).join("_")}function hx(n){let e=new Set,t=[];for(let r of n){let i=z$(r),a="",o=0;for(;e.has(i+a);)a=""+ ++o;t.push(i+a)}return t}var qA=class{constructor(e,t){this.attributeNames=e;this.attributeInfo=t;this.tempLightVec=new Float32Array(4);this.textureAccessHelper=new ho("vertexData");this.indexBufferHelper=new dx("vertexIndex")}defineAttributeAccess(e,t){let{textureAccessHelper:r}=this;r.defineShader(e);let{attributeNames:i}=this,a=2+i.length;for(let l=Dl.length;l<a;++l)Dl[l]=Symbol(`SingleMeshShaderManager.vertexAttributeTextureUnit${l}`);a=0,e.addTextureSampler("sampler2D","uVertexAttributeSampler0",Dl[a++]),e.addTextureSampler("sampler2D","uVertexAttributeSampler1",Dl[a++]),e.addVertexCode(r.getAccessor("readVertexPosition","uVertexAttributeSampler0",G.FLOAT32,3)),e.addVertexCode(r.getAccessor("readVertexNormal","uVertexAttributeSampler1",G.FLOAT32,3));let o=`
vec3 vertexPosition = readVertexPosition(${t});
vec3 vertexNormal = readVertexNormal(${t});
`;this.attributeInfo.forEach((l,c)=>{e.addTextureSampler(`${zc(l.dataType)}sampler2D`,`uVertexAttributeSampler${a}`,Dl[a]);let d=fx(l);e.addVarying(`highp ${d}`,`vCustom${c}`),e.addFragmentCode(`
#define ${i[c]} vCustom${c}
`),e.addVertexCode(r.getAccessor(`readAttribute${c}`,`uVertexAttributeSampler${a}`,l.dataType,l.numComponents)),o+=`vCustom${c} = readAttribute${c}(${t});
`,++a}),e.addVertexMain(o)}defineShader(e){e.require(HA),this.indexBufferHelper.defineShader(e),e.addVarying("highp float","vLightingFactor"),e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp vec4","uColor"),e.addUniform("highp mat4","uModelMatrix"),e.addUniform("highp mat4","uProjection"),e.addUniform("highp uint","uPickID"),e.addVarying("highp uint","vPickID","flat"),e.addVertexMain(`
uint triangleIndex = getPrimitiveIndex() / 3u;
vPickID = uPickID + triangleIndex;
`),e.addFragmentCode(`
void emitPremultipliedRGBA(vec4 color) {
  emit(vec4(color.rgb * vLightingFactor, color.a), vPickID);
}
void emitRGBA(vec4 color) {
  color = clamp(color, 0.0, 1.0);
  color.xyz *= color.a;
  emitPremultipliedRGBA(color);
}
void emitRGB(vec3 color) {
  emitRGBA(vec4(color, 1.0));
}
void emitGray() {
  emitRGB(vec3(1.0, 1.0, 1.0));
}
`),e.addFragmentCode(Bi),this.defineAttributeAccess(e,"vertexIndex"),e.addVertexMain(`
gl_Position = uProjection * (uModelMatrix * vec4(vertexPosition, 1.0));
vec3 normal = normalize((uModelMatrix * vec4(vertexNormal, 0.0)).xyz);
vLightingFactor = abs(dot(normal, uLightDirection.xyz)) + uLightDirection.w;
`)}beginLayer(e,t,r){let{lightDirection:i,ambientLighting:a,directionalLighting:o,projectionParameters:l}=r,{viewProjectionMat:c}=l;e.uniformMatrix4fv(t.uniform("uProjection"),!1,c);let d=this.tempLightVec;K.scale(d,i,o),d[3]=a,e.uniform4fv(t.uniform("uLightDirection"),d)}setPickID(e,t,r){e.uniform1ui(t.uniform("uPickID"),r)}beginObject(e,t,r){e.uniformMatrix4fv(t.uniform("uModelMatrix"),!1,r)}bindVertexData(e,t,r){let i=0,a=l=>{let c=WebGL2RenderingContext.TEXTURE0+t.textureUnit(Dl[i]);e.activeTexture(c),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,l),++i};a(r.vertexTexture),a(r.normalTexture);let{attributeNames:o}=this;r.vertexAttributeTextures.forEach((l,c)=>{o[c]!==void 0&&a(l)})}disableVertexData(e,t){let r=2,i=this.attributeInfo.length,{attributeNames:a}=this;for(let o=0;o<i;++o)a[o]!==void 0&&++r;for(let o=0;o<r;++o){let l=t.textureUnit(Dl[o])+WebGL2RenderingContext.TEXTURE0;e.activeTexture(l),e.bindTexture(e.TEXTURE_2D,null)}}drawFragment(e,t,r,i){i.ensure(r.numIndices).bind(t),this.bindVertexData(e,t,r.vertexData),this.indexBufferHelper.bind(r.indexBuffer,t),e.drawArrays(WebGL2RenderingContext.TRIANGLES,0,r.numIndices)}endLayer(e,t){WA(e,t),this.indexBufferHelper.disable(t),this.disableVertexData(e,t)}},YA=class{copyToGPU(e,t){let r=(i,a)=>{let o=e.createTexture();return e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,o),is(e,a,i),o};this.vertexTexture=r(this.vertexPositions,JA),this.normalTexture=r(this.vertexNormals,W$),this.vertexAttributeTextures=this.vertexAttributes.map((i,a)=>r(i,t[a])),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}freeGPUMemory(e){e.deleteTexture(this.vertexTexture),e.deleteTexture(this.normalTexture);let{vertexAttributeTextures:t}=this;for(let r of t)e.deleteTexture(r);t.length=0}},KA=class extends br{constructor(e,t){super(e);let r=this.vertexData=new YA;r.vertexPositions=t.vertexPositions,r.vertexNormals=t.vertexNormals,r.vertexAttributes=t.vertexAttributes;let i=this.indices=t.indices;this.numIndices=i.length}copyToGPU(e){super.copyToGPU(e),this.vertexData.copyToGPU(e,this.source.attributeTextureFormats),this.indexBuffer=$A(e,this.indices)}freeGPUMemory(e){super.freeGPUMemory(e),this.vertexData.freeGPUMemory(e),this.indexBuffer.dispose()}};function H$(n){return n.map(e=>yi(new Ji,e.dataType,e.numComponents))}var XA=class extends lt(ct()(Gn),Zm){constructor(){super(...arguments);this.attributeTextureFormats=H$(this.info.vertexAttributes)}get info(){return this.parameters.info}getChunk(e){return new KA(this,e)}},$$=ba(Sn),QA=class extends $${},mx=class extends Ur{constructor(e,t,r){super();this.source=e;this.displayState=t;this.transform=r;this.shaderManager=new qA(hx(this.source.info.vertexAttributes.map(e=>e.name)),this.source.info.vertexAttributes);this.shaders=new Map;this.sharedObject=this.registerDisposer(new QA);this.shaderGetter=ti(this,this.gl,{memoizeKey:{t:"single_mesh/RenderLayer",attributes:this.source.info.vertexAttributes},fallbackParameters:new Ee(Qo(lo(jA))),parameters:this.displayState.shaderControlState.builderState,encodeParameters:e=>e.key,shaderError:this.displayState.shaderError,defineShader:(e,t)=>{if(t.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");Gi(t,e),this.shaderManager.defineShader(e),e.setFragmentMainFunction(Ui(t.parseResult.code))}});this.countingBuffer=this.registerDisposer(zA(this.gl));this.registerDisposer(t.shaderControlState.parseResult.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.shaderControlState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(r.changed.add(this.redrawNeeded.dispatch));let{sharedObject:i}=this;i.visibility.add(this.visibility),i.RPC_TYPE_ID=BA,i.initializeCounterpart(e.chunkManager.rpc,{chunkManager:e.chunkManager.rpcId,source:e.addCounterpartRef()})}disposeShaders(){let{shaders:e}=this;for(let t of e.values())t!==null&&t.dispose();e.clear()}disposed(){this.disposeShaders(),super.disposed()}get isTransparent(){return this.displayState.fragmentMain.value.match(/emitRGBA|emitPremultipliedRGBA/)!==null}get gl(){return this.source.gl}isReady(){let e=this.source.chunks.get(Qm);return!(e===void 0||e.state!==Ze.GPU_MEMORY)}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;let r=ns(this.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(r===void 0)return;let i=this.source.chunks.get(Qm);if(i===void 0||i.state!==Ze.GPU_MEMORY)return;let a=this.shaderGetter(e.emitter),{shader:o,parameters:l}=a;if(o===null)return;let{gl:c}=this,d=this.shaderManager;o.bind(),d.beginLayer(c,o,e),ni(c,o,this.displayState.shaderControlState,l.parseResult.controls);let{pickIDs:p}=e;d.beginObject(c,o,r),e.emitPickID&&d.setPickID(c,o,p.register(this,i.numIndices/3)),d.drawFragment(c,o,i,this.countingBuffer),d.endLayer(c,o)}transformPickedValue(e){let{pickedOffset:t}=e,r=this.source.chunks.get(Qm);if(r===void 0)return;let i=t*3,{indices:a}=r;if(i>=a.length)return;let o=a[i],l=[],{attributeNames:c}=this.shaderManager;return r.vertexData.vertexAttributes.forEach((d,p)=>{let m=c[p];m!==void 0&&l.push(`${m}=${d[o].toPrecision(6)}`)}),l.join(", ")}};function j$(n,e,t){return n.memoize.getUncounted({type:"single_mesh:getMeshInfo",url:t},async()=>{let{url:r,credentialsProvider:i}=Tn(t,e);return{info:await n.rpc.promiseInvoke(UA,{chunkManager:n.addCounterpartRef(),credentialsProvider:jd(n,i),parameters:{meshSourceUrl:r}}),url:r,credentialsProvider:i}})}async function eg(n,e,t){let{info:r,url:i,credentialsProvider:a}=await j$(n,e,t);return n.getChunkSource(XA,{credentialsProvider:a,parameters:{meshSourceUrl:i,info:r}})}var gx=class extends Ut{get description(){return"VTK mesh file"}async get(e){let t=await eg(e.chunkManager,e.credentialsManager,e.url),r=Be({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)});return{modelTransform:xt(r),subsources:[{id:"default",default:!0,subsource:{singleMesh:t}}]}}completeUrl(e){return Ci(e.credentialsManager,e.providerUrl,e.cancellationToken)}};Ot("vtk",()=>new gx);var yx=class extends Ut{get description(){return"Wavefront OBJ mesh file"}async get(e){let t=await eg(e.chunkManager,e.credentialsManager,e.url),r=Be({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)});return{modelTransform:xt(r),subsources:[{id:"default",default:!0,subsource:{singleMesh:t}}]}}completeUrl(e){return Ci(e.credentialsManager,e.providerUrl,e.cancellationToken)}};Ot("obj",()=>new yx);function ZA(n){return new Error(`ngauth server ${n} does not allow requests from Neuroglancer instance ${self.origin}`)}async function J$(n){let e=new Ce(!1);function t(i,a){e.element.textContent=i+" ";let o=document.createElement("button");o.textContent=a,e.element.appendChild(o),o.addEventListener("click",()=>{window.open(`${n}/login?origin=${encodeURIComponent(self.origin)}`),t(`Waiting for login to ngauth server ${n}...`,"Retry")})}let r=new Promise((i,a)=>{function o(l){if((l.origin||l.originalEvent.origin)!==n)return;let d=()=>{window.removeEventListener("message",o,!1)},{data:p}=l;l.data==="badorigin"&&(d(),a(ZA(n)));try{Z(p);let m=W(p,"token",Q);d(),i(m)}catch(m){console.log("ngauth: Received unexpected message from ${serverUrl}",l)}}window.addEventListener("message",o,!1)});t(`ngauth server ${n} login required.`,"Login");try{return{token:await r}}finally{e.dispose()}}var vx=class extends An{constructor(e){super();this.serverUrl=e;this.get=or(async()=>{let e=await fetch(`${this.serverUrl}/token`,{method:"POST",credentials:"include"});switch(e.status){case 200:return{token:await e.text()};case 401:return await J$(this.serverUrl);case 403:throw ZA(this.serverUrl);default:throw Cr.fromResponse(e)}})}},Sx=class extends An{constructor(e,t,r){super();this.ngauthCredentialsProvider=e;this.serverUrl=t;this.bucket=r;this.get=or(async()=>{let e=await Pa(this.ngauthCredentialsProvider,`${this.serverUrl}/gcs_token`,{method:"POST"},bt,(t,r)=>({...r,body:JSON.stringify({token:t.token,bucket:this.bucket})}),t=>{let{status:r}=t;if(r===401)return"refresh";throw t});return{tokenType:"Bearer",accessToken:e.token}})}};sr.register("ngauth",n=>new vx(n));sr.register("ngauth_gcs",(n,e)=>new Sx(e.getCredentialsProvider("ngauth",n.authServer),n.authServer,n.bucket));function q$(n,e,t){let r=window.outerHeight-window.innerHeight+window.innerHeight/2-t/2,i=window.innerWidth/2-e/2;return window.open(n,void 0,`toolbar=no, menubar=no, width=${e}, height=${t}, top=${r}, left=${i}`)}async function Y$(n){let e=new Ce(!1),t=new Promise(r=>{function i(a,o){e.element.textContent=a+" ";let l=document.createElement("button");l.textContent=o,e.element.appendChild(l),l.addEventListener("click",()=>{i(`Waiting for login to middleauth server ${n}...`,"Retry");let c=q$(`${n}/api/v1/authorize`,400,650),d=()=>{c==null||c.close()};window.addEventListener("beforeunload",d);let p=setInterval(()=>{(c==null?void 0:c.closed)&&(clearInterval(p),i(`Login window closed for middleauth server ${n}.`,"Retry"))},1e3),m=async g=>{if(g.source===c){clearInterval(p),window.removeEventListener("message",m),window.removeEventListener("beforeunload",d),d(),Z(g.data);let v=W(g.data,"token",Q),b=W(g.data,"app_urls",qt);r({tokenType:"Bearer",accessToken:v,url:n,appUrls:b})}};window.addEventListener("message",m)})}i(`middleauth server ${n} login required.`,"Login")});try{return await t}finally{e.dispose()}}var eM="auth_token_v2";function K$(n){let e=localStorage.getItem(`${eM}_${n}`);return e?JSON.parse(e):null}function X$(n,e){localStorage.setItem(`${eM}_${n}`,JSON.stringify(e))}var bx=class extends An{constructor(e){super();this.serverUrl=e;this.alreadyTriedLocalStorage=!1;this.get=or(async()=>{let e;return this.alreadyTriedLocalStorage||(this.alreadyTriedLocalStorage=!0,e=K$(this.serverUrl)),e||(e=await Y$(this.serverUrl),X$(this.serverUrl,e)),e})}},tM=class extends Error{constructor(e){super();this.url=e}},xx=class extends An{constructor(e,t){super();this.serverUrl=e;this.credentialsManager=t;this.credentials=void 0;this.get=or(async()=>{let e=await fetch(`${this.serverUrl}/auth_info`).then(r=>r.json()),t=this.credentialsManager.getCredentialsProvider("middleauth",e.login_url);if(this.credentials=await t.get(this.credentials),this.credentials.credentials.appUrls.includes(this.serverUrl))return this.credentials.credentials;throw new Ce(!1).setText(`middleauth: unverified app ${this.serverUrl}`),new tM(this.serverUrl)})}};sr.register("middleauth",n=>new bx(n));sr.register("middleauthapp",(n,e)=>new xx(n,e));var Tx=ot(Et());function nM(n){return new Error(`Nggraph server ${n} does not allow requests from Neuroglancer instance ${self.origin}`)}async function Q$(n){let e=new Ce(!1);function t(i,a){e.element.textContent=i+" ";let o=document.createElement("button");o.textContent=a,e.element.appendChild(o),o.addEventListener("click",()=>{window.open(`${n}/login?origin=${encodeURIComponent(self.origin)}`),t(`Waiting for login to nggraph server ${n}...`,"Retry")})}let r=new Promise((i,a)=>{function o(l){if((l.origin||l.originalEvent.origin)!==n||typeof l.data!="string")return;let d=()=>{window.removeEventListener("message",o,!1)};l.data==="badorigin"?(d(),a(nM(n))):(d(),i(l.data))}window.addEventListener("message",o,!1)});t(`Nggraph server ${n} login required.`,"Login");try{return{token:await r}}finally{e.dispose()}}var Cx=class extends An{constructor(e){super();this.serverUrl=e;this.get=or(async()=>{let e=await fetch(`${this.serverUrl}/token`,{method:"POST",credentials:"include"});switch(e.status){case 200:return{token:await e.text()};case 401:return await Q$(this.serverUrl);case 403:throw nM(this.serverUrl);default:throw Cr.fromResponse(e)}})}};var tg=Symbol("disjoint_sets:rank"),vo=Symbol("disjoint_sets:parent"),ng=Symbol("disjoint_sets:next"),mp=Symbol("disjoint_sets:prev");function wx(n){let e=n,t=n[vo];for(;t!==n;)n=t,t=n[vo];for(n=e[vo];t!==n;)e[vo]=t,e=n,n=e[vo];return t}function Z$(n,e){let t=n[tg],r=e[tg];return t>r?(e[vo]=n,n):(n[vo]=e,t===r&&(e[tg]=r+1),e)}function ej(n,e){let t=n[mp],r=e[mp];e[mp]=t,t[ng]=e,n[mp]=r,r[ng]=n}function*rM(n){let e=n;do yield e,e=e[ng];while(e!==n)}function tj(n){n[vo]=n,n[tg]=0,n[ng]=n[mp]=n}var Zc=Symbol("disjoint_sets:min");function iM(n){return n[vo]===n}var Pl=class{constructor(){this.map=new Map;this.visibleSegmentEquivalencePolicy=new Ee(Kt.MIN_REPRESENTATIVE);this.generation=0}has(e){let t=e.toString();return this.map.get(t)!==void 0}get(e){let t=e.toString(),r=this.map.get(t);return r===void 0?e:wx(r)[Zc]}isMinElement(e){let t=this.get(e);return t===e||X.equal(t,e)}makeSet(e){let t=e.toString(),{map:r}=this,i=r.get(t);return i===void 0?(i=e.clone(),tj(i),i[Zc]=i,r.set(t,i),i):wx(i)}link(e,t){if(e=this.makeSet(e),t=this.makeSet(t),e===t)return!1;this.generation++;let r=Z$(e,t);ej(e,t);let i=e[Zc],a=t[Zc],o=(this.visibleSegmentEquivalencePolicy.value&Kt.MAX_REPRESENTATIVE)!=0;return r[Zc]=X.less(i,a)===o?a:i,!0}linkAll(e){for(let t=1,r=e.length;t<r;++t)this.link(e[0],e[t])}deleteSet(e){let{map:t}=this,r=!1;for(let i of this.setElements(e))t.delete(i.toString()),r=!0;return r&&++this.generation,r}*setElements(e){let t=e.toString(),r=this.map.get(t);r===void 0?yield e:yield*rM(r)}clear(){let{map:e}=this;return e.size===0?!1:(++this.generation,e.clear(),!0)}get size(){return this.map.size}*mappings(e=new Array(2)){for(let t of this.map.values())e[0]=t,e[1]=wx(t)[Zc],yield e}*roots(){for(let e of this.map.values())iM(e)&&(yield e)}[Symbol.iterator](){return this.mappings()}toJSON(){let e=new Array;for(let t of this.map.values())if(iM(t)){let r=new Array;for(let i of rM(t))r.push(i);r.sort(X.compare),e.push(r)}return e.sort((t,r)=>X.compare(t[0],r[0])),e.map(t=>t.map(r=>r.toString()))}};var nj="^(https?://[^/]+)/(.*)$";function rj(n){return Z(n),{id:W(n,"id",e=>X.parseString(Q(e))),baseSegments:W(n,"base_segment_ids",e=>ge(e,t=>X.parseString(Q(t)))),baseSegmentParents:W(n,"base_segment_parent_ids",e=>ge(e,t=>X.parseString(Q(t)))),name:W(n,"name",Q),tags:W(n,"tags",qt),numVoxels:W(n,"num_voxels",rt),bounds:W(n,"bounds",e=>ge(e,t=>Qe(t))),lastLogId:W(n,"last_log_id",e=>e==null?null:X.parseString(Q(e)))}}var aM=0,oM=class extends sl{constructor(e,t){super(e,t);this.debouncedVisibleSegmentsChanged=this.registerCancellable((0,Tx.default)(()=>this.visibleSegmentsChanged(),0));this.segmentQueries=new Map;this.ignoreVisibleSegmentsChanged=!1;this.segmentEquivalencesChanged=this.registerCancellable((0,Tx.default)(()=>{this.debouncedVisibleSegmentsChanged.flush(),this.segmentEquivalencesChanged.cancel();let{segmentQueries:e}=this,{segmentEquivalences:t}=this.segmentsState;t.clear();for(let[r,i]of e){if(i.current===void 0||Oc(i.id))continue;let{id:a,baseSegments:o}=i.current;if(o.length>0){for(let l of o)t.link(l,a);i.addedEquivalences=!0}else i.addedEquivalences=!1}},0));let r=()=>{this.ignoreVisibleSegmentsChanged||this.debouncedVisibleSegmentsChanged()};this.registerDisposer(t.visibleSegments.changed.add(r)),this.registerDisposer(t.temporaryVisibleSegments.changed.add(r)),this.visibleSegmentsChanged()}computeSplit(e,t){let{segmentEquivalences:r}=this.segmentsState,i=r.get(e);if(Oc(i)||!X.equal(r.get(t),i))return;let a=this.segmentQueries.get(i.toString());if(a===void 0)return;let{current:o}=a;if(o===void 0)return;let{baseSegments:l,baseSegmentParents:c}=o,d=c.length,p=new Pl;for(let b=0;b<d;++b){let x=l[b],C=c[b];X.equal(x,t)||X.equal(C,t)||(p.link(x,C),console.log(`Linking ${x} - ${C} == ${e}? ${X.equal(e,x)} ${X.equal(e,C)} :: unioned with include = ${X.equal(e,p.get(x))}, with exclude = ${X.equal(t,p.get(x))}`))}let m=[],g=[],v=p.get(e);for(let b of l)X.equal(p.get(b),v)?m.push(b):g.push(b);return console.log("include = "+m.map(b=>b.toString()).join(",")),console.log("exclude = "+g.map(b=>b.toString()).join(",")),{includeRepresentative:i,includeBaseSegments:m,excludeRepresentative:jS,excludeBaseSegments:g}}registerVisibleSegment(e){let t={id:e,current:void 0,addedEquivalences:!1,seenGeneration:aM,disposer:this.graph.watchSegment(e,i=>this.handleSegmentUpdate(t.id.toString(),i))},r=e.toString();this.segmentQueries.set(r,t),console.log(`adding to segmentQueries: ${r}`)}handleSegmentUpdate(e,t){console.log(`handleSegmentUpdate: ${e}`);let r=this.segmentQueries.get(e);if(t==="invalid"){r.disposer(),console.log(`removing from segmentQueries: ${e} due to invalid`),this.segmentQueries.delete(e);try{this.ignoreVisibleSegmentsChanged=!0,this.segmentsState.visibleSegments.delete(r.id),this.segmentsState.temporaryVisibleSegments.delete(r.id)}finally{this.ignoreVisibleSegmentsChanged=!1}r.addedEquivalences&&this.segmentEquivalencesChanged();return}if(t==="error"){r.current=void 0,r.addedEquivalences&&this.segmentEquivalencesChanged(),console.log(`Error from ${this.graph.serverUrl}/${this.graph.entityName} watching segment ${e}`);return}r.current=t;let i=r.id,a=t.id;if(X.equal(a,i))r.current=t,Oc(r.id)||this.segmentEquivalencesChanged();else{r.id=a;let o=a.toString(),l=this.segmentQueries.get(o);console.log(`removing from segmentQueries: ${e} due to rename -> ${a}`),this.segmentQueries.delete(e);try{this.ignoreVisibleSegmentsChanged=!0,this.segmentsState.visibleSegments.has(i)&&(this.segmentsState.visibleSegments.delete(i),this.segmentsState.visibleSegments.add(a)),this.segmentsState.temporaryVisibleSegments.has(i)&&(this.segmentsState.temporaryVisibleSegments.delete(i),this.segmentsState.temporaryVisibleSegments.add(a))}finally{this.ignoreVisibleSegmentsChanged=!1}l===void 0?(console.log(`adding to segmentQueries due to rename -> ${a}`),this.segmentQueries.set(o,r),this.segmentEquivalencesChanged()):(t.lastLogId!==null&&(typeof l.current!="object"||l.current.lastLogId===null||X.less(l.current.lastLogId,t.lastLogId))&&(l.current=t,this.segmentEquivalencesChanged()),r.disposer())}}visibleSegmentsChanged(){let{segmentsState:e}=this,{segmentQueries:t}=this,r=++aM,i=a=>{for(let o of a.unsafeKeys()){if(X.equal(o,jS))continue;let l=o.toString(),c=t.get(l);if(c!==void 0){c.seenGeneration=r;continue}this.registerVisibleSegment(o.clone())}};i(e.visibleSegments),i(e.temporaryVisibleSegments);for(let[a,o]of t)o.seenGeneration!==r&&(console.log(`removing from segmentQueries due to seenGeneration: ${a}`),t.delete(a),o.disposer(),o.addedEquivalences&&this.segmentEquivalencesChanged())}},sM=class extends ol{constructor(e,t,r){super();this.chunkManager=e;this.serverUrl=t;this.entityName=r;this.startingWebsocket=!1;this.websocket=void 0;this.watchesById=new Map;this.watches=new Set;this.nextWatchId=0;this.numOpenFailures=0}get visibleSegmentEquivalencePolicy(){return Kt.MAX_REPRESENTATIVE|Kt.REPRESENTATIVE_EXCLUDED}startWebsocket(){if(this.startingWebsocket||this.watches.size===0)return;this.startingWebsocket=!0;let e=new Ce(!this.numOpenFailures);e.setText(`Opening websocket connection for nggraph://${this.serverUrl}/${this.entityName}`),(async()=>{let{numOpenFailures:t}=this;if(t>1){let o=1e3*Math.min(16,2**t);await new Promise(l=>setTimeout(l,o))}let r=(await kx(this.chunkManager,this.serverUrl,this.entityName).get()).credentials,i=new URL("/graph/watch/"+encodeURIComponent(r.token),this.serverUrl);i.protocol=i.protocol.replace("http","ws");let a=new WebSocket(i.href);a.onclose=()=>{e!==void 0&&(e.dispose(),e=void 0),++this.numOpenFailures,this.websocket=void 0,this.startingWebsocket=!1,this.watchesById.clear(),this.startWebsocket()},a.onopen=()=>{e!==void 0&&(e.dispose(),e=void 0),this.numOpenFailures=0,this.websocket=a,this.nextWatchId=0;try{for(let o of this.watches){a.send(JSON.stringify({watch:{segment_id:o.segment.toString()}}));let l=this.nextWatchId++;o.watchId=l,this.watchesById.set(l,o)}}catch{}},a.onmessage=o=>{let l,c;try{let d=JSON.parse(o.data);Z(d);let p=W(d,"watch_id",rt),m=this.watchesById.get(p);if(m===void 0)return;c=m;let g=W(d,"state",Q);g==="invalid"||g==="error"?l=g:l=W(d,"info",rj)}catch(d){console.log(`Received unexpected websocket message from ${this.serverUrl}:`,o.data,d);return}console.log("got update",l),c.callback(l)}})()}connect(e){let t=e.displayState.segmentationGroupState.value;return new oM(this,t)}trackSegment(e,t){return this.watchSegment(e,r=>{if(r==="invalid")t(null);else{if(r==="error")return;t(r.id)}})}watchSegment(e,t){let r={callback:t,segment:e,watchId:-1};this.watches.add(r);let{websocket:i}=this;if(i!==void 0)try{i.send(JSON.stringify({watch:{segment_id:e.toString()}}));let o=this.nextWatchId++;r.watchId=o,this.watchesById.set(o,r)}catch{}else this.startWebsocket();return()=>{let{websocket:o}=this;if(o!==void 0&&o.readyState===WebSocket.OPEN){let l=r.watchId;this.watchesById.delete(l);try{o.send(JSON.stringify({unwatch:{watch_id:l}}))}catch{}}this.watches.delete(r)}}async merge(e,t){let r=await Ex(this.chunkManager,this.serverUrl,this.entityName,"/graph/mutate",{body:JSON.stringify({merge:{anchor:e.toString(),other:t.toString()}}),headers:{"Content-Type":"application/json"},method:"POST"});return Z(r),W(r,"merged",i=>X.parseString(i))}async split(e,t){let r=await Ex(this.chunkManager,this.serverUrl,this.entityName,"/graph/mutate",{body:JSON.stringify({split:{include:e.toString(),exclude:t.toString()}}),headers:{"Content-Type":"application/json"},method:"POST"});return Z(r),{include:W(r,"include",i=>X.parseString(i)),exclude:W(r,"exclude",i=>X.parseString(i))}}};function lM(n){let e=n.match(nj);if(e===null)throw new Error(`Invalid nggraph url: ${JSON.stringify(n)}`);return{serverUrl:e[1],id:e[2]}}function Lx(n,e,t,r,i=at){return Pa(n,`${e}${t}`,r,bt,(a,o)=>{let l=new Headers(o.headers);return l.set("Authorization",a.token),{...o,headers:l}},a=>{let{status:o}=a;if(o===401)return"refresh";throw a},i)}function ij(n,e,t,r,i=at){return Lx(uM(n,e),e,t,r,i)}var cM=class extends An{constructor(e,t,r){super();this.parentCredentialsProvider=e;this.serverUrl=t;this.entityName=r;this.get=or(async()=>{let e=await Lx(this.parentCredentialsProvider,this.serverUrl,"/entity_token",{body:JSON.stringify({entity:this.entityName}),headers:{"Content-Type":"application/json"},method:"POST"});return{token:e.token,entityType:e.entity_type,role:e.role}})}};function uM(n,e){return n.memoize.getUncounted({type:"nggraph:credentialsProvider",serverUrl:e},()=>new Cx(e))}function kx(n,e,t){return n.memoize.getUncounted({type:"nggraph:entityCredentialsProvider",serverUrl:e,entityName:t},()=>new cM(uM(n,e),e,t))}function Ex(n,e,t,r,i,a=at){return Lx(kx(n,e,t),e,r,i,a)}function aj(n){return Z(n),W(n,"entities",e=>ge(e,t=>{Z(t);let r=W(t,"entity",Q),i=W(t,"entity_type",Q),a=W(t,"access_role",Q);return{id:r,entityType:i,accessRole:a}}))}var Dx=class extends Ut{get description(){return"nggraph data source"}get(e){let{serverUrl:t,id:r}=lM(e.providerUrl);return e.chunkManager.memoize.getUncounted({type:"nggraph:get",serverUrl:t,id:r},async()=>{let i=kx(e.chunkManager,t,r),{entityType:a}=(await i.get()).credentials;if(a!="graph")throw new Error(`Unsupported entity type: ${JSON.stringify(a)}`);let{datasource_url:o}=await Ex(e.chunkManager,t,r,"/graph/config",{method:"POST"}),l=await e.registry.get({...e,url:o}),c=new sM(e.chunkManager,t,r),d=[...l.subsources,{id:"graph",default:!0,subsource:{segmentationGraph:c}}];return{modelTransform:l.modelTransform,subsources:d}})}async completeUrl(e){let{serverUrl:t,id:r}=lM(e.providerUrl),i=await e.chunkManager.memoize.getUncounted({type:"nggraph:list",serverUrl:t},async()=>aj(await ij(e.chunkManager,t,"/list",{method:"POST"})));return{offset:t.length+1,completions:on(r,i,a=>a.id,a=>`${a.entityType} (${a.accessRole})`)}}};Ot("nggraph",()=>new Dx);var gp=1,dM;(function(r){r[r.RAW=0]="RAW",r[r.JPEG=1]="JPEG",r[r.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION"})(dM||(dM={}));var pM=class{};pM.RPC_ID="graphene/VolumeChunkSource";var rg=class{};rg.RPC_ID="graphene/ChunkedGraphSource";var ig=class{};ig.RPC_ID="graphene/MeshSource";var ag=async n=>n;function fM(n,e){let t=X.rshift(new X,n,64-e);return X.equal(t,X.ONE)}function hM(n){if(n.charAt(0)==="~"){let t=n.substring(1).split(/:(.+)/);return{key:t[0],fragmentId:t[1]}}else return{key:n,fragmentId:n}}var mM="ChunkedGraphLayer",gM="ChunkedGraphLayer:updateSources";function yM(n){let{rank:e,dataType:t}=n,{baseVoxelOffset:r=new Float32Array(e)}=n;return{...Jo(n),baseVoxelOffset:r,dataType:t}}function Il(n){try{return n()}catch(e){return{error:e.message}}}function yp(n){if(n.error!==void 0)throw new Error(n.error);return n}var Px=ot(Et());var oj=/^[A-Z]$/,Ix=class extends j{constructor(e,t){super();this.tool=e;this.inputEventMapBinder=t}bindAction(e,t){this.registerDisposer(ce(window,e,t))}bindInputEventMap(e){this.inputEventMapBinder(e,this)}cancel(){this==this.tool.layer.manager.root.toolBinder.activeTool_&&this.tool.layer.manager.root.toolBinder.deactivate_()}},Gr=class extends j{constructor(e,t=!1){super();this.layer=e;this.toggle=t;this.changed=new ze;this.keyBinding=void 0}get mouseState(){return this.layer.manager.root.layerSelectedValues.mouseState}unbind(){let{layer:e}=this,{keyBinding:t}=this;t!==void 0&&e.toolBinder.set(t,void 0)}},vp=class extends j{constructor(e){super();this.layer=e;this.changed=new ze}get mouseState(){return this.layer.manager.root.layerSelectedValues.mouseState}deactivate(){}unbind(){let{layer:e}=this;e.tool.value===this&&(e.tool.value=void 0)}};function vM(n,e){var i;if(e===void 0)return;typeof e=="string"&&(e={type:e}),Z(e);let t=W(e,"type",Q),r=(i=Ax.get(n.constructor))==null?void 0:i.get(t);if(r===void 0&&(r=lj.get(t)),r===void 0)throw new Error(`Invalid tool type: ${JSON.stringify(e)}.`);return r(n,e)}function sj(n,e){if(e===void 0)return;typeof e=="string"&&(e={type:e}),Z(e);let t=W(e,"type",Q),r=SM.get(t);if(r===void 0)throw new Error(`Invalid tool type: ${JSON.stringify(e)}.`);return r(n,e)}var SM=new Map,lj=new Map,Ax=new Map;function Sp(n,e){SM.set(n,e)}function wi(n,e,t){let r=Ax.get(n);r===void 0&&(r=new Map,Ax.set(n,r)),r.set(e,t)}var Mx=class extends j{constructor(e){super();this.layer=e;this.changed=new ze}get value(){return this.value_}set value(e){e!==this.value_&&(this.unregister(),e!==void 0&&(e.changed.add(this.changed.dispatch),this.value_=e),this.changed.dispatch())}unregister(){let e=this.value_;e!==void 0&&(e.changed.remove(this.changed.dispatch),e.dispose(),this.value_=void 0)}disposed(){this.unregister(),super.disposed()}restoreState(e){this.value=sj(this.layer,e)}reset(){this.value=void 0}toJSON(){let e=this.value_;if(e!==void 0)return e.toJSON()}},Rx=class extends j{constructor(e){super();this.inputEventMapBinder=e;this.bindings=new Map;this.changed=new ze;this.debounceDeactivate=this.registerCancellable((0,Px.default)(()=>this.deactivate_(),100));this.debounceReactivate=this.registerCancellable((0,Px.default)(()=>this.reactivateQueuedTool(),100))}get(e){return this.bindings.get(e)}set(e,t){let{bindings:r}=this,i=r.get(e);if(i!==void 0){i.keyBinding=void 0,r.delete(e);let a=i.layer.toolBinder;a.bindings.delete(e),a.jsonToKey.delete(JSON.stringify(i.toJSON())),this.destroyTool(i),a.changed.dispatch()}if(t!==void 0){let a=t.layer.toolBinder,o=JSON.stringify(t.toJSON()),l=a.jsonToKey.get(o);if(l!==void 0){let c=a.bindings.get(l);c.keyBinding=void 0,r.delete(l),a.bindings.delete(l),a.jsonToKey.delete(o),this.destroyTool(c)}a.bindings.set(e,t),t.keyBinding=e,a.jsonToKey.set(o,e),r.set(e,t),a.changed.dispatch()}this.changed.dispatch()}activate(e){let t=this.get(e);if(t===void 0){this.deactivate_();return}this.debounceDeactivate.cancel(),this.debounceReactivate.cancel();let r=this.activeTool_;if(t===(r==null?void 0:r.tool)){t.toggle&&this.deactivate_();return}else r!==void 0&&(r.tool.toggle&&!t.toggle&&(this.queuedTool=r.tool),this.deactivate_());let i=new Ix(t,this.inputEventMapBinder);if(this.activeTool_=i,!t.toggle){let a=`Key${e}`;i.registerEventListener(window,"keyup",o=>{o.code===a&&(this.debounceDeactivate(),this.debounceReactivate())}),i.registerEventListener(window,"blur",()=>{this.debounceDeactivate(),this.debounceReactivate()})}return t.activate(i),t}reactivateQueuedTool(){if(this.queuedTool){let e=new Ix(this.queuedTool,this.inputEventMapBinder);this.activeTool_=e,this.queuedTool.activate(e),this.queuedTool=void 0}}destroyTool(e){var t;this.queuedTool===e&&(this.queuedTool=void 0),((t=this.activeTool_)==null?void 0:t.tool)===e&&this.deactivate_(),e.dispose()}disposed(){this.deactivate_(),super.disposed()}deactivate_(){this.debounceDeactivate.cancel();let e=this.activeTool_;e!==void 0&&(this.activeTool_=void 0,e.dispose())}},_x=class{constructor(e){this.layer=e;this.bindings=new Map;this.jsonToKey=new Map;this.changed=new ze;e.registerDisposer(()=>this.clear())}get globalBinder(){return this.layer.manager.root.toolBinder}get(e){return this.bindings.get(e)}set(e,t){this.globalBinder.set(e,t)}setJson(e,t){let r=vM(this.layer,t);r!==void 0&&this.set(e,r)}removeJsonString(e){let t=this.jsonToKey.get(e);t!==void 0&&this.set(t,void 0)}toJSON(){let{bindings:e}=this;if(e.size===0)return;let t={};for(let[r,i]of e)t[r]=i.toJSON();return t}clear(){let{globalBinder:e,bindings:t}=this;if(t.size!==0){for(let[r,i]of t)i.keyBinding=void 0,e.bindings.delete(r),e.destroyTool(i);t.clear(),this.jsonToKey.clear(),e.changed.dispatch(),this.changed.dispatch()}}reset(){this.clear()}restoreState(e){if(e!==void 0){Z(e);for(let[t,r]of Object.entries(e)){if(!t.match(oj))throw new Error(`Invalid tool key: ${JSON.stringify(t)}`);let i=vM(this.layer,r);if(i===void 0)return;this.set(t,i)}}}},og=class extends j{constructor(e,t){super();this.layer=e;this.toolJson=t;this.element=document.createElement("div");this.toolJsonString=JSON.stringify(this.toolJson);let{element:r}=this;r.classList.add("neuroglancer-tool-key-binding"),this.registerDisposer(e.toolBinder.changed.add(this.registerCancellable(We(()=>this.updateView())))),this.updateView(),r.title="click \u2192 bind key, dbclick \u2192 unbind",r.addEventListener("dblclick",()=>{this.layer.toolBinder.removeJsonString(this.toolJsonString)}),Vx(this,r,i=>this.layer.toolBinder.setJson(i,this.toolJson))}updateView(){let{toolBinder:e}=this.layer,t=e.jsonToKey.get(this.toolJsonString);this.element.textContent=t!=null?t:" "}};function Vx(n,e,t){let r;e.addEventListener("mousedown",i=>{if(i.button!==0||r!==void 0)return;i.preventDefault(),i.stopPropagation(),r=new j,n.registerDisposer(r),r.registerDisposer(new Ce(!1)).setText("Press A-Z to bind key"),r.registerEventListener(window,"keydown",o=>{let{code:l}=o,c=l.match(/^Key([A-Z])$/);if(c===null)return;o.stopPropagation(),o.preventDefault();let d=c[1];t(d)},{capture:!0}),r.registerEventListener(window,"mouseup",o=>{o.button!==0||r===void 0||(o.preventDefault(),o.stopPropagation(),n.unregisterDisposer(r),r.dispose(),r=void 0)})}),e.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation()})}function Al(n,e,t){let r=document.createElement("div");r.classList.add("neuroglancer-tool-button"),r.appendChild(n.registerDisposer(new og(e,t.toolJson)).element);let i=document.createElement("div");return i.classList.add("neuroglancer-tool-button-label"),i.textContent=t.label,t.title&&(i.title=t.title),r.appendChild(i),r}function cj(n){let e=n.registerDisposer(new Ce(!1));e.element.classList.add("neuroglancer-tool-status");let t=document.createElement("div");t.classList.add("neuroglancer-tool-status-content"),e.element.appendChild(t);let{inputEventMapBinder:r}=n;return n.inputEventMapBinder=(i,a)=>{let o=document.createElement("div");o.textContent=i.describe(),o.classList.add("neuroglancer-tool-status-bindings"),e.element.appendChild(o),r(i,a)},{message:e,content:t}}function Oa(n){let{message:e,content:t}=cj(n),r=document.createElement("div");r.classList.add("neuroglancer-tool-status-header");let i=document.createElement("div");i.classList.add("neuroglancer-tool-status-header-container"),i.appendChild(r),t.appendChild(i);let a=document.createElement("div");return a.classList.add("neuroglancer-tool-status-body"),t.appendChild(a),{message:e,body:a,header:r}}var yg=ot(Et()),nR=ot(bp());function hj(n){return typeof n=="boolean"?{enabled:n}:(Z(n),{enabled:oe(n,"enabled",ya)})}function Ml(n,e=void 0){return typeof n=="string"?{url:n,transform:e,enableDefaultSubsources:!0,subsources:new Map}:(Z(n),{url:W(n,"url",Q),transform:W(n,"transform",cS)||e,enableDefaultSubsources:oe(n,"enableDefaultSubsources",ya,!0),subsources:oe(n,"subsources",t=>Za(t,hj),new Map),state:oe(n,"state",Z)})}function mj(n){return n.enabled}function xM(n){let e=uS(n.transform),t={},r=!0;for(let[i,a]of n.subsources){let o=mj(a);o!==void 0&&(t[i]=o,r=!1)}return e===void 0&&r&&n.enableDefaultSubsources===!0&&n.state===void 0?n.url:{url:n.url,transform:e,subsources:r?void 0:t,enableDefaultSubsources:n.enableDefaultSubsources===!0?void 0:!1,state:n.state}}var CM=class{constructor(e,t,r,i,a){this.loadedDataSource=e;this.subsourceEntry=t;this.subsourceSpec=r;this.subsourceIndex=i;this.activated=void 0;this.guardValues=[];this.messages=new Wi;this.isActiveChanged=new re;let o;r===void 0||r.enabled===void 0?o=t.default&&a:o=r.enabled;let l=e.dataSource.modelTransform.sourceRank,{modelSubspaceDimensionIndices:c}=t;if(c===void 0){c=new Array(l);for(let p=0;p<l;++p)c[p]=p}let{subsourceToModelSubspaceTransform:d=Yt(Float32Array,c.length+1)}=t;this.enabled=o,this.subsourceToModelSubspaceTransform=d,this.modelSubspaceDimensionIndices=c,this.isActiveChanged.add(e.activatedSubsourcesChanged.dispatch)}activate(e,...t){if(this.messages.clearMessages(),this.activated!==void 0){if(xe(t,this.guardValues))return;this.activated.dispose()}this.guardValues=t;let r=this.activated=new j;e(r),this.isActiveChanged.dispatch()}deactivate(e){this.messages.clearMessages(),this.messages.addMessage({severity:xr.error,message:e});let{activated:t}=this;t!==void 0&&(this.activated=void 0,t.dispose(),this.isActiveChanged.dispatch())}addRenderLayer(e){let t=this.activated;t.registerDisposer(this.loadedDataSource.layer.addRenderLayer(e)),t.registerDisposer(this.messages.addChild(e.messages))}getRenderLayerTransform(e){let t=this.activated,{layer:r,transform:i}=this.loadedDataSource;return t.registerDisposer(Dh(r.manager.root.coordinateSpace,r.localPosition.coordinateSpace,i,this,e))}},sg=class extends j{constructor(e,t,r){super();this.layerDataSource=e;this.dataSource=t;this.error=void 0;this.enabledSubsourcesChanged=new re;this.activatedSubsourcesChanged=new re;this.messages=new Wi;t.canChangeModelSpaceRank?(this.transform=new Th(xt(Be({rank:0,scales:new Float64Array(0),units:[],names:[]})),!0),this.transform.value=t.modelTransform):this.transform=new Th(t.modelTransform),r.transform!==void 0&&(this.transform.spec=r.transform);let i=r.subsources;this.enableDefaultSubsources=r.enableDefaultSubsources,this.subsources=t.subsources.map((a,o)=>new CM(this,a,i.get(a.id),o,this.enableDefaultSubsources))}get enabledSubsources(){return this.subsources.filter(e=>e.enabled)}get layer(){return this.layerDataSource.layer}disposed(){for(let e of this.subsources){let{activated:t}=e;t!==void 0&&(e.activated=void 0,t.dispose())}}},Ox=class extends j{constructor(e,t=void 0){super();this.layer=e;this.changed=new re;this.messages=new Wi;this.loadState_=void 0;this.specGeneration=-1;this.refCounted_=void 0;this.registerDisposer(this.changed.add(e.dataSourcesChanged.dispatch)),t===void 0?this.spec_=Jh():this.spec=t}get spec(){let{loadState:e}=this;if(e!==void 0&&e.error===void 0){let t=this.changed.count;t!==this.specGeneration&&(this.specGeneration=t,this.spec_={url:this.spec.url,transform:e.transform.spec,enableDefaultSubsources:e.enableDefaultSubsources,subsources:new Map(Array.from(e.subsources,r=>{let i=e.enableDefaultSubsources&&r.subsourceEntry.default;return[r.subsourceEntry.id,{enabled:r.enabled!==i?r.enabled:void 0}]})),state:this.spec.state})}return this.spec_}get loadState(){return this.loadState_}set spec(e){let{layer:t}=this;if(this.messages.clearMessages(),e.url.length===0){if(t.dataSources.length!==1){let c=t.dataSources.indexOf(this);if(c!==-1){t.dataSources.splice(c,1),t.dataSourcesChanged.dispatch(),this.dispose();return}}this.spec_=e,this.refCounted_!==void 0&&(this.refCounted_.dispose(),this.refCounted_=void 0,this.loadState_=void 0,this.changed.dispatch());return}let r=new j,i=r.registerDisposer(Nf(t.markLoading()));this.refCounted_!==void 0&&(this.refCounted_.dispose(),this.loadState_=void 0),this.refCounted_=r,this.spec_=e;let a=t.manager.chunkManager,o=t.manager.dataSourceProviderRegistry,l=new vr;this.messages.addMessage({severity:xr.info,message:"Loading data source"}),o.get({chunkManager:a,url:e.url,cancellationToken:l,globalCoordinateSpace:t.manager.root.coordinateSpace,transform:e.transform,state:e.state}).then(c=>{if(r.wasDisposed)return;this.messages.clearMessages();let d=r.registerDisposer(new sg(this,c,e));d.registerDisposer(t.addCoordinateSpace(d.transform.outputSpace)),d.registerDisposer(d.transform.changed.add(this.changed.dispatch)),this.loadState_=d,d.registerDisposer(d.enabledSubsourcesChanged.add(this.changed.dispatch)),this.changed.dispatch(),c.state&&r.registerDisposer(c.state.changed.add(()=>{var p;this.spec.state=(p=c.state)==null?void 0:p.toJSON(),t.specificationChanged.dispatch()})),i()}).catch(c=>{this.wasDisposed||(this.loadState_={error:c},this.messages.clearMessages(),this.messages.addMessage({severity:xr.error,message:c.message}),this.changed.dispatch())}),r.registerDisposer(()=>{l.cancel()}),this.changed.dispatch()}disposed(){let e=this.refCounted_;e!==void 0&&e.dispose()}toJSON(){let{loadState:e}=this;return e===void 0||e.error!==void 0?xM(this.spec):xM({url:this.spec.url,transform:e.transform.spec,enableDefaultSubsources:e.enableDefaultSubsources,subsources:new Map(Array.from(e.subsources,t=>{let r=e.enableDefaultSubsources&&t.subsourceEntry.default;return[t.subsourceEntry.id,{enabled:t.enabled!==r?t.enabled:void 0}]})),state:this.spec.state})}};var Ht;(function(r){r[r.LINKED=0]="LINKED",r[r.RELATIVE=1]="RELATIVE",r[r.UNLINKED=2]="UNLINKED"})(Ht||(Ht={}));var lg;(function(t){t[t.LINKED=0]="LINKED",t[t.UNLINKED=2]="UNLINKED"})(lg||(lg={}));var wM=class extends us{constructor(e=0){super(Ht,e)}},TM=class extends us{constructor(e=0){super(lg,e)}},cg=K.create(),LM=Ke.create();function xp(n,e,t,r){let i=!1,a=!1,o;n.registerDisposer(e);let l=()=>{if(!a){switch(i=!0,t.value){case 2:if(r.isValid(n))break;case 0:r.assign(n,e);break;case 1:r.add(n,e,o);break}i=!1}},c=()=>{if(!i)switch(t.value){case 2:break;case 0:r.assign(e,n);break;case 1:r.subtract(e,n,o);break}},d=2,p=()=>{let m=t.value;if(m!==d)switch(m){case 2:o=void 0;break;case 0:o=void 0,r.assign(n,e);break;case 1:o=r.difference(n,e);break}d=m,n.changed.dispatch()};return n.registerDisposer(n.changed.add(c)),n.registerDisposer(e.changed.add(l)),n.registerDisposer(t.changed.add(p)),p(),n}function kM(n,e,t,r){return xp(n,e,t,r)}var Ki=class extends j{constructor(e){super();this.coordinateSpace=e;this.coordinates_=no;this.changed=new re;this.registerDisposer(e.changed.add(()=>{this.handleCoordinateSpaceChanged()}))}get valid(){return this.coordinateSpace.value.valid}get value(){return this.handleCoordinateSpaceChanged(),this.coordinates_}reset(){this.curCoordinateSpace=void 0,this.coordinates_=no,this.changed.dispatch()}set value(e){let{curCoordinateSpace:t}=this;if(t===void 0||!t.valid||t.rank!==e.length)return;let{coordinates_:r}=this;r.set(e),this.changed.dispatch()}handleCoordinateSpaceChanged(){let e=this.coordinateSpace.value,t=this.curCoordinateSpace;if(e===t)return;this.curCoordinateSpace=e;let{rank:r}=e;if(!e.valid)return;if(t===void 0||!t.valid){let{coordinates_:p}=this;if(!(p!==void 0&&p.length===r)){p=this.coordinates_=new Float32Array(r),BE(p,e.bounds);for(let m=0;m<r;++m)p[m]=Math.floor(p[m])+.5}this.changed.dispatch();return}let i=new Float32Array(r),a=this.coordinates_,{ids:o,scales:l}=e,{ids:c,scales:d}=t;for(let p=0;p<r;++p){let m=o[p],g=c.indexOf(m);g===-1?i[p]=nS(e.bounds.lowerBounds[p],e.bounds.upperBounds[p]):i[p]=a[g]*(d[g]/l[p])}this.coordinates_=i,this.changed.dispatch()}toJSON(){if(!this.valid&&this.coordinates_.length===0)return;this.handleCoordinateSpaceChanged();let{value:e}=this;if(e.length!==0)return Array.from(e)}restoreState(e){if(e===void 0){this.reset();return}this.curCoordinateSpace=void 0,this.coordinates_=Float32Array.from(ge(e,Qe)),this.handleCoordinateSpaceChanged(),this.changed.dispatch()}snapToVoxel(){this.handleCoordinateSpaceChanged();let{coordinates_:e}=this,t=e.length;for(let r=0;r<t;++r)e[r]=Math.floor(e[r])+.5;this.changed.dispatch()}assign(e){e.handleCoordinateSpaceChanged();let{curCoordinateSpace:t,coordinates_:r}=e;this.curCoordinateSpace=t,this.coordinates_=Float32Array.from(r),this.changed.dispatch()}static getOffset(e,t){let r=e.coordinates_,i=t.coordinates_;if(r.length===i.length)return yh(new Float32Array(r.length),r,i)}static addOffset(e,t,r,i=1){e.handleCoordinateSpaceChanged();let{value:a}=t;r!==void 0&&a.length===r.length&&(DE(e.value,a,r,i),e.changed.dispatch())}get legacyJsonView(){let e=this;return{changed:e.changed,toJSON(){return e.toJSON()},reset(){e.reset()},restoreState(t){if(t===void 0||Array.isArray(t)){e.restoreState(t);return}Z(t),ln(t,"voxelCoordinates",e)}}}};function EM(n,e,t){if(t===void 0||Object.keys(t).length===0){n.value=0;return}Z(t),n.value=2,W(t,"value",r=>{r!==void 0&&e.restoreState(r)}),W(t,"link",r=>n.restoreState(r))}var eu=class{constructor(e,t=new wM){this.peer=e;this.link=t}get changed(){return this.value.changed}toJSON(){let{link:e}=this;if(e.value!==0)return{link:e.toJSON(),value:this.getValueJson()}}getValueJson(){return this.value.toJSON()}reset(){this.link.value=0}restoreState(e){EM(this.link,this.value,e)}copyToPeer(){this.link.value!==0&&(this.link.value=2,this.peer.assign(this.value),this.link.value=0)}},Nx=class extends eu{constructor(e,t=new TM){super(e,t)}},Cp=class extends eu{constructor(){super(...arguments);this.value=xp(new Ki(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:e=>e.valid,difference:Ki.getOffset,add:Ki.addOffset,subtract:(e,t,r)=>{Ki.addOffset(e,t,r,-1)}})}};function gj(n){return n[0]===0&&n[1]===0&&n[2]===0&&n[3]===1}var So=class extends j{constructor(e){super();this.changed=new re;e==null&&(e=Ke.create()),this.orientation=e}toJSON(){let{orientation:e}=this;if(Ke.normalize(this.orientation,this.orientation),!gj(e))return Array.prototype.slice.call(this.orientation)}restoreState(e){try{wc(this.orientation,e),Ke.normalize(this.orientation,this.orientation)}catch(t){Ke.identity(this.orientation)}this.changed.dispatch()}reset(){Ke.identity(this.orientation),this.changed.dispatch()}snap(){let e=Dt.create();Dt.fromQuat(e,this.orientation);let t=[!1,!1,!1];for(let r=0;r<3;++r){let i=0,a=0;for(let o=0;o<3;++o){let l=e[r*3+o];e[r*3+o]=0,!t[o]&&Math.abs(l)>Math.abs(i)&&(i=l,a=o)}e[r*3+a]=Math.sign(i),t[a]=!0}Ke.fromMat3(this.orientation,e),this.changed.dispatch()}static makeRelative(e,t){let r=new So(Ke.multiply(Ke.create(),e.orientation,t)),i=!1;r.registerDisposer(e.changed.add(()=>{i||(a=!0,Ke.multiply(r.orientation,e.orientation,t),r.changed.dispatch(),a=!1)}));let a=!1,o=Ke.invert(Ke.create(),t);return r.registerDisposer(r.changed.add(()=>{a||(i=!0,Ke.multiply(e.orientation,r.orientation,o),e.changed.dispatch(),i=!1)})),r}assign(e){Ke.copy(this.orientation,e.orientation),this.changed.dispatch()}},tu=class extends eu{constructor(){super(...arguments);this.value=xp(new So,this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:()=>!0,difference:(e,t)=>{let r=Ke.create();return Ke.multiply(r,Ke.invert(r,t.orientation),e.orientation)},add:(e,t,r)=>{Ke.multiply(e.orientation,t.orientation,r),e.changed.dispatch()},subtract:(e,t,r)=>{Ke.multiply(e.orientation,t.orientation,Ke.invert(LM,r)),e.changed.dispatch()}})}},ug=class extends j{constructor(e){super();this.coordinateSpace=e;this.changed=new re;this.curCoordinateSpace=ei;this.value_={factors:new Float64Array(0)};this.registerDisposer(e.changed.add(()=>this.update())),this.update()}get value(){return this.update()}reset(){this.value_={factors:new Float64Array(0)},this.curCoordinateSpace=ei,this.changed.dispatch()}toJSON(){let e={},t=!1,{value:r}=this,{factors:i}=r,{names:a,rank:o}=this.curCoordinateSpace;for(let l=0;l<o;++l){let c=i[l];c!==1&&(e[a[l]]=c,t=!0)}if(t)return e}restoreState(e){let{coordinateSpace:{value:t}}=this,{names:r,rank:i}=t,a=new Float64Array(i);if(a.fill(-1),e!==void 0){let o=Z(e);for(let l=0;l<i;++l)a[l]=W(o,r[l],c=>c===void 0?1:it(c))}this.value_={factors:a},this.curCoordinateSpace=t,this.changed.dispatch()}setFactors(e){let{coordinateSpace:{value:t}}=this;e.length===t.rank&&(this.value_={factors:e},this.curCoordinateSpace=t,this.changed.dispatch())}update(){let{coordinateSpace:{value:e}}=this,t=this.value_,{curCoordinateSpace:r}=this;if(r===e)return t;let{ids:i}=r,{ids:a,rank:o}=e,l=t.factors,c=new Float64Array(o);c.fill(1);for(let d=0;d<o;++d){let p=a[d],m=i.indexOf(p);m!==-1&&(c[d]=l[m])}return xe(c,l)||(t=this.value_={factors:c},this.curCoordinateSpace=e,this.changed.dispatch()),t}assign(e){this.setFactors(e.value.factors)}};function DM(n,e,t,r,i){if(t===r)return e;let{ids:a}=t,{rank:o,ids:l}=r,c=new n(o);for(let d=0;d<o;++d){let p=l[d],m=a.indexOf(p);c[d]=m===-1?i(d):e[m]}return c}var Bx=class extends eu{constructor(){super(...arguments);this.value=xp(new ug(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),difference:(e,t)=>{let{factors:r}=e.value,i=e.coordinateSpace.value,a=t.value.factors;return{coordinateSpace:i,offsets:yh(new Float64Array(r.length),r,a)}},add:(e,t,r)=>{let i=DM(Float64Array,r.offsets,r.coordinateSpace,e.coordinateSpace.value,()=>0);e.setFactors(gh(new Float64Array(i.length),i,t.value.factors))},subtract:(e,t,r)=>{let i=DM(Float64Array,r.offsets,r.coordinateSpace,e.coordinateSpace.value,()=>0);e.setFactors(yh(new Float64Array(i.length),t.value.factors,i))},isValid:()=>!0})}};function PM(n,e,t){let{rank:r,names:i,units:a}=n,{displayRank:o,displayDimensionIndices:l}=e,c=new Float64Array(3),d=new Float64Array(3),p,{factors:m}=t,g=new Array(3),v=new Float64Array(3);if(c.fill(1),d.fill(1),v.fill(1),g.fill(""),o===0)p=1;else{p=Number.POSITIVE_INFINITY;let{scales:b}=n;for(let x=0;x<o;++x){let C=l[x],T=d[x]=m[C]*b[C];p=Math.min(p,T),g[x]=a[C],v[x]=b[C]}for(let x=0;x<o;++x)c[x]=d[x]/p}return{globalRank:r,globalDimensionNames:i,displayRank:o,displayDimensionIndices:l,displayDimensionUnits:g,displayDimensionScales:v,canonicalVoxelFactors:c,voxelPhysicalScales:d,canonicalVoxelPhysicalSize:p}}function yj(n,e){return xe(n.globalDimensionNames,e.globalDimensionNames)&&xe(n.displayDimensionIndices,e.displayDimensionIndices)&&xe(n.canonicalVoxelFactors,e.canonicalVoxelFactors)&&xe(n.voxelPhysicalScales,e.voxelPhysicalScales)&&n.canonicalVoxelPhysicalSize===e.canonicalVoxelPhysicalSize&&xe(n.displayDimensionUnits,e.displayDimensionUnits)&&xe(n.displayDimensionScales,e.displayDimensionScales)}var wp=class extends j{constructor(e,t){super();this.relativeDisplayScales=e;this.displayDimensions=t;this.changed=new re;this.curRelativeDisplayScales=this.relativeDisplayScales.value;this.curDisplayDimensions=this.displayDimensions.value;this.curCoordinateSpace=this.relativeDisplayScales.coordinateSpace.value;this.value_=PM(this.curCoordinateSpace,this.curDisplayDimensions,this.curRelativeDisplayScales);this.registerDisposer(e),this.registerDisposer(t);let r=()=>{this.value};this.registerDisposer(e.changed.add(r)),this.registerDisposer(t.changed.add(r))}get value(){let{relativeDisplayScales:{value:e,coordinateSpace:{value:t}},displayDimensions:{value:r},curRelativeDisplayScales:i,curDisplayDimensions:a,curCoordinateSpace:o}=this,l=this.value_;if(i!==e||a!==r||o!==t){this.curRelativeDisplayScales=e,this.curDisplayDimensions=r,this.curCoordinateSpace=t;let c=PM(t,r,e);yj(l,c)||(this.value_=l=c,this.changed.dispatch())}return l}},dg=class extends j{constructor(e){super();this.coordinateSpace=e;this.changed=new re;this.default_=!0;this.value_=void 0;this.registerDisposer(this.coordinateSpace.changed.add(this.changed.dispatch)),this.update()}get value(){return this.update(),this.value_}update(){let{coordinateSpace:{value:e}}=this,t=this.value_;if(t!==void 0&&t.coordinateSpace===e)return;if(t===void 0||this.default_){this.setToDefault(e);return}let r=new Int32Array(3),{ids:i}=t.coordinateSpace,{ids:a}=e,o=t.displayDimensionIndices,l=t.displayRank,c=0;for(let d=0;d<l;++d){let p=a.indexOf(i[o[d]]);p!==-1&&(r[c]=p,++c)}if(r.fill(-1,c),c===0){this.default_=!0,this.setToDefault(e);return}this.assignValue(e,c,r),this.changed.dispatch()}setToDefault(e){let t=Math.min(e.rank,3),r=new Int32Array(3);r.fill(-1);for(let i=0;i<t;++i)r[i]=i;this.assignValue(e,t,r)}assignValue(e,t,r){this.value_={coordinateSpace:e,displayRank:t,displayDimensionIndices:r},this.changed.dispatch()}reset(){this.default_=!0,this.value_=void 0,this.changed.dispatch()}restoreState(e){if(e===void 0){this.reset();return}let t=Dd(e);if(t.length>3)throw new Error("Number of spatial dimensions must be <= 3");let{coordinateSpace:{value:r}}=this,i=new Int32Array(3);i.fill(-1);let{names:a}=r,o=0;for(let l of t){let c=a.indexOf(l);c!==-1&&(i[o++]=c)}if(o===0){this.reset();return}this.default_=!1,this.assignValue(r,o,i)}get default(){return this.update(),this.default_}set default(e){this.default_!==e&&(e?(this.default_=!0,this.setToDefault(this.coordinateSpace.value)):(this.default_=!1,this.changed.dispatch()))}setDimensionIndices(e,t){this.default_=!1,this.assignValue(this.coordinateSpace.value,e,t)}toJSON(){if(this.default_)return;let{value:e}=this,t=[],{displayRank:r,displayDimensionIndices:i,coordinateSpace:{names:a}}=e;if(r!==0){for(let o=0;o<r;++o)t[o]=a[i[o]];return t}}assign(e){if(e.default)this.default=!0;else{let{displayRank:t,displayDimensionIndices:r}=e.value;this.setDimensionIndices(t,r)}}},Ux=class extends Nx{constructor(e){super(e);this.value=kM(new dg(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:()=>!0})}},Na=class extends j{constructor(e,t,r){super();this.position=e;this.displayDimensionRenderInfo=t;this.orientation=r;this.changed=new re;this.registerDisposer(e),this.registerDisposer(r),this.registerDisposer(t),this.registerDisposer(e.changed.add(this.changed.dispatch)),this.registerDisposer(r.changed.add(this.changed.dispatch)),this.registerDisposer(t.changed.add(this.changed.dispatch))}get displayDimensions(){return this.displayDimensionRenderInfo.displayDimensions}get relativeDisplayScales(){return this.displayDimensionRenderInfo.relativeDisplayScales}get valid(){return this.position.valid}reset(){this.position.reset(),this.orientation.reset(),this.displayDimensions.reset()}updateDisplayPosition(e,t=cg){let{coordinateSpace:{value:r},value:i}=this.position,{displayDimensionIndices:a,displayRank:o}=this.displayDimensions.value;if(r===void 0)return!1;t.fill(0);for(let l=0;l<o;++l){let c=a[l];t[l]=i[c]}if(e(t)!==!1){for(let l=0;l<o;++l){let c=a[l];i[c]=t[l]}return this.position.changed.dispatch(),!0}return!1}toMat4(e,t){ae.fromQuat(e,this.orientation.orientation);let{value:r}=this.position,{canonicalVoxelFactors:i,displayDimensionIndices:a}=this.displayDimensionRenderInfo.value;for(let o=0;o<3;++o){let l=a[o],c=t/i[o];e[o]*=c,e[4+o]*=c,e[8+o]*=c,e[12+o]=r[l]||0}}toMat3(e,t){Dt.fromQuat(e,this.orientation.orientation);let{canonicalVoxelFactors:r,displayRank:i}=this.displayDimensionRenderInfo.value;for(let a=0;a<i;++a){let o=t/r[a];e[a]*=o,e[3+a]*=o,e[6+a]*=o}}snap(){this.orientation.snap(),this.position.snapToVoxel(),this.changed.dispatch()}translateDimensionRelative(e,t){if(!this.valid)return;let{position:r}=this,{value:i}=r,{bounds:{lowerBounds:a,upperBounds:o}}=r.coordinateSpace.value,l=i[e]+t;if(t>0){let c=o[e];Number.isFinite(c)&&(l=Math.min(l,Math.ceil(c-1)))}else{let c=a[e];Number.isFinite(c)&&(l=Math.max(l,Math.floor(c)))}i[e]=l,r.changed.dispatch()}translateVoxelsRelative(e,t=!1){if(!this.valid)return;let r=K.transformQuat(cg,e,this.orientation.orientation),{position:i}=this,{value:a}=i,{displayDimensionIndices:o,displayRank:l}=this.displayDimensions.value,{bounds:{lowerBounds:c,upperBounds:d}}=i.coordinateSpace.value;for(let p=0;p<l;++p){let m=o[p],g=r[p];if(g===0)continue;let v=a[m]+g;if(g>0){let b=d[m];Number.isFinite(b)&&(v=Math.min(v,Math.ceil(b-1)))}else{let b=c[m];Number.isFinite(b)&&(v=Math.max(v,Math.floor(b)))}t&&(v=Math.floor(v)+.5),a[m]=v}this.position.changed.dispatch()}rotateRelative(e,t){var r=Ke.create();Ke.setAxisAngle(r,e,t);var i=this.orientation.orientation;Ke.multiply(i,i,r),this.orientation.changed.dispatch()}rotateAbsolute(e,t,r){let{coordinateSpace:{value:i},value:a}=this.position;if(i===void 0)return;let{relativeDisplayScales:{value:{factors:o}},displayDimensions:{value:{displayDimensionIndices:l,displayRank:c}}}=this,{scales:d}=i,p=Ke.create();Ke.setAxisAngle(p,e,t);let m=this.orientation.orientation,g=cg;cg.fill(0);for(let b=0;b<c;++b){let x=l[b],C=r[x]-a[x];g[b]=C*d[x]*o[x]}let v=Ke.invert(LM,m);K.transformQuat(g,g,v),Ke.multiply(m,p,m),K.transformQuat(g,g,m);for(let b=0;b<c;++b){let x=l[b];a[x]=r[x]-g[b]/(d[x]*o[x])}this.position.changed.dispatch(),this.orientation.changed.dispatch()}translateNonDisplayDimension(e,t){if(!this.valid)return;let{displayDimensionIndices:r}=this.displayDimensions.value,{position:i}=this,a=i.coordinateSpace.value.rank;for(let o=0;o<a;++o)if(r.indexOf(o)===-1&&e--==0){this.translateDimensionRelative(o,t);return}}},nu=class extends eu{constructor(e,t){super(e);this.value=(()=>{let r=new e.constructor(t),i=(d,p)=>{d.assign(p)},a=(d,p)=>d.value/p.value*(d.canonicalVoxelPhysicalSize/p.canonicalVoxelPhysicalSize),o=(d,p,m)=>{d.setPhysicalScale(p.value*m,p.canonicalVoxelPhysicalSize)},l=(d,p,m)=>{d.setPhysicalScale(p.value/m,p.canonicalVoxelPhysicalSize)},c=d=>d.coordinateSpaceValue.valid&&d.canonicalVoxelPhysicalSize!==0;return xp(r,this.peer,this.link,{assign:i,isValid:c,difference:a,add:o,subtract:l}),r})()}};function Rl(n){return{changed:n.changed,toJSON(){return n.toJSON()},restoreState(e){EM(n.link,n.value.legacyJsonView,e)},reset(){n.reset()}}}var Fx=class extends j{constructor(e){super();this.displayDimensionRenderInfo=e;this.changed=new re;this.curCanonicalVoxelPhysicalSize=0;this.value_=Number.NaN;this.legacyValue_=Number.NaN;this.registerDisposer(e),this.registerDisposer(e.changed.add(()=>this.handleCoordinateSpaceChanged())),this.registerDisposer(e.relativeDisplayScales.coordinateSpace.changed.add(()=>this.handleCoordinateSpaceChanged())),this.handleCoordinateSpaceChanged()}get value(){return this.handleCoordinateSpaceChanged(),this.value_}set value(e){let{canonicalVoxelPhysicalSize:t}=this;Object.is(e,this.value_)&&t===this.curCanonicalVoxelPhysicalSize||(this.curCanonicalVoxelPhysicalSize=t,this.legacyValue_=Number.NaN,this.value_=e,this.changed.dispatch())}get canonicalVoxelPhysicalSize(){return this.displayDimensionRenderInfo.value.canonicalVoxelPhysicalSize}get coordinateSpaceValue(){return this.displayDimensionRenderInfo.relativeDisplayScales.coordinateSpace.value}set legacyValue(e){Object.is(e,this.legacyValue_)||(this.value_=Number.NaN,this.legacyValue_=e,this.curCanonicalVoxelPhysicalSize=0,this.changed.dispatch())}get legacyValue(){return this.legacyValue_}handleCoordinateSpaceChanged(){let{value_:e}=this,{displayDimensionRenderInfo:{value:{canonicalVoxelPhysicalSize:t},relativeDisplayScales:{coordinateSpace:{value:r}}}}=this,{curCanonicalVoxelPhysicalSize:i}=this;if(!(!Number.isNaN(e)&&t===i)){if(!Number.isNaN(e)){i!==0&&(this.value_=e*(i/t),this.curCanonicalVoxelPhysicalSize=t,this.changed.dispatch());return}!r.valid||t===0||(this.curCanonicalVoxelPhysicalSize=t,this.value_=this.getDefaultValue(),this.changed.dispatch())}}toJSON(){let{value:e}=this;return Number.isNaN(e)?void 0:e}restoreState(e){this.curCanonicalVoxelPhysicalSize=0,this.legacyValue_=Number.NaN,e===void 0?this.value_=Number.NaN:this.value_=it(e),this.changed.dispatch()}reset(){this.curCanonicalVoxelPhysicalSize=0,this.value_=Number.NaN,this.legacyValue_=Number.NaN,this.changed.dispatch()}get legacyJsonView(){let e=this;return{changed:e.changed,toJSON(){return e.toJSON()},reset(){return e.reset()},restoreState(t){e.legacyValue=it(t)}}}setPhysicalScale(e,t){let r=this.curCanonicalVoxelPhysicalSize=this.canonicalVoxelPhysicalSize;this.value=e*(t/r)}assign(e){let{legacyValue:t}=e;Number.isNaN(t)?this.setPhysicalScale(e.value,e.canonicalVoxelPhysicalSize):this.legacyValue=t}},Gx=class extends Fx{getDefaultValue(){let{legacyValue_:e}=this;if(Number.isNaN(e))return 1;let{canonicalVoxelPhysicalSize:t}=this;return this.legacyValue_*1e-9/t}},Wx=class extends Fx{getDefaultValue(){let{legacyValue_:e}=this;if(!Number.isNaN(e)){this.legacyValue_=Number.NaN;let{canonicalVoxelPhysicalSize:l}=this;return 2*100*Math.tan(Math.PI/8)*1e-9*e/l}let{coordinateSpaceValue:{bounds:{lowerBounds:t,upperBounds:r}}}=this,{canonicalVoxelFactors:i,displayDimensionIndices:a}=this.displayDimensionRenderInfo.value,o=i.reduce((l,c,d)=>{let p=a[d],m=(r[p]-t[p])*c;return Math.max(l,m)},0);return Number.isFinite(o)?o=2**Math.ceil(Math.log2(o)):o=1024,o}},Tp=class extends j{constructor(e,t){super();this.defaultValue=e;this.displayDimensionRenderInfo=t;this.changed=new re;this.value_=e,this.canonicalVoxelPhysicalSize=t.value.canonicalVoxelPhysicalSize,this.registerDisposer(t.changed.add(()=>{this.value}))}get value(){let{value_:e}=this;if(e>0){let{canonicalVoxelPhysicalSize:t}=this.displayDimensionRenderInfo.value,r=this.canonicalVoxelPhysicalSize;t!==r&&(this.canonicalVoxelPhysicalSize=t,e=this.value_=e=r/t,this.changed.dispatch())}return e}set value(e){if(e===this.value)return;this.value_=e;let{canonicalVoxelPhysicalSize:t}=this.displayDimensionRenderInfo.value;this.canonicalVoxelPhysicalSize=t,this.changed.dispatch()}toJSON(){let{value:e}=this;if(e!==this.defaultValue)return e}reset(){this.value=this.defaultValue}restoreState(e){typeof e!="number"||!Number.isFinite(e)||e===0?this.value=this.defaultValue:this.value=e}setValueAbsolute(e,t){if(e>0){let{canonicalVoxelPhysicalSize:r}=this.displayDimensionRenderInfo.value;e=e*(t/r)}this.value=e}assign(e){this.setValueAbsolute(e.value,e.canonicalVoxelPhysicalSize)}},pg=class extends Nx{constructor(e,t){super(e);this.value=kM(new Tp(e.defaultValue,t),this.peer,this.link,{assign:(r,i)=>r.assign(i),isValid:()=>!0})}},Ba=class extends j{constructor(e,t,r){super();this.pose=e;this.zoomFactor=t;this.depthRange=r;this.changed=new re;this.registerDisposer(e),this.registerDisposer(t),this.registerDisposer(r),this.registerDisposer(this.pose.changed.add(this.changed.dispatch)),this.registerDisposer(this.zoomFactor.changed.add(this.changed.dispatch)),this.registerDisposer(this.depthRange.changed.add(this.changed.dispatch))}get coordinateSpace(){return this.pose.position.coordinateSpace}reset(){this.pose.reset(),this.zoomFactor.reset()}get position(){return this.pose.position}get displayDimensions(){return this.pose.displayDimensions}get relativeDisplayScales(){return this.pose.relativeDisplayScales}get displayDimensionRenderInfo(){return this.pose.displayDimensionRenderInfo}toMat4(e){this.pose.toMat4(e,this.zoomFactor.value)}toMat3(e){this.pose.toMat3(e,this.zoomFactor.value)}get relativeDepthRange(){let e=this.depthRange.value;return e>0?e/=this.zoomFactor.value:e*=-1,e}get valid(){return this.pose.valid&&!Number.isNaN(this.zoomFactor.value)}zoomBy(e){this.zoomFactor.value*=e}};var _l='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="plusIconTitle"><path d="M20 12L4 12M12 4L12 20"></path></svg>';function fg(n={}){return He({svg:_l,...n})}var IM='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="arrowUpIconTitle"><path d="M18 9l-6-6-6 6"></path><path d="M12 21V4"></path><path stroke-linecap="round" d="M12 3v1"></path></svg>';var Lp=new Ee(0);window.addEventListener("keydown",n=>{Lp.value=um(n)});window.addEventListener("keyup",n=>{Lp.value=um(n)});var vj=new Set(["f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12","escape","pause"]),Sj=new Set(["color","date","datetime","datetime-local","email","month","number","password","search","tel","text","time","url","week"]),$t=class extends j{constructor(e,t){super();this.target=e;this.eventMap=t;this.modifierShortcutsAreGlobal=!0;this.allShortcutsAreGlobal=!1;this.allowSpaceKeyOnButtons=!1;this.registerEventListener(e,"keydown",this.handleKeyDown.bind(this),!1)}shouldIgnoreEvent(e,t){var r=t.target;let{tagName:i}=r;if(r===this.target)return!1;var a=i==="TEXTAREA"||i==="INPUT"||i==="BUTTON"||i==="SELECT",o=!a&&(r.isContentEditable||r.ownerDocument&&r.ownerDocument.designMode==="on");return!a&&!o||this.allShortcutsAreGlobal||vj.has(e)?!1:o||this.modifierShortcutsAreGlobal&&(t.altKey||t.ctrlKey||t.metaKey)?!0:i==="INPUT"&&Sj.has(r.type)?e!=="enter":i==="INPUT"||i==="BUTTON"?this.allowSpaceKeyOnButtons?!1:e==="space":!0}handleKeyDown(e){let t=bj(e);this.shouldIgnoreEvent(t,e)||pm(t,e,e,this.eventMap)}};function bj(n){return n.code.toLowerCase()}function kp(n,e=n.value){n.style.minWidth=e.length+1+"ch"}var AM="neuroglancer-coordinate-space-transform-singleton";function MM(n,e){let t;n===Number.NEGATIVE_INFINITY?t="(-\u221E,":t=`[${Math.floor(n)},`;let r;return e===Number.POSITIVE_INFINITY?r="+\u221E)":r=`${Math.floor(e)})`,{lower:t,upper:r}}var RM=Me.fromObject({arrowup:{action:"move-up"},arrowdown:{action:"move-down"},arrowleft:{action:"move-left",preventDefault:!1},arrowright:{action:"move-right",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel"}});function _M(){let n=document.createElement("div"),e=document.createElement("input");n.classList.add("neuroglancer-coordinate-space-transform-scale-container"),e.spellcheck=!1,e.autocomplete="off",e.size=1,e.classList.add("neuroglancer-coordinate-space-transform-scale"),n.appendChild(e);let t=document.createElement("div"),r=document.createElement("span");r.innerHTML=IM,t.appendChild(r);let i=document.createTextNode("");return t.appendChild(i),t.classList.add("neuroglancer-coordinate-space-transform-scale-suggestion"),n.appendChild(t),{cellElement:n,inputElement:e,suggestionElement:t}}function VM(n,e,t,r,i){if(e===void 0||e.scale===t&&e.unit===r)n.style.display="none";else{n.style.display="";let a=Vi(e.scale,e.unit,{elide1:!1});n.lastChild.textContent=a,n.title=`${i}${a}`}}function OM(){let n=document.createElement("input");return n.spellcheck=!1,n.autocomplete="off",n.size=1,n.placeholder=" ",n.classList.add("neuroglancer-coordinate-space-transform-output-name"),n}function NM(n,e,t){let r=n.map(g=>Ho(g.value));if(r.includes(void 0))return!1;let i=Float64Array.from(r,g=>g.scale),a=Array.from(r,g=>g.unit),o=t.value,{scales:l,units:c,rank:d}=o;for(let g=0;g<d;++g)e[g]||(i[g]=l[g],a[g]=c[g]);if(xe(l,i)&&xe(c,a))return!1;let p=o.timestamps.map((g,v)=>i[v]===l[v]&&a[v]===c[v]?g:Date.now()),m=Be({valid:o.valid,rank:o.rank,scales:i,units:a,timestamps:p,ids:o.ids,names:o.names,boundingBoxes:o.boundingBoxes,coordinateArrays:o.coordinateArrays});return t.value=m,!0}function BM(n,e,t,r){let i=new Float64Array(n.scales),a=Array.from(n.units);if(i[e]===t&&a[e]===r)return n;let o=Array.from(n.timestamps);return i[e]=t,a[e]=r,o[e]=Date.now(),{...n,scales:i,units:a,timestamps:o}}var zx=class extends j{constructor(e,t,r){super();this.transform=e;this.localCombiner=t;this.globalCombiner=r;this.element=document.createElement("div");this.coefficientContainer=document.createElement("div");this.translationContainer=document.createElement("div");this.outputNameContainer=document.createElement("div");this.outputScaleContainer=document.createElement("div");this.inputNameContainer=document.createElement("div");this.inputScaleContainer=document.createElement("div");this.inputLowerBoundsContainer=document.createElement("div");this.inputUpperBoundsContainer=document.createElement("div");this.coefficientElements=[];this.inputNameElements=[];this.outputNameElements=[];this.outputScaleElements=[];this.outputScaleSuggestionElements=[];this.inputScaleSuggestionElements=[];this.inputScaleElements=[];this.inputBoundsElements=[];this.outputBoundsElements=[];this.addSourceDimensionIcon=He({svg:_l,text:"S"});this.addOutputDimensionIcon=He({svg:_l,text:"V"});this.addOutputDimensionCell=document.createElement("div");this.addOutputDimensionInput=OM();this.inputScaleModified=[];this.outputScaleModified=[];this.curSourceRank=-1;this.curRank=-1;this.curTransform=void 0;this.addingSourceDimension=!1;this.resetToIdentityButton=He({text:"Set to identity",title:"Reset to identity transform",onClick:()=>{let{transform:e}=this,t=e.value.rank;e.transform=Yt(Float64Array,t+1)}});this.resetToDefaultButton=He({text:"Reset to default",title:"Reset to default input scales, transform, and output dimensions.",onClick:()=>{let{transform:e}=this;if(e.mutableSourceRank)return;let{defaultTransform:t}=e,{outputSpace:r}=t,i=r.ids.map(()=>Ks());e.value={...t,outputSpace:{...r,ids:i}}}});let{element:i}=this,a=this.registerDisposer(new $t(i,RM));a.allShortcutsAreGlobal=!0,i.classList.add("neuroglancer-coordinate-space-transform-widget"),this.registerDisposer(new wn(i,RM));let o=We(()=>this.updateView());this.registerDisposer(e.changed.add(o));let{coefficientContainer:l,translationContainer:c,outputNameContainer:d,inputNameContainer:p,inputScaleContainer:m,inputLowerBoundsContainer:g,inputUpperBoundsContainer:v,outputScaleContainer:b,addOutputDimensionCell:x,addOutputDimensionIcon:C,addSourceDimensionIcon:T,resetToIdentityButton:I,resetToDefaultButton:P}=this;l.style.display="contents",c.style.display="contents",d.style.display="contents",p.style.display="contents",m.style.display="contents",b.style.display="contents",g.style.display="contents",v.style.display="contents";let M=document.createElement("div");M.classList.add("neuroglancer-coordinate-space-transform-widget-reset-buttons"),I.classList.add("neuroglancer-coordinate-space-transform-widget-reset-to-identity"),P.classList.add("neuroglancer-coordinate-space-transform-widget-reset-to-default"),M.appendChild(I),M.appendChild(P),i.appendChild(M);for(let[B,z]of[["source","Source dimensions"],["output","Output dimensions"],["input-lower","Lower"],["input-upper","Upper"],["input-scale","Scale"],["translation","Translation"]]){let _=document.createElement("div");_.classList.add(`neuroglancer-coordinate-space-transform-${B}-label`),_.classList.add("neuroglancer-coordinate-space-transform-label"),_.textContent=z,i.appendChild(_)}e.mutableSourceRank&&x.appendChild(T),x.appendChild(C),x.classList.add("neuroglancer-coordinate-space-transform-output-extend");let D="Embed in additional output dimension",E="Extend to additional source dimension";C.title=D,T.title=E,x.appendChild(this.addOutputDimensionInput),x.dataset.isActive="false",C.addEventListener("click",()=>{this.addingSourceDimension=!1,this.addOutputDimensionInput.title=D,this.addOutputDimensionCell.dataset.isActive="true",this.addOutputDimensionInput.focus()}),T.addEventListener("click",()=>{this.addingSourceDimension=!0,this.addOutputDimensionInput.title=E,this.addOutputDimensionCell.dataset.isActive="true",this.addOutputDimensionInput.focus()}),this.addOutputDimensionInput.addEventListener("blur",()=>{this.updateAddOutputDimensionCellStyle()}),i.appendChild(l),i.appendChild(d),i.appendChild(p),i.appendChild(m),i.appendChild(b),i.appendChild(g),i.appendChild(v),l.appendChild(c),i.addEventListener("input",B=>{let{target:z}=B;if(z instanceof HTMLInputElement){kp(z);let _=this.inputScaleElements.indexOf(z);if(_!==-1){this.inputScaleModified[_]=!0,this.updateScaleValidity(z);return}if(_=this.outputScaleElements.indexOf(z),_!==-1){this.outputScaleModified[_]=!0,this.updateScaleValidity(z);return}if(_=this.outputNameElements.indexOf(z),_!==-1){this.updateOutputNameValidity();return}if(this.coefficientContainer.contains(z)){this.updateCoefficientValidity(z);return}}});let V=(B,z,_)=>{ce(i,B,U=>{U.stopPropagation();let N=U.target;if(!(N instanceof HTMLInputElement)||_!==0&&(N.selectionStart!==N.selectionEnd||N.selectionStart!==(_===1?N.value.length:0)))return;let J=this.getElementGridPosition(N);if(J===void 0)return;let ie=this.getElementByGridPosition(J.row+z,J.col+_);ie!==null&&(ie.focus(),U.preventDefault())})};V("move-up",-1,0),V("move-down",1,0),V("move-left",0,-1),V("move-right",0,1);let O=(B,z)=>{B.addEventListener("focusout",_=>{let{relatedTarget:U}=_;U instanceof Node&&B.contains(U)||z(_)})};O(l,()=>{this.updateModelTransform()||this.updateViewTransformCoefficients()}),O(d,()=>{this.updateModelOutputNames()||this.updateViewOutputNames()}),O(m,()=>{this.updateModelInputScales()||this.updateViewInputScales()}),O(b,()=>{this.updateModelOutputScales()||this.updateViewOutputScales()}),ce(i,"cancel",B=>{this.curTransform=void 0,this.updateView(),B.target.blur()}),ce(l,"commit",()=>{this.updateModelTransform()}),ce(d,"commit",()=>{this.updateModelOutputNames()}),ce(m,"commit",()=>{this.updateModelInputScales()}),ce(b,"commit",()=>{this.updateModelOutputScales()}),i.addEventListener("focusin",B=>{let{target:z}=B;z instanceof HTMLInputElement&&z.select()}),this.updateView()}updateWillBeDeletedAttributes(e){let{rank:t}=this.transform.value;e===void 0&&(e=new Array(t),e.fill(!1));let{coefficientElements:r,inputBoundsElements:i,inputScaleElements:a}=this;for(let o=0;o<t;++o){let l=e[o];for(let p=0;p<=t;++p){let m=r[t*p+o],g=p<t&&e[p];m.dataset.willBeDeleted=(l||g).toString()}a[o].dataset.willBeDeleted=l.toString();let{lower:c,upper:d}=i[o];c.dataset.willBeDeleted=l.toString(),d.dataset.willBeDeleted=l.toString()}}updateAddOutputDimensionCellStyle(){let{addOutputDimensionInput:e}=this;this.addOutputDimensionCell.dataset.isActive=(e.value.length!==0||document.activeElement===e).toString()}updateOutputNameValidity(){let{outputNameElements:e}=this,t=e.map(c=>c.value),{value:{sourceRank:r,rank:i},mutableSourceRank:a}=this.transform;if(e.length!==i+1)return;let o=Ed(t),l=new Array(i);l.fill(!1);for(let c=0;c<=i;++c){let d=o[c];t[c].length===0&&(a||c>=r)&&(d=!0,l[c]=!0),e[c].dataset.isValid=d.toString()}this.updateWillBeDeletedAttributes(l),this.updateAddOutputDimensionCellStyle()}updateScaleValidity(e){let t=Ho(e.value)!==void 0;e.dataset.isValid=t.toString()}updateCoefficientValidity(e){let t=Number.isFinite(Number(e.value));e.dataset.isValid=t.toString()}getElementGridPosition(e){{let t=this.outputNameElements.indexOf(e);if(t!==-1)return{row:t,col:-2}}{let t=this.inputScaleElements.indexOf(e);if(t!==-1)return{row:-1,col:t}}{let t=this.coefficientElements.indexOf(e),{rank:r}=this.transform.value;if(t!==-1)return{row:t%r,col:Math.floor(t/r)}}{let t=this.outputScaleElements.indexOf(e);if(t!==-1)return{row:t,col:-1}}}getElementByGridPosition(e,t){let{rank:r}=this.transform.value;return e===-1?t<0||t>=r?null:this.inputScaleElements[t]:t===-2?e<0||e>r?null:this.outputNameElements[e]:t===-1?e<0||e>=r?null:this.outputScaleElements[e]:e<0||e>=r||t<0||t>r?null:this.coefficientElements[t*r+e]}dimensionRefCount(e){return($o(e)?this.localCombiner:this.globalCombiner).dimensionRefCounts.get(e)||0}updateModelInputScales(){return NM(this.inputScaleElements,this.inputScaleModified,this.transform.inputSpace)}updateModelOutputScales(){return NM(this.outputScaleElements,this.outputScaleModified,this.transform.outputSpace)}updateModelOutputNames(){let e=this.outputNameElements.map(I=>I.value),{value:t,mutableSourceRank:r}=this.transform,{outputSpace:i,rank:a,sourceRank:o}=t;if(e.length!==a+1)return;let l=[],c=[],d=e[a].length!==0,p=o;for(let I=0;I<=a;++I){let P=e[I];if(P.length===0){if(I<o){if(!r)return!1;--p}continue}c.push(P),l.push(I)}if(!Ic(c))return!1;let m=i.names;if(!d&&xe(m,c))return!0;let g=t.inputSpace,v=t.outputSpace,b=t.transform;if(d){this.addingSourceDimension&&++p;let I=e[a],P=($o(I)?this.localCombiner:this.globalCombiner).combined.value,M=P.names.indexOf(I),D,E;M!==-1?(D=P.units[M],E=P.scales[M]):(D="",E=1);let V=g.boundingBoxes.map(O=>aS(O,a,a+1));this.addingSourceDimension||V.push(iS(a+1,a)),g=Be({valid:g.valid,rank:a+1,names:[...g.names,""],ids:[...g.ids,Ks()],timestamps:[...g.timestamps,Date.now()],scales:Float64Array.from([...g.scales,E]),units:[...g.units,D],boundingBoxes:V,coordinateArrays:[...g.coordinateArrays,void 0]}),v=Be({valid:i.valid,rank:a+1,names:[...i.names,I],ids:[...i.ids,Ks()],timestamps:[...i.timestamps,Date.now()],scales:Float64Array.from([...i.scales,E]),units:[...i.units,D],coordinateArrays:[...i.coordinateArrays,void 0]}),b=Td(new Float64Array((a+2)**2),a+1,b,a)}b=Lh(Float64Array,b,g.rank,l,l),g=kh(g,l),v=kh(v,l);let x=v.ids.map((I,P)=>{let M=l[P];if(M===a)return I;let D=c[P],E=m[M];return D===E||this.dimensionRefCount(E)===1&&this.dimensionRefCount(D)===(m.includes(D)?1:0)?I:Ks()}),C=v.timestamps.map((I,P)=>{let M=l[P];return M===a||c[P]===m[M]?I:Date.now()});v={...v,names:c,ids:x,timestamps:C};let T={rank:v.rank,sourceRank:p,outputSpace:v,inputSpace:g,transform:b};return this.transform.value=T,!0}updateModelTransform(){let e=this.coefficientElements,{rank:t}=this.transform.value,r=new Float64Array((t+1)**2);r[r.length-1]=1;for(let i=0;i<t;++i)for(let a=0;a<=t;++a){let o=e[a*t+i],l=parseFloat(o.value);if(!Number.isFinite(l))return!1;r[a*(t+1)+i]=l}return this.transform.transform=r,!0}updateViewOutputNames(){let{transform:{value:{outputSpace:e,rank:t}}}=this;if(t!==this.curRank)return;let{outputNameElements:r}=this,{names:i}=e;for(let a=0;a<t;++a){let o=r[a];o.value=i[a],o.dataset.isValid="true",kp(o)}r[t].value="",this.updateWillBeDeletedAttributes()}updateViewTransformCoefficients(){let{transform:{value:{transform:e,rank:t}}}=this,{coefficientElements:r}=this;for(let i=0;i<t;++i)for(let a=0;a<=t;++a){let o=r[a*t+i];o.value=e[a*(t+1)+i].toString(),o.dataset.isValid="true",kp(o)}}ensureViewRankUpdated(){let e=this.transform.value,{rank:t}=e,r=e.sourceRank;if(this.curSourceRank===r&&this.curRank===t)return;let{inputBoundsElements:i,inputNameElements:a,inputScaleElements:o}=this,{element:l,coefficientElements:c,outputNameElements:d,outputScaleElements:p,outputScaleSuggestionElements:m,inputScaleSuggestionElements:g,outputBoundsElements:v,coefficientContainer:b,translationContainer:x,outputNameContainer:C,inputNameContainer:T,inputScaleContainer:I,inputLowerBoundsContainer:P,inputUpperBoundsContainer:M,outputScaleContainer:D}=this;l.style.gridTemplateColumns=`[outputLabel headerStart] min-content [outputNames] 1fr [outputScales] 1fr [headerEnd] repeat(${Math.max(1,t)+1}, [sourceDim] 1fr)`,l.style.gridTemplateRows=`[sourceLabel headerStart] auto [sourceNames] auto [sourceLower] auto [sourceUpper] auto [sourceScales] auto [headerEnd]repeat(${t+1}, [outputDim] auto)`,Ie(b),Ie(x),b.appendChild(x),Ie(C),Ie(T),Ie(I),Ie(P),Ie(M),Ie(D),a.length=0,o.length=0,i.length=0,p.length=0,m.length=0,g.length=0,c.length=0,d.length=0,v.length=0;for(let E=0;E<t;++E){let V=O=>{O.classList.add("neuroglancer-coordinate-space-transform-input"),E>=r&&O.classList.add(AM)};{let O=document.createElement("div");O.classList.add("neuroglancer-coordinate-space-transform-input-name"),V(O),O.style.gridRowStart="sourceNames",O.style.gridColumnStart=`sourceDim ${E+1}`,T.appendChild(O),a.push(O)}{let{cellElement:O,inputElement:B,suggestionElement:z}=_M();O.classList.add("neuroglancer-coordinate-space-transform-input-scale-container"),V(O),O.style.gridRowStart="sourceScales",O.style.gridColumnStart=`sourceDim ${E+1}`,I.appendChild(O),o.push(B),g.push(z);let _=E;z.addEventListener("click",()=>{let U=pS(this.transform,_);U!==void 0&&(this.transform.inputSpace.value=BM(this.transform.inputSpace.value,_,U.scale,U.unit))})}{let O=document.createElement("div");V(O),O.classList.add("neuroglancer-coordinate-space-transform-input-bounds"),O.style.gridRowStart="sourceLower",O.style.gridColumnStart=`sourceDim ${E+1}`,P.appendChild(O);let B=document.createElement("div");V(B),B.classList.add("neuroglancer-coordinate-space-transform-input-bounds"),B.style.gridRowStart="sourceUpper",B.style.gridColumnStart=`sourceDim ${E+1}`,M.appendChild(B),i.push({lower:O,upper:B})}}for(let E=0;E<t;++E){for(let V=0;V<=t;++V){let O=document.createElement("input");O.classList.add("neuroglancer-coordinate-space-transform-coeff"),O.spellcheck=!1,O.autocomplete="off",O.size=1,O.style.gridRowStart=`outputDim ${E+1}`,O.placeholder=" ",O.style.gridColumnStart=`sourceDim ${V+1}`,c[V*t+E]=O,V===t?O.classList.add("neuroglancer-coordinate-space-transform-translation-coeff"):V==r&&O.classList.add(AM),(V===t?x:b).appendChild(O)}{let{cellElement:V,suggestionElement:O,inputElement:B}=_M();V.classList.add("neuroglancer-coordinate-space-transform-output-scale-container"),V.style.gridRowStart=`outputDim ${E+1}`,V.style.gridColumnStart="outputScales";let z=E;O.addEventListener("click",()=>{let{value:_}=this.transform,U=dS(_,z);U!==void 0&&(this.transform.outputSpace.value=BM(_.outputSpace,z,U.scale,U.unit))}),m.push(O),D.appendChild(V),p.push(B)}{let V=document.createElement("div");V.classList.add("neuroglancer-coordinate-space-transform-output-name-container"),V.style.gridRowStart=`outputDim ${E+1}`,V.style.gridColumnStart="outputNames";let O=OM();O.title="Rebind to a different dimension",E>=r?O.title+=", or delete to remove singleton dimension":this.transform.mutableSourceRank&&(O.title+=", or delete to remove source dimension"),O.title+=".  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",d.push(O),C.appendChild(V),V.appendChild(O);let B=document.createElement("div");B.classList.add("neuroglancer-coordinate-space-transform-output-bounds"),V.appendChild(B);let z=document.createElement("div");z.classList.add("neuroglancer-coordinate-space-transform-output-bounds"),V.appendChild(z),v.push({lower:B,upper:z}),V.addEventListener("mousedown",_=>{_.target!==O&&(O.focus(),_.preventDefault())})}}d.push(this.addOutputDimensionInput),this.addOutputDimensionInput.value="",C.appendChild(this.addOutputDimensionCell),this.curSourceRank=r,this.curRank=t}updateViewInputScales(){this.ensureViewRankUpdated(),this.inputScaleModified.length=0;let{inputSpace:e,rank:t,sourceRank:r}=this.transform.value,{inputBoundsElements:i,inputNameElements:a,inputScaleElements:o,inputScaleSuggestionElements:l}=this,{names:c,scales:d,units:p,bounds:{lowerBounds:m,upperBounds:g}}=e;for(let v=0;v<t;++v){let b=o[v],x=d[v],C=p[v];b.value=Vi(x,C,{elide1:!1}),b.dataset.isValid="true",kp(b);let T;if(v<r){let D=c[v];D||(D=`${v}`),a[v].textContent=D,T=`source dimension ${D}`,b.title=`Override scale of ${T}`}else T="singleton dimension",b.title=`Set extent of ${T}`;let{lower:I,upper:P}=MM(m[v],g[v]),M=i[v];M.lower.textContent=I,M.lower.title=`Lower bound of ${T}`,M.upper.title=`Upper bound of ${T}`,M.upper.textContent=P,VM(l[v],pS(this.transform,v),x,C,`Revert scale of ${T} to `)}}updateViewOutputScales(){let{value:e}=this.transform,{rank:t,names:r,units:i,scales:a,bounds:{lowerBounds:o,upperBounds:l}}=e.outputSpace,{outputScaleElements:c,outputBoundsElements:d,outputScaleSuggestionElements:p}=this;for(let m=0;m<t;++m){let g=c[m],v=a[m],b=i[m];g.value=Vi(v,b,{elide1:!1}),kp(g);let x=r[m];g.dataset.isValid="true";let C=`Change coordinates of ${$o(x)?"local":"global"} dimension ${x}`;g.title=`${C} (does not rescale the source)`;let{lower:T,upper:I}=MM(o[m],l[m]),P=d[m];P.lower.textContent=T,P.upper.textContent=I,VM(p[m],dS(e,m),v,b,`${C} to inferred scale of `)}}updateResetButtonVisibility(e=!1,t=!1){let{transform:{value:r,mutableSourceRank:i,defaultTransform:a}}=this,{rank:o}=r;this.resetToIdentityButton.style.visibility=e||!RE(r.transform,o+1,o+1)?"visible":"hidden",this.resetToDefaultButton.style.visibility=!i&&(e||t||!UE(a,r))?"visible":"hidden"}updateView(){let e=this.transform.value;this.curTransform!==e&&(this.curTransform=e,this.ensureViewRankUpdated(),this.updateViewInputScales(),this.updateViewOutputNames(),this.updateViewTransformCoefficients(),this.updateViewOutputScales(),this.updateAddOutputDimensionCellStyle(),this.updateResetButtonVisibility())}disposed(){Ye(this.element),super.disposed()}};var $x=ot(Et());function UM(n,e,{horizontal:t=!1,vertical:r=!0,topMargin:i=6,bottomMargin:a=6,leftMargin:o=6,rightMargin:l=6,maxHeight:c=!0,maxWidth:d=!0}={}){let p=e.getBoundingClientRect();if(t){let m=n.ownerDocument.documentElement.clientWidth,g=p.right,v=m-p.left;g>v?(n.style.left="",n.style.right=`${m-p.right}px`,d&&(n.style.maxWidth=g-o+"px")):(n.style.right="",n.style.left=`${p.left}px`,d&&(n.style.maxWidth=v-l+"px"))}if(r){let m=n.ownerDocument.documentElement.clientHeight,g=p.top-i,v=m-p.bottom-a;n.style.left=`${p.left}px`,n.style.width=`${p.width}px`,g>v*3?(n.style.top="",n.style.bottom=`${m-p.top}px`,c&&(n.style.maxHeight=g+"px")):(n.style.top=`${p.bottom}px`,n.style.bottom="",c&&(n.style.maxHeight=v+"px"))}}function FM(n){let e=n[Symbol.iterator](),{value:t,done:r}=e.next();if(r)return"";let i=t.length;for(;i>0;){let{value:a,done:o}=e.next();if(o)break;let l=0;for(;l<i&&t.charCodeAt(l)===a.charCodeAt(l);++l);i=l}return t.substring(0,i)}var GM=10,hg=.5,WM=class{constructor(){this.anchorIndex=0;this.anchorClientOffset=0}splice(e){let{anchorIndex:t}=this,r=0;for(let i of e){if(r+=i.retainCount,t<r)break;let{deleteCount:a}=i;if(t<r+a){t=r;break}let{insertCount:o}=i;t=t-a+o,r+=o-o}this.anchorIndex=t}},Hx=class{constructor(){this.startIndex=0;this.endIndex=0;this.anchorIndex=0;this.anchorOffset=0;this.scrollOffset=0}},zM=class{constructor(){this.itemSize=[];this.totalKnownSize=0;this.numItemsInTotalKnownSize=0}get averageSize(){return this.totalKnownSize/this.numItemsInTotalKnownSize}getEstimatedSize(e){var t;return(t=this.itemSize[e])!=null?t:this.averageSize}getEstimatedTotalSize(){return this.totalKnownSize/this.numItemsInTotalKnownSize*this.itemSize.length}getEstimatedOffset(e,t=0,r=0){for(;t<e;++t)r+=this.getEstimatedSize(t);for(;t>e;--t)r-=this.getEstimatedSize(t-1);return r}getRangeSize(e,t){var o;let r=0,{itemSize:i,averageSize:a}=this;for(let l=e;l<t;++l)r+=(o=i[l])!=null?o:a;return r}splice(e){let{itemSize:t}=this;t=this.itemSize=_L(t,e),this.totalKnownSize=t.reduce((r,i)=>r+i,0),this.numItemsInTotalKnownSize=t.reduce(r=>r+1,0)}};function xj(n,e,t,r,i,a){let{anchorIndex:o,anchorClientOffset:l}=a,c=i.getEstimatedOffset(o),d,p,m,g,v;if(r===0||i.totalKnownSize===0)d=Math.max(0,o-GM/2),p=Math.min(t,d+GM),v=o,m=0,g=l;else{let b=i.getEstimatedTotalSize(),x=Math.max(0,b-r);g=c-l,g=Math.max(0,Math.min(x,g));let C=g-2*hg*r,T=g-hg*r,I=g+r+hg*r,P=c-l+r+2*hg*r;d=Math.min(t,e.startIndex);let M=i.getEstimatedOffset(d,o,c);if(M<C)for(;d+1<t;++d){let E=i.getEstimatedSize(d);if(M+E>=T)break;M+=E}if(M>=T)for(;M>C&&d>0;--d)M-=i.getEstimatedSize(d-1);p=Math.min(t,e.endIndex);let D=i.getEstimatedOffset(p,o,c);if(D<I)for(;D<=P&&p+1<=t;++p)D+=i.getEstimatedSize(p);else if(D>=P)for(;p>d;--p){let E=i.getEstimatedSize(p-1);if(D-E<I)break;D-=E}for(v=o,m=c;v<d;++v)m+=i.getEstimatedSize(v);for(;v>p;--v)m-=i.getEstimatedSize(v-1)}n.startIndex=d,n.endIndex=p,n.anchorIndex=v,n.anchorOffset=m,n.scrollOffset=g}function Cj(n,e){let t=e.getEstimatedOffset(n.anchorIndex),r=n.anchorOffset;n.anchorOffset=t,n.scrollOffset+=t-r}function wj(n,e){return n.startIndex<e.startIndex||n.endIndex>e.endIndex}var Vl=class extends j{constructor(e){super();this.element=document.createElement("div");this.scrollContent=document.createElement("div");this.header=document.createElement("div");this.body=document.createElement("div");this.topItems=document.createElement("div");this.bottomItems=document.createElement("div");this.renderedItems=[];this.renderGeneration=-1;this.listGeneration=-1;this.newRenderedItems=[];this.state=new WM;this.renderParams=new Hx;this.newRenderParams=new Hx;this.sizes=new zM;this.debouncedUpdateView=this.registerCancellable(We(()=>this.updateView()));this.resizeObserver=new ResizeObserver(()=>this.updateView());let{selectedIndex:t}=e;t!==void 0&&(this.state.anchorIndex=t,this.state.anchorClientOffset=0);let r=this.source=e.source;this.sizes.itemSize.length=r.length;let{element:i,header:a,body:o,scrollContent:l,topItems:c,bottomItems:d}=this;this.resizeObserver.observe(i),this.registerDisposer(()=>this.resizeObserver.disconnect()),i.appendChild(l),i.style.overflowAnchor="none",l.appendChild(a),l.appendChild(o),a.style.position="sticky",a.style.zIndex="1",a.style.top="0",e.horizontalScroll?(l.style.width="min-content",l.style.minWidth="100%",a.style.width="min-content",a.style.minWidth="100%",d.style.width="min-content",d.style.minWidth="100%"):(l.style.width="100%",a.style.width="100%",d.style.width="100%"),o.appendChild(c),o.appendChild(d),c.style.width="min-content",c.style.position="relative",c.style.height="0",c.style.minWidth="100%",d.style.height="0",d.style.position="relative",i.addEventListener("scroll",()=>{let p=i.scrollTop;this.state.anchorClientOffset=this.renderParams.anchorOffset-p,this.renderParams.scrollOffset=p,this.debouncedUpdateView()}),r.changed!==void 0&&this.registerDisposer(r.changed.add(p=>{this.sizes.splice(p),this.state.splice(p),this.renderedItems.length=0,this.debouncedUpdateView()})),r.renderChanged!==void 0&&this.registerDisposer(r.renderChanged.add(this.debouncedUpdateView))}updateView(){let{element:e}=this;if(e.offsetHeight===0)return;let t=e.clientHeight-this.header.offsetHeight,{source:r,state:i,sizes:a}=this,o=r.length,{body:l,topItems:c,bottomItems:d}=this,{changed:p,renderChanged:m}=r,g;for(;;){g=this.newRenderParams;let x=this.renderParams;xj(g,x,o,t,a,i);let C;if(m!==void 0&&m.count!==this.renderGeneration||p!==void 0&&p.count!==this.listGeneration?(this.renderGeneration=m===void 0?-1:m.count,this.listGeneration=p===void 0?-1:p.count,C=!0,this.renderedItems.length=0):C=!1,!C&&!wj(g,x)){x.scrollOffset=g.scrollOffset,g=x;break}this.renderParams=g,this.newRenderParams=x;let T=this.renderedItems,I=this.newRenderedItems;I.length=0,this.renderedItems=I,this.newRenderedItems=T;let{source:P}=this,{render:M}=P,{startIndex:D,endIndex:E,anchorIndex:V}=g;function*O(B,z){for(let _=B;_<z;++_){let U=T[_];U===void 0&&(U=M.call(P,_)),I[_]=U,yield U}}Wn(c,O(D,V)),Wn(d,O(V,E));for(let B=D;B<E;++B){let U=I[B].getBoundingClientRect().height,N=a.itemSize[B];N!==void 0&&(a.totalKnownSize-=N,--a.numItemsInTotalKnownSize),a.itemSize[B]=U,a.totalKnownSize+=U,++a.numItemsInTotalKnownSize}}Cj(g,a),i.anchorIndex=g.anchorIndex,i.anchorClientOffset=g.anchorOffset-g.scrollOffset;let v=a.getRangeSize(g.startIndex,g.anchorIndex),b=a.getEstimatedTotalSize();l.style.height=`${b}px`,c.style.top=`${g.anchorOffset-v}px`,d.style.top=`${g.anchorOffset}px`,e.scrollTop=g.scrollOffset}getItemElement(e){return this.renderedItems[e]}forEachRenderedItem(e){let{startIndex:t,endIndex:r}=this.renderParams,{renderedItems:i}=this;for(let a=t;a<r;++a){let o=i[a];o!==void 0&&e(o,a)}}scrollToTop(){this.state.anchorIndex=0,this.state.anchorClientOffset=0,this.debouncedUpdateView()}scrollItemIntoView(e){let t=this.sizes.getEstimatedOffset(e),r=t+this.sizes.getEstimatedSize(e),i=this.element.scrollTop;if(t<i)this.state.anchorIndex=e,this.state.anchorClientOffset=0;else if(t>i&&r>i+this.element.offsetHeight)this.state.anchorIndex=e+1,this.state.anchorClientOffset=this.element.offsetHeight;else return;this.debouncedUpdateView()}disposed(){Ye(this.element)}};var jx="neuroglancer-multiline-autocomplete-completion-active",Tj=!1;function Lj(n){let e=document.createElement("div");return e.textContent=n.value,e}function*HM(n){for(;n.length>0;){let e=n.match(/[:/_]+/);if(e===null){yield n;return}let t=e.index+e[0].length;yield n.substring(0,t),n=n.substring(t)}}function $M(n){let e=document.createElement("div");e.className="neuroglancer-multiline-autocomplete-completion-with-description",e.textContent=n.value;let t=document.createElement("div");return t.className="neuroglancer-multiline-autocomplete-completion-description",t.textContent=n.description||"",e.appendChild(t),e}var kj=Me.fromObject({arrowdown:{action:"cycle-next-active-completion"},arrowup:{action:"cycle-prev-active-completion"},home:{action:"home"},end:{action:"end"},tab:{action:"choose-active-completion-or-prefix",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel",preventDefault:!1,stopPropagation:!1}}),Ej=200,Jx=class extends j{constructor(e){super();this.element=document.createElement("div");this.inputElement=document.createElement("span");this.hintElement=document.createElement("span");this.completionsVirtualList=void 0;this.onCommit=new ze;this.onInput=new ze;this.prevInputValue="";this.completionsVisible=!1;this.activeCompletionPromise=null;this.activeCompletionCancellationToken=void 0;this.hasFocus=!1;this.completionResult=null;this.dropdownContentsStale=!0;this.hasResultForDropdown=!1;this.commonPrefix="";this.completionDisabled=-1;this.activeIndex=-1;this.dropdownStyleStale=!0;this.resizeHandler=()=>{!this.completionsVisible||this.updateDropdownStyle()};this.resizeObserver=new ResizeObserver(this.resizeHandler);this.debouncedUpdateHintState=this.registerCancellable((0,$x.default)(()=>this.updateHintState(),0));this.completer=e.completer;let{delay:t=Ej}=e,r=this.scheduleUpdateCompletions=(0,$x.default)(()=>{let c=this.activeCompletionCancellationToken=new vr,d=this.activeCompletionPromise=this.completer(this.value,c);d!==null&&d.then(p=>{this.activeCompletionPromise===d&&(this.setCompletions(p),this.activeCompletionPromise=null)})},t);this.registerDisposer(()=>{r.cancel()});let{element:i,inputElement:a,hintElement:o}=this;i.classList.add("neuroglancer-multiline-autocomplete"),this.registerEventListener(window,"resize",this.resizeHandler),this.resizeObserver.observe(i),this.registerDisposer(()=>this.resizeObserver.unobserve(a)),a.contentEditable="true",a.spellcheck=!1,i.appendChild(document.createTextNode("\u200B")),i.appendChild(a),i.appendChild(o),a.classList.add("neuroglancer-multiline-autocomplete-input"),o.classList.add("neuroglancer-multiline-autocomplete-hint"),a.addEventListener("input",()=>{this.completionDisabled=-1,this.setValueAndSelection(this.value,this.getSelectionRange()),this.debouncedUpdateHintState()}),a.addEventListener("copy",c=>{let{clipboardData:d}=c;if(d!==null){let p=window.getSelection();p!==null&&!p.isCollapsed&&p.containsNode(a,!0)&&d.setData("text/plain",p.toString())}c.preventDefault(),c.stopPropagation()}),this.registerEventListener(document,"selectionchange",()=>{let c=this.getSelectionRange(),{completionDisabled:d}=this;c!==void 0&&c.begin===d&&c.end===d||(this.completionDisabled=-1,this.debouncedUpdateHintState())}),this.setValueAndSelection(""),this.updateHintState(),i.addEventListener("pointerdown",c=>{let{target:d}=c;if(d instanceof Node){if(a.contains(d))return;let{completionsVirtualList:p}=this;if(p!==void 0&&p.element.contains(d))return}a===document.activeElement&&(this.moveCaretToEndOfInput(),c.stopPropagation(),c.preventDefault())}),i.addEventListener("click",()=>{a.focus()}),this.registerEventListener(this.inputElement,"focus",()=>{if(!this.hasFocus){this.hasFocus=!0,this.dropdownStyleStale=!0,this.updateDropdown();let c=document.createRange(),{childNodes:d}=a;c.setStart(a,0),d.length===0?c.setEnd(a,0):c.setEndAfter(d[d.length-1]);let p=window.getSelection();p!==null&&(p.removeAllRanges(),p.addRange(c)),this.debouncedUpdateHintState()}}),this.registerEventListener(this.inputElement,"blur",()=>{if(this.hasFocus){if(Tj)return;this.hasFocus=!1,this.updateDropdown()}this.debouncedUpdateHintState();let c=window.getSelection();c!==null&&c.containsNode(this.inputElement,!0)&&c.removeAllRanges(),this.onCommit.dispatch(this.value,!1)}),this.registerEventListener(window,"resize",()=>{this.dropdownStyleStale=!0}),this.registerEventListener(window,"scroll",()=>{this.dropdownStyleStale=!0});let l=this.registerDisposer(new $t(a,kj));l.allShortcutsAreGlobal=!0,ce(a,"cycle-next-active-completion",()=>{this.cycleActiveCompletion(1)}),ce(a,"cycle-prev-active-completion",()=>{this.cycleActiveCompletion(-1)}),ce(a,"home",()=>{this.moveCaretToBeginningOfInput()}),ce(a,"end",()=>{this.moveCaretToEndOfInput()}),ce(a,"choose-active-completion-or-prefix",c=>{this.selectActiveCompletion(!0)&&c.preventDefault()}),ce(a,"commit",c=>{if(this.selectActiveCompletion(!1))c.stopPropagation();else{let d=!this.completionsVisible;this.disableCompletion(),this.hideCompletions(),this.onCommit.dispatch(this.value,d)}}),ce(a,"cancel",c=>{c.stopPropagation(),this.cancel()&&(c.detail.preventDefault(),c.detail.stopPropagation())})}disableCompletion(){let e=this.getSelectionRange();this.completionDisabled=e!==void 0&&e.end===e.begin?e.end:-1}get placeholder(){return this.inputElement.dataset.placeholder||""}set placeholder(e){this.inputElement.dataset.placeholder=e}getSelectionRange(){let e=window.getSelection();if(e===null||e.rangeCount===0)return;let t=e.getRangeAt(0),{inputElement:r}=this,i=document.createRange();i.setStart(r,0),i.setEnd(t.startContainer,t.startOffset);let a=i.toString().length,o=e.toString().length;return{begin:a,end:a+o}}setValueAndSelection(e,t=void 0){let r=this.completionDisabled!==-1;this.onInput.dispatch(e);let{inputElement:i}=this;Ie(i);let a=0,o=t!==void 0?document.createRange():void 0,l=!0;for(let c of HM(e)){l||i.appendChild(document.createElement("wbr")),l=!1;let d=a+c.length,p=document.createTextNode(c);if(i.appendChild(p),o!==void 0){let{begin:m,end:g}=t;m>=a&&m<=d&&o.setStart(p,m-a),g>=a&&g<=d&&o.setEnd(p,g-a)}a=d}if(o!==void 0){l&&(o.setStart(i,0),o.setEnd(i,0));let c=window.getSelection();c!==null&&(c.removeAllRanges(),c.addRange(o))}this.completionDisabled=r&&t!==void 0&&t.end===t.begin?t.end:-1}shouldAttemptCompletion(){let{inputElement:e}=this;if(document.activeElement!==e)return!1;let t=this.getSelectionRange();return t!==void 0&&t.end===t.begin&&t.end!=this.completionDisabled&&t.end===this.value.length}hideCompletions(){this.cancelActiveCompletion(),this.clearCompletions(),this.hintElement.textContent=""}updateHintState(){if(this.debouncedUpdateHintState.cancel(),this.shouldAttemptCompletion()){let{value:e}=this;if(e===this.prevInputValue)return;this.hideCompletions(),this.prevInputValue=e,this.scheduleUpdateCompletions()}else{this.hideCompletions();return}}handleDropdownClick(e){let{completionsVirtualList:t}=this;if(t===void 0)return;let r=t.element;for(let i=e.target;i instanceof HTMLElement&&i!==r;i=i.parentElement){let a=i.dataset.completionIndex;if(a!==void 0){this.selectCompletion(Number(a));break}}}cycleActiveCompletion(e){if(this.completionResult===null)return;let{activeIndex:t}=this,r=this.completionResult.completions.length;t===-1?e>0?t=0:t=r-1:t=(t+e+r)%r,this.setActiveIndex(t)}shouldShowDropdown(){let{completionResult:e}=this;return e===null||!this.hasFocus?!1:this.hasResultForDropdown}updateDropdownStyle(){let{completionsVirtualList:e,element:t}=this;e!==void 0&&UM(e.element,t,{horizontal:!1}),this.dropdownStyleStale=!1}updateDropdown(){let{completionsVirtualList:e}=this;if(this.shouldShowDropdown()){if(this.dropdownContentsStale){e!==void 0&&e.dispose();let r=this.completionResult,{makeElement:i=Lj}=r;e=this.completionsVirtualList=new Vl({source:{length:r.completions.length,render:a=>{let o=r.completions[a],l=i.call(r,o);return l.classList.add("neuroglancer-multiline-autocomplete-completion"),l.dataset.completionIndex=`${a}`,this.activeIndex===a&&l.classList.add(jx),l}},selectedIndex:this.activeIndex===-1?void 0:this.activeIndex}),e.element.classList.add("neuroglancer-multiline-autocomplete-dropdown"),e.element.addEventListener("mousedown",a=>{this.inputElement.focus(),a.preventDefault()}),e.element.addEventListener("mouseup",this.handleDropdownClick.bind(this)),this.element.appendChild(e.element),this.dropdownContentsStale=!1}this.dropdownStyleStale&&this.updateDropdownStyle(),this.completionsVisible||(this.completionsVisible=!0);let{activeIndex:t}=this;t!==-1&&this.completionsVirtualList.scrollItemIntoView(t)}else this.completionsVisible&&(e!==void 0&&(e.dispose(),this.completionsVirtualList=void 0,this.dropdownContentsStale=!0),this.completionsVisible=!1)}setCompletions(e){this.clearCompletions();let{completions:t}=e;if(t.length===0)return;let r=this.prevInputValue;if(r!==void 0){if(this.completionResult=e,t.length===1){let i=t[0];e.showSingleResult?this.hasResultForDropdown=!0:i.value.startsWith(r)?this.hasResultForDropdown=!1:this.hasResultForDropdown=!0,e.selectSingleResult?this.setActiveIndex(0):this.setHintValue(this.getCompletedValueByIndex(0))}else{this.hasResultForDropdown=!0;let i=FM(function*(){for(let o of e.completions)yield o.value}()),a=this.getCompletedValue(i);a.startsWith(r)&&(this.commonPrefix=a,this.setHintValue(a))}this.updateDropdown()}}setHintValue(e){let t=this.prevInputValue;if(t===void 0)return;(e===t||!e.startsWith(t))&&(e=""),e=e.substring(t.length);let{hintElement:r}=this;Ie(r);let i=!0;for(let a of HM(e)){i||r.appendChild(document.createElement("wbr")),i=!1;let o=document.createTextNode(a);r.appendChild(o)}}setActiveIndex(e){if(!this.dropdownContentsStale){let{activeIndex:t}=this,{completionsVirtualList:r}=this;if(r!==void 0){if(t!==-1){let i=r.getItemElement(t);i!==void 0&&i.classList.remove(jx)}if(e!==-1){let i=r.getItemElement(e);i!==void 0&&i.classList.add(jx),r.scrollItemIntoView(e)}}}e!==-1&&this.setHintValue(this.getCompletedValueByIndex(e)),this.activeIndex=e}getCompletedValueByIndex(e){return this.getCompletedValue(this.completionResult.completions[e].value)}getCompletedValue(e){let t=this.completionResult,r=this.prevInputValue;return r===void 0?"":r.substring(0,t.offset)+e}moveCaretToBeginningOfInput(){let e=document.createRange(),{inputElement:t}=this;e.setStart(t,0),e.setEnd(t,0);let r=window.getSelection();r!==null&&(r.removeAllRanges(),r.addRange(e),this.debouncedUpdateHintState())}moveCaretToEndOfInput(){let e=document.createRange(),{inputElement:t}=this,{childNodes:r}=t,i=r[r.length-1];i===void 0?(e.setStart(t,0),e.setEnd(t,0)):(e.setStartAfter(i),e.setEndAfter(i));let a=window.getSelection();a!==null&&(a.removeAllRanges(),a.addRange(e),this.debouncedUpdateHintState())}selectActiveCompletion(e){let{activeIndex:t}=this;if(t===-1){if(!e)return!1;let{completionResult:i}=this;if(i!==null&&i.completions.length===1)t=0;else{let{commonPrefix:a}=this;return a.length>this.value.length?(this.value=a,this.moveCaretToEndOfInput(),!0):!1}}let r=this.getCompletedValueByIndex(t);return this.value===r?!1:(this.value=r,this.moveCaretToEndOfInput(),!0)}selectCompletion(e){this.value=this.getCompletedValueByIndex(e),this.moveCaretToEndOfInput()}cancel(){return!1}cancelActiveCompletion(){this.prevInputValue=void 0;let e=this.activeCompletionCancellationToken;e!==void 0&&e.cancel(),this.activeCompletionCancellationToken=void 0,this.activeCompletionPromise=null}clearCompletions(){if(this.completionResult!==null){this.activeIndex=-1,this.completionResult=null,this.dropdownContentsStale=!0,this.dropdownStyleStale=!0,this.commonPrefix="";let{completionsVirtualList:e}=this;e!==void 0&&(e.dispose(),this.completionsVirtualList=void 0),this.updateDropdown()}}get value(){return this.inputElement.textContent||""}set value(e){e!==this.value&&(this.completionDisabled=-1,this.setValueAndSelection(e),this.debouncedUpdateHintState())}disposed(){let{completionsVirtualList:e}=this;e!==void 0&&e.dispose(),Ye(this.element),this.cancelActiveCompletion(),super.disposed()}};var jM=class extends Jx{constructor(e){let{manager:t}=e.source.layer,r=(a,o)=>t.dataSourceProviderRegistry.completeUrl({url:a,chunkManager:t.chunkManager,cancellationToken:o}).then(l=>({completions:l.completions,makeElement:$M,offset:l.offset,showSingleResult:!0}));super({completer:r,delay:0});this.placeholder="Data source URL",this.dataSourceView=e,this.element.classList.add("neuroglancer-layer-data-source-url-input"),this.dirty=new Ee(!1);let i=a=>{a!==this.dataSourceView.source.spec.url&&(this.dirty.value=!0)};i(""),this.onInput.add(i)}cancel(){return this.value=this.dataSourceView.source.spec.url,this.dirty.value=!1,this.inputElement.blur(),!0}},qx=class extends j{constructor(e){super();this.model=e;this.element=document.createElement("ul");this.generation=-1;this.element.classList.add("neuroglancer-layer-data-sources-source-messages");let t=this.registerCancellable(We(()=>this.updateView()));this.registerDisposer(e.changed.add(t)),this.registerDisposer(()=>Ye(this.element)),this.updateView()}updateView(){let{model:e}=this,t=e.changed.count;if(t===this.generation)return;this.generation=t;let{element:r}=this;Ie(r);let i=new Set;for(let a of e){let o=`${a.severity} ${a.message}`;if(i.has(o))continue;i.add(o);let l=document.createElement("li");r.appendChild(l),l.classList.add("neuroglancer-message"),l.classList.add(`neuroglancer-message-${xr[a.severity]}`),l.textContent=a.message}}},JM=class extends j{constructor(e,t){super();this.loadedSubsource=t;this.element=document.createElement("div");let{element:r}=this;r.classList.add("neuroglancer-layer-data-source-subsource");let i=document.createElement("label"),a=document.createElement("span"),o=()=>{i.dataset.isActive=(t.activated!==void 0||!t.enabled).toString()};o(),this.registerDisposer(t.isActiveChanged.add(o)),this.registerDisposer(e.enabledSubsourcesChanged.add(o));let l=this.registerDisposer(new Fn({get value(){return t.enabled},set value(b){t.enabled=b,e.enableDefaultSubsources=!1,e.enabledSubsourcesChanged.dispatch()},changed:e.enabledSubsourcesChanged}));i.classList.add("neuroglancer-layer-data-sources-info-line"),i.appendChild(l.element);let c=document.createElement("span");c.classList.add("neuroglancer-layer-data-sources-source-id");let{id:d}=t.subsourceEntry;d!=="default"&&(c.textContent=d),i.appendChild(c),a.classList.add("neuroglancer-layer-data-sources-source-type");let p=this.registerDisposer(new qx(this.loadedSubsource.messages));r.appendChild(i),i.appendChild(a),r.appendChild(p.element);let m="",{subsource:g}=t.subsourceEntry,{volume:v}=g;if(v instanceof zt)m=`${G[v.dataType].toLowerCase()} volume`;else if(g.mesh instanceof tr)m="meshes (single-res.)";else if(g.mesh instanceof mo)m="meshes (multi-res.)";else if(g.mesh instanceof go)m="skeletons";else if(g.segmentPropertyMap!==void 0)m="segment property map";else if(g.local!==void 0)switch(g.local){case mi.annotations:m="Local annotations";break;case mi.equivalences:m="local segmentation graph";break}else g.staticAnnotations!==void 0?m="default annotations":g.annotation!==void 0?m="annotations":g.singleMesh!==void 0?m="single mesh":g.segmentationGraph!==void 0&&(m="segmentation graph");a.textContent=m}},qM=class extends j{constructor(e){super();this.source=e;this.element=document.createElement("div");let{element:t}=this,r=document.createElement("label");r.classList.add("neuroglancer-layer-data-sources-source-default"),r.appendChild(this.registerDisposer(new Fn({changed:e.enabledSubsourcesChanged,get value(){return e.enableDefaultSubsources},set value(a){if(e.enableDefaultSubsources!==a){if(e.enableDefaultSubsources=a,a)for(let o of e.subsources)o.enabled=o.subsourceEntry.default;e.enabledSubsourcesChanged.dispatch()}}})).element),r.appendChild(document.createTextNode("Enable default subsource set")),r.title="Enable the default set of subsources for this data source.",t.appendChild(r);for(let a of e.subsources)t.appendChild(this.registerDisposer(new JM(e,a)).element);let{transform:i}=e;if(i.mutableSourceRank||i.value.sourceRank!==0){let a=this.registerDisposer(new zx(e.transform,e.layer.localCoordinateSpaceCombiner,e.layer.manager.root.coordinateSpaceCombiner));this.element.appendChild(a.element)}this.registerDisposer(()=>Ye(this.element))}},YM=class extends j{constructor(e,t){super();this.tab=e;this.source=t;this.element=document.createElement("div");this.seenGeneration=0;this.generation=-1;let r=this.urlInput=this.registerDisposer(new jM(this)),i=(o,l)=>{let{source:c}=this,d=c.spec,p=this.source.layer;if(o=p.manager.dataSourceProviderRegistry.normalizeUrl({url:o}),o!==r.value&&(r.disableCompletion(),r.setValueAndSelection(o,{begin:o.length,end:o.length})),r.dirty.value=!1,o&&o===d.url){l&&e.detectedLayerConstructor!==void 0&&KM(c.layer);return}if(p instanceof Xi)try{let m=p.manager.dataSourceProviderRegistry.suggestLayerName(o);mg(p.managedLayer,m)}catch{}c.spec={...d,url:o}};r.onCommit.add(i);let{element:a}=this;a.classList.add("neuroglancer-layer-data-source"),a.appendChild(r.element),a.appendChild(this.registerDisposer(new qx(t.messages)).element),this.updateView()}updateView(){let e=this.source.changed.count;if(e===this.generation)return;this.generation=e,this.urlInput.value=this.source.spec.url,this.urlInput.dirty.value=!1;let{loadState:t}=this.source,{loadedView:r}=this;if(r!==void 0){if(r.source===t)return;r.dispose(),r=this.loadedView=void 0}t instanceof sg&&(r=this.loadedView=new qM(t),this.element.appendChild(r.element))}disposed(){let{loadedView:e}=this;e!==void 0&&e.dispose(),Ye(this.element),super.disposed()}};function KM(n){if(n instanceof Xi){let e=n.detectedLayerConstructor;if(e!==void 0)return Ep(n.managedLayer,e),!0}return!1}var Yx=class extends Vt{constructor(e){super();this.layer=e;this.generation=-1;this.sourceViews=new Map;this.addDataSourceIcon=fg({title:"Add additional data source"});this.layerTypeDetection=document.createElement("div");this.layerTypeElement=document.createElement("span");this.dataSourcesContainer=document.createElement("div");this.detectedLayerConstructor=void 0;let{element:t,dataSourcesContainer:r}=this;t.classList.add("neuroglancer-layer-data-sources-tab"),r.classList.add("neuroglancer-layer-data-sources-container");let{addDataSourceIcon:i}=this;if(i.style.alignSelf="start",i.addEventListener("click",()=>{let o=this.layer.addDataSource(void 0);this.updateView();let l=this.sourceViews.get(o);l!==void 0&&l.urlInput.inputElement.focus()}),t.appendChild(this.dataSourcesContainer),e instanceof Xi){let{layerTypeDetection:o,layerTypeElement:l}=this;o.style.display="none",l.classList.add("neuroglancer-layer-data-sources-tab-type-detection-type"),o.appendChild(document.createTextNode("Create as ")),o.appendChild(l),o.appendChild(document.createTextNode(" layer")),t.appendChild(o),o.classList.add("neuroglancer-layer-data-sources-tab-type-detection"),o.addEventListener("click",()=>{KM(e)})}let a=this.reRender=We(()=>this.updateView());this.registerDisposer(e.dataSourcesChanged.add(a)),this.registerDisposer(this.visibility.changed.add(a)),this.updateView()}updateLayerTypeDetection(){let e=(()=>{let r=this.layer;if(!(r instanceof Xi))return;let i=r.detectedLayerConstructor;if(i!==void 0){for(let a of this.sourceViews.values())if(a.urlInput.dirty.value)return;return i}})();if(e===this.detectedLayerConstructor)return;let{layerTypeDetection:t}=this;if(this.detectedLayerConstructor=e,e!==void 0){let{layerTypeElement:r}=this;r.textContent=e.type,t.title=`Click here or press enter in the data source URL input box to create as ${e.type} layer`,t.style.display=""}else t.style.display="none"}disposed(){let{sourceViews:e}=this;for(let t of e.values())t.dispose();e.clear(),super.disposed()}updateView(){if(!this.visible)return;let e=this.layer.dataSourcesChanged.count;if(e!==this.generation){this.generation=e;let t=Date.now(),{sourceViews:r}=this,{layer:i}=this;function*a(){let o=!0,{dataSources:l}=i;for(let c of l){let d=r.get(c);d===void 0&&(d=new YM(this,c),d.registerDisposer(d.urlInput.dirty.changed.add(this.reRender)),r.set(c,d)),d.seenGeneration=t,d.updateView();let p=c.spec.url;l.length===1&&p===""&&setTimeout(()=>{d.urlInput.inputElement.focus()},0),o=c.spec.url.length===0,yield d.element}o||(yield this.addDataSourceIcon)}Wn(this.dataSourcesContainer,a.call(this));for(let[o,l]of r)l.seenGeneration!==t&&(l.dispose(),r.delete(o))}this.updateLayerTypeDetection()}};var gg="tab",XM="tabs",QM="panels",ZM={...vi,row:0},Kx={...vi,visible:!0,row:0},ru=class extends j{constructor(e){super();this.panels=e;this.layer=this.panels.layer;this.location=new Zn(Kx);this.tabsChanged=new ze;this.selectedTab=new Ee(void 0);this.tabs=[]}initialize(){let{panels:e}=this;this.tabsChanged.add(e.specificationChanged.dispatch),this.selectedTab.changed.add(e.specificationChanged.dispatch),this.location.changed.add(()=>{var a;e.specificationChanged.dispatch();let{layer:t}=this,{selectedLayer:r}=t.manager.root;if(((a=r.layer)==null?void 0:a.layer)!==t||this!==t.panels.panels[0])return;let i=this.location.value;r.location.value!==i&&(r.location.value=i,r.location.locationChanged.dispatch())}),this.location.locationChanged.add(()=>{this.location.visible||this!==this.panels.panels[0]&&this.panels.removePanel(this)});for(let t of this.tabs){let{hidden:r}=this.layer.tabs.options.get(t);r&&this.registerDisposer(r.changed.add(()=>{this.panels.updateTabs(),this.tabsChanged.dispatch()}))}}normalizeTabs(){let{tabs:e}=this;if(e.length===0){this.selectedTab.value=void 0;return}let t=this.layer.tabs.options,r=o=>{var l;return(l=t.get(o).order)!=null?l:0};e.sort((o,l)=>r(o)-r(l));let{selectedTab:i}=this,a=i.value;(a===void 0||!e.includes(a))&&(i.value=e[0])}pin(){var a;let{layer:e}=this,{selectedLayer:t}=e.manager.root;if(((a=t.layer)==null?void 0:a.layer)!==e||this!==e.panels.panels[0]||this.tabs.length===0)return;let{panels:r}=this,i=e.registerDisposer(new ru(r));r.panels.splice(0,1,i),r.panels.push(this),r.updateTabs(),i.initialize(),t.layerManager.layersChanged.dispatch(),this.panels.specificationChanged.dispatch()}unpin(){var l;let{panels:e}=this,t=e.panels.indexOf(this);if(t===-1||t===0)return;let{layer:r}=this,{selectedLayer:i}=r.manager.root,a=(l=i.layer)==null?void 0:l.layer;i.visible&&a!=null&&a!=r&&a.panels.panels[0].pin(),e.panels.splice(t,1);let[o]=e.panels.splice(0,1,this);if(this.explicitTabs===void 0)r.unregisterDisposer(o);else{e.panels.push(o);for(let c=1,d=e.panels.length;c<d;++c){let p=e.panels[c];p.explicitTabs===void 0&&(p.explicitTabs=new Set(p.tabs))}}this.explicitTabs=void 0,e.updateTabs(),i.layer=r.managedLayer,i.location.value=this.location.value,i.location.locationChanged.dispatch(),i.layerManager.layersChanged.dispatch(),this.panels.specificationChanged.dispatch()}splitOffTab(e,t){if(!this.tabs.includes(e))return;let{panels:r}=this;{let{explicitTabs:o}=this;o!==void 0&&o.delete(e)}let{layer:i}=this,a=i.registerDisposer(new ru(r));a.location.value=t,a.explicitTabs=new Set([e]),r.panels.splice(1,0,a),r.updateTabs(),a.initialize(),i.manager.root.layerManager.layersChanged.dispatch(),r.specificationChanged.dispatch()}moveTabTo(e,t){if(!this.tabs.includes(e))return;{let{explicitTabs:i}=this;i!==void 0&&i.delete(e)}{let{explicitTabs:i}=t;i!==void 0&&i.add(e)}let{panels:r}=this;r.updateTabs(),t.selectedTab.value=e,r.specificationChanged.dispatch()}mergeInto(e){let{explicitTabs:t}=e;if(t!==void 0)for(let i of this.tabs)t.add(i);let{panels:r}=this;r.removePanel(this)}},Xx=class{constructor(e){this.layer=e;this.specificationChanged=new ze;this.updating=!1;this.panels=[e.registerDisposer(new ru(this))]}restoreState(e){let{panels:t}=this;t[0].selectedTab.value=oe(e,gg,Q);let{layer:r}=this,{tabs:i}=r,a=new Set(i.options.keys());oe(e,QM,o=>ge(o,l=>{Z(l);let c=new ru(this);c.location.restoreState(l),!!c.location.visible&&(c.selectedTab.value=oe(l,gg,Q),c.explicitTabs=oe(l,XM,d=>{let p=new Set;for(let m of qt(d))!a.has(m)||(a.delete(m),p.add(m));return p}),c.explicitTabs===void 0?(c.tabs=Array.from(a),a.clear()):c.tabs=Array.from(c.explicitTabs),c.tabs.length!==0&&(c.normalizeTabs(),r.registerDisposer(c),c.initialize(),t.push(c)))})),t[0].tabs=Array.from(a),t[0].normalizeTabs(),this.panels[0].initialize()}removePanel(e){if(this.updating)return;let t=this.panels.indexOf(e);this.panels.splice(t,1),this.layer.unregisterDisposer(e),this.updateTabs()}updateTabs(){var o;let{layer:e}=this,{tabs:t}=e,r=new Set(t.options.keys()),{panels:i}=this;this.updating=!0;let a=l=>{let c=l.tabs;if(l.explicitTabs===void 0)l.tabs=Array.from(r),r.clear();else{l.tabs=Array.from(l.explicitTabs);for(let d of l.tabs)r.delete(d)}xe(c,l.tabs)||(l.normalizeTabs(),l.tabsChanged.dispatch())};for(let l=1;l<i.length;){let c=i[l];if(c.location.visible&&(a(c),c.tabs.length!==0)){++l;continue}i.splice(l,1),e.unregisterDisposer(c)}if(a(i[0]),i[0].tabs.length===0){let{selectedLayer:l}=this.layer.manager.root;((o=l.layer)==null?void 0:o.layer)===this.layer&&(l.location.visible=!1)}this.updating=!1}toJSON(){var r;let{panels:e}=this,t={};if(t[gg]=e[0].selectedTab.value,e.length>1){let i=[];for(let a=1,o=e.length;a<o;++a){let l=e[a],c=(r=l.location.toJSON())!=null?r:{};c[gg]=l.selectedTab.value;let{explicitTabs:d}=l;d!==void 0&&(c[XM]=Array.from(d)),i.push(c)}t[QM]=i}return t}};function eR(n,e){n.remove(e)}function tR(n,e){n.add(e)}var rR="tool",iR="toolBindings",Qx="localPosition",aR="localDimensions",oR="source",Dj="transform",sR="pick",lR=class{constructor(){this.callbacks=[]}defer(e){this.callbacks.push(e)}},Ti=class extends j{constructor(e){super();this.managedLayer=e;this.pick=new qe(!0,!0);this.layersChanged=new re;this.readyStateChanged=new re;this.specificationChanged=new re;this.renderLayers=new Array;this.loadingCounter=1;this.tabs=this.registerDisposer(new zS);this.panels=new Xx(this);this.tool=this.registerDisposer(new Mx(this));this.toolBinder=new _x(this);this.dataSourcesChanged=new re;this.dataSources=[];this.localCoordinateSpaceCombiner.includeDimensionPredicate=lS,this.tabs.changed.add(this.specificationChanged.dispatch),this.panels.specificationChanged.add(this.specificationChanged.dispatch),this.tool.changed.add(this.specificationChanged.dispatch),this.toolBinder.changed.add(this.specificationChanged.dispatch),this.localPosition.changed.add(this.specificationChanged.dispatch),this.pick.changed.add(this.specificationChanged.dispatch),this.pick.changed.add(this.layersChanged.dispatch),this.dataSourcesChanged.add(this.specificationChanged.dispatch),this.dataSourcesChanged.add(()=>this.updateDataSubsourceActivations()),this.tabs.add("source",{label:"Source",order:-100,getter:()=>new Yx(this)})}get localPosition(){return this.managedLayer.localPosition}get localCoordinateSpaceCombiner(){return this.managedLayer.localCoordinateSpaceCombiner}get localCoordinateSpace(){return this.managedLayer.localCoordinateSpace}get type(){return this.constructor.type}initializeSelectionState(e){e.generation=-1,e.localPositionValid=!1,e.localPosition=no,e.localCoordinateSpace=void 0,e.annotationId=void 0,e.annotationType=void 0,e.annotationBuffer=void 0,e.annotationIndex=void 0,e.annotationCount=void 0,e.annotationSourceIndex=void 0,e.annotationSubsource=void 0,e.annotationPartIndex=void 0,e.value=void 0}resetSelectionState(e){e.localPositionValid=!1,e.annotationId=void 0,e.value=void 0}selectionStateFromJson(e,t){let r=e.localCoordinateSpace=this.localCoordinateSpace.value,{rank:i}=r;if(i!==0){let o=oe(t,Qx,l=>Ne(new Float32Array(i),l,Qe));o===void 0?e.localPositionValid=!1:(e.localPositionValid=!0,e.localPosition=o)}(e.annotationId=oe(t,"annotationId",Q))!==void 0&&(e.annotationSourceIndex=oe(t,"annotationSource",rt,0),e.annotationPartIndex=oe(t,"annotationPart",rt),e.annotationSubsource=oe(t,"annotationSubsource",Q)),e.value=t.value}displaySelectionState(e,t,r){return!1}selectionStateToJson(e,t){let r={};if(e.localPositionValid){let{localPosition:i}=e;i.length>0&&(r.localPosition=Array.from(i))}return e.annotationId!==void 0&&(r.annotationId=e.annotationId,r.annotationPart=e.annotationPartIndex,r.annotationSource=e.annotationSourceIndex,r.annotationSubsource=e.annotationSubsource),e.value!=null&&(r.value=e.value),r}captureSelectionState(e,t){e.localCoordinateSpace=this.localCoordinateSpace.value;let r=this.localPosition.value,{localPosition:i}=e;i.length!==r.length?e.localPosition=r.slice():i.set(r),e.localPositionValid=!0,e.value=this.getValueAt(t.position,t)}copySelectionState(e,t){e.generation=t.generation,e.localPositionValid=t.localPositionValid,e.localCoordinateSpace=t.localCoordinateSpace;let r=t.localPosition,{localPosition:i}=e;i.length!==r.length?e.localPosition=r.slice():e.localPosition.set(r),e.annotationId=t.annotationId,e.annotationType=t.annotationType,e.annotationBuffer=t.annotationBuffer,e.annotationIndex=t.annotationIndex,e.annotationCount=t.annotationCount,e.annotationSourceIndex=t.annotationSourceIndex,e.annotationSubsource=t.annotationSubsource,e.annotationPartIndex=t.annotationPartIndex,e.value=t.value}get isReady(){return this.loadingCounter===0}get manager(){return this.managedLayer.manager}canAddDataSource(){return!0}addDataSource(e){let t=new Ox(this,e);return this.dataSources.push(t),this.dataSourcesChanged.dispatch(),t}activateDataSubsources(e){}updateDataSubsourceActivations(){function*e(){for(let t of this.dataSources){let{loadState:r}=t;if(!(r===void 0||r.error!==void 0))for(let i of r.subsources)if(i.enabled)yield i;else{let{activated:a}=i;i.messages.clearMessages(),a!==void 0&&(a.dispose(),i.activated=void 0,r.activatedSubsourcesChanged.dispatch())}}}this.activateDataSubsources(e.call(this))}decrementLoadingCounter(){--this.loadingCounter==0&&this.readyStateChanged.dispatch()}markLoading(){let e=this.localCoordinateSpaceCombiner.retain(),t=this.manager.root.coordinateSpaceCombiner.retain();return++this.loadingCounter==1&&this.readyStateChanged.dispatch(),()=>{e(),t(),this.decrementLoadingCounter()}}addCoordinateSpace(e){let t=this.manager.root.coordinateSpaceCombiner.bind(e),r=this.localCoordinateSpaceCombiner.bind(e);return()=>{t(),r()}}initializationDone(){let e=this.selectionState={};this.initializeSelectionState(e),this.decrementLoadingCounter()}getLegacyDataSourceSpecifications(e,t,r,i){return e===void 0?[]:[Ml(e,r)]}getDataSourceSpecifications(e){let t,r=W(e,oR,a=>Array.isArray(a)?a.map(o=>Ml(o)):typeof a=="object"?[Ml(a)]:(t=a,[])),i=W(e,Dj,$E);return r.push(...this.getLegacyDataSourceSpecifications(t,e,i,r)),r=r.filter(a=>a.url),r.length===0&&r.push(Jh()),r}restoreState(e){this.tool.restoreState(e[rR]),this.toolBinder.restoreState(e[iR]),this.panels.restoreState(e),this.localCoordinateSpace.restoreState(e[aR]),this.localPosition.restoreState(e[Qx]),this.constructor.supportsPickOption&&this.pick.restoreState(e[sR]);for(let t of this.getDataSourceSpecifications(e))this.addDataSource(t)}addRenderLayer(e){this.renderLayers.push(e);let{layersChanged:t}=this;return e.layerChanged.add(t.dispatch),e.userLayer=this,t.dispatch(),()=>this.removeRenderLayer(e)}removeRenderLayer(e){let{renderLayers:t,layersChanged:r}=this,i=t.indexOf(e);if(i===-1)throw new Error("Attempted to remove invalid RenderLayer");t.splice(i,1),e.layerChanged.remove(r.dispatch),e.userLayer=void 0,e.dispose(),r.dispatch()}disposed(){let{layersChanged:e}=this;Ya(this.dataSources);for(let t of this.renderLayers)t.layerChanged.remove(e.dispatch),t.dispose();this.renderLayers.length=0,super.disposed()}getValueAt(e,t){let r,{renderLayers:i}=this,{pickedRenderLayer:a}=t;if(a!==null&&i.indexOf(a)!==-1&&(r=a.transformPickedValue(t),r=this.transformPickedValue(r),r!=null))return r;for(let o of i)if(r=o.getValueAt(e),r!=null)break;return this.transformPickedValue(r)}transformPickedValue(e){return e}toJSON(){return{type:this.type,[oR]:Pj(this.dataSources),[rR]:this.tool.toJSON(),[iR]:this.toolBinder.toJSON(),[aR]:this.localCoordinateSpace.toJSON(),[Qx]:this.localPosition.toJSON(),[sR]:this.pick.toJSON(),...this.panels.toJSON()}}handleAction(e,t){}selectedValueToJson(e){return e}selectedValueFromJson(e){return e}setLayerPosition(e,t){let{globalPosition:r}=this.manager.root,{localPosition:i}=this;cv(r.value,t,e.globalToRenderLayerDimensions),cv(i.value,t,e.localToRenderLayerDimensions),i.changed.dispatch(),r.changed.dispatch()}};Ti.supportsPickOption=!1;function Pj(n){if(n.length!==0)return n.length===1?n[0].toJSON():n.map(e=>e.toJSON())}var Dp=class extends j{constructor(e,t){super();this.manager=t;this.localCoordinateSpace=new Xs;this.localCoordinateSpaceCombiner=new Ac(this.localCoordinateSpace,$o);this.localPosition=this.registerDisposer(new Ki(this.localCoordinateSpace));this.nonArchivedLayerIndex=-1;this.readyStateChanged=new re;this.layerChanged=new re;this.specificationChanged=new re;this.containers=new Set;this.layer_=null;this.visible=!0;this.archived=!1;this.name_=e}get layer(){return this.layer_}set layer(e){let t=this.layer_;if(t!=null&&(this.unregisterUserLayer(),t.dispose()),this.layer_=e,e!=null){let r=[e.layersChanged.add(this.layerChanged.dispatch),e.readyStateChanged.add(this.readyStateChanged.dispatch),e.specificationChanged.add(this.specificationChanged.dispatch)];this.unregisterUserLayer=()=>{r.forEach(i=>i())},this.readyStateChanged.dispatch(),this.layerChanged.dispatch()}}isReady(){let{layer:e}=this;return e!==null&&e.isReady}get name(){return this.name_}set name(e){e!==this.name_&&(this.name_=e,this.layerChanged.dispatch())}get supportsPickOption(){let e=this.layer;return e!==null&&e.constructor.supportsPickOption}get pickEnabled(){let e=this.layer;return e!==null&&e.constructor.supportsPickOption&&e.pick.value}set pickEnabled(e){let t=this.layer;t!==null&&t.constructor.supportsPickOption&&(t.pick.value=e)}toJSON(){let e=this.layer;if(e===null)return;let t=e.toJSON();return t.name=this.name,this.visible||(this.archived?t.archived=!0:t.visible=!1),t}setVisible(e){if(e!==this.visible){if(e&&this.archived){this.visible=!0,this.setArchived(!1);return}this.visible=e,this.layerChanged.dispatch()}}setArchived(e){if(this.archived!==e){if(e===!0){this.visible=!1,this.archived=!0;for(let{layerManager:t}of this.manager.root.subsets)!t.has(this)||t.removeManagedLayer(this)}else{for(let{layerManager:t}of this.manager.root.subsets)t.has(this)||t.addManagedLayer(this.addRef());this.archived=!1}this.layerChanged.dispatch()}}disposed(){this.layer=null,super.disposed()}},vg=class extends j{constructor(){super();this.managedLayers=new Array;this.layerSet=new Set;this.layersChanged=new re;this.readyStateChanged=new re;this.specificationChanged=new re;this.boundPositions=new WeakSet;this.numDirectUsers=0;this.nonArchivedLayerIndexGeneration=-1;this.renderLayerToManagedLayerMapGeneration=-1;this.renderLayerToManagedLayerMap_=new Map;this.scheduleRemoveLayersWithSingleRef=this.registerCancellable((0,yg.default)(()=>this.removeLayersWithSingleRef(),0));this.layersChanged.add(this.scheduleRemoveLayersWithSingleRef)}updateNonArchivedLayerIndices(){let e=this.layersChanged.count;if(e===this.nonArchivedLayerIndexGeneration)return;this.nonArchivedLayerIndexGeneration=e;let t=0;for(let r of this.managedLayers)r.archived||(r.nonArchivedLayerIndex=t++);for(let r of this.managedLayers)r.archived&&(r.nonArchivedLayerIndex=t++)}getLayerByNonArchivedIndex(e){let t=0;for(let r of this.managedLayers)if(!r.archived){if(t===e)return r;++t}}get renderLayerToManagedLayerMap(){let e=this.layersChanged.count,t=this.renderLayerToManagedLayerMap_;if(this.renderLayerToManagedLayerMapGeneration!==e){this.renderLayerToManagedLayerMapGeneration=e,t.clear();for(let r of this.managedLayers){let i=r.layer;if(i!==null)for(let a of i.renderLayers)t.set(a,r)}}return t}filter(e){let t=!1;this.managedLayers=this.managedLayers.filter(r=>e(r)?!0:(this.unbindManagedLayer(r),this.layerSet.delete(r),t=!0,!1)),t&&this.layersChanged.dispatch()}removeLayersWithSingleRef(){this.numDirectUsers>0||this.filter(e=>e.refCount!==1||e.archived)}updateSignalBindings(e,t){t(e.layerChanged,this.layersChanged.dispatch),t(e.readyStateChanged,this.readyStateChanged.dispatch),t(e.specificationChanged,this.specificationChanged.dispatch)}useDirectly(){return++this.numDirectUsers==1&&this.layersChanged.remove(this.scheduleRemoveLayersWithSingleRef),()=>{--this.numDirectUsers==0&&(this.layersChanged.add(this.scheduleRemoveLayersWithSingleRef),this.scheduleRemoveLayersWithSingleRef())}}addManagedLayer(e,t){return this.updateSignalBindings(e,tR),this.layerSet.add(e),e.containers.add(this),t===void 0&&(t=this.managedLayers.length),this.managedLayers.splice(t,0,e),this.layersChanged.dispatch(),this.readyStateChanged.dispatch(),e}*readyRenderLayers(){for(let e of this.managedLayers)!e.visible||!e.layer||(yield*e.layer.renderLayers)}unbindManagedLayer(e){this.updateSignalBindings(e,eR),e.containers.delete(this),e.manager.rootLayers.layersChanged.dispatch(),e.dispose()}clear(){for(let e of this.managedLayers)this.unbindManagedLayer(e);this.managedLayers.length=0,this.layerSet.clear(),this.layersChanged.dispatch()}remove(e){let t=this.managedLayers[e];this.unbindManagedLayer(t),this.managedLayers.splice(e,1),this.layerSet.delete(t),this.layersChanged.dispatch()}removeManagedLayer(e){let t=this.managedLayers.indexOf(e);if(t===-1)throw new Error("Internal error: invalid managed layer.");this.remove(t)}reorderManagedLayer(e,t){let r=this.managedLayers.length;if(e===t||e<0||e>=r||t<0||t>=r)return;let[i]=this.managedLayers.splice(e,1);this.managedLayers.splice(t,0,i),this.layersChanged.dispatch()}disposed(){this.clear(),super.disposed()}getLayerByName(e){return this.managedLayers.find(t=>t.name===e)}getUniqueLayerName(e){let t=e,r=0;for(;this.getLayerByName(t)!==void 0;)t=e+ ++r;return t}has(e){return this.layerSet.has(e)}get renderLayers(){let e=this;return{*[Symbol.iterator](){for(let t of e.managedLayers)if(t.layer!==null)for(let r of t.layer.renderLayers)yield r}}}get visibleRenderLayers(){let e=this;return{*[Symbol.iterator](){for(let t of e.managedLayers)if(!(t.layer===null||!t.visible))for(let r of t.layer.renderLayers)yield r}}}invokeAction(e){let t=new lR;for(let r of this.managedLayers){if(r.layer===null||!r.visible)continue;let i=r.layer;i.handleAction(e,t);for(let a of i.renderLayers)a.handleAction(e)}for(let r of t.callbacks)r()}},Zx=class{constructor(){this.changed=new re;this.coordinateSpace=ei;this.position=no;this.unsnappedPosition=no;this.active=!1;this.displayDimensions=void 0;this.pickedRenderLayer=null;this.pickedValue=new X(0,0);this.pickedOffset=0;this.pickedAnnotationLayer=void 0;this.pickedAnnotationId=void 0;this.pickedAnnotationBuffer=void 0;this.pickedAnnotationBufferBaseOffset=void 0;this.pickedAnnotationIndex=void 0;this.pickedAnnotationCount=void 0;this.pickedAnnotationType=void 0;this.forcerFunction=void 0}removeForcer(e){e===this.forcerFunction&&(this.forcerFunction=void 0,this.setActive(!1))}setForcer(e){this.forcerFunction=e,e===void 0&&this.setActive(!1)}updateUnconditionally(){let{forcerFunction:e}=this;return e===void 0?!1:(e(),this.active)}setActive(e){(this.active!==e||e===!0)&&(this.active=e,this.changed.dispatch())}},eC=class extends j{constructor(e,t){super();this.layerManager=e;this.mouseState=t;this.changed=new re;this.needsUpdate=!0;this.registerDisposer(t.changed.add(()=>{this.handleChange()})),this.registerDisposer(e.layersChanged.add(()=>{this.handleLayerChange()}))}handleLayerChange(){this.mouseState.active&&this.handleChange()}handleChange(){this.needsUpdate=!0,this.changed.dispatch()}update(){if(!this.needsUpdate)return;this.needsUpdate=!1;let e=this.mouseState,t=this.changed.count;if(e.active)for(let r of this.layerManager.managedLayers){let i=r.layer;if(r.visible&&i!==null){let{selectionState:a}=i;i.resetSelectionState(a),a.generation=t,i.captureSelectionState(a,e)}}}get(e){this.update();let{selectionState:t}=e;if(t.generation===this.changed.count)return t}toJSON(){this.update();let e={};for(let t of this.layerManager.managedLayers){let r=t.layer;if(r){let i=this.get(r);i!==void 0&&(e[t.name]=r.selectionStateToJson(i,!0))}}return e}},cR=10,tC={...vi,minSize:150,row:1},uR={...tC,visible:!0},nC=class extends j{constructor(e,t){super();this.coordinateSpace=e;this.layerSelectedValues=t;this.changed=new re;this.history=[];this.historyIndex=0;this.location=new Zn(tC);this.pin=new Ee(!0);this.registerDisposer(Dn((r,i)=>{i||(this.capture(!0),r.registerDisposer(t.changed.add(r.registerCancellable((0,nR.default)(()=>this.capture(!0),100,{leading:!0,trailing:!0})))))},this.pin)),this.pin.changed.add(this.changed.dispatch),this.location.changed.add(this.changed.dispatch)}get value(){return this.value_}goBack(){let e=this.pin.value?this.historyIndex:this.history.length;e>0&&(this.historyIndex=e-1,this.value_=this.history[e-1],this.pin.value=!0,this.changed.dispatch())}canGoBack(){return(this.pin.value?this.historyIndex:this.history.length)>0}canGoForward(){return this.pin.value?this.historyIndex+1<this.history.length:!1}goForward(){if(!this.pin.value)return;let e=this.historyIndex;e+1<this.history.length&&(this.historyIndex=e+1,this.value_=this.history[e+1],this.changed.dispatch())}set value(e){if(e!==this.value_){if(this.value_=e,e!==void 0&&this.pin.value){let{history:t}=this;t.length=Math.min(t.length,this.historyIndex+1),t.push(e),t.length>cR&&t.splice(0,t.length-cR),this.historyIndex=t.length-1}this.changed.dispatch()}}captureSingleLayerState(e,t,r=!0){if(r===!1&&(!this.location.visible||this.pin.value))return;let i={};e.initializeSelectionState(i),t(i)&&(this.location.visible=!0,r===!0?this.pin.value=!0:r==="toggle"&&(this.pin.value=!this.pin.value),this.value={layers:[{layer:e,state:i}],coordinateSpace:this.coordinateSpace.value,position:void 0})}reset(){this.location.reset(),this.pin.value=!1,this.value=void 0}toJSON(){let{value:e}=this,t;if(this.location.visible){if(t=this.location.toJSON(uR),this.pin.value&&e!==void 0){let r={};for(let i of e.layers){let{layer:a}=i,o=a.selectionStateToJson(i.state,!1);Object.keys(o).length===0&&(o=void 0),r[i.layer.managedLayer.name]=o}e.position!==void 0&&(t.position=Array.from(e.position)),t.layers=r}}else t=this.location.toJSON(tC),t=Ri(t),t!==void 0&&(t.visible=!1);return t}select(){let{pin:e}=this;this.location.visible=!0,e.value=!e.value,e.value&&this.capture()}capture(e=!1){let t=Ij(this.layerSelectedValues);e&&t===void 0||(this.value=t)}restoreState(e){if(e===void 0){this.pin.value=!0,this.value=void 0;return}if(e===null){this.pin.value=!1,this.location.visible=!0,this.value=void 0;return}Z(e),this.location.restoreState(e,uR);let t=this.coordinateSpace.value,r=oe(e,"position",a=>Ne(new Float32Array(t.rank),a,Qe)),i=[];oe(e,"layers",a=>{Z(a);let{layerManager:o}=this.layerSelectedValues;for(let[l,c]of Object.entries(a)){let d=o.getLayerByName(l);if(d===void 0)return;let p=d.layer;if(p===null)return;Z(c);let m={};p.initializeSelectionState(m),p.selectionStateFromJson(m,c),i.push({layer:p,state:m})}}),this.pin.value=i.length>0||r!==void 0,this.value={position:r,coordinateSpace:t,layers:i}}};function Ij(n){let{mouseState:e}=n;if(!e.active)return;let t=[];for(let r of n.layerManager.managedLayers){let i=r.layer;if(i===null)continue;let a=n.get(i);if(a===void 0)continue;let o={};i.initializeSelectionState(o),i.copySelectionState(o,a),t.push({layer:i,state:o})}return{position:e.position.slice(),coordinateSpace:e.coordinateSpace,layers:t}}var dR=class extends j{constructor(e){super();this.view=e;this.messages=new Wi;this.seenGeneration=-1;this.state=void 0}},Aj=0,pR=class extends j{constructor(e,t,r,i,a,o){super();this.layerManager=e;this.renderLayerType=t;this.view=r;this.roles=i;this.layerAdded=a;this.visibility=o;this.visibleLayers_=new Map;this.debouncedUpdateVisibleLayers=this.registerCancellable((0,yg.default)(()=>this.updateVisibleLayers(),0));this.registerDisposer(e.layersChanged.add(this.debouncedUpdateVisibleLayers)),this.registerDisposer(i.changed.add(this.debouncedUpdateVisibleLayers)),this.updateVisibleLayers()}disposed(){this.visibleLayers.forEach(e=>e.dispose()),this.visibleLayers.clear(),super.disposed()}updateVisibleLayers(){let e=++Aj,{visibleLayers_:t,renderLayerType:r,layerAdded:i,roles:a}=this;for(let o of this.layerManager.readyRenderLayers())if(o instanceof r&&a.has(o.role)){let l=o,c=t.get(l);c===void 0&&(c=new dR(this.view),c.registerDisposer(l.messages.addChild(c.messages)),c.registerDisposer(l.addRef()),c.registerDisposer(l.visibility.add(this.visibility)),t.set(l,c),i(l,c),l.attach(c)),c.seenGeneration=e}for(let[o,l]of t)l.seenGeneration!==e&&(t.delete(o),l.dispose())}get visibleLayers(){return this.debouncedUpdateVisibleLayers.flush(),this.visibleLayers_}};function Sg(n,e,t,r,i){return r.registerDisposer(new pR(n,e,r,t,(a,o)=>{o.registerDisposer(a.redrawNeeded.add(()=>r.scheduleRedraw()));let{backend:l}=a;l&&(l.rpc.invoke(OP,{layer:l.rpcId,view:r.rpcId}),o.registerDisposer(()=>l.rpc.invoke(NP,{layer:l.rpcId,view:r.rpcId}))),i!==void 0&&i(a,o),r.scheduleRedraw(),o.registerDisposer(()=>r.scheduleRedraw())},r.visibility))}var rC=class extends j{constructor(e){super();this.layerManager=e;this.changed=new re;this.location=new Zn(ZM);this.registerDisposer(e),this.location.changed.add(()=>{var r,i;this.changed.dispatch();let t=(i=(r=this.layer)==null?void 0:r.layer)!=null?i:void 0;if(t!==void 0){let a=this.location.value;if(a.visible){let o=t.panels.panels[0];o.location.value!==a&&(o.location.value=a,o.location.locationChanged.dispatch())}}})}get layer(){return this.layer_}get visible(){return this.location.visible}toggle(e){this.layer===e&&this.visible?this.visible=!1:(this.layer=e,this.visible=!0)}set visible(e){let t=this.layer_;if(e===!0&&t===void 0){let{managedLayers:r}=this.layerManager;r.length>0?t=this.layer=r[0]:e=!1}if(e===!0&&t!==void 0){let r=t.layer;(r===null||r.panels.panels[0].tabs.length===0)&&(e=!1)}this.visible!==e&&(this.location.visible=e,!e&&t!==void 0&&this.maybeDeleteNewLayer(t),this.changed.dispatch())}maybeDeleteNewLayer(e){if(e.wasDisposed)return;let t=e.layer;t!==null&&t instanceof Xi&&(t.dataSources.some(r=>r.spec.url.length!==0)||bo(e))}set layer(e){if(e===this.layer_)return;let t=this.layer_;if(t!==void 0&&(this.existingLayerDisposer(),this.existingLayerDisposer=void 0,this.maybeDeleteNewLayer(t)),this.layer_=e,e!==void 0){let r=()=>{this.layer_=void 0,this.visible=!1,this.existingLayerDisposer=void 0,this.changed.dispatch()};e.registerDisposer(r);let i=e.specificationChanged.add(()=>{this.changed.dispatch()});this.existingLayerDisposer=()=>{let a=e.layer;if(a!==null){let o=a.tool.value;o!==void 0&&o.deactivate()}e.unregisterDisposer(r),i()}}else this.location.visible=!1;this.changed.dispatch()}toJSON(){let e=this.location.toJSON();return this.layer!==void 0&&(e.layer=this.layer.name),Ri(e)}restoreState(e){if(e===void 0){this.reset();return}Z(e),this.location.restoreState(e);let t=W(e,"layer",Wt),r=t!==void 0?this.layerManager.getLayerByName(t):void 0;r===void 0&&(this.visible=!1),this.layer=r}reset(){this.location.reset(),this.layer=void 0}},iC=class extends j{constructor(e,t){super();this.layerManager=e;this.filter=t;this.changed=new re;this.validate=(0,yg.default)(()=>{let{layerName_:e}=this;if(e!==void 0){let t=this.layerManager.getLayerByName(e);t!==void 0&&this.filter(t)?(this.layer_=t,this.changed.dispatch()):(this.layer_=void 0,this.layerName_=void 0,this.changed.dispatch())}},0);this.registerDisposer(e),this.registerDisposer(e.specificationChanged.add(()=>{let{layer_:r}=this;if(r!==void 0)if(!this.layerManager.layerSet.has(r)||!this.filter(r))this.layer_=void 0,this.layerName_=void 0,this.changed.dispatch();else{let{name:i}=r;i!==this.layerName_&&(this.layerName_=i,this.changed.dispatch())}}))}get layer(){return this.layer_}get layerName(){return this.layerName_}set layer(e){this.layer_!==e&&(e!==void 0&&this.layerManager.layerSet.has(e)&&this.filter(e)?(this.layer_=e,this.layerName_=e.name):(this.layer_=void 0,this.layerName_=void 0),this.changed.dispatch())}set layerName(e){e!==this.layerName_&&(this.layer_=void 0,this.layerName_=e,this.changed.dispatch(),this.validate())}restoreState(e){let t=Wt(e);this.layerName=t}toJSON(){let{layer_:e}=this;return e!==void 0?e.name:this.layerName_}reset(){this.layerName_=void 0,this.layer_=void 0,this.changed.dispatch()}},bg=class extends j{constructor(e,t,r,i){super();this.layerManager=e;this.layer=t;this.predicate=r;this.getGroup=i;this.linkedLayers_=new Set;this.changed=new re;this.linkedLayersChanged=new re;this.root_=t;let a=this;this.root={get value(){return a.root_},changed:a.changed}}get linkedLayers(){return this.linkedLayers_}get rootGroup(){return this.getGroup(this.root.value)}reset(){this.isolate()}restoreState(e){if(e===void 0)return;let t=Q(e);this.linkByName(t)}toJSON(){let{root:{value:e}}=this;if(e!==this.layer)return e.managedLayer.name}isolate(e=!0){let{getGroup:t,layer:r,root_:i}=this;if(i===r){let{linkedLayers_:o}=this;if(o.size!==0){for(let l of o){let c=t(l);c.root_=l,c.changed.dispatch()}o.clear(),this.linkedLayersChanged.dispatch()}return}let a=t(i);a.linkedLayers_.delete(r),a.linkedLayersChanged.dispatch(),this.root_=r,e&&this.changed.dispatch()}linkByName(e){let{layer:t}=this,{managedLayer:r}=t,{layerManager:i}=this,a=i.getLayerByName(e);if(a===void 0||a===r)return;let o=a.layer;o!==null&&(!this.predicate(o)||this.linkToLayer(o))}linkToLayer(e){if(e===this.layer||this.root_===e)return;this.root_!==this.layer&&this.isolate(!1);let{getGroup:t}=this,r=t(e).root_;if(r===this.layer)return;let i=t(r);i.linkedLayers_.add(this.layer),i.linkedLayersChanged.dispatch(),this.root_=r,this.changed.dispatch()}disposed(){this.isolate(!1)}};function fR(n,e){let t=oe(e,"type",Q,"auto");n.archived=oe(e,"archived",ya,!1),n.archived?n.visible=!1:n.visible=oe(e,"visible",ya,!0);let r=Ip.get(t)||Xi;return n.layer=new r(n),e}function hR(n,e){try{let t=n.layer;if(t===null)return;t.restoreState(e),t.initializationDone()}catch(t){throw bo(n),t}}function mR(n,e){try{Z(e),fR(n,e),hR(n,e)}catch(t){throw bo(n),t}}function gR(n,e){try{mR(n,e)}catch(t){new Ce().setErrorMessage(t instanceof Error?t.message:""+t)}}function aC(n,e,t){let r=new Dp(e,n);return mR(r,t),r}var oC=class extends j{constructor(){super(...arguments);this.changed=new re}},sC=class extends oC{constructor(e,t,r,i,a,o,l,c,d){super();this.display=e;this.dataSourceProviderRegistry=t;this.layerManager=r;this.chunkManager=i;this.selectionState=a;this.selectedLayer=o;this.coordinateSpace=l;this.globalPosition=c;this.toolBinder=d;this.coordinateSpaceCombiner=new Ac(this.coordinateSpace,WE);this.subsets=new Set;this.layerSelectedValues=this.selectionState.layerSelectedValues;this.registerDisposer(r.layersChanged.add(this.changed.dispatch)),this.registerDisposer(r.specificationChanged.add(this.changed.dispatch))}get rpc(){return this.chunkManager.rpc}get root(){return this}reset(){this.layerManager.clear()}restoreState(e){this.layerManager.clear();let t;Array.isArray(e)?t=e:(Z(e),t=Object.entries(e).map(([i,a])=>typeof a=="string"?{name:i,source:a}:(Z(a),{...a,name:i})));let r=[];for(let i of t){Z(i);let a=this.layerManager.getUniqueLayerName(W(i,"name",Q)),o=new Dp(a,this);try{fR(o,i),this.layerManager.addManagedLayer(o),r.push({managedLayer:o,spec:i})}catch(l){o.dispose(),new Ce().setErrorMessage(`Error creating layer ${JSON.stringify(a)}: `+(l instanceof Error)?l.message:""+l)}}for(let{managedLayer:i,spec:a}of r)try{hR(i,a)}catch(o){new Ce().setErrorMessage(`Error creating layer ${JSON.stringify(name)}: `+(o instanceof Error)?o.message:""+o)}}add(e,t){this.layerManager.managedLayers.indexOf(e)===-1&&(e.name=this.layerManager.getUniqueLayerName(e.name)),this.layerManager.addManagedLayer(e,t)}toJSON(){let e=[],t=0;for(let r of this.layerManager.managedLayers){let i=r.toJSON();i!=null&&(e.push(i),++t)}if(t!==0)return e}get rootLayers(){return this.layerManager}},Pp=class extends oC{constructor(e){super();this.master=e;this.changed=new re;this.layerManager=this.registerDisposer(new vg);this.registerDisposer(e);let{layerManager:t}=this;this.registerDisposer(t.layersChanged.add(this.changed.dispatch)),this.registerDisposer(t.specificationChanged.add(this.changed.dispatch)),e.subsets.add(this)}get rpc(){return this.master.rpc}get dataSourceProviderRegistry(){return this.master.dataSourceProviderRegistry}get chunkManager(){return this.master.chunkManager}get layerSelectedValues(){return this.master.layerSelectedValues}get root(){return this.master}disposed(){super.disposed(),this.master.subsets.delete(this)}reset(){this.layerManager.clear()}restoreState(e){let t=this.master.layerManager,r=[];for(let i of new Set(ge(e,Q))){let a=t.getLayerByName(i);if(a===void 0)throw new Error(`Undefined layer referenced in subset specification: ${JSON.stringify(i)}`);a.archived||r.push(a)}this.layerManager.clear();for(let i of r)this.layerManager.addManagedLayer(i.addRef())}toJSON(){return this.layerManager.managedLayers.map(e=>e.name)}add(e,t){this.master.layerManager.managedLayers.indexOf(e)===-1&&(e.name=this.master.layerManager.getUniqueLayerName(e.name),this.master.layerManager.addManagedLayer(e.addRef())),this.layerManager.addManagedLayer(e,t)}get rootLayers(){return this.master.rootLayers}},Ip=new Map,lC=new Map,yR=[n=>{let{volume:e}=n;if(e===void 0)return;let t=lC.get(e.volumeType);if(t!==void 0)return{layerConstructor:t,priority:0}}];function Qi(n,e=n.type){Ip.set(e,n)}function gs(n){yR.push(n)}function xg(n,e){lC.set(n,e)}function Ep(n,e){let t=n.layer;if(t===null)return;let r=t.toJSON(),i=new e(n);i.restoreState(r),i.initializationDone(),n.layer=i}function mg(n,e){return e!==n.name?(e=n.manager.root.layerManager.getUniqueLayerName(e),n.name=e,n.layerChanged.dispatch(),!0):!1}function bo(n){if(!n.wasDisposed)for(let e of n.containers)e.removeManagedLayer(n)}function cC(n,e){return n===void 0?e:e===void 0?n:n.priority<e.priority?e:n}function Mj(n){let e;for(let r of yR)e=cC(e,r(n));let{volume:t}=n;if(t!==void 0){let r=lC.get(t.volumeType);r!==void 0&&(e=cC(e,{layerConstructor:r,priority:0}))}return e}function vR(n){let e;for(let t of n){let{subsourceEntry:r}=t,{subsource:i}=r;e=cC(e,Mj(i))}return e}var Xi=class extends Ti{activateDataSubsources(e){var t;this.detectedLayerConstructor=(t=vR(e))==null?void 0:t.layerConstructor}};Xi.type="new",Xi.typeAbbreviation="new";var Cg=class extends Ti{activateDataSubsources(e){var r;let t=(r=vR(e))==null?void 0:r.layerConstructor;t!==void 0&&Ep(this.managedLayer,t)}};Cg.type="auto",Cg.typeAbbreviation="auto";function wg(n,e){let t=aC(n,"new layer",{type:"new"});n.add(t),e.layer=t,e.visible=!0}Qi(Xi);Qi(Cg);var TR=ot(Et());var Rj="DisjointUint64Sets",SR="DisjointUint64Sets.add",bR="DisjointUint64Sets.clear",xR="DisjointUint64Sets.highBitRepresentativeChanged",CR="DisjointUint64Sets.deleteSet",Ua=class extends ro{constructor(){super(...arguments);this.disjointSets=new Pl;this.changed=new re}get value(){return this}static makeWithCounterpart(e,t){let r=new this;return r.disjointSets.visibleSegmentEquivalencePolicy=t,r.registerDisposer(t.changed.add(()=>{wR(r)})),r.initializeCounterpart(e),t.value&&wR(r),r}disposed(){this.disjointSets=void 0,this.changed=void 0,super.disposed()}link(e,t){if(this.disjointSets.link(e,t)){let{rpc:r}=this;return r&&r.invoke(SR,{id:this.rpcId,al:e.low,ah:e.high,bl:t.low,bh:t.high}),this.changed.dispatch(),!0}return!1}linkAll(e){for(let t=1,r=e.length;t<r;++t)this.link(e[0],e[t])}has(e){return this.disjointSets.has(e)}get(e){return this.disjointSets.get(e)}clear(){if(this.disjointSets.clear()){let{rpc:e}=this;e&&e.invoke(bR,{id:this.rpcId}),this.changed.dispatch()}}setElements(e){return this.disjointSets.setElements(e)}deleteSet(e){if(this.disjointSets.deleteSet(e)){let{rpc:t}=this;t&&t.invoke(CR,{id:this.rpcId,l:e.low,h:e.high}),this.changed.dispatch()}}get size(){return this.disjointSets.size}toJSON(){return this.disjointSets.toJSON()}restoreState(e){if(e!==void 0){let t=[new X,new X];ge(e,r=>{ge(r,(i,a)=>{t[a%2].parseString(String(i),10),a!==0&&this.link(t[0],t[1])})})}}assignFrom(e){this.clear(),e instanceof Ua&&(e=e.disjointSets);for(let[t,r]of e)this.link(t,r)}};Ua=kt([jo(Rj)],Ua);var iu=new X,uC=new X;wt(SR,function(n){let e=this.get(n.id);iu.low=n.al,iu.high=n.ah,uC.low=n.bl,uC.high=n.bh,e.disjointSets.link(iu,uC)&&e.changed.dispatch()});wt(bR,function(n){let e=this.get(n.id);e.disjointSets.clear()&&e.changed.dispatch()});function wR(n){n.rpc.invoke(xR,{id:n.rpcId,value:n.disjointSets.visibleSegmentEquivalencePolicy.value})}wt(xR,function(n){let e=this.get(n.id);e.disjointSets.visibleSegmentEquivalencePolicy.value=n.value});wt(CR,function(n){let e=this.get(n.id);iu.low=n.l,iu.high=n.h,e.disjointSets.deleteSet(iu)&&e.changed.dispatch()});var dC=class extends ol{constructor(){super(...arguments);this.spanningTreeEdges=new Map;this.equivalences=new Ua;this.connections=new Set;this.changed=new ze}link(e,t){this.equivalences.link(e,t);for(let r of this.connections)r.segmentsState.segmentEquivalences.link(e,t)}linkAll(e){this.equivalences.linkAll(e);for(let t of this.connections)t.segmentsState.segmentEquivalences.linkAll(e)}deleteSet(e){this.equivalences.deleteSet(e);for(let t of this.connections)t.segmentsState.segmentEquivalences.deleteSet(e)}normalizeAll(){for(let e of this.connections)pC(e.segmentsState.visibleSegments,e.segmentsState.segmentEquivalences.disjointSets)}addSpanningTreeEdge(e,t){let r=e.toString(),i=t.toString(),{spanningTreeEdges:a}=this,o=a.get(r);o===void 0&&(o=new Set,a.set(r,o));let l=a.get(i);l===void 0&&(l=new Set,a.set(i,l)),o.add(i),l.add(r)}removeSpanningTreeEdge(e,t){let r=e.toString(),i=t.toString(),{spanningTreeEdges:a}=this,o=a.get(r),l=a.get(i);o.delete(i),o.size===0&&a.delete(r),l.delete(r),l.size===0&&a.delete(i)}*getSpanningTreeNeighbors(e){let t=new X,r=this.spanningTreeEdges.get(e.toString());if(r!==void 0)for(let i of r)t.parseString(i),yield t}restoreState(e){let{equivalences:t,spanningTreeEdges:r}=this;if(t.clear(),r.clear(),e===void 0)return;let i=[new X,new X];ge(e,a=>{ge(a,(o,l)=>{i[l%2].parseString(String(o),10),l!==0&&t.link(i[0],i[1])&&this.addSpanningTreeEdge(i[0],i[1])})})}toJSON(){let{spanningTreeEdges:e}=this;if(e.size===0)return;let t=new Array;for(let[r,i]of e){let a=X.parseString(r);for(let o of i){let l=X.parseString(o);X.compare(a,l)>0||t.push([a,l])}}return t.sort((r,i)=>X.compare(r[0],i[0])||X.compare(r[1],i[1])),t.map(r=>r.map(i=>i.toString()))}get visibleSegmentEquivalencePolicy(){return Kt.MIN_REPRESENTATIVE}async merge(e,t){let{equivalences:r}=this;return X.equal(r.get(e),r.get(t))?e:(this.addSpanningTreeEdge(e,t),this.link(e,t),this.normalizeAll(),this.changed.dispatch(),r.get(e))}async split(e,t){let r=this.computeSplit(e,t);if(r===void 0)throw new Error("Segments are already split");let{includeBaseSegments:i,includeRepresentative:a,excludeBaseSegments:o,excludeRepresentative:l}=r,{equivalences:c}=this;this.deleteSet(e),this.linkAll(i),this.linkAll(o);let d=(g,v)=>{for(let b of g)for(let x of this.getSpanningTreeNeighbors(b))X.equal(c.get(x),v)||this.removeSpanningTreeEdge(b,x)},p=c.get(e),m=c.get(t);d(i,p),d(o,m);for(let g of this.connections){let{visibleSegments:v}=g.segmentsState;v.has(l)&&(v.delete(l),v.add(a))}return this.normalizeAll(),this.changed.dispatch(),{include:p,exclude:m}}trackSegment(e,t){return()=>{}}computeSplit(e,t){let{equivalences:r}=this,i=r.get(e);if(!X.equal(i,r.get(t)))return;let a=new Pl;for(let m of r.setElements(i))if(!X.equal(m,t))for(let g of this.getSpanningTreeNeighbors(m))X.equal(g,t)||a.link(m,g);let o=[],l=[],c=a.get(e),d=e,p=t;for(let m of r.setElements(i))X.equal(a.get(m),c)?(o.push(m),X.compare(m,d)<0&&(d=m)):(l.push(m),X.compare(m,p)<0&&(p=m));return o.sort(X.compare),l.sort(X.compare),{includeBaseSegments:o,includeRepresentative:d,excludeBaseSegments:l,excludeRepresentative:p}}connect(e){let t=e.displayState.segmentationGroupState.value,r=new LR(this,t);return t.segmentEquivalences.assignFrom(this.equivalences),pC(t.visibleSegments,t.segmentEquivalences.disjointSets),r.registerDisposer(t.visibleSegments.changed.add(r.registerCancellable((0,TR.default)(()=>pC(t.visibleSegments,t.segmentEquivalences.disjointSets),0)))),this.connections.add(r),r.registerDisposer(()=>{this.connections.delete(r)}),r}};function pC(n,e){let t=[];for(let r of n.unsafeKeys()){let i=e.get(r);X.equal(r,i)||(t.push(i),n.delete(r))}for(let r of t)n.add(r)}var LR=class extends sl{computeSplit(e,t){return this.graph.computeSplit(e,t)}};var _j=K.create(),Vj=K.create(),Tg=.001,kR=.001;function ER(n){let e=0;for(var t=0;t<3;++t)n[t]<0&&(e+=1<<t);return e}var Lg=new Float32Array([0,0,0,1,0,0,0,1,0,1,1,0,0,0,1,1,0,1,0,1,1,1,1,1]),DR=(()=>{let n=[0,1,2,4,5,3,6,7],e=[0,1,2,5,3,4,6,7],t=[0,1,1,4,4,7,4,7,1,5,0,1,1,4,4,7,0,2,2,5,5,7,5,7,2,6,0,2,2,5,5,7,0,3,3,6,6,7,6,7,3,4,0,3,3,6,6,7],r=[0,1,2,3,4,5,6,7,1,4,5,0,3,7,2,6,2,6,0,5,7,3,1,4,3,0,6,4,1,2,7,5,4,3,7,1,0,6,5,2,5,2,1,7,6,0,4,3,6,7,3,2,5,4,0,1,7,5,4,6,2,1,3,0],i=new Int32Array(8*8*6);for(let a=0;a<8;++a)for(let o=0;o<t.length;++o){let l=e[a]*8+t[o];i[a*8*6+o]=n[r[l]]}return i})();function Ol(n){n.addUniform("highp vec3","uPlaneNormal"),n.addUniform("highp float","uPlaneDistance"),n.addUniform("highp ivec2","uVertexIndex",24),n.addUniform("highp vec3","uVertexBasePosition",8),n.addInitializer(e=>{e.gl.uniform3fv(e.uniform("uVertexBasePosition"),Lg)}),n.addVertexCode(`
vec3 getBoundingBoxPlaneIntersectionVertexPosition(vec3 chunkSize, vec3 boxLower, vec3 lowerClipBound, vec3 upperClipBound, int vertexIndex, float planeDistance) {
  for (int e = 0; e < 4; ++e) {
    highp ivec2 vidx = uVertexIndex[vertexIndex*4 + e];
    highp vec3 v1 = max(lowerClipBound, min(upperClipBound, chunkSize * uVertexBasePosition[vidx.x] + boxLower));
    highp vec3 v2 = max(lowerClipBound, min(upperClipBound, chunkSize * uVertexBasePosition[vidx.y] + boxLower));
    highp vec3 vDir = v2 - v1;
    highp float denom = dot(vDir, uPlaneNormal);
    if (abs(denom) > ${kR}) {
      highp float lambda = (planeDistance - dot(v1, uPlaneNormal)) / denom;
      if ((lambda >= -${Tg}) && (lambda <= (1.0 + ${Tg}))) {
        lambda = clamp(lambda, 0.0, 1.0);
        highp vec3 position = v1 + lambda * vDir;
        return position;
      }
    }
  }
  return vec3(0, 0, 0);
}
vec3 getBoundingBoxPlaneIntersectionVertexPosition(vec3 chunkSize, vec3 boxLower, vec3 lowerClipBound, vec3 upperClipBound, int vertexIndex) {
  return getBoundingBoxPlaneIntersectionVertexPosition(chunkSize, boxLower, lowerClipBound, upperClipBound, vertexIndex, uPlaneDistance);
}
`)}function PR(n,e,t,r,i,a,o,l=!0){let c=ER(i),d=DR.subarray(c*48,(c+1)*48),p=[0,0],m=[K.create(),K.create()],g=K.create(),v=K.create(),b=x=>Lg.subarray(x*3,x*3+3);for(let x=0;x<4;++x){for(let T=0;T<2;++T)p[T]=d[2*(o*4+x)+T],K.multiply(m[T],n,b(p[T])),K.add(m[T],m[T],a),K.min(m[T],m[T],t),K.max(m[T],m[T],e);K.subtract(g,m[1],m[0]);let C=K.dot(g,i);if(Math.abs(C)>kR){let T=(r-K.dot(m[0],i))/C;if(T>=-Tg&&T<=1+Tg)return l&&console.log(`vertex ${o}, e = ${x}, good, lambda=${T}, denom=${C}, v0=${m[0].join()}, vDir=${g.join()}`),T=Math.max(0,Math.min(1,T)),K.scaleAndAdd(v,m[0],g,T),v;l&&console.log(`vertex ${o}, e = ${x}, skipped, denom = ${C}, vDir = ${g.join()}, v0=${m[0].join()}, v1=${m[1].join()}uPlaneNormal = ${Fo(i)}, lambda=${T}`)}else l&&console.log(`vertex ${o}, e = ${x}, skipped, deom = ${C}, vDir = ${Fo(g)}, uPlaneNormal = ${Fo(i)}, uLowerClipBound=${e.join()}, uUpperClipBound=${t.join()}, chunkSize=${n}, uVertexBasePosition(v0)=${b(p[0]).join()}, uVertexBasePosition(v1)=${b(p[1]).join()}, uTranslation=${a.join()}`)}}function Oj(n,e,t){let{gl:r}=n;r.uniform3fv(n.uniform("uPlaneNormal"),e),r.uniform1f(n.uniform("uPlaneDistance"),t);let i=ER(e);r.uniform2iv(n.uniform("uVertexIndex"),DR.subarray(i*48,(i+1)*48))}function au(n,e,t,r,i){let a=qf(_j,e,r);K.normalize(a,a);let o=K.dot(K.transformMat4(Vj,t,i),a);Oj(n,a,o)}var fC=!1,IR=.001,AR=ae.create();function Nj(n,e){if(Lr(n),Ol(n),n.addUniform("highp vec3","uTranslation"),n.addUniform("highp mat4","uProjectionMatrix"),n.addUniform("highp vec3","uChunkDataSize"),n.addUniform("highp vec3","uLowerClipBound"),n.addUniform("highp vec3","uUpperClipBound"),e){rr(n),n.setVertexMain(`
int vertexIndex1 = gl_VertexID / ${bi};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex2);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`),n.setFragmentMain(`
emit(vec4(1.0, 1.0, 1.0, getLineAlpha()));
`);return}n.addVarying("highp vec3","vChunkPosition"),n.setVertexMain(`
vec3 position = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, gl_VertexID);
gl_Position = uProjectionMatrix * vec4(position, 1.0);
gl_Position.z = 0.0;
vChunkPosition = (position - uTranslation) +
    ${IR} * abs(uPlaneNormal);
`)}function Bj(n,e,t,r,i,a,o){let l=K.create(),c=K.create(),d=K.fromValues(Math.abs(i[0]),Math.abs(i[1]),Math.abs(i[2])),p=K.create();for(let m=0;m<6;++m){let g=PR(n,e,t,r,i,a,m);if(g===void 0){console.log("no intersection found");return}K.transformMat4(l,g,o);let v=m!==0&&K.equals(l,p);K.copy(p,l),K.sub(c,g,a),K.scaleAndAdd(c,c,d,IR),console.log(`${v?"SKIPPED":"OUTPUT"} vertex ${m}, at ${l}, vChunkPosition = ${c}, uTranslation=${a.join()}, position=${g.join()}`)}}function Uj(n,e,t){t&&ar(n,e,1)}function Fj(n,e,t,r,i,a){let o=t.projectionParameters.value,{centerDataPosition:l}=o;au(e,o.viewportNormalInGlobalCoordinates,l,a.transform,a.invTransform),n.uniformMatrix4fv(e.uniform("uProjectionMatrix"),!1,ae.multiply(AR,r,a.transform)),n.uniform3fv(e.uniform("uLowerClipBound"),i.lowerClipDisplayBound),n.uniform3fv(e.uniform("uUpperClipBound"),i.upperClipDisplayBound),fC&&(window.debug_sliceView_uLowerClipBound=i.lowerClipDisplayBound,window.debug_sliceView_uUpperClipBound=i.upperClipDisplayBound,window.debug_sliceView=t,window.debug_sliceView_dataToDevice=ae.clone(AR),window.debug_sliceView_chunkLayout=a)}function Gj(n,e,t){n.uniform3fv(e.uniform("uChunkDataSize"),t),fC&&(window.debug_sliceView_chunkDataSize=t)}function Wj(n,e,t,r){if(n.uniform3fv(e.uniform("uTranslation"),t),r?ir(e.gl,6,1):n.drawArrays(n.TRIANGLE_FAN,0,6),fC){let a=window.debug_sliceView.projectionParameters.value,o=window.debug_sliceView_chunkDataSize,l=window.debug_sliceView_uLowerClipBound,c=window.debug_sliceView_uUpperClipBound,d=window.debug_sliceView_dataToDevice,p=window.debug_sliceView_chunkLayout;console.log(`Drawing chunk: ${t.join()} of data size ${o.join()}, projection`,d);let m=p.globalToLocalNormal(K.create(),a.viewportNormalInGlobalCoordinates),g=K.dot(K.transformMat4(K.create(),a.centerDataPosition,p.invTransform),m);Bj(o,l,c,g,m,t,d)}}function zj(n,e,t){return n>e?t>n?n:e>t?e:t:t>e?e:n>t?n:t}var Ap=class extends Nc{constructor(e,t){let{shaderError:r=Sa(),shaderParameters:i}=t;super(e.chunkManager,e,t);let{gl:a}=this;this.vertexIdHelper=this.registerDisposer(zn.get(a)),this.shaderParameters=i;let{channelCoordinateSpace:o}=t;this.channelCoordinateSpace=o===void 0?Rr(ei):o,this.registerDisposer(i.changed.add(this.redrawNeeded.dispatch));let l=this.registerDisposer(At((c,d)=>({numChannelDimensions:c.rank,dataHistogramChannelSpecifications:d}),[this.channelCoordinateSpace,this.dataHistogramSpecifications.channels]));this.shaderGetter=Ad(this,a,{memoizeKey:`volume/RenderLayer:${pt(this.constructor)}`,fallbackParameters:t.fallbackShaderParameters,parameters:i,encodeParameters:t.encodeShaderParameters,shaderError:r,extraParameters:l,defineShader:(c,d,p,m)=>{let{chunkFormat:g,dataHistogramsEnabled:v}=d,{dataHistogramChannelSpecifications:b,numChannelDimensions:x}=m;if(Nj(c,g===null),c.addOutputBuffer("vec4","v4f_fragData0",0),c.addFragmentCode(`
void emit(vec4 color) {
  v4f_fragData0 = color;
}
`),g===null)return;Cm(c,g,x,"vChunkPosition");let C=b.length;if(v&&C>0){let T="",{dataType:I}=g;for(let P=0;P<C;++P){let{channel:M}=b[P],D=`out_histogram${P}`;c.addOutputBuffer("vec4",D,1+P);let E=`getDataValue(${M.join(",")})`,V=`invlerpForHistogram${P}`;c.addFragmentCode(rl(c,V,I,!1)),c.addFragmentCode(`
float getHistogramValue${P}() {
  return invlerpForHistogram${P}(${E});
}
`),T+=`{
float x = getHistogramValue${P}();
if (x < 0.0) x = 0.0;
else if (x > 1.0) x = 1.0;
else x = (1.0 + x * 253.0) / 255.0;
${D} = vec4(x, x, x, 1.0);
}`}c.addFragmentCode(`void userMain();
void main() {
  ${T}
  userMain();
}
#define main userMain
`)}this.defineShader(c,p)},getContextKey:c=>{var d;return`${(d=c.chunkFormat)==null?void 0:d.shaderKey}/${c.dataHistogramsEnabled}`}}),this.tempChunkPosition=new Float32Array(e.rank),this.initializeCounterpart()}get dataType(){return this.multiscaleSource.dataType}getValueAt(e){let{tempChunkPosition:t}=this;for(let{source:r,chunkTransform:i}of this.visibleSourcesList){if(!Ni(t,e,this.localPosition.value,i.layerRank,i.combinedGlobalLocalToChunkTransform))continue;let a=r.getValueAt(t,i);if(a!=null)return a}return null}beginChunkFormat(e,t,r){let{gl:i}=this,a=this.dataHistogramSpecifications.visibility.visible,o=this.shaderGetter({chunkFormat:t,dataHistogramsEnabled:a}),{shader:l,parameters:c,fallback:d}=o;if(l!==null&&(l.bind(),Uj(l,r,t===null),t!==null)){if(a){let{dataHistogramChannelSpecifications:p}=o.extraParameters,m=p.length,g=this.dataHistogramSpecifications.bounds.value;for(let v=0;v<m;++v)io(l,`invlerpForHistogram${v}`,t.dataType,g[v])}this.initializeShader(e,l,c,d),t.beginDrawing(i,l)}return o}endSlice(e,t,r){}draw(e){let{sliceView:t}=e,r=t.visibleLayers.get(this),{visibleSources:i}=r;if(i.length===0)return;let{projectionParameters:a,wireFrame:o}=e,{gl:l}=this;this.vertexIdHelper.enable();let c=K.create(),{renderScaleHistogram:d}=this;d!==void 0&&d.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);let p,m=null,g,v=K.create(),b=()=>{m!==null&&(g!==null&&g.endDrawing(l,m),this.endSlice(t,m,p.parameters))},x=!0;for(let C of i){let T=Rc(a,C.chunkLayout),{chunkTransform:{channelToChunkDimensionIndices:I}}=C,P=C.source,{fixedPositionWithinChunk:M,chunkDisplayDimensionIndices:D}=C;for(let N of D)M[N]=0;let E=o?null:P.chunkFormat;if(E!==g&&(g=E,b(),p=this.beginChunkFormat(t,E,a),m=p.shader),m===null)continue;let V=P.chunks;v.fill(1);let O=T.size,B,z=P.spec.rank;Fj(l,m,t,a.viewProjectionMat,C,T),E!==null&&E.beginSource(l,m),x=!0;let _=0,U=0;if(t.forEachVisibleChunk(C,T,N=>{let J=V.get(N);if(J&&J.state===Ze.GPU_MEMORY){let ie=J.chunkDataSize;if(ie!==B){B=ie;for(let me=0;me<3;++me){let Pe=D[me];v[me]=Pe===-1||Pe>=z?1:B[Pe]}Gj(l,m,v)}let{chunkGridPosition:pe}=J;for(let me=0;me<3;++me){let Pe=D[me];c[me]=Pe===-1||Pe>=z?0:O[me]*pe[Pe]}E!==null&&E.bindChunk(l,m,J,M,D,I,x),x=!1,Wj(l,m,c,o),++_}else++U}),(_!==0||U!==0)&&d!==void 0){let{effectiveVoxelSize:N}=C,J=zj(N[0],N[1],N[2]);d.add(J,J/a.pixelSize,_,U)}}if(b(),this.vertexIdHelper.disable(),!e.wireFrame){let C=this.getDataHistogramCount();C>0&&t.computeHistograms(C,this.dataHistogramSpecifications)}}};var hC=class{constructor(e){this.disjointSets=e;this.generation=Number.NaN;this.hashMap=new Wc}update(){let{disjointSets:e}=this,{generation:t}=e;if(this.generation!==t){this.generation=t;let{hashMap:r}=this;r.clear();for(let[i,a]of e.mappings())r.set(i,a)}}},MR=1,RR=2,kg=class extends Ap{constructor(e,t){super(e,{shaderParameters:new sd(r=>({hasEquivalences:r.registerDisposer(At(i=>i.size!==0,[t.segmentationGroupState.value.segmentEquivalences])),hasSegmentStatedColors:r.registerDisposer(At((i,a,o)=>(o?a:i).size!==0,[t.segmentStatedColors,t.tempSegmentStatedColors2d,t.useTempSegmentStatedColors2d])),hasSegmentDefaultColor:r.registerDisposer(At((i,a)=>i!==void 0||a!==void 0,[t.segmentDefaultColor,t.tempSegmentDefaultColor2d])),hasHighlightColor:r.registerDisposer(At(i=>i!==void 0,[t.highlightColor])),hideSegmentZero:t.hideSegmentZero,baseSegmentColoring:t.baseSegmentColoring,baseSegmentHighlighting:t.baseSegmentHighlighting})),transform:t.transform,renderScaleHistogram:t.renderScaleHistogram,renderScaleTarget:t.renderScaleTarget,localPosition:t.localPosition});this.displayState=t;this.segmentationGroupState=this.displayState.segmentationGroupState.value;this.segmentColorShaderManager=new cb("segmentColorHash");this.segmentStatedColorShaderManager=new db("segmentStatedColor");this.hashTableManager=new sm("visibleSegments");this.gpuHashTable=this.registerDisposer(vl.get(this.gl,this.segmentationGroupState.visibleSegments.hashTable));this.gpuTemporaryHashTable=vl.get(this.gl,this.segmentationGroupState.temporaryVisibleSegments.hashTable);this.equivalencesShaderManager=new Kd("equivalences");this.equivalencesHashMap=new hC(this.segmentationGroupState.segmentEquivalences.disjointSets);this.temporaryEquivalencesHashMap=new hC(this.segmentationGroupState.temporarySegmentEquivalences.disjointSets);this.gpuEquivalencesHashTable=this.registerDisposer(vl.get(this.gl,this.equivalencesHashMap.hashMap));this.gpuTemporaryEquivalencesHashTable=this.registerDisposer(vl.get(this.gl,this.temporaryEquivalencesHashMap.hashMap));this.registerDisposer(this.shaderParameters),Pb(t,this),this.registerDisposer(t.selectedAlpha.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.notSelectedAlpha.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.ignoreNullVisibleSet.changed.add(this.redrawNeeded.dispatch))}disposed(){var e;(e=this.gpuSegmentStatedColorHashTable)==null||e.dispose()}getSources(e){return this.multiscaleSource.getSources({...e,discreteValues:!0})}defineShader(e,t){this.hashTableManager.defineShader(e);let r=`
uint64_t getUint64DataValue() {
  uint64_t x = toUint64(getDataValue());
`;r+=`return x;
}
`,e.addFragmentCode(r),t.hasEquivalences?(this.equivalencesShaderManager.defineShader(e),e.addFragmentCode(`
uint64_t getMappedObjectId(uint64_t value) {
  uint64_t mappedValue;
  if (${this.equivalencesShaderManager.getFunctionName}(value, mappedValue)) {
    return mappedValue;
  }
  return value;
}
`)):e.addFragmentCode(`
uint64_t getMappedObjectId(uint64_t value) {
  return value;
}
`),e.addUniform("highp uvec2","uSelectedSegment"),e.addUniform("highp uint","uFlags"),e.addUniform("highp float","uSelectedAlpha"),e.addUniform("highp float","uNotSelectedAlpha"),e.addUniform("highp float","uSaturation");let i=`
  uint64_t baseValue = getUint64DataValue();
  uint64_t value = getMappedObjectId(baseValue);
  uint64_t valueForColor = ${t.baseSegmentColoring?"baseValue":"value"};
  uint64_t valueForHighlight = ${t.baseSegmentHighlighting?"baseValue":"value"};

  float alpha = uSelectedAlpha;
  float saturation = uSaturation;
`;t.hideSegmentZero&&(i+=`
  if (value.value[0] == 0u && value.value[1] == 0u) {
    emit(vec4(vec4(0, 0, 0, 0)));
    return;
  }
`),i+=`
  bool has = (uFlags & ${RR}u) != 0u ? true : ${this.hashTableManager.hasFunctionName}(value);
  if ((uFlags & ${MR}u) != 0u && uSelectedSegment == valueForHighlight.value) {
    float adjustment = has ? 0.5 : 0.75;
    if (saturation > adjustment) {
      saturation -= adjustment;
    } else {
      saturation += adjustment;
    }
`,t.hasHighlightColor&&(e.addUniform("highp vec4","uHighlightColor"),i+=`
    emit(uHighlightColor);
    return;
`),i+=`
  } else if (!has) {
    alpha = uNotSelectedAlpha;
  }
`;let a=`vec4 getMappedIdColor(uint64_t value) {
`;t.hasSegmentStatedColors&&(this.segmentStatedColorShaderManager.defineShader(e),a+=`
  vec4 rgba;
  if (${this.segmentStatedColorShaderManager.getFunctionName}(value, rgba)) {
    return rgba;
  }
`),t.hasSegmentDefaultColor?(e.addUniform("highp vec4","uSegmentDefaultColor"),a+=`  return uSegmentDefaultColor;
`):(this.segmentColorShaderManager.defineShader(e),a+=`  return vec4(segmentColorHash(value), 0.0);
`),a+=`
}
`,e.addFragmentCode(a),i+=`
  vec4 rgba = getMappedIdColor(valueForColor);
  if (rgba.a > 0.0) {
    alpha = rgba.a;
  }
  emit(vec4(mix(vec3(1.0,1.0,1.0), vec3(rgba), saturation), alpha));
`,e.setFragmentMain(i)}initializeShader(e,t,r){let{gl:i}=this,{displayState:a,segmentationGroupState:o}=this,{segmentSelectionState:l}=this.displayState,{segmentDefaultColor:{value:c},segmentColorHash:{value:d},highlightColor:{value:p},tempSegmentDefaultColor2d:{value:m}}=this.displayState,g=qS(o),v=this.displayState.ignoreNullVisibleSet.value,b=0,x=0,C=0;if(l.hasSelectedSegment&&a.hoverHighlight.value){let I=a.baseSegmentHighlighting.value?l.baseSelectedSegment:l.selectedSegment;b=I.low,x=I.high,C|=MR}if(i.uniform1f(t.uniform("uSelectedAlpha"),a.selectedAlpha.value),i.uniform1f(t.uniform("uSaturation"),a.saturation.value),i.uniform1f(t.uniform("uNotSelectedAlpha"),a.notSelectedAlpha.value),i.uniform2ui(t.uniform("uSelectedSegment"),b,x),g.hashTable.size===0&&v&&(C|=RR),i.uniform1ui(t.uniform("uFlags"),C),this.hashTableManager.enable(i,t,o.useTemporaryVisibleSegments.value?this.gpuTemporaryHashTable:this.gpuHashTable),r.hasEquivalences){let I=o.useTemporarySegmentEquivalences.value;(I?this.temporaryEquivalencesHashMap:this.equivalencesHashMap).update(),this.equivalencesShaderManager.enable(i,t,I?this.gpuTemporaryEquivalencesHashTable:this.gpuEquivalencesHashTable)}let T=m||c;if(T){let[I,P,M,D]=T;i.uniform4f(t.uniform("uSegmentDefaultColor"),I,P,M,D===void 0?0:D)}else this.segmentColorShaderManager.enable(i,t,d);if(r.hasSegmentStatedColors){let I=a.useTempSegmentStatedColors2d.value?a.tempSegmentStatedColors2d.value:a.segmentStatedColors.value,{gpuSegmentStatedColorHashTable:P}=this;(P===void 0||P.hashTable!==I.hashTable)&&(P==null||P.dispose(),this.gpuSegmentStatedColorHashTable=P=vl.get(i,I.hashTable)),this.segmentStatedColorShaderManager.enable(i,t,P)}p!==void 0&&i.uniform4fv(t.uniform("uHighlightColor"),p)}endSlice(e,t,r){let{gl:i}=this;this.hashTableManager.disable(i,t),r.hasEquivalences&&this.equivalencesShaderManager.disable(i,t),r.hasSegmentStatedColors&&this.segmentStatedColorShaderManager.disable(i,t),super.endSlice(e,t,r)}};function Nl(n=.5){return new Le(n,nh)}var Bl=class extends j{constructor(e,t){super();this.register=e;this.changed=new re;this.disposerMap=new Map;if(t===void 0)this.map=new Map;else{let r=this.map=new Map(t),{disposerMap:i}=this;for(let[a,o]of r){let l=new j;i.set(a,l),e(l,o,a)}}}get value(){return this.map}set(e,t){let{map:r,disposerMap:i}=this,a=i.get(e);return a!==void 0&&a.dispose(),a=new j,i.set(e,a),r.set(e,t),this.register(a,t,e),this.changed.dispatch(),this}delete(e){let{map:t,disposerMap:r}=this,i=r.get(e);return i!==void 0?(i.dispose(),r.delete(e),t.delete(e),this.changed.dispatch(),!0):!1}get(e){return this.map.get(e)}has(e){return this.map.has(e)}get size(){return this.map.size}[Symbol.iterator](){return this.map[Symbol.iterator]()}clear(){let{map:e,disposerMap:t}=this;if(e.size>0){for(let r of t.values())r.dispose();e.clear(),t.clear(),this.changed.dispatch()}}values(){return this.map.values()}keys(){return this.map.keys()}disposed(){let{map:e,disposerMap:t}=this;for(let r of t.values())r.dispose();e.clear(),t.clear(),super.disposed()}};var _R=class extends Ee{},VR=class extends Bl{constructor(){super((e,{showMatches:t,segmentationState:r})=>{e.registerDisposer(t.changed.add(this.changed.dispatch)),e.registerDisposer(r.changed.add(this.changed.dispatch)),e.registerDisposer(Dn((i,a)=>{if(a==null)return;let{segmentationGroupState:o}=a;i.registerDisposer(o.changed.add(this.changed.dispatch)),i.registerDisposer(Dn((l,c)=>{let{visibleSegments:d}=c,p=d.size===0;l.registerDisposer(d.changed.add(()=>{let m=d.size===0;m!==p&&(p=m,this.changed.dispatch())}))},o))},r))})}get(e){let t=super.get(e);return t===void 0&&(t={segmentationState:new Ee(void 0),showMatches:new qe(!1)},super.set(e,t)),t}},OR=`
void main() {
  setColor(defaultColor());
}
`,Mp=class extends j{constructor(){super(...arguments);this.annotationProperties=new Ee(void 0);this.shader=Yo(OR);this.shaderControls=new co(this.shader,mn(e=>{let t=new Map;if(e===void 0)return null;for(let r of e){let i=Sd[r.type];i!==void 0&&t.set(r.identifier,i)}return{properties:t}},this.annotationProperties));this.fallbackShaderControls=new Ee(Qo(lo(OR)));this.shaderError=Sa();this.color=new Go(K.fromValues(1,1,0));this.relationshipStates=this.registerDisposer(new VR);this.ignoreNullSegmentFilter=new qe(!0);this.displayUnfiltered=mn((e,t)=>{for(let r of e.values())if(r.showMatches.value){if(!t)return!1;let i=r.segmentationState.value;if(i!=null&&i.segmentationGroupState.value.visibleSegments.size>0)return!1}return!0},this.relationshipStates,this.ignoreNullSegmentFilter);this.hoverState=new _R(void 0)}},ys=class extends j{constructor(e){super();let{transform:t,localPosition:r,source:i,role:a=In.ANNOTATION}=e;this.transform=t,this.localPosition=r,this.source=this.registerDisposer(i),this.role=a,this.displayState=e.displayState,this.chunkTransform=this.registerDisposer(mn(o=>Il(()=>Qs(yp(o))),this.transform)),this.dataSource=e.dataSource,this.subsourceId=e.subsourceId,this.subsourceIndex=e.subsourceIndex,this.subsubsourceId=e.subsubsourceId}get sourceIndex(){let{dataSource:e}=this;return e.layer.dataSources.indexOf(e)}};var Rp=12,mC=8,Hj=6,NR=`
vec3 getBoxFaceVertexPosition(int vertexIndex) {
  const vec3 vertexPositions[] = vec3[](
  // Front face
  vec3(0.0, 0.0,  1.0), // 0
  vec3(1.0, 0.0,  1.0), // 1
  vec3(1.0,  1.0,  1.0), // 2
  vec3(0.0,  1.0,  1.0), // 3

  // Back face
  vec3(0.0, 0.0, 0.0), // 4
  vec3(0.0,  1.0, 0.0), // 5
  vec3(1.0,  1.0, 0.0), // 6
  vec3(1.0, 0.0, 0.0), // 7

  // Top face
  vec3(0.0,  1.0, 0.0), // 8
  vec3(0.0,  1.0,  1.0), // 9
  vec3(1.0,  1.0,  1.0), // 10
  vec3(1.0,  1.0, 0.0), // 11

  // Bottom face
  vec3(0.0, 0.0, 0.0), // 12
  vec3( 1.0, 0.0, 0.0), // 13
  vec3( 1.0, 0.0,  1.0), // 14
  vec3(0.0, 0.0,  1.0), // 15

  // Right face
  vec3( 1.0, 0.0, 0.0), // 16
  vec3( 1.0,  1.0, 0.0), // 17
  vec3( 1.0,  1.0,  1.0), // 18
  vec3( 1.0, 0.0,  1.0), // 19

  // Left face
  vec3(0.0, 0.0, 0.0), // 20
  vec3(0.0, 0.0,  1.0), // 21
  vec3(0.0,  1.0,  1.0), // 22
  vec3(0.0,  1.0, 0.0) // 23
  );
  const int indices[] = int[](
    0,  1,  2,      0,  2,  3,    // front
    4,  5,  6,      4,  6,  7,    // back
    8,  9,  10,     8,  10, 11,   // top
    12, 13, 14,     12, 14, 15,   // bottom
    16, 17, 18,     16, 18, 19,   // right
    20, 21, 22,     20, 22, 23   // left
  );
  return vertexPositions[indices[vertexIndex]];
}
`;function BR(n,e,t){n.drawArraysInstanced(WebGL2RenderingContext.TRIANGLES,0,6*Hj*e,t)}var UR=0,Eg=UR+1,$n=Eg+mC,gC=$n+Rp,$j=gC+6,jj=Float32Array.from([0,0,0,0,0,1,$n+0,1,0,0,1,0,1,$n+1,0,1,0,0,1,1,$n+2,1,1,0,1,1,1,$n+3,0,0,0,0,1,0,$n+4,0,0,1,0,1,1,$n+5,1,0,0,1,1,0,$n+6,1,0,1,1,1,1,$n+7,0,0,0,1,0,0,$n+8,0,0,1,1,0,1,$n+9,0,1,0,1,1,0,$n+10,0,1,1,1,1,1,$n+11]),FR=ae.create(),vs=new Float32Array(6),yC=class extends uo{constructor(){super(...arguments);this.vertexIdHelper=this.registerDisposer(zn.get(this.gl))}defineShader(e){Lr(e);let{rank:t}=this;Ko(e,"float",WebGL2RenderingContext.FLOAT,!1,"Bounds",t,2),e.addUniform("vec3","uModelSpaceBoundOffsets",2)}enable(e,t,r){ae.invert(FR,t.modelViewProjectionMatrix),sE(FR,vs);let{numChunkDisplayDims:i}=t.chunkDisplayTransform;for(let a=0;a<i;++a)vs[a]=0,vs[a+3]=0;for(let a=i;a<3;++a){let o=Math.abs(vs[a+3]-vs[a]);vs[a]-=o,vs[a+3]+=o}super.enable(e,t,a=>{let o=a.vertexShaderInputBinders.Bounds;o.enable(1);let{gl:l}=this;l.uniform3fv(a.uniform("uModelSpaceBoundOffsets"),vs),l.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),o.bind(this.geometryDataStride,t.bufferOffset);let{vertexIdHelper:c}=this;c.enable(),r(a),c.disable(),o.disable()})}};function GR(n){n.addVertexCode(`
void setBoundingBoxBorderWidth(float width) {}
void setBoundingBoxBorderColor(vec4 color) {}
`)}function WR(n){n.addVertexCode(`
void setBoundingBoxFillColor(vec4 color) {}
`)}function vC(n){WR(n),n.addVertexCode(`
float ng_lineWidth;
void setBoundingBoxBorderWidth(float size) {
  ng_lineWidth = size;
}
void setBoundingBoxBorderColor(vec4 color) {
  vColor = color;
}
`)}function Jj(n){GR(n),n.addVertexCode(`
void setBoundingBoxFillColor(vec4 color) {
  vColor = color;
}
`)}var zR=class extends yC{constructor(){super(...arguments);this.edgeBoxCornerOffsetsBuffer=this.registerDisposer(Bt.fromData(this.gl,rd(jj,7,1,bi)));this.edgeShaderGetter=this.getDependentShader("annotation/boundingBox/projection/border",e=>{let{rank:t}=this;this.defineShader(e),rr(e),e.addAttribute("highp vec3","aBoxCornerOffset1"),e.addAttribute("highp vec4","aBoxCornerOffset2"),e.addVarying("highp float","vClipCoefficient"),vC(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
vec3 endpointA = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset1);
vec3 endpointB = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset2.xyz);
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
ng_lineWidth = 1.0;
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(endpointA, 1.0),
         uModelViewProjection * vec4(endpointB, 1.0),
         ng_lineWidth);
${this.setPartIndex(e,"uint(aBoxCornerOffset2.w)")};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, getLineAlpha() * vClipCoefficient));
`)});this.boxCornerOffsetsBuffer=this.registerDisposer(Bt.fromData(this.gl,rd(Lg,3,1,Sm)));this.cornerShaderGetter=this.getDependentShader("annotation/boundingBox/projection/corner",e=>{let{rank:t}=this;this.defineShader(e),ds(e,this.targetIsSliceView),e.addAttribute("highp vec3","aBoxCornerOffset"),e.addVarying("highp float","vClipCoefficient"),vC(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
vClipCoefficient = getMaxEndpointSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
vec3 vertexPosition = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset);
emitCircle(uModelViewProjection * vec4(vertexPosition, 1.0), ng_lineWidth, 0.0);
uint cornerIndex = uint(aBoxCornerOffset.x + aBoxCornerOffset.y * 2.0 + aBoxCornerOffset.z * 4.0);
uint cornerPickOffset = ${Eg}u + cornerIndex;
${this.setPartIndex(e,"cornerPickOffset")};
`),e.setFragmentMain(`
vec4 borderColor = vec4(0.0, 0.0, 0.0, 1.0);
vec4 color = getCircleColor(vColor, borderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)})}drawEdges(e){let{gl:t}=this;this.enable(this.edgeShaderGetter,e,r=>{let i=r.attribute("aBoxCornerOffset1"),a=r.attribute("aBoxCornerOffset2");this.edgeBoxCornerOffsetsBuffer.bindToVertexAttrib(i,3,WebGL2RenderingContext.FLOAT,!1,4*7,0),this.edgeBoxCornerOffsetsBuffer.bindToVertexAttrib(a,4,WebGL2RenderingContext.FLOAT,!1,4*7,4*3),ar(r,e.renderContext.projectionParameters,1),ir(t,Rp,e.count),t.disableVertexAttribArray(i),t.disableVertexAttribArray(a)})}drawCorners(e){let{gl:t}=this;this.enable(this.cornerShaderGetter,e,r=>{let i=r.attribute("aBoxCornerOffset");this.boxCornerOffsetsBuffer.bindToVertexAttrib(i,3,WebGL2RenderingContext.FLOAT,!1),ps(r,e.renderContext.projectionParameters,{featherWidthInPixels:0}),fs(r.gl,mC,e.count),t.disableVertexAttribArray(i)})}draw(e){this.drawEdges(e),this.drawCorners(e)}},HR=class extends yC{constructor(){super(...arguments);this.faceShaderGetter=this.getDependentShader("annotation/boundingBox/crossSection/face",e=>{let{rank:t}=this;super.defineShader(e),Ol(e),rr(e),e.addVarying("highp float","vClipCoefficient"),vC(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
for (int i = 0; i < ${t}; ++i) {
  float a = modelPositionA[i];
  float b = modelPositionB[i];
  modelPositionA[i] = min(a, b);
  modelPositionB[i] = max(a, b);
}
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
int vertexIndex1 = gl_VertexID / ${bi};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex2);
ng_lineWidth = 1.0;
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(vertexPosition1, 1.0),
         uModelViewProjection * vec4(vertexPosition2, 1.0),
         ng_lineWidth);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() * vClipCoefficient));
`)});this.fillShaderGetter=this.getDependentShader("annotation/boundingBox/crossSection/fill",e=>{let{rank:t}=this;super.defineShader(e),Ol(e),e.addVarying("highp float","vClipCoefficient"),Jj(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
for (int i = 0; i < ${t}; ++i) {
  float a = modelPositionA[i];
  float b = modelPositionB[i];
  modelPositionA[i] = min(a, b);
  modelPositionB[i] = max(a, b);
}
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
int vertexIndex = gl_VertexID;
vec3 vertexPosition = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex);
gl_Position = uModelViewProjection * vec4(vertexPosition, 1);
${this.invokeUserMain}
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, vColor.a * vClipCoefficient));
`)})}enableForBoundingBox(e,t,r){super.enable(e,t,i=>{let a=t.renderContext.sliceView.projectionParameters.value;au(i,a.viewportNormalInGlobalCoordinates,a.centerDataPosition,t.renderSubspaceModelMatrix,t.renderSubspaceInvModelMatrix),r(i)})}draw(e){this.shaderControlState.parseResult.value.code.match(/\bsetBoundingBoxFillColor\b/)&&this.enableForBoundingBox(this.fillShaderGetter,e,()=>{MD(this.gl,WebGL2RenderingContext.TRIANGLE_FAN,0,6,e.count)}),this.enableForBoundingBox(this.faceShaderGetter,e,t=>{ar(t,e.renderContext.projectionParameters,1),ir(t.gl,6,e.count)})}};function qj(n,e){let t=n.length;for(let r=0;r<t;++r){let i=e[r],a=e[r+t],o=n[r];n[r]=Math.abs(i-o)<Math.abs(a-o)?i:a}}Zo(Oe.AXIS_ALIGNED_BOUNDING_BOX,{sliceViewRenderHelper:HR,perspectiveViewRenderHelper:zR,defineShaderNoOpSetters(n){WR(n),GR(n)},pickIdsPerInstance:$j,snapPosition(n,e,t,r){let i=n.length,a=new Float32Array(e,t,i*2);r>=Eg&&r<$n?qj(n,a):r>=$n&&r<gC},getRepresentativePoint(n,e,t){t===UR||t>=Eg&&t<$n||t>=$n&&t<gC,n.set(e.pointA)},updateViaRepresentativePoint(n,e,t){let r=e.length,{pointA:i,pointB:a}=n,o=new Float32Array(r),l=new Float32Array(r);for(let c=0;c<r;++c){let d=o[c]=e[c];l[c]=a[c]+(d-i[c])}return{...n,pointA:o,pointB:l}}});var ou=0,SC=ou+1,Yj=SC+2;function $R(n){n.addVertexCode(`
void setEndpointMarkerSize(float startSize, float endSize) {}
void setEndpointMarkerBorderWidth(float startSize, float endSize) {}
void setEndpointMarkerColor(vec4 startColor, vec4 endColor) {}
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {}
`)}function jR(n){n.addVertexCode(`
void setLineWidth(float width) {}
void setLineColor(vec4 startColor, vec4 endColor) {}
`)}var bC=class extends uo{constructor(){super(...arguments);this.vertexIdHelper=this.registerDisposer(zn.get(this.gl));this.edgeShaderGetter=this.getDependentShader("annotation/line/edge",e=>{let{rank:t}=this;this.defineShader(e),rr(e),e.addVarying(`highp float[${t}]`,"vModelPosition"),e.addVertexCode(`
float ng_LineWidth;
`),$R(e),e.addVertexCode(`
void setLineWidth(float width) {
  ng_LineWidth = width;
}
void setLineColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, getLineEndpointCoefficient());
}
`),e.setVertexMain(`
float modelPositionA[${t}] = getVertexPosition0();
float modelPositionB[${t}] = getVertexPosition1();
for (int i = 0; i < ${t}; ++i) {
  vModelPosition[i] = mix(modelPositionA[i], modelPositionB[i], getLineEndpointCoefficient());
}
ng_LineWidth = 1.0;
vColor = vec4(0.0, 0.0, 0.0, 0.0);
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionA), 1.0),
         uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionB), 1.0),
         ng_LineWidth);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
float clipCoefficient = getSubspaceClipCoefficient(vModelPosition);
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() *
                                ${this.getCrossSectionFadeFactor()} *
                                clipCoefficient));
`)});this.endpointShaderGetter=this.getDependentShader("annotation/line/endpoint",e=>{let{rank:t}=this;this.defineShader(e),ds(e,this.targetIsSliceView),e.addVarying("highp float","vClipCoefficient"),e.addVarying("highp vec4","vBorderColor"),jR(e),e.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
int getEndpointIndex() {
  return gl_VertexID / ${Sm};
}
void setEndpointMarkerSize(float startSize, float endSize) {
  ng_markerDiameter = mix(startSize, endSize, float(getEndpointIndex()));
}
void setEndpointMarkerBorderWidth(float startSize, float endSize) {
  ng_markerBorderWidth = mix(startSize, endSize, float(getEndpointIndex()));
}
void setEndpointMarkerColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, float(getEndpointIndex()));
}
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {
  vBorderColor = mix(startColor, endColor, float(getEndpointIndex()));
}
`),e.setVertexMain(`
float modelPosition[${t}] = getVertexPosition0();
float modelPositionB[${t}] = getVertexPosition1();
for (int i = 0; i < ${t}; ++i) {
  modelPosition[i] = mix(modelPosition[i], modelPositionB[i], float(getEndpointIndex()));
}
vClipCoefficient = getSubspaceClipCoefficient(modelPosition);
vColor = vec4(0.0, 0.0, 0.0, 0.0);
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
${this.invokeUserMain}
emitCircle(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
${this.setPartIndex(e,"uint(getEndpointIndex()) + 1u")};
`),e.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)})}defineShader(e){Lr(e);let{rank:t}=this;Ko(e,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",t,2)}enable(e,t,r){super.enable(e,t,i=>{let a=i.vertexShaderInputBinders.VertexPosition;a.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),a.bind(this.geometryDataStride,t.bufferOffset);let{vertexIdHelper:o}=this;o.enable(),r(i),o.disable(),a.disable()})}drawEdges(e){this.enable(this.edgeShaderGetter,e,t=>{ar(t,e.renderContext.projectionParameters,1),ir(t.gl,1,e.count)})}drawEndpoints(e){this.enable(this.endpointShaderGetter,e,t=>{ps(t,e.renderContext.projectionParameters,{featherWidthInPixels:.5}),fs(t.gl,2,e.count)})}draw(e){this.drawEdges(e),this.drawEndpoints(e)}};function Kj(n,e){let t=n.length;rE(n,e.subarray(0,t),e.subarray(t),n)}function Xj(n,e,t){let r=n.length,i=r*t;for(let a=0;a<r;++a)n[a]=e[i+a]}Zo(Oe.LINE,{sliceViewRenderHelper:bC,perspectiveViewRenderHelper:bC,defineShaderNoOpSetters(n){$R(n),jR(n)},pickIdsPerInstance:Yj,snapPosition(n,e,t,r){let i=n.length,a=new Float32Array(e,t,i*2);r===ou?Kj(n,a):Xj(n,a,r-SC)},getRepresentativePoint(n,e,t){n.set(t===ou||t===SC?e.pointA:e.pointB)},updateViaRepresentativePoint(n,e,t){let r={...n},i=e.length;switch(t){case ou:{let{pointA:a,pointB:o}=n,l=new Float32Array(i),c=new Float32Array(i);for(let d=0;d<i;++d){let p=l[d]=e[d];c[d]=o[d]+(p-a[d])}return{...n,pointA:l,pointB:c}}case ou+1:return{...n,pointA:new Float32Array(e)};case ou+2:return{...n,pointB:new Float32Array(e)}}return r}});var xC=class extends uo{constructor(){super(...arguments);this.shaderGetter3d=this.getDependentShader("annotation/point:3d",e=>{Lr(e),ds(e,this.targetIsSliceView),this.defineShaderCommon(e),e.addVertexMain(`
emitCircle(uModelViewProjection *
           vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
`),e.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
emitAnnotation(color);
`)});this.makeShaderGetter2d=e=>this.getDependentShader(`annotation/point:2d:${e}`,t=>{Lr(t),rr(t,!0),this.defineShaderCommon(t),t.addVertexMain(`
vec3 subspacePositionA = projectModelVectorToSubspace(modelPosition);
vec3 subspacePositionB = subspacePositionA;
vec4 baseProjection = uModelViewProjection * vec4(subspacePositionA, 1.0);
vec4 zCoeffs = uModelViewProjection[${e}];
float minZ = 1e30;
float maxZ = -1e30;
for (int i = 0; i < 3; ++i) {
  // Want: baseProjection[i] + z * zCoeffs[i] = -2.0 * (baseProjection.w - z * zCoeffs.w)
  //  i.e. baseProjection[i] + 2.0 * baseProjection.w < -z * (2.0 * zCoeffs.w + zCoeffs[i])
  //  i.e. baseProjection[i] + 2.0 * baseProjection.w < -z * k1
  float k1 = 2.0 * zCoeffs.w + zCoeffs[i];
  float q1 = -(baseProjection[i] + 2.0 * baseProjection.w) / k1;
  if (k1 != 0.0) {
    minZ = min(minZ, q1);
    maxZ = max(maxZ, q1);
  }
  // Want: baseProjection[i] + z * zCoeffs[i] = 2.0 * (baseProjection.w + z * zCoeffs.w)
  //  i.e. baseProjection[i] - 2.0 * baseProjection.w > z * (2.0 * zCoeffs.w - zCoeffs[i])
  //  i.e. baseProjection[i] - 2.0 * baseProjection.w > z * k2
  float k2 = 2.0 * zCoeffs.w - zCoeffs[i];
  float q2 = (baseProjection[i] - 2.0 * baseProjection.w) / k2;
  if (k2 != 0.0) {
    minZ = min(minZ, q2);
    maxZ = max(maxZ, q2);
  }
}
if (minZ > maxZ) minZ = maxZ = 0.0;
subspacePositionA[${e}] = minZ;
subspacePositionB[${e}] = maxZ;
emitLine(uModelViewProjection, subspacePositionA, subspacePositionB, ng_markerDiameter, ng_markerBorderWidth);
`),t.setFragmentMain(`
vec4 color = getRoundedLineColor(vColor, vBorderColor);
emitAnnotation(vec4(color.rgb, color.a * ${this.getCrossSectionFadeFactor()}));
`)});this.shaderGetter2d=this.makeShaderGetter2d(2);this.shaderGetter1d=this.makeShaderGetter2d(1);this.vertexIdHelper=this.registerDisposer(zn.get(this.gl))}defineShaderCommon(e){let{rank:t}=this;Ko(e,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",t),e.addVarying("highp vec4","vBorderColor"),e.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
void setPointMarkerSize(float size) {
  ng_markerDiameter = size;
}
void setPointMarkerBorderWidth(float size) {
  ng_markerBorderWidth = size;
}
void setPointMarkerColor(vec4 color) {
  vColor = color;
}
void setPointMarkerBorderColor(vec4 color) {
  vBorderColor = color;
}
`),e.addVertexMain(`
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
float modelPosition[${t}] = getVertexPosition0();
float clipCoefficient = getSubspaceClipCoefficient(modelPosition);
if (clipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
${this.invokeUserMain}
vColor.a *= clipCoefficient;
vBorderColor.a *= clipCoefficient;
${this.setPartIndex(e)};
`)}enable(e,t,r){super.enable(e,t,i=>{let a=i.vertexShaderInputBinders.VertexPosition;a.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),a.bind(this.geometryDataStride,t.bufferOffset);let{vertexIdHelper:o}=this;o.enable(),r(i),o.disable(),a.disable()})}draw(e){let{numChunkDisplayDims:t}=e.chunkDisplayTransform;switch(t){case 3:this.enable(this.shaderGetter3d,e,r=>{ps(r,e.renderContext.projectionParameters,{featherWidthInPixels:1}),fs(r.gl,1,e.count)});break;case 2:case 1:this.enable(t===2?this.shaderGetter2d:this.shaderGetter1d,e,r=>{ar(r,e.renderContext.projectionParameters,1),ir(r.gl,1,e.count)});break}}};Zo(Oe.POINT,{sliceViewRenderHelper:xC,perspectiveViewRenderHelper:xC,defineShaderNoOpSetters(n){n.addVertexCode(`
void setPointMarkerSize(float size) {}
void setPointMarkerBorderWidth(float size) {}
void setPointMarkerColor(vec4 color) {}
void setPointMarkerBorderColor(vec4 color) {}
`)},pickIdsPerInstance:1,snapPosition(n,e,t){n.set(new Float32Array(e,t,n.length))},getRepresentativePoint(n,e){n.set(e.point)},updateViaRepresentativePoint(n,e){return{...n,point:new Float32Array(e)}}});var JR=`
struct EllipseQuadraticForm {
  highp float A;  // x*x coefficient
  highp float B;  // x*y coefficient
  highp float C;  // y*y coefficient
  highp float D;  // x coefficient
  highp float E;  // y coefficient
  highp float F;  // 1 coefficient
};
`,qR=[JR,`
EllipseQuadraticForm computeCrossSectionEllipse(mat3 A, vec3 c) {
  EllipseQuadraticForm p;
  p.A = A[0][0];
  p.B = A[0][1] + A[1][0];
  p.C = A[1][1];
  p.D = -2.0 * c[0] * A[0][0] - c[1] * (A[0][1] + A[1][0]) +
        c[2] * (A[0][2] + A[2][0]);
  p.E = -c[0] * (A[0][1] + A[1][0]) - 2.0 * c[1] * A[1][1] +
        c[2] * (A[1][2] + A[2][1]);
  p.F = c[0] * c[0] * A[0][0] + c[0] * c[1] * (A[0][1] + A[1][0]) -
        c[0] * c[2] * (A[0][2] + A[2][0]) + c[1] * c[1] * A[1][1] -
        c[1] * c[2] * (A[1][2] + A[2][1]) + c[2] * c[2] * A[2][2] - 1.0;
  return p;
}
`];function YR(n,e){let t=[[n[0],n[1],n[2]],[n[3],n[4],n[5]],[n[6],n[7],n[8]]];return{A:t[0][0],B:t[0][1]+t[1][0],C:t[1][1],D:-2*e[0]*t[0][0]-e[1]*(t[0][1]+t[1][0])+e[2]*(t[0][2]+t[2][0]),E:-e[0]*(t[0][1]+t[1][0])-2*e[1]*t[1][1]+e[2]*(t[1][2]+t[2][1]),F:e[0]*e[0]*t[0][0]+e[0]*e[1]*(t[0][1]+t[1][0])-e[0]*e[2]*(t[0][2]+t[2][0])+e[1]*e[1]*t[1][1]-e[1]*e[2]*(t[1][2]+t[2][1])+e[2]*e[2]*t[2][2]-1}}var Qj=`
struct CenterOrientEllipse {
  vec2 k;   // center
  vec2 u1;  // minor axis direction
  vec2 u2;  // major axis direction
  float a;  // semimajor axis
  float b;  // semiminor axis
  bool valid; // indicates if the ellipse is valid
};
`,KR=[JR,Qj,`
CenterOrientEllipse computeCenterOrientEllipse(EllipseQuadraticForm p) {
  CenterOrientEllipse r;
  float a11 = p.A;
  float a12 = p.B / 2.0;
  float a22 = p.C;
  float b1 = p.D;
  float b2 = p.E;
  float c = p.F;
  float kdenom = 2.0 * (a12 * a12 - a11 * a22);
  float k1 = r.k.x = (a22 * b1 - a12 * b2) / kdenom;
  float k2 = r.k.y = (a11 * b2 - a12 * b1) / kdenom;
  float mu = 1.0 / (a11 * k1 * k1 + 2.0 * a12 * k1 * k2 + a22 * k2 * k2 - c);
  float m11 = mu * a11;
  float m12 = mu * a12;
  float m22 = mu * a22;
  float lambdaTerm1 = m11 + m22;
  float lambdaTerm2 = sqrt((m11 - m22) * (m11 - m22) + 4.0 * m12 * m12);
  float lambda1 = ((lambdaTerm1 + lambdaTerm2) / 2.0);
  float lambda2 = ((lambdaTerm1 - lambdaTerm2) / 2.0);
  r.a = 1.0 / sqrt(lambda1);
  r.b = 1.0 / sqrt(lambda2);
  r.valid = lambda1 > 0.0 && lambda2 > 0.0;
  if (abs(m11 - m22) < 1e-6 && abs(m12) < 1e-6) {
    r.u1 = vec2(1.0, 0.0);
  } else if (m11 >= m22) {
    r.u1 = normalize(vec2(lambda1 - m22, m12));
  } else {
    r.u1 = normalize(vec2(m12, lambda1 - m11));
  }
  r.u2 = vec2(-r.u1.y, r.u1.x);
  return r;
}
`];function XR(n){let e=n.A,t=n.B/2,r=n.C,i=n.D,a=n.E,o=n.F,l=2*(t*t-e*r),c=(r*i-t*a)/l,d=(e*a-t*i)/l,p=1/(e*c*c+2*t*c*d+r*d*d-o),m=p*e,g=p*t,v=p*r,b=m+v,x=Math.sqrt((m-v)*(m-v)+4*g*g),C=(b+x)/2,T=(b-x)/2,I=1/Math.sqrt(C),P=1/Math.sqrt(T),M;m>=v?M=gr.fromValues(C-v,g):M=gr.fromValues(g,C-m),gr.normalize(M,M);let D=gr.fromValues(-M[1],M[0]);return{k:gr.fromValues(c,d),u1:M,u2:D,a:I,b:P,lambda1:C,lambda2:T,m11:m,m12:g,m22:v,valid:C>0&&T>0}}function Zj(n,e){let t=new Float32Array((n+1)*(e+1)*3),r=0;for(let i=0;i<=n;++i){let a=i*Math.PI/n,o=Math.sin(a),l=Math.cos(a);for(let c=0;c<=e;++c){let d=c*2*Math.PI/e,p=Math.sin(d),m=Math.cos(d);t[r++]=m*o,t[r++]=l,t[r++]=p*o}}return t}function e5(n,e){let t=new Uint16Array(n*e*6),r=0;for(let i=0;i<n;i++)for(let a=0;a<e;a++){let o=i*(e+1)+a,l=o+e+1;t[r++]=o,t[r++]=l,t[r++]=o+1,t[r++]=l,t[r++]=l+1,t[r++]=o+1}return t}var CC=class extends j{constructor(e,t,r){super();this.vertexBuffer=this.registerDisposer(oo(e,WebGL2RenderingContext.ARRAY_BUFFER,Zj,t,r)).value,this.indexBuffer=this.registerDisposer(oo(e,WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER,e5,t,r)).value,this.numIndices=t*r*6}defineShader(e){e.addAttribute("highp vec3","aSphereVertex"),e.addVarying("highp float","vLightingFactor"),e.addVertexCode(`
void emitSphere(mat4 projectionMatrix, mat4 normalTransformMatrix, vec3 centerPosition, vec3 radii, vec4 lightDirection) {
  vec3 vertexPosition = aSphereVertex * radii + centerPosition;
  gl_Position = projectionMatrix * vec4(vertexPosition, 1.0);
  vec3 normal = normalize((normalTransformMatrix * vec4(aSphereVertex / max(radii, 1e-6), 0.0)).xyz);
  vLightingFactor = abs(dot(normal, uLightDirection.xyz)) + uLightDirection.w;
}
`)}draw(e,t){let r=e.attribute("aSphereVertex");this.vertexBuffer.bindToVertexAttrib(r,3,WebGL2RenderingContext.FLOAT,!1),this.indexBuffer.bind(),e.gl.drawElementsInstanced(WebGL2RenderingContext.TRIANGLES,this.numIndices,WebGL2RenderingContext.UNSIGNED_SHORT,0,t),e.gl.disableVertexAttribArray(r)}};var QR=ae.create(),t5=!1,wC=class extends uo{defineShader(e){let{rank:t}=this;Ko(e,"float",WebGL2RenderingContext.FLOAT,!1,"CenterAndRadii",t,2),e.addVertexCode(`
struct SubspaceParams {
  highp vec3 subspaceCenter;
  highp vec3 subspaceRadii;
  highp float clipCoefficient;
  bool cull;
};
SubspaceParams getSubspaceParams() {
  SubspaceParams params;
  highp float modelCenter[${t}] = getCenterAndRadii0();
  highp float modelRadii[${t}] = getCenterAndRadii1();
  float radiusAdjustment = 1.0;
  float clipCoefficient = 1.0;
  for (int i = 0; i < ${t}; ++i) {
    float r = modelRadii[i];
    float c = modelCenter[i];
    float x = uModelClipBounds[i];
    float clipRadius = uModelClipBounds[i + ${t}];
    if (r != 0.0 && clipRadius != 0.0) {
      float d = c - x;
      d = d * d;
      radiusAdjustment -= d / (r * r);
    }
    float e = abs(x - clamp(x, c - r, c + r)) * clipRadius;
    clipCoefficient *= max(0.0, 1.0 - e);
  }
  radiusAdjustment = sqrt(max(0.0, radiusAdjustment));
  params.subspaceCenter = projectModelVectorToSubspace(modelCenter);
  params.subspaceRadii = projectModelVectorToSubspace(modelRadii) * radiusAdjustment;
  params.clipCoefficient = clipCoefficient;
  params.cull = clipCoefficient == 0.0 || radiusAdjustment == 0.0;
  return params;
}
void setEllipsoidFillColor(vec4 color) {
  vColor = color;
}
`)}enable(e,t,r){super.enable(e,t,i=>{let a=i.vertexShaderInputBinders.CenterAndRadii;a.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),a.bind(this.geometryDataStride,t.bufferOffset),r(i),a.disable()})}},ZR=class extends wC{constructor(){super(...arguments);this.sphereRenderHelper=this.registerDisposer(new CC(this.gl,10,10));this.shaderGetter=this.getDependentShader("annotation/ellipsoid/projection",e=>{this.defineShader(e),this.sphereRenderHelper.defineShader(e),e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp mat4","uNormalTransform"),e.addVarying("highp float","vClipCoefficient"),e.setVertexMain(`
SubspaceParams params = getSubspaceParams();
if (params.cull) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vClipCoefficient = params.clipCoefficient;
${this.invokeUserMain}
emitSphere(uModelViewProjection, uNormalTransform, params.subspaceCenter, params.subspaceRadii, uLightDirection);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb * vLightingFactor, vColor.a * vClipCoefficient));
`)});this.tempLightVec=new Float32Array(4)}draw(e){this.enable(this.shaderGetter,e,t=>{let{gl:r}=t,i=this.tempLightVec,{lightDirection:a,ambientLighting:o,directionalLighting:l}=e.renderContext;K.scale(i,a,l),i[3]=o,r.uniform4fv(t.uniform("uLightDirection"),i),r.uniformMatrix4fv(t.uniform("uNormalTransform"),!1,ae.transpose(ae.create(),e.renderSubspaceInvModelMatrix)),this.sphereRenderHelper.draw(t,e.count)})}},e_=class extends wC{constructor(){super(...arguments);this.shaderGetter=this.getDependentShader("annotation/ellipsoid/crossSection",e=>{Lr(e),this.defineShader(e),e.addUniform("highp mat4","uViewportToObject"),e.addUniform("highp mat4","uObjectToViewport"),e.addUniform("highp mat4","uViewportToDevice"),e.addAttribute("highp vec2","aCornerOffset"),e.addVarying("highp vec2","vCircleCoord"),e.addVarying("highp float","vClipCoefficient"),e.addVertexCode(qR),e.addVertexCode(KR),e.addVertexCode(Jc),e.setVertexMain(`
SubspaceParams params = getSubspaceParams();
if (params.cull) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vClipCoefficient = params.clipCoefficient;
mat3 Aobject = mat3(0.0);
for (int i = 0; i < 3; ++i) {
  float r = max(params.subspaceRadii[i], 1e-3);
  Aobject[i][i] = 1.0 / (r * r);
}
mat3 RviewportToObject = mat3(uViewportToObject);
mat3 Aviewport = transpose(RviewportToObject) * Aobject * RviewportToObject;
vec3 cViewport = (uObjectToViewport * vec4(params.subspaceCenter, 1.0)).xyz;
EllipseQuadraticForm quadraticForm = computeCrossSectionEllipse(Aviewport, cViewport);
vec2 u1, u2;
float a, b;
CenterOrientEllipse centerOrient = computeCenterOrientEllipse(quadraticForm);
vec2 cornerOffset = getQuadVertexPosition(vec2(-1.0, -1.0), vec2(1.0, 1.0));
vec2 viewportCorner = centerOrient.k +
  centerOrient.u1 * cornerOffset.x * centerOrient.a +
  centerOrient.u2 * cornerOffset.y * centerOrient.b;
if (centerOrient.valid) {
  gl_Position = uViewportToDevice * vec4(viewportCorner, 0.0, 1.0);
} else {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
}
vCircleCoord = cornerOffset;
${this.invokeUserMain}
${this.setPartIndex(e)};
`),e.setFragmentMain(`
if (dot(vCircleCoord, vCircleCoord) > 1.0) {
  discard;
}
emitAnnotation(vec4(vColor.rgb, vColor.a * vClipCoefficient));
`)});this.vertexIdHelper=this.registerDisposer(zn.get(this.gl))}draw(e){this.enable(this.shaderGetter,e,t=>{let{gl:r}=t,i=e.renderContext.sliceView.projectionParameters.value,a=ae.multiply(QR,e.renderSubspaceInvModelMatrix,i.invViewMatrix);r.uniformMatrix4fv(t.uniform("uViewportToObject"),!1,a),r.uniformMatrix4fv(t.uniform("uViewportToDevice"),!1,i.projectionMat);let o=QR;ae.invert(o,a),r.uniformMatrix4fv(t.uniform("uObjectToViewport"),!1,o);let{vertexIdHelper:l}=this;if(l.enable(),qc(r,1,e.count),l.disable(),t5){let c=K.fromValues(3406.98779296875,3234.910400390625,4045),d=K.fromValues(10,10,10),p=Dt.create();p[0]=1/(d[0]*d[0]),p[4]=1/(d[1]*d[1]),p[8]=1/(d[2]*d[2]);let m=Dt.fromMat4(Dt.create(),a),g=Dt.multiply(Dt.create(),Dt.transpose(Dt.create(),m),p);Dt.multiply(g,g,m);let v=K.transformMat4(K.create(),c,o);console.log("Aviewport",g),console.log("cViewport",v);let b=YR(g,v),x=XR(b);console.log(b),console.log(x)}})}};Zo(Oe.ELLIPSOID,{sliceViewRenderHelper:e_,perspectiveViewRenderHelper:ZR,defineShaderNoOpSetters(n){n.addVertexCode(`
void setEllipsoidFillColor(vec4 color) {}
`)},pickIdsPerInstance:1,snapPosition:()=>{},getRepresentativePoint(n,e){n.set(e.center)},updateViaRepresentativePoint(n,e){return{...n,center:new Float32Array(e)}}});var t_=ae.create(),n_=K.create();function r_(n){n.addUniform("highp vec3","uTranslation"),n.addUniform("highp mat4","uProjectionMatrix"),n.addUniform("highp vec3","uChunkDataSize"),n.addUniform("highp vec3","uLowerClipBound"),n.addUniform("highp vec3","uUpperClipBound"),n.setFragmentMain(`
emit(vec4(1.0, 1.0, 1.0, getLineAlpha()), 0u);
`)}var i_={defineShader(n){r_(n),rr(n),n.addVertexCode(`
const vec3[24] boxCornerOffsets = vec3[](
  vec3(0, 0, 0), vec3(0, 0, 1),  // e1
  vec3(1, 0, 0), vec3(1, 0, 1),  // e2
  vec3(0, 1, 0), vec3(0, 1, 1),  // e3
  vec3(1, 1, 0), vec3(1, 1, 1),  // e4
  vec3(0, 0, 0), vec3(0, 1, 0),  // e5
  vec3(0, 0, 1), vec3(0, 1, 1),  // e6
  vec3(1, 0, 0), vec3(1, 1, 0),  // e7
  vec3(1, 0, 1), vec3(1, 1, 1),  // e8
  vec3(0, 0, 0), vec3(1, 0, 0),  // e9
  vec3(0, 0, 1), vec3(1, 0, 1),  // e10
  vec3(0, 1, 0), vec3(1, 1, 0),  // e11
  vec3(0, 1, 1), vec3(1, 1, 1)  // e12
);
`),n.setVertexMain(`
int edgeIndex = gl_VertexID / ${bi};
vec3 cornerA = max(uLowerClipBound, min(uUpperClipBound, uTranslation));
vec3 cornerB = max(uLowerClipBound, min(uUpperClipBound, uTranslation + uChunkDataSize));
vec3 vertexPosition1 = mix(cornerA, cornerB, boxCornerOffsets[edgeIndex * 2]);
vec3 vertexPosition2 = mix(cornerA, cornerB, boxCornerOffsets[edgeIndex * 2 + 1]);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`)},initialize(n,e){ar(n,e,1)},draw(n,e,t){let{gl:r}=n,i=t_,{chunkLayout:a}=e;ae.multiply(i,t.viewProjectionMat,a.transform),r.uniformMatrix4fv(n.uniform("uProjectionMatrix"),!1,i),r.uniform3fv(n.uniform("uChunkDataSize"),a.size),r.uniform3fv(n.uniform("uLowerClipBound"),e.lowerClipDisplayBound),r.uniform3fv(n.uniform("uUpperClipBound"),e.upperClipDisplayBound);let o=a.size,{curPositionInChunks:l,chunkDisplayDimensionIndices:c}=e,d=n_;for(let p=0;p<3;++p){let m=c[p];d[p]=(m===-1?0:l[m])*o[p]}r.uniform3fv(n.uniform("uTranslation"),d),ir(r,Rp,1)}},a_={defineShader(n){Ol(n),r_(n),rr(n),n.setVertexMain(`
int vertexIndex1 = gl_VertexID / ${bi};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex2);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`)},initialize(n,e){ar(n,e,1)},draw(n,e,t){let{gl:r}=n,i=t_,{chunkLayout:a}=e;ae.multiply(i,t.viewProjectionMat,a.transform),r.uniformMatrix4fv(n.uniform("uProjectionMatrix"),!1,i),r.uniform3fv(n.uniform("uChunkDataSize"),a.size),r.uniform3fv(n.uniform("uLowerClipBound"),e.lowerClipDisplayBound),r.uniform3fv(n.uniform("uUpperClipBound"),e.upperClipDisplayBound);let o=a.size,{curPositionInChunks:l,chunkDisplayDimensionIndices:c}=e,d=n_;for(let p=0;p<3;++p){let m=c[p];d[p]=(m===-1?0:l[m])*o[p]}r.uniform3fv(n.uniform("uTranslation"),d),au(n,t.viewportNormalInGlobalCoordinates,t.centerDataPosition,a.transform,a.invTransform),ir(r,6,1)}};var n5=ae.create();function r5(n){if(n!==void 0)return e=>{let{relatedSegments:t}=e;if(t===void 0)return!1;for(let r=0,i=t.length;r<i;++r){let a=n[r];if(a==null)continue;let{visibleSegments:o,segmentEquivalences:l}=a.segmentationGroupState.value;for(let c of t[r])if(o.has(l.get(c)))return!0}return!1}}function i5(n,e){let t=new Jv(n.annotationPropertySerializers);for(let r of n)(e===void 0||e(r))&&t.add(r);return t.serialize()}var Dg=class extends ba(ka){constructor(e,t,r,i){super(i);this.chunkManager=e;this.source=t;this.segmentationStates=r;this.initializeCounterpart(this.chunkManager.rpc,{chunkManager:this.chunkManager.rpcId,source:t.rpcId,segmentationStates:this.serializeDisplayState()});let a=()=>{let o={id:this.rpcId,segmentationStates:this.serializeDisplayState()};this.rpc.invoke(kD,o)};this.registerDisposer(r.changed.add(a))}serializeDisplayState(){let{value:e}=this.segmentationStates;if(e!==void 0)return e.map(t=>t==null?t:Ab(t.segmentationGroupState.value))}};Dg=kt([bn(LD)],Dg);var TC=class extends j{constructor(e,t){super();this.chunkManager=e;this.state=t;this.layerChunkProgressInfo=new po;this.numPickIds=0;this.generation=-1;this.redrawNeeded=new re;this.serializedAnnotations=void 0;this.handleChangeAffectingBuffer=()=>{this.generation=-1,this.redrawNeeded.dispatch()};this.segmentationStates=this.registerDisposer(At((e,t)=>{let{displayState:r,source:i}=this.state,{relationshipStates:a}=r;return r.displayUnfiltered.value?void 0:i.relationships.map(o=>{let l=a.get(o);return l.showMatches.value?l.segmentationState.value:void 0})},[this.state.displayState.relationshipStates,this.state.displayState.ignoreNullSegmentFilter],(e,t)=>e===void 0||t===void 0?e===t:xe(e,t)));this.registerDisposer(t),this.registerDisposer(this.source.changed.add(this.handleChangeAffectingBuffer)),this.registerDisposer(Dn((i,a)=>{if(this.handleChangeAffectingBuffer(),a!==void 0)for(let o of a)o!=null&&i.registerDisposer(Ka((l,c)=>{l.registerDisposer(c.visibleSegments.changed.add(()=>this.handleChangeAffectingBuffer())),l.registerDisposer(c.segmentEquivalences.changed.add(()=>this.handleChangeAffectingBuffer()))},o.segmentationGroupState))},this.segmentationStates)),this.source instanceof to||(this.sharedObject=this.registerDisposer(new Dg(e,this.source,this.segmentationStates,this.layerChunkProgressInfo)));let{displayState:r}=this.state;this.registerDisposer(r.color.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(r.shader.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(r.shaderControls.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.hoverState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.transform.changed.add(this.redrawNeeded.dispatch))}get source(){return this.state.source}get transform(){return this.state.transform}get hoverState(){return this.state.displayState.hoverState}get visibility(){let{sharedObject:e}=this;if(e!==void 0)return e.visibility}get gl(){return this.chunkManager.gl}updateBuffer(){let{source:e}=this;if(e instanceof to){let t=e.changed.count;if(this.generation!==t){let{buffer:r}=this;r===void 0&&(r=this.buffer=this.registerDisposer(new Bt(this.chunkManager.gl))),this.generation=t;let i=this.serializedAnnotations=i5(e,r5(this.segmentationStates.value));r.setData(this.serializedAnnotations.data),this.numPickIds=QS(i)}}}};function o_(n){let{chunkTransform:e}=n,{unpaddedRank:t}=e.modelTransform,r=new Float32Array(t*2),i=new Float32Array(t*3);i.fill(0),r.fill(1,t);let{numChunkDisplayDims:a,chunkDisplayDimensionIndices:o}=n;for(let l=0;l<a;++l){let c=o[l];r[t+c]=0,i[c*3+l]=1}return{modelClipBounds:r,renderSubspaceTransform:i}}function s_(n,e,t){t.clearMessages();let r=c=>{t.addMessage({severity:xr.error,message:c})};if(n.error!==void 0)return r(n.error);let i=Ph(n.modelTransform,e.displayDimensionIndices),a;try{a=Ih(n,i)}catch(c){return r(c.message)}let{modelClipBounds:o,renderSubspaceTransform:l}=o_(a);return{chunkTransform:n,chunkDisplayTransform:a,modelClipBounds:o,renderSubspaceTransform:l}}function LC(n,e){class t extends n{constructor(i,a){super();this.base=i;this.renderScaleHistogram=a;this.curRank=-1;this.renderHelpers=[];this.isAnnotation=!0;let o=i.visibility;o!==void 0&&this.registerDisposer(o.add(this.visibility)),this.registerDisposer(this.renderScaleHistogram.visibility.add(this.visibility)),this.registerDisposer(()=>{for(let l of this.renderHelpers)l.dispose()}),this.role=i.state.role,this.registerDisposer(i.redrawNeeded.add(this.redrawNeeded.dispatch)),this.handleRankChanged(),this.registerDisposer(this.base.state.displayState.shaderControls.histogramSpecifications.producerVisibility.add(this.visibility))}handleRankChanged(){let{rank:i}=this.base.source;if(i===this.curRank)return;this.curRank=i,this.tempChunkPosition=new Float32Array(i);let{renderHelpers:a,gl:o}=this;for(let d of a)d.dispose();let{properties:l}=this.base.source,{displayState:c}=this.base.state;for(let d of _i){let p=es(d),m=p[e],g=a[d]=new m(o,d,i,l,c.shaderControls,c.fallbackShaderControls,c.shaderError);g.pickIdsPerInstance=p.pickIdsPerInstance,g.targetIsSliceView=e==="sliceViewRenderHelper"}}attach(i){super.attach(i),this.handleRankChanged();let{chunkTransform:a}=this,o=i.view.displayDimensionRenderInfo.value;i.state={chunkTransform:a,displayDimensionRenderInfo:o,chunkRenderParameters:s_(a,o,i.messages)}}updateAttachmentState(i){let a=i.state;this.handleRankChanged();let{chunkTransform:o}=this,l=i.view.displayDimensionRenderInfo.value;return a!==void 0&&a.chunkTransform===o&&a.displayDimensionRenderInfo===l?a.chunkRenderParameters:(a.chunkTransform=o,a.displayDimensionRenderInfo=l,a.chunkRenderParameters=s_(o,l,i.messages))}get chunkTransform(){return this.base.state.chunkTransform.value}updateModelClipBounds(i,a){let{modelClipBounds:o}=a,l=this.curRank,{chunkTransform:c}=a;Ni(o.subarray(0,l),i.projectionParameters.globalPosition,this.base.state.localPosition.value,c.layerRank,c.combinedGlobalLocalToChunkTransform)}get gl(){return this.base.chunkManager.gl}drawGeometryChunkData(i,a,o,l=1){if(!i.bufferValid){let{buffer:c}=i;c===void 0&&(c=i.buffer=new Bt(this.gl));let{serializedAnnotations:d}=i;c.setData(d.data),i.numPickIds=QS(d),i.bufferValid=!0}this.drawGeometry(i,a,o,l)}drawGeometry(i,a,o,l=1){let{base:c}=this,{chunkDisplayTransform:d}=o,{serializedAnnotations:p}=i,{typeToIdMaps:m,typeToOffset:g}=p,v=0;a.emitPickID&&(v=a.pickIDs.register(this,i.numPickIds,0,0,i));let b=c.hoverState.value,x=ae.multiply(n5,a.projectionParameters.viewProjectionMat,d.displaySubspaceModelMatrix),C={annotationLayer:c,renderContext:a,selectedIndex:0,basePickId:v,buffer:i.buffer,bufferOffset:0,count:0,modelViewProjectionMatrix:x,modelClipBounds:o.modelClipBounds,subspaceMatrix:o.renderSubspaceTransform,renderSubspaceModelMatrix:d.displaySubspaceModelMatrix,renderSubspaceInvModelMatrix:d.displaySubspaceInvModelMatrix,chunkDisplayTransform:d},T=this.base.state.displayState.shaderControls.histogramSpecifications.visibleHistograms>0;for(let I of _i){let P=m[I],M=P.size;if(M>0){let D=es(I),E=4294967295;if(b!==void 0){let O=P.get(b.id);O!==void 0&&(E=O*D.pickIdsPerInstance)}M=Math.round(M*l),C.count=M,C.bufferOffset=g[I],C.selectedIndex=E;let V=this.renderHelpers[I];V.draw(C),T&&(V.computeHistograms(C,a.frameNumber),a.bindFramebuffer()),C.basePickId+=M*D.pickIdsPerInstance}}}updateMouseState(i,a,o,l){let c=l,{serializedAnnotations:d}=c,{typeToIds:p,typeToOffset:m}=d,g=this.curRank,v=this.chunkTransform;if(v.error===void 0)for(let b of _i){let x=p[b],C=es(b),{pickIdsPerInstance:T}=C;if(o<x.length*T){let I=Math.floor(o/T),P=x[I],M=o%T;i.pickedAnnotationId=P,i.pickedAnnotationLayer=this.base.state,i.pickedOffset=M,i.pickedAnnotationBuffer=d.data.buffer,i.pickedAnnotationType=b,i.pickedAnnotationBufferBaseOffset=d.data.byteOffset+m[b],i.pickedAnnotationIndex=I,i.pickedAnnotationCount=x.length;let D=this.tempChunkPosition,{chunkToLayerTransform:E,combinedGlobalLocalToChunkTransform:V,layerRank:O}=v,{globalToRenderLayerDimensions:B}=v.modelTransform,{position:z}=i;if(!Ni(D,z,this.base.state.localPosition.value,O,V))return;let _=this.base.source.annotationPropertySerializers[b];C.snapPosition(D,i.pickedAnnotationBuffer,i.pickedAnnotationBufferBaseOffset+i.pickedAnnotationIndex*_.propertyGroupBytes[0],M);let U=B.length;for(let N=0;N<U;++N){let J=B[N];if(J===-1)continue;let ie=E[(g+1)*g+J];for(let pe=0;pe<g;++pe)ie+=D[pe]*E[pe*(O+1)+J];!Number.isFinite(ie)||(z[N]=ie)}return}o-=x.length*T}}transformPickedValue(i){let{pickedAnnotationBuffer:a}=i;if(a===void 0)return;let{properties:o}=this.base.source;if(o.length===0)return;let{pickedAnnotationBufferBaseOffset:l,pickedAnnotationType:c,pickedAnnotationIndex:d,pickedAnnotationCount:p}=i,{annotationPropertySerializers:m}=this.base.source,g=new Array(o.length);return m[c].deserialize(new DataView(a),l,d,p,yn.LITTLE===ga,g),LE(o[0],g[0])}}return t}var l_=n=>class extends n{constructor(){super(...arguments);this.layerChunkProgressInfo=this.base.layerChunkProgressInfo}draw(t,r){let i=this.updateAttachmentState(r);if(this.curRank===0||i===void 0)return;this.updateModelClipBounds(t,i);let{source:a}=this.base;if(a instanceof to){let{base:o}=this;o.updateBuffer(),this.drawGeometry(o,t,i)}else{let{renderScaleHistogram:o}=this;o.begin(this.base.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),this.drawGeometryChunkData(a.temporary.data,t,i);let{value:l}=this.base.segmentationStates,c=0,d=0;if(l!==void 0)for(let p=0,m=l.length;p<m;++p){let g=l[p];if(g==null)continue;let v=a.segmentFilteredSources[p].chunks;Ea(g.segmentationGroupState.value,b=>{let x=Nr(b),C=v.get(x);if(C!==void 0&&C.state===Ze.GPU_MEMORY){let{data:T}=C;if(T===void 0)return;this.drawGeometryChunkData(T,t,i),++c}else++d})}o.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,c,d)}}isReady(){let{base:t}=this,{source:r}=t;if(!(r instanceof Hi))return!0;let{value:i}=this.base.segmentationStates;if(i===void 0)return!0;for(let a=0,o=i.length;a<o;++a){let l=i[a];if(l===null)return!1;if(l===void 0)continue;let c=r.segmentFilteredSources[a].chunks,d=!1;if(Ea(l.segmentationGroupState.value,p=>{let m=Nr(p);c.has(m)||(d=!0)}),d)return!1}return!0}},c_=LC(Ur,"perspectiveViewRenderHelper"),kC=class extends l_(c_){},u_=n=>{class e extends n{constructor(r){super(r.annotationLayer,r.renderScaleHistogram);this.wireFrameRenderHelper=this instanceof hi?a_:i_;this.wireFrameShaderGetter=ti(this,this.gl,{memoizeKey:`annotation/wireFrameShader:${this instanceof hi}`,parameters:Rr(void 0),defineShader:r=>{this.wireFrameRenderHelper.defineShader(r)}});this.renderScaleTarget=r.renderScaleTarget,this.registerDisposer(this.renderScaleTarget.changed.add(this.redrawNeeded.dispatch));let i=this.registerDisposer(new ka(this.layerChunkProgressInfo)),a=this.base.chunkManager.rpc;i.RPC_TYPE_ID=wD,i.initializeCounterpart(a,{chunkManager:this.base.chunkManager.rpcId,localPosition:this.registerDisposer(mt.makeFromExisting(a,this.base.state.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(mt.makeFromExisting(a,this.renderScaleTarget)).rpcId}),this.backend=i}attach(r){super.attach(r),r.state.sources=r.registerDisposer(Dn((i,a,o)=>{let l=pl(o,a,c=>this.base.state.source.getSources(c),r.messages,this);for(let c of l)for(let d of c)i.registerDisposer(d.source),Object.assign(d,o_(d.chunkDisplayTransform));return r.view.flushBackendProjectionParameters(),this.backend.rpc.invoke(TD,{layer:this.backend.rpcId,view:r.view.rpcId,displayDimensionRenderInfo:o,sources:cl(l)}),this.redrawNeeded.dispatch(),l},this.base.state.transform,r.view.displayDimensionRenderInfo))}draw(r,i){let a=this.updateAttachmentState(i);if(this.curRank===0||a===void 0)return;let o=i.state.sources.value;if(o.length===0)return;this.updateModelClipBounds(r,a);let{renderScaleHistogram:l}=this;l.begin(this.base.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);let{projectionParameters:c}=r,d;if(r.wireFrame){let{shader:p}=this.wireFrameShaderGetter(r.emitter);if(p===null)return;p.bind(),this.wireFrameRenderHelper.initialize(p,c),d=p}CS(c,this.base.state.localPosition.value,this.renderScaleTarget.value,o[0],()=>{},(p,m,g,v,b)=>{let x=p.source.chunks.get(p.curPositionInChunks.join()),C;if(x===void 0||x.state!==Ze.GPU_MEMORY)C=0;else{let{data:T}=x;if(T===void 0)return;d!==void 0?this.wireFrameRenderHelper.draw(d,p,c):this.drawGeometryChunkData(T,r,a,g),C=1}l.add(v,b,C,1-C)})}isReady(r,i){let a=this.updateAttachmentState(i);if(this.curRank===0||a===void 0)return;let o=i.state.sources.value;if(o.length===0)return;this.updateModelClipBounds(r,a);let{projectionParameters:l}=r,c=!0;return CS(l,this.base.state.localPosition.value,this.renderScaleTarget.value,o[0],()=>{},(d,p,m,g,v)=>{let b=d.source.chunks.get(d.curPositionInChunks.join());if(b===void 0||b.state!==Ze.GPU_MEMORY){c=!1;return}}),c}}return e},d_=u_(c_),p_=u_(LC(hi,"sliceViewRenderHelper")),f_=l_(LC(hi,"sliceViewRenderHelper"));var Ul=class extends j{constructor(e,t=()=>K.fromValues(1,0,0)){super();this.model=e;this.getDefaultColor=t;this.element=document.createElement("input");let{element:r}=this;r.classList.add("neuroglancer-color-widget"),r.type="color",r.addEventListener("change",()=>this.updateModel()),r.addEventListener("input",()=>this.updateModel()),r.addEventListener("wheel",i=>{i.stopPropagation(),i.preventDefault(),this.adjustHueViaWheel(i)}),this.registerDisposer(e.changed.add(()=>this.updateView())),this.updateView()}getRGB(){var e;return(e=this.model.value)!=null?e:this.getDefaultColor()}updateView(){this.element.value=gn(this.getRGB())}updateModel(){this.model.value=ma(this.element.value)}adjustHueViaWheel(e){let t=this.getRGB(),r=K.create();mI(r,t[0],t[1],t[2]);let{deltaY:i}=e,a=Math.round(r[0]*256);a+=i>0?1:i<0?-1:0,a=(a+256)%256,r[0]=a/256,Sl(r,r[0],r[1],r[2]),this.model.value=r}};var h_='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="binIconTitle"><path d="M19 6L5 6M14 5L10 5M6 10L6 20C6 20.6666667 6.33333333 21 7 21 7.66666667 21 11 21 17 21 17.6666667 21 18 20.6666667 18 20 18 19.3333333 18 16 18 10"></path></svg>';function Li(n={}){let e=He({svg:h_,...n}),t=e.firstElementChild;return t.style.fill="white",e}var Pg=class extends j{constructor(){super(...arguments);this.changed=new re;this.isLoadingChanged=new re;this.states=[];this.relationships=[];this.loadingCount=0}get value(){return this.states}get isLoading(){return this.loadingCount!==0}markLoading(){return this.loadingCount++,()=>{--this.loadingCount==0&&this.isLoadingChanged.dispatch()}}sort(){this.states.sort((e,t)=>{let r=e.sourceIndex-t.sourceIndex;return r!==0?r:e.subsourceIndex-t.subsourceIndex})}updateRelationships(){let e=new Set;for(let t of this.states)for(let r of t.source.relationships)e.add(r);this.relationships=Array.from(e)}add(e){return this.states.push(e),this.sort(),this.updateRelationships(),this.changed.dispatch(),()=>{let t=this.states.indexOf(e);this.states.splice(t,1),this.updateRelationships(),this.changed.dispatch()}}};function a5(n,e){switch(e.type){case Oe.AXIS_ALIGNED_BOUNDING_BOX:case Oe.LINE:gh(n,e.pointA,e.pointB),PE(n,n,.5);break;case Oe.POINT:n.set(e.point);break;case Oe.ELLIPSOID:n.set(e.center);break}}function m_(n,e,t){e.error===void 0&&n.setLayerPosition(e.modelTransform,t)}function g_(n,e,t){let{layerRank:r}=e,i=new Float32Array(r);Un[n.type].visitGeometry(n,(a,o)=>{i.set(a);let l=new Float32Array(r);(o?bh:Zr)(l,e.chunkToLayerTransform,r+1,i,r),t(l,o)})}var Ig=class extends Vt{constructor(e,t){super();this.layer=e;this.displayState=t;this.previousSelectedState=void 0;this.previousHoverId=void 0;this.previousHoverAnnotationLayerState=void 0;this.virtualListSource={length:0,render:e=>this.render(e),changed:new ze};this.virtualList=new Vl({source:this.virtualListSource});this.listElements=[];this.updated=!1;this.mutableControls=document.createElement("div");this.headerRow=document.createElement("div");this.attachedAnnotationStates=new Map;this.forceUpdateView=()=>{this.updated=!1,this.updateView()};this.globalDimensionIndices=[];this.localDimensionIndices=[];this.curCoordinateSpaceGeneration=-1;this.prevCoordinateSpaceGeneration=-1;this.columnWidths=[];this.gridTemplate="";this.selectedAnnotationState=mn((e,t)=>{var l;if(e===void 0)return;let{layer:r}=this,i=(l=e.layers.find(c=>c.layer===r))==null?void 0:l.state;if(i===void 0)return;let{annotationId:a}=i;if(a===void 0)return;let o=this.annotationStates.states.find(c=>c.sourceIndex===i.annotationSourceIndex&&(i.annotationSubsource===void 0||c.subsourceId===i.annotationSubsource));if(o!==void 0)return{annotationId:a,annotationLayerState:o,pin:t}},this.layer.manager.root.selectionState,this.layer.manager.root.selectionState.pin);this.element.classList.add("neuroglancer-annotation-layer-view"),this.registerDisposer(this.visibility.changed.add(()=>this.updateView())),this.registerDisposer(this.annotationStates.changed.add(()=>this.updateAttachedAnnotationLayerStates())),this.headerRow.classList.add("neuroglancer-annotation-list-header");let r=document.createElement("div");r.className="neuroglancer-annotation-toolbox",e.initializeAnnotationLayerViewTab(this);let i=this.registerDisposer(new Ul(this.displayState.color));i.element.title="Change annotation display color",this.registerDisposer(new Xn(mn(g=>g.match(/\bdefaultColor\b/)!==null,t.shaderControls.processedFragmentMain),i.element)),r.appendChild(i.element);let{mutableControls:a}=this,o=He({text:Un[Oe.POINT].icon,title:"Annotate point",onClick:()=>{this.layer.tool.value=new DC(this.layer,{})}});a.appendChild(o);let l=He({text:Un[Oe.AXIS_ALIGNED_BOUNDING_BOX].icon,title:"Annotate bounding box",onClick:()=>{this.layer.tool.value=new Mg(this.layer,{})}});a.appendChild(l);let c=He({text:Un[Oe.LINE].icon,title:"Annotate line",onClick:()=>{this.layer.tool.value=new Rg(this.layer,{})}});a.appendChild(c);let d=He({text:Un[Oe.ELLIPSOID].icon,title:"Annotate ellipsoid",onClick:()=>{this.layer.tool.value=new AC(this.layer,{})}});a.appendChild(d),r.appendChild(a),this.element.appendChild(r),this.element.appendChild(this.headerRow);let{virtualList:p}=this;p.element.classList.add("neuroglancer-annotation-list"),this.element.appendChild(p.element),this.virtualList.element.addEventListener("mouseleave",()=>{this.displayState.hoverState.value=void 0});let m=bI();this.registerDisposer(new wn(this.virtualList.element,m)),this.virtualList.element.title=m.describe(),this.registerDisposer(this.displayState.hoverState.changed.add(()=>this.updateHoverView())),this.registerDisposer(this.selectedAnnotationState.changed.add(()=>this.updateSelectionView())),this.registerDisposer(this.layer.localCoordinateSpace.changed.add(()=>{this.updateCoordinateSpace(),this.updateView()})),this.registerDisposer(this.layer.manager.root.coordinateSpace.changed.add(()=>{this.updateCoordinateSpace(),this.updateView()})),this.updateCoordinateSpace(),this.updateAttachedAnnotationLayerStates(),this.updateSelectionView()}get annotationStates(){return this.layer.annotationStates}updateAttachedAnnotationLayerStates(){let e=this.annotationStates.states,{attachedAnnotationStates:t}=this,r=new Map;for(let[i,a]of t)e.includes(i)||(t.delete(i),a.refCounted.dispose());for(let i of e){let a=t.get(i);if(a!==void 0){r.set(i,a);continue}let o=i.source,l=new j;o instanceof to&&(l.registerDisposer(o.childAdded.add(c=>this.addAnnotationElement(c,i))),l.registerDisposer(o.childUpdated.add(c=>this.updateAnnotationElement(c,i))),l.registerDisposer(o.childDeleted.add(c=>this.deleteAnnotationElement(c,i)))),l.registerDisposer(i.transform.changed.add(this.forceUpdateView)),r.set(i,{refCounted:l,annotations:[],idToIndex:new Map,listOffset:0})}this.attachedAnnotationStates=r,t.clear(),this.updateCoordinateSpace(),this.forceUpdateView()}updateCoordinateSpace(){let e=this.layer.localCoordinateSpace.value,t=this.layer.manager.root.coordinateSpace.value,r=[],i=[];for(let a=0,o=t.rank;a<o;++a)this.annotationStates.states.some(l=>{let c=l.transform.value;return c.error!==void 0?!1:c.globalToRenderLayerDimensions[a]!==-1})&&r.push(a);for(let a=0,o=e.rank;a<o;++a)this.annotationStates.states.some(l=>{let c=l.transform.value;return c.error!==void 0?!1:c.localToRenderLayerDimensions[a]!==-1})&&i.push(a);(!xe(r,this.globalDimensionIndices)||!xe(i,this.localDimensionIndices))&&(this.localDimensionIndices=i,this.globalDimensionIndices=r,++this.curCoordinateSpaceGeneration)}getRenderedAnnotationListElement(e,t,r=!1){let i=this.attachedAnnotationStates.get(e);if(i==null)return;let a=i.idToIndex.get(t);if(a===void 0)return;let o=i.listOffset+a;return r&&this.virtualList.scrollItemIntoView(a),this.virtualList.getItemElement(o)}clearSelectionClass(){let{previousSelectedState:e}=this;if(e===void 0)return;this.previousSelectedState=void 0;let t=this.getRenderedAnnotationListElement(e.annotationLayerState,e.annotationId);t!==void 0&&t.classList.remove("neuroglancer-annotation-selected")}clearHoverClass(){let{previousHoverId:e,previousHoverAnnotationLayerState:t}=this;if(t!==void 0){this.previousHoverAnnotationLayerState=void 0,this.previousHoverId=void 0;let r=this.getRenderedAnnotationListElement(t,e);r!==void 0&&r.classList.remove("neuroglancer-annotation-hover")}}updateSelectionView(){let e=this.selectedAnnotationState.value,{previousSelectedState:t}=this;if(t===e||t!==void 0&&e!==void 0&&t.annotationId===e.annotationId&&t.annotationLayerState===e.annotationLayerState&&t.pin===e.pin||(this.clearSelectionClass(),this.previousSelectedState=e,e===void 0))return;let r=this.getRenderedAnnotationListElement(e.annotationLayerState,e.annotationId,e.pin);r!==void 0&&r.classList.add("neuroglancer-annotation-selected")}updateHoverView(){let e=this.displayState.hoverState.value,t,r;e!==void 0&&(t=e.id,r=e.annotationLayerState);let{previousHoverId:i,previousHoverAnnotationLayerState:a}=this;if(t===i&&r===a||(this.clearHoverClass(),this.previousHoverId=t,this.previousHoverAnnotationLayerState=r,t===void 0))return;let o=this.getRenderedAnnotationListElement(r,t);o!==void 0&&o.classList.add("neuroglancer-annotation-hover")}render(e){let{annotation:t,state:r}=this.listElements[e];return this.makeAnnotationListElement(t,r)}setColumnWidth(e,t){t+=2;let{columnWidths:r}=this;r[e]>t||(r[e]=t,this.element.style.setProperty(`--neuroglancer-column-${e}-width`,`${t}ch`))}updateView(){if(!this.visible)return;if(this.curCoordinateSpaceGeneration!==this.prevCoordinateSpaceGeneration){this.updated=!1;let{columnWidths:i}=this;i.length=0;let{headerRow:a}=this,o=document.createElement("div");o.style.gridColumn="symbol";let l=document.createElement("div");l.style.gridColumn="delete",Ie(a),a.appendChild(o);let c=0,d="[symbol] 2ch",p=(v,b)=>{let x=document.createElement("div");x.classList.add("neuroglancer-annotations-view-dimension");let C=document.createElement("span");C.classList.add("neuroglancer-annotations-view-dimension-name"),C.textContent=v.names[b];let T=document.createElement("scale");T.classList.add("neuroglancer-annotations-view-dimension-scale"),T.textContent=Vi(v.scales[b],v.units[b],{precision:2}),x.appendChild(C),x.appendChild(T),x.style.gridColumn=`dim ${c+1}`,this.setColumnWidth(c,T.textContent.length+C.textContent.length+3),d+=` [dim] var(--neuroglancer-column-${c}-width)`,++c,a.appendChild(x)},m=this.layer.manager.root.coordinateSpace.value;for(let v of this.globalDimensionIndices)p(m,v);let g=this.layer.localCoordinateSpace.value;for(let v of this.localDimensionIndices)p(g,v);a.appendChild(l),d+=" [delete] 2ch",this.gridTemplate=d,a.style.gridTemplateColumns=d,this.prevCoordinateSpaceGeneration=this.curCoordinateSpaceGeneration}if(this.updated)return;let e=!1,{listElements:t}=this;t.length=0;for(let[i,a]of this.attachedAnnotationStates){if(i.source.readonly||(e=!0),i.chunkTransform.value.error!==void 0)continue;let{source:o}=i,l=Array.from(o);a.annotations=l;let{idToIndex:c}=a;c.clear();for(let d=0,p=l.length;d<p;++d)c.set(l[d].id,d);for(let d of l)t.push({state:i,annotation:d})}let r=this.virtualListSource.length;this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:0,deleteCount:r,insertCount:t.length}]),this.mutableControls.style.display=e?"contents":"none",this.resetOnUpdate()}updateListLength(){let e=0;for(let t of this.attachedAnnotationStates.values())t.listOffset=e,e+=t.annotations.length;this.virtualListSource.length=e}addAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}let r=this.attachedAnnotationStates.get(t);if(r!==void 0){let i=r.annotations.length;r.annotations.push(e),r.idToIndex.set(e.id,i);let a=r.listOffset+i;this.listElements.splice(a,0,{state:t,annotation:e}),this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:a,deleteCount:0,insertCount:1}])}this.resetOnUpdate()}updateAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}let r=this.attachedAnnotationStates.get(t);if(r!==void 0){let i=r.idToIndex.get(e.id);if(i!==void 0){let a=r.listOffset+i;r.annotations[i]=e,this.listElements[a].annotation=e,this.virtualListSource.changed.dispatch([{retainCount:a,deleteCount:1,insertCount:1}])}}this.resetOnUpdate()}deleteAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}let r=this.attachedAnnotationStates.get(t);if(r!==void 0){let{idToIndex:i}=r,a=i.get(e);if(a!==void 0){let o=r.listOffset+a,{annotations:l}=r;l.splice(a,1),i.delete(e);for(let c=a,d=l.length;c<d;++c)i.set(l[c].id,c);this.listElements.splice(o,1),this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:o,deleteCount:1,insertCount:0}])}}this.resetOnUpdate()}resetOnUpdate(){this.clearHoverClass(),this.clearSelectionClass(),this.updated=!0,this.updateHoverView(),this.updateSelectionView()}makeAnnotationListElement(e,t){let r=t.chunkTransform.value,i=document.createElement("div");i.classList.add("neuroglancer-annotation-list-entry"),i.dataset.color=t.displayState.color.toString(),i.style.gridTemplateColumns=this.gridTemplate;let a=document.createElement("div");a.className="neuroglancer-annotation-icon",a.textContent=Un[e.type].icon,i.appendChild(a);let o,l=()=>{t.source.readonly||o===void 0&&(o=Li({title:"Delete annotation",onClick:p=>{p.stopPropagation(),p.preventDefault();let m=t.source.getReference(e.id);try{t.source.delete(m)}finally{m.dispose()}}}),o.classList.add("neuroglancer-annotation-list-entry-delete"),i.appendChild(o))},c=0;if(g_(e,r,(p,m)=>{++c;let g=document.createElement("div");g.className="neuroglancer-annotation-position",i.appendChild(g);let v=0,b=(x,C)=>{for(let T of x){let I=C[T];if(I!==-1){let P=Math.floor(p[I]),M=document.createElement("div"),D=P.toString();M.textContent=D,M.classList.add("neuroglancer-annotation-coordinate"),M.style.gridColumn=`dim ${v+1}`,this.setColumnWidth(v,D.length),g.appendChild(M)}++v}};b(this.globalDimensionIndices,r.modelTransform.globalToRenderLayerDimensions),b(this.localDimensionIndices,r.modelTransform.localToRenderLayerDimensions),l()}),e.description){++c;let p=document.createElement("div");p.classList.add("neuroglancer-annotation-description"),p.textContent=e.description,i.appendChild(p)}a.style.gridRow=`span ${c}`,o!==void 0&&(o.style.gridRow=`span ${c}`),i.addEventListener("mouseenter",()=>{this.displayState.hoverState.value={id:e.id,partIndex:0,annotationLayerState:t},this.layer.selectAnnotation(t,e.id,!1)}),i.addEventListener("action:select-position",p=>{p.stopPropagation(),this.layer.selectAnnotation(t,e.id,"toggle")}),i.addEventListener("action:pin-annotation",p=>{p.stopPropagation(),this.layer.selectAnnotation(t,e.id,!0)}),i.addEventListener("action:move-to-annotation",p=>{p.stopPropagation(),p.preventDefault();let{layerRank:m}=r,g=new Float32Array(m),v=new Float32Array(m);a5(g,e),Zr(v,r.chunkToLayerTransform,m+1,g,m),m_(this.layer,r,v)});let d=this.selectedAnnotationState.value;return d!==void 0&&d.annotationLayerState===t&&d.annotationId===e.id&&i.classList.add("neuroglancer-annotation-selected"),i}},y_=class extends Vt{constructor(e){super();this.layer=e;this.layerView=this.registerDisposer(new Ig(this.layer,this.layer.annotationDisplayState));let{element:t}=this;t.classList.add("neuroglancer-annotations-tab"),t.appendChild(this.layerView.element)}};function Ag(n){let e=[],{relationships:t}=n.source,{relationshipStates:r}=n.displayState;for(let i=0,a=t.length;i<a;++i){let o=r.get(t[i]).segmentationState.value;if(o!=null&&o.segmentSelectionState.hasSelectedSegment){e[i]=[o.segmentSelectionState.selectedSegment.clone()];continue}e[i]=[]}return e}var EC=class extends vp{constructor(e,t){super(e)}get annotationLayer(){for(let e of this.layer.annotationStates.states)if(!e.source.readonly)return e}},v_="annotatePoint",S_="annotateLine",b_="annotateBoundingBox",x_="annotateSphere",DC=class extends EC{trigger(e){let{annotationLayer:t}=this;if(t!==void 0&&e.updateUnconditionally()){let r=_p(e,t);if(r===void 0)return;let i={id:"",description:"",relatedSegments:Ag(t),point:r,type:Oe.POINT,properties:t.source.properties.map(o=>o.default)},a=t.source.add(i,!0);this.layer.selectAnnotation(t,a.id,!0),a.dispose()}}get description(){return"annotate point"}toJSON(){return v_}};function _p(n,e){let t=e.chunkTransform.value;if(t.error!==void 0)return;let r=new Float32Array(t.modelTransform.unpaddedRank);if(!!Ni(r,n.unsnappedPosition,e.localPosition.value,t.layerRank,t.combinedGlobalLocalToChunkTransform))return r}var PC=class extends EC{trigger(e){let{annotationLayer:t}=this;if(t!==void 0&&e.updateUnconditionally()){let r=()=>{let i=this.inProgressAnnotation,a=i.reference,o=this.getUpdatedAnnotation(a.value,e,t);JSON.stringify(ch(o,t.source))!==JSON.stringify(ch(a.value,t.source))&&(i.annotationLayer.source.update(a,o),this.layer.selectAnnotation(t,a.id,!0))};if(this.inProgressAnnotation===void 0){let i=t.source.add(this.getInitialAnnotation(e,t),!1);this.layer.selectAnnotation(t,i.id,!0);let a=e.changed.add(r),o=()=>{a(),i.dispose()};this.inProgressAnnotation={annotationLayer:t,reference:i,disposer:o}}else r(),this.inProgressAnnotation.annotationLayer.source.commit(this.inProgressAnnotation.reference),this.inProgressAnnotation.disposer(),this.inProgressAnnotation=void 0}}disposed(){this.deactivate(),super.disposed()}deactivate(){this.inProgressAnnotation!==void 0&&(this.inProgressAnnotation.annotationLayer.source.delete(this.inProgressAnnotation.reference),this.inProgressAnnotation.disposer(),this.inProgressAnnotation=void 0)}},IC=class extends PC{getInitialAnnotation(e,t){let r=_p(e,t);return{id:"",type:this.annotationType,description:"",pointA:r,pointB:r,properties:t.source.properties.map(i=>i.default)}}getUpdatedAnnotation(e,t,r){let i=_p(t,r);return i===void 0?e:{...e,pointB:i}}},Mg=class extends IC{get description(){return"annotate bounding box"}getUpdatedAnnotation(e,t,r){let i=super.getUpdatedAnnotation(e,t,r),{pointA:a,pointB:o}=i,l=a.length;for(let c=0;c<l;++c)a[c]===o[c]&&(o[c]+=1);return i}toJSON(){return b_}};Mg.prototype.annotationType=Oe.AXIS_ALIGNED_BOUNDING_BOX;var Rg=class extends IC{get description(){return"annotate line"}getInitialAnnotation(e,t){let r=super.getInitialAnnotation(e,t);return this.initialRelationships=r.relatedSegments=Ag(t),r}getUpdatedAnnotation(e,t,r){let i=super.getUpdatedAnnotation(e,t,r),a=this.initialRelationships,o=Ag(r);return a===void 0?i.relatedSegments=o:i.relatedSegments=Array.from(o,(l,c)=>{let d=a[c];return l=l.filter(p=>d.findIndex(m=>X.equal(p,m))===-1),[...d,...l]}),i}toJSON(){return S_}};Rg.prototype.annotationType=Oe.LINE;var AC=class extends PC{getInitialAnnotation(e,t){let r=_p(e,t);return{type:Oe.ELLIPSOID,id:"",description:"",segments:Ag(t),center:r,radii:K.fromValues(0,0,0),properties:t.source.properties.map(i=>i.default)}}getUpdatedAnnotation(e,t,r){let i=_p(t,r);if(i===void 0)return e;let a=e.center,o=a.length;for(let l=0;l<o;++l)i[l]=Math.abs(a[l]-i[l]);return{...e,radii:i}}get description(){return"annotate ellipsoid"}toJSON(){return x_}};Sp(v_,(n,e)=>new DC(n,e));Sp(b_,(n,e)=>new Mg(n,e));Sp(S_,(n,e)=>new Rg(n,e));Sp(x_,(n,e)=>new AC(n,e));var o5=Me.fromObject({enter:{action:"commit"},escape:{action:"cancel"}});function s5(n,e,t,r){return new Cn(t,(i,a,o)=>{let l=document.createElement("div");l.classList.add("neuroglancer-related-segment-list"),i!=null&&o.registerDisposer(ss(i,l));let c=document.createElement("div");c.classList.add("neuroglancer-related-segment-list-header");let d=Tr({title:"Copy segment IDs",onClick:()=>{wr(e.map(b=>b.toString()).join(", "))}});c.appendChild(d);let p;if(i!=null&&(p=document.createElement("input"),p.type="checkbox",p.addEventListener("change",()=>{let{visibleSegments:b}=i.segmentationGroupState.value,x=e.some(C=>!b.has(C));for(let C of e)b.set(C,x)}),c.appendChild(p)),r!==void 0){let b=Li({title:"Remove all IDs",onClick:()=>{r([])}});c.appendChild(b)}let m=document.createElement("span");if(m.classList.add("neuroglancer-related-segment-list-title"),m.textContent=n,c.appendChild(m),r!==void 0){let b=fg({title:"Add related segment ID",onClick:()=>{let x=new j,C=o.registerDisposer(Nf(x)),T=document.createElement("div");T.classList.add("neuroglancer-segment-list-entry"),T.classList.add("neuroglancer-segment-list-entry-new");let I=Tr({});if(I.classList.add("neuroglancer-segment-list-entry-copy"),T.appendChild(I),i!=null){let V=document.createElement("input");V.classList.add("neuroglancer-segment-list-entry-visible-checkbox"),V.type="checkbox",T.appendChild(V)}let P=Li({title:"Cancel adding new segment ID",onClick:()=>{C()}});P.classList.add("neuroglancer-segment-list-entry-delete"),T.appendChild(P);let M=document.createElement("input");M.autocomplete="off",M.spellcheck=!1,M.classList.add("neuroglancer-segment-list-entry-id");let D=x.registerDisposer(new $t(M,o5));D.allShortcutsAreGlobal=!0;let E=()=>{let V=new X;if(V.tryParseString(M.value))return M.dataset.valid="true",V;M.dataset.valid="false"};E(),M.addEventListener("input",()=>{E()}),M.addEventListener("blur",()=>{let V=E();V!==void 0&&r([...e,V]),C()}),ce(M,"cancel",C),ce(M,"commit",()=>{let V=E();V!==void 0&&r([...e,V]),C()}),T.appendChild(M),l.appendChild(T),M.focus(),x.registerDisposer(()=>{M.value="",T.remove()})}});c.appendChild(b)}l.appendChild(c);let g=[],v=Cl.make(i!=null?i:void 0,!1);for(let b of e){let x=v.get(b);if(g.push(x),r!==void 0){let C=Li({title:"Remove ID",onClick:T=>{r(e.filter(I=>!X.equal(I,b))),T.stopPropagation()}});C.classList.add("neuroglancer-segment-list-entry-delete"),x.children[0].appendChild(C)}l.appendChild(x)}if(i!=null){let b=o.registerCancellable(We(()=>{let{visibleSegments:x}=i.segmentationGroupState.value,C=0;for(let T of e)x.has(T)&&++C;for(let T of g)v.update(T);p.checked=C===e.length&&C>0,p.indeterminate=C>0&&C<e.length}));b(),b.flush(),ls(i,o,b),o.registerDisposer(i.segmentationGroupState.changed.add(b))}a.appendChild(l)})}var C_="annotationColor";function su(n){class e extends n{constructor(...r){super(...r);this.annotationStates=this.registerDisposer(new Pg);this.annotationDisplayState=new Mp;this.annotationCrossSectionRenderScaleHistogram=new Da;this.annotationCrossSectionRenderScaleTarget=zi(8);this.annotationProjectionRenderScaleHistogram=new Da;this.annotationProjectionRenderScaleTarget=zi(8);this.annotationDisplayState.color.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.shader.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.shaderControls.changed.add(this.specificationChanged.dispatch),this.tabs.add("annotations",{label:"Annotations",order:10,getter:()=>new y_(this)});let i,a=()=>{let l=this.isReady;l&&i!==void 0?(i(),i=void 0):!l&&i===void 0&&(i=this.annotationStates.markLoading())};this.readyStateChanged.add(a),a();let{mouseState:o}=this.manager.layerSelectedValues;this.registerDisposer(o.changed.add(()=>{if(o.active){let{pickedAnnotationLayer:l}=o;if(l!==void 0&&this.annotationStates.states.includes(l)){let c=this.annotationDisplayState.hoverState.value;(c===void 0||c.id!==o.pickedAnnotationId||c.partIndex!==o.pickedOffset||c.annotationLayerState!==l)&&(this.annotationDisplayState.hoverState.value={id:o.pickedAnnotationId,partIndex:o.pickedOffset,annotationLayerState:l});return}}this.annotationDisplayState.hoverState.value=void 0}))}initializeAnnotationLayerViewTab(r){}restoreState(r){super.restoreState(r),this.annotationDisplayState.color.restoreState(r[C_])}captureSelectionState(r,i){super.captureSelectionState(r,i);let a=i.pickedAnnotationLayer;a===void 0||!this.annotationStates.states.includes(a)||(r.annotationId=i.pickedAnnotationId,r.annotationType=i.pickedAnnotationType,r.annotationBuffer=new Uint8Array(i.pickedAnnotationBuffer,i.pickedAnnotationBufferBaseOffset),r.annotationIndex=i.pickedAnnotationIndex,r.annotationCount=i.pickedAnnotationCount,r.annotationPartIndex=i.pickedOffset,r.annotationSourceIndex=a.sourceIndex,r.annotationSubsource=a.subsourceId)}displayAnnotationState(r,i,a){if(r.annotationId===void 0)return!1;let o=this.annotationStates.states.find(c=>c.sourceIndex===r.annotationSourceIndex&&c.subsubsourceId===r.annotationSubsubsourceId&&(r.annotationSubsource===void 0||c.subsourceId===r.annotationSubsource));if(o===void 0)return!1;let l=a.registerDisposer(o.source.getReference(r.annotationId));return i.appendChild(a.registerDisposer(new Cn(a.registerDisposer(new sd(()=>({annotation:l,chunkTransform:o.chunkTransform}))),({annotation:c,chunkTransform:d},p,m)=>{let g;if(c==null)if(r.annotationType!==void 0&&r.annotationBuffer!==void 0){let v=Un[r.annotationType],b=o.source.rank,x=v.serializedBytes(b),C=r.annotationBuffer.byteOffset,T=new DataView(r.annotationBuffer.buffer),I=yn.LITTLE===ga,{properties:P}=o.source,M=new oh(b,x,P),D=r.annotationIndex,E=r.annotationCount;c=v.deserialize(T,C+M.propertyGroupBytes[0]*D,I,b,r.annotationId),M.deserialize(T,C,D,E,I,c.properties=new Array(P.length)),o.source.hasNonSerializedProperties()&&(g="Loading...")}else g=c===null?"Annotation not found":"Loading...";if(c!=null){let v=d.error===void 0?d.layerRank:0,b=document.createElement("div");b.classList.add("neuroglancer-selected-annotation-details-position-grid"),b.style.gridTemplateColumns=`[icon] 0fr [copy] 0fr repeat(${v}, [dim] 0fr [coord] 0fr) [move] 0fr [delete] 0fr`,p.appendChild(b);let x=Un[c.type],C=document.createElement("div");if(C.className="neuroglancer-selected-annotation-details-icon",C.textContent=x.icon,b.appendChild(C),v!==0){let{layerDimensionNames:D}=d.modelTransform;for(let E=0;E<v;++E){let V=document.createElement("div");V.classList.add("neuroglancer-selected-annotation-details-position-dim"),V.textContent=D[E],V.style.gridColumn=`dim ${E+1}`,b.appendChild(V)}g_(c,d,(E,V)=>{let O=Tr({title:"Copy position",onClick:()=>{wr(E.map(B=>Math.floor(B)).join(", "))}});O.style.gridColumn="copy",b.appendChild(O);for(let B=0;B<v;++B){let z=document.createElement("div");z.classList.add("neuroglancer-selected-annotation-details-position-coord"),z.style.gridColumn=`coord ${B+1}`,z.textContent=Math.floor(E[B]).toString(),b.appendChild(z)}if(!V){let B=mm({title:"Move to position",onClick:()=>{m_(this,d,E)}});B.style.gridColumn="move",b.appendChild(B)}})}if(!o.source.readonly){let D=Li({title:"Delete annotation",onClick:()=>{o.source.delete(l)}});D.classList.add("neuroglancer-selected-annotation-details-delete"),b.appendChild(D)}let{relationships:T,properties:I}=o.source,P=o.source.readonly;for(let D=0,E=I.length;D<E;++D){let V=I[D],O=document.createElement("label");O.classList.add("neuroglancer-annotation-property");let B=document.createElement("span");B.classList.add("neuroglancer-annotation-property-label"),B.textContent=V.identifier,O.appendChild(B);let{description:z}=V;z!==void 0&&(O.title=z);let _=c.properties[D],U=document.createElement("span");switch(U.classList.add("neuroglancer-annotation-property-value"),V.type){case"rgb":{let N=Qa(_),J=gn(N);U.textContent=J,U.style.backgroundColor=J,U.style.color=fd(N)?"white":"black";break}case"rgba":{let N=Qa(_);U.textContent=gn(pd(_)),U.style.backgroundColor=gn(Qa(_)),U.style.color=fd(N)?"white":"black";break}default:U.textContent=Wv(V,_);break}O.appendChild(U),p.appendChild(O)}let{relatedSegments:M}=c;for(let D=0,E=T.length;D<E;++D){let V=M===void 0?[]:M[D];if(V.length===0&&P)continue;let O=D,B=T[D];p.appendChild(m.registerDisposer(s5(B,V,o.displayState.relationshipStates.get(B).segmentationState,P?void 0:z=>{let _=l.value;if(_==null)return;let{relatedSegments:U}=_;U===void 0?U=o.source.relationships.map(()=>[]):U=U.slice(),U[O]=z;let N={..._,relatedSegments:U};o.source.update(l,N),o.source.commit(l)})).element)}if(!o.source.readonly||c.description)if(o.source.readonly){let D=document.createElement("div");D.className="neuroglancer-annotation-details-description",D.textContent=c.description||"",p.appendChild(D)}else{let D=document.createElement("textarea");D.value=c.description||"",D.rows=3,D.className="neuroglancer-annotation-details-description",D.placeholder="Description",D.addEventListener("change",()=>{let E=D.value;o.source.update(l,{...c,description:E||void 0}),o.source.commit(l)}),p.appendChild(D)}}if(g!==void 0){let v=document.createElement("div");v.classList.add("neuroglancer-selection-annotation-status"),v.textContent=g,p.appendChild(v)}})).element),!0}displaySelectionState(r,i,a){let o=this.displayAnnotationState(r,i,a);return super.displaySelectionState(r,i,a)&&(o=!0),o}addLocalAnnotations(r,i,a){let{subsourceEntry:o}=r,l=new ys({localPosition:this.localPosition,transform:r.getRenderLayerTransform(),source:i,displayState:this.annotationDisplayState,dataSource:r.loadedDataSource.layerDataSource,subsourceIndex:r.subsourceIndex,subsourceId:o.id,role:a});this.addAnnotationLayerState(l,r)}addStaticAnnotations(r){let{subsourceEntry:i}=r,{staticAnnotations:a}=i.subsource;return a===void 0?!1:(r.activate(()=>{this.addLocalAnnotations(r,a,In.DEFAULT_ANNOTATION)}),!0)}addAnnotationLayerState(r,i){let a=i.activated;a.registerDisposer(this.annotationStates.add(r));let o=new TC(this.manager.chunkManager,r.addRef());if(o.source instanceof Hi){let l=new p_({annotationLayer:o.addRef(),renderScaleTarget:this.annotationCrossSectionRenderScaleTarget,renderScaleHistogram:this.annotationCrossSectionRenderScaleHistogram});a.registerDisposer(i.messages.addChild(l.messages));let c=new d_({annotationLayer:o.addRef(),renderScaleTarget:this.annotationProjectionRenderScaleTarget,renderScaleHistogram:this.annotationProjectionRenderScaleHistogram});a.registerDisposer(i.messages.addChild(c.messages)),a.registerDisposer(Dn((d,p)=>{p&&(d.registerDisposer(this.addRenderLayer(l.addRef())),d.registerDisposer(this.addRenderLayer(c.addRef())))},this.annotationDisplayState.displayUnfiltered))}{let l=new f_(o,this.annotationCrossSectionRenderScaleHistogram);a.registerDisposer(this.addRenderLayer(l)),a.registerDisposer(i.messages.addChild(l.messages))}{let l=new kC(o.addRef(),this.annotationProjectionRenderScaleHistogram);a.registerDisposer(this.addRenderLayer(l)),a.registerDisposer(i.messages.addChild(l.messages))}}selectAnnotation(r,i,a){this.manager.root.selectionState.captureSingleLayerState(this,o=>(o.annotationId=i,o.annotationSourceIndex=r.sourceIndex,o.annotationSubsource=r.subsourceId,o.annotationSubsubsourceId=r.subsubsourceId,!0),a)}toJSON(){let r=super.toJSON();return r[C_]=this.annotationDisplayState.color.toJSON(),r}}return e}var Fg=ot(Et()),O_=ot(bp());var l5=0,c5=1,u5=2;function lu(n){let e=0,{deltaMode:t}=n;switch(t){case l5:e=1/200;break;case c5:e=1/10;break;case u5:e=2;break}return Math.exp(n.deltaY*e)}var w_=Me.fromObject({"shift?+mousedown0":{action:"set"},"shift?+alt+mousedown0":{action:"adjust-window-via-drag"},"shift?+wheel":{action:"zoom-via-wheel"}}),_g=class extends j{constructor(e,t,r,i){super();this.element=e;this.dataType=t;this.getModel=r;this.setModel=i;e.title=w_.describe(),this.registerDisposer(new wn(e,w_)),ce(e,"set",a=>{let o=a.detail,l=this.getModel(),c=this.getTargetValue(o);if(c===void 0)return;let d=qs(l.window,l.range),p=CE(d,c),m=g=>{let v=this.getModel();this.setModel(Vp(v,"range",p,g))};m(c),sn(o,g=>{let v=this.getTargetValue(g);v!==void 0&&m(v)})}),ce(e,"adjust-window-via-drag",a=>{let o=a.detail,l=this.getTargetFraction(o),c=this.getWindowLerp(l),d=l<.5?0:1,p=m=>{let g=this.getModel();this.setModel(Vp(g,"window",d,m))};sn(o,m=>{let g=this.getModel().window,v=this.getTargetFraction(m);p(d===0?va([c,g[1]],this.dataType,-v/(1-v)):va([g[0],c],this.dataType,1/v))})}),ce(e,"zoom-via-wheel",a=>{let o=a.detail,l=lu(o),c=this.getTargetFraction(o),{dataType:d}=this,p=this.getModel(),m=va(p.window,d,c*(1-l)),g=va(p.window,d,(1-c)*l+c);this.setModel({...p,window:[m,g],range:p.range})})}getTargetFraction(e){let t=this.element.getBoundingClientRect();return(e.clientX-t.left)/t.width}getWindowLerp(e){return va(this.getModel().window,this.dataType,e)}getTargetValue(e){let t=this.getTargetFraction(e);if(!!Number.isFinite(t))return this.getWindowLerp(t)}},T_=Symbol("histogramSamplerTexture");function Vp(n,e,t,r,i=!1){let a={...n},o=n[e];if(a[e]=[o[0],o[1]],a[e][t]=r,e==="window"&&yr(r,o[1-t])*(2*t-1)<0&&(a[e][1-t]=r),e==="range"&&i){let l=[n.window[0],n.window[1]];for(let c=0;c<2;++c)yr(r,l[c])*(2*c-1)>0&&(l[c]=r);a.window=l}return a}var d5=254,Op=d5+1,L_=class extends mh{constructor(e){super(e.display,document.createElement("div"),e.visibility);this.parent=e;this.controller=this.registerDisposer(new _g(this.element,this.parent.dataType,()=>this.parent.trackable.value,e=>{this.parent.trackable.value=e}));this.dataValuesBuffer=this.registerDisposer(oo(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>{let e=new Uint8Array(Op*bi);for(let t=0;t<Op;++t)for(let r=0;r<bi;++r)e[t*bi+r]=t;return e})).value;this.lineShader=this.registerDisposer((()=>{let e=new Sr(this.gl);return rr(e),e.addTextureSampler("sampler2D","uHistogramSampler",T_),e.addOutputBuffer("vec4","out_color",0),e.addAttribute("uint","aDataValue"),e.addUniform("float","uBoundsFraction"),e.addVertexCode(`
float getCount(int i) {
  return texelFetch(uHistogramSampler, ivec2(i, 0), 0).x;
}
vec4 getVertex(float cdf, int i) {
  float x;
  if (i == 0) {
    x = -1.0;
  } else if (i == 255) {
    x = 1.0;
  } else {
    x = float(i) / 254.0 * uBoundsFraction * 2.0 - 1.0;
  }
  return vec4(x, cdf * (2.0 - uLineParams.y) - 1.0 + uLineParams.y * 0.5, 0.0, 1.0);
}
`),e.setVertexMain(`
int lineNumber = int(aDataValue);
int dataValue = lineNumber;
float cumSum = 0.0;
for (int i = 0; i <= dataValue; ++i) {
  cumSum += getCount(i);
}
float total = cumSum + getCount(dataValue + 1);
float cumSumEnd = dataValue == ${Op-1} ? cumSum : total;
if (dataValue == ${Op-1}) {
  cumSum + getCount(dataValue + 1);
}
for (int i = dataValue + 2; i < 256; ++i) {
  total += getCount(i);
}
total = max(total, 1.0);
float cdf1 = cumSum / total;
float cdf2 = cumSumEnd / total;
emitLine(getVertex(cdf1, lineNumber), getVertex(cdf2, lineNumber + 1), 1.0);
`),e.setFragmentMain(`
out_color = vec4(0.0, 1.0, 1.0, getLineAlpha());
`),e.build()})());this.regionCornersBuffer=Xo(this.gl,0,-1,1,1);this.regionShader=this.registerDisposer((()=>{let e=new Sr(this.gl);return e.addAttribute("vec2","aVertexPosition"),e.addUniform("vec2","uBounds"),e.addUniform("vec4","uColor"),e.addOutputBuffer("vec4","out_color",0),e.setVertexMain(`
gl_Position = vec4(mix(uBounds[0], uBounds[1], aVertexPosition.x) * 2.0 - 1.0, aVertexPosition.y, 0.0, 1.0);
`),e.setFragmentMain(`
out_color = uColor;
`),e.build()})());let{element:t}=this;t.classList.add("neuroglancer-invlerp-cdfpanel")}get drawOrder(){return 100}drawIndirect(){let{lineShader:e,gl:t,regionShader:r,parent:{dataType:i,trackable:{value:a}}}=this;this.setGLLogicalViewport(),t.clearColor(0,0,0,0),t.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.enable(WebGL2RenderingContext.BLEND),t.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),t.disable(WebGL2RenderingContext.DEPTH_TEST),t.disable(WebGL2RenderingContext.STENCIL_TEST);{r.bind(),t.uniform4f(r.uniform("uColor"),.2,.2,.2,1);let o=Or(a.window,a.range[0]),l=Or(a.window,a.range[1]),c=Tc(i,a.window);t.uniform2f(r.uniform("uBounds"),Math.min(o,l)*c,Math.max(o,l)*c+(1-c));let d=r.attribute("aVertexPosition");this.regionCornersBuffer.bindToVertexAttrib(d,2,WebGL2RenderingContext.FLOAT),t.drawArrays(WebGL2RenderingContext.TRIANGLE_FAN,0,4),t.disableVertexAttribArray(d)}if(this.parent.histogramSpecifications.producerVisibility.visible){let{renderViewport:o}=this;e.bind(),ar(e,{width:o.logicalWidth,height:o.logicalHeight},1);let l=e.textureUnit(T_);t.uniform1f(e.uniform("uBoundsFraction"),Tc(i,a.window)),t.activeTexture(WebGL2RenderingContext.TEXTURE0+l),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,this.parent.texture),so(t);let c=e.attribute("aDataValue");this.dataValuesBuffer.bindToVertexAttribI(c,1,WebGL2RenderingContext.UNSIGNED_BYTE),ir(t,Op,1),t.disableVertexAttribArray(c),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}t.disable(WebGL2RenderingContext.BLEND)}isReady(){return!0}};function p5(){}var k_=class extends mh{constructor(e){super(e.display,document.createElement("div"),e.visibility);this.parent=e;this.cornersBuffer=Xo(this.gl,-1,-1,1,1);let{element:t}=this;t.classList.add("neuroglancer-invlerp-legend-panel");let r=this.shaderOptions=e.legendShaderOptions;this.shaderGetter=ti(this,this.gl,{...r,memoizeKey:{id:"colorLegendShader",base:r.memoizeKey},defineShader:(i,a,o)=>{i.addOutputBuffer("vec4","v4f_fragData0",0),i.addAttribute("vec2","aVertexPosition"),i.addUniform("float","uLegendOffset"),i.addVarying("float","vLinearPosition"),i.setVertexMain(`
gl_Position = vec4(aVertexPosition, 0.0, 1.0);
vLinearPosition = -uLegendOffset + ((aVertexPosition.x + 1.0) * 0.5) * (1.0 + 2.0 * uLegendOffset);
`);let l=this.parent.dataType,c=_t(l);i.addFragmentCode(XD(i,"ng_colorLegendLerp",l)),i.addFragmentCode(`
void emit(vec4 v) {
  v4f_fragData0 = v;
}
${c} getDataValue() {
  return ng_colorLegendLerp(vLinearPosition);
}
${c} getDataValue(int dummyChannel) {
  return getDataValue();
}
${c} getInterpolatedDataValue() {
  return getDataValue();
}
${c} getInterpolatedDataValue(int dummyChannel) {
  return getDataValue();
}
`),r.defineShader(i,a,o)}})}drawIndirect(){let e=this.shaderGetter(p5),{shader:t}=e;if(t===null)return;this.setGLLogicalViewport();let{gl:r}=this;r.clearColor(0,0,0,0),r.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.bind(),this.shaderOptions.initializeShader(e),r.enable(WebGL2RenderingContext.BLEND);let{trackable:{value:{window:i}},dataType:a}=this.parent;io(t,"ng_colorLegendLerp",this.parent.dataType,i);let o=wE(a,i);r.uniform1f(t.uniform("uLegendOffset"),Number.isFinite(o)?o:0),r.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),r.disable(WebGL2RenderingContext.DEPTH_TEST),r.disable(WebGL2RenderingContext.STENCIL_TEST);let l=t.attribute("aVertexPosition");this.cornersBuffer.bindToVertexAttrib(l,2,WebGL2RenderingContext.FLOAT),r.drawArrays(WebGL2RenderingContext.TRIANGLE_FAN,0,4),r.disableVertexAttribArray(l)}isReady(){return!0}};function E_(n,e){let t=document.createElement("input");return t.addEventListener("focus",()=>{t.select()}),t.classList.add("neuroglancer-invlerp-widget-bound"),t.classList.add(`neuroglancer-invlerp-widget-${n}-bound`),t.type="text",t.spellcheck=!1,t.autocomplete="off",t.title=n==="range"?`Data value that maps to ${e}`:`${e===0?"Lower":"Upper"} bound for distribution`,t}function D_(n,e,t){let r=document.createElement("div");r.classList.add("neuroglancer-invlerp-widget-bounds"),r.classList.add(`neuroglancer-invlerp-widget-${n}-bounds`);let i=[E_(n,0),E_(n,1)];for(let o=0;o<2;++o){let l=i[o];l.addEventListener("input",()=>{P_(l)}),l.addEventListener("change",()=>{let c=t.value,d=c[n];try{let p=eo(e,l.value);t.value=Vp(c,n,o,p,!0)}catch{MC(l,d[o])}})}let a;return r.appendChild(i[0]),r.appendChild(i[1]),n==="range"&&(a=[document.createElement("div"),document.createElement("div"),document.createElement("div")],a[1].classList.add("neuroglancer-invlerp-widget-range-spacer"),r.insertBefore(a[0],i[0]),r.insertBefore(a[1],i[1]),r.appendChild(a[2])),{container:r,inputs:i,spacers:a}}function P_(n){xn(n,Math.max(1,n.value.length+.1))}function MC(n,e){let t;e instanceof X||Number.isInteger(e)?t=e.toString():t=e.toPrecision(6),n.value=t,P_(n)}function I_(n){let e=n.value,{range:t}=e;n.value={...e,range:[t[1],t[0]]}}function f5(n,e,t){let r=e.value,i=va(r.range,n,.5-t/2),a=va(r.range,n,.5+t/2);e.value={...r,range:[i,a]}}function h5(n,e,t,r,i){let a=Math.exp(i),o=e.value,l=va(t,n,.5-a/2+r),c=va(t,n,.5+a/2+r);e.value={...o,range:[l,c]}}var Vg=class extends Vt{constructor(e,t,r,i,a,o,l){super(e);this.display=t;this.dataType=r;this.trackable=i;this.histogramSpecifications=a;this.histogramIndex=o;this.legendShaderOptions=l;this.cdfPanel=this.registerDisposer(new L_(this));this.boundElements={range:D_("range",this.dataType,this.trackable),window:D_("window",this.dataType,this.trackable)};this.registerDisposer(a.visibility.add(this.visibility));let{element:c,boundElements:d}=this;if(l!==void 0){let m=this.registerDisposer(new k_(this));c.appendChild(m.element)}let p=m=>{let g=He({svg:m,title:"Invert range",onClick:()=>{this.invertRange()}});return d.range.spacers[1].appendChild(g),g};this.invertArrows=[p(cm),p(lm)],c.appendChild(d.range.container),c.appendChild(this.cdfPanel.element),c.classList.add("neuroglancer-invlerp-widget"),c.appendChild(d.window.container),this.updateView(),this.registerDisposer(i.changed.add(this.registerCancellable(We(()=>this.updateView()))))}get texture(){return this.histogramSpecifications.getFramebuffers(this.display.gl)[this.histogramIndex].colorBuffers[0].texture}invertRange(){I_(this.trackable)}updateView(){let{boundElements:e}=this,{trackable:{value:t},dataType:r}=this;for(let m=0;m<2;++m)MC(e.range.inputs[m],t.range[m]),MC(e.window.inputs[m],t.window[m]);let i=yr(t.range[0],t.range[1])>0;e.range.container.style.flexDirection=i?"row-reverse":"row";let a=qs(t.window,t.range),o=e.range.spacers,l=Tc(r,t.window),c=Or(t.window,a[i?1:0])*l,d=Or(t.window,a[i?0:1])*l+(1-l);o[i?2:0].style.width=`${c*100}%`,o[i?0:2].style.width=`${(1-d)*100}%`;let{invertArrows:p}=this;p[i?1:0].style.display="",p[i?0:1].style.display="none"}},RC=class extends Vt{constructor(e,t,r,i,a,o,l){super(e);this.display=t;this.watchableDataType=r;this.trackable=i;this.histogramSpecifications=a;this.histogramIndex=o;this.legendShaderOptions=l;this.invlerpWidget=this.makeInvlerpWidget(),this.registerDisposer(r.changed.add(()=>{Ie(this.element),this.invlerpWidget.dispose(),this.invlerpWidget=this.makeInvlerpWidget()}))}get dataType(){return this.watchableDataType.value}disposed(){this.invlerpWidget.dispose(),super.disposed()}makeInvlerpWidget(){let{dataType:e}=this,t=new Vg(this.visibility,this.display,e,this.trackable,this.histogramSpecifications,this.histogramIndex,this.legendShaderOptions);return this.element.appendChild(t.element),t}},m5=Me.fromObject({"at:shift+wheel":{action:"adjust-contrast-via-wheel"},"at:shift+mousedown0":{action:"adjust-via-drag"},"at:shift+mousedown2":{action:"invert-range"}});function Og(n,e){n.bindInputEventMap(m5),n.bindAction("adjust-contrast-via-wheel",t=>{t.stopPropagation();let r=lu(t.detail);f5(e.dataType,e.trackable,r)}),n.bindAction("adjust-via-drag",t=>{t.stopPropagation();let r=t.detail.screenX,i=t.detail.screenY,a=e.trackable.value.range,o=a,l=r,c=i;sn(t.detail,d=>{let p=e.trackable.value.range,m=d.screenX,g=d.screenY;ui(e.dataType,p,o)||(a=p,r=l,i=c),h5(e.dataType,e.trackable,a,(g-i)*2/screen.height,(m-r)*4/screen.width),o=e.trackable.value.range,l=m,c=g})}),n.bindAction("invert-range",t=>{t.stopPropagation(),I_(e.trackable)})}var Ng="mergeSegments",Bg="splitSegments",g5=Me.fromObject({"at:shift?+mousedown0":{action:"merge-segments"},"at:shift?+mousedown2":{action:"set-anchor"}}),y5=Me.fromObject({"at:shift?+mousedown0":{action:"split-segments"},"at:shift?+alt+mousedown0":{action:"split-and-select-segments"},"at:shift?+mousedown2":{action:"set-anchor"}}),A_=class extends Gr{constructor(e){super(e);this.lastAnchorBaseSegment=new Ee(void 0);let t=()=>{let r=e.anchorSegment.value;if(r===void 0)return;let{segmentSelectionState:i}=e.displayState;if(!i.hasSelectedSegment)return;let{segmentEquivalences:a}=e.displayState.segmentationGroupState.value,o=a.get(r);if(!X.equal(i.selectedSegment,o))return;let l=i.baseSelectedSegment,c=Oc(l),d=a.disjointSets.visibleSegmentEquivalencePolicy.value;d&Kt.NONREPRESENTATIVE_EXCLUDED&&c||d&Kt.REPRESENTATIVE_EXCLUDED&&!c||(this.lastAnchorBaseSegment.value=l.clone())};this.registerDisposer(e.displayState.segmentSelectionState.changed.add(t)),this.registerDisposer(e.anchorSegment.changed.add(t))}toJSON(){return Ng}activate(e){let t=this.layer.displayState.segmentationGroupState.value,r=()=>{let d=this.layer.anchorSegment.value,p=this.lastAnchorBaseSegment.value;if(d===void 0)return{anchorSegment:void 0,error:"Select anchor segment for merge"};let m=t.segmentEquivalences.get(d);return t.visibleSegments.has(m)?p===void 0||!X.equal(t.segmentEquivalences.get(p),m)?{anchorSegment:d,error:"Hover over base segment within anchor segment that is closest to merge location"}:{anchorSegment:p,error:void 0}:{anchorSegment:d,error:"Anchor segment must be in visible set"}},i=()=>{let{anchorSegment:d,error:p}=r();if(d===void 0||p!==void 0)return{anchorSegment:d,error:p,otherSegment:void 0,anchorSegmentValid:!1};let{displayState:m}=this.layer,g=m.segmentSelectionState.baseValue;return g===void 0||X.equal(m.segmentSelectionState.selectedSegment,t.segmentEquivalences.get(d))?{anchorSegment:d,otherSegment:void 0,error:"Hover over segment to merge",anchorSegmentValid:!0}:{anchorSegment:d,otherSegment:g,error:void 0,anchorSegmentValid:!0}},{body:a,header:o}=Oa(e);o.textContent="Merge segments",a.classList.add("neuroglancer-merge-segments-status"),e.bindInputEventMap(g5),e.registerDisposer(()=>{xl(t)});let l=()=>{Ie(a);let{displayState:d}=this.layer,{anchorSegment:p,otherSegment:m,anchorSegmentValid:g,error:v}=i(),b=C=>{let T=wl(this.layer.displayState,C);return T.classList.add("neuroglancer-segment-list-entry-double-line"),T};if(p!==void 0&&a.appendChild(b(_a(d,p))),v!==void 0){let C=document.createElement("span");C.textContent=v,a.appendChild(C)}if(m!==void 0){let C=document.createElement("span");C.textContent=" merge ",a.appendChild(C),a.appendChild(b(_a(d,m)))}let{segmentEquivalences:x}=t;if(g){t.useTemporaryVisibleSegments.value=!0;let C=t.temporaryVisibleSegments;C.clear(),C.add(x.get(p)),m!==void 0&&C.add(x.get(m))}else{xl(t);return}};l(),e.registerDisposer(ss(this.layer.displayState,a));let c=e.registerCancellable(We(l));ls(this.layer.displayState,e,c),e.registerDisposer(this.layer.anchorSegment.changed.add(c)),e.registerDisposer(this.lastAnchorBaseSegment.changed.add(c)),e.bindAction("merge-segments",d=>{d.stopPropagation(),(async()=>{let{graph:{value:p}}=t;if(p===void 0)return;let{anchorSegment:m,otherSegment:g,error:v}=i();if(!(m===void 0||g===void 0||v!==void 0))try{await p.merge(m,g),Ce.showTemporaryMessage("Merge performed")}catch(b){Ce.showTemporaryMessage(`Merge failed: ${b}`)}})()}),e.bindAction("set-anchor",d=>{d.stopPropagation();let{segmentSelectionState:p}=this.layer.displayState,m=p.baseValue;if(m===void 0)return;let g=this.layer.anchorSegment.value;if(t.visibleSegments.add(m),g===void 0||!X.equal(g,m)){this.layer.anchorSegment.value=m.clone();return}})}get description(){return"merge"}},M_=class extends Gr{toJSON(){return Bg}activate(e){let t=this.layer.displayState.segmentationGroupState.value,r=()=>{let p=this.layer.anchorSegment.value;if(p===void 0)return{anchorSegment:void 0,error:"Select anchor segment for split"};let m=t.segmentEquivalences.get(p);return t.visibleSegments.has(m)?{anchorSegment:p,error:void 0}:{anchorSegment:p,error:"Anchor segment must be in visible set"}},{body:i,header:a}=Oa(e);a.textContent="Split segments",i.classList.add("neuroglancer-merge-segments-status"),e.bindInputEventMap(y5);let o=()=>{let{anchorSegment:p,error:m}=r();if(p===void 0||m!==void 0)return{anchorSegment:p,error:m,otherSegment:void 0,anchorSegmentValid:!1};let{displayState:g}=this.layer,v=g.segmentSelectionState.baseValue;return v===void 0||!X.equal(g.segmentSelectionState.selectedSegment,t.segmentEquivalences.get(p))||X.equal(v,p)?{anchorSegment:p,otherSegment:void 0,anchorSegmentValid:!0,error:"Hover over base segment to seed split"}:{anchorSegment:p,otherSegment:v,anchorSegmentValid:!0,error:void 0}};e.registerDisposer(()=>{xl(t)});let l=()=>{Ie(i);let{displayState:p}=this.layer,{anchorSegment:m,otherSegment:g,anchorSegmentValid:v,error:b}=o(),x,C;(()=>{let{segmentEquivalences:P}=t,{graphConnection:{value:M}}=this.layer;if(!v||M===void 0){xl(t);return}else{if(t.useTemporaryVisibleSegments.value=!0,g!==void 0){let E=M.computeSplit(m,g);if(E!==void 0){x=new qi(m,E.includeRepresentative),C=new qi(g,E.excludeRepresentative),t.useTemporarySegmentEquivalences.value=!0;let V=E.includeRepresentative,O=E.excludeRepresentative,B=t.temporarySegmentEquivalences;B.clear();for(let _ of E.includeBaseSegments)B.link(_,V);for(let _ of E.excludeBaseSegments)B.link(_,O);let z=t.temporaryVisibleSegments;z.clear(),z.add(V),z.add(O);return}}t.useTemporarySegmentEquivalences.value=!1;let D=t.temporaryVisibleSegments;D.clear(),D.add(P.get(m))}})();let I=P=>{let M=wl(this.layer.displayState,P);return M.classList.add("neuroglancer-segment-list-entry-double-line"),M};if(m!==void 0&&i.appendChild(I(x!=null?x:_a(p,m))),b!==void 0){let P=document.createElement("span");P.textContent=b,i.appendChild(P)}if(C!==void 0){let P=document.createElement("span");P.textContent=" split ",i.appendChild(P),i.appendChild(I(C))}};e.registerDisposer(ss(this.layer.displayState,i)),l();let c=e.registerCancellable(We(l));ls(this.layer.displayState,e,c),e.registerDisposer(this.layer.anchorSegment.changed.add(c));let d=async p=>{let{graph:{value:m}}=t;if(m===void 0)return;let{anchorSegment:g,otherSegment:v,error:b}=o();if(!(g===void 0||v===void 0||b!==void 0))try{await m.split(g,v),p&&t.visibleSegments.add(t.segmentEquivalences.get(v)),Ce.showTemporaryMessage("Split performed")}catch(x){Ce.showTemporaryMessage(`Split failed: ${x}`)}};e.bindAction("split-segments",p=>{p.stopPropagation(),d(!1)}),e.bindAction("split-and-select-segments",p=>{p.stopPropagation(),d(!0)}),e.bindAction("set-anchor",p=>{p.stopPropagation();let{segmentSelectionState:m}=this.layer.displayState,g=m.baseValue;if(g===void 0)return;t.visibleSegments.add(g);let v=this.layer.anchorSegment.value;if(v===void 0||!X.equal(v,g)){this.layer.anchorSegment.value=g.clone();return}})}get description(){return"split"}};function R_(){wi(Qt,Ng,n=>new A_(n)),wi(Qt,Bg,n=>new M_(n))}var Ug="selectSegments",_C="mousedown0",v5=Me.fromObject({[`at:alt?+shift?+${_C}`]:"drag-select-segments"}),kr;(function(r){r[r.IDLE=0]="IDLE",r[r.SELECT=1]="SELECT",r[r.DESELECT=2]="DESELECT"})(kr||(kr={}));var __=class extends Gr{constructor(e){super(e)}toJSON(){return Ug}activate(e){let{layer:t}=this,{body:r,header:i}=Oa(e),a=0,o=!1;e.bindInputEventMap(v5);let l=()=>Lp.value&Tt.ALT?2:1,c=g=>{a!==g&&(a=g,o=!1,d())},d=()=>{Ie(r);let g=document.createElement("span");switch(a){case 0:i.textContent="Select/Deselect segments",g.textContent=`${_C} to select segments; alt+${_C} to deselect segments.`;break;case 1:case 2:i.textContent=`${a==1?"Select":"Deselect"} segments`,g.textContent=`Drag to ${a==1?"select":"deselect"} segments (${t.displayState.segmentationGroupState.value.visibleSegments.size} selected).`}r.appendChild(g)};d();let p=()=>{if(a==0)return;let{segmentSelectionState:g}=t.displayState;if(g.hasSelectedSegment){let v=g.selectedSegment,{visibleSegments:b}=t.displayState.segmentationGroupState.value;switch(a){case 1:b.add(v);break;case 2:b.delete(v);break}}};e.registerDisposer(t.displayState.segmentSelectionState.changed.add(()=>{o&&p()})),e.registerDisposer(t.displayState.segmentationGroupState.value.visibleSegments.changed.add(d)),e.registerDisposer(Lp.changed.add(()=>{a!=0&&c(l())}));let m=(g,v)=>{g.stopPropagation(),c(v),p();let b=g.detail.screenX,x=g.detail.screenY;sn(g.detail,(C,T,I)=>{if(!o){let P=C.screenX-b,M=C.screenY-x;P*P+M*M>25&&(p(),o=!0)}},C=>{o=!1,c(0)})};e.bindAction("drag-select-segments",g=>m(g,l()))}get description(){return"select"}};function V_(){wi(Qt,Ug,n=>new __(n))}var S5=new X,N_=class extends j{constructor(e,t,r,i){super();this.query=e;this.segmentPropertyMap=t;this.segmentationDisplayState=r;this.parentElement=i;this.changed=new ze;this.explicitSegmentsVisible=!1;this.visibleSegmentsGeneration=-1;this.queryResult=new Ee(void 0);this.statusText=new Ee("");this.selectedMatches=0;this.matchStatusTextPrefix="";this.debouncedUpdate=(0,Fg.default)(()=>this.update(),0);this.render=e=>{let{explicitSegments:t}=this,r,i=!1;if(t!==void 0&&e<t.length)r=t[e],i=this.explicitSegmentsVisible;else{t!==void 0&&(e-=t.length),r=S5;let o=this.queryResult.value.indices[e],{ids:l}=this.segmentPropertyMap.segmentPropertyMap.inlineProperties;r.low=l[o*2],r.high=l[o*2+1]}let a=this.segmentWidgetFactory.get(r);return i&&(a.dataset.visibleList="true"),a};this.update(),this.registerDisposer(r.segmentationGroupState.value.visibleSegments.changed.add(this.debouncedUpdate)),this.registerDisposer(e.changed.add(this.debouncedUpdate))}get numMatches(){var e,t;return(t=(e=this.queryResult.value)==null?void 0:e.count)!=null?t:0}update(){var b;let e=this.query.value,{segmentPropertyMap:t}=this,r=this.queryResult.value,i;if(this.prevQuery===e)i=r;else{let x=q1(t,e);i=Y1(t,x)}let a=[],o=!1,l="",{visibleSegments:c}=this.segmentationDisplayState.segmentationGroupState.value,d=c.changed.count,p=this.visibleSegmentsGeneration,m=eA(i.query);if(m){if(p!==d||this.explicitSegments===void 0||!this.explicitSegmentsVisible){this.visibleSegmentsGeneration=d;let x=Array.from(c,T=>T.clone());x.sort(X.compare);let{explicitSegments:C}=this;C===void 0?(this.explicitSegments=x,a.push({retainCount:0,insertCount:x.length,deleteCount:0})):a.push(...VL(C,x,X.compare)),this.explicitSegments=x,o=!0}else a.push({retainCount:this.explicitSegments.length,deleteCount:0,insertCount:0});this.explicitSegmentsVisible=!0}else this.visibleSegmentsGeneration=d,this.explicitSegments!==void 0&&this.explicitSegmentsVisible&&(a.push({deleteCount:this.explicitSegments.length,retainCount:0,insertCount:0}),this.explicitSegments=void 0,o=!0),this.explicitSegmentsVisible=!1;let{explicitIds:g}=i;if(g!==void 0?this.explicitSegments=g:this.explicitSegmentsVisible||(this.explicitSegments=void 0),r!==i&&(a.push({retainCount:0,deleteCount:(b=r==null?void 0:r.count)!=null?b:0,insertCount:i.count}),o=!0,this.queryResult.value=i),i.explicitIds!==void 0?l=`${i.count} ids`:m?l=`${i.count} listed ids`:i.total>0&&(l=`${i.count}/${i.total} matches`),r!==i||d!==p){let x=l,C=0;t!==void 0&&i.count>0&&(C=Z1(t,i,c),x+=` (${C} visible)`),this.selectedMatches=C,this.statusText.value=x}this.prevQuery=e,this.matchStatusTextPrefix=l;let{explicitSegments:v}=this;this.length=(this.explicitSegmentsVisible?v.length:0)+i.count,o&&this.changed.dispatch(a)}updateRendering(e){this.segmentWidgetFactory.update(e)}updateRenderedItems(e){e.forEachRenderedItem(t=>{this.updateRendering(t)})}},B_=Me.fromObject({enter:{action:"toggle-listed"},"shift+enter":{action:"hide-listed"},"control+enter":{action:"hide-all"},escape:{action:"cancel"}}),b5=100;function U_(n){xn(n,Math.max(1,n.value.length+.1))}function VC(n,e){let t;if(Number.isInteger(e))t=e.toString();else{let r=e.toString(),i=e.toPrecision(6);t=r.length<i.length?r:i}n.value=t,U_(n)}function x5(n,e){let t=document.createElement("input");return t.addEventListener("focus",()=>{t.select()}),t.classList.add(`neuroglancer-segment-query-result-numerical-plot-${n}-bound`),t.classList.add("neuroglancer-segment-query-result-numerical-plot-bound"),t.type="text",t.spellcheck=!1,t.autocomplete="off",t.title=(e===0?"Lower":"Upper")+" bound "+(n==="range"?"range":"for distribution"),t.addEventListener("input",()=>{U_(t)}),t}function C5(n,e,t){if(n===void 0||n.indices===void 0)return;let r=n.query,{sortBy:i,includeColumns:a}=r;$m(r,t)?(i=i.filter(l=>l.fieldId!==t),a=a.filter(l=>l!==t)):a.push(t),e({...r,sortBy:i,includeColumns:a})}function F_(n,e,t){var d;let r=n==null?void 0:n.query,i=r==null?void 0:r.sortBy;if(i===void 0)return;let{includeColumns:a}=r,l=((d=i.find(p=>p.fieldId===t))==null?void 0:d.order)==="<"?">":"<",c=a.filter(p=>p!==t);for(let p of i)p.fieldId!=="id"&&p.fieldId!=="label"&&p.fieldId!==t&&c.push(p.fieldId);e({...r,sortBy:[{fieldId:t,order:l}],includeColumns:c})}function G_(n,e,t){var a,o;let r=(a=n==null?void 0:n.query)==null?void 0:a.sortBy,i=(o=r==null?void 0:r.find(l=>l.fieldId===t))==null?void 0:o.order;e.textContent=i===">"?"\u25BC":"\u25B2",e.style.visibility=i===void 0?"":"visible",e.title=`Sort by ${t} in ${i==="<"?"descending":"ascending"} order`}var W_=class extends j{constructor(e,t,r){super();this.segmentPropertyMap=e;this.queryResult=t;this.setQuery=r;this.propertyHistograms=[];this.bounds={window:new Ee([]),range:new Ee([])};this.throttledUpdate=this.registerCancellable((0,O_.default)(()=>this.updateHistograms(),100));this.debouncedRender=this.registerCancellable(We(()=>this.updateHistogramRenderings()));this.debouncedSetQuery=this.registerCancellable((0,Fg.default)(()=>this.setQueryFromBounds(),200));let i=e==null?void 0:e.numericalProperties,a=[],o;if(i!==void 0&&i.length>0){o=document.createElement("details");let l=document.createElement("summary");l.textContent=`${i.length} numerical propert${i.length>1?"ies":"y"}`,o.appendChild(l),o.classList.add("neuroglancer-segment-query-result-numerical-list");let c=this.bounds.window.value;for(let d=0,p=i.length;d<p;++d){let m=i[d],g=this.makeNumericalPropertySummary(d,m);a.push(g),o.appendChild(g.element),c[d]=m.bounds}}this.listElement=o,this.properties=a,this.registerDisposer(this.queryResult.changed.add(()=>{this.handleNewQueryResult()})),this.registerDisposer(this.bounds.window.changed.add(this.throttledUpdate)),this.registerDisposer(this.bounds.window.changed.add(this.debouncedRender)),this.registerDisposer(this.bounds.range.changed.add(this.debouncedRender)),this.registerDisposer(this.bounds.range.changed.add(this.debouncedSetQuery)),this.handleNewQueryResult()}setQueryFromBounds(){let e=this.queryResult.value;if(e===void 0||e.indices===void 0)return;let t=e.query,r=[],i=this.bounds.range.value,{properties:a}=this;for(let o=0,l=a.length;o<l;++o){let c=a[o].property;r.push({fieldId:c.id,bounds:i[o]})}this.setQuery({...t,numericalConstraints:r})}getBounds(e){let{bounds:t}=this;return{range:t.range.value[e],window:t.window.value[e]}}setBounds(e,t){let{property:r}=this.properties[e],i=qs(r.bounds,t.range);yr(i[0],i[1])>0&&(i=[i[1],i[0]]);let a=qs(r.bounds,t.window),o=this.getBounds(e),{dataType:l}=this.properties[e].property;ui(l,a,o.window)||(this.bounds.window.value[e]=a,this.bounds.window.changed.dispatch()),ui(l,i,o.range)||(this.bounds.range.value[e]=i,this.bounds.range.changed.dispatch())}setBound(e,t,r,i){let o=this.segmentPropertyMap.numericalProperties[r].bounds;i=Js(o,i);let l=this.getBounds(r),c=Vp(l,e,t,i,!0);this.setBounds(r,c)}handleNewQueryResult(){let e=this.queryResult.value,{listElement:t}=this;if(t!==void 0){if((e==null?void 0:e.indices)!==void 0){let{numericalConstraints:r}=e.query,{numericalProperties:i}=this.segmentPropertyMap,a=this.bounds.range.value,o=r.length,l=i.length;a.length=l;for(let c=0;c<l;++c)a[c]=i[c].bounds;for(let c=0;c<o;++c){let d=r[c],p=i.findIndex(m=>m.id===d.fieldId);a[p]=d.bounds}}this.updateHistograms(),this.throttledUpdate.cancel()}}updateHistograms(){let e=this.queryResult.value,{listElement:t}=this;t!==void 0&&(K1(this.segmentPropertyMap,e,this.propertyHistograms,this.bounds.window.value),this.updateHistogramRenderings())}updateHistogramRenderings(){this.debouncedRender.cancel();let{listElement:e}=this;if(e===void 0)return;let{propertyHistograms:t}=this;if(t.length===0){e.style.display="none";return}e.style.display="";let{properties:r}=this;for(let i=0,a=r.length;i<a;++i)this.updateNumericalPropertySummary(i,r[i],t[i])}makeNumericalPropertySummary(e,t){let r=document.createElement("div");r.classList.add("neuroglancer-segment-query-result-numerical-plot-container");let i=document.createElement("img");i.classList.add("neuroglancer-segment-query-result-numerical-plot");let a=new _g(i,t.dataType,()=>this.getBounds(e),p=>this.setBounds(e,p)),o=document.createElement("span");o.classList.add("neuroglancer-segment-query-result-numerical-plot-sort");let l=document.createElement("input");l.type="checkbox",l.addEventListener("click",()=>{C5(this.queryResult.value,this.setQuery,t.id)});let c=p=>{let m=document.createElement("div");m.classList.add("neuroglancer-segment-query-result-numerical-plot-bounds"),m.classList.add(`neuroglancer-segment-query-result-numerical-plot-bounds-${p}`);let g=x=>{let C=x5(p,x);return C.addEventListener("change",()=>{if(this.bounds[p].value[e]!==void 0){try{let I=eo(t.dataType,C.value);this.setBound(p,x,e,I),this.bounds[p].changed.dispatch()}catch{}VC(C,this.bounds[p].value[e][x])}}),C},v=[g(0),g(1)],b;if(p==="range"){b=[document.createElement("div"),document.createElement("div"),document.createElement("div")],b[1].classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-spacer"),b[1].appendChild(l);let x=document.createElement("span");x.classList.add("neuroglancer-segment-query-result-numerical-plot-label"),x.appendChild(document.createTextNode(t.id)),x.appendChild(o),x.addEventListener("click",()=>{F_(this.queryResult.value,this.setQuery,t.id)}),b[1].appendChild(x);let{description:C}=t;C&&(b[1].title=C),m.appendChild(b[0]),m.appendChild(v[0]);let T=document.createElement("div");T.textContent="\u2264",T.classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-symbol"),m.appendChild(T),m.appendChild(b[1]);let I=document.createElement("div");I.textContent="\u2264",I.classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-symbol"),m.appendChild(I),m.appendChild(v[1]),m.appendChild(b[2])}else m.appendChild(v[0]),m.appendChild(v[1]);return{container:m,spacers:b,inputs:v}},d={range:c("range"),window:c("window")};return r.appendChild(d.range.container),r.appendChild(i),r.appendChild(d.window.container),{property:t,controller:a,element:r,plotImg:i,boundElements:d,bounds:{window:[NaN,NaN],range:[NaN,NaN]},propertyHistogram:void 0,columnCheckbox:l,sortIcon:o}}updateNumericalPropertySummary(e,t,r){let i=t.bounds.window,a=this.bounds.window.value[e],o=t.bounds.range,l=this.bounds.range.value[e],{property:c}=t,d=this.queryResult.value,p=$m(d==null?void 0:d.query,c.id);if(t.columnCheckbox.checked=p,t.columnCheckbox.title=p?"Remove column from result table":"Add column to result table",G_(d,t.sortIcon,c.id),t.propertyHistogram===r&&ui(c.dataType,i,a)&&ui(c.dataType,o,l))return;let{histogram:m}=r,g="http://www.w3.org/2000/svg",v=document.createElementNS(g,"svg");v.setAttribute("width","1"),v.setAttribute("height","1"),v.setAttribute("preserveAspectRatio","none");let b=document.createElementNS(g,"rect"),x=Or(a,l[0]),C=Or(a,l[1]);b.setAttribute("x",`${x}`),b.setAttribute("y","0"),b.setAttribute("width",`${C-x}`),b.setAttribute("height","1"),b.setAttribute("fill","#4f4f4f"),v.appendChild(b);let T=m.length,I=(B,z,_)=>{let U=document.createElementNS(g,"polyline"),N="",J=0;for(let le=B;le<_;++le)J+=m[le];if(J===0)return;let ie=Or(a,r.window[0]),pe=Or(a,r.window[1]),me=(le,we)=>{let Re=le/(T-2);N+=` ${ie*(1-Re)+pe*Re},${1-we}`};B!==0&&me(B,0);let Pe=0;for(let le=B;le<z;++le)Pe+=m[le],me(le,Pe/J);return U.setAttribute("fill","none"),U.setAttribute("stroke-width","1px"),U.setAttribute("points",N),U.setAttribute("vector-effect","non-scaling-stroke"),U};{let B=I(0,T-1,T);B!==void 0&&(B.setAttribute("stroke","cyan"),v.appendChild(B))}if(!ui(c.dataType,c.bounds,l)){let B=Math.floor(Math.max(0,Math.min(1,Or(r.window,l[0])))*(T-2)),z=Math.ceil(Math.max(0,Math.min(1,Or(r.window,l[1])))*(T-2)),_=I(B,z,z);_!==void 0&&(_.setAttribute("stroke","white"),v.appendChild(_))}let P=new XMLSerializer().serializeToString(v);t.plotImg.src=`data:image/svg+xml;base64,${btoa(P)}`,t.propertyHistogram=r;for(let B=0;B<2;++B)i[B]=a[B],VC(t.boundElements.window.inputs[B],a[B]),o[B]=l[B],VC(t.boundElements.range.inputs[B],l[B]);let M=t.boundElements.range.spacers,D=qs(a,l),E=Tc(c.dataType,a),V=Or(a,D[0])*E,O=Or(a,D[1])*E+(1-E);M[0].style.width=`${V*100}%`,M[2].style.width=`${(1-O)*100}%`}};function w5(n,e){let{tags:t}=n;if(t===void 0||t.length===0)return;let r=n.query,i=document.createElement("div");i.classList.add("neuroglancer-segment-query-result-tag-list");for(let{tag:a,count:o}of t){let l=document.createElement("div");l.classList.add("neuroglancer-segment-query-result-tag");let c=document.createElement("span");c.classList.add("neuroglancer-segment-query-result-tag-name"),c.textContent=a,i.appendChild(l);let d=r.includeTags.includes(a),p=r.excludeTags.includes(a),m;d?m="Remove tag from required set":p?m="Remove tag from excluded set":m="Add tag to required set",c.addEventListener("click",()=>{e(ix(r,a,!0,!d&&!p))}),c.title=m;let g=d||p,v=x=>{let C=x?o:n.count-o,T=document.createElement("div");if(T.classList.add("neuroglancer-segment-query-result-tag-toggle"),T.classList.add(`neuroglancer-segment-query-result-tag-${x?"include":"exclude"}`),l.appendChild(T),!g&&C===0)return;let I=x?d:p;T.appendChild(new er({get value(){return I},set value(P){e(ix(r,a,x,P))},changed:Bf},{text:x?"+":"-",enableTitle:`Add tag to ${x?"required":"exclusion"} set`,disableTitle:`Remove tag from ${x?"required":"exclusion"} set`,backgroundScheme:"dark"}).element)};v(!0),v(!1),l.appendChild(c);let b=document.createElement("span");b.classList.add("neuroglancer-segment-query-result-tag-count"),g||(b.textContent=o.toString()),l.appendChild(b)}return i}var OC=class extends Vt{constructor(e){super();this.layer=e;let{element:t}=this;t.classList.add("neuroglancer-segment-display-tab"),t.appendChild(this.registerDisposer(new Cn(e.displayState.segmentationGroupState.value.graph,(c,d,p)=>{if(c===void 0)return;let m=document.createElement("div");m.className="neuroglancer-segmentation-toolbox",m.appendChild(Al(p,e,{toolJson:Ng,label:"Merge",title:"Merge segments"})),m.appendChild(Al(p,e,{toolJson:Bg,label:"Split",title:"Split segments"})),d.appendChild(m)})).element);let r=document.createElement("div");r.className="neuroglancer-segmentation-toolbox",r.appendChild(Al(this,e,{toolJson:Ug,label:"Select",title:"Select/Deselect segments"})),t.appendChild(r);let i=document.createElement("input");i.classList.add("neuroglancer-segment-list-query"),i.addEventListener("focus",()=>{i.select()});let a=this.registerDisposer(new $t(i,B_));a.allShortcutsAreGlobal=!0;let{segmentQuery:o}=this.layer.displayState,l=this.registerCancellable((0,Fg.default)(()=>{o.value=i.value},200));i.autocomplete="off",i.title=B_.describe(),i.spellcheck=!1,i.placeholder="Enter ID, name prefix or /regexp",this.registerDisposer(_r(c=>{i.value=c},o)),this.registerDisposer(_r(c=>{Date.now()-c<100&&(setTimeout(()=>{i.focus()},0),this.layer.segmentQueryFocusTime.value=Number.NEGATIVE_INFINITY)},this.layer.segmentQueryFocusTime)),t.appendChild(i),t.appendChild(this.registerDisposer(new Cn(e.displayState.segmentPropertyMap,(c,d,p)=>{let m=le=>{i.focus(),i.select();let we=Q1(c,le);document.execCommand("insertText",!1,we),o.value=we,i.select()},g=p.registerDisposer(new N_(o,c,e.displayState,d)),v=e.displayState.segmentationGroupState.value,b=document.createElement("ul");b.classList.add("neuroglancer-segment-query-errors"),d.appendChild(b);let x=document.createElement("div");x.classList.add("neuroglancer-segment-query-result-statistics");let C=document.createElement("span"),T=document.createElement("input");T.type="checkbox",T.checked=!0,T.title="Deselect all segment IDs",T.addEventListener("change",()=>{v.visibleSegments.clear()});let I=Tr({title:"Copy visible segment IDs",onClick:()=>{let le=Array.from(v.visibleSegments,we=>we.clone());le.sort(X.compare),wr(le.join(", "))}}),P=document.createElement("span");C.appendChild(I),C.appendChild(T),C.appendChild(P);let M=document.createElement("span"),D=document.createElement("input"),E=Tr({onClick:()=>{l(),l.flush(),g.debouncedUpdate.flush();let le=g.queryResult.value;if(le===void 0)return;let we=new Array(le.count);up(c,le,(Re,Ue)=>{we[Ue]=Re.toString()}),wr(we.join(", "))}});D.type="checkbox";let V=()=>{l(),l.flush(),g.debouncedUpdate.flush();let le=g.queryResult.value;if(le===void 0)return;let{visibleSegments:we}=v,{selectedMatches:Re}=g,Ue=Re!==le.count;if(Ue&&le.count-Re>b5){if(!U)return U=!0,O.textContent=`Confirm: show ${le.count-Re} segments?`,!1;U=!1,_()}return up(c,le,et=>{we.set(et,Ue)}),!0};D.addEventListener("click",le=>{V()||le.preventDefault()});let O=document.createElement("span");M.appendChild(E),M.appendChild(D),M.appendChild(O),C.classList.add("neuroglancer-segment-list-status"),M.classList.add("neuroglancer-segment-list-status"),d.appendChild(x);let B=document.createElement("div");B.classList.add("neuroglancer-segment-query-result-statistics-separator"),d.appendChild(B),d.appendChild(M),d.appendChild(C);let z=-1,_=()=>{let le=v.visibleSegments.size;z!==le&&(z=le,P.textContent=`${le} visible in total`,T.checked=le>0,T.style.visibility=le?"visible":"hidden",I.style.visibility=le?"visible":"hidden"),O.textContent=g.statusText.value;let{numMatches:we,selectedMatches:Re}=g;E.style.visibility=we?"visible":"hidden",E.title=`Copy ${we} segment ID(s)`,D.style.visibility=we?"visible":"hidden",Re===0?(D.checked=!1,D.indeterminate=!1,D.title=`Show ${we} segment ID(s)`):Re===we?(D.checked=!0,D.indeterminate=!1,D.title=`Hide ${Re} segment ID(s)`):(D.checked=!0,D.indeterminate=!0,D.title=`Show ${we-Re} segment ID(s)`)};_(),g.statusText.changed.add(_),p.registerDisposer(v.visibleSegments.changed.add(_));let U=!1;p.registerEventListener(i,"input",()=>{l(),U&&(U=!1,_())}),p.registerDisposer(ce(i,"cancel",()=>{i.focus(),i.select(),document.execCommand("delete"),i.blur(),i.value="",o.value="",U=!1,_()})),p.registerDisposer(ce(i,"toggle-listed",V)),p.registerDisposer(ce(i,"hide-all",()=>{v.visibleSegments.clear()})),p.registerDisposer(ce(i,"hide-listed",()=>{l(),l.flush(),g.debouncedUpdate.flush();let{visibleSegments:le}=v;if(o.value==="")le.clear();else{let we=g.queryResult.value;if(we===void 0)return;up(c,we,Re=>{le.delete(Re)})}}));let N=p.registerDisposer(new Vl({source:g,horizontalScroll:!0})),J=p.registerCancellable(We(()=>{g.updateRenderedItems(N)})),{displayState:ie}=this.layer;p.registerDisposer(ie.segmentSelectionState.changed.add(J)),p.registerDisposer(v.visibleSegments.changed.add(J)),p.registerDisposer(ie.segmentColorHash.changed.add(J)),p.registerDisposer(ie.segmentStatedColors.changed.add(J)),p.registerDisposer(ie.segmentDefaultColor.changed.add(J)),N.element.classList.add("neuroglancer-segment-list"),p.registerDisposer(e.bindSegmentListWidth(N.element)),p.registerDisposer(new wn(N.element,Hc()));let pe=p.registerDisposer(new W_(c,g.queryResult,m));{let{listElement:le}=pe;le!==void 0&&x.appendChild(le)}let me,Pe=le=>{let we=le==null?void 0:le.errors;if(Ie(b),we!==void 0)for(let Re of we){let Ue=document.createElement("li");Ue.textContent=Re.message,b.appendChild(Ue)}};_r(le=>{if(g.segmentWidgetFactory=new Db(g.segmentationDisplayState,g.parentElement,Re=>$m(le==null?void 0:le.query,Re.id)),N.scrollToTop(),Ie(N.header),c!==void 0){let Re=g.segmentWidgetFactory.getHeader();Re.container.classList.add("neuroglancer-segment-list-header");for(let Ue of Re.propertyLabels){let{label:et,sortIcon:ye,id:ke}=Ue;et.addEventListener("click",()=>{F_(g.queryResult.value,m,ke)}),G_(le,ye,ke)}N.header.appendChild(Re.container)}if(Pe(le),B.style.display="none",me==null||me.remove(),le===void 0)return;let{query:we}=le;we.errors!==void 0||we.ids!==void 0||(me=w5(le,m),me!==void 0&&x.appendChild(me),(pe.properties.length>0||me!==void 0)&&(B.style.display=""))},g.queryResult),d.appendChild(N.element)})).element)}};var NC=ot(Et());var Ss=class{static insertAfter(n,e){let t=n.next0;e.next0=t,e.prev0=n,n.next0=e,t.prev0=e}static insertBefore(n,e){let t=n.prev0;e.prev0=t,e.next0=n,n.prev0=e,t.next0=e}static front(n){let e=n.next0;return e===n?null:e}static back(n){let e=n.prev0;return e===n?null:e}static pop(n){let e=n.next0,t=n.prev0;return e.prev0=t,t.next0=e,n.next0=null,n.prev0=null,n}static*iterator(n){for(let e=n.next0;e!==n;e=e.next0)yield e}static*reverseIterator(n){for(let e=n.prev0;e!==n;e=e.prev0)yield e}static initializeHead(n){n.next0=n.prev0=n}};var z_=class{constructor(){Ss.initializeHead(this)}},BC=new z_,T5=window.top===window,UC=(0,NC.default)(()=>{if(!T5)return;let{activeElement:n}=document;if(n===null||n===document.body){let e=Ss.front(BC);e!==null&&e.element.focus({preventScroll:!0})}});window.addEventListener("focus",()=>{UC()},!0);window.addEventListener("blur",()=>{UC()},!0);var xo=class extends j{constructor(e){super();this.element=e;this.prev0=null;this.next0=null;this.lastFocusedElement=null;this.scheduleUpdateFocus=this.registerCancellable((0,NC.default)(()=>{let{activeElement:e}=document,{element:t}=this;t.contains(e)||Fd(e)||(e!=null&&(e===this.lastFocusedElement||e.contains(t))&&this.element.focus({preventScroll:!0}),this.lastFocusedElement=null)},0));e.tabIndex=-1,this.registerEventListener(e,"pointerdown",t=>{t.target===e&&(this.lastFocusedElement=null,e.focus({preventScroll:!0}))}),this.registerEventListener(e,"mouseenter",()=>{this.lastFocusedElement=document.activeElement,this.scheduleUpdateFocus()}),this.registerEventListener(e,"mouseleave",()=>{this.scheduleUpdateFocus.cancel()}),Ss.insertBefore(BC,this),this.registerEventListener(e,"focus",()=>{Ss.pop(this),Ss.insertAfter(BC,this)}),UC()}disposed(){Ss.pop(this),super.disposed()}};var Gg=0,L5=Me.fromObject({escape:{action:"close"}}),Zi=class extends j{constructor(){super();this.keyMap=new Me;this.keyMap.addParent(L5,Number.NEGATIVE_INFINITY),++Gg;let e=this.container=document.createElement("div");e.className="overlay";let t=this.content=document.createElement("div");this.registerDisposer(new xo(t)),t.className="overlay-content",e.appendChild(t),document.body.appendChild(e),this.registerDisposer(new $t(this.container,this.keyMap)),this.registerEventListener(e,"action:close",()=>{this.dispose()}),t.focus()}disposed(){--Gg,document.body.removeChild(this.container),super.disposed()}};function bs(n={}){return He({text:"?",...n})}function H_(n,e,t,r){let i=document.createElement("label");i.classList.add("neuroglancer-layer-control-container");let a=document.createElement("div");a.classList.add("neuroglancer-layer-control-label-container");let o=document.createElement("div");o.classList.add("neuroglancer-layer-control-label"),a.appendChild(o);let l=document.createElement("div");l.classList.add("neuroglancer-layer-control-label-text-container"),l.appendChild(document.createTextNode(t.label)),o.appendChild(l),t.title&&(o.title=t.title),i.appendChild(a);let{control:c,controlElement:d}=t.makeControl(e,n,{labelContainer:a,labelTextContainer:l,display:e.manager.root.display,visibility:r});return d.classList.add("neuroglancer-layer-control-control"),i.appendChild(d),{controlContainer:i,label:o,labelContainer:a,labelTextContainer:l,control:c}}var Wg=class extends Gr{constructor(e,t){super(e);this.options=t}activate(e){let{options:t}=this,{layer:r}=this,{isValid:i}=t;if(i!==void 0&&!i(r).value)return;let{header:a,body:o}=Oa(e),{controlContainer:l,control:c,labelContainer:d}=H_(e,r,t,new It(It.VISIBLE));a.appendChild(d),o.appendChild(l),t.activateTool(e,c)}get description(){var t;let{options:e}=this;return(t=e.toolDescription)!=null?t:e.label}toJSON(){return this.options.toolJson}};function $_(n,e,t,r){let{controlContainer:i,label:a}=H_(n,e,t,r);return i.classList.add("neuroglancer-layer-options-control-container"),a.prepend(n.registerDisposer(new og(e,t.toolJson)).element),i}function cu(n,e,t,r){let{isValid:i}=r;return i===void 0?$_(n,e,r,t):n.registerDisposer(new Cn(i(e),(a,o,l)=>{!a||o.appendChild($_(l,e,r,t))},t)).element}function zg(n,e){let{toolJson:t}=e,r=typeof t=="string"?t:t.type;wi(n,r,i=>new Wg(i,e))}var j_=ot(Et());var Hg=class extends j{constructor(e){super();this.group=e;this.element=document.createElement("div");this.topRow=document.createElement("div");this.label=document.createElement("label");this.selectElement=document.createElement("select");this.linkedLayers=document.createElement("div");this.unlinkButton=document.createElement("button");let{element:t,label:r,topRow:i,selectElement:a,linkedLayers:o,unlinkButton:l}=this;i.appendChild(r),i.appendChild(a),i.appendChild(l),l.textContent="Unlink",l.addEventListener("click",()=>{this.group.isolate()}),t.appendChild(i),t.appendChild(o),this.updateView();let c=(0,j_.default)(()=>this.updateView(),0);this.registerEventListener(a,"change",()=>{this.updateModel(),c()}),this.registerDisposer(this.group.changed.add(c)),this.registerDisposer(this.group.linkedLayersChanged.add(c)),this.registerDisposer(this.group.layerManager.layersChanged.add(c))}updateModel(){let e=this.selectElement.value;e===""&&this.group.root.value!==this.group.layer?this.group.isolate():this.group.linkByName(e)}updateView(){var l;let{selectElement:e,group:t}=this,{predicate:r}=t;Ie(e);let i=this.group.rootGroup.linkedLayers.size!==0;this.unlinkButton.style.display=i?"":"none";let{linkedLayers:a}=this,o=t.linkedLayers.size!==0;if(a.style.display=o?"":"none",this.unlinkButton.textContent=o?"Unlink all":"Unlink",o){this.element.style.display="",e.style.display="none",Ie(a);for(let c of t.linkedLayers){let d=document.createElement("div");d.classList.add("neuroglancer-linked-layer-widget-layer");let p=jc({title:"Unlink layer",onClick:()=>{this.group.getGroup(c).isolate()}});d.appendChild(p),d.appendChild(document.createTextNode(c.managedLayer.name)),a.appendChild(d)}}else{e.style.display="";let c=document.createElement("option");e.appendChild(c);let d=0;for(let p of this.group.layerManager.managedLayers){let m=p.layer;if(m!==null&&m!==t.layer&&r(m)){++d;let g=document.createElement("option"),{name:v}=p;g.textContent=v,g.value=v,e.appendChild(g)}}e.value=(l=t.toJSON())!=null?l:"",this.element.style.display=d===0?"none":""}}};var J_='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="maximiseIconTitle"><polyline points="21 16 21 21 16 21"></polyline><polyline points="8 21 3 21 3 16"></polyline><polyline points="16 3 21 3 21 8"></polyline><polyline points="3 8 3 3 8 3"></polyline></svg>';function xs(n={}){return He({svg:J_,...n})}var m0e=ot(K_());var Fl=ot(Cs()),Z_=ot(Q_()),eV=ot(Et());(0,Z_.default)(Fl.default);var k5=500,Co=class extends j{constructor(e){super();this.state=e;this.changingValue=!1;this.debouncedValueUpdater=(0,eV.default)(()=>{this.changingValue=!0;try{this.state.fragmentMain.value=this.textEditor.getValue()}finally{this.changingValue=!1}},k5);this.textEditor=(0,Fl.default)(i=>{},{value:this.state.fragmentMain.value,mode:"glsl",gutters:["CodeMirror-lint-markers"]}),this.textEditor.on("change",()=>{this.setValidState(void 0),this.debouncedValueUpdater()}),this.registerDisposer(this.state.fragmentMain.changed.add(()=>{this.changingValue||this.textEditor.setValue(this.state.fragmentMain.value)})),this.element.classList.add("neuroglancer-shader-code-widget"),this.registerDisposer(this.state.shaderError.changed.add(()=>{this.updateErrorState()}));let{shaderControlState:t}=this.state;t!==void 0&&this.registerDisposer(t.parseErrors.changed.add(()=>{this.updateErrorState()})),this.updateErrorState();let r=new IntersectionObserver(i=>{i.some(a=>a.isIntersecting)&&this.textEditor.refresh()},{root:document.body});r.observe(this.element),this.registerDisposer(()=>r.disconnect())}get element(){return this.textEditor.getWrapperElement()}updateErrorState(){let{sourceStringNumber:e=1}=this.state,t=this.state.shaderError.value,r,{shaderControlState:i}=this.state;i!==void 0?r=i.parseErrors.value:r=[],t===void 0&&r.length===0?this.setValidState(void 0):t!=null||r.length!==0?(this.textEditor.setOption("lint",{getAnnotations:()=>{let a=[];for(let o of r)a.push({message:o.message,severity:"error",from:Fl.default.Pos(o.line)});if(t!=null)if(t.name==="ShaderCompilationError")for(let o of t.errorMessages)a.push({message:o.message,severity:"error",from:Fl.default.Pos(o.file===e&&o.line||0)});else t.name==="ShaderLinkError"?a.push({message:t.log,severity:"error",from:Fl.default.Pos(0)}):a.push({message:t.message,severity:"error",from:Fl.default.Pos(0)});return a}}),this.setValidState(!1)):(this.textEditor.setOption("lint",void 0),this.setValidState(!0))}setValidState(e){let{element:t}=this;t.classList.remove("invalid-input"),t.classList.remove("valid-input"),e===!0?t.classList.add("valid-input"):e===!1&&t.classList.add("invalid-input")}disposed(){this.debouncedValueUpdater.flush(),this.debouncedValueUpdater=void 0,Ye(this.element),this.textEditor=void 0,super.disposed()}};var qC=ot(Et());var Np="neuroglancer-position",tV=Me.fromObject({arrowup:{action:"adjust-up"},arrowdown:{action:"adjust-down"},arrowleft:{action:"maybe-tab-backward",preventDefault:!1},arrowright:{action:"maybe-tab-forward",preventDefault:!1},tab:{action:"tab-forward"},"shift+tab":{action:"tab-backward"},wheel:{action:"adjust-via-wheel"},backspace:{action:"delete-backward",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel"}}),E5=[n=>n.nameElement,n=>n.coordinate,n=>n.scaleElement];function $g(n,e){let t=n.coordinateArrays[e];return t===void 0?t:n.units[e]!=""||n.scales[e]!==1?null:t}var nV=class{constructor(e,t){this.coordinateSpace=e;this.container=document.createElement("div");this.nameContainer=document.createElement("span");this.nameElement=document.createElement("input");this.scaleContainer=document.createElement("span");this.scaleElement=document.createElement("input");this.coordinate=document.createElement("input");this.coordinateLabel=document.createElement("span");this.coordinateLabelWidth=0;this.dropdownOwner=void 0;this.modified=!1;this.draggingPosition=!1;this.hasFocus=!1;let{container:r,scaleElement:i,scaleContainer:a,coordinate:o,nameElement:l,nameContainer:c,coordinateLabel:d}=this;r.title="",r.classList.add("neuroglancer-position-dimension"),r.draggable=!0,r.tabIndex=-1,r.appendChild(c),r.appendChild(i),c.appendChild(l),c.title="Drag to reorder, double click to rename.  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",a.appendChild(i),l.classList.add("neuroglancer-position-dimension-name"),l.disabled=!0,l.spellcheck=!1,l.autocomplete="off",l.required=!0,l.placeholder=" ",a.classList.add("neuroglancer-position-dimension-scale-container"),i.classList.add("neuroglancer-position-dimension-scale"),i.disabled=!0,i.spellcheck=!1,i.autocomplete="off",r.appendChild(a),r.appendChild(o),o.type="text",o.classList.add("neuroglancer-position-dimension-coordinate"),o.spellcheck=!1,o.autocomplete="off",o.pattern=String.raw`(-?\d+(?:\.(?:\d+)?)?)`;let p=$g(e,t);if(p!=null){let m=0;for(let g of p.labels)m=Math.max(m,g.length);this.coordinateLabelWidth=m,d.style.width=`${m+2}ch`,r.appendChild(d)}o.required=!0,o.placeholder=" ",d.classList.add("neuroglancer-position-dimension-coordinate-label")}};function WC(n,e,t,r){return Math.floor((n-e)*(r-1)/(t-e))}function D5(n,e,t){let{boundingBoxes:r,bounds:i}=n,a=Math.floor(i.lowerBounds[e]),o=Math.ceil(i.upperBounds[e]-1);if(!Number.isFinite(a)||!Number.isFinite(o))return;let l=[],c=p=>WC(p,a,o,t),{rank:d}=n;for(let p of r){let m=rS(p,e,d);m!==void 0&&(m.lower=c(m.lower),m.upper=c(Math.ceil(m.upper-1)),l.push(m))}return l.sort((p,m)=>{let g=p.lower-m.lower;return g!==0?g:m.upper-m.upper}),Vf(l,(p,m)=>{if(m===0)return!0;let g=l[m-1];return g.lower!==p.lower||g.upper!==p.upper}),{lowerBound:a,upperBound:o,normalizedBounds:l}}var zC=10,HC=15,P5=10,$C=zC+HC+P5;function I5(n,e,t){e.clearRect(0,0,n.width,n.height);let{normalizedBounds:r}=t;function i(o){e.fillRect(0,o,zC,1)}e.fillStyle="#fff";for(let{lower:o,upper:l}of r)i(o),i(l);let a=r.length;e.fillStyle="#ccc";for(let o=0;o<a;++o){let{lower:l,upper:c}=r[o],d=Math.floor(o*HC/a),p=Math.max(1,HC/a);e.fillRect(d+zC,l,p,c+1-l)}}function rV(n,e){xn(n,e.length+1)}function iV(n){let{value:e}=n;xn(n),n.parentElement.dataset.isEmpty=e===""?"true":"false"}var ws=class extends j{constructor(e,t,{copyButton:r=!0}={}){super();this.position=e;this.combiner=t;this.element=document.createElement("div");this.dimensionContainer=document.createElement("div");this.coordinateSpace=void 0;this.dimensionWidgets=new Map;this.dimensionWidgetList=[];this.dragSource=void 0;let{element:i,dimensionContainer:a}=this;if(this.registerDisposer(e.coordinateSpace.changed.add(this.registerCancellable(We(()=>this.updateDimensions())))),i.className="neuroglancer-position-widget",a.style.display="contents",i.appendChild(a),r){let l=Tr({title:"Copy position to clipboard",onClick:()=>{let c=wr(this.getPositionText());Ce.showTemporaryMessage(c?"Position copied to clipboard":"Failed to copy position to clipboard")}});l.addEventListener("dragstart",c=>{c.dataTransfer.setData(Np,JSON.stringify({position:e.toJSON(),dimensions:e.coordinateSpace.value.names})),c.dataTransfer.setData("text",this.getPositionText()),c.stopPropagation()}),l.draggable=!0,i.appendChild(l)}this.registerDisposer(e.changed.add(this.registerCancellable(We(()=>this.updateView()))));let o=this.registerDisposer(new $t(i,tV));o.allShortcutsAreGlobal=!0,this.registerDisposer(new wn(i,tV)),this.registerDisposer(ce(i,"cancel",l=>{this.coordinateSpace=void 0,this.updateView(),this.closeDropdown();let{target:c}=l;c instanceof HTMLElement&&c.blur()})),this.updateView()}openRegularDropdown(e,t){t.classList.add("neuroglancer-position-dimension-dropdown");let r=document.createElement("canvas"),i=r.getContext("2d"),a=document.createElement("div"),o=document.createElement("div");o.appendChild(a);let l=document.createTextNode("");a.appendChild(l);let c=document.createElement("div"),d=document.createElement("div");o.classList.add("neuroglancer-position-dimension-dropdown-lowerbound"),c.classList.add("neuroglancer-position-dimension-dropdown-upperbound"),d.classList.add("neuroglancer-position-dimension-dropdown-hoverposition"),t.appendChild(o),t.appendChild(c),t.appendChild(d),t.appendChild(r);let p=100;r.width=$C,r.height=p,c.style.marginTop=`${p-1}px`;let m,g,v,b=()=>{let P=this.dimensionWidgetList.indexOf(e);if(P===-1)return;let{coordinateSpace:M}=e,D=D5(M,P,p);if(D===void 0||M.bounds.lowerBounds[P]+1===M.bounds.upperBounds[P]){t.style.display="none",e.container.dataset.dropdownVisible=void 0;return}e.container.dataset.dropdownVisible="true",t.style.display="";let{lowerBound:E,upperBound:V}=D;m=E,g=V,l.textContent=E.toString(),c.textContent=V.toString(),I5(r,i,D);let O=this.position.value[P];if(O>=E&&O<=V&&(i.fillStyle="#f66",i.fillRect(0,WC(O,E,V,p),$C,1)),v!==void 0&&v>=E&&v<=V){i.fillStyle="#66f";let B=WC(v,E,V,p);i.fillRect(0,B,$C,1),d.textContent=v.toString();let z=a.clientHeight;a.style.visibility=B>z?"":"hidden",c.style.visibility=B<p-z?"":"hidden",d.style.display="",d.style.visibility="visible",d.style.marginTop=`${B}px`}else a.style.visibility="",d.style.display="none",c.style.visibility=""},x=e.dropdownOwner,C=x.registerCancellable(We(b));x.registerDisposer(this.position.changed.add(C));let T=P=>{if(m===void 0||g===void 0)return;let M=r.getBoundingClientRect(),D=(P.clientY-M.top)/M.height;return D=Math.max(0,D),D=Math.min(1,D),Math.round(D*(g-m))+m},I=P=>{let M=this.dimensionWidgetList.indexOf(e);if(M===-1)return;let D=T(P);if(D===void 0)return;let{position:E}=this,V=E.value;V[M]=D+.5,e.modified=!1,E.value=V};r.addEventListener("pointermove",P=>{v=T(P),C()}),r.addEventListener("pointerleave",()=>{v=void 0,C()}),r.addEventListener("pointerdown",P=>{P.preventDefault(),P.stopPropagation(),!(P.ctrlKey||P.altKey||P.shiftKey||P.metaKey)&&(sn(P,M=>{e.dropdownOwner!==void 0&&(v=void 0,I(M),C(),e.draggingPosition=!0)},()=>{e.draggingPosition=!1,this.updateDropdownVisibility(e)}),I(P))}),b()}openCoordinateArrayDropdown(e,t,r){t.classList.add("neuroglancer-position-dimension-coordinate-dropdown");let{coordinates:i,labels:a}=r,o=[],l=i.length;t.style.setProperty("--neuroglancer-coordinate-label-width",`${e.coordinateLabelWidth}ch`);for(let c=0;c<l;++c){let d=document.createElement("div");d.classList.add("neuroglancer-dimension-dropdown-coordinate-entry");let p=document.createElement("div");p.classList.add("neuroglancer-dimension-dropdown-coordinate");let m=document.createElement("div");m.classList.add("neuroglancer-dimension-dropdown-coordinate-label"),m.textContent=a[c],p.textContent=i[c].toString(),d.appendChild(p),d.appendChild(m),d.addEventListener("click",()=>{let g=this.dimensionWidgetList.indexOf(e);if(g===-1)return;let{position:v}=this,b=v.value;b[g]=i[c]+.5,e.modified=!1,v.value=b}),t.appendChild(d),o.push({entryElement:d,coordinateElement:p,labelElement:m})}}openDropdown(e){if(e.dropdownOwner!==void 0)return;let t=this.dimensionWidgetList.indexOf(e);if(t===-1)return;this.closeDropdown();let r=e.dropdownOwner=new j,i=document.createElement("div");i.draggable=!0,i.addEventListener("dragstart",o=>{o.stopPropagation(),o.preventDefault()}),i.addEventListener("pointerenter",()=>{e.hasFocus=!0}),i.tabIndex=-1,e.container.appendChild(i);let a=$g(e.coordinateSpace,t);a==null?this.openRegularDropdown(e,i):this.openCoordinateArrayDropdown(e,i,a),this.widgetWithOpenDropdown=e,r.registerDisposer(()=>{Ye(i),e.dropdownOwner=void 0,delete e.container.dataset.dropdownVisible,this.widgetWithOpenDropdown=void 0}),r.registerEventListener(document,"pointerdown",o=>{let{target:l}=o;l instanceof Node&&e.container.contains(l)||this.closeDropdown(e)},{capture:!0})}closeDropdown(e=this.widgetWithOpenDropdown){if(e===void 0)return;let{dropdownOwner:t}=e;t!==void 0&&t.dispose()}pasteString(e,t){for(;;){e.coordinate.focus();let r=t.match(/^\s*(-?\d+(?:\.(?:\d+)?)?)((?:\s+(?![\s,]))|(?:\s*,\s*))?/);if(r===null)break;if(r[1]!==void 0&&document.execCommand("insertText",void 0,r[1]),r[2]!==void 0){let{dimensionWidgetList:i}=this,a=i.indexOf(e);if(a===-1||a+1===i.length)break;let o=t.substring(r[0].length);e=i[a+1],t=o;continue}break}}reorderDimensionTo(e,t){if(e===t)return;let{coordinateSpace:r}=this.position;r.value=Eh(r.value,e,t)}updateDropdownVisibility(e){e.hasFocus||e.draggingPosition?this.openDropdown(e):this.closeDropdown(e)}newDimension(e,t){let r=new nV(e,t);r.container.addEventListener("dragstart",i=>{this.dragSource=r,i.stopPropagation(),i.dataTransfer.setData("neuroglancer-dimension","")}),r.container.addEventListener("dragenter",i=>{let{dragSource:a}=this;if(a===void 0||a===r)return;let{dimensionWidgetList:o}=this,l=o.indexOf(a),c=o.indexOf(r);l===-1||c===-1||(i.preventDefault(),this.reorderDimensionTo(c,l))}),r.container.addEventListener("dragend",i=>{this.dragSource===r&&(this.dragSource=void 0)}),r.nameContainer.addEventListener("dblclick",()=>{r.nameElement.disabled=!1,r.nameElement.focus(),r.nameElement.select()}),r.scaleContainer.addEventListener("dblclick",()=>{r.scaleElement.disabled=!1,r.scaleElement.focus(),r.scaleElement.select()}),r.coordinate.addEventListener("focus",()=>{r.coordinate.select()}),r.container.addEventListener("focusin",()=>{r.hasFocus=!0,this.updateDropdownVisibility(r)}),r.container.addEventListener("focusout",i=>{let{relatedTarget:a}=i;a instanceof Node&&r.container.contains(a)||(r.hasFocus=!1,this.updateDropdownVisibility(r))}),r.container.addEventListener("click",i=>{(!(i.target instanceof HTMLInputElement)||i.target.disabled)&&r.coordinate.focus()}),r.coordinate.addEventListener("paste",i=>{let a=r.coordinate,o=a.value,{clipboardData:l}=i;if(l===null)return;let c=l.getData("text"),{selectionEnd:d,selectionStart:p}=a;if(p!==0||d!==o.length){p==null&&(p=0),d==null&&(d=0);let m=c.match(/[^\-0-9\.]/);m!==null&&(c=c.substring(0,m.index)),c.length>0&&document.execCommand("insertText",void 0,c)}else this.pasteString(r,c);i.preventDefault(),i.stopPropagation()}),r.coordinate.addEventListener("input",()=>{r.modified=!0;let i=r.coordinate,a=i.value,{selectionDirection:o,selectionEnd:l,selectionStart:c}=i;c===null&&(c=0),l===null&&(l=c);let d="",p=/[^\-0-9\.]/g;d+=a.substring(0,c).replace(p,"");let m=d.length;d+=a.substring(c,l).replace(p,"");let g=d.length;d+=a.substring(l).replace(p,""),i.value=d,i.selectionStart=m,i.selectionEnd=g,i.selectionDirection=o,rV(i,d),l===c&&l===a.length&&a.match(/^(-?\d+(?:\.(?:\d+)?)?)((?:\s+(?![\s,]))|(?:\s*,\s*))$/)&&this.selectAdjacentCoordinate(r,1)}),r.nameElement.addEventListener("input",()=>{let{nameElement:i}=r;xn(i),this.updateNameValidity()}),r.scaleElement.addEventListener("input",()=>{let{scaleElement:i}=r;iV(i),this.updateScaleValidity(r)}),r.coordinate.addEventListener("blur",i=>{let{relatedTarget:a}=i;this.dimensionWidgetList.some(o=>o.coordinate===a)||r.modified&&this.updatePosition()}),r.nameElement.addEventListener("blur",i=>{r.nameElement.disabled=!0;let{relatedTarget:a}=i;this.dimensionWidgetList.some(o=>o.nameElement===a)||this.updateNames()||this.forceUpdateDimensions()}),r.scaleElement.addEventListener("blur",i=>{r.scaleElement.disabled=!0;let{relatedTarget:a}=i;this.dimensionWidgetList.some(o=>o.scaleElement===a)||this.updateScales()||this.forceUpdateDimensions()}),ce(r.container,"adjust-via-wheel",i=>{let a=i.detail,{deltaY:o}=a;o!==0&&this.adjustDimension(r,Math.sign(o))}),ce(r.container,"adjust-up",()=>{this.adjustDimension(r,-1)}),ce(r.container,"adjust-down",()=>{this.adjustDimension(r,1)});for(let i of E5){let a=i(r);ce(a,"maybe-tab-forward",o=>{this.handleLeftRightMovement(o,r,1,i)}),ce(a,"maybe-tab-backward",o=>{this.handleLeftRightMovement(o,r,-1,i)}),ce(a,"tab-forward",()=>{this.selectAdjacentField(r,1,i)}),ce(a,"tab-backward",()=>{this.selectAdjacentField(r,-1,i)})}return ce(r.coordinate,"commit",()=>{this.updatePosition()}),ce(r.nameElement,"commit",()=>{this.updateNames()}),ce(r.scaleElement,"commit",()=>{this.updateScales()}),ce(r.coordinate,"delete-backward",i=>{i.stopPropagation();let{coordinate:a}=r;a.selectionStart===a.selectionEnd&&a.selectionStart===0&&(i.preventDefault(),this.selectAdjacentCoordinate(r,-1))}),r}forceUpdateDimensions(){let{position:{coordinateSpace:{value:e}}}=this;e.valid||(e=ei),this.coordinateSpace=e;let{dimensionWidgets:t,dimensionWidgetList:r}=this;r.length=0;let{names:i,ids:a,scales:o,units:l}=e;Wn(this.dimensionContainer,a.map((c,d)=>{let p=t.get(c);p===void 0?(p=this.newDimension(e,d),t.set(c,p)):p.coordinateSpace=e;let m=i[d];p.nameElement.value=m,delete p.nameElement.dataset.isValid,xn(p.nameElement);let g=$g(e,d);g===void 0?p.container.dataset.coordinateArray="none":g===null?p.container.dataset.coordinateArray="invalid":p.container.dataset.coordinateArray="valid",p.scaleContainer.title="Drag to reorder, double click to change scale",g===null&&(p.scaleContainer.title+=".  Coordinate array disabled.  To use the coordinate array, remove the unit/scale.");let{scale:v,prefix:b,unit:x}=eS(o[d],l[d]),C=`${v}${b}${x}`;return p.scaleElement.value=C,delete p.scaleElement.dataset.isValid,iV(p.scaleElement),r.push(p),p.container}));for(let[c,d]of t)d.coordinateSpace!==e&&(this.closeDropdown(d),t.delete(c))}updateDimensions(){let{position:{coordinateSpace:{value:e}}}=this;e!==this.coordinateSpace&&this.forceUpdateDimensions()}selectAdjacentField(e,t,r){let{dimensionWidgetList:i}=this,a=i.indexOf(e);if(a!==-1)for(;;){if(a+=t,a<0||a>=i.length)return!1;let o=i[a],l=r(o);if(l.style.display!=="none")return l.disabled=!1,l.focus(),l.selectionStart=0,l.selectionEnd=l.value.length,l.selectionDirection=t===1?"forward":"backward",!0}}selectAdjacentCoordinate(e,t){return this.selectAdjacentField(e,t,r=>r.coordinate)}handleLeftRightMovement(e,t,r,i){e.stopPropagation();let a=i(t);a.selectionStart!==a.selectionEnd||a.selectionStart!==(r===1?a.value.length:0)||this.selectAdjacentField(t,r,i)&&e.preventDefault()}updateNameValidity(){let{dimensionWidgetList:e}=this,t=e.map(a=>a.nameElement.value),r=t.length,i=this.combiner.getRenameValidity(t);for(let a=0;a<r;++a)e[a].nameElement.dataset.isValid=i[a]===!1?"false":"true"}updateScaleValidity(e){let t=Ho(e.scaleElement.value)!==void 0;e.scaleElement.dataset.isValid=t.toString()}adjustDimension(e,t){let r=this.dimensionWidgetList.indexOf(e);if(r===-1)return;this.updatePosition();let{position:i}=this;if(!i.valid)return;let a=i.coordinateSpace.value,{bounds:o}=a,l=Float32Array.from(i.value),c=Math.floor(l[r]+t);if(t>0){let d=o.upperBounds[r];Number.isFinite(d)&&(c=Math.min(c,Math.ceil(d-1)))}else{let d=o.lowerBounds[r];Number.isFinite(d)&&(c=Math.max(c,Math.floor(d)))}l[r]=c+.5,this.position.value=l,this.updateView()}updatePosition(){let{dimensionWidgetList:e}=this,{position:t}=this,{value:r}=t;if(r===void 0)return;let i=e.length;for(let a=0;a<i;++a){let o=e[a];o.modified=!1;let l=Number(o.coordinate.value);Number.isFinite(l)&&(r[a]=l+(Number.isInteger(l)?.5:0))}t.value=r}updateNames(){let{dimensionWidgetList:e}=this,{position:{coordinateSpace:t}}=this,r=t.value,i=e.map(c=>c.nameElement.value);if(this.combiner.getRenameValidity(i).includes(!1))return!1;let a=r.names;if(xe(a,i))return!1;let o=r.timestamps.map((c,d)=>a[d]===i[d]?c:Date.now()),l={...r,names:i,timestamps:o};return t.value=l,!0}updateScales(){let{dimensionWidgetList:e}=this,{position:{coordinateSpace:t}}=this,r=t.value,i=e.map(m=>Ho(m.scaleElement.value));if(i.includes(void 0))return!1;let a=Float64Array.from(i,m=>m.scale),o=Array.from(i,m=>m.unit),{scales:l,units:c}=r;if(xe(l,a)&&xe(c,o))return!1;let d=r.timestamps.map((m,g)=>a[g]===l[g]&&o[g]===c[g]?m:Date.now()),p=Be({valid:r.valid,rank:r.rank,scales:a,units:o,timestamps:d,ids:r.ids,names:r.names,boundingBoxes:r.boundingBoxes,coordinateArrays:r.coordinateArrays});return t.value=p,!0}getPositionText(){let{position:e}=this;return e.valid?e.value.map(t=>Math.floor(t)).join(", "):""}updateView(){this.updateDimensions();let{position:{value:e},dimensionWidgetList:t}=this,r=t.length;if(e===void 0)return;let i=this.coordinateSpace;for(let a=0;a<r;++a){let o=t[a],l=o.coordinate,c=Math.floor(e[a]),d=c.toString();rV(l,d),l.value=d;let p=$g(i,a),m="";if(p!=null){let{coordinates:v}=p,b=IL(v,c,(x,C)=>x-C);b!==v.length&&(m=p.labels[b])}let g=o.coordinateLabel;g.textContent=m}}disposed(){this.closeDropdown(),Ye(this.element),super.disposed()}},jC=class extends j{constructor(e,t,r){super();this.element=e;this.mouseState=t;this.coordinateSpace=r;this.tempPosition=K.create();e.className="neuroglancer-mouse-position-widget";let i=this.registerCancellable(We(()=>this.updateView()));this.registerDisposer(t.changed.add(i)),this.registerDisposer(r.changed.add(i))}updateView(){let e="",{mouseState:t,coordinateSpace:{value:r}}=this;if(t.active&&r!==void 0){let i=t.position,{rank:a,names:o}=r;for(let l=0;l<a;++l)l!==0&&(e+="  "),e+=`${o[l]} ${Math.floor(i[l])}`}this.element.textContent=e}disposed(){Ye(this.element),super.disposed()}};function aV(n){return{makeControl:(e,t,r)=>{let{watchableValue:i,channelCoordinateSpaceCombiner:a,dataType:o,defaultChannel:l,histogramSpecifications:c,legendShaderOptions:d,histogramIndex:p}=n(e);if(a!==void 0&&l.length!==0){let g=t.registerDisposer(new Ki(a.combined)),v=t.registerDisposer(new ws(g,a,{copyButton:!1}));t.registerDisposer(g.changed.add(()=>{let x=g.value,C=Array.from(x,I=>Math.floor(I)),T=i.value;xe(T.channel,C)||(i.value={...i.value,channel:C})}));let b=()=>{let x=g.value,C=i.value;xe(x,C.channel)||(x.set(C.channel),g.changed.dispatch())};b(),t.registerDisposer(i.changed.add(b)),r.labelContainer.appendChild(v.element)}let m=t.registerDisposer(new Vg(r.visibility,r.display,o,i,c,p,l.length===0?d:void 0));return{control:m,controlElement:m.element}},activateTool:(e,t)=>{Og(e,t)}}}function wo(n){return{makeControl:(e,t)=>{let r=n(e),i=t.registerDisposer(new Fn(r));return{control:i,controlElement:i.element}},activateTool:(e,t)=>{t.model.value=!t.model.value}}}var A5=Me.fromObject({"at:shift+wheel":{action:"adjust-hue-via-wheel"}});function jg(n){return{makeControl:(e,t)=>{let r=n(e),i=t.registerDisposer(new Ul(r));return{control:i,controlElement:i.element}},activateTool:(e,t)=>{e.bindInputEventMap(A5),e.bindAction("adjust-via-wheel",r=>{r.stopPropagation(),r.preventDefault(),t.adjustHueViaWheel(r.detail)})}}}function oV(n){return{makeControl:(e,t,r)=>{let{watchableValue:i,properties:a,histogramSpecifications:o,legendShaderOptions:l,histogramIndex:c}=n(e);{let g=document.createElement("select");for(let[x,C]of a){let T=document.createElement("option");T.textContent=`${x} (${G[C].toLowerCase()})`,T.value=x,g.appendChild(T)}let v=()=>{let x=g.value,C=a.get(x),{window:T,range:I}=i.value;i.value={window:T!==void 0?Lc(T,C):void 0,range:I!==void 0?Lc(I,C):void 0,property:x,dataType:C}},b=()=>{g.value=i.value.property};t.registerEventListener(g,"change",v),t.registerDisposer(i.changed.add(b)),b(),r.labelContainer.appendChild(g)}let d={changed:i.changed,get value(){let{dataType:g,window:v,range:b}=i.value;return b===void 0&&(b=Xr[g]),{window:ah(v!=null?v:b),range:b}},set value(g){let{window:v,range:b}=g;i.value={...i.value,window:v,range:b}}},p=At(g=>g.dataType,[i]),m=t.registerDisposer(new RC(r.visibility,r.display,p,d,o,c,l));return{control:m,controlElement:m.element}},activateTool:(e,t)=>{Og(e,t)}}}var JC=class extends j{constructor(e,{min:t=0,max:r=1,step:i=.01}={}){super();this.value=e;this.element=document.createElement("label");this.inputElement=document.createElement("input");this.numericInputElement=document.createElement("input");let{element:a,inputElement:o,numericInputElement:l}=this;a.className="range-slider";let c=p=>{p.min=""+t,p.max=""+r,p.step=""+i,p.valueAsNumber=this.value.value,this.registerEventListener(p,"change",()=>this.inputValueChanged(p)),this.registerEventListener(p,"input",()=>this.inputValueChanged(p)),this.registerEventListener(p,"wheel",m=>{this.adjustViaWheel(p,m)})};o.type="range",c(o),l.type="number";let d=Math.max(t.toString().length,r.toString().length,Math.min(r,t+i).toString().length,Math.max(t,r-i).toString().length);l.style.width=d+2+"ch",c(l),a.appendChild(o),a.appendChild(l),e.changed.add(()=>{this.inputElement.valueAsNumber=this.value.value,this.numericInputElement.valueAsNumber=this.value.value})}inputValueChanged(e){this.value.value=e.valueAsNumber}adjustViaWheel(e,t){let r=this.inputElement,{deltaY:i}=t;i>0?(r.stepUp(),this.inputValueChanged(e)):i<0&&(r.stepDown(),this.inputValueChanged(e))}disposed(){Ye(this.element),super.disposed()}};var M5=Me.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"}});function ea(n){return{makeControl:(e,t)=>{let{value:r,options:i}=n(e),a=t.registerDisposer(new JC(r,i));return{control:a,controlElement:a.element}},activateTool:(e,t)=>{e.bindInputEventMap(M5),e.bindAction("adjust-via-wheel",r=>{r.stopPropagation(),r.preventDefault(),t.adjustViaWheel(t.inputElement,r.detail)})}}}function sV(n,e){let{shaderControlState:t}=n,r=t.state.get(e);if(r===void 0)return;let{control:i}=r;switch(i.type){case"slider":return ea(()=>({value:r.trackable,options:{min:i.min,max:i.max,step:i.step}}));case"color":return jg(()=>r.trackable);case"checkbox":return wo(()=>r.trackable);case"imageInvlerp":{let a=0;for(let[o,{control:{type:l}}]of t.state){if(o===e)break;l==="imageInvlerp"&&++a}return aV(()=>({dataType:i.dataType,defaultChannel:i.default.channel,watchableValue:r.trackable,channelCoordinateSpaceCombiner:t.channelCoordinateSpaceCombiner,histogramSpecifications:t.histogramSpecifications,histogramIndex:a,legendShaderOptions:n.legendShaderOptions}))}case"propertyInvlerp":{let a=0;for(let[o,{control:{type:l}}]of t.state){if(o===e)break;l==="propertyInvlerp"&&++a}return oV(()=>({properties:i.properties,watchableValue:r.trackable,histogramSpecifications:t.histogramSpecifications,histogramIndex:a,legendShaderOptions:n.legendShaderOptions}))}}}function lV(n,e,t){return{label:t,toolJson:R5(t,e),makeControl:(r,i,a)=>{let o=n(r);return sV(o,t).makeControl(r,i,a)},activateTool:(r,i)=>{let a=n(r.tool.layer);return sV(a,t).activateTool(r,i)}}}var To=class extends Vt{constructor(e,t,r,i={}){super(i.visibility);this.state=e;this.display=t;this.layer=r;this.options=i;this.controlDisposer=void 0;let{toolId:a=cV}=i;this.toolId=a;let{element:o}=this;o.style.display="contents";let{controls:l}=e;this.registerDisposer(l.changed.add(this.registerCancellable((0,qC.default)(()=>this.updateControls(),0)))),this.updateControls()}updateControls(){let{element:e}=this;this.controlDisposer!==void 0&&(this.controlDisposer.dispose(),Ie(e));let t=this.controlDisposer=new j,r=()=>({shaderControlState:this.state,legendShaderOptions:this.options.legendShaderOptions});for(let i of this.state.state.keys())e.appendChild(cu(t,this.layer,this.visibility,lV(r,this.toolId,i)))}disposed(){var e;(e=this.controlDisposer)==null||e.dispose(),super.disposed()}},cV="shaderControl",uV="control";function R5(n,e){return{type:e,[uV]:n}}var dV=class extends Wg{constructor(e,t,r,i){super(e,lV(()=>t,r,i));this.layerShaderControls=t;this.control=i;this.registerDisposer(t.shaderControlState.controls.changed.add(this.registerCancellable((0,qC.default)(()=>{t.shaderControlState.state.get(i)===void 0&&this.unbind()}))))}activate(e){let{shaderControlState:t}=this.layerShaderControls;t.state.get(this.control)!==void 0&&super.activate(e)}};function Ts(n,e,t=cV){wi(n,t,(r,i)=>{let a=W(i,uV,Q);return new dV(r,e(r),t,a)})}function pV(n){return new Co({fragmentMain:n.displayState.skeletonRenderingOptions.shader,shaderError:n.displayState.shaderError,shaderControlState:n.displayState.skeletonRenderingOptions.shaderControlState})}var YC=class extends Vt{constructor(e){super();this.layer=e;let{element:t}=this;t.classList.add("neuroglancer-segmentation-rendering-tab");{let i=this.registerDisposer(new Hg(e.displayState.linkedSegmentationGroup));i.label.textContent="Linked to: ",t.appendChild(i.element)}{let i=this.registerDisposer(new Hg(e.displayState.linkedSegmentationColorGroup));i.label.textContent="Colors linked to: ",t.appendChild(i.element)}for(let i of XC)t.appendChild(cu(this,e,this.visibility,i));let r=this.registerDisposer(new Cn(e.hasSkeletonsLayer,(i,a,o)=>{if(!i)return;let l=document.createElement("div");l.className="neuroglancer-segmentation-dropdown-skeleton-shader-header";let c=document.createElement("div");c.style.flex="1",c.textContent="Skeleton shader:",l.appendChild(c),l.appendChild(xs({title:"Show larger editor view",onClick:()=>{new fV(this.layer)}})),l.appendChild(bs({title:"Documentation on skeleton rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/sliceview/image_layer_rendering.md"})),a.appendChild(l);let d=o.registerDisposer(pV(this.layer));a.appendChild(d.element),a.appendChild(o.registerDisposer(new To(e.displayState.skeletonRenderingOptions.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility,toolId:KC})).element),d.textEditor.refresh()},this.visibility));t.appendChild(r.element)}},fV=class extends Zi{constructor(e){super();this.layer=e;this.codeWidget=this.registerDisposer(pV(this.layer));this.content.classList.add("neuroglancer-segmentation-layer-skeleton-shader-overlay"),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}};var Ls=class extends ro{constructor(){super(...arguments);this.hashTable=new Wc;this.changed=new ze}get value(){return this}static makeWithCounterpart(e){let t=new Ls;return t.initializeCounterpart(e),t}set_(e,t){return this.hashTable.set(e,t)}set(e,t){if(this.set_(e,t)){let{rpc:r}=this;r&&r.invoke("Uint64Map.set",{id:this.rpcId,key:e,value:t}),this.changed.dispatch(e,!0)}}has(e){return this.hashTable.has(e)}get(e,t){return this.hashTable.get(e,t)}[Symbol.iterator](){return this.hashTable.entries()}unsafeEntries(){return this.hashTable.unsafeEntries()}delete_(e){return this.hashTable.delete(e)}delete(e){if(this.delete_(e)){let{rpc:t}=this;t&&t.invoke("Uint64Map.delete",{id:this.rpcId,key:e}),this.changed.dispatch(e,!1)}}get size(){return this.hashTable.size}assignFrom(e){this.clear();for(let[t,r]of e.unsafeEntries())this.set(t,r)}clear(){if(this.hashTable.clear()){let{rpc:e}=this;e&&e.invoke("Uint64Map.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){let e={};for(let[t,r]of this.hashTable.unsafeEntries())e[t.toString()]=r.toString();return e}};Ls=kt([jo("Uint64Map")],Ls);wt("Uint64Map.set",function(n){let e=this.get(n.id);e.set_(n.key,n.value)&&e.changed.dispatch()});wt("Uint64Map.delete",function(n){let e=this.get(n.id);e.delete_(n.key)&&e.changed.dispatch()});wt("Uint64Map.clear",function(n){let e=this.get(n.id);e.hashTable.clear()&&e.changed.dispatch()});var ks=class extends ro{constructor(){super(...arguments);this.hashTable=new am;this.changed=new ze}get value(){return this}static makeWithCounterpart(e){let t=new ks;return t.initializeCounterpart(e),t}set(e,t){t?this.add(e):this.delete(e)}reserve_(e){return this.hashTable.reserve(e)}reserve(e){if(this.reserve_(e)){let{rpc:t}=this;t&&t.invoke("Uint64Set.reserve",{id:this.rpcId,value:e})}}add_(e){let t=!1;for(let r of e)t=this.hashTable.add(r)||t;return t}add(e){let t=Array().concat(e);if(this.add_(t)){let{rpc:r}=this;r&&r.invoke("Uint64Set.add",{id:this.rpcId,value:t}),this.changed.dispatch(e,!0)}}has(e){return this.hashTable.has(e)}[Symbol.iterator](){return this.hashTable.keys()}unsafeKeys(){return this.hashTable.unsafeKeys()}delete_(e){let t=!1;for(let r of e)t=this.hashTable.delete(r)||t;return t}delete(e){let t=Array().concat(e);if(this.delete_(Array().concat(e))){let{rpc:r}=this;r&&r.invoke("Uint64Set.delete",{id:this.rpcId,value:t}),this.changed.dispatch(e,!1)}}get size(){return this.hashTable.size}clear(){if(this.hashTable.clear()){let{rpc:e}=this;e&&e.invoke("Uint64Set.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){let e=new Array;for(let t of this.unsafeKeys())e.push(t.toString());return e.sort(),e}assignFrom(e){this.clear();for(let t of e.unsafeKeys())this.add(t)}};ks=kt([jo("Uint64Set")],ks);wt("Uint64Set.reserve",function(n){let e=this.get(n.id);e.reserve_(n.value)&&e.changed.dispatch()});wt("Uint64Set.add",function(n){let e=this.get(n.id);e.add_(n.value)&&e.changed.dispatch()});wt("Uint64Set.delete",function(n){let e=this.get(n.id);e.delete_(n.value)&&e.changed.dispatch()});wt("Uint64Set.clear",function(n){let e=this.get(n.id);e.hashTable.clear()&&e.changed.dispatch()});var Bp=class extends j{constructor(e){super();this.model=e;this.element=document.createElement("select");this.valueIndexMap=new Map;let{element:t,valueIndexMap:r}=this,i=0;for(let a of Object.keys(e.enumType))if(isNaN(Number(a))){let o=document.createElement("option");o.textContent=o.value=a.toLowerCase(),t.appendChild(o),r.set(e.enumType[a],i),++i}this.registerDisposer(e.changed.add(()=>this.updateView())),this.registerEventListener(t,"change",()=>this.updateModel()),this.registerEventListener(t,"wheel",a=>{a.preventDefault(),a.stopPropagation(),this.adjustViaWheel(a)}),this.updateView()}adjustViaWheel(e){let{element:t}=this,{deltaY:r}=e;r>0?(t.selectedIndex=(t.options.length+t.selectedIndex-1)%t.options.length,this.updateModel()):r<0&&(t.selectedIndex=(t.options.length+t.selectedIndex+1)%t.options.length,this.updateModel())}updateView(){let{element:e}=this;e.selectedIndex=this.valueIndexMap.get(this.model.value)}updateModel(){this.model.restoreState(this.element.value)}};var _5=Me.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"}});function Jg(n){return{makeControl:(e,t)=>{let r=n(e),i=t.registerDisposer(new Bp(r));return{control:i,controlElement:i.element}},activateTool:(e,t)=>{e.bindInputEventMap(_5),e.bindAction("adjust-via-wheel",r=>{r.stopPropagation(),r.preventDefault(),t.adjustViaWheel(r.detail)})}}}var hV=ot(Et()),mV=ot(bp());function qg(n,e){let t="";for(let r=0;r<=e&&(t=n.toFixed(r),parseFloat(t)!==n);++r);return t}var V5=200,gV=Me.fromObject({mousedown0:{action:"set"},wheel:{action:"adjust-via-wheel"},dblclick0:{action:"reset"}});function O5(n){if(n<1||n>1024){let e=Math.log2(n)|0,t=n/2**e;return`${qg(t,1)}p${e}`}return Math.round(n)+""}var Up=class extends j{constructor(e,t){super();this.histogram=e;this.target=t;this.label=document.createElement("div");this.element=document.createElement("div");this.canvas=document.createElement("canvas");this.legend=document.createElement("div");this.legendRenderScale=document.createElement("div");this.legendSpatialScale=document.createElement("div");this.legendChunks=document.createElement("div");this.ctx=this.canvas.getContext("2d");this.hoverTarget=new Ee(void 0);this.throttledUpdateView=this.registerCancellable((0,mV.default)(()=>this.debouncedUpdateView(),V5,{leading:!0,trailing:!0}));this.debouncedUpdateView=this.registerCancellable((0,hV.default)(()=>this.updateView(),0));let{canvas:r,label:i,element:a,legend:o,legendRenderScale:l,legendSpatialScale:c,legendChunks:d}=this;i.className="neuroglancer-render-scale-widget-prompt",a.className="neuroglancer-render-scale-widget",a.title=gV.describe(),o.className="neuroglancer-render-scale-widget-legend",a.appendChild(i),a.appendChild(r),a.appendChild(o),l.title="Target resolution of data in screen pixels",d.title="Number of chunks rendered",o.appendChild(l),o.appendChild(d),o.appendChild(c),this.registerDisposer(e.changed.add(this.throttledUpdateView)),this.registerDisposer(e.visibility.changed.add(this.debouncedUpdateView)),this.registerDisposer(t.changed.add(this.debouncedUpdateView)),this.registerDisposer(new wn(r,gV)),this.registerDisposer(t.changed.add(this.debouncedUpdateView)),this.registerDisposer(this.hoverTarget.changed.add(this.debouncedUpdateView));let p=g=>{let v=g.offsetX/r.width*an;return zP(v)};this.registerEventListener(r,"pointermove",g=>{this.hoverTarget.value=[p(g),g.offsetY]}),this.registerEventListener(r,"pointerleave",()=>{this.hoverTarget.value=void 0}),this.registerDisposer(ce(r,"set",g=>{this.target.value=p(g.detail)})),this.registerDisposer(ce(r,"adjust-via-wheel",g=>{this.adjustViaWheel(g.detail)})),this.registerDisposer(ce(r,"reset",g=>{this.reset(),g.preventDefault()}));let m=new ResizeObserver(()=>this.debouncedUpdateView());m.observe(r),this.registerDisposer(()=>m.disconnect()),this.updateView()}adjustViaWheel(e){let{deltaY:t}=e;t!==0&&(this.hoverTarget.value=void 0,this.target.value*=2**Math.sign(t),e.preventDefault())}reset(){this.hoverTarget.value=void 0,this.target.reset()}updateView(){let{ctx:e}=this,{canvas:t}=this,r=t.width=t.offsetWidth,i=t.height=t.offsetHeight,a=this.target.value,o=this.hoverTarget.value;{let{legendRenderScale:E}=this,V=o===void 0?a:o[0],O=O5(V);E.textContent=O+" px"}function l(E){return E*r/an}e.clearRect(0,0,r,i);let{histogram:c}=this,{value:d,spatialScales:p}=c;c.visibility.visible||d.fill(0);let m=Array.from(p.keys());m.sort();let g=K.create(),v=1,b=p.size,x=0,C=0;for(let E=0;E<an;++E){let V=0;for(let O=0;O<b;++O){let B=O*an*2+E,z=d[B],_=d[B+an];x+=z,C+=_,V+=z+_}v=Math.max(V,v)}let I=i/Math.log(1+v);function P(E){return i-Math.log(1+E)*I}let M;if(o!==void 0){let E=Math.floor(zd(o[0]));if(E>=0&&E<an){let V=0,O=o[1];for(let B=b-1;B>=0;--B){let z=m[B],_=p.get(z),U=2*_*an+E,N=d[U]+d[U+an];if(N===0)continue;let J=Math.round(P(V));if(V+=N,Math.round(P(V))<=O&&O<=J){M=z;break}}}}if(M!==void 0){x=0,C=0;let E=p.get(M),V=2*E*an;for(let O=0;O<an;++O){let B=V+O;x+=d[B],C+=d[B+an]}Number.isFinite(M)?this.legendSpatialScale.textContent=Vi(M,"m",{precision:2,elide1:!1}):this.legendSpatialScale.textContent="unknown"}else this.legendSpatialScale.textContent="";this.legendChunks.textContent=`${x}/${x+C}`;let D=m.map(E=>{let V=E===M?.5:1,O;Number.isFinite(E)?O=(Math.log2(E)*.1%1+1)%1:O=0,Sl(g,O,V,1);let B=gn(g);Sl(g,O,V,.5);let z=gn(g);return[B,z]});for(let E=0;E<an;++E){let V=0;for(let O=b-1;O>=0;--O){let B=m[O],_=p.get(B)*an*2+E,U=d[_],N=d[_+an],J=U+N;if(J===0)continue;let ie=Math.round(l(E)),pe=Math.round(l(E+1)),me=Math.round(P(V));V+=J;let Pe=Math.round(P(V)),le=(U*Pe+N*me)/J;e.fillStyle=D[O][1],e.fillRect(ie,Pe,pe-ie,le-Pe),e.fillStyle=D[O][0],e.fillRect(ie,le,pe-ie,me-le)}}{let E=a;e.fillStyle="#fff";let V=l(zd(E)),O=1;e.fillRect(Math.floor(V),0,O,i)}if(o!==void 0){let E=o[0];e.fillStyle="#888";let V=l(zd(E)),O=1;e.fillRect(Math.floor(V),0,O,i)}}},N5=Me.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"},"at:shift+dblclick0":{action:"reset"}});function uu(n){return{makeControl:(e,t)=>{let{histogram:r,target:i}=n(e),a=t.registerDisposer(new Up(r,i));return{control:a,controlElement:a.element}},activateTool:(e,t)=>{e.bindInputEventMap(N5),e.bindAction("adjust-via-wheel",r=>{r.stopPropagation(),r.preventDefault(),t.adjustViaWheel(r.detail)}),e.bindAction("reset",r=>{r.stopPropagation(),r.preventDefault(),t.reset()})}}}var yV='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="rotateIconTitle"><path d="M22 12l-3 3-3-3"></path><path d="M2 12l3-3 3 3"></path><path d="M19.016 14v-1.95A7.05 7.05 0 0 0 8 6.22"></path><path d="M16.016 17.845A7.05 7.05 0 0 1 5 12.015V10"></path><path stroke-linecap="round" d="M5 10V9"></path><path stroke-linecap="round" d="M19 15v-1"></path></svg>';var Fp=class extends j{constructor(e){super();this.model=e;this.element=document.createElement("input");this.registerDisposer(e.changed.add(()=>this.updateView()));let{element:t}=this;t.type="text",this.registerEventListener(t,"change",()=>this.updateModel()),this.updateView()}disposed(){Ye(this.element)}updateView(){var e;this.element.value=((e=this.model.value)!=null?e:"")+""}updateModel(){try{this.model.restoreState(this.element.value)}catch{}this.updateView()}};function Yg(n,e){e?n.displayState.segmentDefaultColor.value=K.fromValues(1,0,0):n.displayState.segmentDefaultColor.value=void 0}function vV(){let n=e=>{e.displayState.segmentationColorGroupState.value.segmentColorHash.randomize()};return{makeControl:(e,t,{labelTextContainer:r})=>{let i=document.createElement("input");i.type="radio",i.addEventListener("change",()=>{Yg(e,!i.checked)}),r.prepend(i);let a=document.createElement("div");a.classList.add("neuroglancer-segmentation-color-seed-control");let o=t.registerDisposer(new Fp(e.displayState.segmentColorHash));a.appendChild(o.element);let l=He({svg:yV,title:"Randomize",onClick:()=>n(e)});return a.appendChild(l),t.registerDisposer(_r(c=>{let d=c===void 0;a.style.visibility=d?"":"hidden",i.checked=d},e.displayState.segmentDefaultColor)),{controlElement:a,control:o}},activateTool:e=>{let{layer:t}=e.tool;Yg(t,!1),n(t)}}}function SV(){let n=jg(e=>e.displayState.segmentDefaultColor);return{...n,makeControl:(e,t,r)=>{let i=n.makeControl(e,t,r),{controlElement:a}=i,o=document.createElement("input");return o.type="radio",o.addEventListener("change",()=>{Yg(e,o.checked),o.checked&&a.click()}),r.labelTextContainer.prepend(o),t.registerDisposer(_r(l=>{let c=l!==void 0;a.style.visibility=c?"":"hidden",o.checked=c},e.displayState.segmentDefaultColor)),i},activateTool:(e,t)=>{Yg(e.tool.layer,!0),n.activateTool(e,t)}}}var QC=class extends nr{constructor(){super();this.changed=new re;this.set_color_val=new Le("",Q,"");this.clNeuronColor=new Le("",Q,"");this.clClearBeforeLoad=new qe(!1,!1);this.clAlsoLoadNeurons=new qe(!1,!1);this.state={set_color_val:this.set_color_val,clNeuronColor:this.clNeuronColor,clClearBeforeLoad:this.clClearBeforeLoad,clAlsoLoadNeurons:this.clAlsoLoadNeurons};super.add("set_color_val",this.state.set_color_val),super.add("clNeuronColor",this.state.clNeuronColor),super.add("clClearBeforeLoad",this.state.clClearBeforeLoad),super.add("clAlsoLoadNeurons",this.state.clAlsoLoadNeurons)}reset(){super.reset()}toJSON(){return super.toJSON()}restoreState(e){if(e!=null)try{this.state=e,super.restoreState(this.state),this.changed.dispatch()}catch(t){this.reset()}}};var ZC=class extends j{constructor(e,t,r,i={}){super();this.model=e;this.element=document.createElement("label");this.inputElement=document.createElement("textarea");let{validator:a,label:o}=i,{element:l,inputElement:c}=this;a===void 0&&(e instanceof Le?a=e.validator:a=d=>d),this.validator=a,o!==void 0&&(l.textContent=o),l.appendChild(c),l.className="neuroglancer-string-input",c.rows=t,c.cols=r,this.registerDisposer(this.model.changed.add(()=>this.updateView())),this.registerEventListener(c,"change",()=>this.updateModel()),this.updateView()}updateView(){this.inputElement.value=""+this.model.value}updateModel(){let e=this.inputElement.value.trim();if(typeof e!="string"){this.updateView();return}try{e=this.validator(e),this.model.value=e}catch{this.updateView()}}disposed(){Ye(this.element),super.disposed()}};var Gl=class extends Vt{constructor(e){super();this.model=e}addButton(e,t,r,i){let a=document.createElement("br"),o=e,l=document.createElement("DIV");l.setAttribute("align","right"),o.type=r,o.name=t,o.value=t,o.textContent=t,o.title=t,l.appendChild(o),l.appendChild(a),l.appendChild(a),this.element.appendChild(l),i&&(o.id=i),o.addEventListener("mousedown",()=>{document.dispatchEvent(new Event(o.id))})}addCheckbox(e,t){let r=document.createElement("br"),i=document.createElement("DIV");i.setAttribute("align","right");let a=document.createElement("label");a.textContent=e;let o=this.registerDisposer(new Fn(t));a.appendChild(o.element),i.appendChild(a),i.appendChild(r),i.appendChild(r),this.element.appendChild(i)}addTextArea(e,t,r=1,i=24){let a=document.createElement("DIV");a.setAttribute("align","right");let o=document.createElement("H3");o.textContent=e,o.style.padding="0",o.style.margin="0";let l=this.registerDisposer(new ZC(t,r,i));a.appendChild(o),a.appendChild(l.element),this.element.appendChild(a)}};var ew=class extends Gl{constructor(e){super(e);this.transform=e;this.clSetVal=document.createElement("input");this.clClear=document.createElement("input");this.clNeuronColorButton=document.createElement("input");let{element:t}=this;t.classList.add("neuroglancer-Color-widget"),this.addTextArea("Color value",e.set_color_val),this.addButton(this.clSetVal,"Set color to selections","button","clSetVal"),this.addButton(this.clClear,"Clear colors","button","clClear"),this.addTextArea("Neuron color mapping",e.clNeuronColor,14,28),this.addButton(this.clNeuronColorButton,"Set color","button","clNeuronColorButton"),this.addCheckbox("Also load neurons",e.clAlsoLoadNeurons),this.addCheckbox("Clear segments before load",e.clClearBeforeLoad)}};var bV="Colors",xV="colors";function CV(n){class e extends n{constructor(...r){super(...r);this.cl=new QC;this.cl.changed.add(this.specificationChanged.dispatch),this.tabs.add(bV,{label:bV,order:100,getter:()=>new ew(this.cl)})}restoreState(r){super.restoreState(r),this.cl.restoreState(r[xV])}toJSON(){let r=super.toJSON();return r[xV]=this.cl.toJSON(),r}}return e}var tw=class extends nr{constructor(){super();this.changed=new re;this.dbNeuronPrefix=new Le("",Q,"");this.dbFindAnnotator=new Le("",Q,"");this.dbFindType=new Le("",Q,"");this.dbFindTags=new Le("",Q,"");this.dbFindFinished=new qe(!1,!1);this.dbFindReviewed=new qe(!1,!1);this.dbFindResult=new Le("",Q,"");this.dbLoadNeuronName=new Le("",Q,"");this.dbLoadNeuronName1=new Le("",Q,"");this.dbLoadNeuronName2=new Le("",Q,"");this.dbLoadNeuronName3=new Le("",Q,"");this.dbLoadWithoutChildren=new qe(!1,!1);this.state={dbNeuronPrefix:this.dbNeuronPrefix,dbFindAnnotator:this.dbFindAnnotator,dbFindType:this.dbFindType,dbFindTags:this.dbFindTags,dbFindFinished:this.dbFindFinished,dbFindReviewed:this.dbFindReviewed,dbFindResult:this.dbFindResult,dbLoadNeuronName:this.dbLoadNeuronName,dbLoadNeuronName1:this.dbLoadNeuronName1,dbLoadNeuronName2:this.dbLoadNeuronName2,dbLoadNeuronName3:this.dbLoadNeuronName3,dbLoadWithoutChildren:this.dbLoadWithoutChildren};super.add("dbNeuronPrefix",this.dbNeuronPrefix),super.add("dbFindAnnotator",this.dbFindAnnotator),super.add("dbFindType",this.dbFindType),super.add("dbFindTags",this.dbFindTags),super.add("dbFindFinished",this.dbFindFinished),super.add("dbFindReviewed",this.dbFindReviewed),super.add("dbFindResult",this.dbFindResult),super.add("dbLoadNeuronName",this.dbLoadNeuronName),super.add("dbLoadNeuronName1",this.dbLoadNeuronName1),super.add("dbLoadNeuronName2",this.dbLoadNeuronName2),super.add("dbLoadNeuronName3",this.dbLoadNeuronName3),super.add("dbLoadWithoutChildren",this.dbLoadWithoutChildren)}reset(){super.reset()}toJSON(){return super.toJSON()}restoreState(e){if(e!=null)try{this.state=e,super.restoreState(this.state),this.changed.dispatch()}catch(t){this.reset()}}};var nw=class extends Gl{constructor(e){super(e);this.transform=e;this.dbSearchButton=document.createElement("input");this.dbLoadNeuronNameButton=document.createElement("input");this.dbLoadNeuronNameButton1=document.createElement("input");this.dbLoadNeuronNameButton2=document.createElement("input");this.dbLoadNeuronNameButton3=document.createElement("input");let{element:t}=this;t.classList.add("neuroglancer-Proofread-widget"),this.addTextArea("Prefix",e.dbNeuronPrefix),this.addTextArea("Annotator",e.dbFindAnnotator),this.addTextArea("Type",e.dbFindType),this.addTextArea("Tags",e.dbFindTags),this.addCheckbox("Finished",e.dbFindFinished),this.addCheckbox("Reviewed",e.dbFindReviewed),this.addButton(this.dbSearchButton,"Search","button","dbSearchButton"),this.addTextArea("Result",e.dbFindResult,14,28),this.addTextArea("Load Neuron",e.dbLoadNeuronName),this.addButton(this.dbLoadNeuronNameButton,"Load","button","dbLoadNeuronNameButton"),this.addTextArea("",e.dbLoadNeuronName1),this.addButton(this.dbLoadNeuronNameButton1,"Load","button","dbLoadNeuronNameButton1"),this.addTextArea("",e.dbLoadNeuronName2),this.addButton(this.dbLoadNeuronNameButton2,"Load","button","dbLoadNeuronNameButton2"),this.addTextArea("",e.dbLoadNeuronName3),this.addButton(this.dbLoadNeuronNameButton3,"Load","button","dbLoadNeuronNameButton3"),this.addCheckbox("Load without children",e.dbLoadWithoutChildren)}};var wV="neurondb",TV="Search DB";function LV(n){class e extends n{constructor(...r){super(...r);this.sr=new tw;this.sr.changed.add(this.specificationChanged.dispatch),this.tabs.add(TV,{label:TV,order:100,getter:()=>new nw(this.sr)})}restoreState(r){super.restoreState(r),this.sr.restoreState(r[wV])}toJSON(){let r=super.toJSON();return r[wV]=this.sr.toJSON(),r}}return e}var rw=class extends nr{constructor(){super();this.changed=new re;this.prNeuronName=new Le("",Q,"");this.prCellType=new Le("",Q,"");this.prTags=new Le("",Q,"");this.prLocTags=new Le("",Q,"");this.prUncertainCon=new Le("",Q,"");this.prMergers=new Le("",Q,"");this.prAnnotator=new Le("",Q,"");this.prNotes=new Le("",Q,"");this.prFinished=new qe(!1,!1);this.prReviewed=new qe(!1,!1);this.prSomaLoc=new Le("",Q,"");this.prOverrideSuperSetCheck=new qe(!1,!1);this.prOverrideConflictCheck=new qe(!1,!1);this.prGrowThreshold=new Le("",Q,"");this.prSuperGrowThreshold=new Le("",Q,"");this.state={prNeuronName:this.prNeuronName,prCellType:this.prCellType,prTags:this.prTags,prLocTags:this.prLocTags,prUncertainCon:this.prUncertainCon,prMergers:this.prMergers,prAnnotator:this.prAnnotator,prNotes:this.prNotes,prFinished:this.prFinished,prReviewed:this.prReviewed,prSomaLoc:this.prSomaLoc,prOverrideSuperSetCheck:this.prOverrideSuperSetCheck,prOverrideConflictCheck:this.prOverrideConflictCheck,prGrowThreshold:this.prGrowThreshold,prSuperGrowThreshold:this.prSuperGrowThreshold};super.add("prNeuronName",this.prNeuronName),super.add("prCellType",this.prCellType),super.add("prTags",this.prTags),super.add("prLocTags",this.prLocTags),super.add("prUncertainCon",this.prUncertainCon),super.add("prMergers",this.prMergers),super.add("prAnnotator",this.prAnnotator),super.add("prNotes",this.prNotes),super.add("prFinished",this.prFinished),super.add("prReviewed",this.prReviewed),super.add("prSomaLoc",this.prSomaLoc),super.add("prOverrideSuperSetCheck",this.prOverrideSuperSetCheck),super.add("prOverrideConflictCheck",this.prOverrideConflictCheck),super.add("prGrowThreshold",this.prGrowThreshold),super.add("prSuperGrowThreshold",this.prSuperGrowThreshold)}reset(){super.reset()}toJSON(){return super.toJSON()}restoreState(e){if(e!=null)try{this.state=e,super.restoreState(this.state),this.changed.dispatch()}catch(t){this.reset()}}};var iw=class extends Gl{constructor(e){super(e);this.transform=e;this.prSomaLocCopyLoc=document.createElement("input");this.prSaveNeuron=document.createElement("input");let{element:t}=this;t.classList.add("neuroglancer-Proofread-widget"),this.addTextArea("Neuron Name",e.prNeuronName,2),this.addTextArea("Cell Type",e.prCellType),this.addTextArea("Tags",e.prTags),this.addTextArea("Location Tags",e.prLocTags,2),this.addTextArea("Uncertain Continuation",e.prUncertainCon,4),this.addTextArea("Merge Locations",e.prMergers,4),this.addTextArea("Notes",e.prNotes,8,28),this.addTextArea("Grow Threshold",e.prGrowThreshold),this.addTextArea("Super Grow Threshold",e.prSuperGrowThreshold),this.addCheckbox("Finished",e.prFinished),this.addCheckbox("Reviewed",e.prReviewed),this.addTextArea("Soma Location",e.prSomaLoc),this.addButton(this.prSomaLocCopyLoc,"Copy Location","button","prSomaLocCopyLoc"),this.addCheckbox("Override Set Check",e.prOverrideSuperSetCheck),this.addCheckbox("Override Conflict Check",e.prOverrideConflictCheck),this.addTextArea("Annotator",e.prAnnotator),this.addButton(this.prSaveNeuron,"Save Neuron","button","prSaveNeuron")}};var kV="Proofread",EV="pr";function DV(n){class e extends n{constructor(...r){super(...r);this.pr=new rw;this.pr.changed.add(this.specificationChanged.dispatch),this.tabs.add(kV,{label:kV,order:100,getter:()=>new iw(this.pr)})}restoreState(r){super.restoreState(r),this.pr.restoreState(r[EV])}toJSON(){let r=super.toJSON();return r[EV]=this.pr.toJSON(),r}}return e}var aw="selectedAlpha",ow="notSelectedAlpha",sw="objectAlpha",lw="saturation",cw="hoverHighlight",uw="hideSegmentZero",dw="baseSegmentColoring",pw="ignoreNullVisibleSet",B5="mesh",U5="skeletons",PV="segments",Kg="equivalences",fw="colorSeed",IV="segmentColors",hw="meshRenderScale",mw="crossSectionRenderScale",Xg="skeletonRendering",F5="skeletonShader",AV="segmentQuery",gw="meshSilhouetteRendering",MV="linkedSegmentationGroup",RV="linkedSegmentationColorGroup",yw="segmentDefaultColor",_V="anchorSegment",KC="skeletonShaderControl",VV=class extends j{constructor(e){super();this.layer=e;this.specificationChanged=new ze;this.localGraph=new dC;this.visibleSegments=this.registerDisposer(ks.makeWithCounterpart(this.layer.manager.rpc));this.segmentPropertyMap=new Ee(void 0);this.graph=new Ee(void 0);this.segmentEquivalences=this.registerDisposer(Ua.makeWithCounterpart(this.layer.manager.rpc,this.layer.registerDisposer(At(e=>e&&e.visibleSegmentEquivalencePolicy||Kt.MIN_REPRESENTATIVE,[this.graph]))));this.localSegmentEquivalences=!1;this.maxIdLength=new Ee(1);this.hideSegmentZero=new qe(!0,!0);this.segmentQuery=new Le("",Q);this.temporaryVisibleSegments=this.layer.registerDisposer(ks.makeWithCounterpart(this.layer.manager.rpc));this.temporarySegmentEquivalences=this.layer.registerDisposer(Ua.makeWithCounterpart(this.layer.manager.rpc,this.segmentEquivalences.disjointSets.visibleSegmentEquivalencePolicy));this.useTemporaryVisibleSegments=this.layer.registerDisposer(mt.make(this.layer.manager.rpc,!1));this.useTemporarySegmentEquivalences=this.layer.registerDisposer(mt.make(this.layer.manager.rpc,!1));let{specificationChanged:t}=this;this.visibleSegments.changed.add(t.dispatch),this.hideSegmentZero.changed.add(t.dispatch),this.segmentQuery.changed.add(t.dispatch)}restoreState(e){oe(e,uw,t=>this.hideSegmentZero.restoreState(t)),oe(e,Kg,t=>{this.localGraph.restoreState(t)}),oe(e,PV,t=>{let{segmentEquivalences:r,visibleSegments:i}=this;ge(t,a=>{let o=X.parseString(String(a),10);i.add(r.get(o))})}),oe(e,AV,t=>this.segmentQuery.restoreState(t))}toJSON(){let e={};e[uw]=this.hideSegmentZero.toJSON();let{visibleSegments:t}=this;t.size>0&&(e[PV]=t.toJSON());let{segmentEquivalences:r}=this;return this.localSegmentEquivalences&&r.size>0&&(e[Kg]=r.toJSON()),e[AV]=this.segmentQuery.toJSON(),e}assignFrom(e){this.maxIdLength.value=e.maxIdLength.value,this.hideSegmentZero.value=e.hideSegmentZero.value,this.visibleSegments.assignFrom(e.visibleSegments),this.segmentEquivalences.assignFrom(e.segmentEquivalences)}},OV=class extends j{constructor(e){super();this.layer=e;this.specificationChanged=new ze;this.segmentColorHash=Xd.getDefault();this.segmentStatedColors=this.registerDisposer(new Ls);this.tempSegmentStatedColors2d=this.registerDisposer(new Ls);this.segmentDefaultColor=new _v;this.tempSegmentDefaultColor2d=new Ee(void 0);this.highlightColor=new Ee(void 0);let{specificationChanged:t}=this;this.segmentColorHash.changed.add(t.dispatch),this.segmentStatedColors.changed.add(t.dispatch),this.tempSegmentStatedColors2d.changed.add(t.dispatch),this.segmentDefaultColor.changed.add(t.dispatch),this.tempSegmentDefaultColor2d.changed.add(t.dispatch),this.highlightColor.changed.add(t.dispatch)}restoreState(e){oe(e,fw,t=>this.segmentColorHash.restoreState(t)),oe(e,yw,t=>this.segmentDefaultColor.restoreState(t)),oe(e,IV,t=>{let r=Za(t,i=>ma(String(i)));for(let[i,a]of r){let o=X.parseString(String(i)),l=new X(Xa(a));this.segmentStatedColors.set(o,l)}})}toJSON(){let e={};e[fw]=this.segmentColorHash.toJSON(),e[yw]=this.segmentDefaultColor.toJSON();let{segmentStatedColors:t}=this;if(t.size>0){let r=e[IV]={};for(let[i,a]of t.unsafeEntries())r[i.toString()]=gn(Qa(a.low))}return e}assignFrom(e){this.segmentColorHash.value=e.segmentColorHash.value,this.segmentStatedColors.assignFrom(e.segmentStatedColors),this.tempSegmentStatedColors2d.assignFrom(e.tempSegmentStatedColors2d),this.segmentDefaultColor.value=e.segmentDefaultColor.value,this.highlightColor.value=e.highlightColor.value}},vw=class extends j{constructor(e,t){super();this.linkedGroup=e;this.propertyName=t;this.value}get changed(){return this.linkedGroup.root.changed}get value(){let e=this.linkedGroup.root.value;if(e!==this.curRoot){this.curRoot=e;let t=e.displayState[this.propertyName];if(e===this.linkedGroup.layer){let{curGroupState:r}=this;r!==void 0&&(t.assignFrom(r),r.dispose())}this.curGroupState=t.addRef()}return this.curGroupState}disposed(){var e;(e=this.curGroupState)==null||e.dispose()}},NV=class{constructor(e){this.layer=e;this.segmentSelectionState=new Lb;this.selectedAlpha=Nl(.5);this.saturation=Nl(1);this.notSelectedAlpha=Nl(0);this.hoverHighlight=new qe(!0,!0);this.silhouetteRendering=new Le(0,Zf,0);this.objectAlpha=Nl(1);this.ignoreNullVisibleSet=new qe(!0,!0);this.skeletonRenderingOptions=new Ob;this.shaderError=Sa();this.renderScaleHistogram=new Da;this.renderScaleTarget=zi(1);this.selectSegment=this.layer.selectSegment;this.transparentPickEnabled=this.layer.pick;this.baseSegmentColoring=new qe(!1,!1);this.baseSegmentHighlighting=new qe(!1,!1);this.useTempSegmentStatedColors2d=this.layer.registerDisposer(mt.make(this.layer.manager.rpc,!1));this.filterBySegmentLabel=this.layer.filterBySegmentLabel;this.moveToSegment=e=>{this.layer.moveToSegment(e)};this.linkedSegmentationGroup=this.layer.registerDisposer(new bg(this.layer.manager.rootLayers,this.layer,e=>e instanceof Qt,e=>e.displayState.linkedSegmentationGroup));this.linkedSegmentationColorGroup=this.layer.registerDisposer(new bg(this.layer.manager.rootLayers,this.layer,e=>e instanceof Qt,e=>e.displayState.linkedSegmentationColorGroup));this.originalSegmentationGroupState=this.layer.registerDisposer(new VV(this.layer));this.originalSegmentationColorGroupState=this.layer.registerDisposer(new OV(this.layer));e.displayState=this,this.segmentationGroupState=this.layer.registerDisposer(new vw(this.linkedSegmentationGroup,"originalSegmentationGroupState")),this.segmentationColorGroupState=this.layer.registerDisposer(new vw(this.linkedSegmentationColorGroup,"originalSegmentationColorGroupState")),this.hideSegmentZero=this.layer.registerDisposer(new Sc(this.segmentationGroupState,t=>t.hideSegmentZero)),this.segmentColorHash=this.layer.registerDisposer(new Uo(this.segmentationColorGroupState,t=>t.segmentColorHash)),this.segmentStatedColors=this.layer.registerDisposer(new Uo(this.segmentationColorGroupState,t=>t.segmentStatedColors)),this.tempSegmentStatedColors2d=this.layer.registerDisposer(new Uo(this.segmentationColorGroupState,t=>t.tempSegmentStatedColors2d)),this.segmentDefaultColor=this.layer.registerDisposer(new Uo(this.segmentationColorGroupState,t=>t.segmentDefaultColor)),this.tempSegmentDefaultColor2d=this.layer.registerDisposer(new Uo(this.segmentationColorGroupState,t=>t.tempSegmentDefaultColor2d)),this.highlightColor=this.layer.registerDisposer(new Uo(this.segmentationColorGroupState,t=>t.highlightColor)),this.segmentQuery=this.layer.registerDisposer(new Sc(this.segmentationGroupState,t=>t.segmentQuery)),this.segmentPropertyMap=this.layer.registerDisposer(new Sc(this.segmentationGroupState,t=>t.segmentPropertyMap))}},G5=su(CV(LV(DV(Ti)))),Qt=class extends G5{constructor(e){super(e);this.sliceViewRenderScaleHistogram=new Da;this.sliceViewRenderScaleTarget=zi(1);this.graphConnection=new Ee(void 0);this.segmentQueryFocusTime=new Ee(Number.NEGATIVE_INFINITY);this.selectSegment=(e,t)=>{this.manager.root.selectionState.captureSingleLayerState(this,r=>(r.value=e.clone(),!0),t)};this.filterBySegmentLabel=e=>{let t=_a(this.displayState,e),{label:r}=t;!r||this.filterSegments(r)};this.filterSegments=e=>{this.displayState.segmentationGroupState.value.segmentQuery.value=e,this.segmentQueryFocusTime.value=Date.now(),this.tabs.value="segments",this.manager.root.selectedLayer.layer=this.managedLayer};this.displayState=new NV(this);this.anchorSegment=new Le(void 0,e=>e===void 0?void 0:X.parseString(e));this.has2dLayer=this.registerDisposer(mn(e=>e.some(t=>t instanceof kg),{changed:this.layersChanged,value:this.renderLayers}));this.has3dLayer=this.registerDisposer(mn(e=>e.some(t=>t instanceof gm||t instanceof tp||t instanceof ip||t instanceof bm),{changed:this.layersChanged,value:this.renderLayers}));this.hasSkeletonsLayer=this.registerDisposer(mn(e=>e.some(t=>t instanceof ip),{changed:this.layersChanged,value:this.renderLayers}));this.registerDisposer(Ka((r,i)=>{r.registerDisposer(i.specificationChanged.add(this.specificationChanged.dispatch)),this.specificationChanged.dispatch()},this.displayState.segmentationGroupState)),this.registerDisposer(Ka((r,i)=>{r.registerDisposer(i.specificationChanged.add(this.specificationChanged.dispatch)),this.specificationChanged.dispatch()},this.displayState.segmentationColorGroupState)),this.displayState.segmentSelectionState.bindTo(this.manager.layerSelectedValues,this),this.displayState.selectedAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.saturation.changed.add(this.specificationChanged.dispatch),this.displayState.notSelectedAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.objectAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.hoverHighlight.changed.add(this.specificationChanged.dispatch),this.displayState.baseSegmentColoring.changed.add(this.specificationChanged.dispatch),this.displayState.ignoreNullVisibleSet.changed.add(this.specificationChanged.dispatch),this.displayState.skeletonRenderingOptions.changed.add(this.specificationChanged.dispatch),this.displayState.renderScaleTarget.changed.add(this.specificationChanged.dispatch),this.displayState.silhouetteRendering.changed.add(this.specificationChanged.dispatch),this.anchorSegment.changed.add(this.specificationChanged.dispatch),this.sliceViewRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.displayState.originalSegmentationGroupState.localGraph.changed.add(this.specificationChanged.dispatch),this.displayState.linkedSegmentationGroup.changed.add(()=>this.updateDataSubsourceActivations()),this.tabs.add("rendering",{label:"Render",order:-100,getter:()=>new YC(this)}),this.tabs.add("segments",{label:"Seg.",order:-50,getter:()=>new OC(this)});let t=this.registerDisposer(At(r=>r===void 0,[this.displayState.segmentationGroupState.value.graph]));this.tabs.add("graph",{label:"Graph",order:-25,getter:()=>new $S(this),hidden:t}),this.tabs.default="rendering"}bindSegmentListWidth(e){return ss(this.displayState,e)}get volumeOptions(){return{volumeType:gt.SEGMENTATION}}activateDataSubsources(e){let t=[],r=this.displayState.linkedSegmentationGroup.root.value===this,i;for(let a of e){if(this.addStaticAnnotations(a))continue;let{volume:o,mesh:l,segmentPropertyMap:c,segmentationGraph:d,local:p}=a.subsourceEntry.subsource;if(o instanceof zt){switch(o.dataType){case G.FLOAT32:a.deactivate("Data type not compatible with segmentation layer");continue}a.activate(()=>a.addRenderLayer(new kg(o,{...this.displayState,transform:a.getRenderLayerTransform(),renderScaleTarget:this.sliceViewRenderScaleTarget,renderScaleHistogram:this.sliceViewRenderScaleHistogram,localPosition:this.localPosition})),this.displayState.segmentationGroupState.value)}else l!==void 0?a.activate(()=>{let m={...this.displayState,transform:a.getRenderLayerTransform()};if(l instanceof tr)a.addRenderLayer(new gm(this.manager.chunkManager,l,m));else if(l instanceof mo)a.addRenderLayer(new tp(this.manager.chunkManager,l,m));else{let g=new Nb(this.manager.chunkManager,l,m);a.addRenderLayer(new ip(g.addRef())),a.addRenderLayer(new bm(g))}},this.displayState.segmentationGroupState.value):c!==void 0?r?(a.activate(()=>{}),t.push(c)):a.deactivate("Not supported on non-root linked segmentation layers"):d!==void 0?r?i!==void 0?a.deactivate("Only one segmentation graph is supported"):(i=d,a.activate(m=>{let g=d.connect(this);m.registerDisposer(()=>{g.dispose(),this.graphConnection.value=void 0});let v={...this.displayState,transform:a.getRenderLayerTransform()},b=g.createRenderLayers(this.manager.chunkManager,v,this.localPosition);this.graphConnection.value=g;for(let x of b)a.addRenderLayer(x)})):a.deactivate("Not supported on non-root linked segmentation layers"):p===mi.equivalences?r?i!==void 0?a.deactivate("Only one segmentation graph is supported"):(i=this.displayState.originalSegmentationGroupState.localGraph,a.activate(m=>{this.graphConnection.value=m.registerDisposer(i.connect(this)),m.registerDisposer(()=>{this.graphConnection.value=void 0})})):a.deactivate("Not supported on non-root linked segmentation layers"):a.deactivate("Not compatible with segmentation layer")}this.displayState.originalSegmentationGroupState.segmentPropertyMap.value=J1(this.manager.chunkManager,t),this.displayState.originalSegmentationGroupState.graph.value=i}getLegacyDataSourceSpecifications(e,t,r,i){let a=super.getLegacyDataSourceSpecifications(e,t,r,i),o=oe(t,B5,c=>c===null?null:Q(c)),l=oe(t,U5,c=>c===null?null:Q(c));if(o!==void 0||l!==void 0)for(let c of a)c.enableDefaultSubsources=!1,c.subsources=new Map([["default",{enabled:!0}],["bounds",{enabled:!0}]]);return o!=null&&a.push(Ml(this.manager.dataSourceProviderRegistry.convertLegacyUrl({url:o,type:"mesh"}))),l!=null&&a.push(Ml(this.manager.dataSourceProviderRegistry.convertLegacyUrl({url:l,type:"skeletons"}))),t[Kg]!==void 0&&i.find(c=>c.url===qh)===void 0&&a.push({url:qh,enableDefaultSubsources:!0,transform:{outputSpace:Oi,sourceRank:0,transform:void 0,inputSpace:Oi},subsources:new Map}),a}restoreState(e){super.restoreState(e),this.displayState.selectedAlpha.restoreState(e[aw]),this.displayState.saturation.restoreState(e[lw]),this.displayState.notSelectedAlpha.restoreState(e[ow]),this.displayState.hoverHighlight.restoreState(e[cw]),this.displayState.objectAlpha.restoreState(e[sw]),this.displayState.baseSegmentColoring.restoreState(e[dw]),this.displayState.silhouetteRendering.restoreState(e[gw]),this.displayState.ignoreNullVisibleSet.restoreState(e[pw]);let{skeletonRenderingOptions:t}=this.displayState;t.restoreState(e[Xg]);let r=e[F5];r!==void 0&&t.shader.restoreState(r),this.displayState.renderScaleTarget.restoreState(e[hw]),this.anchorSegment.restoreState(e[_V]),this.sliceViewRenderScaleTarget.restoreState(e[mw]);let i=oe(e,MV,Q);i!==void 0&&this.displayState.linkedSegmentationGroup.linkByName(i);let a=oe(e,RV,o=>o===!1?void 0:Q(o),i);a!==void 0&&this.displayState.linkedSegmentationColorGroup.linkByName(a),this.displayState.segmentationGroupState.value.restoreState(e),this.displayState.segmentationColorGroupState.value.restoreState(e)}toJSON(){var i;let e=super.toJSON();e[aw]=this.displayState.selectedAlpha.toJSON(),e[ow]=this.displayState.notSelectedAlpha.toJSON(),e[lw]=this.displayState.saturation.toJSON(),e[sw]=this.displayState.objectAlpha.toJSON(),e[cw]=this.displayState.hoverHighlight.toJSON(),e[dw]=this.displayState.baseSegmentColoring.toJSON(),e[pw]=this.displayState.ignoreNullVisibleSet.toJSON(),e[gw]=this.displayState.silhouetteRendering.toJSON(),e[_V]=this.anchorSegment.toJSON(),e[Xg]=this.displayState.skeletonRenderingOptions.toJSON(),e[hw]=this.displayState.renderScaleTarget.toJSON(),e[mw]=this.sliceViewRenderScaleTarget.toJSON();let{linkedSegmentationGroup:t,linkedSegmentationColorGroup:r}=this.displayState;return e[MV]=t.toJSON(),r.root.value!==t.root.value&&(e[RV]=(i=r.toJSON())!=null?i:!1),e[Kg]=this.displayState.originalSegmentationGroupState.localGraph.toJSON(),t.root.value===this&&Object.assign(e,this.displayState.segmentationGroupState.value.toJSON()),r.root.value===this&&Object.assign(e,this.displayState.segmentationColorGroupState.value.toJSON()),e}transformPickedValue(e){return e==null?e:kb(this.displayState,e,!0)}handleAction(e,t){switch(e){case"recolor":{this.displayState.segmentationColorGroupState.value.segmentColorHash.randomize();break}case"clear-segments":{if(!this.pick.value)break;this.displayState.segmentationGroupState.value.visibleSegments.clear();break}case"select":{if(!this.pick.value)break;let{segmentSelectionState:r}=this.displayState;if(r.hasSelectedSegment){let i=r.selectedSegment,{visibleSegments:a}=this.displayState.segmentationGroupState.value,o=!a.has(i);(o||t.segmentationToggleSegmentState===void 0)&&(t.segmentationToggleSegmentState=o),t.defer(()=>{t.segmentationToggleSegmentState===o&&a.set(i,o)})}break}}}selectionStateFromJson(e,t){super.selectionStateFromJson(e,t);let r=new X,{value:i}=e;typeof i=="number"&&(i=i.toString()),typeof i!="string"||!r.tryParseString(i)?e.value=void 0:e.value=r}selectionStateToJson(e,t){let r=super.selectionStateToJson(e,t),{value:i}=e;return i instanceof qi?t?r.value={key:i.key.toString(),value:i.value?i.value.toString():void 0,label:i.label}:r.value=(i.value||i.key).toString():i instanceof X&&(r.value=i.toString()),r}displaySegmentationSelection(e,t,r){let{value:i}=e,a;if((typeof i=="number"||typeof i=="string")&&(a=new X,!a.tryParseString(i.toString())))return!1;if(i instanceof X)a=i.clone();else if(i instanceof qi)a=i.key.clone();else return!1;let{displayState:o}=this,l=_a(o,a),{segmentEquivalences:c,segmentPropertyMap:{value:d}}=this.displayState.segmentationGroupState.value,p=c.get(a),m=wl(this.displayState,l);if(ls(o,r,r.redraw),r.registerDisposer(ss(o,m)),m.classList.add("neuroglancer-selection-details-segment"),t.appendChild(m),d!==void 0){let{inlineProperties:g}=d.segmentPropertyMap;if(g!==void 0){let v=d.getSegmentInlineIndex(p);if(v!==-1){for(let b of g.properties)if(b.type!=="label"){if(b.type==="description"){let x=b.values[v];if(!x)continue;let C=document.createElement("div");C.classList.add("neuroglancer-selection-details-segment-description"),C.textContent=x,t.appendChild(C)}else if(b.type==="number"||b.type==="string"){let x=b.values[v];if(b.type==="number"?isNaN(x):!x)continue;let C=document.createElement("div");C.classList.add("neuroglancer-selection-details-segment-property");let T=document.createElement("div");T.classList.add("neuroglancer-selection-details-segment-property-name"),T.textContent=b.id,b.description&&(T.title=b.description);let I=document.createElement("div");I.classList.add("neuroglancer-selection-details-segment-property-value"),I.textContent=x.toString(),C.appendChild(T),C.appendChild(I),t.appendChild(C)}}}}}return!0}displaySelectionState(e,t,r){let i=this.displaySegmentationSelection(e,t,r);return super.displaySelectionState(e,t,r)&&(i=!0),i}moveToSegment(e){for(let t of this.renderLayers){if(!(t instanceof tp))continue;let r=t.getObjectPosition(e);if(r!==void 0){this.setLayerPosition(t.displayState.transform.value,r);return}}Ce.showTemporaryMessage(`No position information loaded for segment ${e}`)}};Qt.type="segmentation",Qt.typeAbbreviation="seg",Qt.supportsPickOption=!0;var W5=10;function BV(n){return[{label:`Skeleton mode (${n})`,toolJson:`${Xg}.mode${n}`,isValid:e=>e.hasSkeletonsLayer,...Jg(e=>e.displayState.skeletonRenderingOptions[`params${n}`].mode)},{label:`Line width (${n})`,toolJson:`${Xg}.lineWidth${n}`,isValid:e=>e.hasSkeletonsLayer,toolDescription:`Skeleton line width (${n})`,title:`Skeleton line width (${n})`,...ea(e=>({value:e.displayState.skeletonRenderingOptions[`params${n}`].lineWidth,options:{min:1,max:40,step:1}}))}]}var XC=[{label:"Color seed",title:"Color segments based on a hash of their id",toolJson:fw,...vV()},{label:"Fixed color",title:"Use a fixed color for all segments without an explicitly-specified color",toolJson:yw,...SV()},{label:"Saturation",toolJson:lw,title:"Saturation of segment colors",...ea(n=>({value:n.displayState.saturation}))},{label:"Opacity (on)",toolJson:aw,isValid:n=>n.has2dLayer,title:"Opacity in cross-section views of segments that are selected",...ea(n=>({value:n.displayState.selectedAlpha}))},{label:"Opacity (off)",toolJson:ow,isValid:n=>n.has2dLayer,title:"Opacity in cross-section views of segments that are not selected",...ea(n=>({value:n.displayState.notSelectedAlpha}))},{label:"Resolution (slice)",toolJson:mw,isValid:n=>n.has2dLayer,...uu(n=>({histogram:n.sliceViewRenderScaleHistogram,target:n.sliceViewRenderScaleTarget}))},{label:"Resolution (mesh)",toolJson:hw,isValid:n=>n.has3dLayer,...uu(n=>({histogram:n.displayState.renderScaleHistogram,target:n.displayState.renderScaleTarget}))},{label:"Opacity (3d)",toolJson:sw,isValid:n=>n.has3dLayer,title:"Opacity of meshes and skeletons",...ea(n=>({value:n.displayState.objectAlpha}))},{label:"Silhouette (3d)",toolJson:gw,isValid:n=>n.has3dLayer,title:"Set to a non-zero value to increase transparency of object faces perpendicular to view direction",...ea(n=>({value:n.displayState.silhouetteRendering,options:{min:0,max:W5,step:.1}}))},{label:"Hide segment ID 0",toolJson:uw,title:"Disallow selection and display of segment id 0",...wo(n=>n.displayState.hideSegmentZero)},{label:"Base segment coloring",toolJson:dw,title:"Color base segments individually",...wo(n=>n.displayState.baseSegmentColoring)},{label:"Show all by default",title:"Show all segments if none are selected",toolJson:pw,...wo(n=>n.displayState.ignoreNullVisibleSet)},{label:"Highlight on hover",toolJson:cw,title:"Highlight the segment under the mouse pointer",...wo(n=>n.displayState.hoverHighlight)},...BV("2d"),...BV("3d")];for(let n of XC)zg(Qt,n);Qi(Qt);xg(gt.SEGMENTATION,Qt);gs(n=>{if(n.mesh!==void 0)return{layerConstructor:Qt,priority:1}});Ts(Qt,n=>({shaderControlState:n.displayState.skeletonRenderingOptions.shaderControlState}),KC);R_();V_();function Qg(n,e=0){let t=rn.clone([...n]);return t[3]=e,t}var Sw=K.fromValues(1,0,0),bw=K.fromValues(0,0,1),z5=Qg(Sw,.5),H5=Qg(bw,.5),$5=Qg(Sw,.25),j5=Qg(bw,.25),J5=rn.fromValues(.5,.5,.5,.01),q5=new X(Xa(z5)),Y5=new X(Xa(H5)),K5=new X(Xa(J5)),X5=rn.fromValues(0,0,0,.5),UV=class extends lt(ct()(tr),ig){getFragmentKey(e,t){return hM(t)}},FV=class{constructor(e,t){let r=/^(https?:\/\/[.\w:\-\/]+)\/segmentation\/(?:1\.0|table)\/([^\/]+)\/?$/,i=e.match(r);if(i===null)throw Error(`Graph URL invalid: ${e}`);this.segmentationUrl=`${i[1]}/segmentation/api/v${gp}/table/${i[2]}`,this.meshingUrl=`${i[1]}/meshing/api/v${gp}/table/${i[2]}`;try{Z(t),this.supported_api_versions=W(t,"supported_api_versions",a=>ge(a,fE))}catch(a){this.supported_api_versions=[0]}if(!(gp in this.supported_api_versions)){let a=`This Neuroglancer branch requires Graph Server version ${gp}, but the server only supports version(s) ${this.supported_api_versions}.`;throw new Error(a)}}},Q5=8,GV=class{constructor(e){Z(e),this.chunkSize=W(e,"chunk_size",t=>Ne(K.create(),t,St)),this.nBitsForLayerId=oe(e,"n_bits_for_layer_id",St,Q5)}};function Z5(n,e,t){let r=ax(n),i=W(n,"data_dir",l=>Tn(l,t)).url,a=W(n,"app",l=>new FV(e,l)),o=W(n,"graph",l=>new GV(l));return{...r,app:a,graph:o,dataUrl:i}}var WV=class extends Jm{constructor(e,t,r){super(e,void 0,r.dataUrl,r);this.chunkedGraphCredentialsProvider=t;this.info=r}getChunkedGraphSource(){let{rank:e}=this,t=this.info.scales[0],r=yM({rank:e,dataType:this.info.dataType,upperVoxelBound:t.size,chunkDataSize:Uint32Array.from(this.info.graph.chunkSize),baseVoxelOffset:t.voxelOffset}),i=e+1,a=new Float32Array(i*i);a[a.length-1]=1;let{lowerBounds:o,upperBounds:l}=this.info.modelSpace.boundingBoxes[0].box,c=new Float32Array(e),d=new Float32Array(e);for(let p=0;p<3;++p){let m=1;a[i*p+p]=m,a[i*e+p]=t.voxelOffset[p],c[p]=o[p],d[p]=l[p]}return{chunkSource:this.chunkManager.getChunkSource(a2,{spec:r,credentialsProvider:this.chunkedGraphCredentialsProvider,parameters:{url:`${this.info.app.segmentationUrl}/node`}}),chunkToMultiscaleTransform:a,lowerClipBound:c,upperClipBound:d}}};function zV(n){return W(n,"transform",e=>{let t=ae.create();return e!==void 0&&Ne(t.subarray(0,12),e,Qe),ae.transpose(t,t),t})}function eJ(n){Z(n);let e=W(n,"@type",Q),t;if(e==="neuroglancer_legacy_mesh"){let i=W(n,"sharding",$V);if(i===void 0)t=void 0;else{let a=0,o=10,l=zV(n);t={lodScaleMultiplier:a,transform:l,sharding:i,vertexQuantizationBits:o}}}else{if(e!=="neuroglancer_multilod_draco")throw new Error(`Unsupported mesh type: ${JSON.stringify(e)}`);{let i=W(n,"lod_scale_multiplier",it),a=W(n,"vertex_quantization_bits",St),o=zV(n),l=W(n,"sharding",$V);t={lodScaleMultiplier:i,transform:o,sharding:l,vertexQuantizationBits:a}}}let r=W(n,"segment_properties",Wt);return{metadata:t,segmentPropertyMap:r}}async function tJ(n,e,t){let r;try{r=await xw(n,e,t)}catch(i){if(ji(i))return{metadata:void 0};throw i}return eJ(r)}function HV(n){return n===void 0?hs.RAW:Mt(n,hs)}function nJ(n){if(n===void 0)return;Z(n);let e=W(n,"@type",Q);if(e!=="neuroglancer_uint64_sharded_v1")throw new Error(`Unsupported sharding format: ${JSON.stringify(e)}`);let t=W(n,"hash",c=>Mt(c,Kc)),r=W(n,"preshift_bits",rt),i=W(n,"shard_bits",rt),a=W(n,"minishard_bits",rt),o=W(n,"minishard_index_encoding",HV),l=W(n,"data_encoding",HV);return{hash:t,preshiftBits:r,shardBits:i,minishardBits:a,minishardIndexEncoding:o,dataEncoding:l}}function $V(n){if(n===void 0)return;Z(n);let e=new Array;for(let t in n){let r=Number(t);e[r]=nJ(n[r])}return e}function rJ(n,e,t){return n.getChunkSource(UV,{parameters:e,credentialsProvider:t})}async function iJ(n,e,t,r,i){let{metadata:a,segmentPropertyMap:o}=await tJ(n,void 0,r),l={manifestUrl:t,fragmentUrl:r,lod:0,sharding:a==null?void 0:a.sharding,nBitsForLayerId:i},c=(a==null?void 0:a.transform)||ae.create();return{source:rJ(n,l,e),transform:c,segmentPropertyMap:o}}function xw(n,e,t){return n.memoize.getUncounted({type:"graphene:metadata",url:t,credentialsProvider:pt(e)},async()=>await Mn(e,`${t}/info`,{},bt))}function aJ(n){let e=ae.create(),t=n.scales[0].resolution;for(let r=0;r<3;++r)e[5*r]=1/t[r];return e}async function oJ(n,e,t,r){let i=Z5(r,t,n.credentialsManager),a=new WV(n.chunkManager,e,i),o=new e2;n.state&&o.restoreState(n.state);let l=new Tw(i,e,a,o),{modelSpace:c}=i,d=[{id:"default",default:!0,subsource:{volume:a}},{id:"graph",default:!0,subsource:{segmentationGraph:l}},{id:"bounds",default:!0,subsource:{staticAnnotations:Pn(c.bounds)}}];if(i.segmentPropertyMap!==void 0){let p=Va(t,i.segmentPropertyMap),m=await xw(n.chunkManager,e,p),g=Qc(n.chunkManager,e,m,p);d.push({id:"properties",default:!0,subsource:{segmentPropertyMap:g}})}if(i.mesh!==void 0){let{source:p,transform:m}=await iJ(n.chunkManager,e,i.app.meshingUrl,Va(i.dataUrl,i.mesh),i.graph.nBitsForLayerId),g=aJ(i);ae.multiply(g,g,m),d.push({id:"mesh",default:!0,subsource:{mesh:p},subsourceToModelSubspaceTransform:g})}return{modelTransform:xt(c),subsources:d,state:o}}var Cw=class extends fp{get description(){return"Graphene file-backed data source"}get(e){let{url:t,parameters:r}=pp(e.providerUrl);return e.chunkManager.memoize.getUncounted({type:"graphene:get",providerUrl:t,parameters:r},async()=>{let{url:i,credentialsProvider:a}=Tn(t,e.credentialsManager),o;try{o=await xw(e.chunkManager,a,i)}catch(d){throw ji(d)&&r.type==="mesh"&&console.log("does this happen?"),d}Z(o);let l=oe(o,"redirect",Q);if(l!==void 0)throw new Uc(l);let c=oe(o,"@type",Q);switch(c){case"neuroglancer_multiscale_volume":case void 0:return await oJ(e,a,i,o);default:throw new Error(`Invalid type: ${JSON.stringify(c)}`)}})}};function Zg(n){for(let e of n.dataSources){let{loadState:t}=e;if(!(t===void 0||t.error!==void 0)){for(let r of t.subsources)if(r.enabled&&r.subsourceEntry.id==="graph")return r}}}function jV(n,e,t,r){let{subsourceEntry:i}=e,a=new bd(e.loadedDataSource.transform,[],[]),o=new Mp;o.color.value.set(r);let l=new ys({localPosition:n.localPosition,transform:e.getRenderLayerTransform(),source:a,displayState:o,dataSource:e.loadedDataSource.layerDataSource,subsourceIndex:e.subsourceIndex,subsourceId:i.id,subsubsourceId:t,role:In.ANNOTATION});return n.addAnnotationLayerState(l,e),l}function sJ(n){function e(a){return W(n,a,o=>X.parseString(String(o)))}let t=e(XV),r=e(QV),i=W(n,ZV,a=>rh(a));return{segmentId:t,rootId:r,position:i}}var JV="multicut",qV="focusSegment",YV="sinks",KV="sources",XV="segmentId",QV="rootId",ZV="position",e2=class{constructor(){this.changed=new re;this.multicutState=new t2;this.multicutState.changed.add(()=>{this.changed.dispatch()})}reset(){this.multicutState.reset()}toJSON(){return{[JV]:this.multicutState.toJSON()}}restoreState(e){oe(e,JV,t=>{this.multicutState.restoreState(t)})}},t2=class extends j{constructor(e=new Le(void 0,r=>r),t=new Ee(!1)){super();this.focusSegment=e;this.blueGroup=t;this.changed=new re;this.sinks=new vc;this.sources=new vc;let r=()=>{this.sinks.size===0&&this.sources.size===0&&(this.focusSegment.value=void 0)};this.registerDisposer(e.changed.add(this.changed.dispatch)),this.registerDisposer(this.sinks.changed.add(r)),this.registerDisposer(this.sources.changed.add(r)),this.registerDisposer(this.blueGroup.changed.add(this.changed.dispatch)),this.registerDisposer(this.sinks.changed.add(this.changed.dispatch)),this.registerDisposer(this.sources.changed.add(this.changed.dispatch))}reset(){this.focusSegment.value=void 0,this.blueGroup.value=!1,this.sinks.clear(),this.sources.clear()}toJSON(){let{focusSegment:e,sinks:t,sources:r}=this,i=a=>({[XV]:a.segmentId.toJSON(),[QV]:a.rootId.toJSON(),[ZV]:[...a.position]});return{[qV]:e.toJSON(),[YV]:[...t].map(i),[KV]:[...r].map(i)}}restoreState(e){let t=a=>ge(a,o=>sJ(o));oe(e,qV,a=>{this.focusSegment.restoreState(X.parseString(String(a)))});let r=W(e,YV,t),i=W(e,KV,t);for(let a of r)this.sinks.add(a);for(let a of i)this.sources.add(a)}swapGroup(){this.blueGroup.value=!this.blueGroup.value}get activeGroup(){return this.blueGroup.value?this.sources:this.sinks}get segments(){return[...this.redSegments,...this.blueSegments]}get redSegments(){return[...this.sinks].filter(e=>!X.equal(e.segmentId,e.rootId)).map(e=>e.segmentId)}get blueSegments(){return[...this.sources].filter(e=>!X.equal(e.segmentId,e.rootId)).map(e=>e.segmentId)}},ey=class extends sl{constructor(e,t,r,i){super(e,t.displayState.segmentationGroupState.value);this.graph=e;this.chunkSource=r;this.state=i;this.annotationLayerStates=[];this.lastDeselectionMessageExists=!1;t.displayState.segmentationGroupState.value.visibleSegments.changed.add((m,g)=>{m!==null&&(m=Array().concat(m)),this.visibleSegmentsChanged(m,g)});let{annotationLayerStates:o,state:{multicutState:l}}=this,c=Zg(t),d=jV(t,c,"sinks",Sw),p=jV(t,c,"sources",bw);l2(l.sinks,d),l2(l.sources,p),o.push(d,p)}createRenderLayers(e,t,r){return[new o2(e,this.chunkSource.getChunkedGraphSource(),t,r,this.graph.info.graph.nBitsForLayerId)]}visibleSegmentsChanged(e,t){let{segmentsState:r}=this;if(e===null){let i=this.segmentsState.visibleSegments.size;this.segmentsState.segmentEquivalences.clear(),Ce.showTemporaryMessage(`Deselected all ${i} segments.`,3e3);return}for(let i of e){let a=fM(i,this.graph.info.graph.nBitsForLayerId),o=i.clone();if(t)a&&this.graph.getRoot(o).then(l=>{r.visibleSegments.delete(o),r.visibleSegments.add(l)});else if(!a){let{focusSegment:{value:l}}=this.graph.state.multicutState;if(l&&X.equal(i,l)){r.visibleSegments.add(i),Ce.showTemporaryMessage("Can't deselect active multicut segment.",3e3);return}let c=[...r.segmentEquivalences.setElements(i)].length;r.segmentEquivalences.deleteSet(i),this.lastDeselectionMessage&&this.lastDeselectionMessageExists&&(this.lastDeselectionMessage.dispose(),this.lastDeselectionMessageExists=!1),this.lastDeselectionMessage=Ce.showMessage(`Deselected ${c} segments.`),this.lastDeselectionMessageExists=!0,setTimeout(()=>{this.lastDeselectionMessageExists&&(this.lastDeselectionMessage.dispose(),this.lastDeselectionMessageExists=!1)},2e3)}}}computeSplit(e,t){}async submitMulticut(e){let{state:{multicutState:t}}=this,{sinks:r,sources:i}=t;if(r.size===0||i.size===0)return Ce.showTemporaryMessage("Must select both red and blue groups to perform a multi-cut.",7e3),!1;{let a=await this.graph.graphServer.splitSegments([...r],[...i],e);if(a.length===0)return Ce.showTemporaryMessage("No split found.",3e3),!1;{let o=t.focusSegment.value;t.reset();let{segmentsState:l}=this;return l.visibleSegments.delete(o),l.visibleSegments.add(a),!0}}}};async function ww(n,e){let t=new Ce(!0);t.setText(e.initialMessage);let r=t.dispose.bind(t);try{let i=await n;return r(),i}catch(i){if(i instanceof Cr&&i.response){let a;i.response.headers.get("content-type")==="application/json"?a=(await i.response.json()).message:a=await i.response.text();let{errorPrefix:o=""}=e;throw t.setErrorMessage(o+a),t.setVisible(!0),new Error(`[${i.response.status}] ${o}${a}`)}throw i}}var n2=Symbol("Graph Server Not Specified."),r2=class{constructor(e,t){this.url=e;this.credentialsProvider=t}async getRoot(e,t=""){let r=new Date(t).valueOf()/1e3,i=`${this.url}/node/${String(e)}/root?int64_as_str=1${Number.isNaN(r)?"":`&timestamp=${r}`}`,a=Mn(this.credentialsProvider,i,{},ag),l=await(await ww(a,{initialMessage:`Retrieving root for segment ${e}`,errorPrefix:"Could not fetch root: "})).json();return X.parseString(l.root_id)}async mergeSegments(e,t,r){let{url:i}=this;if(i==="")return Promise.reject(n2);let a=Mn(this.credentialsProvider,`${i}/merge?int64_as_str=1`,{method:"POST",body:JSON.stringify([[String(e.segmentId),...e.position.map((c,d)=>c*r[d])],[String(t.segmentId),...t.position.map((c,d)=>c*r[d])]])},ag),l=await(await ww(a,{initialMessage:`Merging ${e.segmentId} and ${t.segmentId}`,errorPrefix:"Merge failed: "})).json();return X.parseString(l.new_root_ids[0])}async splitSegments(e,t,r){let{url:i}=this;if(i==="")return Promise.reject(n2);let a=Mn(this.credentialsProvider,`${i}/split?int64_as_str=1`,{method:"POST",body:JSON.stringify({sources:e.map(d=>[String(d.segmentId),...d.position.map((p,m)=>p*r[m])]),sinks:t.map(d=>[String(d.segmentId),...d.position.map((p,m)=>p*r[m])])})},ag),l=await(await ww(a,{initialMessage:`Splitting ${e.length} sources from ${t.length} sinks`,errorPrefix:"Split failed: "})).json(),c=new Array(l.new_root_ids.length);for(let d=0;d<c.length;++d)c[d]=X.parseString(l.new_root_ids[d]);return c}},Tw=class extends ol{constructor(e,t,r,i){super();this.info=e;this.chunkSource=r;this.state=i;this.connections=new Set;this.graphServer=new r2(e.app.segmentationUrl,t)}connect(e){let t=new ey(this,e,this.chunkSource,this.state);return this.connections.add(t),t.registerDisposer(()=>{this.connections.delete(t)}),t}get visibleSegmentEquivalencePolicy(){return Kt.MAX_REPRESENTATIVE|Kt.NONREPRESENTATIVE_EXCLUDED}getRoot(e){return this.graphServer.getRoot(e)}tabContents(e,t,r){let i=document.createElement("div");i.style.display="contents";let a=document.createElement("div");a.className="neuroglancer-segmentation-toolbox",a.appendChild(Al(t,e,{toolJson:Lw,label:"Multicut",title:"Multicut segments"})),a.appendChild(Al(t,e,{toolJson:kw,label:"Merge",title:"Merge segments"})),i.appendChild(a),i.appendChild(t.registerDisposer(new s2(e,e.annotationDisplayState)).element);let o=r.element;return o.classList.add("neuroglancer-annotations-tab"),o.classList.add("neuroglancer-graphene-tab"),i}async merge(e,t){return new X}async split(e,t){return{include:e,exclude:t}}trackSegment(e,t){return()=>{console.log("trackSegment... do nothing",e,t)}}},i2=class extends ul{constructor(e,t){super(e,t)}},a2=class extends lt(ct()(i2),rg){},o2=class extends hi{constructor(e,t,r,i,a){super();this.chunkManager=e;this.source=t;this.displayState=r;this.localPosition=i;this.layerChunkProgressInfo=new po;this.leafRequestsActive=this.registerDisposer(mt.make(e.rpc,!0)),this.chunkTransform=this.registerDisposer(mn(l=>Il(()=>Qs(yp(l))),this.displayState.transform));let o=this.sharedObject=this.backend=this.registerDisposer(new cs(e,r,this.layerChunkProgressInfo));o.RPC_TYPE_ID=mM,o.initializeCounterpartWithChunkManager({source:t.chunkSource.addCounterpartRef(),localPosition:this.registerDisposer(mt.makeFromExisting(e.rpc,this.localPosition)).rpcId,leafRequestsActive:this.leafRequestsActive.rpcId,nBitsForLayerId:this.registerDisposer(mt.make(e.rpc,a)).rpcId}),this.registerDisposer(o.visibility.add(this.visibility)),this.registerDisposer(this.leafRequestsActive.changed.add(()=>{this.showOrHideMessage(this.leafRequestsActive.value)}))}attach(e){super.attach(e);let t=this.chunkTransform.value,r=e.view.displayDimensionRenderInfo.value;e.state={chunkTransform:t,displayDimensionRenderInfo:r},e.state.source=e.registerDisposer(Dn((i,a,o)=>{let l=pl(o,a,c=>[[this.source]],e.messages,this);return e.view.flushBackendProjectionParameters(),this.sharedObject.rpc.invoke(gM,{layer:this.sharedObject.rpcId,view:e.view.rpcId,displayDimensionRenderInfo:o,sources:cl(l)}),l[0][0]},this.displayState.transform,e.view.displayDimensionRenderInfo))}isReady(){return!0}showOrHideMessage(e){this.leafRequestsStatusMessage&&e?(this.leafRequestsStatusMessage.dispose(),this.leafRequestsStatusMessage=void 0,Ce.showTemporaryMessage("Loading chunked graph segmentation...",3e3)):!this.leafRequestsStatusMessage&&!e&&(this.leafRequestsStatusMessage=Ce.showMessage("At this zoom level, chunked graph segmentation will not be loaded. Please zoom in if you wish to load it."))}},Lw="grapheneMulticutSegments",kw="grapheneMergeSegments",s2=class extends Ig{constructor(e,t){super(e,t);this.layer=e;this.displayState=t;let{graphConnection:{value:r}}=e;if(r instanceof ey)for(let i of r.annotationLayerStates)this.annotationStates.add(i)}get annotationStates(){return this._annotationStates===void 0&&(this._annotationStates=this.registerDisposer(new Pg)),this._annotationStates}},l2=(n,e)=>{let t=e.source;t.childDeleted.add(i=>{let a=[...n].find(o=>{var l;return((l=o.annotationReference)==null?void 0:l.id)===i});a&&n.delete(a)});let r=i=>{let a={id:"",point:i.position,type:Oe.POINT,properties:[],relatedSegments:[[i.segmentId,i.rootId]]},o=t.add(a);i.annotationReference=o};n.changed.add((i,a)=>{if(i===null){for(let o of t)t.delete(t.getReference(o.id));return}a?r(i):i.annotationReference&&t.delete(i.annotationReference)});for(let i of n)r(i)};function lJ(n,e){let r=Zg(e).getRenderLayerTransform(),i=Il(()=>Qs(yp(r.value)));if(i.error!==void 0)return;let a=new Float32Array(i.modelTransform.unpaddedRank);if(!!Ni(a,n,e.localPosition.value,i.layerRank,i.combinedGlobalLocalToChunkTransform))return a}var cJ=(n,e)=>{if(e.updateUnconditionally())return lJ(e.unsnappedPosition,n)},uJ=Me.fromObject({"at:shift?+control+mousedown0":{action:"set-anchor"},"at:shift?+keys":{action:"swap-group"}}),c2=class extends Gr{toJSON(){return Lw}activate(e){let{layer:t}=this,{graphConnection:{value:r}}=t;if(!r||!(r instanceof ey))return;let{state:{multicutState:i},segmentsState:a}=r;if(i===void 0)return;let{body:o,header:l}=Oa(e);l.textContent="Multicut segments",o.classList.add("graphene-multicut-status"),o.appendChild(He({text:"Swap",title:"Swap group",onClick:()=>{i.swapGroup()}})),o.appendChild(He({text:"Clear",title:"Clear multicut",onClick:()=>{i.reset()}})),o.appendChild(He({text:"Submit",title:"Submit multicut",onClick:()=>{let C=Zg(this.layer).loadedDataSource.transform.inputSpace.value.scales.map(T=>T/1e-9);r.submitMulticut(C).then(T=>{T&&e.cancel()})}}));let c=document.createElement("div");c.className="activeGroupIndicator",c.innerHTML="Active Group: ",o.appendChild(c);let{displayState:d}=this.layer,p=d.segmentationGroupState.value,m=d.baseSegmentHighlighting.value,g=d.highlightColor.value;e.bindInputEventMap(uJ),e.registerDisposer(()=>{v(),d.baseSegmentHighlighting.value=m,d.highlightColor.value=g});let v=()=>{xl(p),d.useTempSegmentStatedColors2d.value=!1,d.tempSegmentStatedColors2d.value.clear(),d.tempSegmentDefaultColor2d.value=void 0,d.highlightColor.value=void 0},b=()=>{v(),c.classList.toggle("blueGroup",i.blueGroup.value);let x=i.focusSegment.value;if(x!==void 0){d.baseSegmentHighlighting.value=!0,d.highlightColor.value=i.blueGroup.value?j5:$5,a.useTemporaryVisibleSegments.value=!0,a.useTemporarySegmentEquivalences.value=!0,a.temporaryVisibleSegments.add(x);for(let C of i.segments)a.temporaryVisibleSegments.add(C);for(let C of a.segmentEquivalences.setElements(x))a.temporaryVisibleSegments.has(C)||a.temporarySegmentEquivalences.link(x,C);d.tempSegmentDefaultColor2d.value=X5,d.tempSegmentStatedColors2d.value.set(x,K5);for(let C of i.redSegments)d.tempSegmentStatedColors2d.value.set(C,q5);for(let C of i.blueSegments)d.tempSegmentStatedColors2d.value.set(C,Y5);d.useTempSegmentStatedColors2d.value=!0}};b(),e.registerDisposer(i.changed.add(b)),e.bindAction("swap-group",x=>{x.stopPropagation(),i.swapGroup()}),e.bindAction("set-anchor",x=>{x.stopPropagation();let C=Ew(this,p.visibleSegments);if(!C)return;let{rootId:T,segmentId:I}=C,{focusSegment:P,segments:M}=i;if(P.value===void 0&&(P.value=T.clone()),!X.equal(P.value,T)){Ce.showTemporaryMessage(`The selected supervoxel has root segment ${T.toString()}, but the supervoxels already selected have root ${P.value.toString()}`,12e3);return}if(!X.equal(T,I)){for(let E of M)if(X.equal(E,I)){Ce.showTemporaryMessage(`Supervoxel ${I.toString()} has already been selected`,7e3);return}}i.activeGroup.add(C)})}get description(){return"multicut"}},Ew=(n,e)=>{let{layer:t,mouseState:r}=n,{segmentSelectionState:{value:i,baseValue:a}}=t.displayState;if(!a||!i)return;if(!e.has(i)){Ce.showTemporaryMessage("The selected supervoxel is of an unselected segment",7e3);return}let o=cJ(t,r);if(o!==void 0)return{rootId:i.clone(),segmentId:a.clone(),position:o}},dJ=Me.fromObject({"at:shift?+mousedown0":{action:"merge-segments"}}),u2=class extends Gr{constructor(){super(...arguments);this.lastAnchorSelection=new Ee(void 0)}activate(e){let t=this.layer.displayState.segmentationGroupState.value,{graph:{value:r}}=t;if(!(r instanceof Tw))return;let{body:i,header:a}=Oa(e);a.textContent="Merge segments",i.classList.add("graphene-merge-segments-status");let o=document.createElement("div");o.style.display="contents",i.appendChild(o);let l=v=>{let b=wl(this.layer.displayState,v);return b.classList.add("neuroglancer-segment-list-entry-double-line"),b},c=(v,b)=>{let x=document.createElement("div");x.classList.add("graphene-merge-segments-point");let C=document.createElement("span");C.textContent=b,x.appendChild(C);let T=l(_a(this.layer.displayState,v));x.appendChild(T),o.appendChild(x)},d=He({text:"Clear",title:"Clear selection",onClick:()=>{for(this.lastAnchorSelection.value=void 0;o.firstChild;)o.removeChild(o.firstChild);i.removeChild(d)}}),p=v=>{c(v,"Sink: "),i.appendChild(d)},m=v=>{i.removeChild(d),c(v,"Source: ")};e.bindInputEventMap(dJ),e.registerDisposer(()=>{this.lastAnchorSelection.value=void 0});let g=!1;e.bindAction("merge-segments",v=>{v.stopPropagation(),(async()=>{let b=this.lastAnchorSelection.value;if(b){if(!g){let x=Ew(this,t.visibleSegments);if(x){g=!0,m(x.rootId);let T=Zg(this.layer).loadedDataSource.transform.inputSpace.value.scales.map(M=>M/1e-9),I=await r.graphServer.mergeSegments(b,x,T),{visibleSegments:P}=t;P.delete(b.rootId),P.delete(x.rootId),P.add(I),this.lastAnchorSelection.value=void 0,e.cancel()}}}else{let x=Ew(this,t.visibleSegments);x&&(this.lastAnchorSelection.value=x,p(x.rootId))}})()})}toJSON(){return kw}get description(){return"merge segments"}};wi(Qt,Lw,n=>new c2(n,!0));wi(Qt,kw,n=>new u2(n,!0));Ot("graphene",()=>new Cw);var Es;(function(t){t[t.DEFAULT=0]="DEFAULT",t[t.ADDITIVE=1]="ADDITIVE"})(Es||(Es={}));var d2=new Map([[0,n=>{n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA)}],[1,n=>{n.blendFunc(n.SRC_ALPHA,n.ONE)}]]);function p2(n=0){return new us(Es,n)}var f2=`#uicontrol invlerp normalized
void main() {
  emitGrayscale(normalized());
}
`;function h2(n=f2){return Yo(n)}function Dw(n,e){n.addFragmentCode(`
#define VOLUME_RENDERING false

void emitRGBA(vec4 rgba) {
  emit(vec4(rgba.rgb, rgba.a * uOpacity));
}
void emitRGB(vec3 rgb) {
  emit(vec4(rgb, uOpacity));
}
void emitGrayscale(float value) {
  emit(vec4(value, value, value, uOpacity));
}
void emitTransparent() {
  emit(vec4(0.0, 0.0, 0.0, 0.0));
}
`),n.addFragmentCode(Bi),Gi(e,n),n.setFragmentMainFunction(Ui(e.parseResult.code))}var Pw=class extends Ap{constructor(e,t){var o,l,c;let{opacity:r,blendMode:i,shaderControlState:a}=t;super(e,{...t,fallbackShaderParameters:new Ee(Qo(lo(f2,{imageData:{dataType:e.dataType,channelRank:(c=(l=(o=t.channelCoordinateSpace)==null?void 0:o.value)==null?void 0:l.rank)!=null?c:0}}))),encodeShaderParameters:d=>d.key,shaderParameters:a.builderState,dataHistogramSpecifications:a.histogramSpecifications});this.shaderControlState=a,this.opacity=r,this.blendMode=i,this.registerDisposer(r.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(i.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(a.changed.add(this.redrawNeeded.dispatch))}defineShader(e,t){if(t.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");e.addUniform("highp float","uOpacity"),Dw(e,t)}initializeShader(e,t,r){let{gl:i}=this;i.uniform1f(t.uniform("uOpacity"),this.opacity.value),ni(i,t,this.shaderControlState,r.parseResult.controls)}setGLBlendMode(e,t){let r=this.blendMode.value;r===Es.ADDITIVE||t>0?(e.enable(e.BLEND),d2.get(r)(e)):e.disable(WebGL2RenderingContext.BLEND)}};var m2="volume_rendering/VolumeRenderingRenderLayer",g2="volume_rendering/VolumeRenderingRenderLayer/update",ty=64,pJ=Dt.create();function y2(n,e,t){let r=0,i=0;for(let d=0;d<3;++d){let p=n[16+d],m=p*e[d],g=p*t[d];r+=Math.min(m,g),i+=Math.max(m,g)}let a=-n[19],o=Math.max(a,r),l=n[23],c=Math.min(l,i);return{near:a,far:l,adjustedNear:o,adjustedFar:c}}function Iw(n,e,t,r,i,a){if(r.length===0)return;let{viewMatrix:o,projectionMat:l,displayDimensionRenderInfo:c}=n,{voxelPhysicalScales:d}=c,p=dd(d),g=(Kf(l)/ty)**3,v=Dt.determinant(Hs(pJ,o)),b=D=>{let E=r[D];return Math.abs(E.chunkLayout.detTransform*v)},x=r.length-1,C=b(x);for(let D=x-1;D>=0;--D){let E=b(D);if(Math.abs(E-g)<Math.abs(C-g))C=E,x=D;else break}let T=Math.pow(C*p/v,1/3),I=Math.pow(C,1/3)*n.width/(2*l[0]),P=!0,M=r[x];_h(n,e,M,(D,E)=>{P&&(i(M,x,T,I,E),P=!1),a(M,x,D)})}var fJ=ae.create(),hJ=new Float32Array(24),Aw=class extends Ur{get gl(){return this.multiscaleSource.chunkManager.gl}get isTransparent(){return!0}get isVolumeRendering(){return!0}constructor(e){super();this.multiscaleSource=e.multiscaleSource,this.transform=e.transform,this.channelCoordinateSpace=e.channelCoordinateSpace,this.shaderControlState=e.shaderControlState,this.localPosition=e.localPosition,this.renderScaleTarget=e.renderScaleTarget,this.renderScaleHistogram=e.renderScaleHistogram,this.registerDisposer(this.renderScaleHistogram.visibility.add(this.visibility));let t=this.registerDisposer(At(o=>o.rank,[this.channelCoordinateSpace]));this.shaderGetter=Ad(this,this.gl,{memoizeKey:"VolumeRenderingRenderLayer",parameters:e.shaderControlState.builderState,getContextKey:({emitter:o,chunkFormat:l})=>`${pt(o)}:${l.shaderKey}`,shaderError:e.shaderError,extraParameters:t,defineShader:(o,{emitter:l,chunkFormat:c},d,p)=>{if(d.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");Lr(o),o.addFragmentCode(`
#define VOLUME_RENDERING true
`),l(o),o.addUniform("highp float","uNearLimitFraction"),o.addUniform("highp float","uFarLimitFraction"),o.addUniform("highp int","uMaxSteps"),o.addUniform("highp vec3","uTranslation"),o.addUniform("highp mat4","uModelViewProjectionMatrix"),o.addUniform("highp mat4","uInvModelViewProjectionMatrix"),o.addUniform("highp vec3","uChunkDataSize"),o.addUniform("highp vec3","uLowerClipBound"),o.addUniform("highp vec3","uUpperClipBound"),o.addUniform("highp float","uBrightnessFactor"),o.addVarying("highp vec4","vNormalizedPosition"),o.addVertexCode(NR),o.setVertexMain(`
vec3 boxVertex = getBoxFaceVertexPosition(gl_VertexID);
vec3 position = max(uLowerClipBound, min(uUpperClipBound, uTranslation + boxVertex * uChunkDataSize));
vNormalizedPosition = gl_Position = uModelViewProjectionMatrix * vec4(position, 1.0);
gl_Position.z = 0.0;
`),o.addFragmentCode(`
vec3 curChunkPosition;
vec4 outputColor;
void userMain();
`),Cm(o,c,p,"curChunkPosition"),o.addFragmentCode(`
void emitRGBA(vec4 rgba) {
  float alpha = rgba.a * uBrightnessFactor;
  outputColor += vec4(rgba.rgb * alpha, alpha);
}
void emitRGB(vec3 rgb) {
  emitRGBA(vec4(rgb, 1.0));
}
void emitGrayscale(float value) {
  emitRGB(vec3(value, value, value));
}
void emitTransparent() {
  emitRGBA(vec4(0.0, 0.0, 0.0, 0.0));
}
`),o.setFragmentMainFunction(`
void main() {
  vec2 normalizedPosition = vNormalizedPosition.xy / vNormalizedPosition.w;
  vec4 nearPointH = uInvModelViewProjectionMatrix * vec4(normalizedPosition, -1.0, 1.0);
  vec4 farPointH = uInvModelViewProjectionMatrix * vec4(normalizedPosition, 1.0, 1.0);
  vec3 nearPoint = nearPointH.xyz / nearPointH.w;
  vec3 farPoint = farPointH.xyz / farPointH.w;
  vec3 rayVector = farPoint - nearPoint;
  vec3 boxStart = max(uLowerClipBound, uTranslation);
  vec3 boxEnd = min(boxStart + uChunkDataSize, uUpperClipBound);
  float intersectStart = uNearLimitFraction;
  float intersectEnd = uFarLimitFraction;
  for (int i = 0; i < 3; ++i) {
    float startPt = nearPoint[i];
    float endPt = farPoint[i];
    float boxLower = boxStart[i];
    float boxUpper = boxEnd[i];
    float r = rayVector[i];
    float startFraction;
    float endFraction;
    if (startPt >= boxLower && startPt <= boxUpper) {
      startFraction = 0.0;
    } else {
      startFraction = min((boxLower - startPt) / r, (boxUpper - startPt) / r);
    }
    if (endPt >= boxLower && endPt <= boxUpper) {
      endFraction = 1.0;
    } else {
      endFraction = max((boxLower - startPt) / r, (boxUpper - startPt) / r);
    }
    intersectStart = max(intersectStart, startFraction);
    intersectEnd = min(intersectEnd, endFraction);
  }
  float stepSize = (uFarLimitFraction - uNearLimitFraction) / float(uMaxSteps - 1);
  int startStep = int(floor((intersectStart - uNearLimitFraction) / stepSize));
  int endStep = min(uMaxSteps, int(floor((intersectEnd - uNearLimitFraction) / stepSize)) + 1);
  outputColor = vec4(0, 0, 0, 0);
  for (int step = startStep; step < endStep; ++step) {
    vec3 position = mix(nearPoint, farPoint, uNearLimitFraction + float(step) * stepSize);
    curChunkPosition = position - uTranslation;
    userMain();
  }
  emit(outputColor, 0u);
}
`),o.addFragmentCode(Bi),Gi(d,o),o.addFragmentCode(`
#define main userMain
`+Ui(d.parseResult.code)+`
#undef main
`)}}),this.vertexIdHelper=this.registerDisposer(zn.get(this.gl)),this.registerDisposer(this.renderScaleTarget.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.shaderControlState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.localPosition.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.transform.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.shaderControlState.fragmentMain.changed.add(this.redrawNeeded.dispatch));let{chunkManager:r}=this.multiscaleSource,i=this.registerDisposer(new ka(this.layerChunkProgressInfo)),a=r.rpc;i.RPC_TYPE_ID=m2,i.initializeCounterpart(a,{chunkManager:r.rpcId,localPosition:this.registerDisposer(mt.makeFromExisting(a,this.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(mt.makeFromExisting(a,this.renderScaleTarget)).rpcId}),this.backend=i}get dataType(){return this.multiscaleSource.dataType}attach(e){super.attach(e),e.state={sources:e.registerDisposer(Dn((t,r,i)=>{let a=pl(i,r,o=>this.multiscaleSource.getSources(o),e.messages,this);for(let o of a)for(let l of o)t.registerDisposer(l.source);return e.view.flushBackendProjectionParameters(),this.backend.rpc.invoke(g2,{layer:this.backend.rpcId,view:e.view.rpcId,sources:cl(a)}),this.redrawNeeded.dispatch(),a},this.transform,e.view.displayDimensionRenderInfo))}}get chunkManager(){return this.multiscaleSource.chunkManager}draw(e,t){if(!e.emitColor)return;let r=t.state.sources.value;if(r.length===0)return;let i=0,a=0,o=null,l,c,d=K.create(),{gl:p}=this;this.vertexIdHelper.enable();let{renderScaleHistogram:m}=this;m.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);let g=()=>{o!==null&&(l!==null&&l.endDrawing(p,o),(C!==0||T!==0)&&m.add(i,a,C,T))},v=!0,{projectionParameters:b}=e,x,C=0,T=0,I,P=this.multiscaleSource.rank,M=K.create();p.enable(WebGL2RenderingContext.CULL_FACE),p.cullFace(WebGL2RenderingContext.FRONT),Iw(e.projectionParameters,this.localPosition.value,this.renderScaleTarget.value,r[0],(D,E,V,O)=>{i=V,a=O;let B=Rc(b,D.chunkLayout),z=D.source,{fixedPositionWithinChunk:_,chunkDisplayDimensionIndices:U}=D;for(let ye of U)_[ye]=0;let N=z.chunkFormat;if(N!==l&&(l=N,g(),c=this.shaderGetter({emitter:e.emitter,chunkFormat:N}),o=c.shader,o!==null&&(o.bind(),N!==null&&(ni(p,o,this.shaderControlState,c.parameters.parseResult.controls),N.beginDrawing(p,o),N.beginSource(p,o)))),I=void 0,o===null)return;x=z.chunks,d.fill(1);let J=ae.multiply(fJ,b.viewProjectionMat,B.transform);p.uniformMatrix4fv(o.uniform("uModelViewProjectionMatrix"),!1,J);let ie=hJ;$s(ie,J),ae.invert(J,J),p.uniformMatrix4fv(o.uniform("uInvModelViewProjectionMatrix"),!1,J);let{near:pe,far:me,adjustedNear:Pe,adjustedFar:le}=y2(ie,D.lowerClipDisplayBound,D.upperClipDisplayBound),Re=(le-Pe)/(ty-1)/(me-pe);p.uniform1f(o.uniform("uBrightnessFactor"),Re);let Ue=(Pe-pe)/(me-pe),et=(le-pe)/(me-pe);p.uniform1f(o.uniform("uNearLimitFraction"),Ue),p.uniform1f(o.uniform("uFarLimitFraction"),et),p.uniform1i(o.uniform("uMaxSteps"),ty),p.uniform3fv(o.uniform("uLowerClipBound"),D.lowerClipDisplayBound),p.uniform3fv(o.uniform("uUpperClipBound"),D.upperClipDisplayBound)},D=>{if(o===null)return;let E=D.curPositionInChunks.join(),V=x.get(E);if(V!==void 0&&V.state===Ze.GPU_MEMORY){let O=D.chunkLayout.size,B=V.chunkDataSize,{chunkDisplayDimensionIndices:z,fixedPositionWithinChunk:_,chunkTransform:{channelToChunkDimensionIndices:U}}=D,{}=D;if(B!==I){I=B;for(let J=0;J<3;++J){let ie=z[J];d[J]=ie===-1||ie>=P?1:I[ie]}p.uniform3fv(o.uniform("uChunkDataSize"),d)}let{chunkGridPosition:N}=V;for(let J=0;J<3;++J){let ie=z[J];M[J]=ie===-1||ie>=P?0:O[J]*N[ie]}l!=null&&l.bindChunk(p,o,V,_,z,U,v),v=!1,p.uniform3fv(o.uniform("uTranslation"),M),BR(p,1,1),++C}else++T}),p.disable(WebGL2RenderingContext.CULL_FACE),g(),this.vertexIdHelper.disable()}isReady(e,t){let r=t.state.sources.value;if(r.length===0)return!0;let i=!1;return Iw(e.projectionParameters,this.localPosition.value,this.renderScaleTarget.value,r[0],()=>{},a=>{let o=a.source.chunks.get(a.curPositionInChunks.join());(o===void 0||o.state!==Ze.GPU_MEMORY)&&(i=!0)}),i}};var mJ=Me.fromObject({arrowup:{action:"tab-backward"},arrowdown:{action:"tab-forward"},tab:{action:"tab-forward"},"shift+tab":{action:"tab-backward"},enter:{action:"commit"},escape:{action:"cancel"}}),v2=class{constructor(e){this.id=e;this.element=document.createElement("div");this.nameContainer=document.createElement("div");this.nameElement=document.createElement("input");this.lowerElement=document.createElement("div");this.upperElement=document.createElement("div");let{element:t,nameContainer:r,nameElement:i,lowerElement:a,upperElement:o}=this;t.classList.add("neuroglancer-channel-dimensions-widget-dim"),r.classList.add("neuroglancer-channel-dimensions-widget-name-container"),i.classList.add("neuroglancer-channel-dimensions-widget-name"),r.appendChild(i),a.classList.add("neuroglancer-channel-dimensions-widget-lower"),o.classList.add("neuroglancer-channel-dimensions-widget-upper"),t.appendChild(r),t.appendChild(a),t.appendChild(o),r.draggable=!0,i.disabled=!0,i.spellcheck=!1,i.autocomplete="off",i.required=!0,i.placeholder=" ",r.title="Drag to reorder, double click to rename.  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",r.addEventListener("dblclick",()=>{i.disabled=!1,i.focus(),i.select()}),i.addEventListener("focus",()=>{i.select()})}},Mw=class extends j{constructor(e){super();this.combiner=e;this.element=document.createElement("div");this.dimensionWidgets=[];this.curCoordinateSpace=void 0;this.dragSource=void 0;this.coordinateSpace=this.combiner.combined;let{element:t}=this;t.classList.add("neuroglancer-channel-dimensions-widget");let r=this.registerCancellable(We(()=>this.updateView()));this.registerDisposer(e.combined.changed.add(r));let i=this.registerDisposer(new $t(t,mJ));i.allShortcutsAreGlobal=!0,this.registerDisposer(ce(t,"cancel",a=>{this.forceUpdateView();let{target:o}=a;o instanceof HTMLElement&&o.blur()})),this.updateView()}reorderDimensionTo(e,t){if(e===t)return;let{coordinateSpace:r}=this;r.value=Eh(r.value,e,t)}makeNewDimensionWidget(e){let t=new v2(e);return t.nameContainer.addEventListener("dragstart",r=>{this.dragSource=t,r.stopPropagation(),r.dataTransfer.setData("neuroglancer-dimension","")}),t.nameContainer.addEventListener("dragenter",r=>{let{dragSource:i}=this;if(i===void 0||i===t)return;let{dimensionWidgets:a}=this,o=a.indexOf(i),l=a.indexOf(t);o===-1||l===-1||(r.preventDefault(),this.reorderDimensionTo(l,o))}),t.nameContainer.addEventListener("dragend",r=>{this.dragSource===t&&(this.dragSource=void 0)}),t.nameElement.addEventListener("blur",r=>{t.nameElement.disabled=!0;let{relatedTarget:i}=r;this.dimensionWidgets.some(a=>a.nameElement===i)||this.updateNames()||this.forceUpdateView()}),t.nameElement.addEventListener("input",()=>{let{nameElement:r}=t;xn(r),this.updateNameValidity()}),ce(t.nameElement,"commit",()=>{this.updateNames()}),ce(t.nameElement,"tab-forward",r=>this.selectAdjacentField(r,t,1)),ce(t.nameElement,"tab-backward",r=>this.selectAdjacentField(r,t,-1)),t}selectAdjacentField(e,t,r){e.stopPropagation();let{dimensionWidgets:i}=this,a=i.indexOf(t);if(a===-1)return;let o=a+r;if(o<0||o>=i.length)return;let l=i[o];l.nameElement.disabled=!1,l.nameElement.focus(),e.preventDefault()}updateNames(){let{dimensionWidgets:e,coordinateSpace:t}=this,r=t.value,i=e.map(c=>c.nameElement.value);if(this.combiner.getRenameValidity(i).includes(!1))return!1;let a=r.names;if(xe(a,i))return!1;let o=r.timestamps.map((c,d)=>a[d]===i[d]?c:Date.now()),l={...r,names:i,timestamps:o};return t.value=l,!0}updateNameValidity(){let{dimensionWidgets:e}=this,t=e.map(a=>a.nameElement.value),r=t.length,i=this.combiner.getRenameValidity(t);for(let a=0;a<r;++a)e[a].nameElement.dataset.isValid=i[a]===!1?"false":"true"}forceUpdateView(){this.curCoordinateSpace=void 0,this.updateView()}updateView(){let{coordinateSpace:{value:e}}=this;if(this.curCoordinateSpace===e)return;this.curCoordinateSpace=e;let{element:t}=this,r=this.dimensionWidgets,i=this.dimensionWidgets=e.ids.map(o=>r.find(l=>l.id===o)||this.makeNewDimensionWidget(o));function*a(){let{names:o,rank:l,bounds:{lowerBounds:c,upperBounds:d}}=e;for(let p=0;p<l;++p){let m=i[p];m.nameElement.value=o[p],delete m.nameElement.dataset.isValid,xn(m.nameElement),m.lowerElement.textContent=c[p].toString(),m.upperElement.textContent=d[p].toString(),yield m.element}}Wn(t,a.call(this))}};var Rw="opacity",_w="blend",S2="shader",b2="shaderControls",Vw="crossSectionRenderScale",x2="channelDimensions",Ow="volumeRendering",gJ="volumeRenderScale",yJ=su(Ti),Ds=class extends yJ{constructor(e){super(e);this.opacity=Nl(.5);this.blendMode=p2();this.fragmentMain=h2();this.shaderError=Sa();this.dataType=new Ee(void 0);this.sliceViewRenderScaleHistogram=new Da;this.sliceViewRenderScaleTarget=zi(1);this.volumeRenderingRenderScaleHistogram=new Da;this.volumeRenderingRenderScaleTarget=zi(1);this.channelCoordinateSpace=new Xs;this.channelCoordinateSpaceCombiner=new Ac(this.channelCoordinateSpace,GE);this.channelSpace=this.registerDisposer(mn(e=>Il(()=>jE(e)),this.channelCoordinateSpace));this.volumeRendering=new qe(!1,!1);this.shaderControlState=this.registerDisposer(new co(this.fragmentMain,this.registerDisposer(At((e,t)=>e===void 0?null:{imageData:{dataType:e,channelRank:t.rank}},[this.dataType,this.channelCoordinateSpace],(e,t)=>JSON.stringify(e)===JSON.stringify(t))),this.channelCoordinateSpaceCombiner));this.localCoordinateSpaceCombiner.includeDimensionPredicate=$o,this.blendMode.changed.add(this.specificationChanged.dispatch),this.opacity.changed.add(this.specificationChanged.dispatch),this.fragmentMain.changed.add(this.specificationChanged.dispatch),this.shaderControlState.changed.add(this.specificationChanged.dispatch),this.sliceViewRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.volumeRendering.changed.add(this.specificationChanged.dispatch),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new T2(this)}),this.tabs.default="rendering"}markLoading(){let e=super.markLoading(),t=this.channelCoordinateSpaceCombiner.retain();return()=>{e(),t()}}addCoordinateSpace(e){let t=super.addCoordinateSpace(e),r=this.channelCoordinateSpaceCombiner.bind(e);return()=>{t(),r()}}activateDataSubsources(e){let t;for(let r of e){if(this.addStaticAnnotations(r))continue;let{subsourceEntry:i}=r,{subsource:a}=i,{volume:o}=a;if(!(o instanceof zt)){r.deactivate("Not compatible with image layer");continue}if(t&&o.dataType!==t){r.deactivate(`Data type must be ${G[o.dataType].toLowerCase()}`);continue}t=o.dataType,r.activate(l=>{r.addRenderLayer(new Pw(o,{opacity:this.opacity,blendMode:this.blendMode,shaderControlState:this.shaderControlState,shaderError:this.shaderError,transform:r.getRenderLayerTransform(this.channelCoordinateSpace),renderScaleTarget:this.sliceViewRenderScaleTarget,renderScaleHistogram:this.sliceViewRenderScaleHistogram,localPosition:this.localPosition,channelCoordinateSpace:this.channelCoordinateSpace}));let c=l.registerDisposer(new Aw({multiscaleSource:o,shaderControlState:this.shaderControlState,shaderError:this.shaderError,transform:r.getRenderLayerTransform(this.channelCoordinateSpace),renderScaleTarget:this.volumeRenderingRenderScaleTarget,renderScaleHistogram:this.volumeRenderingRenderScaleHistogram,localPosition:this.localPosition,channelCoordinateSpace:this.channelCoordinateSpace}));l.registerDisposer(r.messages.addChild(c.messages)),l.registerDisposer(Dn((d,p)=>{!p||d.registerDisposer(this.addRenderLayer(c.addRef()))},this.volumeRendering)),this.shaderError.changed.dispatch()})}this.dataType.value=t}restoreState(e){super.restoreState(e),this.opacity.restoreState(e[Rw]),oe(e,_w,t=>this.blendMode.restoreState(t)),this.fragmentMain.restoreState(e[S2]),this.shaderControlState.restoreState(e[b2]),this.sliceViewRenderScaleTarget.restoreState(e[Vw]),this.channelCoordinateSpace.restoreState(e[x2]),this.volumeRendering.restoreState(e[Ow])}toJSON(){let e=super.toJSON();return e[Rw]=this.opacity.toJSON(),e[_w]=this.blendMode.toJSON(),e[S2]=this.fragmentMain.toJSON(),e[b2]=this.shaderControlState.toJSON(),e[Vw]=this.sliceViewRenderScaleTarget.toJSON(),e[x2]=this.channelCoordinateSpace.toJSON(),e[Ow]=this.volumeRendering.toJSON(),e}displayImageSelectionState(e,t){let{value:r}=e;if(r==null)return!1;let i=this.channelSpace.value;if(i.error!==void 0)return!1;let{numChannels:a,coordinates:o,channelCoordinateSpace:{names:l,rank:c}}=i,d=document.createElement("div");d.classList.add("neuroglancer-selection-details-value-grid");let p="[copy] 0fr ";c!==0&&(p+=`repeat(${c}, [dim] 0fr [coord] 0fr) `),p+="[value] 1fr",d.style.gridTemplateColumns=p;for(let m=0;m<a;++m){let g=c===0?r:r[m],v=g==null?"":g.toString(),b=Tr({title:"Copy value",onClick:()=>{wr(v)}});d.appendChild(b);for(let C=0;C<c;++C){let T=document.createElement("div");T.classList.add("neuroglancer-selection-details-value-grid-dim"),T.textContent=l[C],d.appendChild(T);let I=document.createElement("div");I.classList.add("neuroglancer-selection-details-value-grid-coord"),I.textContent=o[m*c+C].toString(),d.appendChild(I)}let x=document.createElement("div");x.classList.add("neuroglancer-selection-details-value-grid-value"),x.textContent=v,d.appendChild(x)}return t.appendChild(d),!0}displaySelectionState(e,t,r){let i=this.displayImageSelectionState(e,t);return super.displaySelectionState(e,t,r)&&(i=!0),i}getLegendShaderOptions(){return{memoizeKey:"ImageUserLayer",parameters:this.shaderControlState.builderState,encodeParameters:e=>e.key,defineShader:(e,t)=>{e.addFragmentCode(`
#define uOpacity 1.0
`),Dw(e,t)},initializeShader:e=>{let t=e.shader;ni(this.manager.root.display.gl,t,this.shaderControlState,e.parameters.parseResult.controls)}}}};Ds.type="image",Ds.typeAbbreviation="img";function C2(n){return new Co({shaderError:n.shaderError,fragmentMain:n.fragmentMain,shaderControlState:n.shaderControlState})}var w2=[{label:"Resolution (slice)",toolJson:Vw,...uu(n=>({histogram:n.sliceViewRenderScaleHistogram,target:n.sliceViewRenderScaleTarget}))},{label:"Blending",toolJson:_w,...Jg(n=>n.blendMode)},{label:"Volume rendering (experimental)",toolJson:Ow,...wo(n=>n.volumeRendering)},{label:"Resolution (3d)",toolJson:gJ,isValid:n=>n.volumeRendering,...uu(n=>({histogram:n.volumeRenderingRenderScaleHistogram,target:n.volumeRenderingRenderScaleTarget}))},{label:"Opacity",toolJson:Rw,...ea(n=>({value:n.opacity}))}];for(let n of w2)zg(Ds,n);var T2=class extends Vt{constructor(e){super();this.layer=e;this.codeWidget=this.registerDisposer(C2(this.layer));let{element:t}=this;t.classList.add("neuroglancer-image-dropdown");for(let a of w2)t.appendChild(cu(this,e,this.visibility,a));let r=document.createElement("div");r.style.flex="1";let i=document.createElement("div");i.className="neuroglancer-image-dropdown-top-row",i.appendChild(document.createTextNode("Shader")),i.appendChild(r),i.appendChild(xs({title:"Show larger editor view",onClick:()=>{new L2(this.layer)}})),i.appendChild(bs({title:"Documentation on image layer rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/sliceview/image_layer_rendering.md"})),t.appendChild(i),t.appendChild(this.registerDisposer(new Mw(e.channelCoordinateSpaceCombiner)).element),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new To(e.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility,legendShaderOptions:this.layer.getLegendShaderOptions()})).element)}},L2=class extends Zi{constructor(e){super();this.layer=e;this.codeWidget=this.registerDisposer(C2(this.layer));this.content.classList.add("neuroglancer-image-layer-shader-overlay"),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}};Qi(Ds);xg(gt.IMAGE,Ds);gs(n=>{let{volume:e}=n;if(e!==void 0&&e.volumeType===gt.UNKNOWN)return{layerConstructor:Ds,priority:-100}});Ts(Ds,n=>({shaderControlState:n.shaderControlState,legendShaderOptions:n.getLegendShaderOptions()}));var k2="shader",E2="shaderControls",du=class extends Ti{constructor(e){super(e);this.managedLayer=e;this.displayState=new px;this.vertexAttributes=new Ee(void 0);this.registerDisposer(this.displayState.shaderControlState.changed.add(this.specificationChanged.dispatch)),this.registerDisposer(this.displayState.fragmentMain.changed.add(this.specificationChanged.dispatch)),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new A2(this)}),this.tabs.default="rendering"}restoreState(e){super.restoreState(e),this.displayState.fragmentMain.restoreState(e[k2]),this.displayState.shaderControlState.restoreState(e[E2])}activateDataSubsources(e){let t=!1;for(let r of e){let{subsourceEntry:i}=r,{subsource:a}=i,{singleMesh:o}=a;if(o!==void 0){if(t){r.deactivate("Only one single-mesh source supported");continue}t=!0,r.activate(l=>{r.addRenderLayer(new mx(o,this.displayState,r.getRenderLayerTransform())),this.vertexAttributes.value=o.info.vertexAttributes,l.registerDisposer(()=>{this.vertexAttributes.value=void 0})});continue}r.deactivate("Not compatible with image layer")}}toJSON(){let e=super.toJSON();return e[k2]=this.displayState.fragmentMain.toJSON(),e[E2]=this.displayState.shaderControlState.toJSON(),e}};du.type="mesh",du.typeAbbreviation="mesh";function D2(n){return new Co({fragmentMain:n.displayState.fragmentMain,shaderError:n.displayState.shaderError,shaderControlState:n.displayState.shaderControlState})}var P2=class extends j{constructor(e){super();this.attributes=e;this.element=document.createElement("div");this.element.className="neuroglancer-single-mesh-attribute-widget",this.updateView(),this.registerDisposer(e.changed.add(()=>{this.updateView()}))}updateView(){let{element:e}=this,t=this.attributes.value;if(t===void 0){Ie(e);return}let r=hx(t.map(a=>a.name)),i=t.length;for(let a=0;a<i;++a){let o=t[a],l=document.createElement("div");l.className="neuroglancer-single-mesh-attribute";let c=document.createElement("div");c.className="neuroglancer-single-mesh-attribute-type",c.textContent=fx(o);let d=document.createElement("div");if(d.className="neuroglancer-single-mesh-attribute-name",d.textContent=r[a],l.appendChild(c),l.appendChild(d),o.min!==void 0&&o.max!==void 0){let p=document.createElement("neuroglancer-single-mesh-attribute-minmax");p.className="neuroglancer-single-mesh-attribute-range",p.textContent=`[${o.min.toPrecision(6)}, ${o.max.toPrecision(6)}]`,l.appendChild(p)}e.appendChild(l)}}disposed(){Ye(this.element)}};function I2(n){return new P2(n.vertexAttributes)}var A2=class extends Vt{constructor(e){super();this.layer=e;this.attributeWidget=this.registerDisposer(I2(this.layer));this.codeWidget=this.registerDisposer(D2(this.layer));let{element:t}=this;t.classList.add("neuroglancer-single-mesh-dropdown");let r=document.createElement("div");r.className="neuroglancer-single-mesh-dropdown-top-row";let i=document.createElement("div");i.style.flex="1",r.appendChild(i),r.appendChild(xs({title:"Show larger editor view",onClick:()=>{new M2(this.layer)}})),r.appendChild(bs({title:"Documentation on single mesh layer rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/sliceview/image_layer_rendering.md"})),t.appendChild(r),t.appendChild(this.attributeWidget.element),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new To(e.displayState.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility})).element)}},M2=class extends Zi{constructor(e){super();this.layer=e;this.attributeWidget=this.registerDisposer(I2(this.layer));this.codeWidget=this.registerDisposer(D2(this.layer));this.content.classList.add("neuroglancer-single-mesh-layer-shader-overlay"),this.content.appendChild(this.attributeWidget.element),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}};Qi(du);gs(n=>{if(n.singleMesh!==void 0)return{layerConstructor:du,priority:2}});Ts(du,n=>({shaderControlState:n.displayState.shaderControlState}));var R2=ot(Et());var Nw=class extends j{constructor(e){super();this.ref=e;this.element=document.createElement("label");this.selectElement=document.createElement("select");this.registerDisposer(e);let{element:t,selectElement:r}=this;t.appendChild(r),this.updateView(),this.registerEventListener(r,"change",()=>this.updateModel()),this.registerDisposer(this.ref.changed.add((0,R2.default)(()=>this.updateView(),0)))}updateModel(){this.ref.layerName=this.selectElement.value||void 0}updateView(){let{selectElement:e,ref:t}=this,{filter:r}=t;Ie(e);let i=document.createElement("option");e.appendChild(i);for(let a of this.ref.layerManager.managedLayers)if(r(a)){let o=document.createElement("option"),{name:l}=a;o.textContent=l,o.value=l,e.appendChild(o)}e.value=t.layerName||""}};var vJ="points",Bw="annotations",_2="annotationProperties",V2="annotationRelationships",O2="crossSectionAnnotationSpacing",N2="projectionAnnotationSpacing",B2="shader",U2="shaderControls";function SJ(n,e){e!==void 0&&ge(e,(t,r)=>{n.add({type:Oe.POINT,id:""+r,point:rh(t),properties:[]})})}function bJ(n){let e=n.layer;return e===null||e instanceof Qt}function xJ(n){if(n===void 0)return null;let e=n.layer;return e===null||!(e instanceof Qt)?null:e.displayState}var F2="linkedSegmentationLayer",G2="filterBySegmentation",W2="ignoreNullSegmentFilter",z2=class extends j{constructor(e,t,r){super();this.layerManager=e;this.annotationStates=t;this.annotationDisplayState=r;this.changed=new re;this.curGeneration=-1;this.wasLoading=void 0;this.map=new Map;this.registerDisposer(t.changed.add(()=>this.update())),this.registerDisposer(t.isLoadingChanged.add(()=>this.update())),this.update()}update(){let e=this.annotationStates.changed.count,t=this.annotationStates.isLoading;if(this.curGeneration===e&&t===this.wasLoading)return;this.wasLoading=t,this.curGeneration=e;let{map:r}=this,i=!1;for(let a of this.annotationStates.relationships){let o=r.get(a);o===void 0&&(o=this.addRelationship(a),i=!0),o.seenGeneration=e}if(!t)for(let[a,o]of r)o.seenGeneration!==e&&(r.delete(a),i=!0);i&&this.changed.dispatch()}addRelationship(e){let t=this.annotationDisplayState.relationshipStates.get(e),r=new iC(this.layerManager.addRef(),bJ);r.registerDisposer(r.changed.add(()=>{t.segmentationState.value=r.layerName===void 0?void 0:xJ(r.layer)}));let{showMatches:i}=t,a={layerRef:r,showMatches:i,seenGeneration:-1};return r.changed.add(this.changed.dispatch),i.changed.add(this.changed.dispatch),this.map.set(e,a),a}get(e){return this.update(),this.map.get(e)}unbind(e){e.layerRef.changed.remove(this.changed.dispatch),e.showMatches.changed.remove(this.changed.dispatch)}reset(){for(let e of this.map.values())e.showMatches.reset()}toJSON(){let{map:e}=this;if(e.size===0)return{};let t,r=[];for(let[i,a]of e){a.showMatches.value&&r.push(i);let{layerName:o}=a.layerRef;o!==void 0&&((t=t||{})[i]=o)}return r.sort(),{[F2]:t,[G2]:r.length===0?void 0:r}}restoreState(e){let{isLoading:t}=this.annotationStates;oe(e,F2,r=>{typeof r=="string"&&(r={segments:r}),Z(r);for(let i of Object.keys(r)){let a=Q(r[i]),o=this.map.get(i);if(o===void 0){if(!t)continue;o=this.addRelationship(i)}o.layerRef.layerName=a}for(let[i,a]of this.map)Object.prototype.hasOwnProperty.call(r,i)||(a.layerRef.layerName=void 0)}),oe(e,G2,r=>{typeof r=="boolean"&&(r=r===!0?["segments"]:[]);for(let i of qt(r)){let a=this.map.get(i);if(a===void 0){if(!t)continue;a=this.addRelationship(i)}a.showMatches.value=!0}})}disposed(){let{map:e}=this;for(let t of e.values())this.unbind(t);e.clear(),super.disposed()}},H2=class extends j{constructor(e,t){super();this.relationship=e;this.state=t;this.element=document.createElement("label");this.seenGeneration=-1;let{element:r}=this,i=this.registerDisposer(new Fn(t.showMatches)),a=new Nw(t.layerRef);r.appendChild(i.element),r.appendChild(document.createTextNode(e)),r.appendChild(a.element)}},$2=class extends j{constructor(e){super();this.linkedSegmentationLayers=e;this.widgets=new Map;this.element=document.createElement("div");this.element.style.display="contents";let t=this.registerCancellable(We(()=>this.updateView()));this.registerDisposer(this.linkedSegmentationLayers.annotationStates.changed.add(t)),this.updateView()}updateView(){let{linkedSegmentationLayers:e}=this,{annotationStates:t}=e,r=t.changed.count,{widgets:i}=this;function*a(){for(let o of t.relationships){let l=i.get(o);l===void 0&&(l=new H2(o,e.get(o))),l.seenGeneration=r,yield l.element}}for(let[o,l]of i)l.seenGeneration!==r&&(l.dispose(),i.delete(o));Wn(this.element,a.call(this))}disposed(){super.disposed();for(let e of this.widgets.values())e.dispose()}},CJ=su(Ti),Ps=class extends CJ{constructor(e){super(e);this.localAnnotationsJson=void 0;this.pointAnnotationsJson=void 0;this.linkedSegmentationLayers=this.registerDisposer(new z2(this.manager.rootLayers,this.annotationStates,this.annotationDisplayState));this.linkedSegmentationLayers.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.ignoreNullSegmentFilter.changed.add(this.specificationChanged.dispatch),this.annotationCrossSectionRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.annotationProjectionRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new q2(this)}),this.tabs.default="annotations"}disposed(){let{localAnnotations:e}=this;e!==void 0&&e.dispose(),super.disposed()}restoreState(e){super.restoreState(e),this.linkedSegmentationLayers.restoreState(e),this.localAnnotationsJson=e[Bw],this.localAnnotationProperties=oe(e,_2,lh),this.localAnnotationRelationships=oe(e,V2,qt,["segments"]),this.pointAnnotationsJson=e[vJ],this.annotationCrossSectionRenderScaleTarget.restoreState(e[O2]),this.annotationProjectionRenderScaleTarget.restoreState(e[N2]),this.annotationDisplayState.ignoreNullSegmentFilter.restoreState(e[W2]),this.annotationDisplayState.shader.restoreState(e[B2]),this.annotationDisplayState.shaderControls.restoreState(e[U2])}getLegacyDataSourceSpecifications(e,t,r,i){if(Object.prototype.hasOwnProperty.call(t,"source"))return super.getLegacyDataSourceSpecifications(e,t,r,i);let a=oe(t,"voxelSize",l=>Ne(new Float64Array(3),l,c=>it(c)/1e9)),o=["m","m","m"];if(a!==void 0){let l=Be({rank:3,units:o,scales:a,names:["x","y","z"]});r===void 0?r={outputSpace:l,sourceRank:3,transform:void 0,inputSpace:l}:r={...r,inputSpace:l}}return[{url:nb,transform:r,enableDefaultSubsources:!0,subsources:new Map}]}activateDataSubsources(e){var a;let t=!1,r;for(let o of e){let{subsourceEntry:l}=o,{local:c}=l.subsource,d=m=>r!==void 0&&Bn(m)!==Bn(r)?(o.deactivate("Annotation properties are not compatible"),!1):(r=m,!0);if(c===mi.annotations){if(t){o.deactivate("Only one local annotations source per layer is supported");continue}if(t=!0,!d((a=this.localAnnotationProperties)!=null?a:[]))continue;o.activate(m=>{var b;let g=this.localAnnotations=new bd(o.loadedDataSource.transform,(b=this.localAnnotationProperties)!=null?b:[],this.localAnnotationRelationships);try{g.restoreState(this.localAnnotationsJson)}catch{}m.registerDisposer(()=>{g.dispose(),this.localAnnotations=void 0}),m.registerDisposer(this.localAnnotations.changed.add(this.specificationChanged.dispatch));try{SJ(this.localAnnotations,this.pointAnnotationsJson)}catch{}this.pointAnnotationsJson=void 0,this.localAnnotationsJson=void 0;let v=new ys({localPosition:this.localPosition,transform:m.registerDisposer(Dh(this.manager.root.coordinateSpace,this.localPosition.coordinateSpace,o.loadedDataSource.transform,void 0)),source:g.addRef(),displayState:this.annotationDisplayState,dataSource:o.loadedDataSource.layerDataSource,subsourceIndex:o.subsourceIndex,subsourceId:l.id,role:In.ANNOTATION});this.addAnnotationLayerState(v,o)});continue}let{annotation:p}=l.subsource;if(p!==void 0){if(!d(p.properties))continue;o.activate(()=>{let m=new ys({localPosition:this.localPosition,transform:o.getRenderLayerTransform(),source:p,displayState:this.annotationDisplayState,dataSource:o.loadedDataSource.layerDataSource,subsourceIndex:o.subsourceIndex,subsourceId:l.id,role:In.ANNOTATION});this.addAnnotationLayerState(m,o)});continue}o.deactivate("Not compatible with annotation layer")}let i=this.annotationDisplayState.annotationProperties.value;Bn(i)!==Bn(r)&&(this.annotationDisplayState.annotationProperties.value=r)}initializeAnnotationLayerViewTab(e){let t=e.registerDisposer(mn(i=>i.some(a=>a.source instanceof Hi),this.annotationStates)),r=e.registerDisposer(new Cn(t,(i,a,o)=>{if(!!i){{let l=o.registerDisposer(new Up(this.annotationCrossSectionRenderScaleHistogram,this.annotationCrossSectionRenderScaleTarget));l.label.textContent="Spacing (cross section)",a.appendChild(l.element)}{let l=o.registerDisposer(new Up(this.annotationProjectionRenderScaleHistogram,this.annotationProjectionRenderScaleTarget));l.label.textContent="Spacing (projection)",a.appendChild(l.element)}}}));e.element.insertBefore(r.element,e.element.firstChild);{let i=e.registerDisposer(new Fn(this.annotationDisplayState.ignoreNullSegmentFilter)),a=document.createElement("label");a.appendChild(document.createTextNode("Ignore null related segment filter")),a.title="Display all annotations if filtering by related segments is enabled but no segments are selected",a.appendChild(i.element),e.element.appendChild(a)}e.element.appendChild(e.registerDisposer(new $2(this.linkedSegmentationLayers)).element)}toJSON(){let e=super.toJSON();e[O2]=this.annotationCrossSectionRenderScaleTarget.toJSON(),e[N2]=this.annotationProjectionRenderScaleTarget.toJSON(),this.localAnnotations!==void 0?e[Bw]=this.localAnnotations.toJSON():this.localAnnotationsJson!==void 0&&(e[Bw]=this.localAnnotationsJson),e[_2]=kE(this.localAnnotationProperties);let{localAnnotationRelationships:t}=this;return e[V2]=t.length===1&&t[0]==="segments"?void 0:t,e[W2]=this.annotationDisplayState.ignoreNullSegmentFilter.toJSON(),e[B2]=this.annotationDisplayState.shader.toJSON(),e[U2]=this.annotationDisplayState.shaderControls.toJSON(),Object.assign(e,this.linkedSegmentationLayers.toJSON()),e}};Ps.type="annotation",Ps.typeAbbreviation="ann";function j2(n){return new Co({shaderError:n.annotationDisplayState.shaderError,fragmentMain:n.annotationDisplayState.shader,shaderControlState:n.annotationDisplayState.shaderControls})}var J2=class extends Zi{constructor(e){super();this.layer=e;this.codeWidget=this.registerDisposer(j2(this.layer));this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}},q2=class extends Vt{constructor(e){super();this.layer=e;this.codeWidget=this.registerDisposer(j2(this.layer));let{element:t}=this;t.classList.add("neuroglancer-annotation-rendering-tab"),t.appendChild(this.registerDisposer(new Cn(e.annotationDisplayState.annotationProperties,(a,o)=>{if(a===void 0||a.length===0)return;let l=document.createElement("div");o.appendChild(l),l.classList.add("neuroglancer-annotation-shader-property-list");for(let c of a){let d=document.createElement("div");d.classList.add("neuroglancer-annotation-shader-property");let p=document.createElement("span");p.classList.add("neuroglancer-annotation-shader-property-type"),p.textContent=c.type;let m=document.createElement("span");m.classList.add("neuroglancer-annotation-shader-property-identifier"),m.textContent=`prop_${c.identifier}`,d.appendChild(p),d.appendChild(m);let{description:g}=c;g!==void 0&&(d.title=g),l.appendChild(d)}})).element);let r=document.createElement("div");r.className="neuroglancer-segmentation-dropdown-skeleton-shader-header";let i=document.createElement("div");i.style.flex="1",i.textContent="Annotation shader:",r.appendChild(i),r.appendChild(xs({title:"Show larger editor view",onClick:()=>{new J2(this.layer)}})),r.appendChild(bs({title:"Documentation on annotation rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/annotation/rendering.md"})),t.appendChild(r),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new To(e.annotationDisplayState.shaderControls,this.layer.manager.root.display,this.layer,{visibility:this.visibility})).element)}};Qi(Ps);Qi(Ps,"pointAnnotation");gs(n=>{if(n.local===mi.annotations)return{layerConstructor:Ps,priority:100};if(n.annotation!==void 0)return{layerConstructor:Ps,priority:1}});Ts(Ps,n=>({shaderControlState:n.annotationDisplayState.shaderControls}));function Y2(n){n.registerEventListener(document,"copy",e=>{if(Fd(e.target))return;let t=document.getSelection();if(t!==null&&t.type==="Range")return;let{mouseState:r}=n,{clipboardData:i}=e;r.updateUnconditionally()&&i!==null&&i.setData("text/plain",Array.prototype.slice.call(r.position)),e.preventDefault()})}function wJ(n,e){let t=String.raw`^[\[\]{}()\s,]*`;for(let a=0;a<e;++a)a!==0&&(t+=String.raw`[,\s]+`),t+=String.raw`(\d+(?:\.\d+)?)`;t+=String.raw`[\[\]{}()\s,]*$`;let r=n.match(t);if(r===null)return;let i=new Float32Array(e);for(let a=0;a<e;++a){let o=Number(r[a+1]);if(!Number.isFinite(o))return;i[a]=o}return i}function K2(n){n.registerEventListener(document,"paste",e=>{if(Fd(e.target))return;let{clipboardData:t}=e;if(t!==null){let r=t.getData("text/plain"),i=wJ(r,n.coordinateSpace.value.rank);i!==void 0&&(n.navigationState.position.value=i)}e.preventDefault()})}function X2(){return En(document,"contextmenu",n=>{n.preventDefault()})}function Q2(){return En(document,"wheel",n=>{n.ctrlKey&&n.preventDefault()},{passive:!1})}var Z2=Symbol("SingleTextureVolumeChunk.textureUnit"),ny=Symbol("SingleTextureVolumeChunk.textureLayout"),Gp=class extends j{constructor(e,t){super();this.shaderKey=e;this.dataType=t}defineShader(e,t){e.addTextureSampler(this.shaderSamplerType,"uVolumeChunkSampler",Z2)}beginDrawing(e,t){let r=t.textureUnit(Z2);e.activeTexture(WebGL2RenderingContext.TEXTURE0+r),t[ny]=null}endDrawing(e,t){e.bindTexture(qo[this.shaderSamplerType],null),t[ny]=null}bindChunk(e,t,r,i,a,o,l){let c=r.textureLayout;(t[ny]!==c||l)&&(t[ny]=c,this.setupTextureLayout(e,t,c,i,a,o)),e.bindTexture(qo[this.shaderSamplerType],r.texture)}beginSource(e,t){}},Wp=class extends Ub{constructor(e,t){super(e,t);this.texture=null;this.data=t.data}copyToGPU(e){if(super.copyToGPU(e),this.data===null)return;let t=this.texture=e.createTexture(),r=qo[this.chunkFormat.shaderSamplerType];e.bindTexture(r,t),this.setTextureData(e),e.bindTexture(r,null)}freeGPUMemory(e){super.freeGPUMemory(e),this.data!==null&&(e.deleteTexture(this.texture),this.texture=null,this.textureLayout.dispose(),this.textureLayout=null)}};var zp=class extends j{constructor(e,t,r){super();this.chunkDataSize=t;this.textureDims=r;this.textureShape=new Uint32Array(this.textureDims);let i=t.length,a=0;for(let m of t)m!==1&&++a;let o=this.strides=new Uint32Array(i*r),l=r===3?e.max3dTextureSize:e.maxTextureSize,c=0,d=1,{textureShape:p}=this;p.fill(1);for(let m=0;m<i;++m){let g=t[m];if(g===1)continue;let v=g*d,b;v>l||d!==1&&c+a<r?(++c,d=g,b=1):(b=d,d=v),o[r*m+c]=b,p[c]=d}}static get(e,t,r){return e.memoize.get(`sliceview.UncompressedTextureLayout:${t.join()}:${r}`,()=>new zp(e,t,r))}},Uw=new Uint32Array(3*5),ry=class extends Gp{constructor(e,t,r,i){super(r,t);this.textureDims=i;yi(this,t),this.shaderSamplerType=`${this.samplerPrefix}sampler${i}D`,this.textureAccessHelper=new sb("chunkData",i)}static get(e,t,r){let i=`sliceview.UncompressedChunkFormat:${t}:${r}`;return e.memoize.get(i,()=>new ry(e,t,i,r))}defineShader(e,t){super.defineShader(e,t);let{textureDims:r}=this,i=`ivec${this.textureDims}`,{textureAccessHelper:a}=this,o=(4+t)*r;Uw.length<o&&(Uw=new Uint32Array(o)),e.addUniform(`highp ${i}`,"uVolumeChunkStrides",4+t),e.addFragmentCode(a.getAccessor("readVolumeData","uVolumeChunkSampler",this.dataType));let c=`
${_t(this.dataType)} getDataValueAt(highp ivec3 p`;for(let d=0;d<t;++d)c+=`, highp int channelIndex${d}`;c+=`) {
  highp ${i} offset = uVolumeChunkStrides[0]
                     + p.x * uVolumeChunkStrides[1]
                     + p.y * uVolumeChunkStrides[2]
                     + p.z * uVolumeChunkStrides[3];
`;for(let d=0;d<t;++d)c+=`
  offset += channelIndex${d} * uVolumeChunkStrides[${4+d}];
`;c+=`
  return readVolumeData(offset);
}
`,e.addFragmentCode(c)}setupTextureLayout(e,t,r,i,a,o){let l=Uw,c=o.length,{strides:d}=r,p=i.length,{textureDims:m}=this;for(let v=0;v<m;++v){let b=0;for(let x=0;x<p;++x)b+=i[x]*d[x*m+v];l[v]=b}for(let v=0;v<3;++v){let b=a[v];if(!(b>=p))for(let x=0;x<m;++x)l[(v+1)*m+x]=d[b*m+x]}for(let v=0;v<c;++v){let b=o[v];if(b===-1)l.fill(0,(4+v)*m,(4+v+1)*m);else for(let x=0;x<m;++x)l[(4+v)*m+x]=d[b*m+x]}let g=(4+c)*m;m===3?e.uniform3iv(t.uniform("uVolumeChunkStrides"),l,0,g):e.uniform2iv(t.uniform("uVolumeChunkStrides"),l,0,g)}getTextureLayout(e,t){return zp.get(e,t,this.textureDims)}setTextureData(e,t,r){let{textureShape:i}=t;(this.textureDims===3?fI:pI)(e,this,r,i[0],i[1],i[2])}},eO=class extends Wp{setTextureData(e){let{source:t}=this,{chunkFormatHandler:r}=t,{chunkFormat:i}=r,a;this.chunkDataSize===t.spec.chunkDataSize?this.textureLayout=a=r.textureLayout.addRef():this.textureLayout=a=i.getTextureLayout(e,this.chunkDataSize),this.chunkFormat.setTextureData(e,a,this.data)}getValueAt(e){let{data:t}=this;if(t===null)return this.source.spec.fillValue;let{chunkFormat:r}=this,{chunkDataSize:i}=this,a=0,o=1,l=e.length;for(let d=0;d<l;++d)a+=o*e[d],o*=i[d];switch(r.dataType){case G.UINT8:case G.INT8:case G.FLOAT32:case G.UINT16:case G.INT16:case G.UINT32:case G.INT32:return t[a];case G.UINT64:{let d=a*2;return new X(t[d],t[d+1])}}}},tO=class extends j{};function TJ(n,e,t,r,i){let{dataType:a}=e,o=new Qf[a](uE[a]);a===G.UINT64?(o[0]=t.low,o[1]=t.high):o[0]=t;let l=new Uint32Array(r);l.fill(1);let c=new zp(n,l,i);c.strides.fill(0);let d=n.createTexture(),p=qo[e.shaderSamplerType];n.bindTexture(p,d),e.setTextureData(n,c,o),n.bindTexture(p,null);let m=new tO;return m.textureLayout=c,m.texture=d,m}var nO=class extends j{constructor(e,t){super();let r=0;for(let a of t.chunkDataSize)a>1&&++r;let i=r>=3?3:2;this.chunkFormat=this.registerDisposer(ry.get(e,t.dataType,i)),this.textureLayout=this.registerDisposer(this.chunkFormat.getTextureLayout(e,t.chunkDataSize)),this.fillValueChunk=this.registerDisposer(e.memoize.get(`sliceview.UncompressedChunkFormat.fillValue:${t.chunkDataSize.length}:${t.dataType}:${t.fillValue}:${i}`,()=>TJ(e,this.chunkFormat,t.fillValue,t.chunkDataSize.length,i)))}getChunk(e,t){let r=new eO(e,t);return r.data===null&&(r.texture=this.fillValueChunk.texture,r.textureLayout=this.fillValueChunk.textureLayout),r}};wm((n,e)=>e.compressedSegmentationBlockSize==null?new nO(n,e):null);function iy(n,e,t,r,i,a){let o=0,l=0,c=1,d=1;for(let x=0;x<3;++x){let C=i[x],T=r[x],I=Math.floor(C/T),P=C%T;o+=I*c,c*=Math.ceil(t[x]/T),l+=P*d,d*=T}let p=e+o*2,m=n[p],g=n[p+1],v=m&16777215,b=m>>24&255;if(b>0){let C=(e+g&16777215)+Math.floor(l*b/32),T=n[C],I=l*b%32,P=T>>I&(1<<b)-1;v+=a*P}return v}function rO(n,e,t,r,i){let a=iy(n,e,t,r,i,1)+e;return n[a]}function iO(n,e,t,r,i,a){let o=iy(e,t,r,i,a,2)+t;return n.low=e[o],n.high=e[o+1],n}var Hp=class extends j{constructor(e,t){super();let r=this.subchunkGridSize=K.create();for(let i=0;i<3;++i)r[i]=Math.ceil(e[i]/t[i]);this.singleton=!1}static get(e,t,r){return e.memoize.get(`sliceview.CompressedSegmentationTextureLayout:${Fo(t)},${Fo(r)}`,()=>new Hp(t,r))}},LJ=yi(new Ji,G.UINT32),Fw=new Uint32Array(4*4),ay=class extends Gp{constructor(e,t,r,i){super(i,e);this.subchunkSize=t;this.numChannels=r;this.textureAccessHelper=new ho("chunkData")}static get(e,t,r,i){let a=`sliceview.CompressedSegmentationChunkFormat:${t}:${i}`,o=`${a}:${Fo(r)}`;return e.memoize.get(o,()=>new ay(t,r,i,a))}get shaderSamplerType(){return"usampler2D"}defineShader(e,t){super.defineShader(e,t);let r=4*(4+t);Fw.length<r&&(Fw=new Uint32Array(r));let{textureAccessHelper:i}=this;i.defineShader(e);let a=d=>"compressedSegmentationChunkFormat_"+d;e.addUniform("highp ivec3","uSubchunkGridSize"),e.addUniform("highp ivec3","uSubchunkSize"),e.addUniform("highp ivec4","uVolumeChunkStrides",4+t),e.addFragmentCode(UD);let{dataType:o}=this,l=_t(o);o===G.UINT64?e.addFragmentCode(Pt):e.addFragmentCode(tl),e.addFragmentCode(i.getAccessor(a("readTextureValue"),"uVolumeChunkSampler",G.UINT32,1));let c=`
uint ${a("getChannelOffset")}(int channelIndex) {
  if (channelIndex == 0) {
    return ${this.numChannels}u;
  }
  return ${a("readTextureValue")}(uint(channelIndex)).value;
}
${l} getDataValueAt(highp ivec3 p`;for(let d=0;d<t;++d)c+=`, highp int channelIndex${d}`;c+=`) {
  highp ivec4 chunkPositionFull = uVolumeChunkStrides[0] +
                     + p.x * uVolumeChunkStrides[1]
                     + p.y * uVolumeChunkStrides[2]
                     + p.z * uVolumeChunkStrides[3];
`;for(let d=0;d<t;++d)c+=`
  chunkPositionFull += channelIndex${d} * uVolumeChunkStrides[${4+d}];
`;c+=`
  highp ivec3 chunkPosition = chunkPositionFull.xyz;

  // TODO: maybe premultiply this and store as uniform.
  ivec3 subchunkGridPosition = chunkPosition / uSubchunkSize;
  int subchunkGridOffset = getFortranOrderIndex(subchunkGridPosition, uSubchunkGridSize);

  int channelOffset = int(${a("getChannelOffset")}(chunkPositionFull[3]));

  // TODO: Maybe just combine this offset into subchunkGridStrides.
  int subchunkHeaderOffset = subchunkGridOffset * 2 + channelOffset;

  highp uint subchunkHeader0 = ${a("readTextureValue")}(uint(subchunkHeaderOffset)).value;
  highp uint subchunkHeader1 = ${a("readTextureValue")}(uint(subchunkHeaderOffset + 1)).value;
  highp uint outputValueOffset = (subchunkHeader0 & 0xFFFFFFu) + uint(channelOffset);
  highp uint encodingBits = subchunkHeader0 >> 24u;
  if (encodingBits > 0u) {
    ivec3 subchunkPosition = chunkPosition - subchunkGridPosition * uSubchunkSize;
    int subchunkOffset = getFortranOrderIndex(subchunkPosition, uSubchunkSize);
    uint encodedValueBaseOffset = subchunkHeader1 + uint(channelOffset);
    uint encodedValueOffset = encodedValueBaseOffset + uint(subchunkOffset) * encodingBits / 32u;
    uint encodedValue = ${a("readTextureValue")}(encodedValueOffset).value;
    uint wordOffset = uint(subchunkOffset) * encodingBits % 32u;
    uint encodedValueShifted = encodedValue >> wordOffset;
    uint decodedValue = encodedValueShifted - (encodedValueShifted >> encodingBits << encodingBits);
    outputValueOffset += decodedValue * ${this.dataType===G.UINT64?"2u":"1u"};
  }
  ${l} result;
`,o===G.UINT64?c+=`
  result.value[0] = ${a("readTextureValue")}(outputValueOffset).value;
  result.value[1] = ${a("readTextureValue")}(outputValueOffset+1u).value;
`:c+=`
  result.value = ${a("readTextureValue")}(outputValueOffset).value;
`,c+=`
  return result;
}
`,e.addFragmentCode(c)}setupTextureLayout(e,t,r,i,a,o){let{subchunkGridSize:l}=r;e.uniform3i(t.uniform("uSubchunkGridSize"),l[0],l[1],l[2]);let c=Fw,d=o.length;if(c.fill(0),!r.singleton){for(let p=0;p<3;++p){c[p]=i[p];let m=a[p];m!==-1&&(c[4*(p+1)+m]=1)}for(let p=0;p<d;++p){let m=o[p];m!==-1&&(c[4*(4+p)+m]=1)}}e.uniform4iv(t.uniform("uVolumeChunkStrides"),c,0,(d+4)*4)}setTextureData(e,t,r){is(e,LJ,r)}getTextureLayout(e,t){return Hp.get(e,t,this.subchunkSize)}beginSource(e,t){super.beginSource(e,t);let{subchunkSize:r}=this;e.uniform3i(t.uniform("uSubchunkSize"),r[0],r[1],r[2])}},aO=class extends Wp{setTextureData(e){let{data:t}=this,{chunkFormat:r}=this,i=this.textureLayout=r.getTextureLayout(e,this.chunkDataSize);r.setTextureData(e,i,t)}getValueAt(e){let{chunkDataSize:t,chunkFormat:r}=this,{data:i}=this;if(i===null)return this.source.spec.fillValue;let a=i[e[3]||0];if(r.dataType===G.UINT64){let o=new X;return iO(o,i,a,t,r.subchunkSize,e),o}else return rO(i,a,t,r.subchunkSize,e)}},oO=class extends j{};function kJ(n,e,t){let{dataType:r,numChannels:i}=e,a=new Uint32Array(i+2+(r===G.UINT64?2:1));a[0]=i,a[i]=2,r===G.UINT64?(a[i+2]=t.low,a[i+3]=t.high):a[i+2]=t;let o=new Hp(Uint32Array.of(1,1,1),K.fromValues(1,1,1));o.singleton=!0;let l=n.createTexture(),c=qo[e.shaderSamplerType];n.bindTexture(c,l),e.setTextureData(n,o,a),n.bindTexture(c,null);let d=new oO;return d.textureLayout=o,d.texture=l,d}var sO=class extends j{constructor(e,t){super();let{dataType:r}=t;if(r!==G.UINT64&&r!==G.UINT32)throw new Error(`Unsupported compressed segmentation data type: ${G[r]}`);this.chunkFormat=this.registerDisposer(ay.get(e,t.dataType,t.compressedSegmentationBlockSize,t.chunkDataSize[3]||1)),this.fillValueChunk=this.registerDisposer(e.memoize.get(`sliceview.CompressedSegmentationChunkFormat.fillValue:${t.dataType}:${t.fillValue}:${this.chunkFormat.numChannels}`,()=>kJ(e,this.chunkFormat,t.fillValue)))}getChunk(e,t){let r=new aO(e,t);return r.data===null&&(r.texture=this.fillValueChunk.texture,r.textureLayout=this.fillValueChunk.textureLayout),r}};wm((n,e)=>e.compressedSegmentationBlockSize!=null?new sO(n,e):null);var oy='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-labelledby="controlsAltIconTitle"><circle cx="9" cy="6" r="2"></circle><path d="M4 6H7"></path><path d="M11 6H20"></path><circle cx="9" cy="18" r="2"></circle><path d="M4 18H7"></path><path d="M11 18H20"></path><circle cx="15" cy="12" r="2"></circle><path d="M4 12H13"></path><path d="M17 12L20 12"></path></svg>';var lO='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-labelledby="layersIconTitle"><path d="M12 4L20 8.00004L12 12L4 8.00004L12 4Z"></path><path d="M20 12L12 16L4 12"></path><path d="M20 16L12 20L4 16"></path></svg>';var cO='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="listIconTitle"><path d="M10 7L18 7M10 12L18 12M10 17L18 17"></path><line x1="7" y1="7" x2="7" y2="7"></line><line x1="7" y1="12" x2="7" y2="12"></line><line x1="7" y1="17" x2="7" y2="17"></line></svg>';var uO='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="settingsIconTitle"><path d="M5.03506429,12.7050339 C5.01187484,12.4731696 5,12.2379716 5,12 C5,11.7620284 5.01187484,11.5268304 5.03506429,11.2949661 L3.20577137,9.23205081 L5.20577137,5.76794919 L7.9069713,6.32070904 C8.28729123,6.0461342 8.69629298,5.80882212 9.12862533,5.61412402 L10,3 L14,3 L14.8713747,5.61412402 C15.303707,5.80882212 15.7127088,6.0461342 16.0930287,6.32070904 L18.7942286,5.76794919 L20.7942286,9.23205081 L18.9649357,11.2949661 C18.9881252,11.5268304 19,11.7620284 19,12 C19,12.2379716 18.9881252,12.4731696 18.9649357,12.7050339 L20.7942286,14.7679492 L18.7942286,18.2320508 L16.0930287,17.679291 C15.7127088,17.9538658 15.303707,18.1911779 14.8713747,18.385876 L14,21 L10,21 L9.12862533,18.385876 C8.69629298,18.1911779 8.28729123,17.9538658 7.9069713,17.679291 L5.20577137,18.2320508 L3.20577137,14.7679492 L5.03506429,12.7050339 Z"></path><circle cx="12" cy="12" r="1"></circle></svg>';var yN=ot(Et());var TO=ot(Et());function ii(n,e){return t=>{t.style.flex=n,e(t)}}function Is(n,e){return t=>{t.style.display="flex",t.style.flexDirection=n;for(let r of e){let i=t.ownerDocument.createElement("div");t.appendChild(i),r(i)}}}var EJ=ae.create();function sy(n,e){let t=ae.identity(EJ),{globalPosition:r,displayDimensionRenderInfo:{canonicalVoxelFactors:i,displayDimensionIndices:a}}=n;for(let o=0;o<3;++o){let l=a[o];t[12+o]=l===-1?0:r[l],t[5*o]=e/i[o]}return ae.multiply(t,n.viewProjectionMat,t),t}var Wl=class extends j{constructor(e){super();this.gl=e;this.vertexBuffer=this.registerDisposer(Bt.fromData(e,new Float32Array([0,0,0,1,1,0,0,1,0,0,0,1,0,1,0,1,0,0,0,1,0,0,1,1]),e.ARRAY_BUFFER,e.STATIC_DRAW));let t=.5;this.colorBuffer=this.registerDisposer(Bt.fromData(e,new Float32Array([1,0,0,t,1,0,0,t,0,1,0,t,0,1,0,t,0,0,1,t,0,0,1,t]),e.ARRAY_BUFFER,e.STATIC_DRAW)),this.trivialColorShader=this.registerDisposer(iP(e))}static get(e){return e.memoize.get("SliceViewPanel:AxesLineHelper",()=>new Wl(e))}draw(e,t=!0){let r=this.trivialColorShader,i=this.gl;r.bind(),i.uniformMatrix4fv(r.uniform("uProjectionMatrix"),!1,e);let a=r.attribute("aVertexPosition");this.vertexBuffer.bindToVertexAttrib(a,4);let o=r.attribute("aColor");this.colorBuffer.bindToVertexAttrib(o,4),t&&(i.colorMask(!1,!1,!1,!0),i.clearColor(0,0,0,0),i.clear(i.COLOR_BUFFER_BIT),i.colorMask(!0,!0,!0,!0),i.enable(i.BLEND),i.blendFunc(i.ONE_MINUS_DST_ALPHA,i.DST_ALPHA)),i.lineWidth(1),i.drawArrays(i.LINES,0,6),t&&i.disable(i.BLEND),i.disableVertexAttribArray(a),i.disableVertexAttribArray(o)}};var dO="perspective_view/PerspectiveView";var pO=!1,$p=class{constructor(){this.renderLayers=[null];this.pickData=[null];this.values=[0,0,0];this.nextPickID=1}clear(){this.renderLayers.length=1,this.pickData.length=1,this.values.length=3,this.nextPickID=1}registerUint64(e,t,r=1,i=null){return this.register(e,r,t.low,t.high,i)}register(e,t=1,r=0,i=0,a=null){let{renderLayers:o,values:l}=this,c=this.nextPickID;this.nextPickID+=t;let d=o.length;o[d]=e;let p=d*3;return l[p]=c,l[p+1]=r,l[p+2]=i,this.pickData[d]=a,c}setMouseState(e,t){let{renderLayers:r,values:i}=this,a=0,o=r.length-1;for(;a<o;){let g=Math.ceil(a+(o-a)/2);i[g*3]>t?o=g-1:a=g}let l=e.pickedRenderLayer=r[a],c=a*3,d=e.pickedOffset=t-i[c];pO&&console.log(`Looking up pick ID ${t}: renderLayer`,l,`offset=${d}`);let{pickedValue:p}=e;p.low=i[c+1],p.high=i[c+2],e.pickedAnnotationId=void 0,e.pickedAnnotationLayer=void 0,e.pickedAnnotationBuffer=void 0,e.pickedAnnotationBufferBaseOffset=void 0,e.pickedAnnotationIndex=void 0,e.pickedAnnotationCount=void 0,e.pickedAnnotationType=void 0;let m=this.pickData[a];l!==null&&(pO&&console.log(`Picked value=${p}, offset=${d}, data=${this.pickData[a]}`),l.updateMouseState(e,p,d,m))}};var fO=ot(bp());var hO=10,DJ=1e3,PJ=400,IJ=500,AJ=Math.PI/20,MJ=20,RJ=10;function mO(n,e){return Math.sqrt(n*n+e*e)}function gO(n){let[e,t]=n;e.identifier>t.identifier&&([t,e]=[e,t]);let r=e.clientX-t.clientX,i=e.clientY-t.clientY,a=mO(r,i),o=Math.atan2(r,i);return{distance:a,angle:o}}function _J(n,e){let t=Math.PI*2,r=Math.abs(n-e)%t;return Math.min(r,t-r)}var Gw=class extends j{constructor(e,t){super();this.target=e;this.eventMap=t;this.prevTouches=new Map;this.moved=!1;this.prevAngle=0;this.rotated=!1;this.prevDistance=0;this.pinched=!1;this.prevCenterX=0;this.prevCenterY=0;this.translated=!1;this.startHold=this.registerCancellable((0,fO.default)((e,t,r,i)=>{let a={event:e,centerX:r,centerY:i};this.dispatch(`touchhold${e.targetTouches.length}`,e,a,t)},DJ,{leading:!1,trailing:!0}));this.numPriorTaps=0;this.priorTapNumTouches=0;this.tapStartTime=0;this.tapEndTime=0;this.curTapNumTouches=0;this.registerEventListener(e,"touchstart",r=>{this.handleTouchEvent(r)}),this.registerEventListener(e,"touchmove",r=>{this.handleTouchEvent(r)}),this.registerEventListener(e,"touchend",r=>{this.handleTouchEvent(r)})}dispatch(e,t,r,i=t.eventPhase){mb(e,t,i,r,this.eventMap)}handleTouchEvent(e){if(e.target===this.target)e.preventDefault();else return;let t=new Map,{prevTouches:r,prevEvent:i}=this,a=0,o=0;for(let g of e.targetTouches)t.set(g.identifier,g),a+=g.clientX,o+=g.clientY;a/=t.size,o/=t.size;for(let[g,v]of r.entries()){let b=t.get(g);if(b===void 0)r.delete(g);else{let x=b.clientX-v.clientX,C=b.clientY-v.clientY;(Math.abs(x)>=hO||Math.abs(C)>=hO)&&(this.moved=!0)}}if(i===void 0||i.targetTouches.length!==t.size||t.size==0){if(this.moved=!1,e.type==="touchstart")this.startHold(e,e.eventPhase,a,o),(i===void 0||i.targetTouches.length===0)&&(this.tapStartTime=Date.now(),this.curTapNumTouches=0),this.curTapNumTouches=Math.max(this.curTapNumTouches,e.targetTouches.length);else{if(e.type=="touchend"){let g=Date.now();if(e.targetTouches.length===0&&g-this.tapStartTime<PJ){(this.curTapNumTouches!==this.priorTapNumTouches||g-this.tapEndTime>=IJ)&&(this.numPriorTaps=0),++this.numPriorTaps,this.tapEndTime=g,this.priorTapNumTouches=this.curTapNumTouches;let v={event:e,centerX:a,centerY:o};this.dispatch(`touchtap${this.curTapNumTouches}x${this.numPriorTaps}`,e,v)}}this.startHold.cancel()}if(this.prevTouches=t,this.prevEvent=e,this.prevCenterX=a,this.prevCenterY=o,this.translated=!1,t.size===2){let{distance:g,angle:v}=gO(t.values());this.prevDistance=g,this.prevAngle=v,this.rotated=!1,this.pinched=!1}return}if(!this.moved)return;this.tapStartTime=0,this.startHold.cancel(),this.prevTouches=t,this.prevEvent=e;let{prevCenterX:l,prevCenterY:c,translated:d}=this,p=a-l,m=o-c;if(d===!1&&mO(p,m)>=RJ&&(d=this.translated=!0),d===!0&&(p!==0||m!==0)){this.prevCenterX=a,this.prevCenterY=o;let g={event:e,deltaX:p,deltaY:m,centerX:a,centerY:o};this.dispatch(`touchtranslate${t.size}`,e,g)}if(t.size===2){let{distance:g,angle:v}=gO(t.values()),{pinched:b,rotated:x,prevDistance:C,prevAngle:T}=this;b===!1&&Math.abs(g-C)>=MJ&&(this.pinched=b=!0);let I=_J(v,T);if(x===!1&&I>=AJ&&(this.rotated=x=!0),b===!0&&g!=C){this.prevDistance=g;let P={event:e,distance:g,prevDistance:C,centerX:a,centerY:o};this.dispatch("touchpinch",e,P)}x===!0&&v!==T&&(this.prevAngle=v,this.dispatch("touchrotate",e,{event:e,centerX:a,centerY:o,angle:v,prevAngle:T}))}}};var Ww=K.create(),zw=class{constructor(){this.pickIDs=new $p;this.viewportWidth=0;this.viewportHeight=0;this.invTransform=ae.create();this.frameNumber=-1}},Hw=class{constructor(){this.buffer=null;this.glWindowX=0;this.glWindowY=0}},VJ=30,cn=5,ut=1+cn*2,pu=(()=>{let n=cn**2,e=(i,a)=>(i-cn)**2+(a-cn)**2,t=new Uint32Array(ut*ut),r=0;for(let i=0;i<ut;++i)for(let a=0;a<ut;++a)e(i,a)>n||(t[r++]=a*ut+i);return t=t.subarray(0,r),t.sort((i,a)=>{let o=i%ut,l=(i-o)/ut,c=a%ut,d=(a-c)/ut;return e(o,l)-e(c,d)}),t})();function ly(n,e,t,r,i,a,o){let l=r-cn,c=i-cn;if(!(l>=0&&c>=0&&l+ut<=a&&c+ut<=o))for(let d=0;d<ut;++d)for(let p=0;p<ut;++p){let m=l+p,g=c+d;(m<0||g<0||m>=a||g>=o)&&(n[e+(g*ut+m)*t]=0)}}var jp=class extends hh{constructor(e,t,r){super(e,t,r.visibility);this.viewer=r;this.mouseX=-1;this.mouseY=-1;this.pickRequestPending=!1;this.mouseStateForcer=()=>this.blockOnPickRequest();this.pickingData=[new zw,new zw];this.pickRequests=[new Hw,new Hw];this.pickBufferContents=new Float32Array(2*4*ut*ut);this.pickTimerId=-1;this.nextPickRequestTime=0;this.pendingPickRequestTimerId=-1;this.pendingPickRequestTimerExpired=()=>{this.pendingPickRequestTimerId=-1,!!this.pickRequestPending&&this.attemptToIssuePickRequest()};this.inputEventMap=r.inputEventMap,t.classList.add("neuroglancer-rendered-data-panel"),t.classList.add("neuroglancer-panel"),t.classList.add("neuroglancer-noselect"),typeof NEUROGLANCER_SHOW_OBJECT_SELECTION_TOOLTIP!="undefined"&&NEUROGLANCER_SHOW_OBJECT_SELECTION_TOOLTIP===!0&&(t.title="Double click to toggle display of object under mouse pointer.  Control+rightclick to pin/unpin selection."),this.registerDisposer(new xo(t)),this.registerDisposer(new $t(t,this.inputEventMap)),this.registerDisposer(new wn(t,this.inputEventMap,i=>{this.onMousemove(i)})),this.registerDisposer(new Gw(t,this.inputEventMap)),this.registerEventListener(t,"mousemove",this.onMousemove.bind(this)),this.registerEventListener(t,"touchstart",this.onTouchstart.bind(this)),this.registerEventListener(t,"mouseleave",()=>this.onMouseout()),this.registerEventListener(t,"mouseover",i=>{i.target!==t&&this.onMouseout()},!0),ce(t,"select-position",()=>{this.viewer.selectionDetailsState.select()}),ce(t,"snap",()=>{this.navigationState.pose.snap()}),ce(t,"zoom-in",()=>{this.navigationState.zoomBy(.5)}),ce(t,"zoom-out",()=>{this.navigationState.zoomBy(2)}),ce(t,"depth-range-decrease",()=>{this.navigationState.depthRange.value*=.5}),ce(t,"depth-range-increase",()=>{this.navigationState.depthRange.value*=2});for(let i=0;i<3;++i){let a=tE[i];for(let o of[-1,1]){let l=o<0?"-":"+";ce(t,`rotate-relative-${a}${l}`,()=>{this.navigationState.pose.rotateRelative(qr[i],o*.1)});let c=K.create();ce(t,`${a}${l}`,()=>{let{navigationState:d}=this,p=c;p[0]=0,p[1]=0,p[2]=0,p[i]=o,d.pose.translateVoxelsRelative(p,!0)})}}ce(t,"zoom-via-wheel",i=>{let a=i.detail;this.onMousemove(a,!1),this.zoomByMouse(lu(a))}),ce(t,"adjust-depth-range-via-wheel",i=>{let a=i.detail;this.navigationState.depthRange.value*=lu(a)}),ce(t,"translate-via-mouse-drag",i=>{sn(i.detail,(a,o,l)=>{this.translateByViewportPixels(o,l)})}),ce(t,"translate-in-plane-via-touchtranslate",i=>{let{detail:a}=i;this.translateByViewportPixels(a.deltaX,a.deltaY)}),ce(t,"translate-z-via-touchtranslate",i=>{let{detail:a}=i,{navigationState:o}=this,l=Ww;l[0]=0,l[1]=0,l[2]=a.deltaY+a.deltaX,o.pose.translateVoxelsRelative(l,!0)});for(let i of[1,10])ce(t,`z+${i}-via-wheel`,a=>{let o=a.detail,{navigationState:l}=this,c=Ww,d=o.deltaY!==0?o.deltaY:o.deltaX;c[0]=0,c[1]=0,c[2]=(d>0?-1:1)*i,l.pose.translateVoxelsRelative(c,!0)});ce(t,"move-to-mouse-position",()=>{let{mouseState:i}=this.viewer;i.updateUnconditionally()&&(this.navigationState.position.value=i.position)}),ce(t,"snap",()=>this.navigationState.pose.snap()),ce(t,"move-annotation",i=>{let{mouseState:a}=this.viewer,o=a.pickedAnnotationId,l=a.pickedAnnotationLayer;if(l!==void 0&&o!==void 0){i.stopPropagation();let c=l.source.getReference(o),d=c.value,p=es(d.type),m=a.pickedOffset,{chunkTransform:{value:g}}=l;if(g.error!==void 0)return;let{layerRank:v}=g,b=new Float32Array(v);p.getRepresentativePoint(b,d,a.pickedOffset);let x=gr.set(gr.create(),0,0);a.updateUnconditionally()&&sn(i.detail,(C,T,I)=>{gr.add(x,x,[T,I]);let P=new Float32Array(v);Zr(P,g.chunkToLayerTransform,v+1,b,v);let M=Ww,{displayDimensionIndices:D}=this.navigationState.pose.displayDimensions.value;JE(M,P,g.modelTransform,D),this.translateDataPointByViewportPixels(M,M,x[0],x[1]),qE(P,M,g.modelTransform,D);let E=new Float32Array(v);Zr(E,g.layerToChunkTransform,v+1,P,v);let V=p.updateViaRepresentativePoint(d,E,m);l.source.update(c,V)},C=>{l.source.commit(c),c.dispose()})}}),ce(t,"delete-annotation",()=>{let{mouseState:i}=this.viewer,a=i.pickedAnnotationId,o=i.pickedAnnotationLayer;if(o!==void 0&&!o.source.readonly&&a!==void 0){let l=o.source.getReference(a);try{o.source.delete(l)}finally{l.dispose()}}}),ce(t,"zoom-via-touchpinch",i=>{let{detail:a}=i;this.handleMouseMove(a.centerX,a.centerY);let o=a.prevDistance/a.distance;o>.1&&o<10&&this.zoomByMouse(o)})}cancelPickRequests(){let{gl:e}=this;for(let t of this.pickRequests){let{sync:r}=t;r!==null&&e.deleteSync(r),t.sync=null}clearTimeout(this.pickTimerId),this.pickTimerId=-1}issuePickRequestInternal(e){let{gl:t}=this,{buffer:r}=e;r===null?(r=e.buffer=t.createBuffer(),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,r),t.bufferData(WebGL2RenderingContext.PIXEL_PACK_BUFFER,2*4*4*ut*ut,WebGL2RenderingContext.STREAM_READ)):t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,r);let{renderViewport:i}=this,a=this.mouseX-i.visibleLeftFraction*i.logicalWidth,o=i.height-(this.mouseY-i.visibleTopFraction*i.logicalHeight);this.issuePickRequest(a,o),e.sync=t.fenceSync(WebGL2RenderingContext.SYNC_GPU_COMMANDS_COMPLETE,0),e.frameNumber=this.context.frameNumber,e.glWindowX=a,e.glWindowY=o,t.flush(),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,null),this.pickTimerId===-1&&this.scheduleCheckForPickRequestCompletion(),this.pickRequestPending=!1;let{pickRequests:l}=this;e!==l[0]&&(l[1]=l[0],l[0]=e),this.nextPickRequestTime=Date.now()+VJ}completePickInternal(e){let{gl:t}=this,{pickBufferContents:r}=this;t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,e.buffer),t.getBufferSubData(WebGL2RenderingContext.PIXEL_PACK_BUFFER,0,r),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,null);let{pickingData:i}=this,{frameNumber:a}=e;this.completePickRequest(e.glWindowX,e.glWindowY,r,i[0].frameNumber===a?i[0]:i[1])}scheduleCheckForPickRequestCompletion(){this.pickTimerId=window.setTimeout(()=>{this.pickTimerId=-1,this.checkForPickRequestCompletion()},0)}checkForPickRequestCompletion(e=!1,t=!1){let r=this.context.frameNumber,i=-1;e&&(--r,i=r-1);let{pickRequests:a}=this,{gl:o}=this,l=!1,c=!1,d;for(let m of a){let{sync:g}=m;if(g===null)continue;let{frameNumber:v}=m;if(!c&&v>=r-1){if(t||o.getSyncParameter(g,WebGL2RenderingContext.SYNC_STATUS)===WebGL2RenderingContext.SIGNALED)this.completePickInternal(m),c=!0;else if(v!==i){l=!0;continue}}o.deleteSync(g),m.sync=null,d=m}let{pickTimerId:p}=this;l&&p===-1?this.scheduleCheckForPickRequestCompletion():!l&&p!==-1&&(window.clearTimeout(p),this.pickTimerId=-1),!e&&d!==void 0&&this.pickRequestPending&&this.canIssuePickRequest()&&this.issuePickRequestInternal(d)}blockOnPickRequest(){this.pickRequestPending&&(this.cancelPickRequests(),this.nextPickRequestTime=0,this.attemptToIssuePickRequest()),this.checkForPickRequestCompletion(!1,!0)}draw(){let{width:e,height:t}=this.renderViewport;this.checkForPickRequestCompletion(!0);let{pickingData:r}=this;r[0]=r[1];let i=this.context.frameNumber,a=r[1];if(a.frameNumber=i,a.viewportWidth=e,a.viewportHeight=t,a.pickIDs.clear(),!this.drawWithPicking(a)){a.frameNumber=-1;return}this.nextPickRequestTime=0,this.mouseX>=0&&this.attemptToIssuePickRequest()}canIssuePickRequest(){let e=Date.now(),{nextPickRequestTime:t,pendingPickRequestTimerId:r}=this;return e<t?(r==-1&&(this.pendingPickRequestTimerId=window.setTimeout(this.pendingPickRequestTimerExpired,t-e)),!1):!0}attemptToIssuePickRequest(){if(!this.canIssuePickRequest())return;let e=this.context.frameNumber,{gl:t}=this,{pickRequests:r}=this;for(let i of r){let{sync:a}=i;if(a!==null)if(i.frameNumber<e-1)t.deleteSync(a);else continue;this.issuePickRequestInternal(i);return}}updateMousePosition(e,t){if(e===this.mouseX&&t===this.mouseY)return;if(this.mouseX=e,this.mouseY=t,e<0){this.pickRequestPending=!1,this.cancelPickRequests();return}let r=this.context.frameNumber,i=this.pickingData[1];i.frameNumber!==r||this.renderViewport.width!==i.viewportWidth||this.renderViewport.height!==i.viewportHeight||(this.pickRequestPending=!0,this.attemptToIssuePickRequest())}onMouseout(){this.updateMousePosition(-1,-1),this.viewer.mouseState.setForcer(void 0)}handleMouseMove(e,t){let{element:r}=this,i=r.getBoundingClientRect(),a=e-(i.left+r.clientLeft),o=t-(i.top+r.clientTop),{mouseState:l}=this.viewer;l.pageX=e+window.scrollX,l.pageY=t+window.scrollY,l.setForcer(this.mouseStateForcer),this.updateMousePosition(a,o)}onMousemove(e,t=!0){let{element:r}=this;t&&e.target!==r||this.handleMouseMove(e.clientX,e.clientY)}onTouchstart(e){let{element:t}=this;if(e.target!==t||e.targetTouches.length!==1)return;let{clientX:r,clientY:i}=e.targetTouches[0];this.handleMouseMove(r,i)}disposed(){let{mouseState:e}=this.viewer;e.removeForcer(this.mouseStateForcer);let{gl:t}=this;this.cancelPickRequests();let{pendingPickRequestTimerId:r}=this;r!==-1&&window.clearTimeout(r);for(let i of this.pickRequests)t.deleteBuffer(i.buffer);super.disposed()}};var OJ=[1.5,2,3,5,7.5,10];var yO=class{constructor(){this.allowedSignificands=OJ;this.targetLengthInPixels=0;this.physicalSizePerPixel=0;this.prevPhysicalSizePerPixel=0;this.prevTargetLengthInPixels=0;this.prevPhysicalUnit="\0"}update(){let{physicalSizePerPixel:e,targetLengthInPixels:t}=this;if(this.prevPhysicalSizePerPixel===e&&this.prevTargetLengthInPixels===t&&this.prevPhysicalUnit===this.physicalUnit)return!1;this.prevPhysicalSizePerPixel=e,this.prevTargetLengthInPixels=t,this.prevPhysicalUnit=this.physicalUnit;let r=t*e,i=Math.floor(Math.log10(r)),a=10**i,o=r/a,l=1;for(let p of this.allowedSignificands)if(Math.abs(p-o)<Math.abs(l-o))l=p;else break;let c=l*a,d=Zv(c);return this.lengthInPixels=Math.round(c/e),this.physicalUnit=`${d.prefix}${this.physicalBaseUnit}`,this.physicalLength=l*10**(i-d.exponent),!0}};function NJ(n,e,t,r,i){let a=document.createElement("canvas"),o=a.getContext("2d"),l=i.textHeightInPixels*i.scaleFactor,c=`bold ${l}px ${i.fontName}`;o.font=c,o.fillStyle="white";let d=`${r}${n.physicalLength} ${n.physicalUnit}`,p=o.measureText(d),m=Math.max(n.lengthInPixels,p.width),g=i.barHeightInPixels*i.scaleFactor,v=i.barTopMarginInPixels*i.scaleFactor,b=g+v+l,x=i.paddingInPixels*i.scaleFactor,C=b+2*x,T=m+2*x;return a.width=T,a.height=C,o.font=c,o.textAlign="center",o.fillStyle="rgba(0, 0, 0, 0.3)",o.fillRect(0,0,T,C),o.fillStyle="white",o.fillText(d,T/2,C-x-g-v),o.fillRect(x,C-x-g,n.lengthInPixels,g),nP(e,t,a),{width:T,height:C}}var vO=class extends j{constructor(e,t=new yO){super();this.gl=e;this.dimensions=t;this.texture=null;this.width=0;this.height=0;this.label="";this.factor=1;this.priorOptions=void 0;this.prevLabel=""}update(e){let{dimensions:t,label:r}=this,{texture:i}=this;if(!t.update()&&i!==null&&e===this.priorOptions&&r==this.prevLabel)return;i===null&&(i=this.texture=this.gl.createTexture());let{width:a,height:o}=NJ(t,this.gl,i,r,e);this.priorOptions=e,this.prevLabel=r,this.width=a,this.height=o}disposed(){this.gl.deleteTexture(this.texture),this.texture=null,super.disposed()}},Jp=class extends j{constructor(e){super();this.gl=e;this.scaleBarCopyHelper=this.registerDisposer(Ca.get(this.gl));this.scaleBars=[];for(let t=0;t<3;++t)this.scaleBars.push(this.registerDisposer(new vO(e)))}draw(e,t,r,i,a){let{scaleBars:o}=this,{displayRank:l,displayDimensionIndices:c,canonicalVoxelFactors:d,globalDimensionNames:p,displayDimensionUnits:m,displayDimensionScales:g}=t,{factors:v}=r,b=Math.min(a.maxWidthFraction*e.logicalWidth,a.maxWidthInPixels*a.scaleFactor),x=0;for(let P=0;P<l;++P){let M=c[P],D=m[P],E=v[M],V,O,B;for(V=0;V<x&&(O=o[V],B=O.dimensions,!(B.physicalBaseUnit===D&&O.factor===E));++V);V===x&&(++x,O=o[V],O.label="",B=O.dimensions,O.factor=E,B.physicalBaseUnit=D,B.targetLengthInPixels=b,B.physicalSizePerPixel=g[P]*i/d[P]),O.label+=`${p[M]} `}let{gl:C,scaleBarCopyHelper:T}=this,I=a.bottomPixelOffset*a.scaleFactor;for(let P=x-1;P>=0;--P){let M=o[P];x===1?M.label="":M.label+=": ",M.update(a),C.viewport(a.leftPixelOffset*a.scaleFactor-e.visibleLeftFraction*e.logicalWidth,I-(1-(e.visibleTopFraction+e.visibleHeightFraction))*e.logicalHeight,M.width,M.height),T.draw(M.texture),I+=M.height+a.marginPixelsBetweenScaleBars*a.scaleFactor}}},BJ={scaleFactor:1,textHeightInPixels:15,barHeightInPixels:8,barTopMarginInPixels:5,fontName:"sans-serif",paddingInPixels:2},SO={...BJ,maxWidthInPixels:100,maxWidthFraction:.25,leftPixelOffset:10,bottomPixelOffset:10,marginPixelsBetweenScaleBars:5};function UJ(n){let e={...SO};for(let t of["textHeightInPixels","barTopMarginInPixels","barHeightInPixels","paddingInPixels","scaleFactor","maxWidthInPixels","maxWidthFraction","leftPixelOffset","bottomPixelOffset"])W(n,t,r=>{r!==void 0&&(e[t]=vn(r))});return W(n,"fontName",t=>{t!==void 0&&(e.fontName=Q(t))}),e}var $w=class extends Le{constructor(){super(SO,UJ)}};var ai;(function(i){i[i.COLOR=0]="COLOR",i[i.Z=1]="Z",i[i.PICK=2]="PICK",i[i.NUM_TEXTURES=3]="NUM_TEXTURES"})(ai||(ai={}));var FJ=`
void emit(vec4 color, highp uint pickId) {
  out_color = color;
  float zValue = 1.0 - gl_FragCoord.z;
  out_z = vec4(zValue, zValue, zValue, 1.0);
  float pickIdFloat = float(pickId);
  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);
}
`,GJ=`
float computeOITWeight(float alpha) {
  float a = min(1.0, alpha) * 8.0 + 0.01;
  float b = -gl_FragCoord.z * 0.95 + 1.0;
  return a * a * a * b * b * b;
}
`,WJ=[GJ,`
void emit(vec4 color, highp uint pickId) {
  float weight = computeOITWeight(color.a);
  vec4 accum = color * weight;
  v4f_fragData0 = vec4(accum.rgb, color.a);
  v4f_fragData1 = vec4(accum.a, 0.0, 0.0, 0.0);
}
`];function jw(n){n.addOutputBuffer("vec4","out_color",0),n.addOutputBuffer("highp vec4","out_z",1),n.addOutputBuffer("highp vec4","out_pickId",2),n.addFragmentCode(FJ)}function zJ(n){n.addOutputBuffer("vec4","v4f_fragData0",0),n.addOutputBuffer("vec4","v4f_fragData1",1),n.addFragmentCode(WJ)}var Lo=K.create(),bO=rn.create(),HJ=ae.create();function $J(n){n.addOutputBuffer("vec4","v4f_fragColor",null),n.setFragmentMain(`
vec4 v0 = getValue0();
vec4 v1 = getValue1();
vec4 accum = vec4(v0.rgb, v1.r);
float revealage = v0.a;

v4f_fragColor = vec4(accum.rgb / accum.a, revealage);
`)}var jJ=ba(Sn),xO=class extends jJ{constructor(e){super();this.panel=e}initializeCounterpart(e,t){this.sharedProjectionParameters=this.registerDisposer(new ll(e,this.panel.projectionParameters)),t.projectionParameters=this.sharedProjectionParameters.rpcId,super.initializeCounterpart(e,t)}},qp=class extends jp{constructor(e,t,r){super(e,t,r);this.sliceViews=this.registerDisposer(new Bl((e,t,r)=>{e.registerDisposer(r),e.registerDisposer(r.visibility.add(this.visibility))}));this.axesLineHelper=this.registerDisposer(Wl.get(this.gl));this.sliceViewRenderHelper=this.registerDisposer(dl.get(this.gl,jw));this.offscreenFramebuffer=this.registerDisposer(new Fi(this.gl,{colorBuffers:[new xa(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new xa(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT),new xa(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)],depthBuffer:new OS(this.gl)}));this.offscreenCopyHelper=this.registerDisposer(Ca.get(this.gl));this.transparencyCopyHelper=this.registerDisposer(Ca.get(this.gl,$J,2));this.scaleBars=this.registerDisposer(new Jp(this.gl));this.projectionParameters=this.registerDisposer(new Wd({navigationState:this.navigationState,update:(a,o)=>{let{invViewMatrix:l,projectionMat:c,logicalWidth:d,logicalHeight:p}=a,m=d/p,g=Math.PI/4,{relativeDepthRange:v}=o,x=o.zoomFactor.value/2;if(this.viewer.orthographicProjection.value){let C=Math.max(.1,1-v),T=1+v;ae.ortho(c,-m,m,-1,1,C,T)}else{let C=1/Math.tan(g/2);v/=C;let T=Math.max(.1,1-v),I=1+v;x*=C,ae.perspective(c,g,m,T,I)}ph(a,c),o.pose.toMat4(l,x),ae.scale(l,l,K.set(Lo,1,-1,-1)),ae.translate(l,l,qr[2]),vh(a)}})),this.projectionParameters.changed.add(()=>this.context.scheduleRedraw());let i=this.sharedObject=this.registerDisposer(new xO(this));if(i.RPC_TYPE_ID=dO,i.initializeCounterpart(r.rpc,{}),i.visibility.add(this.visibility),this.visibleLayerTracker=Sg(this.viewer.layerManager,Ur,this.viewer.visibleLayerRoles,this),ce(t,"rotate-via-mouse-drag",a=>{sn(a.detail,(o,l,c)=>{this.navigationState.pose.rotateRelative(qr[1],l/4*Math.PI/180),this.navigationState.pose.rotateRelative(qr[0],-c/4*Math.PI/180)})}),ce(t,"rotate-in-plane-via-touchrotate",a=>{let{detail:o}=a;this.navigationState.pose.rotateRelative(qr[2],o.angle-o.prevAngle)}),ce(t,"rotate-out-of-plane-via-touchtranslate",a=>{let{detail:o}=a;this.navigationState.pose.rotateRelative(qr[1],o.deltaX/4*Math.PI/180),this.navigationState.pose.rotateRelative(qr[0],-o.deltaY/4*Math.PI/180)}),r.showSliceViewsCheckbox){let a=this.registerDisposer(new Fn(r.showSliceViews));a.element.className="perspective-panel-show-slice-views neuroglancer-noselect";let o=document.createElement("label");o.className="perspective-panel-show-slice-views neuroglancer-noselect",o.appendChild(document.createTextNode("Sections")),o.appendChild(a.element),this.element.appendChild(o)}this.registerDisposer(r.orthographicProjection.changed.add(()=>{this.projectionParameters.update(),this.scheduleRedraw()})),this.registerDisposer(r.showScaleBar.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.scaleBarOptions.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.showSliceViews.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.showAxisLines.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.crossSectionBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.perspectiveViewBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.wireFrame.changed.add(()=>this.scheduleRedraw())),this.sliceViews.changed.add(()=>this.scheduleRedraw())}get rpc(){return this.sharedObject.rpc}get rpcId(){return this.sharedObject.rpcId}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}flushBackendProjectionParameters(){this.sharedObject.sharedProjectionParameters.flush()}translateByViewportPixels(e,t){let r=Lo,{viewProjectionMat:i,invViewProjectionMat:a,logicalWidth:o,logicalHeight:l}=this.projectionParameters.value,{pose:c}=this.viewer.navigationState;c.updateDisplayPosition(d=>{K.transformMat4(r,d,i),r[0]+=-2*e/o,r[1]+=2*t/l,K.transformMat4(d,r,a)})}get navigationState(){return this.viewer.navigationState}ensureBoundsUpdated(){super.ensureBoundsUpdated(),this.projectionParameters.setViewport(this.renderViewport)}isReady(){if(!this.visible)return!0;for(let[o,l]of this.sliceViews)if((l||this.viewer.showSliceViews.value)&&!o.isReady())return!1;this.ensureBoundsUpdated();let{width:e,height:t}=this.renderViewport;if(e===0||t===0)return!0;let i={projectionParameters:this.projectionParameters.value},{visibleLayers:a}=this.visibleLayerTracker;for(let[o,l]of a)if(!o.isReady(i,l))return!1;return!0}disposed(){this.sliceViews.clear(),super.disposed()}getDepthArray(){if(!this.navigationState.valid)return;let{offscreenFramebuffer:e,renderViewport:{width:t,height:r}}=this,i=t*r,a=new Float32Array(i*4);try{e.bindSingle(1),this.gl.readPixels(0,0,t,r,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,a)}finally{e.framebuffer.unbind()}let o=new Float32Array(i);for(let l=0;l<i;++l)o[l]=a[l*4];return o}issuePickRequest(e,t){let{offscreenFramebuffer:r}=this;r.readPixelFloat32IntoBuffer(1,e-cn,t-cn,0,ut,ut),r.readPixelFloat32IntoBuffer(2,e-cn,t-cn,4*4*ut*ut,ut,ut)}completePickRequest(e,t,r,i){let{mouseState:a}=this.viewer;a.pickedRenderLayer=null,ly(r,0,4,e,t,i.viewportWidth,i.viewportHeight);let o=pu.length;for(let l=0;l<o;++l){let c=pu[l],d=r[4*c];if(d===0)continue;let p=c%ut,m=(c-p)/ut,g=1-d;Lo[0]=2*(e+p-cn)/i.viewportWidth-1,Lo[1]=2*(t+m-cn)/i.viewportHeight-1,Lo[2]=2*g-1,K.transformMat4(Lo,Lo,i.invTransform);let{position:v,unsnappedPosition:b}=a,{value:x}=this.navigationState.position,C=x.length;v.length!==C&&(v=a.position=new Float32Array(C)),b.length!==C&&(b=a.unsnappedPosition=new Float32Array(C)),v.set(x),a.coordinateSpace=this.navigationState.coordinateSpace.value;let T=this.navigationState.pose.displayDimensions.value,{displayDimensionIndices:I}=T;for(let M=0,D=I.length;M<D;++M)v[I[M]]=Lo[M];b.set(v);let P=r[4*ut*ut+4*c];i.pickIDs.setMouseState(a,P),a.displayDimensions=T,a.setActive(!0);return}a.setActive(!1)}translateDataPointByViewportPixels(e,t,r,i){let a=Lo,{viewProjectionMat:o,invViewProjectionMat:l,width:c,height:d}=this.projectionParameters.value;return K.transformMat4(a,t,o),a[0]+=2*r/c,a[1]+=-2*i/d,K.transformMat4(e,a,l)}get transparentConfiguration(){let e=this.transparentConfiguration_;return e===void 0&&(e=this.transparentConfiguration_=this.registerDisposer(new Fi(this.gl,{colorBuffers:al(this.gl,2,this.gl.RGBA32F,this.gl.RGBA,this.gl.FLOAT),depthBuffer:this.offscreenFramebuffer.depthBuffer.addRef()}))),e}drawWithPicking(e){if(!this.navigationState.valid)return!1;let{width:t,height:r}=this.renderViewport,i=this.viewer.showSliceViews.value;for(let[C,T]of this.sliceViews)(T||i)&&C.updateRendering();let a=this.gl,o=()=>{this.offscreenFramebuffer.bind(t,r)};o(),a.disable(a.SCISSOR_TEST),a.enable(WebGL2RenderingContext.STENCIL_TEST),a.stencilMask(4294967295),a.clearStencil(0),a.clear(WebGL2RenderingContext.STENCIL_BUFFER_BIT),a.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.REPLACE),a.stencilFunc(WebGL2RenderingContext.ALWAYS,1,1);let l=this.viewer.perspectiveViewBackgroundColor.value;this.gl.clearColor(l[0],l[1],l[2],0),a.clear(a.DEPTH_BUFFER_BIT),a.clearBufferfv(WebGL2RenderingContext.COLOR,0,[l[0],l[1],l[2],0]),a.clearBufferfv(WebGL2RenderingContext.COLOR,1,ud),a.clearBufferfv(WebGL2RenderingContext.COLOR,2,ud),a.enable(a.DEPTH_TEST);let c=this.projectionParameters.value,d=K.create();K.transformQuat(d,qr[2],this.navigationState.pose.orientation.orientation),K.scale(d,d,-1);let p=.2,m=1-p,g={wireFrame:this.viewer.wireFrame.value,projectionParameters:c,lightDirection:d,ambientLighting:p,directionalLighting:m,pickIDs:e.pickIDs,emitter:jw,emitColor:!0,emitPickID:!0,alreadyEmittedPickID:!1,bindFramebuffer:o,frameNumber:this.context.frameNumber};ae.copy(e.invTransform,c.invViewProjectionMat);let{visibleLayers:v}=this.visibleLayerTracker,b=!1,x=!1;for(let[C,T]of v)C.isTransparent?b=!0:C.isAnnotation?x=!0:C.draw(g,T);if(this.drawSliceViews(g),x){a.enable(WebGL2RenderingContext.BLEND),a.depthFunc(WebGL2RenderingContext.LEQUAL),a.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);for(let[C,T]of v)C.isAnnotation&&C.draw(g,T);a.depthFunc(WebGL2RenderingContext.LESS),a.disable(WebGL2RenderingContext.BLEND)}if(this.viewer.showAxisLines.value&&this.drawAxisLines(),a.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP),b){a.depthMask(!1),a.enable(WebGL2RenderingContext.BLEND);let{transparentConfiguration:C}=this;g.bindFramebuffer=()=>{C.bind(t,r)},g.bindFramebuffer(),this.gl.clearColor(0,0,0,1),a.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),g.emitter=zJ,a.blendFuncSeparate(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE,WebGL2RenderingContext.ZERO,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),g.emitPickID=!1;for(let[T,I]of v)T.isTransparent&&T.draw(g,I);a.disable(WebGL2RenderingContext.DEPTH_TEST),this.offscreenFramebuffer.bindSingle(0),a.blendFunc(WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA,WebGL2RenderingContext.SRC_ALPHA),this.transparencyCopyHelper.draw(C.colorBuffers[0].texture,C.colorBuffers[1].texture),a.depthMask(!0),a.disable(WebGL2RenderingContext.BLEND),a.enable(WebGL2RenderingContext.DEPTH_TEST),g.bindFramebuffer=o,o(),a.enable(WebGL2RenderingContext.STENCIL_TEST),a.drawBuffers([a.NONE,a.COLOR_ATTACHMENT1,a.COLOR_ATTACHMENT2]),g.emitter=jw,g.emitPickID=!0,g.emitColor=!1,a.stencilFunc(WebGL2RenderingContext.NOTEQUAL,3,1),a.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.REPLACE),a.stencilMask(2);for(let[T,I]of v)!T.isTransparent||!T.transparentPickEnabled||T.draw(g,I);a.stencilFunc(WebGL2RenderingContext.EQUAL,0,3),a.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP),a.stencilMask(0);for(let[T,I]of v)!T.isTransparent||T.transparentPickEnabled||T.draw(g,I)}if(a.stencilMask(4294967295),a.disable(WebGL2RenderingContext.STENCIL_TEST),this.viewer.showScaleBar.value&&this.viewer.orthographicProjection.value){a.drawBuffers([a.COLOR_ATTACHMENT0]),a.disable(WebGL2RenderingContext.DEPTH_TEST),a.enable(WebGL2RenderingContext.BLEND),a.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);let{scaleBars:C}=this,T=this.viewer.scaleBarOptions.value;C.draw(this.renderViewport,this.navigationState.displayDimensionRenderInfo.value,this.navigationState.relativeDisplayScales.value,this.navigationState.zoomFactor.value/this.renderViewport.logicalHeight,T),a.disable(WebGL2RenderingContext.BLEND)}return this.offscreenFramebuffer.unbind(),this.setGLClippedViewport(),this.offscreenCopyHelper.draw(this.offscreenFramebuffer.colorBuffers[0].texture),!0}drawSliceViews(e){let{sliceViewRenderHelper:t}=this,{lightDirection:r,ambientLighting:i,directionalLighting:a,projectionParameters:{viewProjectionMat:o}}=e,l=this.viewer.showSliceViews.value;for(let[c,d]of this.sliceViews){if(!d&&!l)continue;let{width:p,height:m,invViewMatrix:g,viewportNormalInCanonicalCoordinates:v}=c.projectionParameters.value;if(p===0||m===0||!c.valid)continue;let b=Math.abs(K.dot(r,v)),x=i+b*a,C=HJ;ae.identity(C),C[0]=p/2,C[5]=-m/2,ae.multiply(C,g,C),ae.multiply(C,o,C);let T=bO,I=this.viewer.crossSectionBackgroundColor.value;T[0]=I[0],T[1]=I[1],T[2]=I[2],T[3]=1,t.draw(c.offscreenFramebuffer.colorBuffers[0].texture,C,rn.fromValues(x,x,x,1),bO,0,0,1,1)}}drawAxisLines(){let{zoomFactor:{value:e}}=this.viewer.navigationState,t=this.projectionParameters.value,r=Math.min(t.logicalWidth,t.logicalHeight)/this.renderViewport.logicalHeight/4,i=e*r,{gl:a}=this;a.drawBuffers([a.COLOR_ATTACHMENT0]),this.axesLineHelper.draw(sy(t,i),!1)}zoomByMouse(e){this.navigationState.zoomBy(e)}};var fu;(function(r){r[r.COLOR=0]="COLOR",r[r.PICK=1]="PICK",r[r.NUM_TEXTURES=2]="NUM_TEXTURES"})(fu||(fu={}));function JJ(n){n.addOutputBuffer("vec4","out_fragColor",0),n.addOutputBuffer("highp vec4","out_pickId",1),n.addFragmentCode(`
void emit(vec4 color, highp uint pickId) {
  out_fragColor = color;
  float pickIdFloat = float(pickId);
  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);
}
`)}function qJ(n){n.addOutputBuffer("vec4","out_fragColor",null),n.addFragmentCode(`
void emit(vec4 color, highp uint pickId) {
  out_fragColor = color;
}
`)}var zl=K.create(),YJ=K.create(),KJ=rn.create(),hu=class extends jp{constructor(e,t,r,i){super(e,t,i);this.sliceView=r;this.axesLineHelper=this.registerDisposer(Wl.get(this.gl));this.sliceViewRenderHelper=this.registerDisposer(dl.get(this.gl,qJ));this.colorFactor=rn.fromValues(1,1,1,1);this.pickIDs=new $p;this.offscreenFramebuffer=this.registerDisposer(new Fi(this.gl,{colorBuffers:[new xa(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new xa(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)]}));this.offscreenCopyHelper=this.registerDisposer(Ca.get(this.gl));this.scaleBars=this.registerDisposer(new Jp(this.gl));i.wireFrame.changed.add(()=>this.scheduleRedraw()),ce(t,"rotate-via-mouse-drag",a=>{let{mouseState:o}=this.viewer;if(o.updateUnconditionally()){let l=Float32Array.from(o.position);sn(a.detail,(c,d,p)=>{let{pose:m}=this.navigationState,g=K.transformQuat(zl,qr[0],m.orientation.orientation),v=K.transformQuat(YJ,qr[1],m.orientation.orientation);this.viewer.navigationState.pose.rotateAbsolute(v,-d/4*Math.PI/180,l),this.viewer.navigationState.pose.rotateAbsolute(g,-p/4*Math.PI/180,l)})}}),ce(t,"rotate-in-plane-via-touchrotate",a=>{let{detail:o}=a,{mouseState:l}=this.viewer;this.handleMouseMove(o.centerX,o.centerY),l.updateUnconditionally()&&this.navigationState.pose.rotateAbsolute(this.sliceView.projectionParameters.value.viewportNormalInCanonicalCoordinates,o.angle-o.prevAngle,l.position)}),this.registerDisposer(r),this.visibleLayerTracker=Sg(this.viewer.layerManager,hi,this.viewer.visibleLayerRoles,this),this.registerDisposer(i.crossSectionBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.visibility.add(this.visibility)),this.registerDisposer(r.viewChanged.add(()=>{this.visible&&e.scheduleRedraw()})),this.registerDisposer(i.showAxisLines.changed.add(()=>{this.visible&&this.scheduleRedraw()})),this.registerDisposer(i.showScaleBar.changed.add(()=>{this.visible&&this.context.scheduleRedraw()})),this.registerDisposer(i.scaleBarOptions.changed.add(()=>{this.visible&&this.context.scheduleRedraw()}))}flushBackendProjectionParameters(){this.sliceView.flushBackendProjectionParameters()}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}get rpc(){return this.sliceView.rpc}get rpcId(){return this.sliceView.rpcId}get navigationState(){return this.sliceView.navigationState}translateByViewportPixels(e,t){let{pose:r}=this.viewer.navigationState;r.updateDisplayPosition(i=>{K.set(i,-e,-t,0),K.transformMat4(i,i,this.sliceView.projectionParameters.value.invViewMatrix)})}translateDataPointByViewportPixels(e,t,r,i){let a=this.sliceView.projectionParameters.value;return K.transformMat4(e,t,a.viewMatrix),K.set(e,e[0]+r,e[1]+i,e[2]),K.transformMat4(e,e,a.invViewMatrix),e}isReady(){if(!this.visible)return!1;let{sliceView:e}=this;if(this.ensureBoundsUpdated(),!e.isReady())return!1;let t={projectionParameters:e.projectionParameters.value,sliceView:e};for(let[r,i]of this.visibleLayerTracker.visibleLayers)if(!r.isReady(t,i))return!1;return!0}drawWithPicking(e){let{sliceView:t}=this;if(!t.valid)return!1;t.updateRendering();let r=t.projectionParameters.value,{width:i,height:a,invViewProjectionMat:o}=r;ae.copy(e.invTransform,o);let{gl:l}=this;this.offscreenFramebuffer.bind(i,a),l.disable(WebGL2RenderingContext.SCISSOR_TEST),this.gl.clearColor(0,0,0,0),l.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);let c=KJ,d=this.viewer.crossSectionBackgroundColor.value;c[0]=d[0],c[1]=d[1],c[2]=d[2],c[3]=1,this.offscreenFramebuffer.bindSingle(0),this.sliceViewRenderHelper.draw(t.offscreenFramebuffer.colorBuffers[0].texture,jf,this.colorFactor,c,0,0,1,1);let{visibleLayers:p}=this.visibleLayerTracker,{pickIDs:m}=this;m.clear();let g=()=>{l.disable(WebGL2RenderingContext.SCISSOR_TEST),l.enable(WebGL2RenderingContext.BLEND),l.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),this.offscreenFramebuffer.bind(i,a)};g();let v={wireFrame:this.viewer.wireFrame.value,projectionParameters:r,pickIDs:m,emitter:JJ,emitColor:!0,emitPickID:!0,sliceView:t,bindFramebuffer:g,frameNumber:this.context.frameNumber};for(let[b,x]of p)b.draw(v,x);if(l.disable(WebGL2RenderingContext.BLEND),this.viewer.showAxisLines.value||this.viewer.showScaleBar.value){if(this.offscreenFramebuffer.bindSingle(0),this.viewer.showAxisLines.value){let b=Math.min(r.logicalWidth,r.logicalHeight)/4*1.5,{zoomFactor:{value:x}}=this.viewer.navigationState;this.axesLineHelper.draw(oE(sy(r,b*x)))}this.viewer.showScaleBar.value&&(l.enable(WebGL2RenderingContext.BLEND),l.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),this.scaleBars.draw(r,this.navigationState.displayDimensionRenderInfo.value,this.navigationState.relativeDisplayScales.value,this.navigationState.zoomFactor.value,this.viewer.scaleBarOptions.value),l.disable(WebGL2RenderingContext.BLEND))}return this.offscreenFramebuffer.unbind(),this.setGLClippedViewport(),this.offscreenCopyHelper.draw(this.offscreenFramebuffer.colorBuffers[0].texture),!0}ensureBoundsUpdated(){super.ensureBoundsUpdated(),this.sliceView.projectionParameters.setViewport(this.renderViewport)}issuePickRequest(e,t){let{offscreenFramebuffer:r}=this;r.readPixelFloat32IntoBuffer(1,e-cn,t-cn,0,ut,ut)}completePickRequest(e,t,r,i){let{mouseState:a}=this.viewer;a.pickedRenderLayer=null,ly(r,0,4,e,t,i.viewportWidth,i.viewportHeight);let{viewportWidth:o,viewportHeight:l}=i,c=pu.length,{value:d}=this.navigationState.position,p=d.length,m=this.navigationState.pose.displayDimensions.value,{displayRank:g,displayDimensionIndices:v}=m,b=(T,I,P)=>{let M=e+T,D=t+I;zl[0]=2*M/o-1,zl[1]=2*D/l-1,zl[2]=0,K.transformMat4(zl,zl,i.invTransform),P.set(d);for(let E=0;E<g;++E)P[v[E]]=zl[E]},{unsnappedPosition:x}=a;x.length!==p&&(x=a.unsnappedPosition=new Float32Array(p)),a.coordinateSpace=this.navigationState.coordinateSpace.value,a.displayDimensions=m,b(0,0,x);let C=(T,I,P)=>{let{position:M}=a;M.length!==p&&(M=a.position=new Float32Array(p)),b(T-cn,I-cn,M),this.pickIDs.setMouseState(a,P),a.setActive(!0)};for(let T=0;T<c;++T){let I=pu[T],P=r[4*T];if(P===0)continue;let M=I%ut,D=(I-M)/ut;C(M,D,P);return}C(cn,cn,0)}zoomByMouse(e){let{navigationState:t}=this;if(!t.valid)return;let{sliceView:r}=this,{width:i,height:a,invViewMatrix:o,displayDimensionRenderInfo:{displayDimensionIndices:l,displayRank:c}}=r.projectionParameters.value,{mouseX:d,mouseY:p}=this;d-=i/2,p-=a/2;let m=this.navigationState.position.value;for(let g=0;g<c;++g){let v=l[g],b=o[g]*d+o[4+g]*p;m[v]+=b*(1-e)}this.navigationState.position.changed.dispatch(),t.zoomBy(e)}};var CO=ot(Et());var XJ=["#f00","#0f0","#00f"],wO=Me.fromObject({arrowup:{action:"move-up"},arrowdown:{action:"move-down"},wheel:{action:"adjust-via-wheel"},enter:{action:"commit"},escape:{action:"cancel"}});function QJ(n){if(n<1||n>1024){let e=Math.log2(n)|0,t=n/2**e;return`${qg(t,1)}p${e}`}return n.toString()}var ZJ=[n=>n.name,n=>n.scaleFactor],eq=2e3,Jw=class extends j{constructor(e,t,r,i="px"){super();this.displayDimensionRenderInfo=e;this.zoom=t;this.depthRange=r;this.displayUnit=i;this.element=document.createElement("div");this.dimensionGridContainer=document.createElement("div");this.depthGridContainer=document.createElement("div");this.defaultCheckbox=document.createElement("input");this.dimensionElements=Array.from(Array(3),(e,t)=>{let r=document.createElement("div");r.classList.add("neuroglancer-display-dimensions-widget-dimension"),r.style.display="contents",ce(r,"adjust-via-wheel",d=>{let p=d.detail,{deltaY:m}=p;m!==0&&this.zoomDimension(t,Math.sign(m))});let i=document.createElement("input");i.classList.add("neuroglancer-display-dimensions-widget-name"),i.title="Change display dimensions",i.spellcheck=!1,i.autocomplete="off",i.style.color=XJ[t],i.style.gridColumn="1",i.style.gridRow=`${t+1}`,i.addEventListener("focus",()=>{i.select()}),r.appendChild(i);let a=document.createElement("span");a.classList.add("neuroglancer-display-dimensions-widget-scale-factor");let o=document.createElement("input");o.spellcheck=!1,o.title="Change relative scale at which dimension is displayed",o.autocomplete="off",a.style.gridColumn="2",a.style.gridRow=`${t+1}`,o.addEventListener("focus",()=>{o.select()}),a.appendChild(o),r.appendChild(a);let l=document.createElement("span");l.classList.add("neuroglancer-display-dimensions-widget-scale"),l.style.gridColumn="3",l.style.gridRow=`${t+1}`,r.appendChild(l),this.dimensionGridContainer.appendChild(r);let c={name:i,container:r,scaleFactor:o,scale:l,scaleFactorModified:!1};i.addEventListener("input",()=>{xn(i),this.updateNameValidity()}),ce(i,"commit",()=>{this.updateNames()}),i.addEventListener("blur",d=>{let{relatedTarget:p}=d;this.dimensionElements.some(m=>m.name===p)||this.updateNames()||this.updateView()}),a.addEventListener("click",d=>{let{target:p}=d;p!==o&&(o.focus(),d.preventDefault())}),o.addEventListener("input",()=>{xn(o),c.scaleFactorModified=!0}),ce(o,"commit",()=>{this.updateScaleFactors()}),o.addEventListener("blur",()=>{this.updateScaleFactors()||this.updateView()});for(let d of ZJ)ce(d(c),"move-up",()=>{t!==0&&d(this.dimensionElements[t-1]).focus()}),ce(d(c),"move-down",()=>{t!==2&&d(this.dimensionElements[t+1]).focus()});return c});this.scheduleUpdateView=We(()=>this.updateView());let{element:a,dimensionGridContainer:o,defaultCheckbox:l}=this,c=document.createElement("label"),d=this.registerCancellable((0,CO.default)(()=>{a.dataset.active="false"},eq)),p=()=>{a.dataset.active="true",d()};this.registerDisposer(t.changed.add(p)),this.registerDisposer(e.relativeDisplayScales.changed.add(p)),this.registerDisposer(r.changed.add(p)),a.classList.add("neuroglancer-display-dimensions-widget"),a.appendChild(o),o.classList.add("neuroglancer-display-dimensions-widget-dimension-grid"),a.addEventListener("pointerleave",()=>{let x=document.activeElement;x instanceof HTMLElement&&a.contains(x)&&x.blur()}),l.type="checkbox",c.appendChild(l),c.appendChild(document.createTextNode("Default")),c.title="Display first 3 dimensions",c.classList.add("neuroglancer-display-dimensions-widget-default"),l.addEventListener("change",()=>{this.updateDefault()}),o.appendChild(c),this.registerDisposer(e),this.registerDisposer(r),this.registerDisposer(t.changed.add(this.scheduleUpdateView)),this.registerDisposer(e.changed.add(this.scheduleUpdateView));let m=this.registerDisposer(new $t(a,wO));m.allShortcutsAreGlobal=!0,this.registerDisposer(new wn(a,wO)),ce(o,"cancel",()=>{this.updateView();let x=document.activeElement;x instanceof HTMLElement&&a.contains(x)&&x.blur()});let{depthGridContainer:g}=this;g.classList.add("neuroglancer-depth-range-widget-grid"),a.appendChild(g);let v=document.createElement("label"),b=document.createElement("input");b.type="checkbox",v.classList.add("neuroglancer-depth-range-relative-checkbox-label"),b.classList.add("neuroglancer-depth-range-relative-checkbox"),v.appendChild(b),v.appendChild(document.createTextNode("Zoom-relative")),b.addEventListener("change",()=>{let x=b.checked,C=this.depthRange.value;x!==C<0&&(x?C=-C/this.zoom.value:C=-C*this.zoom.value,this.depthRange.value=C)}),v.title="Depth range is multiplied by scale",a.appendChild(v),ce(g,"adjust-via-wheel",x=>{let C=x.detail,{deltaY:T}=C;if(T===0)return;let I=this.depthRange.value;this.depthRange.value=I*2**Math.sign(T)}),this.registerDisposer(Dn((x,C,{factors:T})=>{Ie(g);let{displayRank:I,globalDimensionNames:P,displayDimensionIndices:M,displayDimensionUnits:D,displayDimensionScales:E,canonicalVoxelFactors:V}=C,O=[],B=()=>{b.checked=this.depthRange.value<0;let U=this.depthRange.value;U<0&&(U*=-this.zoom.value);for(let N of O){let{input:J}=N;J.value=Vi(U*N.scale,N.unit,{precision:2,elide1:!1}),xn(J)}},z=U=>{let N=Ho(U.input.value);if(N===void 0||N.unit!==U.unit)return!1;let J=N.scale/U.scale;return this.depthRange.value<0&&(J=-J/this.zoom.value),this.depthRange.value=J,!0};for(let U=0;U<I;++U){let N=M[U],J=P[N],ie=D[U],pe=T[N],me=O.find(Pe=>Pe.unit===ie&&Pe.factor===pe);if(me===void 0){let Pe=document.createElement("div");Pe.title="Visible depth range",Pe.style.display="contents",g.appendChild(Pe);let le=document.createElement("span");le.textContent="\xB1",Pe.appendChild(le);let we=document.createElement("input");we.spellcheck=!1,we.autocomplete="off",we.addEventListener("focus",()=>{we.select()}),ce(we,"commit",()=>{z(me)}),we.addEventListener("change",()=>{z(me)||B()}),we.addEventListener("input",()=>{xn(we)}),Pe.appendChild(we);let Re=document.createElement("span");Re.classList.add("neuroglancer-depth-range-widget-dimension-names"),Pe.appendChild(Re),me={unit:ie,factor:pe,dimensionNames:[],input:we,label:Re,scale:E[U]/V[U]},O.push(me)}me.dimensionNames.push(J)}for(let U of O)U.dimensionNames.length!==I&&(U.label.textContent=U.dimensionNames.join(" "));x.registerDisposer(ce(g,"cancel",()=>{B();let U=document.activeElement;U instanceof HTMLElement&&g.contains(U)&&U.blur()}));let _=x.registerCancellable(We(B));x.registerDisposer(this.depthRange.changed.add(_)),x.registerDisposer(this.zoom.changed.add(_)),B()},e,this.relativeDisplayScales)),this.updateView()}zoomDimension(e,t){this.updateScaleFactors();let{displayDimensions:r}=this,{relativeDisplayScales:i}=this,{displayDimensionIndices:a}=r.value,o=a[e];if(o===-1)return;let{factors:l}=i.value,c=new Float64Array(l);c[o]*=2**-t,i.setFactors(c)}updateNameValidity(){let{dimensionElements:e}=this,{displayDimensionIndices:t}=this.displayDimensions.value,r=e.map(c=>c.name.value),i=Ed(r),a=this.displayDimensions.coordinateSpace.value,{names:o}=a,l=r.length;for(let c=0;c<l;++c){let d=i[c],p=r[c],m=-1;p.length===0?d=!0:(m=o.indexOf(p),m===-1&&(d=!1));let g=e[c];g.name.dataset.isValid=d.toString(),g.container.dataset.isModified=(m!==t[c]).toString()}}get displayDimensions(){return this.displayDimensionRenderInfo.displayDimensions}get relativeDisplayScales(){return this.displayDimensionRenderInfo.relativeDisplayScales}updateNames(){let e=this.dimensionElements.map(l=>l.name.value).filter(l=>l.length>0);if(!Ic(e))return!1;let{displayDimensions:t}=this.displayDimensionRenderInfo;if(e.length===0)return t.reset(),!0;let r=new Int32Array(3);r.fill(-1);let i=t.coordinateSpace.value,{names:a}=i,o=e.length;for(let l=0;l<o;++l){let c=a.indexOf(e[l]);if(c===-1)return!1;r[l]=c}return xe(r,t.value.displayDimensionIndices)||t.setDimensionIndices(o,r),!0}updateDefault(){this.displayDimensions.default=this.defaultCheckbox.checked}updateScaleFactors(){let{displayDimensions:e}=this,{relativeDisplayScales:t}=this,{displayDimensionIndices:r,displayRank:i}=e.value,{factors:a}=t.value,{dimensionElements:o}=this,l=new Float64Array(a);for(let c=0;c<i;++c){let d=o[c];if(!d.scaleFactorModified)continue;let p=Number(d.scaleFactor.value),m=r[c];!Number.isFinite(p)||p<=0||(l[m]=p)}return xe(l,a)||t.setFactors(l),!0}updateView(){let{dimensionElements:e,displayDimensions:{default:t}}=this,{displayDimensionIndices:r,canonicalVoxelFactors:i,displayDimensionUnits:a,displayDimensionScales:o,globalDimensionNames:l}=this.displayDimensionRenderInfo.value,{factors:c}=this.relativeDisplayScales.value;this.defaultCheckbox.checked=t;let d=this.zoom.value,p=r[0],m=!0;if(p!==-1){let g=a[0],v=c[p];for(let b=1;b<3;++b){let x=r[b];if(x!==-1&&(a[b]!==g||c[x]!==v)){m=!1;break}}}for(let g=0;g<3;++g){let v=r[g],b=e[g];if(delete b.name.dataset.isValid,b.container.dataset.isModified=(v===-1).toString(),v===-1)b.name.value="",b.scale.textContent="",b.scaleFactor.value="";else{b.name.value=l[v];let x=o[g]*d/i[g];if(g===0||!m){let C=Vi(x,a[g],{precision:2,elide1:!1});b.scale.textContent=`${C}/${this.displayUnit}`}else b.scale.textContent="";b.scaleFactor.value=QJ(c[v])}xn(b.name),xn(b.scaleFactor)}}disposed(){Ye(this.element),super.disposed()}};var LO=new Map([["xy",void 0],["xz",Ke.rotateX(Ke.create(),Ke.create(),Math.PI/2)],["yz",Ke.rotateY(Ke.create(),Ke.create(),Math.PI/2)]]),kO="\u25FB",qw=new Map([["4panel","\u25F1"],["3d",kO]]);function tq(n,e){let t;return e===void 0?t=n.navigationState.addRef():t=new Ba(new Na(n.navigationState.pose.position.addRef(),n.navigationState.pose.displayDimensionRenderInfo.addRef(),So.makeRelative(n.navigationState.pose.orientation,e)),n.navigationState.zoomFactor.addRef(),n.navigationState.depthRange.addRef()),new Bc(n.chunkManager,n.layerManager,t,n.wireFrame)}function Yp(n,e){return tq(n,LO.get(e))}function nq(n){return new Map([["xy",Yp(n,"xy")],["xz",Yp(n,"xz")],["yz",Yp(n,"yz")]])}function EO(n){return{crossSectionBackgroundColor:n.crossSectionBackgroundColor,perspectiveViewBackgroundColor:n.perspectiveViewBackgroundColor,selectionDetailsState:n.selectionDetailsState,mouseState:n.mouseState,layerManager:n.layerManager,showAxisLines:n.showAxisLines,wireFrame:n.wireFrame,visibleLayerRoles:n.visibleLayerRoles,selectedLayer:n.selectedLayer,visibility:n.visibility,scaleBarOptions:n.scaleBarOptions}}function Yw(n){let{viewer:e}=n;return{...EO(e),navigationState:e.perspectiveNavigationState,inputEventMap:e.inputEventBindings.perspectiveView,orthographicProjection:n.specification.orthographicProjection,showScaleBar:e.showScaleBar,rpc:e.chunkManager.rpc}}function cy(n){return{...EO(n),navigationState:n.navigationState,inputEventMap:n.inputEventBindings.sliceView}}function mu(n,e){let{navigationState:t}=e;e.element.appendChild(n.registerDisposer(new Jw(t.pose.displayDimensionRenderInfo.addRef(),t.zoomFactor,t.depthRange.addRef(),e instanceof hu?"px":"vh")).element)}function gu(n,e,t){let r=document.createElement("div");r.className="neuroglancer-data-panel-layout-controls",n.registerDisposer(()=>Ye(r));for(let i=0;i<2;++i){let a=t[Math.min(t.length-1,i)];n.registerDisposer(ce(e.element,i===0?"toggle-layout":"toggle-layout-alternative",o=>{n.container.name=a,o.stopPropagation()}))}for(let i of t){let a=document.createElement("button"),o=document.createElement("div");a.appendChild(o),o.textContent=qw.get(i),a.title=`Switch to ${i} layout.`,a.addEventListener("click",()=>{n.container.name=i}),r.appendChild(a)}e.element.appendChild(r)}function rq(n,e){let t=new Bc(n.chunkManager,n.layerManager,e.navigationState.addRef(),n.wireFrame),r=()=>{let{width:{value:i},height:{value:a}}=e;t.projectionParameters.setViewport({width:i,height:a,logicalWidth:i,logicalHeight:a,visibleLeftFraction:0,visibleTopFraction:0,visibleWidthFraction:1,visibleHeightFraction:1})};return t.registerDisposer(e.width.changed.add(r)),t.registerDisposer(e.height.changed.add(r)),r(),t}function Kw(n,e,t){let r=new Map;(()=>{let a=new Set;for(let o of t.values()){if(a.add(o),r.has(o))continue;let l=rq(n,o);e.sliceViews.set(l,!0),r.set(o,l)}for(let[o,l]of r)a.has(o)||e.sliceViews.delete(l)})()}var DO=class extends j{constructor(e,t,r,i){super();this.container=e;this.rootElement=t;this.viewer=r;let a=nq(r),{display:o}=r,l={...Yw(e),showSliceViews:r.showPerspectiveSliceViews,showSliceViewsCheckbox:!0},c={...cy(r),showScaleBar:r.showScaleBar},d={...cy(r),showScaleBar:new qe(!1,!1)},p=(g,v,b,x)=>{let C=this.registerDisposer(new hu(o,v,a.get(g),b));return x&&mu(this,C),gu(this,C,[g,`${g}-3d`]),C},m=[ii(1,Is("column",[ii(1,Is("row",[ii(1,g=>{p("xy",g,c,!0)}),ii(1,g=>{p("xz",g,d,!1)})])),ii(1,Is("row",[ii(1,g=>{let v=this.registerDisposer(new qp(o,g,l));for(let b of a.values())v.sliceViews.set(b.addRef(),!1);mu(this,v),Kw(r,v,i),gu(this,v,["3d"])}),ii(1,g=>{p("yz",g,d,!1)})]))]))];Is("row",m)(t)}disposed(){Ie(this.rootElement),super.disposed()}},PO=class extends j{constructor(e,t,r,i,a,o){super();this.container=e;this.rootElement=t;this.viewer=r;this.direction=i;let l=Yp(r,a),{display:c}=r,d={...Yw(e),showSliceViews:r.showPerspectiveSliceViews,showSliceViewsCheckbox:!0},p={...cy(r),showScaleBar:r.showScaleBar};ii(1,Is(i,[ii(1,m=>{let g=this.registerDisposer(new hu(c,m,l,p));mu(this,g),gu(this,g,[a,"4panel"])}),ii(1,m=>{let g=this.registerDisposer(new qp(c,m,d));g.sliceViews.set(l.addRef(),!1),Kw(r,g,o),mu(this,g),gu(this,g,["3d","4panel"])})]))(t)}disposed(){Ie(this.rootElement),super.disposed()}},IO=class extends j{constructor(e,t,r,i){super();this.container=e;this.rootElement=t;this.viewer=r;let a=Yp(r,i),o={...cy(r),showScaleBar:r.showScaleBar};Is("row",[ii(1,l=>{let c=this.registerDisposer(new hu(r.display,l,a,o));mu(this,c),gu(this,c,["4panel",`${i}-3d`])})])(t)}disposed(){Ie(this.rootElement),super.disposed()}},AO=class extends j{constructor(e,t,r,i){super();this.container=e;this.rootElement=t;this.viewer=r;let a={...Yw(e),showSliceViews:new qe(!1,!1)};Is("row",[ii(1,o=>{let l=this.registerDisposer(new qp(r.display,o,a));Kw(r,l,i),mu(this,l),gu(this,l,["4panel"])})])(t)}disposed(){Ie(this.rootElement),super.disposed()}},Xw=new Map([["4panel",{factory:(n,e,t,r)=>new DO(n,e,t,r)}],["3d",{factory:(n,e,t,r)=>new AO(n,e,t,r)}]]);for(let n of LO.keys()){Xw.set(n,{factory:(t,r,i)=>new IO(t,r,i,n)});let e=`${n}-3d`;qw.set(n,kO),qw.set(e,"\u25EB"),Xw.set(e,{factory:(t,r,i,a)=>new PO(t,r,i,"row",n,a)})}function MO(n){let e=Xw.get(n);if(e===void 0)throw new Error(`Invalid layout name: ${JSON.stringify(n)}.`);return e}function iq(n){return MO(n),n}var RO=class extends j{constructor(e){super();this.width=new Le(1e3,St);this.height=new Le(1e3,St);this.changed=new re;this.position=new Cp(e.position.addRef()),this.position.changed.add(this.changed.dispatch),this.orientation=new tu(e.pose.orientation.addRef()),this.orientation.changed.add(this.changed.dispatch),this.width.changed.add(this.changed.dispatch),this.height.changed.add(this.changed.dispatch),this.scale=new nu(e.zoomFactor.addRef(),e.zoomFactor.displayDimensionRenderInfo.addRef()),this.scale.changed.add(this.changed.dispatch),this.navigationState=this.registerDisposer(new Ba(new Na(this.position.value,e.pose.displayDimensionRenderInfo.addRef(),this.orientation.value),this.scale.value,e.depthRange.addRef()))}restoreState(e){Z(e),ln(e,"width",this.width),ln(e,"height",this.height),ln(e,"position",Rl(this.position)),ln(e,"orientation",this.orientation),ln(e,"scale",this.scale),ln(e,"zoom",Rl(this.scale))}reset(){this.width.reset(),this.height.reset(),this.position.reset(),this.orientation.reset(),this.scale.reset()}toJSON(){return{width:this.width.toJSON(),height:this.height.toJSON(),position:this.position.toJSON(),orientation:this.orientation.toJSON(),scale:this.scale.toJSON()}}},_O=class extends Bl{constructor(e){super((t,r)=>t.registerDisposer(t.registerDisposer(r).changed.add(this.changed.dispatch)));this.parentNavigationState=e;this.registerDisposer(e)}restoreState(e){Z(e);for(let t of Object.keys(e)){let r=new RO(this.parentNavigationState);try{this.set(t,r.addRef()),r.restoreState(e[t])}finally{r.dispose()}}}reset(){this.clear()}toJSON(){if(this.size===0)return;let e={};for(let[t,r]of this)e[t]=r.toJSON();return e}},VO=class extends j{constructor(e,t){super();this.changed=new re;this.orthographicProjection=new qe(!1);this.type=new Le(t,iq),this.type.changed.add(this.changed.dispatch),this.crossSections=this.registerDisposer(new _O(e.addRef())),this.crossSections.changed.add(this.changed.dispatch),this.orthographicProjection.changed.add(this.changed.dispatch),this.registerDisposer(e)}reset(){this.crossSections.clear(),this.orthographicProjection.reset(),this.type.reset()}restoreState(e){this.crossSections.clear(),this.orthographicProjection.reset(),typeof e=="string"?this.type.restoreState(e):(Z(e),W(e,"type",t=>this.type.restoreState(t)),W(e,"orthographicProjection",t=>this.orthographicProjection.restoreState(t)),W(e,"crossSections",t=>t!==void 0&&this.crossSections.restoreState(t)))}toJSON(){let{type:e,crossSections:t,orthographicProjection:r}=this,i=r.toJSON();return t.size===0&&i===void 0?e.value:{type:e.value,crossSections:t.toJSON(),orthographicProjection:i}}},Qw=class extends j{constructor(e,t){super();this.viewer=e;this.element=document.createElement("div");this.specification=this.registerDisposer(new VO(this.viewer.navigationState.addRef(),t)),this.element.style.flex="1";let r=this.registerCancellable((0,TO.default)(()=>this.updateLayout(),0));this.specification.type.changed.add(r),ce(this.element,"toggle-orthographic-projection",()=>this.specification.orthographicProjection.toggle()),this.registerDisposer(this.viewer.display.updateStarted.add(()=>r.flush())),r()}get name(){return this.specification.type.value}set name(e){this.specification.type.value=e}get changed(){return this.specification.changed}toJSON(){return this.specification.toJSON()}restoreState(e){this.specification.restoreState(e)}reset(){this.specification.reset()}disposeLayout(){let{layout:e}=this;e!==void 0&&(e.dispose(),this.layout=void 0)}updateLayout(){this.disposeLayout(),this.layout=MO(this.name).factory(this,this.element,this.viewer,this.specification.crossSections)}disposed(){this.disposeLayout(),super.disposed()}};var OO=typeof STATE_SERVERS!="undefined"&&Object.keys(STATE_SERVERS).length>0,Zw=class extends j{constructor(e){super();this.element=document.createElement("div");this.button=He({text:"Share",title:"Share State"});if(typeof STATE_SERVERS=="undefined")throw new Error("Cannot construct StateSare without defining STATE_SERVERS");if(Object.keys(STATE_SERVERS).length>1){let t=document.createElement("select");t.style.marginRight="5px",this.registerDisposer(e.selectedStateServer.changed.add(()=>{let r=e.selectedStateServer.value;Object.values(STATE_SERVERS).map(i=>i.url).includes(r)&&(t.value=r)})),this.registerEventListener(t,"change",()=>{e.selectedStateServer.value=t.value});for(let[r,i]of Object.entries(STATE_SERVERS)){let a=document.createElement("option");a.textContent=r,a.value=i.url,a.selected=!!i.default,t.appendChild(a)}this.element.appendChild(t),this.selectStateServerElement=t}this.element.appendChild(this.button),this.registerEventListener(this.button,"click",()=>{let t=this.selectStateServerElement?this.selectStateServerElement.value:Object.values(STATE_SERVERS)[0].url,r=new URL(t).protocol,{url:i,credentialsProvider:a}=Tn(t,sr);Ce.forPromise(Mn(a,i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.state.toJSON())},bt).then(o=>{let l=new URL(o);l.protocol=r;let c=`${window.location.origin}/#!${l}`;navigator.clipboard.writeText(c).then(()=>{Ce.showTemporaryMessage("Share link copied to clipboard")})}).catch(()=>{Ce.showTemporaryMessage("Could not access state server.",4e3)}),{initialMessage:`Posting state to ${t}.`,delay:!0,errorPrefix:""})})}disposed(){this.element.remove(),super.disposed()}};function aq(n){return n.startsWith("key")?n.substring(3):n.startsWith("digit")||n.startsWith("arrow")?n.substring(5):n}function oq(n){return n.split("+").map(aq).join("+")}var sq={...vi,side:"left",row:1},e0=class{constructor(){this.location=new Zn(sq)}get changed(){return this.location.changed}toJSON(){return Ri(this.location.toJSON())}reset(){this.location.reset()}restoreState(e){this.location.restoreState(e)}},t0=class extends Fr{constructor(e,t,r,i,a){super(e,t.location);this.bindings=r;this.toolBinder=a;this.scroll=document.createElement("div");this.addTitleBar({title:"Help"});let o=document.createElement("div");o.classList.add("neuroglancer-help-body");let{scroll:l}=this;l.classList.add("neuroglancer-help-scroll-container"),o.appendChild(l),this.addBody(o);let c=this.registerCancellable(We(()=>this.updateView()));this.registerDisposer(a.changed.add(c)),this.registerDisposer(i.layersChanged.add(c)),this.updateView()}updateView(){let{scroll:e,bindings:t,toolBinder:r}=this;Ie(e);let i=new Map;function a(p,m){for(let g of p.parents)g.label!==void 0?o(g.label,g):a(g,m);for(let[g,v]of p.bindings.entries()){let b=g.indexOf(":"),x=g.substring(b+1);m.set(x,v.action)}}function o(p,m){if(i.has(m))return;let g={label:p,entries:new Map};a(m,g.entries),i.set(m,g)}for(let[p,m]of t)o(p,m);let l=(p,m)=>{let g=document.createElement("h2");g.textContent=p,e.appendChild(g);for(let[v,b]of m){let x=document.createElement("div");x.className="dt",x.textContent=oq(v);let C=document.createElement("div");C.className="dd",C.textContent=b,e.appendChild(x),e.appendChild(C)}},c=new Map;for(let[p,m]of r.bindings){let g=c.get(m.layer);g===void 0&&(g=[],c.set(m.layer,g)),g.push([`shift+key${p.toLowerCase()}`,m.description])}let d=Array.from(c.entries());d.length>0&&(d[0][0].manager.root.layerManager.updateNonArchivedLayerIndices(),d.sort((p,m)=>p[0].managedLayer.nonArchivedLayerIndex-m[0].managedLayer.nonArchivedLayerIndex));for(let[p,m]of d)m.sort(),l(`Tool bindings for layer ${p.managedLayer.nonArchivedLayerIndex+1}: ${p.managedLayer.name}`,m);for(let p of i.values())l(p.label,p.entries)}};var c0=ot(Et());var jO=ot(Et());function lq(n,e){n.style.display="block";let{offsetWidth:t,offsetHeight:r}=n,i=document.documentElement.clientWidth,a=document.documentElement.clientHeight,o=document.documentElement.scrollLeft+Math.min(i-t,e.clientX),l=document.documentElement.scrollTop+Math.min(a-r,e.clientY);n.style.left=o+"px",n.style.top=l+"px"}var n0=class extends j{constructor(e){super();this.element=document.createElement("div");this.parentDisposers=new Map;this.disabledValue=!1;this.opened=new re;this.closed=new re;let{element:t}=this;t.className="neuroglancer-context-menu",t.style.display="none",t.tabIndex=-1,document.body.appendChild(t),e!==void 0&&this.registerParent(e)}get disabled(){return this.disabledValue}set disabled(e){this.disabledValue!==e&&(this.disabledValue=e,e&&this.hide())}get open(){return this.menuDisposer!==void 0}registerParent(e){let{parentDisposers:t}=this;t.has(e)||t.set(e,En(e,"contextmenu",r=>{this.show(r),r.stopPropagation(),r.preventDefault()}))}show(e){if(this.disabledValue)return;this.hide();let{element:t}=this,r=En(document,"mousedown",o=>{o.target instanceof Node&&!t.contains(o.target)&&this.hide()},!0),i=En(document,"keydown",o=>{o.code==="Escape"&&this.hide()},!0),a=()=>{i(),r(),t.style.display="none"};this.opened.dispatch(),lq(t,e),this.menuDisposer=a}unregisterParent(e){let{parentDisposers:t}=this,r=t.get(e);r!==void 0&&(r(),t.delete(e))}disposed(){let{parentDisposers:e}=this;for(let t of e.values())t();e.clear(),Ye(this.element)}hide(){this.menuDisposer!==void 0&&(this.menuDisposer(),this.menuDisposer=void 0,this.closed.dispatch())}};function cq(n){return lE(new TextEncoder().encode(n))}function uq(n){return new TextDecoder().decode(cE(n))}function dq(n,e){if(!!n.startsWith(e))try{let t=uq(n.substring(e.length));return JSON.parse(t)}catch{return}}function NO(n,e){return n+cq(JSON.stringify(e))}function BO(n,e){for(let t of n){let r=dq(t,e);if(r!==void 0)return{parameters:r,dragType:t}}}var UO;function Kp(n,e){return n.dataTransfer.dropEffect=e,UO=e,e}function Xp(){return UO}function FO(n){return n.draggable=!0,En(n,"dragstart",e=>{e.stopPropagation(),e.preventDefault()})}var GO="neuroglancer-layer\0",ki;function r0(n,e){var i;n.dataTransfer.setData(NO(GO,e.layers.map(a=>({name:a.name,visible:a.visible}))),JSON.stringify({layers:e.layers.map(a=>a.toJSON()),layout:e.layoutSpec})),ki!==void 0&&ki.disposer();let t,r=()=>{e.manager.unregisterDisposer(r);for(let a of e.layers)a.dispose();e.manager.dispose(),ki===t&&(ki=void 0)};ki=t={manager:e.manager.addRef(),layers:e.layers.map(a=>a.addRef()),layoutSpec:e.layoutSpec,isLayerListPanel:(i=e.isLayerListPanel)!=null?i:!1,disposer:r}}function yu(n="none"){if(ki!==void 0){if(n==="move"){let e=new Set(ki.layers);ki.manager.layerManager.filter(t=>!e.has(t))}ki.disposer()}}function Qp(n){return BO(n.dataTransfer.types,GO)}function WO(n){if(ki!==void 0&&ki.manager.rootLayers===n.rootLayers)return ki}var i0=class{initializeExternalLayers(e){let{dragType:t}=this;if(t!==void 0)try{let{layers:r,layout:i}=JSON.parse(e.dataTransfer.getData(t));if(!Array.isArray(r)||this.numSourceLayers!==r.length)throw new Error("Invalid layer drop data");this.layoutSpec=i;for(let[a,o]of this.layers)gR(a,r[o])}catch{return!1}return!0}updateArchiveStates(e){let{targetIsLayerListPanel:t}=this,r=e.dataTransfer.dropEffect;for(let i of this.layers.keys()){let a=t;t&&!i.archived&&r!=="copy"&&this.sourceIsLayerListPanel&&(a=!1),(i.archived!==a||a&&i.visible)&&(i.archived=a,a&&(i.visible=!1),i.layerChanged.dispatch())}}get method(){return this.sourceManager!==void 0?this.manager===this.sourceManager&&this.sourceIsLayerListPanel===this.targetIsLayerListPanel?"move":"link":"copy"}compatibleWithMethod(e){return this.method===e?!0:this.forceCopy&&e!=="copy"?!1:!this.moveSupported&&e==="move"}};function a0(n,e,t){let r;n.shiftKey?r="copy":n.ctrlKey&&t?r="move":r=e;let i="",a=o=>{i!==""&&(i+=", "),i+=o};return e!=="none"&&r!==e&&(n.shiftKey?a(`release SHIFT to ${e}`):a(`release CONTROL to ${e}`)),r!=="copy"&&a("hold SHIFT to copy"),r!=="move"&&t&&e!=="move"&&a("hold CONTROL to move"),{dropEffect:r,dropEffectMessage:i}}function zO(n,e,t,r){let i=WO(e),a=!1,o;return i===void 0?o="copy":r?(i.isLayerListPanel||(a=!0),o="link"):i.manager===e&&i.isLayerListPanel===t?(o="move",a=!0):t?o="none":(i.isLayerListPanel||(a=!0),o="link"),a0(n,o,a)}function HO(n,e,t,r){let i=zO(n,e,t,r);return Kp(n,i.dropEffect),i}function uy(n,e,t){let{forceCopy:r,newTarget:i,isLayerListPanel:a=!1}=t,o=WO(e);if(!r&&o!==void 0){let c=!i&&o.manager===e&&(o.isLayerListPanel===a||o.isLayerListPanel),d=new i0;return d.manager=e,d.numSourceLayers=o.layers.length,d.sourceManager=o.manager,d.targetIsLayerListPanel=a,d.sourceIsLayerListPanel=o.isLayerListPanel,d.moveSupported=c,d.layers=new Map,d.forceCopy=!1,d.layoutSpec=o.layoutSpec,c?o.layers.forEach((p,m)=>{d.layers.set(p,m)}):o.layers.forEach((p,m)=>{(i||!e.layerManager.has(p))&&d.layers.set(p.addRef(),m)}),d}let l=Qp(n);if(l!==void 0)try{let c=ge(l.parameters,(p,m)=>{let g=W(p,"name",Q),v=W(p,"visible",ya),b=new Dp(g,e);return a&&(v=!1),b.visible=v,b.archived=a,[b,m]}),d=new i0;return d.numSourceLayers=c.length,d.targetIsLayerListPanel=a,d.sourceIsLayerListPanel=!1,d.sourceManager=void 0,d.moveSupported=!1,d.forceCopy=o!==void 0,d.manager=e,d.dragType=l.dragType,d.layers=new Map(c),d}catch{}}function o0(n,e){return n.moveSupported?!1:(n.manager.layerManager.filter(t=>!n.layers.has(t)),e!==void 0&&n.layers.has(e))}function vu(n,e,t,r=!1){function i(a,o){let l=n.dropLayers,{dropEffect:c,dropEffectMessage:d}=o?zO(a,n.manager,r,!1):{dropEffect:Xp(),dropEffectMessage:""};if(c===void 0)return;Kp(a,c);let p=!0;if(!(l!==void 0&&!l.compatibleWithMethod(c)&&(n.dropLayers=void 0,o0(l,t)))){if(l===void 0){if(l=n.dropLayers=uy(a,n.manager,{forceCopy:c==="copy",newTarget:!1,isLayerListPanel:r}),l===void 0)return;p=l.method==="move"}if(t!==void 0&&l.layers.has(t))return{dropLayers:l,dropEffect:c,dropEffectMessage:d};if(p){let{layerManager:m}=n.manager,g=new Set,v=Number.POSITIVE_INFINITY,b=m.managedLayers=m.managedLayers.filter((C,T)=>l.layers.has(C)?(v===Number.POSITIVE_INFINITY&&(v=T),g.add(C),!1):!0),x;t!==void 0?(x=b.indexOf(t),v<=x&&++x):x=b.length;for(let C of l.layers.keys())g.has(C)||l.layers.delete(C);b.splice(x,0,...l.layers.keys()),m.layersChanged.dispatch()}else{let m;t!==void 0&&(m=n.manager.layerManager.managedLayers.indexOf(t));for(let g of l.layers.keys())n.manager.add(g,m)}return{dropLayers:l,dropEffect:c,dropEffectMessage:d}}}e.addEventListener("dragenter",a=>{i(a,!0)!==void 0?a.preventDefault():Xt(n.element,"drop")}),e.addEventListener("drop",a=>{var l;a.preventDefault(),n.dragEnterCount=0,Xt(n.element,"drop");let o=(l=i(a,!1))==null?void 0:l.dropLayers;if(n.dropLayers=void 0,o!==void 0){if(!o.initializeExternalLayers(a)){o0(o);return}o.updateArchiveStates(a),yu(o.method==="move"?void 0:a.dataTransfer.dropEffect)}}),e.addEventListener("dragover",a=>{let o=i(a,!0);if(o===void 0){Xt(n.element,"drop");return}let{dropLayers:l,dropEffect:c,dropEffectMessage:d}=o,p=l.layers.size,m="",g=l.numSourceLayers===1?"":"s",v=l.numSourceLayers;if(c==="none")m=`Cannot link dragged layer${g} here`;else{let b=v===p?`${v}`:`${p}/${v}`;m=`Drop to ${c} ${b} layer${g}`}d&&(m+=` (${d})`),Qn(n.element,"drop",m),a.preventDefault(),a.stopPropagation()})}function dy(n,e,t,r){e.draggable=!0,e.addEventListener("dragstart",i=>{Qn(e,"drag","Drag layer to another layer bar/panel (including in another Neuroglancer window), or to the left/top/right/bottom edge of a layer group"),r0(i,{manager:n.manager,layers:[t],layoutSpec:r.getLayoutSpec(),isLayerListPanel:r.isLayerListPanel}),i.stopPropagation()}),e.addEventListener("dragend",()=>{Xt(e,"drag"),yu()})}function py(n){n.element.addEventListener("dragenter",()=>{++n.dragEnterCount}),n.element.addEventListener("dragleave",()=>{if(--n.dragEnterCount!=0)return;Xt(n.element,"drop");let{dropLayers:e}=n;e!==void 0&&(o0(e),n.manager.layerManager.layersChanged.dispatch(),n.dropLayers=void 0)})}var $O=class extends j{constructor(e,t){super();this.layer=e;this.panel=t;this.element=document.createElement("div");this.layerNumberElement=document.createElement("div");this.labelElement=document.createElement("div");this.visibleProgress=document.createElement("div");this.prefetchProgress=document.createElement("div");this.labelElementText=document.createTextNode("");this.valueElement=document.createElement("div");this.maxLength=0;this.prevValueText="";let{element:r,labelElement:i,layerNumberElement:a,valueElement:o,visibleProgress:l,prefetchProgress:c,labelElementText:d}=this;r.className="neuroglancer-layer-item neuroglancer-noselect",r.appendChild(l),r.appendChild(c),i.className="neuroglancer-layer-item-label",i.appendChild(d),l.className="neuroglancer-layer-item-visible-progress",c.className="neuroglancer-layer-item-prefetch-progress",a.className="neuroglancer-layer-item-number",o.className="neuroglancer-layer-item-value";let p=document.createElement("div");p.className="neuroglancer-layer-item-value-container";let m=document.createElement("div");m.className="neuroglancer-layer-item-button-container";let g=jc();g.title="Remove layer from this layer group",g.addEventListener("click",x=>{this.panel.layerManager===this.panel.manager.rootLayers?this.layer.setArchived(!0):this.layer.containers.size>2?this.panel.layerManager.removeManagedLayer(this.layer):this.layer.setArchived(!0),x.stopPropagation()});let v=Li();v.title="Delete this layer",v.addEventListener("click",x=>{bo(this.layer),x.stopPropagation()}),r.appendChild(a),p.appendChild(o),p.appendChild(m),m.appendChild(g),m.appendChild(v),r.appendChild(i),r.appendChild(p);let b=this.registerDisposer(new ws(e.localPosition,e.localCoordinateSpaceCombiner,{copyButton:!1}));r.appendChild(b.element),b.element.addEventListener("click",x=>{x.stopPropagation()}),b.element.addEventListener("dblclick",x=>{x.stopPropagation()}),r.addEventListener("click",x=>{x.ctrlKey?t.selectedLayer.toggle(e):x.altKey?e.pickEnabled=!e.pickEnabled:e.setVisible(!e.visible)}),r.addEventListener("contextmenu",x=>{t.selectedLayer.layer=e,t.selectedLayer.visible=!0,x.stopPropagation(),x.preventDefault()}),dy(t,r,e,{getLayoutSpec:()=>t.getLayoutSpecForDrag()}),vu(this.panel,r,this.layer)}update(){let{layer:e,element:t}=this;this.labelElementText.textContent=e.name,t.dataset.visible=e.visible.toString(),t.dataset.selected=(e===this.panel.selectedLayer.layer).toString(),t.dataset.pick=e.pickEnabled.toString();let r=`Click to ${e.visible?"hide":"show"}, control+click to show side panel`;e.supportsPickOption&&(r+=`, alt+click to ${e.pickEnabled?"disable":"enable"} spatial object selection`),r+=", drag to move, shift+drag to copy",t.title=r}disposed(){this.element.remove(),super.disposed()}},s0=class extends j{constructor(e,t,r,i,a,o){super();this.display=e;this.manager=t;this.viewerNavigationState=r;this.selectedLayer=i;this.getLayoutSpecForDrag=a;this.showLayerHoverValues=o;this.layerWidgets=new Map;this.element=document.createElement("div");this.layerUpdateNeeded=!0;this.valueUpdateNeeded=!1;this.layerWidgetInsertionPoint=document.createElement("div");this.positionWidget=this.registerDisposer(new ws(this.viewerNavigationState.position.value,this.manager.root.coordinateSpaceCombiner));this.dragEnterCount=0;this.scheduleUpdate=this.registerCancellable(We(()=>this.update()));this.registerDisposer(i);let{element:l}=this;l.className="neuroglancer-layer-panel",this.registerDisposer(t.layerSelectedValues.changed.add(()=>{this.handleLayerValuesChanged()})),this.registerDisposer(t.layerManager.layersChanged.add(()=>{this.handleLayersChanged()})),this.registerDisposer(i.changed.add(()=>{this.handleLayersChanged()})),this.registerDisposer(o.changed.add(()=>{this.handleLayerItemValueChanged()})),this.element.dataset.showHoverValues=this.showLayerHoverValues.value.toString(),this.layerWidgetInsertionPoint.style.display="none",this.element.appendChild(this.layerWidgetInsertionPoint);let c=He({svg:_l,title:"Click to add layer, control+click/right click/\u2318+click to add local annotation layer."});c.classList.add("neuroglancer-layer-add-button");let d=this.dropZone=document.createElement("div");d.className="neuroglancer-layer-panel-drop-zone";let p=g=>{if(g.ctrlKey||g.metaKey||g.type==="contextmenu"){let v=aC(this.manager,"annotation",{type:"annotation",source:"local://annotations"});this.manager.add(v),this.selectedLayer.layer=v,this.selectedLayer.visible=!0}else this.addLayerMenu()};this.registerEventListener(c,"click",p),this.registerEventListener(c,"contextmenu",p),l.appendChild(c),l.appendChild(d),this.registerDisposer(FO(c)),l.appendChild(this.positionWidget.element);let m=()=>{let g=this.viewerNavigationState.position.link.value;this.positionWidget.element.style.display=g===Ht.LINKED?"none":""};this.registerDisposer(this.viewerNavigationState.position.link.changed.add(m)),m(),this.update(),this.updateChunkStatistics(),py(this),vu(this,d,void 0),this.registerDisposer(e.updateStarted.add(()=>this.updateLayers())),this.registerDisposer(t.chunkManager.layerChunkStatisticsUpdated.add(this.registerCancellable(We(()=>this.updateChunkStatistics()))))}get layerManager(){return this.manager.layerManager}disposed(){this.layerWidgets.forEach(e=>e.dispose()),this.layerWidgets=void 0,Ye(this.element),super.disposed()}handleLayersChanged(){this.layerUpdateNeeded=!0,this.handleLayerValuesChanged()}handleLayerValuesChanged(){this.valueUpdateNeeded||(this.valueUpdateNeeded=!0,this.scheduleUpdate())}handleLayerItemValueChanged(){this.element.dataset.showHoverValues=this.showLayerHoverValues.value.toString()}update(){if(this.valueUpdateNeeded=!1,this.updateLayers(),this.showLayerHoverValues.value===!1)return;let e=this.manager.layerSelectedValues;for(let[t,r]of this.layerWidgets){let i=t.layer,a="";if(i!==null){let o=e.get(i);if(o!==void 0){let{value:l}=o;l!==void 0&&(a=""+l)}}if(a!==r.prevValueText){if(r.prevValueText=a,a.length>r.maxLength){let o=r.maxLength=a.length;r.valueElement.style.width=`${o}ch`}r.valueElement.textContent=a}}}updateChunkStatistics(){for(let[e,t]of this.layerWidgets){let r=0,i=0,a=0,o=0,l=e.layer;if(l!==null)for(let{layerChunkProgressInfo:c}of l.renderLayers)r+=c.numVisibleChunksNeeded,i+=c.numVisibleChunksAvailable,a+=c.numPrefetchChunksNeeded,o+=c.numPrefetchChunksAvailable;t.visibleProgress.style.width=`${i/Math.max(1,r)*100}%`,t.prefetchProgress.style.width=`${o/Math.max(1,a)*100}%`}}updateLayers(){var i;if(!this.layerUpdateNeeded)return;this.layerUpdateNeeded=!1;let e=this.element,t=new Set,r=this.layerWidgetInsertionPoint.nextElementSibling;this.manager.rootLayers.updateNonArchivedLayerIndices();for(let a of this.manager.layerManager.managedLayers){if(a.archived&&!((i=this.dropLayers)==null?void 0:i.layers.has(a)))continue;t.add(a);let o=this.layerWidgets.get(a),l=a.nonArchivedLayerIndex;o===void 0&&(o=new $O(a,this),this.layerWidgets.set(a,o)),o.layerNumberElement.textContent=""+(1+l),o.update();let{element:c}=o;c!==r&&e.insertBefore(o.element,r),r=c.nextElementSibling}for(let[a,o]of this.layerWidgets)t.has(a)||(this.layerWidgets.delete(a),o.dispose())}addLayerMenu(){wg(this.manager,this.selectedLayer)}};function fy(n,e){let t=En(n,"drop",o=>{if(o.preventDefault(),o.dataTransfer.types.indexOf(Np)!==-1){o.stopPropagation();let l=Z(JSON.parse(o.dataTransfer.getData(Np))),c=W(l,"dimensions",Dd),d=W(l,"position",v=>ge(v,Qe));if(d.length!==c.length)throw new Error("length mismatch between position and dimensions");let p=d.length,{coordinateSpace:{value:{names:m}},value:g}=e;for(let v=0;v<p;++v){let b=m.indexOf(c[v]);b!==-1&&(g[b]=d[v])}e.changed.dispatch()}}),r=o=>{o.dataTransfer.types.indexOf(Np)!==-1&&(o.dataTransfer.dropEffect="link",o.preventDefault(),o.stopPropagation())},i=En(n,"dragenter",r),a=En(n,"dragover",r);return()=>{i(),a(),t()}}var hy="neuroglancer-layer-group-viewer";function l0(n){return n.dataTransfer.types.indexOf(hy)!==-1}var Fa;function pq(n){if(Fa&&Fa.viewer.layerSpecification.rootLayers===n.rootLayers)return Fa.viewer}function JO(n,e){let t=pq(e),r,i=!1;return t===void 0||t.layerSpecification===t.layerSpecification.root?r="copy":(i=!0,r="move"),a0(n,r,i)}var qO=class extends j{constructor(e){super();this.relativeDisplayScales=new Bx(e.navigationState.pose.relativeDisplayScales.addRef()),this.displayDimensions=new Ux(e.navigationState.pose.displayDimensions.addRef()),this.position=new Cp(e.navigationState.position.addRef()),this.crossSectionOrientation=new tu(e.navigationState.pose.orientation.addRef()),this.displayDimensionRenderInfo=this.registerDisposer(new wp(this.relativeDisplayScales.value,this.displayDimensions.value)),this.crossSectionScale=new nu(e.navigationState.zoomFactor.addRef(),this.displayDimensionRenderInfo.addRef()),this.crossSectionDepthRange=new pg(e.navigationState.depthRange.addRef(),this.displayDimensionRenderInfo),this.projectionDepthRange=new pg(e.perspectiveNavigationState.depthRange.addRef(),this.displayDimensionRenderInfo),this.navigationState=this.registerDisposer(new Ba(new Na(this.position.value,this.displayDimensionRenderInfo.addRef(),this.crossSectionOrientation.value),this.crossSectionScale.value,this.crossSectionDepthRange.value)),this.projectionOrientation=new tu(e.perspectiveNavigationState.pose.orientation.addRef()),this.projectionScale=new nu(e.perspectiveNavigationState.zoomFactor.addRef(),this.displayDimensionRenderInfo.addRef()),this.projectionNavigationState=this.registerDisposer(new Ba(new Na(this.position.value.addRef(),this.displayDimensionRenderInfo.addRef(),this.projectionOrientation.value),this.projectionScale.value,this.projectionDepthRange.value))}copyToParent(){for(let e of[this.relativeDisplayScales,this.displayDimensions,this.position,this.crossSectionOrientation,this.crossSectionScale,this.projectionOrientation,this.projectionScale])e.copyToPeer()}register(e){e.add("dimensionRenderScales",this.relativeDisplayScales),e.add("displayDimensions",this.displayDimensions),e.add("position",Rl(this.position)),e.add("crossSectionOrientation",this.crossSectionOrientation),e.add("crossSectionScale",this.crossSectionScale),e.add("crossSectionDepth",this.crossSectionDepthRange),e.add("projectionOrientation",this.projectionOrientation),e.add("projectionScale",this.projectionScale),e.add("projectionDepth",this.projectionDepthRange)}};function fq(n,e){let t=new n0(n),r=t.element;r.classList.add("neuroglancer-layer-group-viewer-context-menu");let i=document.createElement("button");i.textContent="Remove layer group",r.appendChild(i),t.registerEventListener(i,"click",()=>{e.layerSpecification.layerManager.clear()});let{viewerNavigationState:a}=e;for(let[o,l]of[["Render scale factors",a.relativeDisplayScales.link],["Render dimensions",a.displayDimensions.link],["Position",a.position.link],["Cross-section orientation",a.crossSectionOrientation.link],["Cross-section zoom",a.crossSectionScale.link],["Cross-section depth range",a.crossSectionDepthRange.link],["3-D projection orientation",a.projectionOrientation.link],["3-D projection zoom",a.projectionScale.link],["3-D projection depth range",a.projectionDepthRange.link]]){let c=t.registerDisposer(new Bp(l)),d=document.createElement("label");d.style.display="flex",d.style.flexDirection="row",d.style.whiteSpace="nowrap",d.textContent=o,d.appendChild(c.element),r.appendChild(d)}return t}var Su=class extends j{constructor(e,t,r={}){super();this.element=e;this.viewerState=t;this.state=new nr;this.options={showLayerPanel:new qe(!0),showViewerMenu:!1,showLayerHoverValues:new qe(!0),...r},this.layerSpecification=this.registerDisposer(t.layerSpecification),this.viewerNavigationState=this.registerDisposer(new qO(t)),this.viewerNavigationState.register(this.state),this.layerSpecification instanceof Pp?this.state.add("layers",this.layerSpecification):this.state.add("layers",{changed:this.layerSpecification.changed,toJSON:()=>this.layerSpecification.layerManager.managedLayers.map(i=>i.name),reset:()=>{throw new Error("not implemented")},restoreState:()=>{throw new Error("not implemented")}}),e.classList.add("neuroglancer-layer-group-viewer"),this.registerDisposer(new xo(e)),this.layout=this.registerDisposer(new Qw(this,"xy")),this.state.add("layout",this.layout),this.registerActionBindings(),this.registerDisposer(this.layerManager.useDirectly()),this.registerDisposer(fy(e,this.navigationState.position)),this.registerDisposer(this.options.showLayerPanel.changed.add(this.registerCancellable((0,jO.default)(()=>this.updateUI(),0)))),this.makeUI()}get perspectiveNavigationState(){return this.viewerNavigationState.projectionNavigationState}get navigationState(){return this.viewerNavigationState.navigationState}get selectionDetailsState(){return this.layerSpecification.root.selectionState}get display(){return this.viewerState.display}get selectedLayer(){return this.viewerState.selectedLayer}get layerManager(){return this.layerSpecification.layerManager}get chunkManager(){return this.layerSpecification.chunkManager}get mouseState(){return this.viewerState.mouseState}get showAxisLines(){return this.viewerState.showAxisLines}get wireFrame(){return this.viewerState.wireFrame}get showScaleBar(){return this.viewerState.showScaleBar}get showPerspectiveSliceViews(){return this.viewerState.showPerspectiveSliceViews}get inputEventBindings(){return this.viewerState.inputEventBindings}get visibility(){return this.viewerState.visibility}get visibleLayerRoles(){return this.viewerState.visibleLayerRoles}get crossSectionBackgroundColor(){return this.viewerState.crossSectionBackgroundColor}get perspectiveViewBackgroundColor(){return this.viewerState.perspectiveViewBackgroundColor}get scaleBarOptions(){return this.viewerState.scaleBarOptions}get changed(){return this.state.changed}bindAction(e,t){this.registerDisposer(ce(this.element,e,t))}registerActionBindings(){this.bindAction("add-layer",()=>{this.layerPanel&&this.layerPanel.addLayerMenu()}),this.bindAction("t-",()=>{this.navigationState.pose.translateNonDisplayDimension(0,-1)}),this.bindAction("t+",()=>{this.navigationState.pose.translateNonDisplayDimension(0,1)})}toJSON(){return{type:"viewer",...this.state.toJSON()}}reset(){this.state.reset()}restoreState(e){this.state.restoreState(e),ln(e,"crossSectionZoom",Rl(this.viewerNavigationState.crossSectionScale)),ln(e,"perspectiveZoom",Rl(this.viewerNavigationState.projectionScale)),ln(e,"perspectiveOrientation",this.viewerNavigationState.projectionOrientation)}makeUI(){this.element.style.flex="1",this.element.style.display="flex",this.element.style.flexDirection="column",this.element.appendChild(this.layout.element),this.updateUI()}updateUI(){let{options:e}=this,t=e.showLayerPanel.value;if(this.layerPanel!==void 0&&!t){this.layerPanel.dispose(),this.layerPanel=void 0;return}if(t&&this.layerPanel===void 0){let r=this.layerPanel=new s0(this.display,this.layerSpecification,this.viewerNavigationState,this.viewerState.selectedLayer.addRef(),()=>this.layout.toJSON(),this.options.showLayerHoverValues);if(e.showViewerMenu?(r.registerDisposer(fq(r.element,this)),r.element.title="Right click for options, drag to move/copy layer group."):r.element.title="Drag to move/copy layer group.",typeof NEUROGLANCER_SHOW_LAYER_BAR_EXTRA_BUTTONS!="undefined"&&NEUROGLANCER_SHOW_LAYER_BAR_EXTRA_BUTTONS===!0){{let a=document.createElement("button");a.textContent="Clear segments",a.title='De-select all objects ("x")',a.addEventListener("click",o=>{hb(o,o,{action:"clear-segments"})}),r.element.appendChild(a)}for(let a of["3d","xy","xz","yz"]){let o=document.createElement("button");o.textContent=a,o.title=`Switch to ${a} layout`,o.addEventListener("click",()=>{let l;this.layout.name===a?a!=="3d"?l=`${a}-3d`:l="4panel":l=a,this.layout.name=l}),r.element.appendChild(o)}}r.element.draggable=!0;let i=r.element;i.addEventListener("dragstart",a=>{Qn(r.element,"drag","Drag layer group to the left/top/right/bottom edge of a layer group, or to another layer bar/panel (including in another Neuroglancer window)"),r0(a,{manager:this.layerSpecification,layers:this.layerManager.managedLayers,layoutSpec:this.layout.toJSON()});let o=()=>{Fa&&Fa.viewer===this&&(Fa=void 0),this.unregisterDisposer(o)};Fa={viewer:this,disposer:o},this.registerDisposer(o);let l=this.toJSON();delete l.layers,a.dataTransfer.setData(hy,JSON.stringify(l)),r.element.style.backgroundColor="black",setTimeout(()=>{r.element.style.backgroundColor=""},0)}),r.element.addEventListener("dragend",()=>{Xt(i,"drag"),yu(),Fa!==void 0&&Fa.viewer===this&&Fa.disposer()}),this.element.insertBefore(i,this.element.firstChild)}}disposed(){Ie(this.element);let{layerPanel:e}=this;e!==void 0&&(e.dispose(),this.layerPanel=void 0),super.disposed()}};var YO=Symbol("layoutComponentContainer"),Hl=class extends j{constructor(e,t,r){super();this.viewer=e;this.parent=r;this.changed=new re;this.flex=new Le(1,it);this.element=document.createElement("div");let{element:i}=this;i.style.display="flex",i.style.flex="1",i.style.position="relative",i.style.alignItems="stretch",i[YO]=this,this.flex.changed.add(()=>{i.style.flexGrow=""+this.flex.value,this.changed.dispatch()}),this.setSpecification(t);let a=[],o=c=>{let d=document.createElement("div");d.className="neuroglancer-layout-split-drop-zone";let p;switch(d.style[c]="0",c){case"left":case"right":p="row",d.style.width="10px",d.style.height="100%";break;case"top":case"bottom":p="column",d.style.height="10px",d.style.width="100%";break}d.style.display="none",a.push({element:d,direction:p,orientation:c}),i.appendChild(d),XO(d,this.viewer.layerSpecification,()=>this.split(c).newContainer.component,p==="row"?"column":"row")};o("left"),o("right"),o("top"),o("bottom");let l=!1;i.addEventListener("dragenter",c=>{if(!l&&Qp(c)!==void 0){l=!0;for(let{element:d,direction:p,orientation:m}of a){if(r!==void 0&&p===r.direction&&((m==="left"||m==="top")&&r.get(0)!==this||(m==="bottom"||m==="right")&&r.get(r.length-1)!==this))continue;let{component:g}=this;g instanceof Zp&&g.direction===p||(d.style.display="block")}}},!0),i.addEventListener("drop",c=>{if(!!l){l=!1;for(let{element:d}of a)d.style.display="none"}},!0),i.addEventListener("dragleave",c=>{let{relatedTarget:d}=c;if(!!l&&!(d instanceof HTMLElement&&this.element.contains(d))){l=!1;for(let{element:p}of a)p.style.display="none"}},!0)}unsetComponent(){let e=this.componentValue;e!==void 0&&(e.changed.remove(this.changed.dispatch),this.element.removeChild(e.element),e.dispose())}get component(){return this.componentValue}setComponent(e){if(this.unsetComponent(),this.componentValue=e,e.changed.add(this.changed.dispatch),this.element.appendChild(e.element),e instanceof Su){let{layerManager:t}=e,r=e.registerCancellable((0,c0.default)(()=>{t.managedLayers.length===0&&this.dispose()},0));e.registerDisposer(t.layersChanged.add(()=>{t.managedLayers.length===0&&r()})),r()}else if(e instanceof Zp){let t=e.registerCancellable((0,c0.default)(()=>{let{length:r}=e;if(r===0&&this.parent!==void 0)this.dispose();else if(r===1){let i=e.get(0).component,a;if(this.parent===void 0&&i instanceof Su){a=i.layout.specification.toJSON(),i.viewerNavigationState.copyToParent();let o=i.layerManager.managedLayers,l=new Set(o),{layerSpecification:c}=i;c.rootLayers.filter(m=>l.has(m)||m.archived);let d=[],{managedLayers:p}=c.rootLayers;for(let m=0,g=p.length;m<g;++m)l.has(p[m])&&d.push(m);for(let m=0,g=o.length;m<g;++m)p[d[m]]=o[m];c.rootLayers.layersChanged.dispatch()}else a=i.toJSON();this.setSpecification(a)}},0));e.registerDisposer(e.changed.add(()=>{e.length<2&&t()})),t()}this.changed.dispatch()}toJSON(){let e=this.component.toJSON();return this.parent instanceof Zp&&(e.flex=this.flex.toJSON()),e}setSpecification(e){this.setComponent(hq(this,e)),this.flex.value=oe(e,"flex",it,1)}static getFromElement(e){return e[YO]}disposed(){this.unsetComponent(),this.componentValue=void 0,super.disposed()}split(e){let t={type:"viewer"},{parent:r}=this;if(r!==void 0){if(e==="left"&&r.direction==="row"||e==="top"&&r.direction==="column")return{newContainer:r.insertChild(t,this),existingContainer:this};if(e==="right"&&r.direction==="row"||e==="bottom"&&r.direction==="column")return{newContainer:r.insertChild(t),existingContainer:this}}let i,a=this.component;a instanceof my?i=a.layerGroupViewer.toJSON():i=a.toJSON();let o,l,c=e==="left"||e==="right"?"row":"column";switch(e){case"left":case"top":o={type:c,children:[t,i]},l=0;break;case"right":case"bottom":o={type:c,children:[i,t]},l=1;break}this.setSpecification(o);let d=this.component;return{newContainer:d.get(l),existingContainer:d.get(1-l)}}};function KO(n){return{mouseState:n.mouseState,showAxisLines:n.showAxisLines,wireFrame:n.wireFrame,showScaleBar:n.showScaleBar,scaleBarOptions:n.scaleBarOptions,showPerspectiveSliceViews:n.showPerspectiveSliceViews,inputEventBindings:n.inputEventBindings,visibility:n.visibility,selectedLayer:n.selectedLayer,visibleLayerRoles:n.visibleLayerRoles,navigationState:n.navigationState.addRef(),perspectiveNavigationState:n.perspectiveNavigationState.addRef(),crossSectionBackgroundColor:n.crossSectionBackgroundColor,perspectiveViewBackgroundColor:n.perspectiveViewBackgroundColor}}var my=class extends j{constructor(e,t,r){super();this.element=e;this.layerGroupViewer=this.registerDisposer(new Su(e,{display:r.display,layerSpecification:r.layerSpecification.addRef(),...KO(r)},{showLayerPanel:r.uiControlVisibility.showLayerPanel,showViewerMenu:!1,showLayerHoverValues:r.uiControlVisibility.showLayerHoverValues})),this.layerGroupViewer.layout.restoreState(t)}toJSON(){return this.layerGroupViewer.layout.specification.toJSON()}get changed(){return this.layerGroupViewer.layout.changed}};function XO(n,e,t,r){n.addEventListener("dragenter",i=>{Qp(i)!==void 0&&n.classList.add("neuroglancer-drag-over")}),n.addEventListener("dragleave",()=>{Xt(n,"drop"),n.classList.remove("neuroglancer-drag-over")}),n.addEventListener("dragover",i=>{let a=(o,l)=>{o.dropEffectMessage&&(l+=` (${o.dropEffectMessage})`),Qn(n,"drop",l),i.stopPropagation(),i.preventDefault()};if(l0(i)){let o=JO(i,e);Kp(i,o.dropEffect),a(o,`Drop to ${o.dropEffect} layer group as new ${r}`);return}if(Qp(i)!==void 0){let o=HO(i,e,!1,!0);a(o,`Drop to ${o.dropEffect} layer as new ${r}`);return}}),n.addEventListener("drop",i=>{n.classList.remove("neuroglancer-drag-over"),Xt(n,"drop");let a,o;if(l0(i)){i.stopPropagation();try{o=JSON.parse(i.dataTransfer.getData(hy))}catch(d){return}if(a=uy(i,e,{forceCopy:!1,newTarget:!0}),a===void 0)return}else{if(a=uy(i,e,{forceCopy:Xp()==="copy",newTarget:!0}),a===void 0)return;o=a.layoutSpec}if(!a.initializeExternalLayers(i)){if(!a.moveSupported)for(let d of a.layers.keys())d.dispose();return}i.preventDefault();let l=i.dataTransfer.dropEffect=Xp();yu(l);let c=t();a.updateArchiveStates(i);for(let d of a.layers.keys())c.layerSpecification.add(d);try{c.restoreState(o)}catch{c.layout.reset()}})}var Zp=class extends j{constructor(e,t,r,i){super();this.element=e;this.direction=t;this.container=i;this.changed=new re;e.classList.add("neuroglancer-stack-layout"),e.classList.add(`neuroglancer-stack-layout-${t}`),e.style.display="flex",e.style.flexDirection=t,e.appendChild(this.makeDropPlaceholder(this));for(let a of r)this.insertChild(a)}get length(){return(this.element.childElementCount-1)/2}makeDropPlaceholder(e){let t=document.createElement("div");return t.className="neuroglancer-stack-layout-drop-placeholder",XO(t,this.viewer.layerSpecification,()=>{let r=t.nextElementSibling,i;return r!==null&&(i=Hl.getFromElement(r)),this.insertChild({type:"viewer",layers:[]},i).component},this.direction==="row"?"column":"row"),e.registerDisposer(()=>{Ye(t)}),t.addEventListener("pointerdown",r=>{if("button"in r&&r.button!==0)return;let i=t.nextElementSibling;if(i===null)return;let a=Hl.getFromElement(i),o=t.previousElementSibling;if(o===null)return;let l=Hl.getFromElement(o);r.preventDefault();let c=()=>{Qn(t,"drag",`Drag to resize, current ${os[this.direction]} ratio is ${l.flex.value} : ${a.flex.value}`)};c(),sn(r,d=>{let p=l.element.getBoundingClientRect(),m=a.element.getBoundingClientRect(),g=Math.max(.1,Math.min(.9,this.direction==="column"?(d.clientY-p.top)/(m.bottom-p.top):(d.clientX-p.left)/(m.right-p.left))),v=Number(l.flex.value)+Number(a.flex.value);l.flex.value=Math.round(g*v*100)/100,a.flex.value=Math.round((1-g)*v*100)/100,c()},()=>{Xt(t,"drag")})}),t}get viewer(){return this.container.viewer}get(e){return Hl.getFromElement(this.element.children[e*2+1])}insertChild(e,t){let r=new Hl(this.viewer,e,this),i=this.makeDropPlaceholder(r);r.element.classList.add("neuroglancer-stack-layout-child"),r.registerDisposer(r.changed.add(this.changed.dispatch)),r.registerDisposer(()=>{this.element.removeChild(r.element),this.changed.dispatch()});let a=t!==void 0?t.element:null;return this.element.insertBefore(r.element,a),this.element.insertBefore(i,a),this.changed.dispatch(),r}disposed(){this.clear(),super.disposed()}clear(){for(;this.length!==0;)this.get(0).dispose()}*[Symbol.iterator](){let{length:e}=this;for(let t=0;t<e;++t)yield this.get(t)}toJSON(){return{type:this.direction,children:Array.from(this).map(e=>e.toJSON())}}};function hq(n,e){let t=document.createElement("div");if(t.style.flex="1",t.style.width="0px",typeof e=="string"){if(n.parent!==void 0)throw new Error(`Invalid layout component specification: ${JSON.stringify(e)}`);return new my(t,e,n.viewer)}Z(e);let r=W(e,"type",Q);switch(r){case"row":case"column":return new Zp(t,r,W(e,"children",i=>{let a=ge(i,o=>o);if(n.parent===void 0&&a.length===0)throw new Error("Stack layout requires at least one child.");return a}),n);case"viewer":{let i=n.viewer,a=new Pp(i.layerSpecification.addRef()),o=new Su(t,{display:i.display,layerSpecification:a,...KO(i)},{showLayerPanel:i.uiControlVisibility.showLayerPanel,showViewerMenu:!0,showLayerHoverValues:i.uiControlVisibility.showLayerHoverValues});try{o.restoreState(e)}catch(l){throw o.dispose(),l}return o}default:return new my(t,e,n.viewer)}}var u0=class extends j{constructor(e,t){super();this.viewer=e;this.defaultSpecification=t;this.container=this.registerDisposer(new Hl(this.viewer,this.defaultSpecification,void 0))}get changed(){return this.container.changed}get element(){return this.container.element}reset(){this.container.setSpecification(this.defaultSpecification)}restoreState(e){this.container.setSpecification(e)}disposed(){super.disposed()}toJSON(){return this.container.toJSON()}};var QO='<svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-labelledby="eyeCrossedIconTitle"><path d="M22 12C22 12 19 18 12 18C5 18 2 12 2 12C2 12 5 6 12 6C19 6 22 12 22 12Z"></path><circle cx="12" cy="12" r="3"></circle><path d="M3 21L20 4"></path></svg>';var ZO='<svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-labelledby="eyeIconTitle"><path d="M22 12C22 12 19 18 12 18C5 18 2 12 2 12C2 12 5 6 12 6C19 6 22 12 22 12Z"></path><circle cx="12" cy="12" r="3"></circle></svg>';var eN='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="cursorIconTitle"><polygon points="7 20 7 4 19 16 12 16 7 21"></polygon></svg>';var mq=Me.fromObject({escape:{action:"cancel"}}),gy=class extends j{constructor(e){super();this.layer=e;this.element=document.createElement("input");let{element:t}=this;t.classList.add("neuroglancer-layer-side-panel-name"),t.spellcheck=!1,t.autocomplete="off";let r=this.registerDisposer(new $t(t,mq));r.allShortcutsAreGlobal=!0,ce(t,"cancel",i=>{this.updateView(),t.blur(),i.stopPropagation(),i.preventDefault()}),t.title="Rename layer",this.registerDisposer(e.layerChanged.add(()=>this.updateView())),t.addEventListener("change",()=>this.updateModel()),t.addEventListener("blur",()=>this.updateModel()),this.updateView()}updateView(){this.element.value=this.layer.name}updateModel(){mg(this.layer,this.element.value)}},tN=class extends j{constructor(e){super();this.layer=e;this.element=document.createElement("select");this.measureElement=document.createElement("div");let{element:t,measureElement:r}=this;t.classList.add("neuroglancer-layer-side-panel-type"),r.classList.add("neuroglancer-layer-side-panel-type-measure"),t.title="Change layer type",document.body.appendChild(r);for(let[i,a]of Ip){if(a.type!==i)continue;let o=document.createElement("option");o.textContent=a.typeAbbreviation,o.value=i,t.appendChild(o)}t.addEventListener("change",()=>{let i=t.value,a=Ip.get(i);Ep(this.layer.managedLayer,a)}),this.updateView()}updateView(){let e=this.layer.type,{element:t,measureElement:r}=this;r.textContent=this.layer.constructor.typeAbbreviation,t.value=e,t.style.width=`${r.offsetWidth}px`}disposed(){this.measureElement.remove()}},ef=class extends Fr{constructor(e,t){super(e,t.location);this.panelState=t;let r=this.layer=t.layer,{element:i}=this,{titleBar:a}=this.addTitleBar({});a.classList.add("neuroglancer-layer-side-panel-title"),a.appendChild(this.registerDisposer(new tN(r)).element),a.appendChild(this.registerDisposer(new gy(r.managedLayer)).element),this.registerDisposer(_r(c=>{i.dataset.neuroglancerLayerVisible=c.toString()},{get value(){return r.managedLayer.visible},changed:r.managedLayer.layerChanged}));let o=this.registerDisposer(new er({get value(){return r.managedLayer.pickEnabled},set value(c){r.managedLayer.pickEnabled=c},changed:r.managedLayer.layerChanged},{svg:eN,enableTitle:"Spatial object selection: disabled",disableTitle:"Spatial object selection: enabled"}));this.registerDisposer(new Xn({get value(){return r.managedLayer.supportsPickOption},changed:r.managedLayer.layerChanged},o.element)),a.appendChild(o.element);let l={get value(){return t!==r.panels.panels[0]},set value(c){c?t.pin():t.unpin()},changed:r.manager.root.layerManager.layersChanged};a.appendChild(this.registerDisposer(new er(l,{text:"\u{1F4CC}\uFE0E",enableTitle:"Pin panel to this layer",disableTitle:"Unpin panel to this layer"})).element),this.registerDisposer(_r(c=>{i.dataset.neuroglancerLayerPanelPinned=c.toString()},l)),a.appendChild(Li({title:"Delete layer",onClick:()=>{bo(this.layer.managedLayer)}})),this.tabView=new HS({makeTab:c=>r.tabs.options.get(c).getter(),selectedTab:t.selectedTab,tabs:this.registerDisposer(new Uf({get value(){return t.tabs.map(c=>{let{label:d,hidden:p}=r.tabs.options.get(c);return{id:c,label:d,hidden:(p==null?void 0:p.value)||!1}})},changed:t.tabsChanged})),handleTabElement:(c,d)=>{d.draggable=!0,d.addEventListener("dragstart",p=>{p.stopPropagation(),p.dataTransfer.setData("neuroglancer-side-panel","");let m="Drag tab to dock as new panel to the left/right/top/bottom of another panel";t.panels.panels.find(v=>v!==t&&v.location.visible)&&(m+=`, or move tab to other ${JSON.stringify(r.managedLayer.name)} panel`),Qn(d,"drag",m),this.sidePanelManager.startDrag({dropAsNewPanel:v=>{this.panelState.splitOffTab(c,{...Kx,...v})},canDropAsTabs:v=>v instanceof ef&&v.layer===this.layer&&v!==this?1:0,dropAsTab:v=>{this.panelState.moveTabTo(c,v.panelState)}},p)}),d.addEventListener("dragend",p=>{Xt(d,"drag"),this.sidePanelManager.endDrag()})}},this.visibility),this.tabView.element.style.flex="1",this.tabView.element.classList.add("neuroglancer-layer-side-panel-tab-view"),this.tabView.element.style.position="relative",this.tabView.element.appendChild(this.makeTabDropZone()),this.addBody(this.tabView.element),this.registerDisposer(t.tabsChanged.add(()=>{t.tabs.length===0&&(this.location.visible=!1)}))}makeDragSource(){return{...super.makeDragSource(),canDropAsTabs:e=>e instanceof ef&&e.layer===this.layer&&e!==this?this.panelState.tabs.length:0,dropAsTab:e=>{this.panelState.mergeInto(e.panelState)}}}makeTabDropZone(){let e=document.createElement("div");return e.className="neuroglancer-side-panel-drop-zone",e.style.position="absolute",e.style.left="20px",e.style.right="20px",e.style.bottom="20px",e.style.top="20px",e.addEventListener("dragenter",t=>{var a;let{dragSource:r}=this.sidePanelManager,i=(a=r==null?void 0:r.canDropAsTabs)==null?void 0:a.call(r,this);!i||(e.classList.add(bl),Qn(e,"drop",`Move ${i} ${i===1?"tab":"tabs"} to this panel`),t.preventDefault())}),e.addEventListener("dragleave",()=>{Xt(e,"drop"),e.classList.remove(bl)}),e.addEventListener("dragover",t=>{var i;let{dragSource:r}=this.sidePanelManager;!((i=r==null?void 0:r.canDropAsTabs)==null?void 0:i.call(r,this))||t.preventDefault()}),e.addEventListener("drop",t=>{var i;Xt(e,"drop");let{dragSource:r}=this.sidePanelManager;!((i=r==null?void 0:r.canDropAsTabs)==null?void 0:i.call(r,this))||(e.classList.remove(bl),r.dropAsTab(this),t.preventDefault(),t.stopPropagation())}),e}},d0=class extends j{constructor(e,t){super();this.sidePanelManager=e;this.selectedLayerState=t;this.layerSidePanels=new Map;this.generation=0;this.layersNeedUpdate=!0;let r=()=>{this.layersNeedUpdate=!0,this.sidePanelManager.display.scheduleRedraw()};this.registerDisposer(t.changed.add(r)),this.registerDisposer(t.layerManager.layersChanged.add(r)),this.registerDisposer(e.beforeRender.add(()=>this.update()))}getSelectedUserLayer(){var e,t;return(t=(e=this.selectedLayerState.layer)==null?void 0:e.layer)!=null?t:void 0}update(){var a;if(!this.layersNeedUpdate)return;let{layerManager:e}=this.selectedLayerState,t=++this.generation;this.layersNeedUpdate=!1;let{layerSidePanels:r}=this,i=o=>{let l=r.get(o);l===void 0?(l={generation:t,unregister:this.sidePanelManager.registerPanel({location:o.location,makePanel:()=>new ef(this.sidePanelManager,o)})},r.set(o,l)):l.generation=t};{let o=this.getSelectedUserLayer(),{location:l}=this.selectedLayerState;if(o===void 0||!l.visible)this.placeholderSelectedLayerPanel===void 0&&(this.placeholderSelectedLayerPanel=this.sidePanelManager.registerPanel({location:l,makePanel:()=>new Fr(this.sidePanelManager,l)}));else{(a=this.placeholderSelectedLayerPanel)==null||a.call(this),this.placeholderSelectedLayerPanel=void 0;let c=o.panels.panels[0];c.location.value=l.value,i(c)}}for(let o of e.managedLayers){let l=o.layer;if(l===null)continue;let{panels:c}=l.panels;for(let d=1,p=c.length;d<p;++d)i(c[d])}for(let[o,l]of r)l.generation!==t&&(l.unregister(),r.delete(o))}disposed(){var e;(e=this.placeholderSelectedLayerPanel)==null||e.call(this);for(let{unregister:t}of this.layerSidePanels.values())t()}};var gq={...vi,side:"left",row:0},p0=class{constructor(){this.location=new Zn(gq)}get changed(){return this.location.changed}restoreState(e){e!==void 0&&this.location.restoreState(e)}reset(){this.location.reset()}toJSON(){return Ri(this.location.toJSON())}},nN=class extends j{constructor(e){super();this.layer=e;this.element=document.createElement("div");let{element:t}=this,r=He({svg:ZO,title:"Hide layer",onClick:()=>{this.layer.setVisible(!1)}}),i=He({svg:QO,title:"Show layer",onClick:()=>{this.layer.setVisible(!0)}});t.appendChild(i),t.appendChild(r);let a=()=>{let o=this.layer.visible;r.style.display=o?"":"none",i.style.display=o?"none":""};a(),this.registerDisposer(e.layerChanged.add(a))}};function yq(n){let{selectedLayer:e}=n.manager.root,t=new er({get value(){return e.layer===n&&e.visible},set value(r){r?(e.layer=n,e.visible=!0):e.visible=!1},changed:e.changed},{backgroundScheme:"dark",enableTitle:"Show layer side panel",disableTitle:"Hide layer side panel",svg:oy});return t.element.classList.add("neuroglancer-layer-list-panel-item-controls"),t}var rN=class extends j{constructor(e,t){super();this.panel=e;this.layer=t;this.element=document.createElement("div");this.numberElement=document.createElement("div");this.generation=-1;let{element:r,numberElement:i}=this;r.classList.add("neuroglancer-layer-list-panel-item"),i.classList.add("neuroglancer-layer-list-panel-item-number"),r.appendChild(this.registerDisposer(new Fn({get value(){return!t.archived},set value(o){t.setArchived(!o)},changed:t.layerChanged},{enableTitle:"Archive layer (disable and remove from layer groups)",disableTitle:"Unarchive layer (enable and add to all layer groups)"})).element),r.appendChild(i),r.appendChild(this.registerDisposer(new nN(t)).element),r.appendChild(this.registerDisposer(new gy(t)).element),r.appendChild(this.registerDisposer(yq(t)).element);let a=Li({title:"Delete layer",onClick:()=>{bo(this.layer)}});a.classList.add("neuroglancer-layer-list-panel-item-delete"),r.appendChild(a),dy(e,r,t,{isLayerListPanel:!0,getLayoutSpec:()=>{}}),vu(e,r,t,!0),r.addEventListener("click",o=>{o.ctrlKey?(e.selectedLayer.toggle(t),o.preventDefault()):o.altKey&&(t.pickEnabled=!t.pickEnabled,o.preventDefault())}),r.addEventListener("contextmenu",o=>{e.selectedLayer.toggle(t),o.stopPropagation(),o.preventDefault()})}},f0=class extends Fr{constructor(e,t,r){super(e,r.location);this.manager=t;this.state=r;this.items=new Map;this.itemContainer=document.createElement("div");this.layerDropZone=document.createElement("div");this.dragEnterCount=0;this.generation=-1;let{itemContainer:i,layerDropZone:a}=this,{titleElement:o}=this.addTitleBar({title:""});this.titleElement=o,i.classList.add("neuroglancer-layer-list-panel-items"),this.addBody(i),a.style.flex="1";let l=this.registerCancellable(We(()=>this.render()));this.visibility.changed.add(l),this.registerDisposer(this.layerManager.layersChanged.add(l)),this.registerDisposer(this.selectedLayer.changed.add(l)),py(this),vu(this,a,void 0,!0),this.render()}get layerManager(){return this.manager.layerManager}get selectedLayer(){return this.manager.selectedLayer}render(){let e=this,t=this.selectedLayer.layer,r=++this.generation,i=0,a=0,o=0;this.layerManager.updateNonArchivedLayerIndices();function*l(){let{items:d}=e,p=0;for(let g of e.layerManager.managedLayers)g.archived||++p;let m=`${(p+1).toString().length}ch`;for(let g of e.layerManager.managedLayers){g.visible?++i:g.archived?++o:++a;let v=d.get(g);v===void 0&&(v=e.registerDisposer(new rN(e,g)),d.set(g,v)),v.generation=r;let{nonArchivedLayerIndex:b}=g;v.numberElement.style.width=m,b===-1?v.numberElement.style.visibility="hidden":(v.numberElement.style.visibility="",v.numberElement.textContent=`${b+1}`),v.element.dataset.selected=(g===t).toString(),v.element.dataset.archived=g.archived.toString(),yield v.element}for(let[g,v]of d)r!==v.generation&&(d.delete(g),e.unregisterDisposer(v),v.dispose());yield e.layerDropZone}Wn(this.itemContainer,l());let c="Layers";if(i||a||o){c+=" (";let d="";i+a&&(c+=`${i}/${a+i} visible`,d=", "),o&&(c+=`${d}${o} archived`),c+=")"}this.titleElement.textContent=c}},h0=class extends j{constructor(e){super();this.layerManager=e;this.element=document.createElement("div");let t=this.registerCancellable(We(()=>this.render()));this.registerDisposer(e.layersChanged.add(t)),this.render()}render(){let e=0,{managedLayers:t}=this.layerManager;for(let i of t)i.archived&&++e;let{element:r}=this;if(e!==0){let i=t.length;r.textContent=`${i-e}/${i}`}else r.textContent=""}};var cNe=ot(oN()),uNe=ot(m0()),dNe=ot(dN()),pNe=ot(hN());var g0=ot(Cs()),mN=ot(Et());var vq=100,y0=class extends Zi{constructor(e){super();this.viewer=e;this.parsedValue=null;this.debouncedValueUpdater=(0,mN.default)(()=>{let e=this.textEditor.getValue();try{let t=JSON.parse(e);this.parsedValue=t,this.applyButton.disabled=!1,this.textEditor.setOption("lint",void 0)}catch(t){this.parsedValue=null,this.applyButton.disabled=!0;let r=0,i=0,a="Unknown parse error";if(t instanceof Error){let o=t.message.match(/^((?:.|\n)*) in JSON at position ([0-9]+)$/);if(o!==null){a=o[1];let l=parseInt(o[2],10),d=e.substring(0,l).split(`
`);r=d.length-1,i=d[d.length-1].length}else a=t.message}this.textEditor.setOption("lint",{getAnnotations:()=>[{message:a,severity:"error",from:g0.default.Pos(r,i)}]})}},vq);this.content.classList.add("neuroglancer-state-editor");let t=this.applyButton=document.createElement("button");t.textContent="Apply changes",this.content.appendChild(t),t.addEventListener("click",()=>this.applyChanges()),t.disabled=!0;let r=this.closeButton=document.createElement("button");r.classList.add("close-button"),r.textContent="Close",this.content.appendChild(r),r.addEventListener("click",()=>this.dispose());let i=this.downloadButton=document.createElement("button");i.textContent="Download",i.title="Download state as a JSON file",this.content.appendChild(i),i.addEventListener("click",()=>this.downloadState()),this.textEditor=(0,g0.default)(a=>{},{value:"",mode:{name:"javascript",json:!0},foldGutter:!0,gutters:["CodeMirror-lint-markers","CodeMirror-foldgutter"]}),this.updateView(),this.textEditor.on("change",()=>{this.debouncedValueUpdater()}),this.content.appendChild(this.textEditor.getWrapperElement()),this.textEditor.refresh()}downloadState(){let e=document.createElement("a"),t=new Blob([this.getJson()],{type:"text/json"}),r=URL.createObjectURL(t);e.href=r,e.download="state.json",e.click(),document.body.removeChild(e)}applyChanges(){this.parsedValue!==null&&(this.viewer.state.reset(),this.viewer.state.restoreState(this.parsedValue)),this.applyButton.disabled=!0}updateView(){this.textEditor.setValue(this.getJson()),this.textEditor.execCommand("foldAll"),this.textEditor.execCommand("unfold")}getJson(){return JSON.stringify(Tl(this.viewer.state).value,null,"  ")}};var gN=ot(Et());var Sq={side:"bottom",size:100,minSize:50,row:0,col:0,flex:1,visible:!1},v0=class{constructor(){this.location=new Zn(Sq)}get changed(){return this.location.changed}restoreState(e){this.location.restoreState(e)}reset(){this.location.reset()}toJSON(){return Ri(this.location.toJSON())}};function bq(n){let e=new Map;function t(r,i){if(typeof r!="object"){e.set(i,""+r);return}for(let a of Object.keys(r))t(r[a],i+"."+a)}return t(n,""),e}function xq(n){let e=new Set;e.add(".type");let t=new Set;function r(i,a){for(let o of e)if(n[i].get(o)!==n[a].get(o))return!0;return!1}for(let i=0,a=n.length;i<a;++i){for(let l of n[i].keys())t.add(l);let o=[];for(let l=0;l<i;++l)r(i,l)||o.push(l);for(;o.length>0;){let l=o,c;for(let d of t){if(e.has(d))continue;let p=[];for(let m of o)n[m].get(d)===n[i].get(d)&&p.push(m);if(p.length<l.length&&(l=p,c=d),p.length===0)break}if(c===void 0)break;o=l,e.add(c)}}return Array.from(e)}function Cq(n,e){let t={};for(let r of e){let i=n.get(r);if(i!==void 0){if(r==="")return i;t[r]=i}}return JSON.stringify(t)}function wq(n){return Object.assign({type:n.RPC_TYPE_ID},n.key||{})}function Tq(n){let e=n.map(bq),t=xq(e);return e.map(r=>Cq(r,t))}var Lq=1e3,S0=[{label:"Visible chunks/T",key:"visibleChunksTotal",getter:n=>{let e=0;for(let t=0;t<Uh;++t)e+=n[ts(t,wa.VISIBLE)*La+Ta.numChunks];return e}},{label:"Visible chunks/D",key:"visibleChunksDownloading",getter:n=>n[ts(Ze.DOWNLOADING,wa.VISIBLE)*La+Ta.numChunks]},{label:"Visible chunks/M",key:"visibleChunksSystemMemory",getter:n=>n[ts(Ze.SYSTEM_MEMORY,wa.VISIBLE)*La+Ta.numChunks]+n[ts(Ze.SYSTEM_MEMORY_WORKER,wa.VISIBLE)*La+Ta.numChunks]},{label:"Visible chunks/G",key:"visibleChunksGpuMemory",getter:n=>n[ts(Ze.GPU_MEMORY,wa.VISIBLE)*La+Ta.numChunks]},{label:"Visible chunks/F",key:"visibleChunksFailed",getter:n=>n[ts(Ze.FAILED,wa.VISIBLE)*La+Ta.numChunks]},{label:"Visible memory",key:"visibleGpuMemory",getter:n=>n[ts(Ze.GPU_MEMORY,wa.VISIBLE)*La+Ta.gpuMemoryBytes]},{label:"Download latency",key:"downloadLatency",getter:n=>n[WS(Nd.totalTime)]/n[WS(Nd.totalChunks)]}],b0=class extends Fr{constructor(e,t,r){super(e,r.location);this.chunkQueueManager=t;this.displayState=r;this.data=void 0;this.requestDataTimerId=-1;this.dataRequested=!1;this.body=document.createElement("div");this.debouncedUpdateView=this.registerCancellable((0,gN.default)(()=>this.updateView(),0));let{body:i}=this;i.classList.add("neuroglancer-statistics-panel-body"),this.addTitleBar({title:"Chunk statistics"}),this.addBody(i),this.requestData()}disposed(){window.clearTimeout(this.requestDataTimerId),super.disposed()}requestData(){if(this.dataRequested)return;let{chunkQueueManager:e}=this;this.dataRequested=!0,e.getStatistics().then(t=>{this.dataRequested=!1,this.data=t,this.debouncedUpdateView(),this.requestDataTimerId=window.setTimeout(()=>{this.requestDataTimerId=-1,this.requestData()},Lq)})}updateView(){let{data:e}=this;if(e===void 0)return;let t=document.createElement("table"),r=[];for(let[l,c]of e){let d=[l];for(let{getter:p}of S0)d.push(p(c));r.push(d)}let i=Tq(r.map(l=>wq(l[0]))),a=new Map;i.forEach((l,c)=>{a.set(r[c][0],l)});{let l=document.createElement("thead"),c=document.createElement("tr");l.appendChild(c);let d=m=>{let g=document.createElement("td");g.textContent=m,c.appendChild(g)};d("Name");let p;for(let{label:m}of S0){let g=m.indexOf("/"),v=m;if(g!==-1){if(v=m.substring(0,g),v===p){++c.lastElementChild.colSpan;continue}p=v}d(v)}c=document.createElement("tr"),l.appendChild(c);{let m=document.createElement("td");c.appendChild(m)}for(let{label:m}of S0){let g=m.indexOf("/"),v="";g!==-1&&(v=m.substring(g+1));let b=document.createElement("td");b.textContent=v,c.appendChild(b)}t.appendChild(l)}let o=document.createElement("tbody");for(let[l,...c]of r){let d=document.createElement("tr"),p=m=>{let g=document.createElement("td");g.textContent=m,d.appendChild(g)};p(a.get(l));for(let m of c)p(""+m);o.appendChild(d)}t.appendChild(o),Ie(this.body),this.body.appendChild(t)}};var x0=class extends j{constructor(e,t={}){super();this.model=e;this.element=document.createElement("label");this.inputElement=document.createElement("input");let{validator:r,label:i}=t,{element:a,inputElement:o}=this;r===void 0&&(e instanceof Le?r=e.validator:r=l=>l),this.validator=r,i!==void 0&&(a.textContent=i),a.appendChild(o),a.className="neuroglancer-number-input",o.type="text",this.registerDisposer(this.model.changed.add(()=>this.updateView())),this.registerEventListener(o,"change",()=>this.updateModel()),this.updateView()}updateView(){this.inputElement.value=""+this.model.value}updateModel(){let e=parseFloat(this.inputElement.value.trim());if(Number.isNaN(e)){this.updateView();return}try{e=this.validator(e),this.model.value=e}catch{this.updateView()}}disposed(){Ye(this.element),super.disposed()}};var kq={...vi,side:"left",row:2},C0=class{constructor(){this.location=new Zn(kq)}get changed(){return this.location.changed}toJSON(){return Ri(this.location.toJSON())}reset(){this.location.reset()}restoreState(e){this.location.restoreState(e)}},w0=class extends Fr{constructor(e,t,r){super(e,t.location);this.addTitleBar({title:"Settings"});let i=document.createElement("div");i.classList.add("neuroglancer-settings-body");let a=document.createElement("div");a.classList.add("neuroglancer-settings-scroll-container"),i.appendChild(a),this.addBody(i);{let d=this.registerDisposer(new Fp(r.title));d.element.placeholder="Title",d.element.classList.add("neuroglancer-settings-title"),a.appendChild(d.element)}let o=(d,p)=>{let m=this.registerDisposer(new x0(p,{label:d}));m.element.classList.add("neuroglancer-settings-limit-widget"),a.appendChild(m.element)};o("GPU memory limit",r.chunkQueueManager.capacities.gpuMemory.sizeLimit),o("System memory limit",r.chunkQueueManager.capacities.systemMemory.sizeLimit),o("Concurrent chunk requests",r.chunkQueueManager.capacities.download.itemLimit);let l=(d,p)=>{let m=document.createElement("label");m.textContent=d;let g=this.registerDisposer(new Fn(p));m.appendChild(g.element),a.appendChild(m)};l("Show axis lines",r.showAxisLines),l("Show scale bar",r.showScaleBar),l("Show cross sections in 3-d",r.showPerspectiveSliceViews),l("Show default annotations",r.showDefaultAnnotations),l("Show chunk statistics",r.statisticsDisplayState.location.watchableVisible),l("Wire frame rendering",r.wireFrame),l("Enable prefetching",r.chunkQueueManager.enablePrefetch);let c=(d,p)=>{let m=document.createElement("label");m.textContent=d;let g=this.registerDisposer(new Ul(p));m.appendChild(g.element),a.appendChild(m)};c("Cross-section background",r.crossSectionBackgroundColor),c("Projection background",r.perspectiveViewBackgroundColor)}};var T0=class extends j{constructor(e,t){super();this.selectedLayer=e;this.toolBinder=t;this.element=document.createElement("div");this.viewContext=void 0;this.updateView=this.registerCancellable(We(()=>{let{viewContext:e}=this;e!==void 0&&(this.unregisterDisposer(e),e.dispose()),this.viewContext=e=this.registerDisposer(new j),Ie(this.element);let{selectedTool:t}=this;t!==void 0&&this.element.appendChild(this.makeWidget(e,t));let r=Array.from(this.toolBinder.bindings);r.sort(([i],[a])=>fo(i,a));for(let[,i]of r)this.element.appendChild(this.makeWidget(e,i))}));let{element:r}=this;r.className="neuroglancer-annotation-tool-status",this.registerDisposer(e.changed.add(()=>this.selectedLayerChanged())),this.registerDisposer(t.changed.add(this.updateView)),this.registerDisposer(this.selectedLayer.layerManager.layersChanged.add(this.updateView)),this.selectedLayerChanged()}get selectedTool(){let e=this.selectedLayer.layer;if(e===void 0)return;let t=e.layer;if(t!==null)return t.tool.value}selectedLayerChanged(){let{unbindPreviousLayer:e}=this;e!==void 0&&e();let t=this.selectedLayer.layer;t!==void 0&&(this.unbindPreviousLayer=t.specificationChanged.add(()=>{this.updateView()})),this.updateView()}disposed(){let{unbindPreviousLayer:e}=this;e!==void 0&&e(),this.unbindPreviousLayer=void 0}makeWidget(e,t){let r=document.createElement("div");r.title="dblclick \u2192 unbind",t instanceof Gr&&(r.title+=", click \u2192 bind key"),r.className="neuroglancer-annotation-tool-status-widget";let i=document.createElement("div");i.className="neuroglancer-annotation-tool-status-widget-layer-number";let{managedLayer:a}=t.layer;a.manager.rootLayers.updateNonArchivedLayerIndices();let o=a.nonArchivedLayerIndex;i.textContent=(o+1).toString();let l=document.createElement("div");if(l.className="neuroglancer-annotation-tool-status-widget-description",l.textContent=t.description,r.addEventListener("dblclick",()=>{t instanceof vp?t.layer.tool.value=void 0:this.toolBinder.set(t.keyBinding,void 0)}),t instanceof Gr){let c=document.createElement("div");c.className="neuroglancer-annotation-tool-status-widget-key",c.textContent=t.keyBinding,r.appendChild(c),Vx(e,r,d=>t.layer.toolBinder.set(d,t.addRef()))}return r.appendChild(i),r.appendChild(l),r}};var vN=class extends j{constructor(e,t,r=""){super();this.gl=e;this.frameNumberCounter=t;let i=r+"chunk_worker.bundle.js";this.worker=new Worker(i),this.chunkQueueManager=this.registerDisposer(new Bd(new yS(this.worker),this.gl,this.frameNumberCounter,{gpuMemory:new Vc({defaultItemLimit:1e6,defaultSizeLimit:1e9}),systemMemory:new Vc({defaultItemLimit:1e7,defaultSizeLimit:2e9}),download:new Vc({defaultItemLimit:100,defaultSizeLimit:Number.POSITIVE_INFINITY}),compute:new Vc({defaultItemLimit:128,defaultSizeLimit:5e8})})),this.chunkQueueManager.registerDisposer(()=>this.worker.terminate()),this.chunkManager=this.registerDisposer(new Ud(this.chunkQueueManager))}get rpc(){return this.chunkQueueManager.rpc}};var SN=["showHelpButton","showSettingsButton","showEditStateButton","showLayerListPanelButton","showSelectionPanelButton","showLayerSidePanelButton","showLocation","showAnnotationToolStatus"],bN=[...SN,"showLayerPanel","showLayerHoverValues"],xN=[...bN,"showUIControls","showPanelBorders"];function Eq(){return Object.fromEntries(xN.map(n=>[n,new qe(!0)]))}function Dq(n,e){for(let t of xN){let r=e[t];r!==void 0&&(n[t].value=r)}}var Pq=typeof NEUROGLANCER_OVERRIDE_DEFAULT_VIEWER_OPTIONS!="undefined"?NEUROGLANCER_OVERRIDE_DEFAULT_VIEWER_OPTIONS:{showLayerDialog:!0,resetStateWhenEmpty:!0},CN=class extends nr{constructor(e){super();this.viewer=e;this.add("title",e.title),this.add("dimensions",e.coordinateSpace),this.add("relativeDisplayScales",e.relativeDisplayScales),this.add("displayDimensions",e.displayDimensions),this.add("position",e.position),this.add("crossSectionOrientation",e.crossSectionOrientation),this.add("crossSectionScale",e.crossSectionScale),this.add("crossSectionDepth",e.crossSectionDepthRange),this.add("projectionOrientation",e.projectionOrientation),this.add("projectionScale",e.projectionScale),this.add("projectionDepth",e.projectionDepthRange),this.add("layers",e.layerSpecification),this.add("showAxisLines",e.showAxisLines),this.add("wireFrame",e.wireFrame),this.add("showScaleBar",e.showScaleBar),this.add("showDefaultAnnotations",e.showDefaultAnnotations),this.add("showSlices",e.showPerspectiveSliceViews),this.add("gpuMemoryLimit",e.dataContext.chunkQueueManager.capacities.gpuMemory.sizeLimit),this.add("prefetch",e.dataContext.chunkQueueManager.enablePrefetch),this.add("systemMemoryLimit",e.dataContext.chunkQueueManager.capacities.systemMemory.sizeLimit),this.add("concurrentDownloads",e.dataContext.chunkQueueManager.capacities.download.itemLimit),this.add("selectedLayer",e.selectedLayer),this.add("crossSectionBackgroundColor",e.crossSectionBackgroundColor),this.add("projectionBackgroundColor",e.perspectiveViewBackgroundColor),this.add("layout",e.layout),this.add("statistics",e.statisticsDisplayState),this.add("helpPanel",e.helpPanelState),this.add("settingsPanel",e.settingsPanelState),this.add("selection",e.selectionDetailsState),this.add("layerListPanel",e.layerListPanelState),this.add("partialViewport",e.partialViewport),this.add("selectedStateServer",e.selectedStateServer)}restoreState(e){let{viewer:t}=this;super.restoreState(e),oe(e,"navigation",r=>{Z(r),oe(r,"pose",i=>{Z(i),oe(i,"position",a=>{Z(a),ln(a,"voxelCoordinates",t.position),oe(a,"voxelSize",o=>{let l=Ne(new Float64Array(3),o,it);for(let c=0;c<3;++c)l[c]*=1e-9;t.coordinateSpace.value=Be({valid:!1,names:["x","y","z"],units:["m","m","m"],scales:l})})}),ln(i,"orientation",t.crossSectionOrientation)}),ln(r,"zoomFactor",t.crossSectionScale.legacyJsonView)}),ln(e,"perspectiveOrientation",t.projectionOrientation),ln(e,"perspectiveZoom",t.projectionScale.legacyJsonView),ln(e,"perspectiveViewBackgroundColor",t.perspectiveViewBackgroundColor)}},L0=class extends j{constructor(e,t={}){super();this.display=e;this.title=new Le(void 0,Q);this.coordinateSpace=new Xs;this.position=this.registerDisposer(new Ki(this.coordinateSpace));this.relativeDisplayScales=this.registerDisposer(new ug(this.coordinateSpace));this.displayDimensions=this.registerDisposer(new dg(this.coordinateSpace));this.displayDimensionRenderInfo=this.registerDisposer(new wp(this.relativeDisplayScales.addRef(),this.displayDimensions.addRef()));this.crossSectionOrientation=this.registerDisposer(new So);this.crossSectionScale=this.registerDisposer(new Gx(this.displayDimensionRenderInfo.addRef()));this.projectionOrientation=this.registerDisposer(new So);this.crossSectionDepthRange=this.registerDisposer(new Tp(-10,this.displayDimensionRenderInfo));this.projectionDepthRange=this.registerDisposer(new Tp(-50,this.displayDimensionRenderInfo));this.projectionScale=this.registerDisposer(new Wx(this.displayDimensionRenderInfo.addRef()));this.navigationState=this.registerDisposer(new Ba(new Na(this.position.addRef(),this.displayDimensionRenderInfo.addRef(),this.crossSectionOrientation.addRef()),this.crossSectionScale.addRef(),this.crossSectionDepthRange.addRef()));this.perspectiveNavigationState=this.registerDisposer(new Ba(new Na(this.position.addRef(),this.displayDimensionRenderInfo.addRef(),this.projectionOrientation.addRef()),this.projectionScale.addRef(),this.projectionDepthRange.addRef()));this.mouseState=new Zx;this.layerManager=this.registerDisposer(new vg);this.selectedLayer=this.registerDisposer(new rC(this.layerManager.addRef()));this.showAxisLines=new qe(!0,!0);this.wireFrame=new qe(!1,!1);this.showScaleBar=new qe(!0,!0);this.showPerspectiveSliceViews=new qe(!0,!0);this.visibleLayerRoles=FP();this.showDefaultAnnotations=new qe(!0,!0);this.crossSectionBackgroundColor=new Go(K.fromValues(.5,.5,.5));this.perspectiveViewBackgroundColor=new Go(K.fromValues(0,0,0));this.scaleBarOptions=new $w;this.partialViewport=new Yv;this.statisticsDisplayState=new v0;this.helpPanelState=new e0;this.settingsPanelState=new C0;this.layerSelectedValues=this.registerDisposer(new eC(this.layerManager,this.mouseState));this.selectionDetailsState=this.registerDisposer(new nC(this.coordinateSpace,this.layerSelectedValues));this.selectedStateServer=new Le("",Q);this.layerListPanelState=new p0;this.resetInitiated=new re;this.uiControlVisibility={};this.visible=!0;this.toolInputEventMapBinder=(e,t)=>{t.registerDisposer(this.inputEventBindings.sliceView.addParent(e,Number.POSITIVE_INFINITY)),t.registerDisposer(this.inputEventBindings.perspectiveView.addParent(e,Number.POSITIVE_INFINITY))};this.toolBinder=this.registerDisposer(new Rx(this.toolInputEventMapBinder));let{dataContext:r=new vN(e.gl,e,t.bundleRoot),visibility:i=new It(It.VISIBLE),inputEventBindings:a={global:new Me,sliceView:new Me,perspectiveView:new Me},element:o=e.makeCanvasOverlayElement(),dataSourceProvider:l=y1({credentialsManager:sr}),uiConfiguration:c=Eq()}=t;this.visibility=i,this.inputEventBindings=a,this.element=o,this.dataSourceProvider=l,this.uiConfiguration=c,this.registerDisposer(_r(v=>{this.display.applyWindowedViewportToElement(o,v)},this.partialViewport)),this.registerDisposer(()=>Ye(this.element)),this.dataContext=this.registerDisposer(r),Dq(c,t);let d={...Pq,...t},{resetStateWhenEmpty:p,showLayerDialog:m}=d;for(let v of bN)this.uiControlVisibility[v]=this.makeUiControlVisibilityState(v);this.registerDisposer(this.uiConfiguration.showPanelBorders.changed.add(()=>{this.updateShowBorders()})),this.showLayerDialog=m,this.resetStateWhenEmpty=p,this.layerSpecification=new sC(this.display,this.dataSourceProvider,this.layerManager,this.chunkManager,this.selectionDetailsState,this.selectedLayer,this.navigationState.coordinateSpace,this.navigationState.pose.position,this.toolBinder),this.registerDisposer(e.updateStarted.add(()=>{this.onUpdateDisplay()})),this.showDefaultAnnotations.changed.add(()=>{this.showDefaultAnnotations.value?this.visibleLayerRoles.add(In.DEFAULT_ANNOTATION):this.visibleLayerRoles.delete(In.DEFAULT_ANNOTATION)}),this.registerDisposer(this.navigationState.changed.add(()=>{this.handleNavigationStateChanged()}));let g=this.registerCancellable((0,yN.default)(()=>{!this.wasDisposed&&this.layerManager.managedLayers.length===0&&this.resetStateWhenEmpty&&(this.navigationState.reset(),this.perspectiveNavigationState.pose.orientation.reset(),this.perspectiveNavigationState.zoomFactor.reset(),this.resetInitiated.dispatch(),!Gg&&this.showLayerDialog&&this.visibility.visible&&wg(this.layerSpecification,this.selectedLayer))}));this.layerManager.layersChanged.add(g),g(),this.registerDisposer(this.dataContext.chunkQueueManager.visibleChunksChanged.add(()=>{this.layerSelectedValues.handleLayerChange()})),this.registerDisposer(this.dataContext.chunkQueueManager.visibleChunksChanged.add(()=>{this.visible&&e.scheduleRedraw()})),this.makeUI(),this.updateShowBorders(),this.registerActionListeners(),this.registerEventActionBindings(),this.registerDisposer(fy(o,this.navigationState.position)),this.state=new CN(this)}get chunkManager(){return this.dataContext.chunkManager}get chunkQueueManager(){return this.dataContext.chunkQueueManager}makeUiControlVisibilityState(e){let t=this.uiConfiguration.showUIControls,r=this.uiConfiguration[e];return this.registerDisposer(hv((i,a)=>i&&a,t,r))}get inputEventMap(){return this.inputEventBindings.global}updateShowBorders(){let{element:e}=this,t="neuroglancer-show-panel-borders";this.uiConfiguration.showPanelBorders.value?e.classList.add(t):e.classList.remove(t)}makeUI(){let e=this.element;e.classList.add("neuroglancer-viewer"),e.classList.add("neuroglancer-noselect"),e.style.display="flex",e.style.flexDirection="column";let t=document.createElement("div");t.classList.add("neuroglancer-viewer-top-row"),t.style.display="flex",t.style.flexDirection="row",t.style.alignItems="stretch";let r=this.registerDisposer(new ws(this.navigationState.position,this.layerSpecification.coordinateSpaceCombiner));this.registerDisposer(new Xn(this.uiControlVisibility.showLocation,r.element)),t.appendChild(r.element);let i=this.registerDisposer(new jC(document.createElement("div"),this.mouseState,this.navigationState.coordinateSpace));if(i.element.style.flex="1",i.element.style.alignSelf="center",this.registerDisposer(new Xn(this.uiControlVisibility.showLocation,i.element)),t.appendChild(i.element),typeof NEUROGLANCER_CREDIT_LINK!="undefined"){let l=NEUROGLANCER_CREDIT_LINK;Array.isArray(l)||(l=[l]);for(let{url:c,text:d}of l){let p=document.createElement("a");p.style.marginRight="5px",p.href=c,p.textContent=d,p.style.fontFamily="sans-serif",p.style.color="yellow",p.target="_blank",t.appendChild(p)}}let a=this.registerDisposer(new T0(this.selectedLayer,this.toolBinder));if(t.appendChild(a.element),this.registerDisposer(new Xn(this.uiControlVisibility.showAnnotationToolStatus,a.element)),OO){let l=this.registerDisposer(new Zw(this));t.appendChild(l.element)}{let{layerListPanelState:l}=this,c=this.registerDisposer(new er(l.location.watchableVisible,{svg:lO,backgroundScheme:"dark",enableTitle:"Show layer list panel",disableTitle:"Hide layer list panel"}));c.element.insertAdjacentElement("afterbegin",this.registerDisposer(new h0(this.layerManager)).element),this.registerDisposer(new Xn(this.uiControlVisibility.showLayerListPanelButton,c.element)),t.appendChild(c.element)}{let{selectionDetailsState:l}=this,c=this.registerDisposer(new er(l.location.watchableVisible,{svg:cO,backgroundScheme:"dark",enableTitle:"Show selection details panel",disableTitle:"Hide selection details panel"}));this.registerDisposer(new Xn(this.uiControlVisibility.showSelectionPanelButton,c.element)),t.appendChild(c.element)}{let{selectedLayer:l}=this,c=this.registerDisposer(new er({get value(){return l.visible},set value(d){l.visible=d},changed:l.location.locationChanged},{svg:oy,backgroundScheme:"dark",enableTitle:"Show layer side panel",disableTitle:"Hide layer side panel"}));this.registerDisposer(new Xn(this.uiControlVisibility.showLayerSidePanelButton,c.element)),t.appendChild(c.element)}{let l=He({text:"{}",title:"Edit JSON state"});this.registerEventListener(l,"click",()=>{this.editJsonState()}),this.registerDisposer(new Xn(this.uiControlVisibility.showEditStateButton,l)),t.appendChild(l)}{let{helpPanelState:l}=this,c=this.registerDisposer(new er(l.location.watchableVisible,{text:"?",backgroundScheme:"dark",enableTitle:"Show help panel",disableTitle:"Hide help panel"}));this.registerDisposer(new Xn(this.uiControlVisibility.showHelpButton,c.element)),t.appendChild(c.element)}{let{settingsPanelState:l}=this,c=this.registerDisposer(new er(l.location.watchableVisible,{svg:uO,backgroundScheme:"dark",enableTitle:"Show settings panel",disableTitle:"Hide settings panel"}));this.registerDisposer(new Xn(this.uiControlVisibility.showSettingsButton,c.element)),t.appendChild(c.element)}this.registerDisposer(new Xn(hv((...l)=>l.reduce((c,d)=>c||d,!1),...SN.map(l=>this.uiControlVisibility[l])),t)),e.appendChild(t),this.layout=this.registerDisposer(new u0(this,"4panel")),this.sidePanelManager=this.registerDisposer(new Cb(this.display,this.layout.element,this.visibility)),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.layerListPanelState.location,makePanel:()=>new f0(this.sidePanelManager,this.layerSpecification,this.layerListPanelState)})),this.registerDisposer(new d0(this.sidePanelManager,this.selectedLayer.addRef())),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.selectionDetailsState.location,makePanel:()=>new Tb(this.sidePanelManager,this.selectionDetailsState,this.layerSpecification,this.selectedLayer)})),e.appendChild(this.sidePanelManager.element),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.statisticsDisplayState.location,makePanel:()=>new b0(this.sidePanelManager,this.chunkQueueManager,this.statisticsDisplayState)})),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.helpPanelState.location,makePanel:()=>{let{inputEventBindings:l}=this;return new t0(this.sidePanelManager,this.helpPanelState,[["Global",l.global],["Cross section view",l.sliceView],["3-D projection view",l.perspectiveView]],this.layerManager,this.toolBinder)}})),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.settingsPanelState.location,makePanel:()=>new w0(this.sidePanelManager,this.settingsPanelState,this)}));let o=()=>{let l=this.visibility.visible;l!==this.visible&&(e.style.visibility=l?"inherit":"hidden",this.visible=l)};o(),this.registerDisposer(this.visibility.changed.add(o))}registerEventActionBindings(){let{element:e}=this;this.registerDisposer(new $t(e,this.inputEventMap)),this.registerDisposer(new xo(e))}bindAction(e,t){this.registerDisposer(ce(this.element,e,t))}registerActionListeners(){for(let e of["recolor","clear-segments"])this.bindAction(e,()=>{this.layerManager.invokeAction(e)});for(let e of["select"])this.bindAction(e,()=>{this.mouseState.updateUnconditionally(),this.layerManager.invokeAction(e)});this.bindAction("help",()=>this.toggleHelpPanel());for(let e=1;e<=9;++e)this.bindAction(`toggle-layer-${e}`,()=>{let t=this.layerManager.getLayerByNonArchivedIndex(e-1);t!==void 0&&t.setVisible(!t.visible)}),this.bindAction(`toggle-pick-layer-${e}`,()=>{let t=this.layerManager.getLayerByNonArchivedIndex(e-1);t!==void 0&&(t.pickEnabled=!t.pickEnabled)}),this.bindAction(`select-layer-${e}`,()=>{let t=this.layerManager.getLayerByNonArchivedIndex(e-1);t!==void 0&&(this.selectedLayer.layer=t,this.selectedLayer.visible=!0)});for(let e=0;e<26;++e){let t=String.fromCharCode(65+e);this.bindAction(`tool-${t}`,()=>{this.activateTool(t)})}this.bindAction("annotate",()=>{let e=this.selectedLayer.layer;if(e===void 0){Ce.showTemporaryMessage("The annotate command requires a layer to be selected.");return}let t=e.layer;if(t===null||t.tool.value===void 0){Ce.showTemporaryMessage(`The selected layer (${JSON.stringify(e.name)}) does not have an active annotation tool.`);return}t.tool.value.trigger(this.mouseState)}),this.bindAction("toggle-axis-lines",()=>this.showAxisLines.toggle()),this.bindAction("toggle-scale-bar",()=>this.showScaleBar.toggle()),this.bindAction("toggle-default-annotations",()=>this.showDefaultAnnotations.toggle()),this.bindAction("toggle-show-slices",()=>this.showPerspectiveSliceViews.toggle()),this.bindAction("toggle-show-statistics",()=>this.showStatistics())}toggleHelpPanel(){this.helpPanelState.location.visible=!this.helpPanelState.location.visible}activateTool(e){this.toolBinder.activate(e)}editJsonState(){new y0(this)}showStatistics(e=void 0){e===void 0&&(e=!this.statisticsDisplayState.location.visible),this.statisticsDisplayState.location.visible=e}get gl(){return this.display.gl}onUpdateDisplay(){this.visible&&(this.dataContext.chunkQueueManager.chunkUpdateDeadline=null)}handleNavigationStateChanged(){if(this.visible){let{chunkQueueManager:e}=this.dataContext;e.chunkUpdateDeadline===null&&(e.chunkUpdateDeadline=Date.now()+10)}}};function wN(n,e=document.getElementById("neuroglancer-container")){try{let t=new Kv(e);return new L0(t,n)}catch(t){throw Ce.showMessage(`Error: ${t.message}`),t}}function TN(n){return X2(),Q2(),wN(n)}function LN(n){let e=We(()=>{var i;let r=(i=n.value)==null?void 0:i.trim();r?document.title=`${r} - neuroglancer`:document.title="neuroglancer"}),t=n.changed.add(e);return e(),e.flush(),()=>{t(),e.cancel()}}var kN=ot(Et());function Iq(n){return encodeURI(n).replace(/[!'()*;,]/g,function(e){return"%"+e.charCodeAt(0).toString(16).toUpperCase()})}var k0=class extends j{constructor(e,t,r={}){super();this.root=e;this.credentialsManager=t;this.parseError=new Ee(void 0);let{updateDelayMilliseconds:i=200,defaultFragment:a="{}"}=r;this.registerEventListener(window,"hashchange",()=>this.updateFromUrlHash());let o=(0,kN.default)(()=>this.setUrlHash(),i);this.registerDisposer(e.changed.add(o)),this.registerDisposer(()=>o.cancel()),this.defaultFragment=a}setUrlHash(){let e=Tl(this.root),{generation:t}=e;if(t!==this.prevStateGeneration){this.prevStateGeneration=e.generation;let r=Iq(JSON.stringify(e.value));r!==this.prevStateString&&(this.prevStateString=r,decodeURIComponent(r)==="{}"?history.replaceState(null,"","#"):history.replaceState(null,"","#!"+r))}}updateFromUrlHash(){try{let e=location.href.replace(/^[^#]+/,"");if((e===""||e==="#"||e==="#!")&&(e="#!"+this.defaultFragment),e.match(/^#!([a-z][a-z\d+-.]*):\/\//)){let t=e.substring(2),{url:r,credentialsProvider:i}=Tn(t,this.credentialsManager);Ce.forPromise(Mn(i,r,{},bt).then(a=>{Z(a),this.root.reset(),this.root.restoreState(a)}),{initialMessage:`Loading state from ${t}`,errorPrefix:"Error loading state:"})}else if(e.startsWith("#!+")){e=e.slice(3),e=decodeURIComponent(e);let t=eh(e);Z(t),this.root.restoreState(t),this.prevStateString=void 0}else if(e.startsWith("#!")){if(e=e.slice(2),e=decodeURIComponent(e),e===this.prevStateString)return;this.prevStateString=e,this.root.reset();let t=eh(e);Z(t),this.root.restoreState(t)}else throw new Error('URL hash is expected to be of the form "#!{...}" or "#!+{...}".');this.parseError.value=void 0}catch(e){this.parseError.value=e}}};var EN=ot(Et());var E0=class extends j{constructor(e){super();this.viewer=e;this.actionSet=new Le(new Set,e=>new Set(qt(e)));this.actionDisposers=[];this.sendActionRequested=new ze;this.actionSet.changed.add((0,EN.default)(()=>this.updateActions(),0))}clearListeners(){for(let e of this.actionDisposers)e();this.actionDisposers.length=0}disposed(){this.clearListeners(),super.disposed()}updateActions(){this.clearListeners();for(let e of this.actionSet.value)this.actionDisposers.push(ce(this.viewer.element,e,()=>this.handleAction(e)))}handleAction(e){let{mouseState:t,layerSelectedValues:r}=this.viewer,i={};t.updateUnconditionally()&&(i.mousePosition=Array.prototype.slice.call(t.position)),i.selectedValues=r.toJSON(),i.viewerState=Tl(this.viewer.state).value,this.sendActionRequested.dispatch(e,JSON.parse(JSON.stringify(i)))}};function DN(){let n=window.viewer=TN();CI(n.inputEventBindings);let e=n.registerDisposer(new k0(n.state,n.dataSourceProvider.credentialsManager,{defaultFragment:typeof NEUROGLANCER_DEFAULT_STATE_FRAGMENT!="undefined"?NEUROGLANCER_DEFAULT_STATE_FRAGMENT:void 0}));n.registerDisposer(e.parseError.changed.add(()=>{let{value:i}=e.parseError;i!==void 0&&(new Ce().setErrorMessage(`Error parsing state: ${i.message}`),console.log("Error parsing state",i)),e.parseError})),e.updateFromUrlHash(),n.registerDisposer(LN(n.title));let t=new nr,r=new E0(n);return window.remoteActionHandler=r,t.add("actions",r.actionSet),Y2(n),K2(n),n}window.addEventListener("DOMContentLoaded",()=>{DN()});})();
/**
 * /**
 * @license
 * This work is a derivative of the Google Neuroglancer project,
 * Copyright 2016 Google Inc.
 * The Derivative Work is covered by
 * Copyright 2021 Howard Hughes Medical Institute
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2017-2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2018 The Neuroglancer Authors
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2019 The Neuroglancer Authors
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2022 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * This work is a derivative of the Google Neuroglancer project,
 * Copyright 2016 Google Inc.
 * The Derivative Work is covered by
 * Copyright 2019 Howard Hughes Medical Institute
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
//# sourceMappingURL=main.bundle.js.map
