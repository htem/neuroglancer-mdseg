function require(x) { throw new Error('Cannot require ' + x) }
(()=>{var GF=Object.create;var ld=Object.defineProperty;var GL=Object.getOwnPropertyDescriptor;var WF=Object.getOwnPropertyNames;var zF=Object.getPrototypeOf,HF=Object.prototype.hasOwnProperty;var WL=n=>ld(n,"__esModule",{value:!0});var qt=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),vc=(n,e)=>{WL(n);for(var t in e)ld(n,t,{get:e[t],enumerable:!0})},$F=(n,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of WF(e))!HF.call(n,r)&&r!=="default"&&ld(n,r,{get:()=>e[r],enumerable:!(t=GL(e,r))||t.enumerable});return n},Ye=n=>$F(WL(ld(n!=null?GF(zF(n)):{},"default",n&&n.__esModule&&"default"in n?{get:()=>n.default,enumerable:!0}:{value:n,enumerable:!0})),n),Pt=(n,e,t,r)=>{for(var i=r>1?void 0:r?GL(e,t):e,a=n.length-1,o;a>=0;a--)(o=n[a])&&(i=(r?o(e,t,i):o(i))||i);return r&&i&&ld(e,t,i),i};var Ff=qt((Nq,XL)=>{function jF(n){var e=typeof n;return n!=null&&(e=="object"||e=="function")}XL.exports=jF});var ZL=qt((Bq,QL)=>{var JF=typeof window=="object"&&window&&window.Object===Object&&window;QL.exports=JF});var bv=qt((Fq,ek)=>{var qF=ZL(),YF=typeof self=="object"&&self&&self.Object===Object&&self,KF=qF||YF||Function("return this")();ek.exports=KF});var nk=qt((Uq,tk)=>{var XF=bv(),QF=function(){return XF.Date.now()};tk.exports=QF});var ik=qt((Gq,rk)=>{var ZF=/\s/;function eU(n){for(var e=n.length;e--&&ZF.test(n.charAt(e)););return e}rk.exports=eU});var ok=qt((Wq,ak)=>{var tU=ik(),nU=/^\s+/;function rU(n){return n&&n.slice(0,tU(n)+1).replace(nU,"")}ak.exports=rU});var xv=qt((zq,sk)=>{var iU=bv(),aU=iU.Symbol;sk.exports=aU});var dk=qt((Hq,uk)=>{var lk=xv(),ck=Object.prototype,oU=ck.hasOwnProperty,sU=ck.toString,dd=lk?lk.toStringTag:void 0;function lU(n){var e=oU.call(n,dd),t=n[dd];try{n[dd]=void 0;var r=!0}catch(a){}var i=sU.call(n);return r&&(e?n[dd]=t:delete n[dd]),i}uk.exports=lU});var fk=qt(($q,pk)=>{var cU=Object.prototype,uU=cU.toString;function dU(n){return uU.call(n)}pk.exports=dU});var yk=qt((jq,gk)=>{var hk=xv(),pU=dk(),fU=fk(),hU="[object Null]",mU="[object Undefined]",mk=hk?hk.toStringTag:void 0;function gU(n){return n==null?n===void 0?mU:hU:mk&&mk in Object(n)?pU(n):fU(n)}gk.exports=gU});var Sk=qt((Jq,vk)=>{function yU(n){return n!=null&&typeof n=="object"}vk.exports=yU});var xk=qt((qq,bk)=>{var vU=yk(),SU=Sk(),bU="[object Symbol]";function xU(n){return typeof n=="symbol"||SU(n)&&vU(n)==bU}bk.exports=xU});var Lk=qt((Yq,Tk)=>{var CU=ok(),Ck=Ff(),wU=xk(),wk=0/0,TU=/^[-+]0x[0-9a-f]+$/i,LU=/^0b[01]+$/i,kU=/^0o[0-7]+$/i,EU=parseInt;function DU(n){if(typeof n=="number")return n;if(wU(n))return wk;if(Ck(n)){var e=typeof n.valueOf=="function"?n.valueOf():n;n=Ck(e)?e+"":e}if(typeof n!="string")return n===0?n:+n;n=CU(n);var t=LU.test(n);return t||kU.test(n)?EU(n.slice(2),t?2:8):TU.test(n)?wk:+n}Tk.exports=DU});var gt=qt((Kq,Ek)=>{var PU=Ff(),Cv=nk(),kk=Lk(),IU="Expected a function",AU=Math.max,MU=Math.min;function RU(n,e,t){var r,i,a,o,l,c,d=0,p=!1,h=!1,g=!0;if(typeof n!="function")throw new TypeError(IU);e=kk(e)||0,PU(t)&&(p=!!t.leading,h="maxWait"in t,a=h?AU(kk(t.maxWait)||0,e):a,g="trailing"in t?!!t.trailing:g);function v(E){var V=r,O=i;return r=i=void 0,d=E,o=n.apply(O,V),o}function b(E){return d=E,l=setTimeout(T,e),p?v(E):o}function x(E){var V=E-c,O=E-d,B=e-V;return h?MU(B,a-O):B}function C(E){var V=E-c,O=E-d;return c===void 0||V>=e||V<0||h&&O>=a}function T(){var E=Cv();if(C(E))return P(E);l=setTimeout(T,x(E))}function P(E){return l=void 0,g&&r?v(E):(r=i=void 0,o)}function I(){l!==void 0&&clearTimeout(l),d=0,r=c=i=l=void 0}function M(){return l===void 0?o:P(Cv())}function D(){var E=Cv(),V=C(E);if(r=arguments,i=this,c=E,V){if(l===void 0)return b(c);if(h)return clearTimeout(l),l=setTimeout(T,e),v(c)}return l===void 0&&(l=setTimeout(T,e)),o}return D.cancel=I,D.flush=M,D}Ek.exports=RU});var Ml=qt((Jpe,CM)=>{var uj=gt(),dj=Ff(),pj="Expected a function";function fj(n,e,t){var r=!0,i=!0;if(typeof n!="function")throw new TypeError(pj);return dj(t)&&(r="leading"in t?!!t.leading:r,i="trailing"in t?!!t.trailing:i),uj(n,e,{leading:r,maxWait:e,trailing:i})}CM.exports=fj});var Cs=qt((HC,$C)=>{(function(n,e){typeof HC=="object"&&typeof $C!="undefined"?$C.exports=e():typeof define=="function"&&define.amd?define(e):(n=n||self,n.CodeMirror=e())})(HC,function(){"use strict";var n=navigator.userAgent,e=navigator.platform,t=/gecko\/\d/i.test(n),r=/MSIE \d/.test(n),i=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(n),a=/Edge\/(\d+)/.exec(n),o=r||i||a,l=o&&(r?document.documentMode||6:+(a||i)[1]),c=!a&&/WebKit\//.test(n),d=c&&/Qt\/\d+\.\d+/.test(n),p=!a&&/Chrome\//.test(n),h=/Opera\//.test(n),g=/Apple Computer/.test(navigator.vendor),v=/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(n),b=/PhantomJS/.test(n),x=g&&(/Mobile\/\w+/.test(n)||navigator.maxTouchPoints>2),C=/Android/.test(n),T=x||C||/webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(n),P=x||/Mac/.test(e),I=/\bCrOS\b/.test(n),M=/win/i.test(e),D=h&&n.match(/Version\/(\d*\.\d*)/);D&&(D=Number(D[1])),D&&D>=15&&(h=!1,c=!0);var E=P&&(d||h&&(D==null||D<12.11)),V=t||o&&l>=9;function O(s){return new RegExp("(^|\\s)"+s+"(?:$|\\s)\\s*")}var B=function(s,u){var m=s.className,f=O(u).exec(m);if(f){var y=m.slice(f.index+f[0].length);s.className=m.slice(0,f.index)+(y?f[1]+y:"")}};function z(s){for(var u=s.childNodes.length;u>0;--u)s.removeChild(s.firstChild);return s}function _(s,u){return z(s).appendChild(u)}function F(s,u,m,f){var y=document.createElement(s);if(m&&(y.className=m),f&&(y.style.cssText=f),typeof u=="string")y.appendChild(document.createTextNode(u));else if(u)for(var S=0;S<u.length;++S)y.appendChild(u[S]);return y}function N(s,u,m,f){var y=F(s,u,m,f);return y.setAttribute("role","presentation"),y}var J;document.createRange?J=function(s,u,m,f){var y=document.createRange();return y.setEnd(f||s,m),y.setStart(s,u),y}:J=function(s,u,m){var f=document.body.createTextRange();try{f.moveToElementText(s.parentNode)}catch(y){return f}return f.collapse(!0),f.moveEnd("character",m),f.moveStart("character",u),f};function ae(s,u){if(u.nodeType==3&&(u=u.parentNode),s.contains)return s.contains(u);do if(u.nodeType==11&&(u=u.host),u==s)return!0;while(u=u.parentNode)}function pe(){var s;try{s=document.activeElement}catch(u){s=document.body||null}for(;s&&s.shadowRoot&&s.shadowRoot.activeElement;)s=s.shadowRoot.activeElement;return s}function me(s,u){var m=s.className;O(u).test(m)||(s.className+=(m?" ":"")+u)}function Ae(s,u){for(var m=s.split(" "),f=0;f<m.length;f++)m[f]&&!O(m[f]).test(u)&&(u+=" "+m[f]);return u}var le=function(s){s.select()};x?le=function(s){s.selectionStart=0,s.selectionEnd=s.value.length}:o&&(le=function(s){try{s.select()}catch(u){}});function we(s){var u=Array.prototype.slice.call(arguments,1);return function(){return s.apply(null,u)}}function _e(s,u,m){u||(u={});for(var f in s)s.hasOwnProperty(f)&&(m!==!1||!u.hasOwnProperty(f))&&(u[f]=s[f]);return u}function Fe(s,u,m,f,y){u==null&&(u=s.search(/[^\s\u00a0]/),u==-1&&(u=s.length));for(var S=f||0,w=y||0;;){var L=s.indexOf("	",S);if(L<0||L>=u)return w+(u-S);w+=L-S,w+=m-w%m,S=L+1}}var rt=function(){this.id=null,this.f=null,this.time=0,this.handler=we(this.onTimeout,this)};rt.prototype.onTimeout=function(s){s.id=0,s.time<=+new Date?s.f():setTimeout(s.handler,s.time-+new Date)},rt.prototype.set=function(s,u){this.f=u;var m=+new Date+s;(!this.id||m<this.time)&&(clearTimeout(this.id),this.id=setTimeout(this.handler,s),this.time=m)};function ye(s,u){for(var m=0;m<s.length;++m)if(s[m]==u)return m;return-1}var Le=50,je={toString:function(){return"CodeMirror.Pass"}},qe={scroll:!1},it={origin:"*mouse"},Ve={origin:"+move"};function ft(s,u,m){for(var f=0,y=0;;){var S=s.indexOf("	",f);S==-1&&(S=s.length);var w=S-f;if(S==s.length||y+w>=u)return f+Math.min(w,u-y);if(y+=S-f,y+=m-y%m,f=S+1,y>=u)return f}}var Yn=[""];function Zi(s){for(;Yn.length<=s;)Yn.push(at(Yn)+" ");return Yn[s]}function at(s){return s[s.length-1]}function Tr(s,u){for(var m=[],f=0;f<s.length;f++)m[f]=u(s[f],f);return m}function ea(s,u,m){for(var f=0,y=m(u);f<s.length&&m(s[f])<=y;)f++;s.splice(f,0,u)}function ta(){}function na(s,u){var m;return Object.create?m=Object.create(s):(ta.prototype=s,m=new ta),u&&_e(u,m),m}var ra=/[\u00df\u0587\u0590-\u05f4\u0600-\u06ff\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/;function ii(s){return/\w/.test(s)||s>"\x80"&&(s.toUpperCase()!=s.toLowerCase()||ra.test(s))}function wi(s,u){return u?u.source.indexOf("\\w")>-1&&ii(s)?!0:u.test(s):ii(s)}function Na(s){for(var u in s)if(s.hasOwnProperty(u)&&s[u])return!1;return!0}var wo=/[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/;function jl(s){return s.charCodeAt(0)>=768&&wo.test(s)}function To(s,u,m){for(;(m<0?u>0:u<s.length)&&jl(s.charAt(u));)u+=m;return u}function Nn(s,u,m){for(var f=u>m?-1:1;;){if(u==m)return u;var y=(u+m)/2,S=f<0?Math.ceil(y):Math.floor(y);if(S==u)return s(S)?u:m;s(S)?m=S:u=S+f}}function ku(s,u,m,f){if(!s)return f(u,m,"ltr",0);for(var y=!1,S=0;S<s.length;++S){var w=s[S];(w.from<m&&w.to>u||u==m&&w.to==u)&&(f(Math.max(w.from,u),Math.min(w.to,m),w.level==1?"rtl":"ltr",S),y=!0)}y||f(u,m,"ltr")}var or=null;function Dt(s,u,m){var f;or=null;for(var y=0;y<s.length;++y){var S=s[y];if(S.from<u&&S.to>u)return y;S.to==u&&(S.from!=S.to&&m=="before"?f=y:or=y),S.from==u&&(S.from!=S.to&&m!="before"?f=y:or=y)}return f!=null?f:or}var As=function(){var s="bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN",u="nnnnnnNNr%%r,rNNmmmmmmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmmmnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmnNmmmmmmrrmmNmmmmrr1111111111";function m(A){return A<=247?s.charAt(A):1424<=A&&A<=1524?"R":1536<=A&&A<=1785?u.charAt(A-1536):1774<=A&&A<=2220?"r":8192<=A&&A<=8203?"w":A==8204?"b":"L"}var f=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/,y=/[stwN]/,S=/[LRr]/,w=/[Lb1n]/,L=/[1n]/;function k(A,G,$){this.level=A,this.from=G,this.to=$}return function(A,G){var $=G=="ltr"?"L":"R";if(A.length==0||G=="ltr"&&!f.test(A))return!1;for(var Y=A.length,q=[],ee=0;ee<Y;++ee)q.push(m(A.charCodeAt(ee)));for(var re=0,de=$;re<Y;++re){var fe=q[re];fe=="m"?q[re]=de:de=fe}for(var Se=0,he=$;Se<Y;++Se){var be=q[Se];be=="1"&&he=="r"?q[Se]="n":S.test(be)&&(he=be,be=="r"&&(q[Se]="R"))}for(var Re=1,De=q[0];Re<Y-1;++Re){var Ze=q[Re];Ze=="+"&&De=="1"&&q[Re+1]=="1"?q[Re]="1":Ze==","&&De==q[Re+1]&&(De=="1"||De=="n")&&(q[Re]=De),De=Ze}for(var Tt=0;Tt<Y;++Tt){var gn=q[Tt];if(gn==",")q[Tt]="N";else if(gn=="%"){var Ut=void 0;for(Ut=Tt+1;Ut<Y&&q[Ut]=="%";++Ut);for(var Dr=Tt&&q[Tt-1]=="!"||Ut<Y&&q[Ut]=="1"?"1":"N",dr=Tt;dr<Ut;++dr)q[dr]=Dr;Tt=Ut-1}}for(var en=0,pr=$;en<Y;++en){var In=q[en];pr=="L"&&In=="1"?q[en]="L":S.test(In)&&(pr=In)}for(var rn=0;rn<Y;++rn)if(y.test(q[rn])){var tn=void 0;for(tn=rn+1;tn<Y&&y.test(q[tn]);++tn);for(var zt=(rn?q[rn-1]:$)=="L",fr=(tn<Y?q[tn]:$)=="L",gc=zt==fr?zt?"L":"R":$,Vo=rn;Vo<tn;++Vo)q[Vo]=gc;rn=tn-1}for(var Gn=[],pa,yn=0;yn<Y;)if(w.test(q[yn])){var yv=yn;for(++yn;yn<Y&&w.test(q[yn]);++yn);Gn.push(new k(0,yv,yn))}else{var Ha=yn,Ws=Gn.length,zs=G=="rtl"?1:0;for(++yn;yn<Y&&q[yn]!="L";++yn);for(var Xn=Ha;Xn<yn;)if(L.test(q[Xn])){Ha<Xn&&(Gn.splice(Ws,0,new k(1,Ha,Xn)),Ws+=zs);var yc=Xn;for(++Xn;Xn<yn&&L.test(q[Xn]);++Xn);Gn.splice(Ws,0,new k(2,yc,Xn)),Ws+=zs,Ha=Xn}else++Xn;Ha<yn&&Gn.splice(Ws,0,new k(1,Ha,yn))}return G=="ltr"&&(Gn[0].level==1&&(pa=A.match(/^\s+/))&&(Gn[0].from=pa[0].length,Gn.unshift(new k(0,0,pa[0].length))),at(Gn).level==1&&(pa=A.match(/\s+$/))&&(at(Gn).to-=pa[0].length,Gn.push(new k(0,Y-pa[0].length,Y)))),G=="rtl"?Gn.reverse():Gn}}();function Lr(s,u){var m=s.order;return m==null&&(m=s.order=As(s.text,u)),m}var Ba=[],Ne=function(s,u,m){if(s.addEventListener)s.addEventListener(u,m,!1);else if(s.attachEvent)s.attachEvent("on"+u,m);else{var f=s._handlers||(s._handlers={});f[u]=(f[u]||Ba).concat(m)}};function Jl(s,u){return s._handlers&&s._handlers[u]||Ba}function sr(s,u,m){if(s.removeEventListener)s.removeEventListener(u,m,!1);else if(s.detachEvent)s.detachEvent("on"+u,m);else{var f=s._handlers,y=f&&f[u];if(y){var S=ye(y,m);S>-1&&(f[u]=y.slice(0,S).concat(y.slice(S+1)))}}}function Ue(s,u){var m=Jl(s,u);if(!!m.length)for(var f=Array.prototype.slice.call(arguments,2),y=0;y<m.length;++y)m[y].apply(null,f)}function Zt(s,u,m){return typeof u=="string"&&(u={type:u,preventDefault:function(){this.defaultPrevented=!0}}),Ue(s,m||u.type,s,u),Fr(u)||u.codemirrorIgnore}function ql(s){var u=s._handlers&&s._handlers.cursorActivity;if(!!u)for(var m=s.curOp.cursorActivityHandlers||(s.curOp.cursorActivityHandlers=[]),f=0;f<u.length;++f)ye(m,u[f])==-1&&m.push(u[f])}function Pn(s,u){return Jl(s,u).length>0}function ia(s){s.prototype.on=function(u,m){Ne(this,u,m)},s.prototype.off=function(u,m){sr(this,u,m)}}function Bn(s){s.preventDefault?s.preventDefault():s.returnValue=!1}function Yl(s){s.stopPropagation?s.stopPropagation():s.cancelBubble=!0}function Fr(s){return s.defaultPrevented!=null?s.defaultPrevented:s.returnValue==!1}function Ms(s){Bn(s),Yl(s)}function Lo(s){return s.target||s.srcElement}function af(s){var u=s.which;return u==null&&(s.button&1?u=1:s.button&2?u=3:s.button&4&&(u=2)),P&&s.ctrlKey&&u==1&&(u=3),u}var Eu=function(){if(o&&l<9)return!1;var s=F("div");return"draggable"in s||"dragDrop"in s}(),lr;function of(s){if(lr==null){var u=F("span","\u200B");_(s,F("span",[u,document.createTextNode("x")])),s.firstChild.offsetHeight!=0&&(lr=u.offsetWidth<=1&&u.offsetHeight>2&&!(o&&l<8))}var m=lr?F("span","\u200B"):F("span","\xA0",null,"display: inline-block; width: 1px; margin-right: -1px");return m.setAttribute("cm-text",""),m}var Du;function aa(s){if(Du!=null)return Du;var u=_(s,document.createTextNode("A\u062EA")),m=J(u,0,1).getBoundingClientRect(),f=J(u,1,2).getBoundingClientRect();return z(s),!m||m.left==m.right?!1:Du=f.right-m.right<3}var Pu=`

b`.split(/\n/).length!=3?function(s){for(var u=0,m=[],f=s.length;u<=f;){var y=s.indexOf(`
`,u);y==-1&&(y=s.length);var S=s.slice(u,s.charAt(y-1)=="\r"?y-1:y),w=S.indexOf("\r");w!=-1?(m.push(S.slice(0,w)),u+=w+1):(m.push(S),u=y+1)}return m}:function(s){return s.split(/\r\n?|\n/)},sf=window.getSelection?function(s){try{return s.selectionStart!=s.selectionEnd}catch(u){return!1}}:function(s){var u;try{u=s.ownerDocument.selection.createRange()}catch(m){}return!u||u.parentElement()!=s?!1:u.compareEndPoints("StartToEnd",u)!=0},lf=function(){var s=F("div");return"oncopy"in s?!0:(s.setAttribute("oncopy","return;"),typeof s.oncopy=="function")}(),Iu=null;function ko(s){if(Iu!=null)return Iu;var u=_(s,F("span","x")),m=u.getBoundingClientRect(),f=J(u,0,1).getBoundingClientRect();return Iu=Math.abs(m.left-f.left)>1}var ai={},Ur={};function cf(s,u){arguments.length>2&&(u.dependencies=Array.prototype.slice.call(arguments,2)),ai[s]=u}function Fa(s,u){Ur[s]=u}function Kl(s){if(typeof s=="string"&&Ur.hasOwnProperty(s))s=Ur[s];else if(s&&typeof s.name=="string"&&Ur.hasOwnProperty(s.name)){var u=Ur[s.name];typeof u=="string"&&(u={name:u}),s=na(u,s),s.name=u.name}else{if(typeof s=="string"&&/^[\w\-]+\/[\w\-]+\+xml$/.test(s))return Kl("application/xml");if(typeof s=="string"&&/^[\w\-]+\/[\w\-]+\+json$/.test(s))return Kl("application/json")}return typeof s=="string"?{name:s}:s||{name:"null"}}function Xl(s,u){u=Kl(u);var m=ai[u.name];if(!m)return Xl(s,"text/plain");var f=m(s,u);if(Ti.hasOwnProperty(u.name)){var y=Ti[u.name];for(var S in y)!y.hasOwnProperty(S)||(f.hasOwnProperty(S)&&(f["_"+S]=f[S]),f[S]=y[S])}if(f.name=u.name,u.helperType&&(f.helperType=u.helperType),u.modeProps)for(var w in u.modeProps)f[w]=u.modeProps[w];return f}var Ti={};function Li(s,u){var m=Ti.hasOwnProperty(s)?Ti[s]:Ti[s]={};_e(u,m)}function Gr(s,u){if(u===!0)return u;if(s.copyState)return s.copyState(u);var m={};for(var f in u){var y=u[f];y instanceof Array&&(y=y.concat([])),m[f]=y}return m}function Au(s,u){for(var m;s.innerMode&&(m=s.innerMode(u),!(!m||m.mode==s));)u=m.state,s=m.mode;return m||{mode:s,state:u}}function Mu(s,u,m){return s.startState?s.startState(u,m):!0}var Wt=function(s,u,m){this.pos=this.start=0,this.string=s,this.tabSize=u||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0,this.lineOracle=m};Wt.prototype.eol=function(){return this.pos>=this.string.length},Wt.prototype.sol=function(){return this.pos==this.lineStart},Wt.prototype.peek=function(){return this.string.charAt(this.pos)||void 0},Wt.prototype.next=function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},Wt.prototype.eat=function(s){var u=this.string.charAt(this.pos),m;if(typeof s=="string"?m=u==s:m=u&&(s.test?s.test(u):s(u)),m)return++this.pos,u},Wt.prototype.eatWhile=function(s){for(var u=this.pos;this.eat(s););return this.pos>u},Wt.prototype.eatSpace=function(){for(var s=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>s},Wt.prototype.skipToEnd=function(){this.pos=this.string.length},Wt.prototype.skipTo=function(s){var u=this.string.indexOf(s,this.pos);if(u>-1)return this.pos=u,!0},Wt.prototype.backUp=function(s){this.pos-=s},Wt.prototype.column=function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=Fe(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?Fe(this.string,this.lineStart,this.tabSize):0)},Wt.prototype.indentation=function(){return Fe(this.string,null,this.tabSize)-(this.lineStart?Fe(this.string,this.lineStart,this.tabSize):0)},Wt.prototype.match=function(s,u,m){if(typeof s=="string"){var f=function(w){return m?w.toLowerCase():w},y=this.string.substr(this.pos,s.length);if(f(y)==f(s))return u!==!1&&(this.pos+=s.length),!0}else{var S=this.string.slice(this.pos).match(s);return S&&S.index>0?null:(S&&u!==!1&&(this.pos+=S[0].length),S)}},Wt.prototype.current=function(){return this.string.slice(this.start,this.pos)},Wt.prototype.hideFirstChars=function(s,u){this.lineStart+=s;try{return u()}finally{this.lineStart-=s}},Wt.prototype.lookAhead=function(s){var u=this.lineOracle;return u&&u.lookAhead(s)},Wt.prototype.baseToken=function(){var s=this.lineOracle;return s&&s.baseToken(this.pos)};function Te(s,u){if(u-=s.first,u<0||u>=s.size)throw new Error("There is no line "+(u+s.first)+" in the document.");for(var m=s;!m.lines;)for(var f=0;;++f){var y=m.children[f],S=y.chunkSize();if(u<S){m=y;break}u-=S}return m.lines[u]}function oa(s,u,m){var f=[],y=u.line;return s.iter(u.line,m.line+1,function(S){var w=S.text;y==m.line&&(w=w.slice(0,m.ch)),y==u.line&&(w=w.slice(u.ch)),f.push(w),++y}),f}function Ru(s,u,m){var f=[];return s.iter(u,m,function(y){f.push(y.text)}),f}function kr(s,u){var m=u-s.height;if(m)for(var f=s;f;f=f.parent)f.height+=m}function ht(s){if(s.parent==null)return null;for(var u=s.parent,m=ye(u.lines,s),f=u.parent;f;u=f,f=f.parent)for(var y=0;f.children[y]!=u;++y)m+=f.children[y].chunkSize();return m+u.first}function sa(s,u){var m=s.first;e:do{for(var f=0;f<s.children.length;++f){var y=s.children[f],S=y.height;if(u<S){s=y;continue e}u-=S,m+=y.chunkSize()}return m}while(!s.lines);for(var w=0;w<s.lines.length;++w){var L=s.lines[w],k=L.height;if(u<k)break;u-=k}return m+w}function Rs(s,u){return u>=s.first&&u<s.first+s.size}function _u(s,u){return String(s.lineNumberFormatter(u+s.firstLineNumber))}function se(s,u,m){if(m===void 0&&(m=null),!(this instanceof se))return new se(s,u,m);this.line=s,this.ch=u,this.sticky=m}function R(s,u){return s.line-u.line||s.ch-u.ch}function j(s,u){return s.sticky==u.sticky&&R(s,u)==0}function te(s){return se(s.line,s.ch)}function ue(s,u){return R(s,u)<0?u:s}function Ge(s,u){return R(s,u)<0?s:u}function st(s,u){return Math.max(s.first,Math.min(u,s.first+s.size-1))}function ve(s,u){if(u.line<s.first)return se(s.first,0);var m=s.first+s.size-1;return u.line>m?se(m,Te(s,m).text.length):Fn(u,Te(s,u.line).text.length)}function Fn(s,u){var m=s.ch;return m==null||m>u?se(s.line,u):m<0?se(s.line,0):s}function Wr(s,u){for(var m=[],f=0;f<u.length;f++)m[f]=ve(s,u[f]);return m}var Ql=function(s,u){this.state=s,this.lookAhead=u},la=function(s,u,m,f){this.state=u,this.doc=s,this.line=m,this.maxLookAhead=f||0,this.baseTokens=null,this.baseTokenPos=1};la.prototype.lookAhead=function(s){var u=this.doc.getLine(this.line+s);return u!=null&&s>this.maxLookAhead&&(this.maxLookAhead=s),u},la.prototype.baseToken=function(s){if(!this.baseTokens)return null;for(;this.baseTokens[this.baseTokenPos]<=s;)this.baseTokenPos+=2;var u=this.baseTokens[this.baseTokenPos+1];return{type:u&&u.replace(/( |^)overlay .*/,""),size:this.baseTokens[this.baseTokenPos]-s}},la.prototype.nextLine=function(){this.line++,this.maxLookAhead>0&&this.maxLookAhead--},la.fromSaved=function(s,u,m){return u instanceof Ql?new la(s,Gr(s.mode,u.state),m,u.lookAhead):new la(s,Gr(s.mode,u),m)},la.prototype.save=function(s){var u=s!==!1?Gr(this.doc.mode,this.state):this.state;return this.maxLookAhead>0?new Ql(u,this.maxLookAhead):u};function W0(s,u,m,f){var y=[s.state.modeGen],S={};q0(s,u.text,s.doc.mode,m,function(A,G){return y.push(A,G)},S,f);for(var w=m.state,L=function(A){m.baseTokens=y;var G=s.state.overlays[A],$=1,Y=0;m.state=!0,q0(s,u.text,G.mode,m,function(q,ee){for(var re=$;Y<q;){var de=y[$];de>q&&y.splice($,1,q,y[$+1],de),$+=2,Y=Math.min(q,de)}if(!!ee)if(G.opaque)y.splice(re,$-re,q,"overlay "+ee),$=re+2;else for(;re<$;re+=2){var fe=y[re+1];y[re+1]=(fe?fe+" ":"")+"overlay "+ee}},S),m.state=w,m.baseTokens=null,m.baseTokenPos=1},k=0;k<s.state.overlays.length;++k)L(k);return{styles:y,classes:S.bgClass||S.textClass?S:null}}function z0(s,u,m){if(!u.styles||u.styles[0]!=s.state.modeGen){var f=Vu(s,ht(u)),y=u.text.length>s.options.maxHighlightLength&&Gr(s.doc.mode,f.state),S=W0(s,u,f);y&&(f.state=y),u.stateAfter=f.save(!y),u.styles=S.styles,S.classes?u.styleClasses=S.classes:u.styleClasses&&(u.styleClasses=null),m===s.doc.highlightFrontier&&(s.doc.modeFrontier=Math.max(s.doc.modeFrontier,++s.doc.highlightFrontier))}return u.styles}function Vu(s,u,m){var f=s.doc,y=s.display;if(!f.mode.startState)return new la(f,!0,u);var S=zN(s,u,m),w=S>f.first&&Te(f,S-1).stateAfter,L=w?la.fromSaved(f,w,S):new la(f,Mu(f.mode),S);return f.iter(S,u,function(k){Ey(s,k.text,L);var A=L.line;k.stateAfter=A==u-1||A%5==0||A>=y.viewFrom&&A<y.viewTo?L.save():null,L.nextLine()}),m&&(f.modeFrontier=L.line),L}function Ey(s,u,m,f){var y=s.doc.mode,S=new Wt(u,s.options.tabSize,m);for(S.start=S.pos=f||0,u==""&&H0(y,m.state);!S.eol();)Dy(y,S,m.state),S.start=S.pos}function H0(s,u){if(s.blankLine)return s.blankLine(u);if(!!s.innerMode){var m=Au(s,u);if(m.mode.blankLine)return m.mode.blankLine(m.state)}}function Dy(s,u,m,f){for(var y=0;y<10;y++){f&&(f[0]=Au(s,m).mode);var S=s.token(u,m);if(u.pos>u.start)return S}throw new Error("Mode "+s.name+" failed to advance stream.")}var $0=function(s,u,m){this.start=s.start,this.end=s.pos,this.string=s.current(),this.type=u||null,this.state=m};function j0(s,u,m,f){var y=s.doc,S=y.mode,w;u=ve(y,u);var L=Te(y,u.line),k=Vu(s,u.line,m),A=new Wt(L.text,s.options.tabSize,k),G;for(f&&(G=[]);(f||A.pos<u.ch)&&!A.eol();)A.start=A.pos,w=Dy(S,A,k.state),f&&G.push(new $0(A,w,Gr(y.mode,k.state)));return f?G:new $0(A,w,k.state)}function J0(s,u){if(s)for(;;){var m=s.match(/(?:^|\s+)line-(background-)?(\S+)/);if(!m)break;s=s.slice(0,m.index)+s.slice(m.index+m[0].length);var f=m[1]?"bgClass":"textClass";u[f]==null?u[f]=m[2]:new RegExp("(?:^|\\s)"+m[2]+"(?:$|\\s)").test(u[f])||(u[f]+=" "+m[2])}return s}function q0(s,u,m,f,y,S,w){var L=m.flattenSpans;L==null&&(L=s.options.flattenSpans);var k=0,A=null,G=new Wt(u,s.options.tabSize,f),$,Y=s.options.addModeClass&&[null];for(u==""&&J0(H0(m,f.state),S);!G.eol();){if(G.pos>s.options.maxHighlightLength?(L=!1,w&&Ey(s,u,f,G.pos),G.pos=u.length,$=null):$=J0(Dy(m,G,f.state,Y),S),Y){var q=Y[0].name;q&&($="m-"+($?q+" "+$:q))}if(!L||A!=$){for(;k<G.start;)k=Math.min(G.start,k+5e3),y(k,A);A=$}G.start=G.pos}for(;k<G.pos;){var ee=Math.min(G.pos,k+5e3);y(ee,A),k=ee}}function zN(s,u,m){for(var f,y,S=s.doc,w=m?-1:u-(s.doc.mode.innerMode?1e3:100),L=u;L>w;--L){if(L<=S.first)return S.first;var k=Te(S,L-1),A=k.stateAfter;if(A&&(!m||L+(A instanceof Ql?A.lookAhead:0)<=S.modeFrontier))return L;var G=Fe(k.text,null,s.options.tabSize);(y==null||f>G)&&(y=L-1,f=G)}return y}function HN(s,u){if(s.modeFrontier=Math.min(s.modeFrontier,u),!(s.highlightFrontier<u-10)){for(var m=s.first,f=u-1;f>m;f--){var y=Te(s,f).stateAfter;if(y&&(!(y instanceof Ql)||f+y.lookAhead<u)){m=f+1;break}}s.highlightFrontier=Math.min(s.highlightFrontier,m)}}var Y0=!1,Ua=!1;function $N(){Y0=!0}function jN(){Ua=!0}function uf(s,u,m){this.marker=s,this.from=u,this.to=m}function Ou(s,u){if(s)for(var m=0;m<s.length;++m){var f=s[m];if(f.marker==u)return f}}function JN(s,u){for(var m,f=0;f<s.length;++f)s[f]!=u&&(m||(m=[])).push(s[f]);return m}function qN(s,u,m){var f=m&&window.WeakSet&&(m.markedSpans||(m.markedSpans=new WeakSet));f&&f.has(s.markedSpans)?s.markedSpans.push(u):(s.markedSpans=s.markedSpans?s.markedSpans.concat([u]):[u],f&&f.add(s.markedSpans)),u.marker.attachLine(s)}function YN(s,u,m){var f;if(s)for(var y=0;y<s.length;++y){var S=s[y],w=S.marker,L=S.from==null||(w.inclusiveLeft?S.from<=u:S.from<u);if(L||S.from==u&&w.type=="bookmark"&&(!m||!S.marker.insertLeft)){var k=S.to==null||(w.inclusiveRight?S.to>=u:S.to>u);(f||(f=[])).push(new uf(w,S.from,k?null:S.to))}}return f}function KN(s,u,m){var f;if(s)for(var y=0;y<s.length;++y){var S=s[y],w=S.marker,L=S.to==null||(w.inclusiveRight?S.to>=u:S.to>u);if(L||S.from==u&&w.type=="bookmark"&&(!m||S.marker.insertLeft)){var k=S.from==null||(w.inclusiveLeft?S.from<=u:S.from<u);(f||(f=[])).push(new uf(w,k?null:S.from-u,S.to==null?null:S.to-u))}}return f}function Py(s,u){if(u.full)return null;var m=Rs(s,u.from.line)&&Te(s,u.from.line).markedSpans,f=Rs(s,u.to.line)&&Te(s,u.to.line).markedSpans;if(!m&&!f)return null;var y=u.from.ch,S=u.to.ch,w=R(u.from,u.to)==0,L=YN(m,y,w),k=KN(f,S,w),A=u.text.length==1,G=at(u.text).length+(A?y:0);if(L)for(var $=0;$<L.length;++$){var Y=L[$];if(Y.to==null){var q=Ou(k,Y.marker);q?A&&(Y.to=q.to==null?null:q.to+G):Y.to=y}}if(k)for(var ee=0;ee<k.length;++ee){var re=k[ee];if(re.to!=null&&(re.to+=G),re.from==null){var de=Ou(L,re.marker);de||(re.from=G,A&&(L||(L=[])).push(re))}else re.from+=G,A&&(L||(L=[])).push(re)}L&&(L=K0(L)),k&&k!=L&&(k=K0(k));var fe=[L];if(!A){var Se=u.text.length-2,he;if(Se>0&&L)for(var be=0;be<L.length;++be)L[be].to==null&&(he||(he=[])).push(new uf(L[be].marker,null,null));for(var Re=0;Re<Se;++Re)fe.push(he);fe.push(k)}return fe}function K0(s){for(var u=0;u<s.length;++u){var m=s[u];m.from!=null&&m.from==m.to&&m.marker.clearWhenEmpty!==!1&&s.splice(u--,1)}return s.length?s:null}function XN(s,u,m){var f=null;if(s.iter(u.line,m.line+1,function(q){if(q.markedSpans)for(var ee=0;ee<q.markedSpans.length;++ee){var re=q.markedSpans[ee].marker;re.readOnly&&(!f||ye(f,re)==-1)&&(f||(f=[])).push(re)}}),!f)return null;for(var y=[{from:u,to:m}],S=0;S<f.length;++S)for(var w=f[S],L=w.find(0),k=0;k<y.length;++k){var A=y[k];if(!(R(A.to,L.from)<0||R(A.from,L.to)>0)){var G=[k,1],$=R(A.from,L.from),Y=R(A.to,L.to);($<0||!w.inclusiveLeft&&!$)&&G.push({from:A.from,to:L.from}),(Y>0||!w.inclusiveRight&&!Y)&&G.push({from:L.to,to:A.to}),y.splice.apply(y,G),k+=G.length-3}}return y}function X0(s){var u=s.markedSpans;if(!!u){for(var m=0;m<u.length;++m)u[m].marker.detachLine(s);s.markedSpans=null}}function Q0(s,u){if(!!u){for(var m=0;m<u.length;++m)u[m].marker.attachLine(s);s.markedSpans=u}}function df(s){return s.inclusiveLeft?-1:0}function pf(s){return s.inclusiveRight?1:0}function Iy(s,u){var m=s.lines.length-u.lines.length;if(m!=0)return m;var f=s.find(),y=u.find(),S=R(f.from,y.from)||df(s)-df(u);if(S)return-S;var w=R(f.to,y.to)||pf(s)-pf(u);return w||u.id-s.id}function Z0(s,u){var m=Ua&&s.markedSpans,f;if(m)for(var y=void 0,S=0;S<m.length;++S)y=m[S],y.marker.collapsed&&(u?y.from:y.to)==null&&(!f||Iy(f,y.marker)<0)&&(f=y.marker);return f}function eT(s){return Z0(s,!0)}function ff(s){return Z0(s,!1)}function QN(s,u){var m=Ua&&s.markedSpans,f;if(m)for(var y=0;y<m.length;++y){var S=m[y];S.marker.collapsed&&(S.from==null||S.from<u)&&(S.to==null||S.to>u)&&(!f||Iy(f,S.marker)<0)&&(f=S.marker)}return f}function tT(s,u,m,f,y){var S=Te(s,u),w=Ua&&S.markedSpans;if(w)for(var L=0;L<w.length;++L){var k=w[L];if(!!k.marker.collapsed){var A=k.marker.find(0),G=R(A.from,m)||df(k.marker)-df(y),$=R(A.to,f)||pf(k.marker)-pf(y);if(!(G>=0&&$<=0||G<=0&&$>=0)&&(G<=0&&(k.marker.inclusiveRight&&y.inclusiveLeft?R(A.to,m)>=0:R(A.to,m)>0)||G>=0&&(k.marker.inclusiveRight&&y.inclusiveLeft?R(A.from,f)<=0:R(A.from,f)<0)))return!0}}}function ca(s){for(var u;u=eT(s);)s=u.find(-1,!0).line;return s}function ZN(s){for(var u;u=ff(s);)s=u.find(1,!0).line;return s}function eB(s){for(var u,m;u=ff(s);)s=u.find(1,!0).line,(m||(m=[])).push(s);return m}function Ay(s,u){var m=Te(s,u),f=ca(m);return m==f?u:ht(f)}function nT(s,u){if(u>s.lastLine())return u;var m=Te(s,u),f;if(!Eo(s,m))return u;for(;f=ff(m);)m=f.find(1,!0).line;return ht(m)+1}function Eo(s,u){var m=Ua&&u.markedSpans;if(m){for(var f=void 0,y=0;y<m.length;++y)if(f=m[y],!!f.marker.collapsed){if(f.from==null)return!0;if(!f.marker.widgetNode&&f.from==0&&f.marker.inclusiveLeft&&My(s,u,f))return!0}}}function My(s,u,m){if(m.to==null){var f=m.marker.find(1,!0);return My(s,f.line,Ou(f.line.markedSpans,m.marker))}if(m.marker.inclusiveRight&&m.to==u.text.length)return!0;for(var y=void 0,S=0;S<u.markedSpans.length;++S)if(y=u.markedSpans[S],y.marker.collapsed&&!y.marker.widgetNode&&y.from==m.to&&(y.to==null||y.to!=m.from)&&(y.marker.inclusiveLeft||m.marker.inclusiveRight)&&My(s,u,y))return!0}function Ga(s){s=ca(s);for(var u=0,m=s.parent,f=0;f<m.lines.length;++f){var y=m.lines[f];if(y==s)break;u+=y.height}for(var S=m.parent;S;m=S,S=m.parent)for(var w=0;w<S.children.length;++w){var L=S.children[w];if(L==m)break;u+=L.height}return u}function hf(s){if(s.height==0)return 0;for(var u=s.text.length,m,f=s;m=eT(f);){var y=m.find(0,!0);f=y.from.line,u+=y.from.ch-y.to.ch}for(f=s;m=ff(f);){var S=m.find(0,!0);u-=f.text.length-S.from.ch,f=S.to.line,u+=f.text.length-S.to.ch}return u}function Ry(s){var u=s.display,m=s.doc;u.maxLine=Te(m,m.first),u.maxLineLength=hf(u.maxLine),u.maxLineChanged=!0,m.iter(function(f){var y=hf(f);y>u.maxLineLength&&(u.maxLineLength=y,u.maxLine=f)})}var Zl=function(s,u,m){this.text=s,Q0(this,u),this.height=m?m(this):1};Zl.prototype.lineNo=function(){return ht(this)},ia(Zl);function tB(s,u,m,f){s.text=u,s.stateAfter&&(s.stateAfter=null),s.styles&&(s.styles=null),s.order!=null&&(s.order=null),X0(s),Q0(s,m);var y=f?f(s):1;y!=s.height&&kr(s,y)}function nB(s){s.parent=null,X0(s)}var rB={},iB={};function rT(s,u){if(!s||/^\s*$/.test(s))return null;var m=u.addModeClass?iB:rB;return m[s]||(m[s]=s.replace(/\S+/g,"cm-$&"))}function iT(s,u){var m=N("span",null,null,c?"padding-right: .1px":null),f={pre:N("pre",[m],"CodeMirror-line"),content:m,col:0,pos:0,cm:s,trailingSpace:!1,splitSpaces:s.getOption("lineWrapping")};u.measure={};for(var y=0;y<=(u.rest?u.rest.length:0);y++){var S=y?u.rest[y-1]:u.line,w=void 0;f.pos=0,f.addToken=oB,aa(s.display.measure)&&(w=Lr(S,s.doc.direction))&&(f.addToken=lB(f.addToken,w)),f.map=[];var L=u!=s.display.externalMeasured&&ht(S);cB(S,f,z0(s,S,L)),S.styleClasses&&(S.styleClasses.bgClass&&(f.bgClass=Ae(S.styleClasses.bgClass,f.bgClass||"")),S.styleClasses.textClass&&(f.textClass=Ae(S.styleClasses.textClass,f.textClass||""))),f.map.length==0&&f.map.push(0,0,f.content.appendChild(of(s.display.measure))),y==0?(u.measure.map=f.map,u.measure.cache={}):((u.measure.maps||(u.measure.maps=[])).push(f.map),(u.measure.caches||(u.measure.caches=[])).push({}))}if(c){var k=f.content.lastChild;(/\bcm-tab\b/.test(k.className)||k.querySelector&&k.querySelector(".cm-tab"))&&(f.content.className="cm-tab-wrap-hack")}return Ue(s,"renderLine",s,u.line,f.pre),f.pre.className&&(f.textClass=Ae(f.pre.className,f.textClass||"")),f}function aB(s){var u=F("span","\u2022","cm-invalidchar");return u.title="\\u"+s.charCodeAt(0).toString(16),u.setAttribute("aria-label",u.title),u}function oB(s,u,m,f,y,S,w){if(!!u){var L=s.splitSpaces?sB(u,s.trailingSpace):u,k=s.cm.state.specialChars,A=!1,G;if(!k.test(u))s.col+=u.length,G=document.createTextNode(L),s.map.push(s.pos,s.pos+u.length,G),o&&l<9&&(A=!0),s.pos+=u.length;else{G=document.createDocumentFragment();for(var $=0;;){k.lastIndex=$;var Y=k.exec(u),q=Y?Y.index-$:u.length-$;if(q){var ee=document.createTextNode(L.slice($,$+q));o&&l<9?G.appendChild(F("span",[ee])):G.appendChild(ee),s.map.push(s.pos,s.pos+q,ee),s.col+=q,s.pos+=q}if(!Y)break;$+=q+1;var re=void 0;if(Y[0]=="	"){var de=s.cm.options.tabSize,fe=de-s.col%de;re=G.appendChild(F("span",Zi(fe),"cm-tab")),re.setAttribute("role","presentation"),re.setAttribute("cm-text","	"),s.col+=fe}else Y[0]=="\r"||Y[0]==`
`?(re=G.appendChild(F("span",Y[0]=="\r"?"\u240D":"\u2424","cm-invalidchar")),re.setAttribute("cm-text",Y[0]),s.col+=1):(re=s.cm.options.specialCharPlaceholder(Y[0]),re.setAttribute("cm-text",Y[0]),o&&l<9?G.appendChild(F("span",[re])):G.appendChild(re),s.col+=1);s.map.push(s.pos,s.pos+1,re),s.pos++}}if(s.trailingSpace=L.charCodeAt(u.length-1)==32,m||f||y||A||S||w){var Se=m||"";f&&(Se+=f),y&&(Se+=y);var he=F("span",[G],Se,S);if(w)for(var be in w)w.hasOwnProperty(be)&&be!="style"&&be!="class"&&he.setAttribute(be,w[be]);return s.content.appendChild(he)}s.content.appendChild(G)}}function sB(s,u){if(s.length>1&&!/  /.test(s))return s;for(var m=u,f="",y=0;y<s.length;y++){var S=s.charAt(y);S==" "&&m&&(y==s.length-1||s.charCodeAt(y+1)==32)&&(S="\xA0"),f+=S,m=S==" "}return f}function lB(s,u){return function(m,f,y,S,w,L,k){y=y?y+" cm-force-border":"cm-force-border";for(var A=m.pos,G=A+f.length;;){for(var $=void 0,Y=0;Y<u.length&&($=u[Y],!($.to>A&&$.from<=A));Y++);if($.to>=G)return s(m,f,y,S,w,L,k);s(m,f.slice(0,$.to-A),y,S,null,L,k),S=null,f=f.slice($.to-A),A=$.to}}}function aT(s,u,m,f){var y=!f&&m.widgetNode;y&&s.map.push(s.pos,s.pos+u,y),!f&&s.cm.display.input.needsContentAttribute&&(y||(y=s.content.appendChild(document.createElement("span"))),y.setAttribute("cm-marker",m.id)),y&&(s.cm.display.input.setUneditable(y),s.content.appendChild(y)),s.pos+=u,s.trailingSpace=!1}function cB(s,u,m){var f=s.markedSpans,y=s.text,S=0;if(!f){for(var w=1;w<m.length;w+=2)u.addToken(u,y.slice(S,S=m[w]),rT(m[w+1],u.cm.options));return}for(var L=y.length,k=0,A=1,G="",$,Y,q=0,ee,re,de,fe,Se;;){if(q==k){ee=re=de=Y="",Se=null,fe=null,q=Infinity;for(var he=[],be=void 0,Re=0;Re<f.length;++Re){var De=f[Re],Ze=De.marker;if(Ze.type=="bookmark"&&De.from==k&&Ze.widgetNode)he.push(Ze);else if(De.from<=k&&(De.to==null||De.to>k||Ze.collapsed&&De.to==k&&De.from==k)){if(De.to!=null&&De.to!=k&&q>De.to&&(q=De.to,re=""),Ze.className&&(ee+=" "+Ze.className),Ze.css&&(Y=(Y?Y+";":"")+Ze.css),Ze.startStyle&&De.from==k&&(de+=" "+Ze.startStyle),Ze.endStyle&&De.to==q&&(be||(be=[])).push(Ze.endStyle,De.to),Ze.title&&((Se||(Se={})).title=Ze.title),Ze.attributes)for(var Tt in Ze.attributes)(Se||(Se={}))[Tt]=Ze.attributes[Tt];Ze.collapsed&&(!fe||Iy(fe.marker,Ze)<0)&&(fe=De)}else De.from>k&&q>De.from&&(q=De.from)}if(be)for(var gn=0;gn<be.length;gn+=2)be[gn+1]==q&&(re+=" "+be[gn]);if(!fe||fe.from==k)for(var Ut=0;Ut<he.length;++Ut)aT(u,0,he[Ut]);if(fe&&(fe.from||0)==k){if(aT(u,(fe.to==null?L+1:fe.to)-k,fe.marker,fe.from==null),fe.to==null)return;fe.to==k&&(fe=!1)}}if(k>=L)break;for(var Dr=Math.min(L,q);;){if(G){var dr=k+G.length;if(!fe){var en=dr>Dr?G.slice(0,Dr-k):G;u.addToken(u,en,$?$+ee:ee,de,k+en.length==q?re:"",Y,Se)}if(dr>=Dr){G=G.slice(Dr-k),k=Dr;break}k=dr,de=""}G=y.slice(S,S=m[A++]),$=rT(m[A++],u.cm.options)}}}function oT(s,u,m){this.line=u,this.rest=eB(u),this.size=this.rest?ht(at(this.rest))-m+1:1,this.node=this.text=null,this.hidden=Eo(s,u)}function mf(s,u,m){for(var f=[],y,S=u;S<m;S=y){var w=new oT(s.doc,Te(s.doc,S),S);y=S+w.size,f.push(w)}return f}var ec=null;function uB(s){ec?ec.ops.push(s):s.ownsGroup=ec={ops:[s],delayedCallbacks:[]}}function dB(s){var u=s.delayedCallbacks,m=0;do{for(;m<u.length;m++)u[m].call(null);for(var f=0;f<s.ops.length;f++){var y=s.ops[f];if(y.cursorActivityHandlers)for(;y.cursorActivityCalled<y.cursorActivityHandlers.length;)y.cursorActivityHandlers[y.cursorActivityCalled++].call(null,y.cm)}}while(m<u.length)}function pB(s,u){var m=s.ownsGroup;if(!!m)try{dB(m)}finally{ec=null,u(m)}}var Nu=null;function fn(s,u){var m=Jl(s,u);if(!!m.length){var f=Array.prototype.slice.call(arguments,2),y;ec?y=ec.delayedCallbacks:Nu?y=Nu:(y=Nu=[],setTimeout(fB,0));for(var S=function(L){y.push(function(){return m[L].apply(null,f)})},w=0;w<m.length;++w)S(w)}}function fB(){var s=Nu;Nu=null;for(var u=0;u<s.length;++u)s[u]()}function sT(s,u,m,f){for(var y=0;y<u.changes.length;y++){var S=u.changes[y];S=="text"?mB(s,u):S=="gutter"?cT(s,u,m,f):S=="class"?_y(s,u):S=="widget"&&gB(s,u,f)}u.changes=null}function Bu(s){return s.node==s.text&&(s.node=F("div",null,null,"position: relative"),s.text.parentNode&&s.text.parentNode.replaceChild(s.node,s.text),s.node.appendChild(s.text),o&&l<8&&(s.node.style.zIndex=2)),s.node}function hB(s,u){var m=u.bgClass?u.bgClass+" "+(u.line.bgClass||""):u.line.bgClass;if(m&&(m+=" CodeMirror-linebackground"),u.background)m?u.background.className=m:(u.background.parentNode.removeChild(u.background),u.background=null);else if(m){var f=Bu(u);u.background=f.insertBefore(F("div",null,m),f.firstChild),s.display.input.setUneditable(u.background)}}function lT(s,u){var m=s.display.externalMeasured;return m&&m.line==u.line?(s.display.externalMeasured=null,u.measure=m.measure,m.built):iT(s,u)}function mB(s,u){var m=u.text.className,f=lT(s,u);u.text==u.node&&(u.node=f.pre),u.text.parentNode.replaceChild(f.pre,u.text),u.text=f.pre,f.bgClass!=u.bgClass||f.textClass!=u.textClass?(u.bgClass=f.bgClass,u.textClass=f.textClass,_y(s,u)):m&&(u.text.className=m)}function _y(s,u){hB(s,u),u.line.wrapClass?Bu(u).className=u.line.wrapClass:u.node!=u.text&&(u.node.className="");var m=u.textClass?u.textClass+" "+(u.line.textClass||""):u.line.textClass;u.text.className=m||""}function cT(s,u,m,f){if(u.gutter&&(u.node.removeChild(u.gutter),u.gutter=null),u.gutterBackground&&(u.node.removeChild(u.gutterBackground),u.gutterBackground=null),u.line.gutterClass){var y=Bu(u);u.gutterBackground=F("div",null,"CodeMirror-gutter-background "+u.line.gutterClass,"left: "+(s.options.fixedGutter?f.fixedPos:-f.gutterTotalWidth)+"px; width: "+f.gutterTotalWidth+"px"),s.display.input.setUneditable(u.gutterBackground),y.insertBefore(u.gutterBackground,u.text)}var S=u.line.gutterMarkers;if(s.options.lineNumbers||S){var w=Bu(u),L=u.gutter=F("div",null,"CodeMirror-gutter-wrapper","left: "+(s.options.fixedGutter?f.fixedPos:-f.gutterTotalWidth)+"px");if(L.setAttribute("aria-hidden","true"),s.display.input.setUneditable(L),w.insertBefore(L,u.text),u.line.gutterClass&&(L.className+=" "+u.line.gutterClass),s.options.lineNumbers&&(!S||!S["CodeMirror-linenumbers"])&&(u.lineNumber=L.appendChild(F("div",_u(s.options,m),"CodeMirror-linenumber CodeMirror-gutter-elt","left: "+f.gutterLeft["CodeMirror-linenumbers"]+"px; width: "+s.display.lineNumInnerWidth+"px"))),S)for(var k=0;k<s.display.gutterSpecs.length;++k){var A=s.display.gutterSpecs[k].className,G=S.hasOwnProperty(A)&&S[A];G&&L.appendChild(F("div",[G],"CodeMirror-gutter-elt","left: "+f.gutterLeft[A]+"px; width: "+f.gutterWidth[A]+"px"))}}}function gB(s,u,m){u.alignable&&(u.alignable=null);for(var f=O("CodeMirror-linewidget"),y=u.node.firstChild,S=void 0;y;y=S)S=y.nextSibling,f.test(y.className)&&u.node.removeChild(y);uT(s,u,m)}function yB(s,u,m,f){var y=lT(s,u);return u.text=u.node=y.pre,y.bgClass&&(u.bgClass=y.bgClass),y.textClass&&(u.textClass=y.textClass),_y(s,u),cT(s,u,m,f),uT(s,u,f),u.node}function uT(s,u,m){if(dT(s,u.line,u,m,!0),u.rest)for(var f=0;f<u.rest.length;f++)dT(s,u.rest[f],u,m,!1)}function dT(s,u,m,f,y){if(!!u.widgets)for(var S=Bu(m),w=0,L=u.widgets;w<L.length;++w){var k=L[w],A=F("div",[k.node],"CodeMirror-linewidget"+(k.className?" "+k.className:""));k.handleMouseEvents||A.setAttribute("cm-ignore-events","true"),vB(k,A,m,f),s.display.input.setUneditable(A),y&&k.above?S.insertBefore(A,m.gutter||m.text):S.appendChild(A),fn(k,"redraw")}}function vB(s,u,m,f){if(s.noHScroll){(m.alignable||(m.alignable=[])).push(u);var y=f.wrapperWidth;u.style.left=f.fixedPos+"px",s.coverGutter||(y-=f.gutterTotalWidth,u.style.paddingLeft=f.gutterTotalWidth+"px"),u.style.width=y+"px"}s.coverGutter&&(u.style.zIndex=5,u.style.position="relative",s.noHScroll||(u.style.marginLeft=-f.gutterTotalWidth+"px"))}function Fu(s){if(s.height!=null)return s.height;var u=s.doc.cm;if(!u)return 0;if(!ae(document.body,s.node)){var m="position: relative;";s.coverGutter&&(m+="margin-left: -"+u.display.gutters.offsetWidth+"px;"),s.noHScroll&&(m+="width: "+u.display.wrapper.clientWidth+"px;"),_(u.display.measure,F("div",[s.node],null,m))}return s.height=s.node.parentNode.offsetHeight}function Wa(s,u){for(var m=Lo(u);m!=s.wrapper;m=m.parentNode)if(!m||m.nodeType==1&&m.getAttribute("cm-ignore-events")=="true"||m.parentNode==s.sizer&&m!=s.mover)return!0}function gf(s){return s.lineSpace.offsetTop}function Vy(s){return s.mover.offsetHeight-s.lineSpace.offsetHeight}function pT(s){if(s.cachedPaddingH)return s.cachedPaddingH;var u=_(s.measure,F("pre","x","CodeMirror-line-like")),m=window.getComputedStyle?window.getComputedStyle(u):u.currentStyle,f={left:parseInt(m.paddingLeft),right:parseInt(m.paddingRight)};return!isNaN(f.left)&&!isNaN(f.right)&&(s.cachedPaddingH=f),f}function ua(s){return Le-s.display.nativeBarWidth}function _s(s){return s.display.scroller.clientWidth-ua(s)-s.display.barWidth}function Oy(s){return s.display.scroller.clientHeight-ua(s)-s.display.barHeight}function SB(s,u,m){var f=s.options.lineWrapping,y=f&&_s(s);if(!u.measure.heights||f&&u.measure.width!=y){var S=u.measure.heights=[];if(f){u.measure.width=y;for(var w=u.text.firstChild.getClientRects(),L=0;L<w.length-1;L++){var k=w[L],A=w[L+1];Math.abs(k.bottom-A.bottom)>2&&S.push((k.bottom+A.top)/2-m.top)}}S.push(m.bottom-m.top)}}function fT(s,u,m){if(s.line==u)return{map:s.measure.map,cache:s.measure.cache};for(var f=0;f<s.rest.length;f++)if(s.rest[f]==u)return{map:s.measure.maps[f],cache:s.measure.caches[f]};for(var y=0;y<s.rest.length;y++)if(ht(s.rest[y])>m)return{map:s.measure.maps[y],cache:s.measure.caches[y],before:!0}}function bB(s,u){u=ca(u);var m=ht(u),f=s.display.externalMeasured=new oT(s.doc,u,m);f.lineN=m;var y=f.built=iT(s,f);return f.text=y.pre,_(s.display.lineMeasure,y.pre),f}function hT(s,u,m,f){return da(s,tc(s,u),m,f)}function Ny(s,u){if(u>=s.display.viewFrom&&u<s.display.viewTo)return s.display.view[Ns(s,u)];var m=s.display.externalMeasured;if(m&&u>=m.lineN&&u<m.lineN+m.size)return m}function tc(s,u){var m=ht(u),f=Ny(s,m);f&&!f.text?f=null:f&&f.changes&&(sT(s,f,m,zy(s)),s.curOp.forceUpdate=!0),f||(f=bB(s,u));var y=fT(f,u,m);return{line:u,view:f,rect:null,map:y.map,cache:y.cache,before:y.before,hasHeights:!1}}function da(s,u,m,f,y){u.before&&(m=-1);var S=m+(f||""),w;return u.cache.hasOwnProperty(S)?w=u.cache[S]:(u.rect||(u.rect=u.view.text.getBoundingClientRect()),u.hasHeights||(SB(s,u.view,u.rect),u.hasHeights=!0),w=CB(s,u,m,f),w.bogus||(u.cache[S]=w)),{left:w.left,right:w.right,top:y?w.rtop:w.top,bottom:y?w.rbottom:w.bottom}}var mT={left:0,right:0,top:0,bottom:0};function gT(s,u,m){for(var f,y,S,w,L,k,A=0;A<s.length;A+=3)if(L=s[A],k=s[A+1],u<L?(y=0,S=1,w="left"):u<k?(y=u-L,S=y+1):(A==s.length-3||u==k&&s[A+3]>u)&&(S=k-L,y=S-1,u>=k&&(w="right")),y!=null){if(f=s[A+2],L==k&&m==(f.insertLeft?"left":"right")&&(w=m),m=="left"&&y==0)for(;A&&s[A-2]==s[A-3]&&s[A-1].insertLeft;)f=s[(A-=3)+2],w="left";if(m=="right"&&y==k-L)for(;A<s.length-3&&s[A+3]==s[A+4]&&!s[A+5].insertLeft;)f=s[(A+=3)+2],w="right";break}return{node:f,start:y,end:S,collapse:w,coverStart:L,coverEnd:k}}function xB(s,u){var m=mT;if(u=="left")for(var f=0;f<s.length&&(m=s[f]).left==m.right;f++);else for(var y=s.length-1;y>=0&&(m=s[y]).left==m.right;y--);return m}function CB(s,u,m,f){var y=gT(u.map,m,f),S=y.node,w=y.start,L=y.end,k=y.collapse,A;if(S.nodeType==3){for(var G=0;G<4;G++){for(;w&&jl(u.line.text.charAt(y.coverStart+w));)--w;for(;y.coverStart+L<y.coverEnd&&jl(u.line.text.charAt(y.coverStart+L));)++L;if(o&&l<9&&w==0&&L==y.coverEnd-y.coverStart?A=S.parentNode.getBoundingClientRect():A=xB(J(S,w,L).getClientRects(),f),A.left||A.right||w==0)break;L=w,w=w-1,k="right"}o&&l<11&&(A=wB(s.display.measure,A))}else{w>0&&(k=f="right");var $;s.options.lineWrapping&&($=S.getClientRects()).length>1?A=$[f=="right"?$.length-1:0]:A=S.getBoundingClientRect()}if(o&&l<9&&!w&&(!A||!A.left&&!A.right)){var Y=S.parentNode.getClientRects()[0];Y?A={left:Y.left,right:Y.left+rc(s.display),top:Y.top,bottom:Y.bottom}:A=mT}for(var q=A.top-u.rect.top,ee=A.bottom-u.rect.top,re=(q+ee)/2,de=u.view.measure.heights,fe=0;fe<de.length-1&&!(re<de[fe]);fe++);var Se=fe?de[fe-1]:0,he=de[fe],be={left:(k=="right"?A.right:A.left)-u.rect.left,right:(k=="left"?A.left:A.right)-u.rect.left,top:Se,bottom:he};return!A.left&&!A.right&&(be.bogus=!0),s.options.singleCursorHeightPerLine||(be.rtop=q,be.rbottom=ee),be}function wB(s,u){if(!window.screen||screen.logicalXDPI==null||screen.logicalXDPI==screen.deviceXDPI||!ko(s))return u;var m=screen.logicalXDPI/screen.deviceXDPI,f=screen.logicalYDPI/screen.deviceYDPI;return{left:u.left*m,right:u.right*m,top:u.top*f,bottom:u.bottom*f}}function yT(s){if(s.measure&&(s.measure.cache={},s.measure.heights=null,s.rest))for(var u=0;u<s.rest.length;u++)s.measure.caches[u]={}}function vT(s){s.display.externalMeasure=null,z(s.display.lineMeasure);for(var u=0;u<s.display.view.length;u++)yT(s.display.view[u])}function Uu(s){vT(s),s.display.cachedCharWidth=s.display.cachedTextHeight=s.display.cachedPaddingH=null,s.options.lineWrapping||(s.display.maxLineChanged=!0),s.display.lineNumChars=null}function ST(){return p&&C?-(document.body.getBoundingClientRect().left-parseInt(getComputedStyle(document.body).marginLeft)):window.pageXOffset||(document.documentElement||document.body).scrollLeft}function bT(){return p&&C?-(document.body.getBoundingClientRect().top-parseInt(getComputedStyle(document.body).marginTop)):window.pageYOffset||(document.documentElement||document.body).scrollTop}function By(s){var u=0;if(s.widgets)for(var m=0;m<s.widgets.length;++m)s.widgets[m].above&&(u+=Fu(s.widgets[m]));return u}function yf(s,u,m,f,y){if(!y){var S=By(u);m.top+=S,m.bottom+=S}if(f=="line")return m;f||(f="local");var w=Ga(u);if(f=="local"?w+=gf(s.display):w-=s.display.viewOffset,f=="page"||f=="window"){var L=s.display.lineSpace.getBoundingClientRect();w+=L.top+(f=="window"?0:bT());var k=L.left+(f=="window"?0:ST());m.left+=k,m.right+=k}return m.top+=w,m.bottom+=w,m}function xT(s,u,m){if(m=="div")return u;var f=u.left,y=u.top;if(m=="page")f-=ST(),y-=bT();else if(m=="local"||!m){var S=s.display.sizer.getBoundingClientRect();f+=S.left,y+=S.top}var w=s.display.lineSpace.getBoundingClientRect();return{left:f-w.left,top:y-w.top}}function Fy(s,u,m,f,y){return f||(f=Te(s.doc,u.line)),yf(s,f,hT(s,f,u.ch,y),m)}function ki(s,u,m,f,y,S){f=f||Te(s.doc,u.line),y||(y=tc(s,f));function w(ee,re){var de=da(s,y,ee,re?"right":"left",S);return re?de.left=de.right:de.right=de.left,yf(s,f,de,m)}var L=Lr(f,s.doc.direction),k=u.ch,A=u.sticky;if(k>=f.text.length?(k=f.text.length,A="before"):k<=0&&(k=0,A="after"),!L)return w(A=="before"?k-1:k,A=="before");function G(ee,re,de){var fe=L[re],Se=fe.level==1;return w(de?ee-1:ee,Se!=de)}var $=Dt(L,k,A),Y=or,q=G(k,$,A=="before");return Y!=null&&(q.other=G(k,Y,A!="before")),q}function CT(s,u){var m=0;u=ve(s.doc,u),s.options.lineWrapping||(m=rc(s.display)*u.ch);var f=Te(s.doc,u.line),y=Ga(f)+gf(s.display);return{left:m,right:m,top:y,bottom:y+f.height}}function Uy(s,u,m,f,y){var S=se(s,u,m);return S.xRel=y,f&&(S.outside=f),S}function Gy(s,u,m){var f=s.doc;if(m+=s.display.viewOffset,m<0)return Uy(f.first,0,null,-1,-1);var y=sa(f,m),S=f.first+f.size-1;if(y>S)return Uy(f.first+f.size-1,Te(f,S).text.length,null,1,1);u<0&&(u=0);for(var w=Te(f,y);;){var L=TB(s,w,y,u,m),k=QN(w,L.ch+(L.xRel>0||L.outside>0?1:0));if(!k)return L;var A=k.find(1);if(A.line==y)return A;w=Te(f,y=A.line)}}function wT(s,u,m,f){f-=By(u);var y=u.text.length,S=Nn(function(w){return da(s,m,w-1).bottom<=f},y,0);return y=Nn(function(w){return da(s,m,w).top>f},S,y),{begin:S,end:y}}function TT(s,u,m,f){m||(m=tc(s,u));var y=yf(s,u,da(s,m,f),"line").top;return wT(s,u,m,y)}function Wy(s,u,m,f){return s.bottom<=m?!1:s.top>m?!0:(f?s.left:s.right)>u}function TB(s,u,m,f,y){y-=Ga(u);var S=tc(s,u),w=By(u),L=0,k=u.text.length,A=!0,G=Lr(u,s.doc.direction);if(G){var $=(s.options.lineWrapping?kB:LB)(s,u,m,S,G,f,y);A=$.level!=1,L=A?$.from:$.to-1,k=A?$.to:$.from-1}var Y=null,q=null,ee=Nn(function(Re){var De=da(s,S,Re);return De.top+=w,De.bottom+=w,Wy(De,f,y,!1)?(De.top<=y&&De.left<=f&&(Y=Re,q=De),!0):!1},L,k),re,de,fe=!1;if(q){var Se=f-q.left<q.right-f,he=Se==A;ee=Y+(he?0:1),de=he?"after":"before",re=Se?q.left:q.right}else{!A&&(ee==k||ee==L)&&ee++,de=ee==0?"after":ee==u.text.length?"before":da(s,S,ee-(A?1:0)).bottom+w<=y==A?"after":"before";var be=ki(s,se(m,ee,de),"line",u,S);re=be.left,fe=y<be.top?-1:y>=be.bottom?1:0}return ee=To(u.text,ee,1),Uy(m,ee,de,fe,f-re)}function LB(s,u,m,f,y,S,w){var L=Nn(function($){var Y=y[$],q=Y.level!=1;return Wy(ki(s,se(m,q?Y.to:Y.from,q?"before":"after"),"line",u,f),S,w,!0)},0,y.length-1),k=y[L];if(L>0){var A=k.level!=1,G=ki(s,se(m,A?k.from:k.to,A?"after":"before"),"line",u,f);Wy(G,S,w,!0)&&G.top>w&&(k=y[L-1])}return k}function kB(s,u,m,f,y,S,w){var L=wT(s,u,f,w),k=L.begin,A=L.end;/\s/.test(u.text.charAt(A-1))&&A--;for(var G=null,$=null,Y=0;Y<y.length;Y++){var q=y[Y];if(!(q.from>=A||q.to<=k)){var ee=q.level!=1,re=da(s,f,ee?Math.min(A,q.to)-1:Math.max(k,q.from)).right,de=re<S?S-re+1e9:re-S;(!G||$>de)&&(G=q,$=de)}}return G||(G=y[y.length-1]),G.from<k&&(G={from:k,to:G.to,level:G.level}),G.to>A&&(G={from:G.from,to:A,level:G.level}),G}var Vs;function nc(s){if(s.cachedTextHeight!=null)return s.cachedTextHeight;if(Vs==null){Vs=F("pre",null,"CodeMirror-line-like");for(var u=0;u<49;++u)Vs.appendChild(document.createTextNode("x")),Vs.appendChild(F("br"));Vs.appendChild(document.createTextNode("x"))}_(s.measure,Vs);var m=Vs.offsetHeight/50;return m>3&&(s.cachedTextHeight=m),z(s.measure),m||1}function rc(s){if(s.cachedCharWidth!=null)return s.cachedCharWidth;var u=F("span","xxxxxxxxxx"),m=F("pre",[u],"CodeMirror-line-like");_(s.measure,m);var f=u.getBoundingClientRect(),y=(f.right-f.left)/10;return y>2&&(s.cachedCharWidth=y),y||10}function zy(s){for(var u=s.display,m={},f={},y=u.gutters.clientLeft,S=u.gutters.firstChild,w=0;S;S=S.nextSibling,++w){var L=s.display.gutterSpecs[w].className;m[L]=S.offsetLeft+S.clientLeft+y,f[L]=S.clientWidth}return{fixedPos:Hy(u),gutterTotalWidth:u.gutters.offsetWidth,gutterLeft:m,gutterWidth:f,wrapperWidth:u.wrapper.clientWidth}}function Hy(s){return s.scroller.getBoundingClientRect().left-s.sizer.getBoundingClientRect().left}function LT(s){var u=nc(s.display),m=s.options.lineWrapping,f=m&&Math.max(5,s.display.scroller.clientWidth/rc(s.display)-3);return function(y){if(Eo(s.doc,y))return 0;var S=0;if(y.widgets)for(var w=0;w<y.widgets.length;w++)y.widgets[w].height&&(S+=y.widgets[w].height);return m?S+(Math.ceil(y.text.length/f)||1)*u:S+u}}function $y(s){var u=s.doc,m=LT(s);u.iter(function(f){var y=m(f);y!=f.height&&kr(f,y)})}function Os(s,u,m,f){var y=s.display;if(!m&&Lo(u).getAttribute("cm-not-content")=="true")return null;var S,w,L=y.lineSpace.getBoundingClientRect();try{S=u.clientX-L.left,w=u.clientY-L.top}catch($){return null}var k=Gy(s,S,w),A;if(f&&k.xRel>0&&(A=Te(s.doc,k.line).text).length==k.ch){var G=Fe(A,A.length,s.options.tabSize)-A.length;k=se(k.line,Math.max(0,Math.round((S-pT(s.display).left)/rc(s.display))-G))}return k}function Ns(s,u){if(u>=s.display.viewTo||(u-=s.display.viewFrom,u<0))return null;for(var m=s.display.view,f=0;f<m.length;f++)if(u-=m[f].size,u<0)return f}function cr(s,u,m,f){u==null&&(u=s.doc.first),m==null&&(m=s.doc.first+s.doc.size),f||(f=0);var y=s.display;if(f&&m<y.viewTo&&(y.updateLineNumbers==null||y.updateLineNumbers>u)&&(y.updateLineNumbers=u),s.curOp.viewChanged=!0,u>=y.viewTo)Ua&&Ay(s.doc,u)<y.viewTo&&Po(s);else if(m<=y.viewFrom)Ua&&nT(s.doc,m+f)>y.viewFrom?Po(s):(y.viewFrom+=f,y.viewTo+=f);else if(u<=y.viewFrom&&m>=y.viewTo)Po(s);else if(u<=y.viewFrom){var S=vf(s,m,m+f,1);S?(y.view=y.view.slice(S.index),y.viewFrom=S.lineN,y.viewTo+=f):Po(s)}else if(m>=y.viewTo){var w=vf(s,u,u,-1);w?(y.view=y.view.slice(0,w.index),y.viewTo=w.lineN):Po(s)}else{var L=vf(s,u,u,-1),k=vf(s,m,m+f,1);L&&k?(y.view=y.view.slice(0,L.index).concat(mf(s,L.lineN,k.lineN)).concat(y.view.slice(k.index)),y.viewTo+=f):Po(s)}var A=y.externalMeasured;A&&(m<A.lineN?A.lineN+=f:u<A.lineN+A.size&&(y.externalMeasured=null))}function Do(s,u,m){s.curOp.viewChanged=!0;var f=s.display,y=s.display.externalMeasured;if(y&&u>=y.lineN&&u<y.lineN+y.size&&(f.externalMeasured=null),!(u<f.viewFrom||u>=f.viewTo)){var S=f.view[Ns(s,u)];if(S.node!=null){var w=S.changes||(S.changes=[]);ye(w,m)==-1&&w.push(m)}}}function Po(s){s.display.viewFrom=s.display.viewTo=s.doc.first,s.display.view=[],s.display.viewOffset=0}function vf(s,u,m,f){var y=Ns(s,u),S,w=s.display.view;if(!Ua||m==s.doc.first+s.doc.size)return{index:y,lineN:m};for(var L=s.display.viewFrom,k=0;k<y;k++)L+=w[k].size;if(L!=u){if(f>0){if(y==w.length-1)return null;S=L+w[y].size-u,y++}else S=L-u;u+=S,m+=S}for(;Ay(s.doc,m)!=m;){if(y==(f<0?0:w.length-1))return null;m+=f*w[y-(f<0?1:0)].size,y+=f}return{index:y,lineN:m}}function EB(s,u,m){var f=s.display,y=f.view;y.length==0||u>=f.viewTo||m<=f.viewFrom?(f.view=mf(s,u,m),f.viewFrom=u):(f.viewFrom>u?f.view=mf(s,u,f.viewFrom).concat(f.view):f.viewFrom<u&&(f.view=f.view.slice(Ns(s,u))),f.viewFrom=u,f.viewTo<m?f.view=f.view.concat(mf(s,f.viewTo,m)):f.viewTo>m&&(f.view=f.view.slice(0,Ns(s,m)))),f.viewTo=m}function kT(s){for(var u=s.display.view,m=0,f=0;f<u.length;f++){var y=u[f];!y.hidden&&(!y.node||y.changes)&&++m}return m}function Gu(s){s.display.input.showSelection(s.display.input.prepareSelection())}function ET(s,u){u===void 0&&(u=!0);for(var m=s.doc,f={},y=f.cursors=document.createDocumentFragment(),S=f.selection=document.createDocumentFragment(),w=0;w<m.sel.ranges.length;w++)if(!(!u&&w==m.sel.primIndex)){var L=m.sel.ranges[w];if(!(L.from().line>=s.display.viewTo||L.to().line<s.display.viewFrom)){var k=L.empty();(k||s.options.showCursorWhenSelecting)&&DT(s,L.head,y),k||DB(s,L,S)}}return f}function DT(s,u,m){var f=ki(s,u,"div",null,null,!s.options.singleCursorHeightPerLine),y=m.appendChild(F("div","\xA0","CodeMirror-cursor"));if(y.style.left=f.left+"px",y.style.top=f.top+"px",y.style.height=Math.max(0,f.bottom-f.top)*s.options.cursorHeight+"px",f.other){var S=m.appendChild(F("div","\xA0","CodeMirror-cursor CodeMirror-secondarycursor"));S.style.display="",S.style.left=f.other.left+"px",S.style.top=f.other.top+"px",S.style.height=(f.other.bottom-f.other.top)*.85+"px"}}function Sf(s,u){return s.top-u.top||s.left-u.left}function DB(s,u,m){var f=s.display,y=s.doc,S=document.createDocumentFragment(),w=pT(s.display),L=w.left,k=Math.max(f.sizerWidth,_s(s)-f.sizer.offsetLeft)-w.right,A=y.direction=="ltr";function G(he,be,Re,De){be<0&&(be=0),be=Math.round(be),De=Math.round(De),S.appendChild(F("div",null,"CodeMirror-selected","position: absolute; left: "+he+`px;
                             top: `+be+"px; width: "+(Re==null?k-he:Re)+`px;
                             height: `+(De-be)+"px"))}function $(he,be,Re){var De=Te(y,he),Ze=De.text.length,Tt,gn;function Ut(en,pr){return Fy(s,se(he,en),"div",De,pr)}function Dr(en,pr,In){var rn=TT(s,De,null,en),tn=pr=="ltr"==(In=="after")?"left":"right",zt=In=="after"?rn.begin:rn.end-(/\s/.test(De.text.charAt(rn.end-1))?2:1);return Ut(zt,tn)[tn]}var dr=Lr(De,y.direction);return ku(dr,be||0,Re==null?Ze:Re,function(en,pr,In,rn){var tn=In=="ltr",zt=Ut(en,tn?"left":"right"),fr=Ut(pr-1,tn?"right":"left"),gc=be==null&&en==0,Vo=Re==null&&pr==Ze,Gn=rn==0,pa=!dr||rn==dr.length-1;if(fr.top-zt.top<=3){var yn=(A?gc:Vo)&&Gn,yv=(A?Vo:gc)&&pa,Ha=yn?L:(tn?zt:fr).left,Ws=yv?k:(tn?fr:zt).right;G(Ha,zt.top,Ws-Ha,zt.bottom)}else{var zs,Xn,yc,vv;tn?(zs=A&&gc&&Gn?L:zt.left,Xn=A?k:Dr(en,In,"before"),yc=A?L:Dr(pr,In,"after"),vv=A&&Vo&&pa?k:fr.right):(zs=A?Dr(en,In,"before"):L,Xn=!A&&gc&&Gn?k:zt.right,yc=!A&&Vo&&pa?L:fr.left,vv=A?Dr(pr,In,"after"):k),G(zs,zt.top,Xn-zs,zt.bottom),zt.bottom<fr.top&&G(L,zt.bottom,null,fr.top),G(yc,fr.top,vv-yc,fr.bottom)}(!Tt||Sf(zt,Tt)<0)&&(Tt=zt),Sf(fr,Tt)<0&&(Tt=fr),(!gn||Sf(zt,gn)<0)&&(gn=zt),Sf(fr,gn)<0&&(gn=fr)}),{start:Tt,end:gn}}var Y=u.from(),q=u.to();if(Y.line==q.line)$(Y.line,Y.ch,q.ch);else{var ee=Te(y,Y.line),re=Te(y,q.line),de=ca(ee)==ca(re),fe=$(Y.line,Y.ch,de?ee.text.length+1:null).end,Se=$(q.line,de?0:null,q.ch).start;de&&(fe.top<Se.top-2?(G(fe.right,fe.top,null,fe.bottom),G(L,Se.top,Se.left,Se.bottom)):G(fe.right,fe.top,Se.left-fe.right,fe.bottom)),fe.bottom<Se.top&&G(L,fe.bottom,null,Se.top)}m.appendChild(S)}function jy(s){if(!!s.state.focused){var u=s.display;clearInterval(u.blinker);var m=!0;u.cursorDiv.style.visibility="",s.options.cursorBlinkRate>0?u.blinker=setInterval(function(){s.hasFocus()||ic(s),u.cursorDiv.style.visibility=(m=!m)?"":"hidden"},s.options.cursorBlinkRate):s.options.cursorBlinkRate<0&&(u.cursorDiv.style.visibility="hidden")}}function PT(s){s.hasFocus()||(s.display.input.focus(),s.state.focused||qy(s))}function Jy(s){s.state.delayingBlurEvent=!0,setTimeout(function(){s.state.delayingBlurEvent&&(s.state.delayingBlurEvent=!1,s.state.focused&&ic(s))},100)}function qy(s,u){s.state.delayingBlurEvent&&!s.state.draggingText&&(s.state.delayingBlurEvent=!1),s.options.readOnly!="nocursor"&&(s.state.focused||(Ue(s,"focus",s,u),s.state.focused=!0,me(s.display.wrapper,"CodeMirror-focused"),!s.curOp&&s.display.selForContextMenu!=s.doc.sel&&(s.display.input.reset(),c&&setTimeout(function(){return s.display.input.reset(!0)},20)),s.display.input.receivedFocus()),jy(s))}function ic(s,u){s.state.delayingBlurEvent||(s.state.focused&&(Ue(s,"blur",s,u),s.state.focused=!1,B(s.display.wrapper,"CodeMirror-focused")),clearInterval(s.display.blinker),setTimeout(function(){s.state.focused||(s.display.shift=!1)},150))}function bf(s){for(var u=s.display,m=u.lineDiv.offsetTop,f=0;f<u.view.length;f++){var y=u.view[f],S=s.options.lineWrapping,w=void 0,L=0;if(!y.hidden){if(o&&l<8){var k=y.node.offsetTop+y.node.offsetHeight;w=k-m,m=k}else{var A=y.node.getBoundingClientRect();w=A.bottom-A.top,!S&&y.text.firstChild&&(L=y.text.firstChild.getBoundingClientRect().right-A.left-1)}var G=y.line.height-w;if((G>.005||G<-.005)&&(kr(y.line,w),IT(y.line),y.rest))for(var $=0;$<y.rest.length;$++)IT(y.rest[$]);if(L>s.display.sizerWidth){var Y=Math.ceil(L/rc(s.display));Y>s.display.maxLineLength&&(s.display.maxLineLength=Y,s.display.maxLine=y.line,s.display.maxLineChanged=!0)}}}}function IT(s){if(s.widgets)for(var u=0;u<s.widgets.length;++u){var m=s.widgets[u],f=m.node.parentNode;f&&(m.height=f.offsetHeight)}}function xf(s,u,m){var f=m&&m.top!=null?Math.max(0,m.top):s.scroller.scrollTop;f=Math.floor(f-gf(s));var y=m&&m.bottom!=null?m.bottom:f+s.wrapper.clientHeight,S=sa(u,f),w=sa(u,y);if(m&&m.ensure){var L=m.ensure.from.line,k=m.ensure.to.line;L<S?(S=L,w=sa(u,Ga(Te(u,L))+s.wrapper.clientHeight)):Math.min(k,u.lastLine())>=w&&(S=sa(u,Ga(Te(u,k))-s.wrapper.clientHeight),w=k)}return{from:S,to:Math.max(w,S+1)}}function PB(s,u){if(!Zt(s,"scrollCursorIntoView")){var m=s.display,f=m.sizer.getBoundingClientRect(),y=null;if(u.top+f.top<0?y=!0:u.bottom+f.top>(window.innerHeight||document.documentElement.clientHeight)&&(y=!1),y!=null&&!b){var S=F("div","\u200B",null,`position: absolute;
                         top: `+(u.top-m.viewOffset-gf(s.display))+`px;
                         height: `+(u.bottom-u.top+ua(s)+m.barHeight)+`px;
                         left: `+u.left+"px; width: "+Math.max(2,u.right-u.left)+"px;");s.display.lineSpace.appendChild(S),S.scrollIntoView(y),s.display.lineSpace.removeChild(S)}}}function IB(s,u,m,f){f==null&&(f=0);var y;!s.options.lineWrapping&&u==m&&(m=u.sticky=="before"?se(u.line,u.ch+1,"before"):u,u=u.ch?se(u.line,u.sticky=="before"?u.ch-1:u.ch,"after"):u);for(var S=0;S<5;S++){var w=!1,L=ki(s,u),k=!m||m==u?L:ki(s,m);y={left:Math.min(L.left,k.left),top:Math.min(L.top,k.top)-f,right:Math.max(L.left,k.left),bottom:Math.max(L.bottom,k.bottom)+f};var A=Yy(s,y),G=s.doc.scrollTop,$=s.doc.scrollLeft;if(A.scrollTop!=null&&(zu(s,A.scrollTop),Math.abs(s.doc.scrollTop-G)>1&&(w=!0)),A.scrollLeft!=null&&(Bs(s,A.scrollLeft),Math.abs(s.doc.scrollLeft-$)>1&&(w=!0)),!w)break}return y}function AB(s,u){var m=Yy(s,u);m.scrollTop!=null&&zu(s,m.scrollTop),m.scrollLeft!=null&&Bs(s,m.scrollLeft)}function Yy(s,u){var m=s.display,f=nc(s.display);u.top<0&&(u.top=0);var y=s.curOp&&s.curOp.scrollTop!=null?s.curOp.scrollTop:m.scroller.scrollTop,S=Oy(s),w={};u.bottom-u.top>S&&(u.bottom=u.top+S);var L=s.doc.height+Vy(m),k=u.top<f,A=u.bottom>L-f;if(u.top<y)w.scrollTop=k?0:u.top;else if(u.bottom>y+S){var G=Math.min(u.top,(A?L:u.bottom)-S);G!=y&&(w.scrollTop=G)}var $=s.options.fixedGutter?0:m.gutters.offsetWidth,Y=s.curOp&&s.curOp.scrollLeft!=null?s.curOp.scrollLeft:m.scroller.scrollLeft-$,q=_s(s)-m.gutters.offsetWidth,ee=u.right-u.left>q;return ee&&(u.right=u.left+q),u.left<10?w.scrollLeft=0:u.left<Y?w.scrollLeft=Math.max(0,u.left+$-(ee?0:10)):u.right>q+Y-3&&(w.scrollLeft=u.right+(ee?0:10)-q),w}function Ky(s,u){u!=null&&(Cf(s),s.curOp.scrollTop=(s.curOp.scrollTop==null?s.doc.scrollTop:s.curOp.scrollTop)+u)}function ac(s){Cf(s);var u=s.getCursor();s.curOp.scrollToPos={from:u,to:u,margin:s.options.cursorScrollMargin}}function Wu(s,u,m){(u!=null||m!=null)&&Cf(s),u!=null&&(s.curOp.scrollLeft=u),m!=null&&(s.curOp.scrollTop=m)}function MB(s,u){Cf(s),s.curOp.scrollToPos=u}function Cf(s){var u=s.curOp.scrollToPos;if(u){s.curOp.scrollToPos=null;var m=CT(s,u.from),f=CT(s,u.to);AT(s,m,f,u.margin)}}function AT(s,u,m,f){var y=Yy(s,{left:Math.min(u.left,m.left),top:Math.min(u.top,m.top)-f,right:Math.max(u.right,m.right),bottom:Math.max(u.bottom,m.bottom)+f});Wu(s,y.scrollLeft,y.scrollTop)}function zu(s,u){Math.abs(s.doc.scrollTop-u)<2||(t||Qy(s,{top:u}),MT(s,u,!0),t&&Qy(s),ju(s,100))}function MT(s,u,m){u=Math.max(0,Math.min(s.display.scroller.scrollHeight-s.display.scroller.clientHeight,u)),!(s.display.scroller.scrollTop==u&&!m)&&(s.doc.scrollTop=u,s.display.scrollbars.setScrollTop(u),s.display.scroller.scrollTop!=u&&(s.display.scroller.scrollTop=u))}function Bs(s,u,m,f){u=Math.max(0,Math.min(u,s.display.scroller.scrollWidth-s.display.scroller.clientWidth)),!((m?u==s.doc.scrollLeft:Math.abs(s.doc.scrollLeft-u)<2)&&!f)&&(s.doc.scrollLeft=u,NT(s),s.display.scroller.scrollLeft!=u&&(s.display.scroller.scrollLeft=u),s.display.scrollbars.setScrollLeft(u))}function Hu(s){var u=s.display,m=u.gutters.offsetWidth,f=Math.round(s.doc.height+Vy(s.display));return{clientHeight:u.scroller.clientHeight,viewHeight:u.wrapper.clientHeight,scrollWidth:u.scroller.scrollWidth,clientWidth:u.scroller.clientWidth,viewWidth:u.wrapper.clientWidth,barLeft:s.options.fixedGutter?m:0,docHeight:f,scrollHeight:f+ua(s)+u.barHeight,nativeBarWidth:u.nativeBarWidth,gutterWidth:m}}var Fs=function(s,u,m){this.cm=m;var f=this.vert=F("div",[F("div",null,null,"min-width: 1px")],"CodeMirror-vscrollbar"),y=this.horiz=F("div",[F("div",null,null,"height: 100%; min-height: 1px")],"CodeMirror-hscrollbar");f.tabIndex=y.tabIndex=-1,s(f),s(y),Ne(f,"scroll",function(){f.clientHeight&&u(f.scrollTop,"vertical")}),Ne(y,"scroll",function(){y.clientWidth&&u(y.scrollLeft,"horizontal")}),this.checkedZeroWidth=!1,o&&l<8&&(this.horiz.style.minHeight=this.vert.style.minWidth="18px")};Fs.prototype.update=function(s){var u=s.scrollWidth>s.clientWidth+1,m=s.scrollHeight>s.clientHeight+1,f=s.nativeBarWidth;if(m){this.vert.style.display="block",this.vert.style.bottom=u?f+"px":"0";var y=s.viewHeight-(u?f:0);this.vert.firstChild.style.height=Math.max(0,s.scrollHeight-s.clientHeight+y)+"px"}else this.vert.style.display="",this.vert.firstChild.style.height="0";if(u){this.horiz.style.display="block",this.horiz.style.right=m?f+"px":"0",this.horiz.style.left=s.barLeft+"px";var S=s.viewWidth-s.barLeft-(m?f:0);this.horiz.firstChild.style.width=Math.max(0,s.scrollWidth-s.clientWidth+S)+"px"}else this.horiz.style.display="",this.horiz.firstChild.style.width="0";return!this.checkedZeroWidth&&s.clientHeight>0&&(f==0&&this.zeroWidthHack(),this.checkedZeroWidth=!0),{right:m?f:0,bottom:u?f:0}},Fs.prototype.setScrollLeft=function(s){this.horiz.scrollLeft!=s&&(this.horiz.scrollLeft=s),this.disableHoriz&&this.enableZeroWidthBar(this.horiz,this.disableHoriz,"horiz")},Fs.prototype.setScrollTop=function(s){this.vert.scrollTop!=s&&(this.vert.scrollTop=s),this.disableVert&&this.enableZeroWidthBar(this.vert,this.disableVert,"vert")},Fs.prototype.zeroWidthHack=function(){var s=P&&!v?"12px":"18px";this.horiz.style.height=this.vert.style.width=s,this.horiz.style.pointerEvents=this.vert.style.pointerEvents="none",this.disableHoriz=new rt,this.disableVert=new rt},Fs.prototype.enableZeroWidthBar=function(s,u,m){s.style.pointerEvents="auto";function f(){var y=s.getBoundingClientRect(),S=m=="vert"?document.elementFromPoint(y.right-1,(y.top+y.bottom)/2):document.elementFromPoint((y.right+y.left)/2,y.bottom-1);S!=s?s.style.pointerEvents="none":u.set(1e3,f)}u.set(1e3,f)},Fs.prototype.clear=function(){var s=this.horiz.parentNode;s.removeChild(this.horiz),s.removeChild(this.vert)};var $u=function(){};$u.prototype.update=function(){return{bottom:0,right:0}},$u.prototype.setScrollLeft=function(){},$u.prototype.setScrollTop=function(){},$u.prototype.clear=function(){};function oc(s,u){u||(u=Hu(s));var m=s.display.barWidth,f=s.display.barHeight;RT(s,u);for(var y=0;y<4&&m!=s.display.barWidth||f!=s.display.barHeight;y++)m!=s.display.barWidth&&s.options.lineWrapping&&bf(s),RT(s,Hu(s)),m=s.display.barWidth,f=s.display.barHeight}function RT(s,u){var m=s.display,f=m.scrollbars.update(u);m.sizer.style.paddingRight=(m.barWidth=f.right)+"px",m.sizer.style.paddingBottom=(m.barHeight=f.bottom)+"px",m.heightForcer.style.borderBottom=f.bottom+"px solid transparent",f.right&&f.bottom?(m.scrollbarFiller.style.display="block",m.scrollbarFiller.style.height=f.bottom+"px",m.scrollbarFiller.style.width=f.right+"px"):m.scrollbarFiller.style.display="",f.bottom&&s.options.coverGutterNextToScrollbar&&s.options.fixedGutter?(m.gutterFiller.style.display="block",m.gutterFiller.style.height=f.bottom+"px",m.gutterFiller.style.width=u.gutterWidth+"px"):m.gutterFiller.style.display=""}var _T={native:Fs,null:$u};function VT(s){s.display.scrollbars&&(s.display.scrollbars.clear(),s.display.scrollbars.addClass&&B(s.display.wrapper,s.display.scrollbars.addClass)),s.display.scrollbars=new _T[s.options.scrollbarStyle](function(u){s.display.wrapper.insertBefore(u,s.display.scrollbarFiller),Ne(u,"mousedown",function(){s.state.focused&&setTimeout(function(){return s.display.input.focus()},0)}),u.setAttribute("cm-not-content","true")},function(u,m){m=="horizontal"?Bs(s,u):zu(s,u)},s),s.display.scrollbars.addClass&&me(s.display.wrapper,s.display.scrollbars.addClass)}var RB=0;function Us(s){s.curOp={cm:s,viewChanged:!1,startHeight:s.doc.height,forceUpdate:!1,updateInput:0,typing:!1,changeObjs:null,cursorActivityHandlers:null,cursorActivityCalled:0,selectionChanged:!1,updateMaxLine:!1,scrollLeft:null,scrollTop:null,scrollToPos:null,focus:!1,id:++RB,markArrays:null},uB(s.curOp)}function Gs(s){var u=s.curOp;u&&pB(u,function(m){for(var f=0;f<m.ops.length;f++)m.ops[f].cm.curOp=null;_B(m)})}function _B(s){for(var u=s.ops,m=0;m<u.length;m++)VB(u[m]);for(var f=0;f<u.length;f++)OB(u[f]);for(var y=0;y<u.length;y++)NB(u[y]);for(var S=0;S<u.length;S++)BB(u[S]);for(var w=0;w<u.length;w++)FB(u[w])}function VB(s){var u=s.cm,m=u.display;GB(u),s.updateMaxLine&&Ry(u),s.mustUpdate=s.viewChanged||s.forceUpdate||s.scrollTop!=null||s.scrollToPos&&(s.scrollToPos.from.line<m.viewFrom||s.scrollToPos.to.line>=m.viewTo)||m.maxLineChanged&&u.options.lineWrapping,s.update=s.mustUpdate&&new wf(u,s.mustUpdate&&{top:s.scrollTop,ensure:s.scrollToPos},s.forceUpdate)}function OB(s){s.updatedDisplay=s.mustUpdate&&Xy(s.cm,s.update)}function NB(s){var u=s.cm,m=u.display;s.updatedDisplay&&bf(u),s.barMeasure=Hu(u),m.maxLineChanged&&!u.options.lineWrapping&&(s.adjustWidthTo=hT(u,m.maxLine,m.maxLine.text.length).left+3,u.display.sizerWidth=s.adjustWidthTo,s.barMeasure.scrollWidth=Math.max(m.scroller.clientWidth,m.sizer.offsetLeft+s.adjustWidthTo+ua(u)+u.display.barWidth),s.maxScrollLeft=Math.max(0,m.sizer.offsetLeft+s.adjustWidthTo-_s(u))),(s.updatedDisplay||s.selectionChanged)&&(s.preparedSelection=m.input.prepareSelection())}function BB(s){var u=s.cm;s.adjustWidthTo!=null&&(u.display.sizer.style.minWidth=s.adjustWidthTo+"px",s.maxScrollLeft<u.doc.scrollLeft&&Bs(u,Math.min(u.display.scroller.scrollLeft,s.maxScrollLeft),!0),u.display.maxLineChanged=!1);var m=s.focus&&s.focus==pe();s.preparedSelection&&u.display.input.showSelection(s.preparedSelection,m),(s.updatedDisplay||s.startHeight!=u.doc.height)&&oc(u,s.barMeasure),s.updatedDisplay&&ev(u,s.barMeasure),s.selectionChanged&&jy(u),u.state.focused&&s.updateInput&&u.display.input.reset(s.typing),m&&PT(s.cm)}function FB(s){var u=s.cm,m=u.display,f=u.doc;if(s.updatedDisplay&&OT(u,s.update),m.wheelStartX!=null&&(s.scrollTop!=null||s.scrollLeft!=null||s.scrollToPos)&&(m.wheelStartX=m.wheelStartY=null),s.scrollTop!=null&&MT(u,s.scrollTop,s.forceScroll),s.scrollLeft!=null&&Bs(u,s.scrollLeft,!0,!0),s.scrollToPos){var y=IB(u,ve(f,s.scrollToPos.from),ve(f,s.scrollToPos.to),s.scrollToPos.margin);PB(u,y)}var S=s.maybeHiddenMarkers,w=s.maybeUnhiddenMarkers;if(S)for(var L=0;L<S.length;++L)S[L].lines.length||Ue(S[L],"hide");if(w)for(var k=0;k<w.length;++k)w[k].lines.length&&Ue(w[k],"unhide");m.wrapper.offsetHeight&&(f.scrollTop=u.display.scroller.scrollTop),s.changeObjs&&Ue(u,"changes",u,s.changeObjs),s.update&&s.update.finish()}function Er(s,u){if(s.curOp)return u();Us(s);try{return u()}finally{Gs(s)}}function hn(s,u){return function(){if(s.curOp)return u.apply(s,arguments);Us(s);try{return u.apply(s,arguments)}finally{Gs(s)}}}function Kn(s){return function(){if(this.curOp)return s.apply(this,arguments);Us(this);try{return s.apply(this,arguments)}finally{Gs(this)}}}function mn(s){return function(){var u=this.cm;if(!u||u.curOp)return s.apply(this,arguments);Us(u);try{return s.apply(this,arguments)}finally{Gs(u)}}}function ju(s,u){s.doc.highlightFrontier<s.display.viewTo&&s.state.highlight.set(u,we(UB,s))}function UB(s){var u=s.doc;if(!(u.highlightFrontier>=s.display.viewTo)){var m=+new Date+s.options.workTime,f=Vu(s,u.highlightFrontier),y=[];u.iter(f.line,Math.min(u.first+u.size,s.display.viewTo+500),function(S){if(f.line>=s.display.viewFrom){var w=S.styles,L=S.text.length>s.options.maxHighlightLength?Gr(u.mode,f.state):null,k=W0(s,S,f,!0);L&&(f.state=L),S.styles=k.styles;var A=S.styleClasses,G=k.classes;G?S.styleClasses=G:A&&(S.styleClasses=null);for(var $=!w||w.length!=S.styles.length||A!=G&&(!A||!G||A.bgClass!=G.bgClass||A.textClass!=G.textClass),Y=0;!$&&Y<w.length;++Y)$=w[Y]!=S.styles[Y];$&&y.push(f.line),S.stateAfter=f.save(),f.nextLine()}else S.text.length<=s.options.maxHighlightLength&&Ey(s,S.text,f),S.stateAfter=f.line%5==0?f.save():null,f.nextLine();if(+new Date>m)return ju(s,s.options.workDelay),!0}),u.highlightFrontier=f.line,u.modeFrontier=Math.max(u.modeFrontier,f.line),y.length&&Er(s,function(){for(var S=0;S<y.length;S++)Do(s,y[S],"text")})}}var wf=function(s,u,m){var f=s.display;this.viewport=u,this.visible=xf(f,s.doc,u),this.editorIsHidden=!f.wrapper.offsetWidth,this.wrapperHeight=f.wrapper.clientHeight,this.wrapperWidth=f.wrapper.clientWidth,this.oldDisplayWidth=_s(s),this.force=m,this.dims=zy(s),this.events=[]};wf.prototype.signal=function(s,u){Pn(s,u)&&this.events.push(arguments)},wf.prototype.finish=function(){for(var s=0;s<this.events.length;s++)Ue.apply(null,this.events[s])};function GB(s){var u=s.display;!u.scrollbarsClipped&&u.scroller.offsetWidth&&(u.nativeBarWidth=u.scroller.offsetWidth-u.scroller.clientWidth,u.heightForcer.style.height=ua(s)+"px",u.sizer.style.marginBottom=-u.nativeBarWidth+"px",u.sizer.style.borderRightWidth=ua(s)+"px",u.scrollbarsClipped=!0)}function WB(s){if(s.hasFocus())return null;var u=pe();if(!u||!ae(s.display.lineDiv,u))return null;var m={activeElt:u};if(window.getSelection){var f=window.getSelection();f.anchorNode&&f.extend&&ae(s.display.lineDiv,f.anchorNode)&&(m.anchorNode=f.anchorNode,m.anchorOffset=f.anchorOffset,m.focusNode=f.focusNode,m.focusOffset=f.focusOffset)}return m}function zB(s){if(!(!s||!s.activeElt||s.activeElt==pe())&&(s.activeElt.focus(),!/^(INPUT|TEXTAREA)$/.test(s.activeElt.nodeName)&&s.anchorNode&&ae(document.body,s.anchorNode)&&ae(document.body,s.focusNode))){var u=window.getSelection(),m=document.createRange();m.setEnd(s.anchorNode,s.anchorOffset),m.collapse(!1),u.removeAllRanges(),u.addRange(m),u.extend(s.focusNode,s.focusOffset)}}function Xy(s,u){var m=s.display,f=s.doc;if(u.editorIsHidden)return Po(s),!1;if(!u.force&&u.visible.from>=m.viewFrom&&u.visible.to<=m.viewTo&&(m.updateLineNumbers==null||m.updateLineNumbers>=m.viewTo)&&m.renderedView==m.view&&kT(s)==0)return!1;BT(s)&&(Po(s),u.dims=zy(s));var y=f.first+f.size,S=Math.max(u.visible.from-s.options.viewportMargin,f.first),w=Math.min(y,u.visible.to+s.options.viewportMargin);m.viewFrom<S&&S-m.viewFrom<20&&(S=Math.max(f.first,m.viewFrom)),m.viewTo>w&&m.viewTo-w<20&&(w=Math.min(y,m.viewTo)),Ua&&(S=Ay(s.doc,S),w=nT(s.doc,w));var L=S!=m.viewFrom||w!=m.viewTo||m.lastWrapHeight!=u.wrapperHeight||m.lastWrapWidth!=u.wrapperWidth;EB(s,S,w),m.viewOffset=Ga(Te(s.doc,m.viewFrom)),s.display.mover.style.top=m.viewOffset+"px";var k=kT(s);if(!L&&k==0&&!u.force&&m.renderedView==m.view&&(m.updateLineNumbers==null||m.updateLineNumbers>=m.viewTo))return!1;var A=WB(s);return k>4&&(m.lineDiv.style.display="none"),HB(s,m.updateLineNumbers,u.dims),k>4&&(m.lineDiv.style.display=""),m.renderedView=m.view,zB(A),z(m.cursorDiv),z(m.selectionDiv),m.gutters.style.height=m.sizer.style.minHeight=0,L&&(m.lastWrapHeight=u.wrapperHeight,m.lastWrapWidth=u.wrapperWidth,ju(s,400)),m.updateLineNumbers=null,!0}function OT(s,u){for(var m=u.viewport,f=!0;;f=!1){if(!f||!s.options.lineWrapping||u.oldDisplayWidth==_s(s)){if(m&&m.top!=null&&(m={top:Math.min(s.doc.height+Vy(s.display)-Oy(s),m.top)}),u.visible=xf(s.display,s.doc,m),u.visible.from>=s.display.viewFrom&&u.visible.to<=s.display.viewTo)break}else f&&(u.visible=xf(s.display,s.doc,m));if(!Xy(s,u))break;bf(s);var y=Hu(s);Gu(s),oc(s,y),ev(s,y),u.force=!1}u.signal(s,"update",s),(s.display.viewFrom!=s.display.reportedViewFrom||s.display.viewTo!=s.display.reportedViewTo)&&(u.signal(s,"viewportChange",s,s.display.viewFrom,s.display.viewTo),s.display.reportedViewFrom=s.display.viewFrom,s.display.reportedViewTo=s.display.viewTo)}function Qy(s,u){var m=new wf(s,u);if(Xy(s,m)){bf(s),OT(s,m);var f=Hu(s);Gu(s),oc(s,f),ev(s,f),m.finish()}}function HB(s,u,m){var f=s.display,y=s.options.lineNumbers,S=f.lineDiv,w=S.firstChild;function L(ee){var re=ee.nextSibling;return c&&P&&s.display.currentWheelTarget==ee?ee.style.display="none":ee.parentNode.removeChild(ee),re}for(var k=f.view,A=f.viewFrom,G=0;G<k.length;G++){var $=k[G];if(!$.hidden)if(!$.node||$.node.parentNode!=S){var Y=yB(s,$,A,m);S.insertBefore(Y,w)}else{for(;w!=$.node;)w=L(w);var q=y&&u!=null&&u<=A&&$.lineNumber;$.changes&&(ye($.changes,"gutter")>-1&&(q=!1),sT(s,$,A,m)),q&&(z($.lineNumber),$.lineNumber.appendChild(document.createTextNode(_u(s.options,A)))),w=$.node.nextSibling}A+=$.size}for(;w;)w=L(w)}function Zy(s){var u=s.gutters.offsetWidth;s.sizer.style.marginLeft=u+"px",fn(s,"gutterChanged",s)}function ev(s,u){s.display.sizer.style.minHeight=u.docHeight+"px",s.display.heightForcer.style.top=u.docHeight+"px",s.display.gutters.style.height=u.docHeight+s.display.barHeight+ua(s)+"px"}function NT(s){var u=s.display,m=u.view;if(!(!u.alignWidgets&&(!u.gutters.firstChild||!s.options.fixedGutter))){for(var f=Hy(u)-u.scroller.scrollLeft+s.doc.scrollLeft,y=u.gutters.offsetWidth,S=f+"px",w=0;w<m.length;w++)if(!m[w].hidden){s.options.fixedGutter&&(m[w].gutter&&(m[w].gutter.style.left=S),m[w].gutterBackground&&(m[w].gutterBackground.style.left=S));var L=m[w].alignable;if(L)for(var k=0;k<L.length;k++)L[k].style.left=S}s.options.fixedGutter&&(u.gutters.style.left=f+y+"px")}}function BT(s){if(!s.options.lineNumbers)return!1;var u=s.doc,m=_u(s.options,u.first+u.size-1),f=s.display;if(m.length!=f.lineNumChars){var y=f.measure.appendChild(F("div",[F("div",m)],"CodeMirror-linenumber CodeMirror-gutter-elt")),S=y.firstChild.offsetWidth,w=y.offsetWidth-S;return f.lineGutter.style.width="",f.lineNumInnerWidth=Math.max(S,f.lineGutter.offsetWidth-w)+1,f.lineNumWidth=f.lineNumInnerWidth+w,f.lineNumChars=f.lineNumInnerWidth?m.length:-1,f.lineGutter.style.width=f.lineNumWidth+"px",Zy(s.display),!0}return!1}function tv(s,u){for(var m=[],f=!1,y=0;y<s.length;y++){var S=s[y],w=null;if(typeof S!="string"&&(w=S.style,S=S.className),S=="CodeMirror-linenumbers")if(u)f=!0;else continue;m.push({className:S,style:w})}return u&&!f&&m.push({className:"CodeMirror-linenumbers",style:null}),m}function FT(s){var u=s.gutters,m=s.gutterSpecs;z(u),s.lineGutter=null;for(var f=0;f<m.length;++f){var y=m[f],S=y.className,w=y.style,L=u.appendChild(F("div",null,"CodeMirror-gutter "+S));w&&(L.style.cssText=w),S=="CodeMirror-linenumbers"&&(s.lineGutter=L,L.style.width=(s.lineNumWidth||1)+"px")}u.style.display=m.length?"":"none",Zy(s)}function Ju(s){FT(s.display),cr(s),NT(s)}function $B(s,u,m,f){var y=this;this.input=m,y.scrollbarFiller=F("div",null,"CodeMirror-scrollbar-filler"),y.scrollbarFiller.setAttribute("cm-not-content","true"),y.gutterFiller=F("div",null,"CodeMirror-gutter-filler"),y.gutterFiller.setAttribute("cm-not-content","true"),y.lineDiv=N("div",null,"CodeMirror-code"),y.selectionDiv=F("div",null,null,"position: relative; z-index: 1"),y.cursorDiv=F("div",null,"CodeMirror-cursors"),y.measure=F("div",null,"CodeMirror-measure"),y.lineMeasure=F("div",null,"CodeMirror-measure"),y.lineSpace=N("div",[y.measure,y.lineMeasure,y.selectionDiv,y.cursorDiv,y.lineDiv],null,"position: relative; outline: none");var S=N("div",[y.lineSpace],"CodeMirror-lines");y.mover=F("div",[S],null,"position: relative"),y.sizer=F("div",[y.mover],"CodeMirror-sizer"),y.sizerWidth=null,y.heightForcer=F("div",null,null,"position: absolute; height: "+Le+"px; width: 1px;"),y.gutters=F("div",null,"CodeMirror-gutters"),y.lineGutter=null,y.scroller=F("div",[y.sizer,y.heightForcer,y.gutters],"CodeMirror-scroll"),y.scroller.setAttribute("tabIndex","-1"),y.wrapper=F("div",[y.scrollbarFiller,y.gutterFiller,y.scroller],"CodeMirror"),o&&l<8&&(y.gutters.style.zIndex=-1,y.scroller.style.paddingRight=0),!c&&!(t&&T)&&(y.scroller.draggable=!0),s&&(s.appendChild?s.appendChild(y.wrapper):s(y.wrapper)),y.viewFrom=y.viewTo=u.first,y.reportedViewFrom=y.reportedViewTo=u.first,y.view=[],y.renderedView=null,y.externalMeasured=null,y.viewOffset=0,y.lastWrapHeight=y.lastWrapWidth=0,y.updateLineNumbers=null,y.nativeBarWidth=y.barHeight=y.barWidth=0,y.scrollbarsClipped=!1,y.lineNumWidth=y.lineNumInnerWidth=y.lineNumChars=null,y.alignWidgets=!1,y.cachedCharWidth=y.cachedTextHeight=y.cachedPaddingH=null,y.maxLine=null,y.maxLineLength=0,y.maxLineChanged=!1,y.wheelDX=y.wheelDY=y.wheelStartX=y.wheelStartY=null,y.shift=!1,y.selForContextMenu=null,y.activeTouch=null,y.gutterSpecs=tv(f.gutters,f.lineNumbers),FT(y),m.init(y)}var Tf=0,zr=null;o?zr=-.53:t?zr=15:p?zr=-.7:g&&(zr=-1/3);function UT(s){var u=s.wheelDeltaX,m=s.wheelDeltaY;return u==null&&s.detail&&s.axis==s.HORIZONTAL_AXIS&&(u=s.detail),m==null&&s.detail&&s.axis==s.VERTICAL_AXIS?m=s.detail:m==null&&(m=s.wheelDelta),{x:u,y:m}}function jB(s){var u=UT(s);return u.x*=zr,u.y*=zr,u}function GT(s,u){var m=UT(u),f=m.x,y=m.y,S=s.display,w=S.scroller,L=w.scrollWidth>w.clientWidth,k=w.scrollHeight>w.clientHeight;if(!!(f&&L||y&&k)){if(y&&P&&c){e:for(var A=u.target,G=S.view;A!=w;A=A.parentNode)for(var $=0;$<G.length;$++)if(G[$].node==A){s.display.currentWheelTarget=A;break e}}if(f&&!t&&!h&&zr!=null){y&&k&&zu(s,Math.max(0,w.scrollTop+y*zr)),Bs(s,Math.max(0,w.scrollLeft+f*zr)),(!y||y&&k)&&Bn(u),S.wheelStartX=null;return}if(y&&zr!=null){var Y=y*zr,q=s.doc.scrollTop,ee=q+S.wrapper.clientHeight;Y<0?q=Math.max(0,q+Y-50):ee=Math.min(s.doc.height,ee+Y+50),Qy(s,{top:q,bottom:ee})}Tf<20&&(S.wheelStartX==null?(S.wheelStartX=w.scrollLeft,S.wheelStartY=w.scrollTop,S.wheelDX=f,S.wheelDY=y,setTimeout(function(){if(S.wheelStartX!=null){var re=w.scrollLeft-S.wheelStartX,de=w.scrollTop-S.wheelStartY,fe=de&&S.wheelDY&&de/S.wheelDY||re&&S.wheelDX&&re/S.wheelDX;S.wheelStartX=S.wheelStartY=null,!!fe&&(zr=(zr*Tf+fe)/(Tf+1),++Tf)}},200)):(S.wheelDX+=f,S.wheelDY+=y))}}var Hr=function(s,u){this.ranges=s,this.primIndex=u};Hr.prototype.primary=function(){return this.ranges[this.primIndex]},Hr.prototype.equals=function(s){if(s==this)return!0;if(s.primIndex!=this.primIndex||s.ranges.length!=this.ranges.length)return!1;for(var u=0;u<this.ranges.length;u++){var m=this.ranges[u],f=s.ranges[u];if(!j(m.anchor,f.anchor)||!j(m.head,f.head))return!1}return!0},Hr.prototype.deepCopy=function(){for(var s=[],u=0;u<this.ranges.length;u++)s[u]=new mt(te(this.ranges[u].anchor),te(this.ranges[u].head));return new Hr(s,this.primIndex)},Hr.prototype.somethingSelected=function(){for(var s=0;s<this.ranges.length;s++)if(!this.ranges[s].empty())return!0;return!1},Hr.prototype.contains=function(s,u){u||(u=s);for(var m=0;m<this.ranges.length;m++){var f=this.ranges[m];if(R(u,f.from())>=0&&R(s,f.to())<=0)return m}return-1};var mt=function(s,u){this.anchor=s,this.head=u};mt.prototype.from=function(){return Ge(this.anchor,this.head)},mt.prototype.to=function(){return ue(this.anchor,this.head)},mt.prototype.empty=function(){return this.head.line==this.anchor.line&&this.head.ch==this.anchor.ch};function Ei(s,u,m){var f=s&&s.options.selectionsMayTouch,y=u[m];u.sort(function(Y,q){return R(Y.from(),q.from())}),m=ye(u,y);for(var S=1;S<u.length;S++){var w=u[S],L=u[S-1],k=R(L.to(),w.from());if(f&&!w.empty()?k>0:k>=0){var A=Ge(L.from(),w.from()),G=ue(L.to(),w.to()),$=L.empty()?w.from()==w.head:L.from()==L.head;S<=m&&--m,u.splice(--S,2,new mt($?G:A,$?A:G))}}return new Hr(u,m)}function Io(s,u){return new Hr([new mt(s,u||s)],0)}function Ao(s){return s.text?se(s.from.line+s.text.length-1,at(s.text).length+(s.text.length==1?s.from.ch:0)):s.to}function WT(s,u){if(R(s,u.from)<0)return s;if(R(s,u.to)<=0)return Ao(u);var m=s.line+u.text.length-(u.to.line-u.from.line)-1,f=s.ch;return s.line==u.to.line&&(f+=Ao(u).ch-u.to.ch),se(m,f)}function nv(s,u){for(var m=[],f=0;f<s.sel.ranges.length;f++){var y=s.sel.ranges[f];m.push(new mt(WT(y.anchor,u),WT(y.head,u)))}return Ei(s.cm,m,s.sel.primIndex)}function zT(s,u,m){return s.line==u.line?se(m.line,s.ch-u.ch+m.ch):se(m.line+(s.line-u.line),s.ch)}function JB(s,u,m){for(var f=[],y=se(s.first,0),S=y,w=0;w<u.length;w++){var L=u[w],k=zT(L.from,y,S),A=zT(Ao(L),y,S);if(y=L.to,S=A,m=="around"){var G=s.sel.ranges[w],$=R(G.head,G.anchor)<0;f[w]=new mt($?A:k,$?k:A)}else f[w]=new mt(k,k)}return new Hr(f,s.sel.primIndex)}function rv(s){s.doc.mode=Xl(s.options,s.doc.modeOption),qu(s)}function qu(s){s.doc.iter(function(u){u.stateAfter&&(u.stateAfter=null),u.styles&&(u.styles=null)}),s.doc.modeFrontier=s.doc.highlightFrontier=s.doc.first,ju(s,100),s.state.modeGen++,s.curOp&&cr(s)}function HT(s,u){return u.from.ch==0&&u.to.ch==0&&at(u.text)==""&&(!s.cm||s.cm.options.wholeLineUpdateBefore)}function iv(s,u,m,f){function y(Se){return m?m[Se]:null}function S(Se,he,be){tB(Se,he,be,f),fn(Se,"change",Se,u)}function w(Se,he){for(var be=[],Re=Se;Re<he;++Re)be.push(new Zl(A[Re],y(Re),f));return be}var L=u.from,k=u.to,A=u.text,G=Te(s,L.line),$=Te(s,k.line),Y=at(A),q=y(A.length-1),ee=k.line-L.line;if(u.full)s.insert(0,w(0,A.length)),s.remove(A.length,s.size-A.length);else if(HT(s,u)){var re=w(0,A.length-1);S($,$.text,q),ee&&s.remove(L.line,ee),re.length&&s.insert(L.line,re)}else if(G==$)if(A.length==1)S(G,G.text.slice(0,L.ch)+Y+G.text.slice(k.ch),q);else{var de=w(1,A.length-1);de.push(new Zl(Y+G.text.slice(k.ch),q,f)),S(G,G.text.slice(0,L.ch)+A[0],y(0)),s.insert(L.line+1,de)}else if(A.length==1)S(G,G.text.slice(0,L.ch)+A[0]+$.text.slice(k.ch),y(0)),s.remove(L.line+1,ee);else{S(G,G.text.slice(0,L.ch)+A[0],y(0)),S($,Y+$.text.slice(k.ch),q);var fe=w(1,A.length-1);ee>1&&s.remove(L.line+1,ee-1),s.insert(L.line+1,fe)}fn(s,"change",s,u)}function Mo(s,u,m){function f(y,S,w){if(y.linked)for(var L=0;L<y.linked.length;++L){var k=y.linked[L];if(k.doc!=S){var A=w&&k.sharedHist;m&&!A||(u(k.doc,A),f(k.doc,y,A))}}}f(s,null,!0)}function $T(s,u){if(u.cm)throw new Error("This document is already in use.");s.doc=u,u.cm=s,$y(s),rv(s),jT(s),s.options.direction=u.direction,s.options.lineWrapping||Ry(s),s.options.mode=u.modeOption,cr(s)}function jT(s){(s.doc.direction=="rtl"?me:B)(s.display.lineDiv,"CodeMirror-rtl")}function qB(s){Er(s,function(){jT(s),cr(s)})}function Lf(s){this.done=[],this.undone=[],this.undoDepth=s?s.undoDepth:Infinity,this.lastModTime=this.lastSelTime=0,this.lastOp=this.lastSelOp=null,this.lastOrigin=this.lastSelOrigin=null,this.generation=this.maxGeneration=s?s.maxGeneration:1}function av(s,u){var m={from:te(u.from),to:Ao(u),text:oa(s,u.from,u.to)};return YT(s,m,u.from.line,u.to.line+1),Mo(s,function(f){return YT(f,m,u.from.line,u.to.line+1)},!0),m}function JT(s){for(;s.length;){var u=at(s);if(u.ranges)s.pop();else break}}function YB(s,u){if(u)return JT(s.done),at(s.done);if(s.done.length&&!at(s.done).ranges)return at(s.done);if(s.done.length>1&&!s.done[s.done.length-2].ranges)return s.done.pop(),at(s.done)}function qT(s,u,m,f){var y=s.history;y.undone.length=0;var S=+new Date,w,L;if((y.lastOp==f||y.lastOrigin==u.origin&&u.origin&&(u.origin.charAt(0)=="+"&&y.lastModTime>S-(s.cm?s.cm.options.historyEventDelay:500)||u.origin.charAt(0)=="*"))&&(w=YB(y,y.lastOp==f)))L=at(w.changes),R(u.from,u.to)==0&&R(u.from,L.to)==0?L.to=Ao(u):w.changes.push(av(s,u));else{var k=at(y.done);for((!k||!k.ranges)&&kf(s.sel,y.done),w={changes:[av(s,u)],generation:y.generation},y.done.push(w);y.done.length>y.undoDepth;)y.done.shift(),y.done[0].ranges||y.done.shift()}y.done.push(m),y.generation=++y.maxGeneration,y.lastModTime=y.lastSelTime=S,y.lastOp=y.lastSelOp=f,y.lastOrigin=y.lastSelOrigin=u.origin,L||Ue(s,"historyAdded")}function KB(s,u,m,f){var y=u.charAt(0);return y=="*"||y=="+"&&m.ranges.length==f.ranges.length&&m.somethingSelected()==f.somethingSelected()&&new Date-s.history.lastSelTime<=(s.cm?s.cm.options.historyEventDelay:500)}function XB(s,u,m,f){var y=s.history,S=f&&f.origin;m==y.lastSelOp||S&&y.lastSelOrigin==S&&(y.lastModTime==y.lastSelTime&&y.lastOrigin==S||KB(s,S,at(y.done),u))?y.done[y.done.length-1]=u:kf(u,y.done),y.lastSelTime=+new Date,y.lastSelOrigin=S,y.lastSelOp=m,f&&f.clearRedo!==!1&&JT(y.undone)}function kf(s,u){var m=at(u);m&&m.ranges&&m.equals(s)||u.push(s)}function YT(s,u,m,f){var y=u["spans_"+s.id],S=0;s.iter(Math.max(s.first,m),Math.min(s.first+s.size,f),function(w){w.markedSpans&&((y||(y=u["spans_"+s.id]={}))[S]=w.markedSpans),++S})}function QB(s){if(!s)return null;for(var u,m=0;m<s.length;++m)s[m].marker.explicitlyCleared?u||(u=s.slice(0,m)):u&&u.push(s[m]);return u?u.length?u:null:s}function ZB(s,u){var m=u["spans_"+s.id];if(!m)return null;for(var f=[],y=0;y<u.text.length;++y)f.push(QB(m[y]));return f}function KT(s,u){var m=ZB(s,u),f=Py(s,u);if(!m)return f;if(!f)return m;for(var y=0;y<m.length;++y){var S=m[y],w=f[y];if(S&&w){e:for(var L=0;L<w.length;++L){for(var k=w[L],A=0;A<S.length;++A)if(S[A].marker==k.marker)continue e;S.push(k)}}else w&&(m[y]=w)}return m}function sc(s,u,m){for(var f=[],y=0;y<s.length;++y){var S=s[y];if(S.ranges){f.push(m?Hr.prototype.deepCopy.call(S):S);continue}var w=S.changes,L=[];f.push({changes:L});for(var k=0;k<w.length;++k){var A=w[k],G=void 0;if(L.push({from:A.from,to:A.to,text:A.text}),u)for(var $ in A)(G=$.match(/^spans_(\d+)$/))&&ye(u,Number(G[1]))>-1&&(at(L)[$]=A[$],delete A[$])}}return f}function ov(s,u,m,f){if(f){var y=s.anchor;if(m){var S=R(u,y)<0;S!=R(m,y)<0?(y=u,u=m):S!=R(u,m)<0&&(u=m)}return new mt(y,u)}else return new mt(m||u,u)}function Ef(s,u,m,f,y){y==null&&(y=s.cm&&(s.cm.display.shift||s.extend)),Un(s,new Hr([ov(s.sel.primary(),u,m,y)],0),f)}function XT(s,u,m){for(var f=[],y=s.cm&&(s.cm.display.shift||s.extend),S=0;S<s.sel.ranges.length;S++)f[S]=ov(s.sel.ranges[S],u[S],null,y);var w=Ei(s.cm,f,s.sel.primIndex);Un(s,w,m)}function sv(s,u,m,f){var y=s.sel.ranges.slice(0);y[u]=m,Un(s,Ei(s.cm,y,s.sel.primIndex),f)}function QT(s,u,m,f){Un(s,Io(u,m),f)}function eF(s,u,m){var f={ranges:u.ranges,update:function(y){this.ranges=[];for(var S=0;S<y.length;S++)this.ranges[S]=new mt(ve(s,y[S].anchor),ve(s,y[S].head))},origin:m&&m.origin};return Ue(s,"beforeSelectionChange",s,f),s.cm&&Ue(s.cm,"beforeSelectionChange",s.cm,f),f.ranges!=u.ranges?Ei(s.cm,f.ranges,f.ranges.length-1):u}function ZT(s,u,m){var f=s.history.done,y=at(f);y&&y.ranges?(f[f.length-1]=u,Df(s,u,m)):Un(s,u,m)}function Un(s,u,m){Df(s,u,m),XB(s,s.sel,s.cm?s.cm.curOp.id:NaN,m)}function Df(s,u,m){(Pn(s,"beforeSelectionChange")||s.cm&&Pn(s.cm,"beforeSelectionChange"))&&(u=eF(s,u,m));var f=m&&m.bias||(R(u.primary().head,s.sel.primary().head)<0?-1:1);eL(s,nL(s,u,f,!0)),!(m&&m.scroll===!1)&&s.cm&&s.cm.getOption("readOnly")!="nocursor"&&ac(s.cm)}function eL(s,u){u.equals(s.sel)||(s.sel=u,s.cm&&(s.cm.curOp.updateInput=1,s.cm.curOp.selectionChanged=!0,ql(s.cm)),fn(s,"cursorActivity",s))}function tL(s){eL(s,nL(s,s.sel,null,!1))}function nL(s,u,m,f){for(var y,S=0;S<u.ranges.length;S++){var w=u.ranges[S],L=u.ranges.length==s.sel.ranges.length&&s.sel.ranges[S],k=Pf(s,w.anchor,L&&L.anchor,m,f),A=Pf(s,w.head,L&&L.head,m,f);(y||k!=w.anchor||A!=w.head)&&(y||(y=u.ranges.slice(0,S)),y[S]=new mt(k,A))}return y?Ei(s.cm,y,u.primIndex):u}function lc(s,u,m,f,y){var S=Te(s,u.line);if(S.markedSpans)for(var w=0;w<S.markedSpans.length;++w){var L=S.markedSpans[w],k=L.marker,A="selectLeft"in k?!k.selectLeft:k.inclusiveLeft,G="selectRight"in k?!k.selectRight:k.inclusiveRight;if((L.from==null||(A?L.from<=u.ch:L.from<u.ch))&&(L.to==null||(G?L.to>=u.ch:L.to>u.ch))){if(y&&(Ue(k,"beforeCursorEnter"),k.explicitlyCleared))if(S.markedSpans){--w;continue}else break;if(!k.atomic)continue;if(m){var $=k.find(f<0?1:-1),Y=void 0;if((f<0?G:A)&&($=rL(s,$,-f,$&&$.line==u.line?S:null)),$&&$.line==u.line&&(Y=R($,m))&&(f<0?Y<0:Y>0))return lc(s,$,u,f,y)}var q=k.find(f<0?-1:1);return(f<0?A:G)&&(q=rL(s,q,f,q.line==u.line?S:null)),q?lc(s,q,u,f,y):null}}return u}function Pf(s,u,m,f,y){var S=f||1,w=lc(s,u,m,S,y)||!y&&lc(s,u,m,S,!0)||lc(s,u,m,-S,y)||!y&&lc(s,u,m,-S,!0);return w||(s.cantEdit=!0,se(s.first,0))}function rL(s,u,m,f){return m<0&&u.ch==0?u.line>s.first?ve(s,se(u.line-1)):null:m>0&&u.ch==(f||Te(s,u.line)).text.length?u.line<s.first+s.size-1?se(u.line+1,0):null:new se(u.line,u.ch+m)}function iL(s){s.setSelection(se(s.firstLine(),0),se(s.lastLine()),qe)}function aL(s,u,m){var f={canceled:!1,from:u.from,to:u.to,text:u.text,origin:u.origin,cancel:function(){return f.canceled=!0}};return m&&(f.update=function(y,S,w,L){y&&(f.from=ve(s,y)),S&&(f.to=ve(s,S)),w&&(f.text=w),L!==void 0&&(f.origin=L)}),Ue(s,"beforeChange",s,f),s.cm&&Ue(s.cm,"beforeChange",s.cm,f),f.canceled?(s.cm&&(s.cm.curOp.updateInput=2),null):{from:f.from,to:f.to,text:f.text,origin:f.origin}}function cc(s,u,m){if(s.cm){if(!s.cm.curOp)return hn(s.cm,cc)(s,u,m);if(s.cm.state.suppressEdits)return}if(!((Pn(s,"beforeChange")||s.cm&&Pn(s.cm,"beforeChange"))&&(u=aL(s,u,!0),!u))){var f=Y0&&!m&&XN(s,u.from,u.to);if(f)for(var y=f.length-1;y>=0;--y)oL(s,{from:f[y].from,to:f[y].to,text:y?[""]:u.text,origin:u.origin});else oL(s,u)}}function oL(s,u){if(!(u.text.length==1&&u.text[0]==""&&R(u.from,u.to)==0)){var m=nv(s,u);qT(s,u,m,s.cm?s.cm.curOp.id:NaN),Yu(s,u,m,Py(s,u));var f=[];Mo(s,function(y,S){!S&&ye(f,y.history)==-1&&(uL(y.history,u),f.push(y.history)),Yu(y,u,null,Py(y,u))})}}function If(s,u,m){var f=s.cm&&s.cm.state.suppressEdits;if(!(f&&!m)){for(var y=s.history,S,w=s.sel,L=u=="undo"?y.done:y.undone,k=u=="undo"?y.undone:y.done,A=0;A<L.length&&(S=L[A],!(m?S.ranges&&!S.equals(s.sel):!S.ranges));A++);if(A!=L.length){for(y.lastOrigin=y.lastSelOrigin=null;;)if(S=L.pop(),S.ranges){if(kf(S,k),m&&!S.equals(s.sel)){Un(s,S,{clearRedo:!1});return}w=S}else if(f){L.push(S);return}else break;var G=[];kf(w,k),k.push({changes:G,generation:y.generation}),y.generation=S.generation||++y.maxGeneration;for(var $=Pn(s,"beforeChange")||s.cm&&Pn(s.cm,"beforeChange"),Y=function(re){var de=S.changes[re];if(de.origin=u,$&&!aL(s,de,!1))return L.length=0,{};G.push(av(s,de));var fe=re?nv(s,de):at(L);Yu(s,de,fe,KT(s,de)),!re&&s.cm&&s.cm.scrollIntoView({from:de.from,to:Ao(de)});var Se=[];Mo(s,function(he,be){!be&&ye(Se,he.history)==-1&&(uL(he.history,de),Se.push(he.history)),Yu(he,de,null,KT(he,de))})},q=S.changes.length-1;q>=0;--q){var ee=Y(q);if(ee)return ee.v}}}}function sL(s,u){if(u!=0&&(s.first+=u,s.sel=new Hr(Tr(s.sel.ranges,function(y){return new mt(se(y.anchor.line+u,y.anchor.ch),se(y.head.line+u,y.head.ch))}),s.sel.primIndex),s.cm)){cr(s.cm,s.first,s.first-u,u);for(var m=s.cm.display,f=m.viewFrom;f<m.viewTo;f++)Do(s.cm,f,"gutter")}}function Yu(s,u,m,f){if(s.cm&&!s.cm.curOp)return hn(s.cm,Yu)(s,u,m,f);if(u.to.line<s.first){sL(s,u.text.length-1-(u.to.line-u.from.line));return}if(!(u.from.line>s.lastLine())){if(u.from.line<s.first){var y=u.text.length-1-(s.first-u.from.line);sL(s,y),u={from:se(s.first,0),to:se(u.to.line+y,u.to.ch),text:[at(u.text)],origin:u.origin}}var S=s.lastLine();u.to.line>S&&(u={from:u.from,to:se(S,Te(s,S).text.length),text:[u.text[0]],origin:u.origin}),u.removed=oa(s,u.from,u.to),m||(m=nv(s,u)),s.cm?tF(s.cm,u,f):iv(s,u,f),Df(s,m,qe),s.cantEdit&&Pf(s,se(s.firstLine(),0))&&(s.cantEdit=!1)}}function tF(s,u,m){var f=s.doc,y=s.display,S=u.from,w=u.to,L=!1,k=S.line;s.options.lineWrapping||(k=ht(ca(Te(f,S.line))),f.iter(k,w.line+1,function(q){if(q==y.maxLine)return L=!0,!0})),f.sel.contains(u.from,u.to)>-1&&ql(s),iv(f,u,m,LT(s)),s.options.lineWrapping||(f.iter(k,S.line+u.text.length,function(q){var ee=hf(q);ee>y.maxLineLength&&(y.maxLine=q,y.maxLineLength=ee,y.maxLineChanged=!0,L=!1)}),L&&(s.curOp.updateMaxLine=!0)),HN(f,S.line),ju(s,400);var A=u.text.length-(w.line-S.line)-1;u.full?cr(s):S.line==w.line&&u.text.length==1&&!HT(s.doc,u)?Do(s,S.line,"text"):cr(s,S.line,w.line+1,A);var G=Pn(s,"changes"),$=Pn(s,"change");if($||G){var Y={from:S,to:w,text:u.text,removed:u.removed,origin:u.origin};$&&fn(s,"change",s,Y),G&&(s.curOp.changeObjs||(s.curOp.changeObjs=[])).push(Y)}s.display.selForContextMenu=null}function uc(s,u,m,f,y){var S;f||(f=m),R(f,m)<0&&(S=[f,m],m=S[0],f=S[1]),typeof u=="string"&&(u=s.splitLines(u)),cc(s,{from:m,to:f,text:u,origin:y})}function lL(s,u,m,f){m<s.line?s.line+=f:u<s.line&&(s.line=u,s.ch=0)}function cL(s,u,m,f){for(var y=0;y<s.length;++y){var S=s[y],w=!0;if(S.ranges){S.copied||(S=s[y]=S.deepCopy(),S.copied=!0);for(var L=0;L<S.ranges.length;L++)lL(S.ranges[L].anchor,u,m,f),lL(S.ranges[L].head,u,m,f);continue}for(var k=0;k<S.changes.length;++k){var A=S.changes[k];if(m<A.from.line)A.from=se(A.from.line+f,A.from.ch),A.to=se(A.to.line+f,A.to.ch);else if(u<=A.to.line){w=!1;break}}w||(s.splice(0,y+1),y=0)}}function uL(s,u){var m=u.from.line,f=u.to.line,y=u.text.length-(f-m)-1;cL(s.done,m,f,y),cL(s.undone,m,f,y)}function Ku(s,u,m,f){var y=u,S=u;return typeof u=="number"?S=Te(s,st(s,u)):y=ht(u),y==null?null:(f(S,y)&&s.cm&&Do(s.cm,y,m),S)}function Xu(s){this.lines=s,this.parent=null;for(var u=0,m=0;m<s.length;++m)s[m].parent=this,u+=s[m].height;this.height=u}Xu.prototype={chunkSize:function(){return this.lines.length},removeInner:function(s,u){for(var m=s,f=s+u;m<f;++m){var y=this.lines[m];this.height-=y.height,nB(y),fn(y,"delete")}this.lines.splice(s,u)},collapse:function(s){s.push.apply(s,this.lines)},insertInner:function(s,u,m){this.height+=m,this.lines=this.lines.slice(0,s).concat(u).concat(this.lines.slice(s));for(var f=0;f<u.length;++f)u[f].parent=this},iterN:function(s,u,m){for(var f=s+u;s<f;++s)if(m(this.lines[s]))return!0}};function Qu(s){this.children=s;for(var u=0,m=0,f=0;f<s.length;++f){var y=s[f];u+=y.chunkSize(),m+=y.height,y.parent=this}this.size=u,this.height=m,this.parent=null}Qu.prototype={chunkSize:function(){return this.size},removeInner:function(s,u){this.size-=u;for(var m=0;m<this.children.length;++m){var f=this.children[m],y=f.chunkSize();if(s<y){var S=Math.min(u,y-s),w=f.height;if(f.removeInner(s,S),this.height-=w-f.height,y==S&&(this.children.splice(m--,1),f.parent=null),(u-=S)==0)break;s=0}else s-=y}if(this.size-u<25&&(this.children.length>1||!(this.children[0]instanceof Xu))){var L=[];this.collapse(L),this.children=[new Xu(L)],this.children[0].parent=this}},collapse:function(s){for(var u=0;u<this.children.length;++u)this.children[u].collapse(s)},insertInner:function(s,u,m){this.size+=u.length,this.height+=m;for(var f=0;f<this.children.length;++f){var y=this.children[f],S=y.chunkSize();if(s<=S){if(y.insertInner(s,u,m),y.lines&&y.lines.length>50){for(var w=y.lines.length%25+25,L=w;L<y.lines.length;){var k=new Xu(y.lines.slice(L,L+=25));y.height-=k.height,this.children.splice(++f,0,k),k.parent=this}y.lines=y.lines.slice(0,w),this.maybeSpill()}break}s-=S}},maybeSpill:function(){if(!(this.children.length<=10)){var s=this;do{var u=s.children.splice(s.children.length-5,5),m=new Qu(u);if(s.parent){s.size-=m.size,s.height-=m.height;var y=ye(s.parent.children,s);s.parent.children.splice(y+1,0,m)}else{var f=new Qu(s.children);f.parent=s,s.children=[f,m],s=f}m.parent=s.parent}while(s.children.length>10);s.parent.maybeSpill()}},iterN:function(s,u,m){for(var f=0;f<this.children.length;++f){var y=this.children[f],S=y.chunkSize();if(s<S){var w=Math.min(u,S-s);if(y.iterN(s,w,m))return!0;if((u-=w)==0)break;s=0}else s-=S}}};var Zu=function(s,u,m){if(m)for(var f in m)m.hasOwnProperty(f)&&(this[f]=m[f]);this.doc=s,this.node=u};Zu.prototype.clear=function(){var s=this.doc.cm,u=this.line.widgets,m=this.line,f=ht(m);if(!(f==null||!u)){for(var y=0;y<u.length;++y)u[y]==this&&u.splice(y--,1);u.length||(m.widgets=null);var S=Fu(this);kr(m,Math.max(0,m.height-S)),s&&(Er(s,function(){dL(s,m,-S),Do(s,f,"widget")}),fn(s,"lineWidgetCleared",s,this,f))}},Zu.prototype.changed=function(){var s=this,u=this.height,m=this.doc.cm,f=this.line;this.height=null;var y=Fu(this)-u;!y||(Eo(this.doc,f)||kr(f,f.height+y),m&&Er(m,function(){m.curOp.forceUpdate=!0,dL(m,f,y),fn(m,"lineWidgetChanged",m,s,ht(f))}))},ia(Zu);function dL(s,u,m){Ga(u)<(s.curOp&&s.curOp.scrollTop||s.doc.scrollTop)&&Ky(s,m)}function nF(s,u,m,f){var y=new Zu(s,m,f),S=s.cm;return S&&y.noHScroll&&(S.display.alignWidgets=!0),Ku(s,u,"widget",function(w){var L=w.widgets||(w.widgets=[]);if(y.insertAt==null?L.push(y):L.splice(Math.min(L.length,Math.max(0,y.insertAt)),0,y),y.line=w,S&&!Eo(s,w)){var k=Ga(w)<s.scrollTop;kr(w,w.height+Fu(y)),k&&Ky(S,y.height),S.curOp.forceUpdate=!0}return!0}),S&&fn(S,"lineWidgetAdded",S,y,typeof u=="number"?u:ht(u)),y}var pL=0,Ro=function(s,u){this.lines=[],this.type=u,this.doc=s,this.id=++pL};Ro.prototype.clear=function(){if(!this.explicitlyCleared){var s=this.doc.cm,u=s&&!s.curOp;if(u&&Us(s),Pn(this,"clear")){var m=this.find();m&&fn(this,"clear",m.from,m.to)}for(var f=null,y=null,S=0;S<this.lines.length;++S){var w=this.lines[S],L=Ou(w.markedSpans,this);s&&!this.collapsed?Do(s,ht(w),"text"):s&&(L.to!=null&&(y=ht(w)),L.from!=null&&(f=ht(w))),w.markedSpans=JN(w.markedSpans,L),L.from==null&&this.collapsed&&!Eo(this.doc,w)&&s&&kr(w,nc(s.display))}if(s&&this.collapsed&&!s.options.lineWrapping)for(var k=0;k<this.lines.length;++k){var A=ca(this.lines[k]),G=hf(A);G>s.display.maxLineLength&&(s.display.maxLine=A,s.display.maxLineLength=G,s.display.maxLineChanged=!0)}f!=null&&s&&this.collapsed&&cr(s,f,y+1),this.lines.length=0,this.explicitlyCleared=!0,this.atomic&&this.doc.cantEdit&&(this.doc.cantEdit=!1,s&&tL(s.doc)),s&&fn(s,"markerCleared",s,this,f,y),u&&Gs(s),this.parent&&this.parent.clear()}},Ro.prototype.find=function(s,u){s==null&&this.type=="bookmark"&&(s=1);for(var m,f,y=0;y<this.lines.length;++y){var S=this.lines[y],w=Ou(S.markedSpans,this);if(w.from!=null&&(m=se(u?S:ht(S),w.from),s==-1))return m;if(w.to!=null&&(f=se(u?S:ht(S),w.to),s==1))return f}return m&&{from:m,to:f}},Ro.prototype.changed=function(){var s=this,u=this.find(-1,!0),m=this,f=this.doc.cm;!u||!f||Er(f,function(){var y=u.line,S=ht(u.line),w=Ny(f,S);if(w&&(yT(w),f.curOp.selectionChanged=f.curOp.forceUpdate=!0),f.curOp.updateMaxLine=!0,!Eo(m.doc,y)&&m.height!=null){var L=m.height;m.height=null;var k=Fu(m)-L;k&&kr(y,y.height+k)}fn(f,"markerChanged",f,s)})},Ro.prototype.attachLine=function(s){if(!this.lines.length&&this.doc.cm){var u=this.doc.cm.curOp;(!u.maybeHiddenMarkers||ye(u.maybeHiddenMarkers,this)==-1)&&(u.maybeUnhiddenMarkers||(u.maybeUnhiddenMarkers=[])).push(this)}this.lines.push(s)},Ro.prototype.detachLine=function(s){if(this.lines.splice(ye(this.lines,s),1),!this.lines.length&&this.doc.cm){var u=this.doc.cm.curOp;(u.maybeHiddenMarkers||(u.maybeHiddenMarkers=[])).push(this)}},ia(Ro);function dc(s,u,m,f,y){if(f&&f.shared)return rF(s,u,m,f,y);if(s.cm&&!s.cm.curOp)return hn(s.cm,dc)(s,u,m,f,y);var S=new Ro(s,y),w=R(u,m);if(f&&_e(f,S,!1),w>0||w==0&&S.clearWhenEmpty!==!1)return S;if(S.replacedWith&&(S.collapsed=!0,S.widgetNode=N("span",[S.replacedWith],"CodeMirror-widget"),f.handleMouseEvents||S.widgetNode.setAttribute("cm-ignore-events","true"),f.insertLeft&&(S.widgetNode.insertLeft=!0)),S.collapsed){if(tT(s,u.line,u,m,S)||u.line!=m.line&&tT(s,m.line,u,m,S))throw new Error("Inserting collapsed marker partially overlapping an existing one");jN()}S.addToHistory&&qT(s,{from:u,to:m,origin:"markText"},s.sel,NaN);var L=u.line,k=s.cm,A;if(s.iter(L,m.line+1,function($){k&&S.collapsed&&!k.options.lineWrapping&&ca($)==k.display.maxLine&&(A=!0),S.collapsed&&L!=u.line&&kr($,0),qN($,new uf(S,L==u.line?u.ch:null,L==m.line?m.ch:null),s.cm&&s.cm.curOp),++L}),S.collapsed&&s.iter(u.line,m.line+1,function($){Eo(s,$)&&kr($,0)}),S.clearOnEnter&&Ne(S,"beforeCursorEnter",function(){return S.clear()}),S.readOnly&&($N(),(s.history.done.length||s.history.undone.length)&&s.clearHistory()),S.collapsed&&(S.id=++pL,S.atomic=!0),k){if(A&&(k.curOp.updateMaxLine=!0),S.collapsed)cr(k,u.line,m.line+1);else if(S.className||S.startStyle||S.endStyle||S.css||S.attributes||S.title)for(var G=u.line;G<=m.line;G++)Do(k,G,"text");S.atomic&&tL(k.doc),fn(k,"markerAdded",k,S)}return S}var ed=function(s,u){this.markers=s,this.primary=u;for(var m=0;m<s.length;++m)s[m].parent=this};ed.prototype.clear=function(){if(!this.explicitlyCleared){this.explicitlyCleared=!0;for(var s=0;s<this.markers.length;++s)this.markers[s].clear();fn(this,"clear")}},ed.prototype.find=function(s,u){return this.primary.find(s,u)},ia(ed);function rF(s,u,m,f,y){f=_e(f),f.shared=!1;var S=[dc(s,u,m,f,y)],w=S[0],L=f.widgetNode;return Mo(s,function(k){L&&(f.widgetNode=L.cloneNode(!0)),S.push(dc(k,ve(k,u),ve(k,m),f,y));for(var A=0;A<k.linked.length;++A)if(k.linked[A].isParent)return;w=at(S)}),new ed(S,w)}function fL(s){return s.findMarks(se(s.first,0),s.clipPos(se(s.lastLine())),function(u){return u.parent})}function iF(s,u){for(var m=0;m<u.length;m++){var f=u[m],y=f.find(),S=s.clipPos(y.from),w=s.clipPos(y.to);if(R(S,w)){var L=dc(s,S,w,f.primary,f.primary.type);f.markers.push(L),L.parent=f}}}function aF(s){for(var u=function(f){var y=s[f],S=[y.primary.doc];Mo(y.primary.doc,function(k){return S.push(k)});for(var w=0;w<y.markers.length;w++){var L=y.markers[w];ye(S,L.doc)==-1&&(L.parent=null,y.markers.splice(w--,1))}},m=0;m<s.length;m++)u(m)}var oF=0,ur=function(s,u,m,f,y){if(!(this instanceof ur))return new ur(s,u,m,f,y);m==null&&(m=0),Qu.call(this,[new Xu([new Zl("",null)])]),this.first=m,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.cleanGeneration=1,this.modeFrontier=this.highlightFrontier=m;var S=se(m,0);this.sel=Io(S),this.history=new Lf(null),this.id=++oF,this.modeOption=u,this.lineSep=f,this.direction=y=="rtl"?"rtl":"ltr",this.extend=!1,typeof s=="string"&&(s=this.splitLines(s)),iv(this,{from:S,to:S,text:s}),Un(this,Io(S),qe)};ur.prototype=na(Qu.prototype,{constructor:ur,iter:function(s,u,m){m?this.iterN(s-this.first,u-s,m):this.iterN(this.first,this.first+this.size,s)},insert:function(s,u){for(var m=0,f=0;f<u.length;++f)m+=u[f].height;this.insertInner(s-this.first,u,m)},remove:function(s,u){this.removeInner(s-this.first,u)},getValue:function(s){var u=Ru(this,this.first,this.first+this.size);return s===!1?u:u.join(s||this.lineSeparator())},setValue:mn(function(s){var u=se(this.first,0),m=this.first+this.size-1;cc(this,{from:u,to:se(m,Te(this,m).text.length),text:this.splitLines(s),origin:"setValue",full:!0},!0),this.cm&&Wu(this.cm,0,0),Un(this,Io(u),qe)}),replaceRange:function(s,u,m,f){u=ve(this,u),m=m?ve(this,m):u,uc(this,s,u,m,f)},getRange:function(s,u,m){var f=oa(this,ve(this,s),ve(this,u));return m===!1?f:f.join(m||this.lineSeparator())},getLine:function(s){var u=this.getLineHandle(s);return u&&u.text},getLineHandle:function(s){if(Rs(this,s))return Te(this,s)},getLineNumber:function(s){return ht(s)},getLineHandleVisualStart:function(s){return typeof s=="number"&&(s=Te(this,s)),ca(s)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(s){return ve(this,s)},getCursor:function(s){var u=this.sel.primary(),m;return s==null||s=="head"?m=u.head:s=="anchor"?m=u.anchor:s=="end"||s=="to"||s===!1?m=u.to():m=u.from(),m},listSelections:function(){return this.sel.ranges},somethingSelected:function(){return this.sel.somethingSelected()},setCursor:mn(function(s,u,m){QT(this,ve(this,typeof s=="number"?se(s,u||0):s),null,m)}),setSelection:mn(function(s,u,m){QT(this,ve(this,s),ve(this,u||s),m)}),extendSelection:mn(function(s,u,m){Ef(this,ve(this,s),u&&ve(this,u),m)}),extendSelections:mn(function(s,u){XT(this,Wr(this,s),u)}),extendSelectionsBy:mn(function(s,u){var m=Tr(this.sel.ranges,s);XT(this,Wr(this,m),u)}),setSelections:mn(function(s,u,m){if(!!s.length){for(var f=[],y=0;y<s.length;y++)f[y]=new mt(ve(this,s[y].anchor),ve(this,s[y].head||s[y].anchor));u==null&&(u=Math.min(s.length-1,this.sel.primIndex)),Un(this,Ei(this.cm,f,u),m)}}),addSelection:mn(function(s,u,m){var f=this.sel.ranges.slice(0);f.push(new mt(ve(this,s),ve(this,u||s))),Un(this,Ei(this.cm,f,f.length-1),m)}),getSelection:function(s){for(var u=this.sel.ranges,m,f=0;f<u.length;f++){var y=oa(this,u[f].from(),u[f].to());m=m?m.concat(y):y}return s===!1?m:m.join(s||this.lineSeparator())},getSelections:function(s){for(var u=[],m=this.sel.ranges,f=0;f<m.length;f++){var y=oa(this,m[f].from(),m[f].to());s!==!1&&(y=y.join(s||this.lineSeparator())),u[f]=y}return u},replaceSelection:function(s,u,m){for(var f=[],y=0;y<this.sel.ranges.length;y++)f[y]=s;this.replaceSelections(f,u,m||"+input")},replaceSelections:mn(function(s,u,m){for(var f=[],y=this.sel,S=0;S<y.ranges.length;S++){var w=y.ranges[S];f[S]={from:w.from(),to:w.to(),text:this.splitLines(s[S]),origin:m}}for(var L=u&&u!="end"&&JB(this,f,u),k=f.length-1;k>=0;k--)cc(this,f[k]);L?ZT(this,L):this.cm&&ac(this.cm)}),undo:mn(function(){If(this,"undo")}),redo:mn(function(){If(this,"redo")}),undoSelection:mn(function(){If(this,"undo",!0)}),redoSelection:mn(function(){If(this,"redo",!0)}),setExtending:function(s){this.extend=s},getExtending:function(){return this.extend},historySize:function(){for(var s=this.history,u=0,m=0,f=0;f<s.done.length;f++)s.done[f].ranges||++u;for(var y=0;y<s.undone.length;y++)s.undone[y].ranges||++m;return{undo:u,redo:m}},clearHistory:function(){var s=this;this.history=new Lf(this.history),Mo(this,function(u){return u.history=s.history},!0)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(s){return s&&(this.history.lastOp=this.history.lastSelOp=this.history.lastOrigin=null),this.history.generation},isClean:function(s){return this.history.generation==(s||this.cleanGeneration)},getHistory:function(){return{done:sc(this.history.done),undone:sc(this.history.undone)}},setHistory:function(s){var u=this.history=new Lf(this.history);u.done=sc(s.done.slice(0),null,!0),u.undone=sc(s.undone.slice(0),null,!0)},setGutterMarker:mn(function(s,u,m){return Ku(this,s,"gutter",function(f){var y=f.gutterMarkers||(f.gutterMarkers={});return y[u]=m,!m&&Na(y)&&(f.gutterMarkers=null),!0})}),clearGutter:mn(function(s){var u=this;this.iter(function(m){m.gutterMarkers&&m.gutterMarkers[s]&&Ku(u,m,"gutter",function(){return m.gutterMarkers[s]=null,Na(m.gutterMarkers)&&(m.gutterMarkers=null),!0})})}),lineInfo:function(s){var u;if(typeof s=="number"){if(!Rs(this,s)||(u=s,s=Te(this,s),!s))return null}else if(u=ht(s),u==null)return null;return{line:u,handle:s,text:s.text,gutterMarkers:s.gutterMarkers,textClass:s.textClass,bgClass:s.bgClass,wrapClass:s.wrapClass,widgets:s.widgets}},addLineClass:mn(function(s,u,m){return Ku(this,s,u=="gutter"?"gutter":"class",function(f){var y=u=="text"?"textClass":u=="background"?"bgClass":u=="gutter"?"gutterClass":"wrapClass";if(!f[y])f[y]=m;else{if(O(m).test(f[y]))return!1;f[y]+=" "+m}return!0})}),removeLineClass:mn(function(s,u,m){return Ku(this,s,u=="gutter"?"gutter":"class",function(f){var y=u=="text"?"textClass":u=="background"?"bgClass":u=="gutter"?"gutterClass":"wrapClass",S=f[y];if(S)if(m==null)f[y]=null;else{var w=S.match(O(m));if(!w)return!1;var L=w.index+w[0].length;f[y]=S.slice(0,w.index)+(!w.index||L==S.length?"":" ")+S.slice(L)||null}else return!1;return!0})}),addLineWidget:mn(function(s,u,m){return nF(this,s,u,m)}),removeLineWidget:function(s){s.clear()},markText:function(s,u,m){return dc(this,ve(this,s),ve(this,u),m,m&&m.type||"range")},setBookmark:function(s,u){var m={replacedWith:u&&(u.nodeType==null?u.widget:u),insertLeft:u&&u.insertLeft,clearWhenEmpty:!1,shared:u&&u.shared,handleMouseEvents:u&&u.handleMouseEvents};return s=ve(this,s),dc(this,s,s,m,"bookmark")},findMarksAt:function(s){s=ve(this,s);var u=[],m=Te(this,s.line).markedSpans;if(m)for(var f=0;f<m.length;++f){var y=m[f];(y.from==null||y.from<=s.ch)&&(y.to==null||y.to>=s.ch)&&u.push(y.marker.parent||y.marker)}return u},findMarks:function(s,u,m){s=ve(this,s),u=ve(this,u);var f=[],y=s.line;return this.iter(s.line,u.line+1,function(S){var w=S.markedSpans;if(w)for(var L=0;L<w.length;L++){var k=w[L];!(k.to!=null&&y==s.line&&s.ch>=k.to||k.from==null&&y!=s.line||k.from!=null&&y==u.line&&k.from>=u.ch)&&(!m||m(k.marker))&&f.push(k.marker.parent||k.marker)}++y}),f},getAllMarks:function(){var s=[];return this.iter(function(u){var m=u.markedSpans;if(m)for(var f=0;f<m.length;++f)m[f].from!=null&&s.push(m[f].marker)}),s},posFromIndex:function(s){var u,m=this.first,f=this.lineSeparator().length;return this.iter(function(y){var S=y.text.length+f;if(S>s)return u=s,!0;s-=S,++m}),ve(this,se(m,u))},indexFromPos:function(s){s=ve(this,s);var u=s.ch;if(s.line<this.first||s.ch<0)return 0;var m=this.lineSeparator().length;return this.iter(this.first,s.line,function(f){u+=f.text.length+m}),u},copy:function(s){var u=new ur(Ru(this,this.first,this.first+this.size),this.modeOption,this.first,this.lineSep,this.direction);return u.scrollTop=this.scrollTop,u.scrollLeft=this.scrollLeft,u.sel=this.sel,u.extend=!1,s&&(u.history.undoDepth=this.history.undoDepth,u.setHistory(this.getHistory())),u},linkedDoc:function(s){s||(s={});var u=this.first,m=this.first+this.size;s.from!=null&&s.from>u&&(u=s.from),s.to!=null&&s.to<m&&(m=s.to);var f=new ur(Ru(this,u,m),s.mode||this.modeOption,u,this.lineSep,this.direction);return s.sharedHist&&(f.history=this.history),(this.linked||(this.linked=[])).push({doc:f,sharedHist:s.sharedHist}),f.linked=[{doc:this,isParent:!0,sharedHist:s.sharedHist}],iF(f,fL(this)),f},unlinkDoc:function(s){if(s instanceof _t&&(s=s.doc),this.linked)for(var u=0;u<this.linked.length;++u){var m=this.linked[u];if(m.doc==s){this.linked.splice(u,1),s.unlinkDoc(this),aF(fL(this));break}}if(s.history==this.history){var f=[s.id];Mo(s,function(y){return f.push(y.id)},!0),s.history=new Lf(null),s.history.done=sc(this.history.done,f),s.history.undone=sc(this.history.undone,f)}},iterLinkedDocs:function(s){Mo(this,s)},getMode:function(){return this.mode},getEditor:function(){return this.cm},splitLines:function(s){return this.lineSep?s.split(this.lineSep):Pu(s)},lineSeparator:function(){return this.lineSep||`
`},setDirection:mn(function(s){s!="rtl"&&(s="ltr"),s!=this.direction&&(this.direction=s,this.iter(function(u){return u.order=null}),this.cm&&qB(this.cm))})}),ur.prototype.eachLine=ur.prototype.iter;var hL=0;function sF(s){var u=this;if(mL(u),!(Zt(u,s)||Wa(u.display,s))){Bn(s),o&&(hL=+new Date);var m=Os(u,s,!0),f=s.dataTransfer.files;if(!(!m||u.isReadOnly()))if(f&&f.length&&window.FileReader&&window.File)for(var y=f.length,S=Array(y),w=0,L=function(){++w==y&&hn(u,function(){m=ve(u.doc,m);var q={from:m,to:m,text:u.doc.splitLines(S.filter(function(ee){return ee!=null}).join(u.doc.lineSeparator())),origin:"paste"};cc(u.doc,q),ZT(u.doc,Io(ve(u.doc,m),ve(u.doc,Ao(q))))})()},k=function(q,ee){if(u.options.allowDropFileTypes&&ye(u.options.allowDropFileTypes,q.type)==-1){L();return}var re=new FileReader;re.onerror=function(){return L()},re.onload=function(){var de=re.result;if(/[\x00-\x08\x0e-\x1f]{2}/.test(de)){L();return}S[ee]=de,L()},re.readAsText(q)},A=0;A<f.length;A++)k(f[A],A);else{if(u.state.draggingText&&u.doc.sel.contains(m)>-1){u.state.draggingText(s),setTimeout(function(){return u.display.input.focus()},20);return}try{var G=s.dataTransfer.getData("Text");if(G){var $;if(u.state.draggingText&&!u.state.draggingText.copy&&($=u.listSelections()),Df(u.doc,Io(m,m)),$)for(var Y=0;Y<$.length;++Y)uc(u.doc,"",$[Y].anchor,$[Y].head,"drag");u.replaceSelection(G,"around","paste"),u.display.input.focus()}}catch(q){}}}}function lF(s,u){if(o&&(!s.state.draggingText||+new Date-hL<100)){Ms(u);return}if(!(Zt(s,u)||Wa(s.display,u))&&(u.dataTransfer.setData("Text",s.getSelection()),u.dataTransfer.effectAllowed="copyMove",u.dataTransfer.setDragImage&&!g)){var m=F("img",null,null,"position: fixed; left: 0; top: 0;");m.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",h&&(m.width=m.height=1,s.display.wrapper.appendChild(m),m._top=m.offsetTop),u.dataTransfer.setDragImage(m,0,0),h&&m.parentNode.removeChild(m)}}function cF(s,u){var m=Os(s,u);if(!!m){var f=document.createDocumentFragment();DT(s,m,f),s.display.dragCursor||(s.display.dragCursor=F("div",null,"CodeMirror-cursors CodeMirror-dragcursors"),s.display.lineSpace.insertBefore(s.display.dragCursor,s.display.cursorDiv)),_(s.display.dragCursor,f)}}function mL(s){s.display.dragCursor&&(s.display.lineSpace.removeChild(s.display.dragCursor),s.display.dragCursor=null)}function gL(s){if(!!document.getElementsByClassName){for(var u=document.getElementsByClassName("CodeMirror"),m=[],f=0;f<u.length;f++){var y=u[f].CodeMirror;y&&m.push(y)}m.length&&m[0].operation(function(){for(var S=0;S<m.length;S++)s(m[S])})}}var yL=!1;function uF(){yL||(dF(),yL=!0)}function dF(){var s;Ne(window,"resize",function(){s==null&&(s=setTimeout(function(){s=null,gL(pF)},100))}),Ne(window,"blur",function(){return gL(ic)})}function pF(s){var u=s.display;u.cachedCharWidth=u.cachedTextHeight=u.cachedPaddingH=null,u.scrollbarsClipped=!1,s.setSize()}for(var _o={3:"Pause",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",61:"=",91:"Mod",92:"Mod",93:"Mod",106:"*",107:"=",109:"-",110:".",111:"/",145:"ScrollLock",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",224:"Mod",63232:"Up",63233:"Down",63234:"Left",63235:"Right",63272:"Delete",63273:"Home",63275:"End",63276:"PageUp",63277:"PageDown",63302:"Insert"},td=0;td<10;td++)_o[td+48]=_o[td+96]=String(td);for(var Af=65;Af<=90;Af++)_o[Af]=String.fromCharCode(Af);for(var nd=1;nd<=12;nd++)_o[nd+111]=_o[nd+63235]="F"+nd;var za={};za.basic={Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharAfter",Backspace:"delCharBefore","Shift-Backspace":"delCharBefore",Tab:"defaultTab","Shift-Tab":"indentAuto",Enter:"newlineAndIndent",Insert:"toggleOverwrite",Esc:"singleSelection"},za.pcDefault={"Ctrl-A":"selectAll","Ctrl-D":"deleteLine","Ctrl-Z":"undo","Shift-Ctrl-Z":"redo","Ctrl-Y":"redo","Ctrl-Home":"goDocStart","Ctrl-End":"goDocEnd","Ctrl-Up":"goLineUp","Ctrl-Down":"goLineDown","Ctrl-Left":"goGroupLeft","Ctrl-Right":"goGroupRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delGroupBefore","Ctrl-Delete":"delGroupAfter","Ctrl-S":"save","Ctrl-F":"find","Ctrl-G":"findNext","Shift-Ctrl-G":"findPrev","Shift-Ctrl-F":"replace","Shift-Ctrl-R":"replaceAll","Ctrl-[":"indentLess","Ctrl-]":"indentMore","Ctrl-U":"undoSelection","Shift-Ctrl-U":"redoSelection","Alt-U":"redoSelection",fallthrough:"basic"},za.emacsy={"Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageDown","Shift-Ctrl-V":"goPageUp","Ctrl-D":"delCharAfter","Ctrl-H":"delCharBefore","Alt-Backspace":"delWordBefore","Ctrl-K":"killLine","Ctrl-T":"transposeChars","Ctrl-O":"openLine"},za.macDefault={"Cmd-A":"selectAll","Cmd-D":"deleteLine","Cmd-Z":"undo","Shift-Cmd-Z":"redo","Cmd-Y":"redo","Cmd-Home":"goDocStart","Cmd-Up":"goDocStart","Cmd-End":"goDocEnd","Cmd-Down":"goDocEnd","Alt-Left":"goGroupLeft","Alt-Right":"goGroupRight","Cmd-Left":"goLineLeft","Cmd-Right":"goLineRight","Alt-Backspace":"delGroupBefore","Ctrl-Alt-Backspace":"delGroupAfter","Alt-Delete":"delGroupAfter","Cmd-S":"save","Cmd-F":"find","Cmd-G":"findNext","Shift-Cmd-G":"findPrev","Cmd-Alt-F":"replace","Shift-Cmd-Alt-F":"replaceAll","Cmd-[":"indentLess","Cmd-]":"indentMore","Cmd-Backspace":"delWrappedLineLeft","Cmd-Delete":"delWrappedLineRight","Cmd-U":"undoSelection","Shift-Cmd-U":"redoSelection","Ctrl-Up":"goDocStart","Ctrl-Down":"goDocEnd",fallthrough:["basic","emacsy"]},za.default=P?za.macDefault:za.pcDefault;function fF(s){var u=s.split(/-(?!$)/);s=u[u.length-1];for(var m,f,y,S,w=0;w<u.length-1;w++){var L=u[w];if(/^(cmd|meta|m)$/i.test(L))S=!0;else if(/^a(lt)?$/i.test(L))m=!0;else if(/^(c|ctrl|control)$/i.test(L))f=!0;else if(/^s(hift)?$/i.test(L))y=!0;else throw new Error("Unrecognized modifier name: "+L)}return m&&(s="Alt-"+s),f&&(s="Ctrl-"+s),S&&(s="Cmd-"+s),y&&(s="Shift-"+s),s}function hF(s){var u={};for(var m in s)if(s.hasOwnProperty(m)){var f=s[m];if(/^(name|fallthrough|(de|at)tach)$/.test(m))continue;if(f=="..."){delete s[m];continue}for(var y=Tr(m.split(" "),fF),S=0;S<y.length;S++){var w=void 0,L=void 0;S==y.length-1?(L=y.join(" "),w=f):(L=y.slice(0,S+1).join(" "),w="...");var k=u[L];if(!k)u[L]=w;else if(k!=w)throw new Error("Inconsistent bindings for "+L)}delete s[m]}for(var A in u)s[A]=u[A];return s}function pc(s,u,m,f){u=Mf(u);var y=u.call?u.call(s,f):u[s];if(y===!1)return"nothing";if(y==="...")return"multi";if(y!=null&&m(y))return"handled";if(u.fallthrough){if(Object.prototype.toString.call(u.fallthrough)!="[object Array]")return pc(s,u.fallthrough,m,f);for(var S=0;S<u.fallthrough.length;S++){var w=pc(s,u.fallthrough[S],m,f);if(w)return w}}}function vL(s){var u=typeof s=="string"?s:_o[s.keyCode];return u=="Ctrl"||u=="Alt"||u=="Shift"||u=="Mod"}function SL(s,u,m){var f=s;return u.altKey&&f!="Alt"&&(s="Alt-"+s),(E?u.metaKey:u.ctrlKey)&&f!="Ctrl"&&(s="Ctrl-"+s),(E?u.ctrlKey:u.metaKey)&&f!="Mod"&&(s="Cmd-"+s),!m&&u.shiftKey&&f!="Shift"&&(s="Shift-"+s),s}function bL(s,u){if(h&&s.keyCode==34&&s.char)return!1;var m=_o[s.keyCode];return m==null||s.altGraphKey?!1:(s.keyCode==3&&s.code&&(m=s.code),SL(m,s,u))}function Mf(s){return typeof s=="string"?za[s]:s}function fc(s,u){for(var m=s.doc.sel.ranges,f=[],y=0;y<m.length;y++){for(var S=u(m[y]);f.length&&R(S.from,at(f).to)<=0;){var w=f.pop();if(R(w.from,S.from)<0){S.from=w.from;break}}f.push(S)}Er(s,function(){for(var L=f.length-1;L>=0;L--)uc(s.doc,"",f[L].from,f[L].to,"+delete");ac(s)})}function lv(s,u,m){var f=To(s.text,u+m,m);return f<0||f>s.text.length?null:f}function cv(s,u,m){var f=lv(s,u.ch,m);return f==null?null:new se(u.line,f,m<0?"after":"before")}function uv(s,u,m,f,y){if(s){u.doc.direction=="rtl"&&(y=-y);var S=Lr(m,u.doc.direction);if(S){var w=y<0?at(S):S[0],L=y<0==(w.level==1),k=L?"after":"before",A;if(w.level>0||u.doc.direction=="rtl"){var G=tc(u,m);A=y<0?m.text.length-1:0;var $=da(u,G,A).top;A=Nn(function(Y){return da(u,G,Y).top==$},y<0==(w.level==1)?w.from:w.to-1,A),k=="before"&&(A=lv(m,A,1))}else A=y<0?w.to:w.from;return new se(f,A,k)}}return new se(f,y<0?m.text.length:0,y<0?"before":"after")}function mF(s,u,m,f){var y=Lr(u,s.doc.direction);if(!y)return cv(u,m,f);m.ch>=u.text.length?(m.ch=u.text.length,m.sticky="before"):m.ch<=0&&(m.ch=0,m.sticky="after");var S=Dt(y,m.ch,m.sticky),w=y[S];if(s.doc.direction=="ltr"&&w.level%2==0&&(f>0?w.to>m.ch:w.from<m.ch))return cv(u,m,f);var L=function(fe,Se){return lv(u,fe instanceof se?fe.ch:fe,Se)},k,A=function(fe){return s.options.lineWrapping?(k=k||tc(s,u),TT(s,u,k,fe)):{begin:0,end:u.text.length}},G=A(m.sticky=="before"?L(m,-1):m.ch);if(s.doc.direction=="rtl"||w.level==1){var $=w.level==1==f<0,Y=L(m,$?1:-1);if(Y!=null&&($?Y<=w.to&&Y<=G.end:Y>=w.from&&Y>=G.begin)){var q=$?"before":"after";return new se(m.line,Y,q)}}var ee=function(fe,Se,he){for(var be=function(Tt,gn){return gn?new se(m.line,L(Tt,1),"before"):new se(m.line,Tt,"after")};fe>=0&&fe<y.length;fe+=Se){var Re=y[fe],De=Se>0==(Re.level!=1),Ze=De?he.begin:L(he.end,-1);if(Re.from<=Ze&&Ze<Re.to||(Ze=De?Re.from:L(Re.to,-1),he.begin<=Ze&&Ze<he.end))return be(Ze,De)}},re=ee(S+f,f,G);if(re)return re;var de=f>0?G.end:L(G.begin,-1);return de!=null&&!(f>0&&de==u.text.length)&&(re=ee(f>0?0:y.length-1,f,A(de)),re)?re:null}var rd={selectAll:iL,singleSelection:function(s){return s.setSelection(s.getCursor("anchor"),s.getCursor("head"),qe)},killLine:function(s){return fc(s,function(u){if(u.empty()){var m=Te(s.doc,u.head.line).text.length;return u.head.ch==m&&u.head.line<s.lastLine()?{from:u.head,to:se(u.head.line+1,0)}:{from:u.head,to:se(u.head.line,m)}}else return{from:u.from(),to:u.to()}})},deleteLine:function(s){return fc(s,function(u){return{from:se(u.from().line,0),to:ve(s.doc,se(u.to().line+1,0))}})},delLineLeft:function(s){return fc(s,function(u){return{from:se(u.from().line,0),to:u.from()}})},delWrappedLineLeft:function(s){return fc(s,function(u){var m=s.charCoords(u.head,"div").top+5,f=s.coordsChar({left:0,top:m},"div");return{from:f,to:u.from()}})},delWrappedLineRight:function(s){return fc(s,function(u){var m=s.charCoords(u.head,"div").top+5,f=s.coordsChar({left:s.display.lineDiv.offsetWidth+100,top:m},"div");return{from:u.from(),to:f}})},undo:function(s){return s.undo()},redo:function(s){return s.redo()},undoSelection:function(s){return s.undoSelection()},redoSelection:function(s){return s.redoSelection()},goDocStart:function(s){return s.extendSelection(se(s.firstLine(),0))},goDocEnd:function(s){return s.extendSelection(se(s.lastLine()))},goLineStart:function(s){return s.extendSelectionsBy(function(u){return xL(s,u.head.line)},{origin:"+move",bias:1})},goLineStartSmart:function(s){return s.extendSelectionsBy(function(u){return CL(s,u.head)},{origin:"+move",bias:1})},goLineEnd:function(s){return s.extendSelectionsBy(function(u){return gF(s,u.head.line)},{origin:"+move",bias:-1})},goLineRight:function(s){return s.extendSelectionsBy(function(u){var m=s.cursorCoords(u.head,"div").top+5;return s.coordsChar({left:s.display.lineDiv.offsetWidth+100,top:m},"div")},Ve)},goLineLeft:function(s){return s.extendSelectionsBy(function(u){var m=s.cursorCoords(u.head,"div").top+5;return s.coordsChar({left:0,top:m},"div")},Ve)},goLineLeftSmart:function(s){return s.extendSelectionsBy(function(u){var m=s.cursorCoords(u.head,"div").top+5,f=s.coordsChar({left:0,top:m},"div");return f.ch<s.getLine(f.line).search(/\S/)?CL(s,u.head):f},Ve)},goLineUp:function(s){return s.moveV(-1,"line")},goLineDown:function(s){return s.moveV(1,"line")},goPageUp:function(s){return s.moveV(-1,"page")},goPageDown:function(s){return s.moveV(1,"page")},goCharLeft:function(s){return s.moveH(-1,"char")},goCharRight:function(s){return s.moveH(1,"char")},goColumnLeft:function(s){return s.moveH(-1,"column")},goColumnRight:function(s){return s.moveH(1,"column")},goWordLeft:function(s){return s.moveH(-1,"word")},goGroupRight:function(s){return s.moveH(1,"group")},goGroupLeft:function(s){return s.moveH(-1,"group")},goWordRight:function(s){return s.moveH(1,"word")},delCharBefore:function(s){return s.deleteH(-1,"codepoint")},delCharAfter:function(s){return s.deleteH(1,"char")},delWordBefore:function(s){return s.deleteH(-1,"word")},delWordAfter:function(s){return s.deleteH(1,"word")},delGroupBefore:function(s){return s.deleteH(-1,"group")},delGroupAfter:function(s){return s.deleteH(1,"group")},indentAuto:function(s){return s.indentSelection("smart")},indentMore:function(s){return s.indentSelection("add")},indentLess:function(s){return s.indentSelection("subtract")},insertTab:function(s){return s.replaceSelection("	")},insertSoftTab:function(s){for(var u=[],m=s.listSelections(),f=s.options.tabSize,y=0;y<m.length;y++){var S=m[y].from(),w=Fe(s.getLine(S.line),S.ch,f);u.push(Zi(f-w%f))}s.replaceSelections(u)},defaultTab:function(s){s.somethingSelected()?s.indentSelection("add"):s.execCommand("insertTab")},transposeChars:function(s){return Er(s,function(){for(var u=s.listSelections(),m=[],f=0;f<u.length;f++)if(!!u[f].empty()){var y=u[f].head,S=Te(s.doc,y.line).text;if(S){if(y.ch==S.length&&(y=new se(y.line,y.ch-1)),y.ch>0)y=new se(y.line,y.ch+1),s.replaceRange(S.charAt(y.ch-1)+S.charAt(y.ch-2),se(y.line,y.ch-2),y,"+transpose");else if(y.line>s.doc.first){var w=Te(s.doc,y.line-1).text;w&&(y=new se(y.line,1),s.replaceRange(S.charAt(0)+s.doc.lineSeparator()+w.charAt(w.length-1),se(y.line-1,w.length-1),y,"+transpose"))}}m.push(new mt(y,y))}s.setSelections(m)})},newlineAndIndent:function(s){return Er(s,function(){for(var u=s.listSelections(),m=u.length-1;m>=0;m--)s.replaceRange(s.doc.lineSeparator(),u[m].anchor,u[m].head,"+input");u=s.listSelections();for(var f=0;f<u.length;f++)s.indentLine(u[f].from().line,null,!0);ac(s)})},openLine:function(s){return s.replaceSelection(`
`,"start")},toggleOverwrite:function(s){return s.toggleOverwrite()}};function xL(s,u){var m=Te(s.doc,u),f=ca(m);return f!=m&&(u=ht(f)),uv(!0,s,f,u,1)}function gF(s,u){var m=Te(s.doc,u),f=ZN(m);return f!=m&&(u=ht(f)),uv(!0,s,m,u,-1)}function CL(s,u){var m=xL(s,u.line),f=Te(s.doc,m.line),y=Lr(f,s.doc.direction);if(!y||y[0].level==0){var S=Math.max(m.ch,f.text.search(/\S/)),w=u.line==m.line&&u.ch<=S&&u.ch;return se(m.line,w?0:S,m.sticky)}return m}function Rf(s,u,m){if(typeof u=="string"&&(u=rd[u],!u))return!1;s.display.input.ensurePolled();var f=s.display.shift,y=!1;try{s.isReadOnly()&&(s.state.suppressEdits=!0),m&&(s.display.shift=!1),y=u(s)!=je}finally{s.display.shift=f,s.state.suppressEdits=!1}return y}function yF(s,u,m){for(var f=0;f<s.state.keyMaps.length;f++){var y=pc(u,s.state.keyMaps[f],m,s);if(y)return y}return s.options.extraKeys&&pc(u,s.options.extraKeys,m,s)||pc(u,s.options.keyMap,m,s)}var vF=new rt;function id(s,u,m,f){var y=s.state.keySeq;if(y){if(vL(u))return"handled";if(/\'$/.test(u)?s.state.keySeq=null:vF.set(50,function(){s.state.keySeq==y&&(s.state.keySeq=null,s.display.input.reset())}),wL(s,y+" "+u,m,f))return!0}return wL(s,u,m,f)}function wL(s,u,m,f){var y=yF(s,u,f);return y=="multi"&&(s.state.keySeq=u),y=="handled"&&fn(s,"keyHandled",s,u,m),(y=="handled"||y=="multi")&&(Bn(m),jy(s)),!!y}function TL(s,u){var m=bL(u,!0);return m?u.shiftKey&&!s.state.keySeq?id(s,"Shift-"+m,u,function(f){return Rf(s,f,!0)})||id(s,m,u,function(f){if(typeof f=="string"?/^go[A-Z]/.test(f):f.motion)return Rf(s,f)}):id(s,m,u,function(f){return Rf(s,f)}):!1}function SF(s,u,m){return id(s,"'"+m+"'",u,function(f){return Rf(s,f,!0)})}var dv=null;function LL(s){var u=this;if(!(s.target&&s.target!=u.display.input.getField())&&(u.curOp.focus=pe(),!Zt(u,s))){o&&l<11&&s.keyCode==27&&(s.returnValue=!1);var m=s.keyCode;u.display.shift=m==16||s.shiftKey;var f=TL(u,s);h&&(dv=f?m:null,!f&&m==88&&!lf&&(P?s.metaKey:s.ctrlKey)&&u.replaceSelection("",null,"cut")),t&&!P&&!f&&m==46&&s.shiftKey&&!s.ctrlKey&&document.execCommand&&document.execCommand("cut"),m==18&&!/\bCodeMirror-crosshair\b/.test(u.display.lineDiv.className)&&bF(u)}}function bF(s){var u=s.display.lineDiv;me(u,"CodeMirror-crosshair");function m(f){(f.keyCode==18||!f.altKey)&&(B(u,"CodeMirror-crosshair"),sr(document,"keyup",m),sr(document,"mouseover",m))}Ne(document,"keyup",m),Ne(document,"mouseover",m)}function kL(s){s.keyCode==16&&(this.doc.sel.shift=!1),Zt(this,s)}function EL(s){var u=this;if(!(s.target&&s.target!=u.display.input.getField())&&!(Wa(u.display,s)||Zt(u,s)||s.ctrlKey&&!s.altKey||P&&s.metaKey)){var m=s.keyCode,f=s.charCode;if(h&&m==dv){dv=null,Bn(s);return}if(!(h&&(!s.which||s.which<10)&&TL(u,s))){var y=String.fromCharCode(f==null?m:f);y!="\b"&&(SF(u,s,y)||u.display.input.onKeyPress(s))}}}var xF=400,pv=function(s,u,m){this.time=s,this.pos=u,this.button=m};pv.prototype.compare=function(s,u,m){return this.time+xF>s&&R(u,this.pos)==0&&m==this.button};var ad,od;function CF(s,u){var m=+new Date;return od&&od.compare(m,s,u)?(ad=od=null,"triple"):ad&&ad.compare(m,s,u)?(od=new pv(m,s,u),ad=null,"double"):(ad=new pv(m,s,u),od=null,"single")}function DL(s){var u=this,m=u.display;if(!(Zt(u,s)||m.activeTouch&&m.input.supportsTouch())){if(m.input.ensurePolled(),m.shift=s.shiftKey,Wa(m,s)){c||(m.scroller.draggable=!1,setTimeout(function(){return m.scroller.draggable=!0},100));return}if(!fv(u,s)){var f=Os(u,s),y=af(s),S=f?CF(f,y):"single";window.focus(),y==1&&u.state.selectingText&&u.state.selectingText(s),!(f&&wF(u,y,f,S,s))&&(y==1?f?LF(u,f,S,s):Lo(s)==m.scroller&&Bn(s):y==2?(f&&Ef(u.doc,f),setTimeout(function(){return m.input.focus()},20)):y==3&&(V?u.display.input.onContextMenu(s):Jy(u)))}}}function wF(s,u,m,f,y){var S="Click";return f=="double"?S="Double"+S:f=="triple"&&(S="Triple"+S),S=(u==1?"Left":u==2?"Middle":"Right")+S,id(s,SL(S,y),y,function(w){if(typeof w=="string"&&(w=rd[w]),!w)return!1;var L=!1;try{s.isReadOnly()&&(s.state.suppressEdits=!0),L=w(s,m)!=je}finally{s.state.suppressEdits=!1}return L})}function TF(s,u,m){var f=s.getOption("configureMouse"),y=f?f(s,u,m):{};if(y.unit==null){var S=I?m.shiftKey&&m.metaKey:m.altKey;y.unit=S?"rectangle":u=="single"?"char":u=="double"?"word":"line"}return(y.extend==null||s.doc.extend)&&(y.extend=s.doc.extend||m.shiftKey),y.addNew==null&&(y.addNew=P?m.metaKey:m.ctrlKey),y.moveOnDrag==null&&(y.moveOnDrag=!(P?m.altKey:m.ctrlKey)),y}function LF(s,u,m,f){o?setTimeout(we(PT,s),0):s.curOp.focus=pe();var y=TF(s,m,f),S=s.doc.sel,w;s.options.dragDrop&&Eu&&!s.isReadOnly()&&m=="single"&&(w=S.contains(u))>-1&&(R((w=S.ranges[w]).from(),u)<0||u.xRel>0)&&(R(w.to(),u)>0||u.xRel<0)?kF(s,f,u,y):EF(s,f,u,y)}function kF(s,u,m,f){var y=s.display,S=!1,w=hn(s,function(A){c&&(y.scroller.draggable=!1),s.state.draggingText=!1,s.state.delayingBlurEvent&&(s.hasFocus()?s.state.delayingBlurEvent=!1:Jy(s)),sr(y.wrapper.ownerDocument,"mouseup",w),sr(y.wrapper.ownerDocument,"mousemove",L),sr(y.scroller,"dragstart",k),sr(y.scroller,"drop",w),S||(Bn(A),f.addNew||Ef(s.doc,m,null,null,f.extend),c&&!g||o&&l==9?setTimeout(function(){y.wrapper.ownerDocument.body.focus({preventScroll:!0}),y.input.focus()},20):y.input.focus())}),L=function(A){S=S||Math.abs(u.clientX-A.clientX)+Math.abs(u.clientY-A.clientY)>=10},k=function(){return S=!0};c&&(y.scroller.draggable=!0),s.state.draggingText=w,w.copy=!f.moveOnDrag,Ne(y.wrapper.ownerDocument,"mouseup",w),Ne(y.wrapper.ownerDocument,"mousemove",L),Ne(y.scroller,"dragstart",k),Ne(y.scroller,"drop",w),s.state.delayingBlurEvent=!0,setTimeout(function(){return y.input.focus()},20),y.scroller.dragDrop&&y.scroller.dragDrop()}function PL(s,u,m){if(m=="char")return new mt(u,u);if(m=="word")return s.findWordAt(u);if(m=="line")return new mt(se(u.line,0),ve(s.doc,se(u.line+1,0)));var f=m(s,u);return new mt(f.from,f.to)}function EF(s,u,m,f){o&&Jy(s);var y=s.display,S=s.doc;Bn(u);var w,L,k=S.sel,A=k.ranges;if(f.addNew&&!f.extend?(L=S.sel.contains(m),L>-1?w=A[L]:w=new mt(m,m)):(w=S.sel.primary(),L=S.sel.primIndex),f.unit=="rectangle")f.addNew||(w=new mt(m,m)),m=Os(s,u,!0,!0),L=-1;else{var G=PL(s,m,f.unit);f.extend?w=ov(w,G.anchor,G.head,f.extend):w=G}f.addNew?L==-1?(L=A.length,Un(S,Ei(s,A.concat([w]),L),{scroll:!1,origin:"*mouse"})):A.length>1&&A[L].empty()&&f.unit=="char"&&!f.extend?(Un(S,Ei(s,A.slice(0,L).concat(A.slice(L+1)),0),{scroll:!1,origin:"*mouse"}),k=S.sel):sv(S,L,w,it):(L=0,Un(S,new Hr([w],0),it),k=S.sel);var $=m;function Y(he){if(R($,he)!=0)if($=he,f.unit=="rectangle"){for(var be=[],Re=s.options.tabSize,De=Fe(Te(S,m.line).text,m.ch,Re),Ze=Fe(Te(S,he.line).text,he.ch,Re),Tt=Math.min(De,Ze),gn=Math.max(De,Ze),Ut=Math.min(m.line,he.line),Dr=Math.min(s.lastLine(),Math.max(m.line,he.line));Ut<=Dr;Ut++){var dr=Te(S,Ut).text,en=ft(dr,Tt,Re);Tt==gn?be.push(new mt(se(Ut,en),se(Ut,en))):dr.length>en&&be.push(new mt(se(Ut,en),se(Ut,ft(dr,gn,Re))))}be.length||be.push(new mt(m,m)),Un(S,Ei(s,k.ranges.slice(0,L).concat(be),L),{origin:"*mouse",scroll:!1}),s.scrollIntoView(he)}else{var pr=w,In=PL(s,he,f.unit),rn=pr.anchor,tn;R(In.anchor,rn)>0?(tn=In.head,rn=Ge(pr.from(),In.anchor)):(tn=In.anchor,rn=ue(pr.to(),In.head));var zt=k.ranges.slice(0);zt[L]=DF(s,new mt(ve(S,rn),tn)),Un(S,Ei(s,zt,L),it)}}var q=y.wrapper.getBoundingClientRect(),ee=0;function re(he){var be=++ee,Re=Os(s,he,!0,f.unit=="rectangle");if(!!Re)if(R(Re,$)!=0){s.curOp.focus=pe(),Y(Re);var De=xf(y,S);(Re.line>=De.to||Re.line<De.from)&&setTimeout(hn(s,function(){ee==be&&re(he)}),150)}else{var Ze=he.clientY<q.top?-20:he.clientY>q.bottom?20:0;Ze&&setTimeout(hn(s,function(){ee==be&&(y.scroller.scrollTop+=Ze,re(he))}),50)}}function de(he){s.state.selectingText=!1,ee=Infinity,he&&(Bn(he),y.input.focus()),sr(y.wrapper.ownerDocument,"mousemove",fe),sr(y.wrapper.ownerDocument,"mouseup",Se),S.history.lastSelOrigin=null}var fe=hn(s,function(he){he.buttons===0||!af(he)?de(he):re(he)}),Se=hn(s,de);s.state.selectingText=Se,Ne(y.wrapper.ownerDocument,"mousemove",fe),Ne(y.wrapper.ownerDocument,"mouseup",Se)}function DF(s,u){var m=u.anchor,f=u.head,y=Te(s.doc,m.line);if(R(m,f)==0&&m.sticky==f.sticky)return u;var S=Lr(y);if(!S)return u;var w=Dt(S,m.ch,m.sticky),L=S[w];if(L.from!=m.ch&&L.to!=m.ch)return u;var k=w+(L.from==m.ch==(L.level!=1)?0:1);if(k==0||k==S.length)return u;var A;if(f.line!=m.line)A=(f.line-m.line)*(s.doc.direction=="ltr"?1:-1)>0;else{var G=Dt(S,f.ch,f.sticky),$=G-w||(f.ch-m.ch)*(L.level==1?-1:1);G==k-1||G==k?A=$<0:A=$>0}var Y=S[k+(A?-1:0)],q=A==(Y.level==1),ee=q?Y.from:Y.to,re=q?"after":"before";return m.ch==ee&&m.sticky==re?u:new mt(new se(m.line,ee,re),f)}function IL(s,u,m,f){var y,S;if(u.touches)y=u.touches[0].clientX,S=u.touches[0].clientY;else try{y=u.clientX,S=u.clientY}catch(Y){return!1}if(y>=Math.floor(s.display.gutters.getBoundingClientRect().right))return!1;f&&Bn(u);var w=s.display,L=w.lineDiv.getBoundingClientRect();if(S>L.bottom||!Pn(s,m))return Fr(u);S-=L.top-w.viewOffset;for(var k=0;k<s.display.gutterSpecs.length;++k){var A=w.gutters.childNodes[k];if(A&&A.getBoundingClientRect().right>=y){var G=sa(s.doc,S),$=s.display.gutterSpecs[k];return Ue(s,m,s,G,$.className,u),Fr(u)}}}function fv(s,u){return IL(s,u,"gutterClick",!0)}function AL(s,u){Wa(s.display,u)||PF(s,u)||Zt(s,u,"contextmenu")||V||s.display.input.onContextMenu(u)}function PF(s,u){return Pn(s,"gutterContextMenu")?IL(s,u,"gutterContextMenu",!1):!1}function ML(s){s.display.wrapper.className=s.display.wrapper.className.replace(/\s*cm-s-\S+/g,"")+s.options.theme.replace(/(^|\s)\s*/g," cm-s-"),Uu(s)}var hc={toString:function(){return"CodeMirror.Init"}},RL={},_f={};function IF(s){var u=s.optionHandlers;function m(f,y,S,w){s.defaults[f]=y,S&&(u[f]=w?function(L,k,A){A!=hc&&S(L,k,A)}:S)}s.defineOption=m,s.Init=hc,m("value","",function(f,y){return f.setValue(y)},!0),m("mode",null,function(f,y){f.doc.modeOption=y,rv(f)},!0),m("indentUnit",2,rv,!0),m("indentWithTabs",!1),m("smartIndent",!0),m("tabSize",4,function(f){qu(f),Uu(f),cr(f)},!0),m("lineSeparator",null,function(f,y){if(f.doc.lineSep=y,!!y){var S=[],w=f.doc.first;f.doc.iter(function(k){for(var A=0;;){var G=k.text.indexOf(y,A);if(G==-1)break;A=G+y.length,S.push(se(w,G))}w++});for(var L=S.length-1;L>=0;L--)uc(f.doc,y,S[L],se(S[L].line,S[L].ch+y.length))}}),m("specialChars",/[\u0000-\u001f\u007f-\u009f\u00ad\u061c\u200b\u200e\u200f\u2028\u2029\ufeff\ufff9-\ufffc]/g,function(f,y,S){f.state.specialChars=new RegExp(y.source+(y.test("	")?"":"|	"),"g"),S!=hc&&f.refresh()}),m("specialCharPlaceholder",aB,function(f){return f.refresh()},!0),m("electricChars",!0),m("inputStyle",T?"contenteditable":"textarea",function(){throw new Error("inputStyle can not (yet) be changed in a running editor")},!0),m("spellcheck",!1,function(f,y){return f.getInputField().spellcheck=y},!0),m("autocorrect",!1,function(f,y){return f.getInputField().autocorrect=y},!0),m("autocapitalize",!1,function(f,y){return f.getInputField().autocapitalize=y},!0),m("rtlMoveVisually",!M),m("wholeLineUpdateBefore",!0),m("theme","default",function(f){ML(f),Ju(f)},!0),m("keyMap","default",function(f,y,S){var w=Mf(y),L=S!=hc&&Mf(S);L&&L.detach&&L.detach(f,w),w.attach&&w.attach(f,L||null)}),m("extraKeys",null),m("configureMouse",null),m("lineWrapping",!1,MF,!0),m("gutters",[],function(f,y){f.display.gutterSpecs=tv(y,f.options.lineNumbers),Ju(f)},!0),m("fixedGutter",!0,function(f,y){f.display.gutters.style.left=y?Hy(f.display)+"px":"0",f.refresh()},!0),m("coverGutterNextToScrollbar",!1,function(f){return oc(f)},!0),m("scrollbarStyle","native",function(f){VT(f),oc(f),f.display.scrollbars.setScrollTop(f.doc.scrollTop),f.display.scrollbars.setScrollLeft(f.doc.scrollLeft)},!0),m("lineNumbers",!1,function(f,y){f.display.gutterSpecs=tv(f.options.gutters,y),Ju(f)},!0),m("firstLineNumber",1,Ju,!0),m("lineNumberFormatter",function(f){return f},Ju,!0),m("showCursorWhenSelecting",!1,Gu,!0),m("resetSelectionOnContextMenu",!0),m("lineWiseCopyCut",!0),m("pasteLinesPerSelection",!0),m("selectionsMayTouch",!1),m("readOnly",!1,function(f,y){y=="nocursor"&&(ic(f),f.display.input.blur()),f.display.input.readOnlyChanged(y)}),m("screenReaderLabel",null,function(f,y){y=y===""?null:y,f.display.input.screenReaderLabelChanged(y)}),m("disableInput",!1,function(f,y){y||f.display.input.reset()},!0),m("dragDrop",!0,AF),m("allowDropFileTypes",null),m("cursorBlinkRate",530),m("cursorScrollMargin",0),m("cursorHeight",1,Gu,!0),m("singleCursorHeightPerLine",!0,Gu,!0),m("workTime",100),m("workDelay",100),m("flattenSpans",!0,qu,!0),m("addModeClass",!1,qu,!0),m("pollInterval",100),m("undoDepth",200,function(f,y){return f.doc.history.undoDepth=y}),m("historyEventDelay",1250),m("viewportMargin",10,function(f){return f.refresh()},!0),m("maxHighlightLength",1e4,qu,!0),m("moveInputWithCursor",!0,function(f,y){y||f.display.input.resetPosition()}),m("tabindex",null,function(f,y){return f.display.input.getField().tabIndex=y||""}),m("autofocus",null),m("direction","ltr",function(f,y){return f.doc.setDirection(y)},!0),m("phrases",null)}function AF(s,u,m){var f=m&&m!=hc;if(!u!=!f){var y=s.display.dragFunctions,S=u?Ne:sr;S(s.display.scroller,"dragstart",y.start),S(s.display.scroller,"dragenter",y.enter),S(s.display.scroller,"dragover",y.over),S(s.display.scroller,"dragleave",y.leave),S(s.display.scroller,"drop",y.drop)}}function MF(s){s.options.lineWrapping?(me(s.display.wrapper,"CodeMirror-wrap"),s.display.sizer.style.minWidth="",s.display.sizerWidth=null):(B(s.display.wrapper,"CodeMirror-wrap"),Ry(s)),$y(s),cr(s),Uu(s),setTimeout(function(){return oc(s)},100)}function _t(s,u){var m=this;if(!(this instanceof _t))return new _t(s,u);this.options=u=u?_e(u):{},_e(RL,u,!1);var f=u.value;typeof f=="string"?f=new ur(f,u.mode,null,u.lineSeparator,u.direction):u.mode&&(f.modeOption=u.mode),this.doc=f;var y=new _t.inputStyles[u.inputStyle](this),S=this.display=new $B(s,f,y,u);S.wrapper.CodeMirror=this,ML(this),u.lineWrapping&&(this.display.wrapper.className+=" CodeMirror-wrap"),VT(this),this.state={keyMaps:[],overlays:[],modeGen:0,overwrite:!1,delayingBlurEvent:!1,focused:!1,suppressEdits:!1,pasteIncoming:-1,cutIncoming:-1,selectingText:!1,draggingText:!1,highlight:new rt,keySeq:null,specialChars:null},u.autofocus&&!T&&S.input.focus(),o&&l<11&&setTimeout(function(){return m.display.input.reset(!0)},20),RF(this),uF(),Us(this),this.curOp.forceUpdate=!0,$T(this,f),u.autofocus&&!T||this.hasFocus()?setTimeout(function(){m.hasFocus()&&!m.state.focused&&qy(m)},20):ic(this);for(var w in _f)_f.hasOwnProperty(w)&&_f[w](this,u[w],hc);BT(this),u.finishInit&&u.finishInit(this);for(var L=0;L<hv.length;++L)hv[L](this);Gs(this),c&&u.lineWrapping&&getComputedStyle(S.lineDiv).textRendering=="optimizelegibility"&&(S.lineDiv.style.textRendering="auto")}_t.defaults=RL,_t.optionHandlers=_f;function RF(s){var u=s.display;Ne(u.scroller,"mousedown",hn(s,DL)),o&&l<11?Ne(u.scroller,"dblclick",hn(s,function(k){if(!Zt(s,k)){var A=Os(s,k);if(!(!A||fv(s,k)||Wa(s.display,k))){Bn(k);var G=s.findWordAt(A);Ef(s.doc,G.anchor,G.head)}}})):Ne(u.scroller,"dblclick",function(k){return Zt(s,k)||Bn(k)}),Ne(u.scroller,"contextmenu",function(k){return AL(s,k)}),Ne(u.input.getField(),"contextmenu",function(k){u.scroller.contains(k.target)||AL(s,k)});var m,f={end:0};function y(){u.activeTouch&&(m=setTimeout(function(){return u.activeTouch=null},1e3),f=u.activeTouch,f.end=+new Date)}function S(k){if(k.touches.length!=1)return!1;var A=k.touches[0];return A.radiusX<=1&&A.radiusY<=1}function w(k,A){if(A.left==null)return!0;var G=A.left-k.left,$=A.top-k.top;return G*G+$*$>20*20}Ne(u.scroller,"touchstart",function(k){if(!Zt(s,k)&&!S(k)&&!fv(s,k)){u.input.ensurePolled(),clearTimeout(m);var A=+new Date;u.activeTouch={start:A,moved:!1,prev:A-f.end<=300?f:null},k.touches.length==1&&(u.activeTouch.left=k.touches[0].pageX,u.activeTouch.top=k.touches[0].pageY)}}),Ne(u.scroller,"touchmove",function(){u.activeTouch&&(u.activeTouch.moved=!0)}),Ne(u.scroller,"touchend",function(k){var A=u.activeTouch;if(A&&!Wa(u,k)&&A.left!=null&&!A.moved&&new Date-A.start<300){var G=s.coordsChar(u.activeTouch,"page"),$;!A.prev||w(A,A.prev)?$=new mt(G,G):!A.prev.prev||w(A,A.prev.prev)?$=s.findWordAt(G):$=new mt(se(G.line,0),ve(s.doc,se(G.line+1,0))),s.setSelection($.anchor,$.head),s.focus(),Bn(k)}y()}),Ne(u.scroller,"touchcancel",y),Ne(u.scroller,"scroll",function(){u.scroller.clientHeight&&(zu(s,u.scroller.scrollTop),Bs(s,u.scroller.scrollLeft,!0),Ue(s,"scroll",s))}),Ne(u.scroller,"mousewheel",function(k){return GT(s,k)}),Ne(u.scroller,"DOMMouseScroll",function(k){return GT(s,k)}),Ne(u.wrapper,"scroll",function(){return u.wrapper.scrollTop=u.wrapper.scrollLeft=0}),u.dragFunctions={enter:function(k){Zt(s,k)||Ms(k)},over:function(k){Zt(s,k)||(cF(s,k),Ms(k))},start:function(k){return lF(s,k)},drop:hn(s,sF),leave:function(k){Zt(s,k)||mL(s)}};var L=u.input.getField();Ne(L,"keyup",function(k){return kL.call(s,k)}),Ne(L,"keydown",hn(s,LL)),Ne(L,"keypress",hn(s,EL)),Ne(L,"focus",function(k){return qy(s,k)}),Ne(L,"blur",function(k){return ic(s,k)})}var hv=[];_t.defineInitHook=function(s){return hv.push(s)};function sd(s,u,m,f){var y=s.doc,S;m==null&&(m="add"),m=="smart"&&(y.mode.indent?S=Vu(s,u).state:m="prev");var w=s.options.tabSize,L=Te(y,u),k=Fe(L.text,null,w);L.stateAfter&&(L.stateAfter=null);var A=L.text.match(/^\s*/)[0],G;if(!f&&!/\S/.test(L.text))G=0,m="not";else if(m=="smart"&&(G=y.mode.indent(S,L.text.slice(A.length),L.text),G==je||G>150)){if(!f)return;m="prev"}m=="prev"?u>y.first?G=Fe(Te(y,u-1).text,null,w):G=0:m=="add"?G=k+s.options.indentUnit:m=="subtract"?G=k-s.options.indentUnit:typeof m=="number"&&(G=k+m),G=Math.max(0,G);var $="",Y=0;if(s.options.indentWithTabs)for(var q=Math.floor(G/w);q;--q)Y+=w,$+="	";if(Y<G&&($+=Zi(G-Y)),$!=A)return uc(y,$,se(u,0),se(u,A.length),"+input"),L.stateAfter=null,!0;for(var ee=0;ee<y.sel.ranges.length;ee++){var re=y.sel.ranges[ee];if(re.head.line==u&&re.head.ch<A.length){var de=se(u,A.length);sv(y,ee,new mt(de,de));break}}}var Di=null;function Vf(s){Di=s}function mv(s,u,m,f,y){var S=s.doc;s.display.shift=!1,f||(f=S.sel);var w=+new Date-200,L=y=="paste"||s.state.pasteIncoming>w,k=Pu(u),A=null;if(L&&f.ranges.length>1)if(Di&&Di.text.join(`
`)==u){if(f.ranges.length%Di.text.length==0){A=[];for(var G=0;G<Di.text.length;G++)A.push(S.splitLines(Di.text[G]))}}else k.length==f.ranges.length&&s.options.pasteLinesPerSelection&&(A=Tr(k,function(fe){return[fe]}));for(var $=s.curOp.updateInput,Y=f.ranges.length-1;Y>=0;Y--){var q=f.ranges[Y],ee=q.from(),re=q.to();q.empty()&&(m&&m>0?ee=se(ee.line,ee.ch-m):s.state.overwrite&&!L?re=se(re.line,Math.min(Te(S,re.line).text.length,re.ch+at(k).length)):L&&Di&&Di.lineWise&&Di.text.join(`
`)==k.join(`
`)&&(ee=re=se(ee.line,0)));var de={from:ee,to:re,text:A?A[Y%A.length]:k,origin:y||(L?"paste":s.state.cutIncoming>w?"cut":"+input")};cc(s.doc,de),fn(s,"inputRead",s,de)}u&&!L&&VL(s,u),ac(s),s.curOp.updateInput<2&&(s.curOp.updateInput=$),s.curOp.typing=!0,s.state.pasteIncoming=s.state.cutIncoming=-1}function _L(s,u){var m=s.clipboardData&&s.clipboardData.getData("Text");if(m)return s.preventDefault(),!u.isReadOnly()&&!u.options.disableInput&&Er(u,function(){return mv(u,m,0,null,"paste")}),!0}function VL(s,u){if(!(!s.options.electricChars||!s.options.smartIndent))for(var m=s.doc.sel,f=m.ranges.length-1;f>=0;f--){var y=m.ranges[f];if(!(y.head.ch>100||f&&m.ranges[f-1].head.line==y.head.line)){var S=s.getModeAt(y.head),w=!1;if(S.electricChars){for(var L=0;L<S.electricChars.length;L++)if(u.indexOf(S.electricChars.charAt(L))>-1){w=sd(s,y.head.line,"smart");break}}else S.electricInput&&S.electricInput.test(Te(s.doc,y.head.line).text.slice(0,y.head.ch))&&(w=sd(s,y.head.line,"smart"));w&&fn(s,"electricInput",s,y.head.line)}}}function OL(s){for(var u=[],m=[],f=0;f<s.doc.sel.ranges.length;f++){var y=s.doc.sel.ranges[f].head.line,S={anchor:se(y,0),head:se(y+1,0)};m.push(S),u.push(s.getRange(S.anchor,S.head))}return{text:u,ranges:m}}function NL(s,u,m,f){s.setAttribute("autocorrect",m?"":"off"),s.setAttribute("autocapitalize",f?"":"off"),s.setAttribute("spellcheck",!!u)}function BL(){var s=F("textarea",null,null,"position: absolute; bottom: -1em; padding: 0; width: 1px; height: 1em; outline: none"),u=F("div",[s],null,"overflow: hidden; position: relative; width: 3px; height: 0px;");return c?s.style.width="1000px":s.setAttribute("wrap","off"),x&&(s.style.border="1px solid black"),NL(s),u}function _F(s){var u=s.optionHandlers,m=s.helpers={};s.prototype={constructor:s,focus:function(){window.focus(),this.display.input.focus()},setOption:function(f,y){var S=this.options,w=S[f];S[f]==y&&f!="mode"||(S[f]=y,u.hasOwnProperty(f)&&hn(this,u[f])(this,y,w),Ue(this,"optionChange",this,f))},getOption:function(f){return this.options[f]},getDoc:function(){return this.doc},addKeyMap:function(f,y){this.state.keyMaps[y?"push":"unshift"](Mf(f))},removeKeyMap:function(f){for(var y=this.state.keyMaps,S=0;S<y.length;++S)if(y[S]==f||y[S].name==f)return y.splice(S,1),!0},addOverlay:Kn(function(f,y){var S=f.token?f:s.getMode(this.options,f);if(S.startState)throw new Error("Overlays may not be stateful.");ea(this.state.overlays,{mode:S,modeSpec:f,opaque:y&&y.opaque,priority:y&&y.priority||0},function(w){return w.priority}),this.state.modeGen++,cr(this)}),removeOverlay:Kn(function(f){for(var y=this.state.overlays,S=0;S<y.length;++S){var w=y[S].modeSpec;if(w==f||typeof f=="string"&&w.name==f){y.splice(S,1),this.state.modeGen++,cr(this);return}}}),indentLine:Kn(function(f,y,S){typeof y!="string"&&typeof y!="number"&&(y==null?y=this.options.smartIndent?"smart":"prev":y=y?"add":"subtract"),Rs(this.doc,f)&&sd(this,f,y,S)}),indentSelection:Kn(function(f){for(var y=this.doc.sel.ranges,S=-1,w=0;w<y.length;w++){var L=y[w];if(L.empty())L.head.line>S&&(sd(this,L.head.line,f,!0),S=L.head.line,w==this.doc.sel.primIndex&&ac(this));else{var k=L.from(),A=L.to(),G=Math.max(S,k.line);S=Math.min(this.lastLine(),A.line-(A.ch?0:1))+1;for(var $=G;$<S;++$)sd(this,$,f);var Y=this.doc.sel.ranges;k.ch==0&&y.length==Y.length&&Y[w].from().ch>0&&sv(this.doc,w,new mt(k,Y[w].to()),qe)}}}),getTokenAt:function(f,y){return j0(this,f,y)},getLineTokens:function(f,y){return j0(this,se(f),y,!0)},getTokenTypeAt:function(f){f=ve(this.doc,f);var y=z0(this,Te(this.doc,f.line)),S=0,w=(y.length-1)/2,L=f.ch,k;if(L==0)k=y[2];else for(;;){var A=S+w>>1;if((A?y[A*2-1]:0)>=L)w=A;else if(y[A*2+1]<L)S=A+1;else{k=y[A*2+2];break}}var G=k?k.indexOf("overlay "):-1;return G<0?k:G==0?null:k.slice(0,G-1)},getModeAt:function(f){var y=this.doc.mode;return y.innerMode?s.innerMode(y,this.getTokenAt(f).state).mode:y},getHelper:function(f,y){return this.getHelpers(f,y)[0]},getHelpers:function(f,y){var S=[];if(!m.hasOwnProperty(y))return S;var w=m[y],L=this.getModeAt(f);if(typeof L[y]=="string")w[L[y]]&&S.push(w[L[y]]);else if(L[y])for(var k=0;k<L[y].length;k++){var A=w[L[y][k]];A&&S.push(A)}else L.helperType&&w[L.helperType]?S.push(w[L.helperType]):w[L.name]&&S.push(w[L.name]);for(var G=0;G<w._global.length;G++){var $=w._global[G];$.pred(L,this)&&ye(S,$.val)==-1&&S.push($.val)}return S},getStateAfter:function(f,y){var S=this.doc;return f=st(S,f==null?S.first+S.size-1:f),Vu(this,f+1,y).state},cursorCoords:function(f,y){var S,w=this.doc.sel.primary();return f==null?S=w.head:typeof f=="object"?S=ve(this.doc,f):S=f?w.from():w.to(),ki(this,S,y||"page")},charCoords:function(f,y){return Fy(this,ve(this.doc,f),y||"page")},coordsChar:function(f,y){return f=xT(this,f,y||"page"),Gy(this,f.left,f.top)},lineAtHeight:function(f,y){return f=xT(this,{top:f,left:0},y||"page").top,sa(this.doc,f+this.display.viewOffset)},heightAtLine:function(f,y,S){var w=!1,L;if(typeof f=="number"){var k=this.doc.first+this.doc.size-1;f<this.doc.first?f=this.doc.first:f>k&&(f=k,w=!0),L=Te(this.doc,f)}else L=f;return yf(this,L,{top:0,left:0},y||"page",S||w).top+(w?this.doc.height-Ga(L):0)},defaultTextHeight:function(){return nc(this.display)},defaultCharWidth:function(){return rc(this.display)},getViewport:function(){return{from:this.display.viewFrom,to:this.display.viewTo}},addWidget:function(f,y,S,w,L){var k=this.display;f=ki(this,ve(this.doc,f));var A=f.bottom,G=f.left;if(y.style.position="absolute",y.setAttribute("cm-ignore-events","true"),this.display.input.setUneditable(y),k.sizer.appendChild(y),w=="over")A=f.top;else if(w=="above"||w=="near"){var $=Math.max(k.wrapper.clientHeight,this.doc.height),Y=Math.max(k.sizer.clientWidth,k.lineSpace.clientWidth);(w=="above"||f.bottom+y.offsetHeight>$)&&f.top>y.offsetHeight?A=f.top-y.offsetHeight:f.bottom+y.offsetHeight<=$&&(A=f.bottom),G+y.offsetWidth>Y&&(G=Y-y.offsetWidth)}y.style.top=A+"px",y.style.left=y.style.right="",L=="right"?(G=k.sizer.clientWidth-y.offsetWidth,y.style.right="0px"):(L=="left"?G=0:L=="middle"&&(G=(k.sizer.clientWidth-y.offsetWidth)/2),y.style.left=G+"px"),S&&AB(this,{left:G,top:A,right:G+y.offsetWidth,bottom:A+y.offsetHeight})},triggerOnKeyDown:Kn(LL),triggerOnKeyPress:Kn(EL),triggerOnKeyUp:kL,triggerOnMouseDown:Kn(DL),execCommand:function(f){if(rd.hasOwnProperty(f))return rd[f].call(null,this)},triggerElectric:Kn(function(f){VL(this,f)}),findPosH:function(f,y,S,w){var L=1;y<0&&(L=-1,y=-y);for(var k=ve(this.doc,f),A=0;A<y&&(k=gv(this.doc,k,L,S,w),!k.hitSide);++A);return k},moveH:Kn(function(f,y){var S=this;this.extendSelectionsBy(function(w){return S.display.shift||S.doc.extend||w.empty()?gv(S.doc,w.head,f,y,S.options.rtlMoveVisually):f<0?w.from():w.to()},Ve)}),deleteH:Kn(function(f,y){var S=this.doc.sel,w=this.doc;S.somethingSelected()?w.replaceSelection("",null,"+delete"):fc(this,function(L){var k=gv(w,L.head,f,y,!1);return f<0?{from:k,to:L.head}:{from:L.head,to:k}})}),findPosV:function(f,y,S,w){var L=1,k=w;y<0&&(L=-1,y=-y);for(var A=ve(this.doc,f),G=0;G<y;++G){var $=ki(this,A,"div");if(k==null?k=$.left:$.left=k,A=FL(this,$,L,S),A.hitSide)break}return A},moveV:Kn(function(f,y){var S=this,w=this.doc,L=[],k=!this.display.shift&&!w.extend&&w.sel.somethingSelected();if(w.extendSelectionsBy(function(G){if(k)return f<0?G.from():G.to();var $=ki(S,G.head,"div");G.goalColumn!=null&&($.left=G.goalColumn),L.push($.left);var Y=FL(S,$,f,y);return y=="page"&&G==w.sel.primary()&&Ky(S,Fy(S,Y,"div").top-$.top),Y},Ve),L.length)for(var A=0;A<w.sel.ranges.length;A++)w.sel.ranges[A].goalColumn=L[A]}),findWordAt:function(f){var y=this.doc,S=Te(y,f.line).text,w=f.ch,L=f.ch;if(S){var k=this.getHelper(f,"wordChars");(f.sticky=="before"||L==S.length)&&w?--w:++L;for(var A=S.charAt(w),G=wi(A,k)?function($){return wi($,k)}:/\s/.test(A)?function($){return/\s/.test($)}:function($){return!/\s/.test($)&&!wi($)};w>0&&G(S.charAt(w-1));)--w;for(;L<S.length&&G(S.charAt(L));)++L}return new mt(se(f.line,w),se(f.line,L))},toggleOverwrite:function(f){f!=null&&f==this.state.overwrite||((this.state.overwrite=!this.state.overwrite)?me(this.display.cursorDiv,"CodeMirror-overwrite"):B(this.display.cursorDiv,"CodeMirror-overwrite"),Ue(this,"overwriteToggle",this,this.state.overwrite))},hasFocus:function(){return this.display.input.getField()==pe()},isReadOnly:function(){return!!(this.options.readOnly||this.doc.cantEdit)},scrollTo:Kn(function(f,y){Wu(this,f,y)}),getScrollInfo:function(){var f=this.display.scroller;return{left:f.scrollLeft,top:f.scrollTop,height:f.scrollHeight-ua(this)-this.display.barHeight,width:f.scrollWidth-ua(this)-this.display.barWidth,clientHeight:Oy(this),clientWidth:_s(this)}},scrollIntoView:Kn(function(f,y){f==null?(f={from:this.doc.sel.primary().head,to:null},y==null&&(y=this.options.cursorScrollMargin)):typeof f=="number"?f={from:se(f,0),to:null}:f.from==null&&(f={from:f,to:null}),f.to||(f.to=f.from),f.margin=y||0,f.from.line!=null?MB(this,f):AT(this,f.from,f.to,f.margin)}),setSize:Kn(function(f,y){var S=this,w=function(k){return typeof k=="number"||/^\d+$/.test(String(k))?k+"px":k};f!=null&&(this.display.wrapper.style.width=w(f)),y!=null&&(this.display.wrapper.style.height=w(y)),this.options.lineWrapping&&vT(this);var L=this.display.viewFrom;this.doc.iter(L,this.display.viewTo,function(k){if(k.widgets){for(var A=0;A<k.widgets.length;A++)if(k.widgets[A].noHScroll){Do(S,L,"widget");break}}++L}),this.curOp.forceUpdate=!0,Ue(this,"refresh",this)}),operation:function(f){return Er(this,f)},startOperation:function(){return Us(this)},endOperation:function(){return Gs(this)},refresh:Kn(function(){var f=this.display.cachedTextHeight;cr(this),this.curOp.forceUpdate=!0,Uu(this),Wu(this,this.doc.scrollLeft,this.doc.scrollTop),Zy(this.display),(f==null||Math.abs(f-nc(this.display))>.5||this.options.lineWrapping)&&$y(this),Ue(this,"refresh",this)}),swapDoc:Kn(function(f){var y=this.doc;return y.cm=null,this.state.selectingText&&this.state.selectingText(),$T(this,f),Uu(this),this.display.input.reset(),Wu(this,f.scrollLeft,f.scrollTop),this.curOp.forceScroll=!0,fn(this,"swapDoc",this,y),y}),phrase:function(f){var y=this.options.phrases;return y&&Object.prototype.hasOwnProperty.call(y,f)?y[f]:f},getInputField:function(){return this.display.input.getField()},getWrapperElement:function(){return this.display.wrapper},getScrollerElement:function(){return this.display.scroller},getGutterElement:function(){return this.display.gutters}},ia(s),s.registerHelper=function(f,y,S){m.hasOwnProperty(f)||(m[f]=s[f]={_global:[]}),m[f][y]=S},s.registerGlobalHelper=function(f,y,S,w){s.registerHelper(f,y,w),m[f]._global.push({pred:S,val:w})}}function gv(s,u,m,f,y){var S=u,w=m,L=Te(s,u.line),k=y&&s.direction=="rtl"?-m:m;function A(){var Se=u.line+k;return Se<s.first||Se>=s.first+s.size?!1:(u=new se(Se,u.ch,u.sticky),L=Te(s,Se))}function G(Se){var he;if(f=="codepoint"){var be=L.text.charCodeAt(u.ch+(m>0?0:-1));if(isNaN(be))he=null;else{var Re=m>0?be>=55296&&be<56320:be>=56320&&be<57343;he=new se(u.line,Math.max(0,Math.min(L.text.length,u.ch+m*(Re?2:1))),-m)}}else y?he=mF(s.cm,L,u,m):he=cv(L,u,m);if(he==null)if(!Se&&A())u=uv(y,s.cm,L,u.line,k);else return!1;else u=he;return!0}if(f=="char"||f=="codepoint")G();else if(f=="column")G(!0);else if(f=="word"||f=="group")for(var $=null,Y=f=="group",q=s.cm&&s.cm.getHelper(u,"wordChars"),ee=!0;!(m<0&&!G(!ee));ee=!1){var re=L.text.charAt(u.ch)||`
`,de=wi(re,q)?"w":Y&&re==`
`?"n":!Y||/\s/.test(re)?null:"p";if(Y&&!ee&&!de&&(de="s"),$&&$!=de){m<0&&(m=1,G(),u.sticky="after");break}if(de&&($=de),m>0&&!G(!ee))break}var fe=Pf(s,u,S,w,!0);return j(S,fe)&&(fe.hitSide=!0),fe}function FL(s,u,m,f){var y=s.doc,S=u.left,w;if(f=="page"){var L=Math.min(s.display.wrapper.clientHeight,window.innerHeight||document.documentElement.clientHeight),k=Math.max(L-.5*nc(s.display),3);w=(m>0?u.bottom:u.top)+m*k}else f=="line"&&(w=m>0?u.bottom+3:u.top-3);for(var A;A=Gy(s,S,w),!!A.outside;){if(m<0?w<=0:w>=y.height){A.hitSide=!0;break}w+=m*5}return A}var xt=function(s){this.cm=s,this.lastAnchorNode=this.lastAnchorOffset=this.lastFocusNode=this.lastFocusOffset=null,this.polling=new rt,this.composing=null,this.gracePeriod=!1,this.readDOMTimeout=null};xt.prototype.init=function(s){var u=this,m=this,f=m.cm,y=m.div=s.lineDiv;y.contentEditable=!0,NL(y,f.options.spellcheck,f.options.autocorrect,f.options.autocapitalize);function S(L){for(var k=L.target;k;k=k.parentNode){if(k==y)return!0;if(/\bCodeMirror-(?:line)?widget\b/.test(k.className))break}return!1}Ne(y,"paste",function(L){!S(L)||Zt(f,L)||_L(L,f)||l<=11&&setTimeout(hn(f,function(){return u.updateFromDOM()}),20)}),Ne(y,"compositionstart",function(L){u.composing={data:L.data,done:!1}}),Ne(y,"compositionupdate",function(L){u.composing||(u.composing={data:L.data,done:!1})}),Ne(y,"compositionend",function(L){u.composing&&(L.data!=u.composing.data&&u.readFromDOMSoon(),u.composing.done=!0)}),Ne(y,"touchstart",function(){return m.forceCompositionEnd()}),Ne(y,"input",function(){u.composing||u.readFromDOMSoon()});function w(L){if(!(!S(L)||Zt(f,L))){if(f.somethingSelected())Vf({lineWise:!1,text:f.getSelections()}),L.type=="cut"&&f.replaceSelection("",null,"cut");else if(f.options.lineWiseCopyCut){var k=OL(f);Vf({lineWise:!0,text:k.text}),L.type=="cut"&&f.operation(function(){f.setSelections(k.ranges,0,qe),f.replaceSelection("",null,"cut")})}else return;if(L.clipboardData){L.clipboardData.clearData();var A=Di.text.join(`
`);if(L.clipboardData.setData("Text",A),L.clipboardData.getData("Text")==A){L.preventDefault();return}}var G=BL(),$=G.firstChild;f.display.lineSpace.insertBefore(G,f.display.lineSpace.firstChild),$.value=Di.text.join(`
`);var Y=pe();le($),setTimeout(function(){f.display.lineSpace.removeChild(G),Y.focus(),Y==y&&m.showPrimarySelection()},50)}}Ne(y,"copy",w),Ne(y,"cut",w)},xt.prototype.screenReaderLabelChanged=function(s){s?this.div.setAttribute("aria-label",s):this.div.removeAttribute("aria-label")},xt.prototype.prepareSelection=function(){var s=ET(this.cm,!1);return s.focus=pe()==this.div,s},xt.prototype.showSelection=function(s,u){!s||!this.cm.display.view.length||((s.focus||u)&&this.showPrimarySelection(),this.showMultipleSelections(s))},xt.prototype.getSelection=function(){return this.cm.display.wrapper.ownerDocument.getSelection()},xt.prototype.showPrimarySelection=function(){var s=this.getSelection(),u=this.cm,m=u.doc.sel.primary(),f=m.from(),y=m.to();if(u.display.viewTo==u.display.viewFrom||f.line>=u.display.viewTo||y.line<u.display.viewFrom){s.removeAllRanges();return}var S=Of(u,s.anchorNode,s.anchorOffset),w=Of(u,s.focusNode,s.focusOffset);if(!(S&&!S.bad&&w&&!w.bad&&R(Ge(S,w),f)==0&&R(ue(S,w),y)==0)){var L=u.display.view,k=f.line>=u.display.viewFrom&&UL(u,f)||{node:L[0].measure.map[2],offset:0},A=y.line<u.display.viewTo&&UL(u,y);if(!A){var G=L[L.length-1].measure,$=G.maps?G.maps[G.maps.length-1]:G.map;A={node:$[$.length-1],offset:$[$.length-2]-$[$.length-3]}}if(!k||!A){s.removeAllRanges();return}var Y=s.rangeCount&&s.getRangeAt(0),q;try{q=J(k.node,k.offset,A.offset,A.node)}catch(ee){}q&&(!t&&u.state.focused?(s.collapse(k.node,k.offset),q.collapsed||(s.removeAllRanges(),s.addRange(q))):(s.removeAllRanges(),s.addRange(q)),Y&&s.anchorNode==null?s.addRange(Y):t&&this.startGracePeriod()),this.rememberSelection()}},xt.prototype.startGracePeriod=function(){var s=this;clearTimeout(this.gracePeriod),this.gracePeriod=setTimeout(function(){s.gracePeriod=!1,s.selectionChanged()&&s.cm.operation(function(){return s.cm.curOp.selectionChanged=!0})},20)},xt.prototype.showMultipleSelections=function(s){_(this.cm.display.cursorDiv,s.cursors),_(this.cm.display.selectionDiv,s.selection)},xt.prototype.rememberSelection=function(){var s=this.getSelection();this.lastAnchorNode=s.anchorNode,this.lastAnchorOffset=s.anchorOffset,this.lastFocusNode=s.focusNode,this.lastFocusOffset=s.focusOffset},xt.prototype.selectionInEditor=function(){var s=this.getSelection();if(!s.rangeCount)return!1;var u=s.getRangeAt(0).commonAncestorContainer;return ae(this.div,u)},xt.prototype.focus=function(){this.cm.options.readOnly!="nocursor"&&((!this.selectionInEditor()||pe()!=this.div)&&this.showSelection(this.prepareSelection(),!0),this.div.focus())},xt.prototype.blur=function(){this.div.blur()},xt.prototype.getField=function(){return this.div},xt.prototype.supportsTouch=function(){return!0},xt.prototype.receivedFocus=function(){var s=this;this.selectionInEditor()?this.pollSelection():Er(this.cm,function(){return s.cm.curOp.selectionChanged=!0});function u(){s.cm.state.focused&&(s.pollSelection(),s.polling.set(s.cm.options.pollInterval,u))}this.polling.set(this.cm.options.pollInterval,u)},xt.prototype.selectionChanged=function(){var s=this.getSelection();return s.anchorNode!=this.lastAnchorNode||s.anchorOffset!=this.lastAnchorOffset||s.focusNode!=this.lastFocusNode||s.focusOffset!=this.lastFocusOffset},xt.prototype.pollSelection=function(){if(!(this.readDOMTimeout!=null||this.gracePeriod||!this.selectionChanged())){var s=this.getSelection(),u=this.cm;if(C&&p&&this.cm.display.gutterSpecs.length&&VF(s.anchorNode)){this.cm.triggerOnKeyDown({type:"keydown",keyCode:8,preventDefault:Math.abs}),this.blur(),this.focus();return}if(!this.composing){this.rememberSelection();var m=Of(u,s.anchorNode,s.anchorOffset),f=Of(u,s.focusNode,s.focusOffset);m&&f&&Er(u,function(){Un(u.doc,Io(m,f),qe),(m.bad||f.bad)&&(u.curOp.selectionChanged=!0)})}}},xt.prototype.pollContent=function(){this.readDOMTimeout!=null&&(clearTimeout(this.readDOMTimeout),this.readDOMTimeout=null);var s=this.cm,u=s.display,m=s.doc.sel.primary(),f=m.from(),y=m.to();if(f.ch==0&&f.line>s.firstLine()&&(f=se(f.line-1,Te(s.doc,f.line-1).length)),y.ch==Te(s.doc,y.line).text.length&&y.line<s.lastLine()&&(y=se(y.line+1,0)),f.line<u.viewFrom||y.line>u.viewTo-1)return!1;var S,w,L;f.line==u.viewFrom||(S=Ns(s,f.line))==0?(w=ht(u.view[0].line),L=u.view[0].node):(w=ht(u.view[S].line),L=u.view[S-1].node.nextSibling);var k=Ns(s,y.line),A,G;if(k==u.view.length-1?(A=u.viewTo-1,G=u.lineDiv.lastChild):(A=ht(u.view[k+1].line)-1,G=u.view[k+1].node.previousSibling),!L)return!1;for(var $=s.doc.splitLines(OF(s,L,G,w,A)),Y=oa(s.doc,se(w,0),se(A,Te(s.doc,A).text.length));$.length>1&&Y.length>1;)if(at($)==at(Y))$.pop(),Y.pop(),A--;else if($[0]==Y[0])$.shift(),Y.shift(),w++;else break;for(var q=0,ee=0,re=$[0],de=Y[0],fe=Math.min(re.length,de.length);q<fe&&re.charCodeAt(q)==de.charCodeAt(q);)++q;for(var Se=at($),he=at(Y),be=Math.min(Se.length-($.length==1?q:0),he.length-(Y.length==1?q:0));ee<be&&Se.charCodeAt(Se.length-ee-1)==he.charCodeAt(he.length-ee-1);)++ee;if($.length==1&&Y.length==1&&w==f.line)for(;q&&q>f.ch&&Se.charCodeAt(Se.length-ee-1)==he.charCodeAt(he.length-ee-1);)q--,ee++;$[$.length-1]=Se.slice(0,Se.length-ee).replace(/^\u200b+/,""),$[0]=$[0].slice(q).replace(/\u200b+$/,"");var Re=se(w,q),De=se(A,Y.length?at(Y).length-ee:0);if($.length>1||$[0]||R(Re,De))return uc(s.doc,$,Re,De,"+input"),!0},xt.prototype.ensurePolled=function(){this.forceCompositionEnd()},xt.prototype.reset=function(){this.forceCompositionEnd()},xt.prototype.forceCompositionEnd=function(){!this.composing||(clearTimeout(this.readDOMTimeout),this.composing=null,this.updateFromDOM(),this.div.blur(),this.div.focus())},xt.prototype.readFromDOMSoon=function(){var s=this;this.readDOMTimeout==null&&(this.readDOMTimeout=setTimeout(function(){if(s.readDOMTimeout=null,s.composing)if(s.composing.done)s.composing=null;else return;s.updateFromDOM()},80))},xt.prototype.updateFromDOM=function(){var s=this;(this.cm.isReadOnly()||!this.pollContent())&&Er(this.cm,function(){return cr(s.cm)})},xt.prototype.setUneditable=function(s){s.contentEditable="false"},xt.prototype.onKeyPress=function(s){s.charCode==0||this.composing||(s.preventDefault(),this.cm.isReadOnly()||hn(this.cm,mv)(this.cm,String.fromCharCode(s.charCode==null?s.keyCode:s.charCode),0))},xt.prototype.readOnlyChanged=function(s){this.div.contentEditable=String(s!="nocursor")},xt.prototype.onContextMenu=function(){},xt.prototype.resetPosition=function(){},xt.prototype.needsContentAttribute=!0;function UL(s,u){var m=Ny(s,u.line);if(!m||m.hidden)return null;var f=Te(s.doc,u.line),y=fT(m,f,u.line),S=Lr(f,s.doc.direction),w="left";if(S){var L=Dt(S,u.ch);w=L%2?"right":"left"}var k=gT(y.map,u.ch,w);return k.offset=k.collapse=="right"?k.end:k.start,k}function VF(s){for(var u=s;u;u=u.parentNode)if(/CodeMirror-gutter-wrapper/.test(u.className))return!0;return!1}function mc(s,u){return u&&(s.bad=!0),s}function OF(s,u,m,f,y){var S="",w=!1,L=s.doc.lineSeparator(),k=!1;function A(q){return function(ee){return ee.id==q}}function G(){w&&(S+=L,k&&(S+=L),w=k=!1)}function $(q){q&&(G(),S+=q)}function Y(q){if(q.nodeType==1){var ee=q.getAttribute("cm-text");if(ee){$(ee);return}var re=q.getAttribute("cm-marker"),de;if(re){var fe=s.findMarks(se(f,0),se(y+1,0),A(+re));fe.length&&(de=fe[0].find(0))&&$(oa(s.doc,de.from,de.to).join(L));return}if(q.getAttribute("contenteditable")=="false")return;var Se=/^(pre|div|p|li|table|br)$/i.test(q.nodeName);if(!/^br$/i.test(q.nodeName)&&q.textContent.length==0)return;Se&&G();for(var he=0;he<q.childNodes.length;he++)Y(q.childNodes[he]);/^(pre|p)$/i.test(q.nodeName)&&(k=!0),Se&&(w=!0)}else q.nodeType==3&&$(q.nodeValue.replace(/\u200b/g,"").replace(/\u00a0/g," "))}for(;Y(u),u!=m;)u=u.nextSibling,k=!1;return S}function Of(s,u,m){var f;if(u==s.display.lineDiv){if(f=s.display.lineDiv.childNodes[m],!f)return mc(s.clipPos(se(s.display.viewTo-1)),!0);u=null,m=0}else for(f=u;;f=f.parentNode){if(!f||f==s.display.lineDiv)return null;if(f.parentNode&&f.parentNode==s.display.lineDiv)break}for(var y=0;y<s.display.view.length;y++){var S=s.display.view[y];if(S.node==f)return NF(S,u,m)}}function NF(s,u,m){var f=s.text.firstChild,y=!1;if(!u||!ae(f,u))return mc(se(ht(s.line),0),!0);if(u==f&&(y=!0,u=f.childNodes[m],m=0,!u)){var S=s.rest?at(s.rest):s.line;return mc(se(ht(S),S.text.length),y)}var w=u.nodeType==3?u:null,L=u;for(!w&&u.childNodes.length==1&&u.firstChild.nodeType==3&&(w=u.firstChild,m&&(m=w.nodeValue.length));L.parentNode!=f;)L=L.parentNode;var k=s.measure,A=k.maps;function G(de,fe,Se){for(var he=-1;he<(A?A.length:0);he++)for(var be=he<0?k.map:A[he],Re=0;Re<be.length;Re+=3){var De=be[Re+2];if(De==de||De==fe){var Ze=ht(he<0?s.line:s.rest[he]),Tt=be[Re]+Se;return(Se<0||De!=de)&&(Tt=be[Re+(Se?1:0)]),se(Ze,Tt)}}}var $=G(w,L,m);if($)return mc($,y);for(var Y=L.nextSibling,q=w?w.nodeValue.length-m:0;Y;Y=Y.nextSibling){if($=G(Y,Y.firstChild,0),$)return mc(se($.line,$.ch-q),y);q+=Y.textContent.length}for(var ee=L.previousSibling,re=m;ee;ee=ee.previousSibling){if($=G(ee,ee.firstChild,-1),$)return mc(se($.line,$.ch+re),y);re+=ee.textContent.length}}var Jt=function(s){this.cm=s,this.prevInput="",this.pollingFast=!1,this.polling=new rt,this.hasSelection=!1,this.composing=null};Jt.prototype.init=function(s){var u=this,m=this,f=this.cm;this.createField(s);var y=this.textarea;s.wrapper.insertBefore(this.wrapper,s.wrapper.firstChild),x&&(y.style.width="0px"),Ne(y,"input",function(){o&&l>=9&&u.hasSelection&&(u.hasSelection=null),m.poll()}),Ne(y,"paste",function(w){Zt(f,w)||_L(w,f)||(f.state.pasteIncoming=+new Date,m.fastPoll())});function S(w){if(!Zt(f,w)){if(f.somethingSelected())Vf({lineWise:!1,text:f.getSelections()});else if(f.options.lineWiseCopyCut){var L=OL(f);Vf({lineWise:!0,text:L.text}),w.type=="cut"?f.setSelections(L.ranges,null,qe):(m.prevInput="",y.value=L.text.join(`
`),le(y))}else return;w.type=="cut"&&(f.state.cutIncoming=+new Date)}}Ne(y,"cut",S),Ne(y,"copy",S),Ne(s.scroller,"paste",function(w){if(!(Wa(s,w)||Zt(f,w))){if(!y.dispatchEvent){f.state.pasteIncoming=+new Date,m.focus();return}var L=new Event("paste");L.clipboardData=w.clipboardData,y.dispatchEvent(L)}}),Ne(s.lineSpace,"selectstart",function(w){Wa(s,w)||Bn(w)}),Ne(y,"compositionstart",function(){var w=f.getCursor("from");m.composing&&m.composing.range.clear(),m.composing={start:w,range:f.markText(w,f.getCursor("to"),{className:"CodeMirror-composing"})}}),Ne(y,"compositionend",function(){m.composing&&(m.poll(),m.composing.range.clear(),m.composing=null)})},Jt.prototype.createField=function(s){this.wrapper=BL(),this.textarea=this.wrapper.firstChild},Jt.prototype.screenReaderLabelChanged=function(s){s?this.textarea.setAttribute("aria-label",s):this.textarea.removeAttribute("aria-label")},Jt.prototype.prepareSelection=function(){var s=this.cm,u=s.display,m=s.doc,f=ET(s);if(s.options.moveInputWithCursor){var y=ki(s,m.sel.primary().head,"div"),S=u.wrapper.getBoundingClientRect(),w=u.lineDiv.getBoundingClientRect();f.teTop=Math.max(0,Math.min(u.wrapper.clientHeight-10,y.top+w.top-S.top)),f.teLeft=Math.max(0,Math.min(u.wrapper.clientWidth-10,y.left+w.left-S.left))}return f},Jt.prototype.showSelection=function(s){var u=this.cm,m=u.display;_(m.cursorDiv,s.cursors),_(m.selectionDiv,s.selection),s.teTop!=null&&(this.wrapper.style.top=s.teTop+"px",this.wrapper.style.left=s.teLeft+"px")},Jt.prototype.reset=function(s){if(!(this.contextMenuPending||this.composing)){var u=this.cm;if(u.somethingSelected()){this.prevInput="";var m=u.getSelection();this.textarea.value=m,u.state.focused&&le(this.textarea),o&&l>=9&&(this.hasSelection=m)}else s||(this.prevInput=this.textarea.value="",o&&l>=9&&(this.hasSelection=null))}},Jt.prototype.getField=function(){return this.textarea},Jt.prototype.supportsTouch=function(){return!1},Jt.prototype.focus=function(){if(this.cm.options.readOnly!="nocursor"&&(!T||pe()!=this.textarea))try{this.textarea.focus()}catch(s){}},Jt.prototype.blur=function(){this.textarea.blur()},Jt.prototype.resetPosition=function(){this.wrapper.style.top=this.wrapper.style.left=0},Jt.prototype.receivedFocus=function(){this.slowPoll()},Jt.prototype.slowPoll=function(){var s=this;this.pollingFast||this.polling.set(this.cm.options.pollInterval,function(){s.poll(),s.cm.state.focused&&s.slowPoll()})},Jt.prototype.fastPoll=function(){var s=!1,u=this;u.pollingFast=!0;function m(){var f=u.poll();!f&&!s?(s=!0,u.polling.set(60,m)):(u.pollingFast=!1,u.slowPoll())}u.polling.set(20,m)},Jt.prototype.poll=function(){var s=this,u=this.cm,m=this.textarea,f=this.prevInput;if(this.contextMenuPending||!u.state.focused||sf(m)&&!f&&!this.composing||u.isReadOnly()||u.options.disableInput||u.state.keySeq)return!1;var y=m.value;if(y==f&&!u.somethingSelected())return!1;if(o&&l>=9&&this.hasSelection===y||P&&/[\uf700-\uf7ff]/.test(y))return u.display.input.reset(),!1;if(u.doc.sel==u.display.selForContextMenu){var S=y.charCodeAt(0);if(S==8203&&!f&&(f="\u200B"),S==8666)return this.reset(),this.cm.execCommand("undo")}for(var w=0,L=Math.min(f.length,y.length);w<L&&f.charCodeAt(w)==y.charCodeAt(w);)++w;return Er(u,function(){mv(u,y.slice(w),f.length-w,null,s.composing?"*compose":null),y.length>1e3||y.indexOf(`
`)>-1?m.value=s.prevInput="":s.prevInput=y,s.composing&&(s.composing.range.clear(),s.composing.range=u.markText(s.composing.start,u.getCursor("to"),{className:"CodeMirror-composing"}))}),!0},Jt.prototype.ensurePolled=function(){this.pollingFast&&this.poll()&&(this.pollingFast=!1)},Jt.prototype.onKeyPress=function(){o&&l>=9&&(this.hasSelection=null),this.fastPoll()},Jt.prototype.onContextMenu=function(s){var u=this,m=u.cm,f=m.display,y=u.textarea;u.contextMenuPending&&u.contextMenuPending();var S=Os(m,s),w=f.scroller.scrollTop;if(!S||h)return;var L=m.options.resetSelectionOnContextMenu;L&&m.doc.sel.contains(S)==-1&&hn(m,Un)(m.doc,Io(S),qe);var k=y.style.cssText,A=u.wrapper.style.cssText,G=u.wrapper.offsetParent.getBoundingClientRect();u.wrapper.style.cssText="position: static",y.style.cssText=`position: absolute; width: 30px; height: 30px;
      top: `+(s.clientY-G.top-5)+"px; left: "+(s.clientX-G.left-5)+`px;
      z-index: 1000; background: `+(o?"rgba(255, 255, 255, .05)":"transparent")+`;
      outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);`;var $;c&&($=window.scrollY),f.input.focus(),c&&window.scrollTo(null,$),f.input.reset(),m.somethingSelected()||(y.value=u.prevInput=" "),u.contextMenuPending=q,f.selForContextMenu=m.doc.sel,clearTimeout(f.detectingSelectAll);function Y(){if(y.selectionStart!=null){var re=m.somethingSelected(),de="\u200B"+(re?y.value:"");y.value="\u21DA",y.value=de,u.prevInput=re?"":"\u200B",y.selectionStart=1,y.selectionEnd=de.length,f.selForContextMenu=m.doc.sel}}function q(){if(u.contextMenuPending==q&&(u.contextMenuPending=!1,u.wrapper.style.cssText=A,y.style.cssText=k,o&&l<9&&f.scrollbars.setScrollTop(f.scroller.scrollTop=w),y.selectionStart!=null)){(!o||o&&l<9)&&Y();var re=0,de=function(){f.selForContextMenu==m.doc.sel&&y.selectionStart==0&&y.selectionEnd>0&&u.prevInput=="\u200B"?hn(m,iL)(m):re++<10?f.detectingSelectAll=setTimeout(de,500):(f.selForContextMenu=null,f.input.reset())};f.detectingSelectAll=setTimeout(de,200)}}if(o&&l>=9&&Y(),V){Ms(s);var ee=function(){sr(window,"mouseup",ee),setTimeout(q,20)};Ne(window,"mouseup",ee)}else setTimeout(q,50)},Jt.prototype.readOnlyChanged=function(s){s||this.reset(),this.textarea.disabled=s=="nocursor",this.textarea.readOnly=!!s},Jt.prototype.setUneditable=function(){},Jt.prototype.needsContentAttribute=!1;function BF(s,u){if(u=u?_e(u):{},u.value=s.value,!u.tabindex&&s.tabIndex&&(u.tabindex=s.tabIndex),!u.placeholder&&s.placeholder&&(u.placeholder=s.placeholder),u.autofocus==null){var m=pe();u.autofocus=m==s||s.getAttribute("autofocus")!=null&&m==document.body}function f(){s.value=L.getValue()}var y;if(s.form&&(Ne(s.form,"submit",f),!u.leaveSubmitMethodAlone)){var S=s.form;y=S.submit;try{var w=S.submit=function(){f(),S.submit=y,S.submit(),S.submit=w}}catch(k){}}u.finishInit=function(k){k.save=f,k.getTextArea=function(){return s},k.toTextArea=function(){k.toTextArea=isNaN,f(),s.parentNode.removeChild(k.getWrapperElement()),s.style.display="",s.form&&(sr(s.form,"submit",f),!u.leaveSubmitMethodAlone&&typeof s.form.submit=="function"&&(s.form.submit=y))}},s.style.display="none";var L=_t(function(k){return s.parentNode.insertBefore(k,s.nextSibling)},u);return L}function FF(s){s.off=sr,s.on=Ne,s.wheelEventPixels=jB,s.Doc=ur,s.splitLines=Pu,s.countColumn=Fe,s.findColumn=ft,s.isWordChar=ii,s.Pass=je,s.signal=Ue,s.Line=Zl,s.changeEnd=Ao,s.scrollbarModel=_T,s.Pos=se,s.cmpPos=R,s.modes=ai,s.mimeModes=Ur,s.resolveMode=Kl,s.getMode=Xl,s.modeExtensions=Ti,s.extendMode=Li,s.copyState=Gr,s.startState=Mu,s.innerMode=Au,s.commands=rd,s.keyMap=za,s.keyName=bL,s.isModifierKey=vL,s.lookupKey=pc,s.normalizeKeyMap=hF,s.StringStream=Wt,s.SharedTextMarker=ed,s.TextMarker=Ro,s.LineWidget=Zu,s.e_preventDefault=Bn,s.e_stopPropagation=Yl,s.e_stop=Ms,s.addClass=me,s.contains=ae,s.rmClass=B,s.keyNames=_o}IF(_t),_F(_t);var UF="iter insert remove copy getEditor constructor".split(" ");for(var Nf in ur.prototype)ur.prototype.hasOwnProperty(Nf)&&ye(UF,Nf)<0&&(_t.prototype[Nf]=function(s){return function(){return s.apply(this.doc,arguments)}}(ur.prototype[Nf]));return ia(ur),_t.inputStyles={textarea:Jt,contenteditable:xt},_t.defineMode=function(s){!_t.defaults.mode&&s!="null"&&(_t.defaults.mode=s),cf.apply(this,arguments)},_t.defineMIME=Fa,_t.defineMode("null",function(){return{token:function(s){return s.skipToEnd()}}}),_t.defineMIME("text/plain","null"),_t.defineExtension=function(s,u){_t.prototype[s]=u},_t.defineDocExtension=function(s,u){ur.prototype[s]=u},_t.fromTextArea=BF,FF(_t),_t.version="5.61.1",_t})});var Q_=qt((K_,X_)=>{(function(n){typeof K_=="object"&&typeof X_=="object"?n(Cs()):typeof define=="function"&&define.amd?define(["../../lib/codemirror"],n):n(CodeMirror)})(function(n){"use strict";var e="CodeMirror-lint-markers";function t(I,M,D){var E=document.createElement("div");E.className="CodeMirror-lint-tooltip cm-s-"+I.options.theme,E.appendChild(D.cloneNode(!0)),I.state.lint.options.selfContain?I.getWrapperElement().appendChild(E):document.body.appendChild(E);function V(O){if(!E.parentNode)return n.off(document,"mousemove",V);E.style.top=Math.max(0,O.clientY-E.offsetHeight-5)+"px",E.style.left=O.clientX+5+"px"}return n.on(document,"mousemove",V),V(M),E.style.opacity!=null&&(E.style.opacity=1),E}function r(I){I.parentNode&&I.parentNode.removeChild(I)}function i(I){!I.parentNode||(I.style.opacity==null&&r(I),I.style.opacity=0,setTimeout(function(){r(I)},600))}function a(I,M,D,E){var V=t(I,M,D);function O(){n.off(E,"mouseout",O),V&&(i(V),V=null)}var B=setInterval(function(){if(V)for(var z=E;;z=z.parentNode){if(z&&z.nodeType==11&&(z=z.host),z==document.body)return;if(!z){O();break}}if(!V)return clearInterval(B)},400);n.on(E,"mouseout",O)}function o(I,M,D){this.marked=[],this.options=M,this.timeout=null,this.hasGutter=D,this.onMouseOver=function(E){P(I,E)},this.waitingFor=0}function l(I,M){return M instanceof Function?{getAnnotations:M}:((!M||M===!0)&&(M={}),M)}function c(I){var M=I.state.lint;M.hasGutter&&I.clearGutter(e);for(var D=0;D<M.marked.length;++D)M.marked[D].clear();M.marked.length=0}function d(I,M,D,E,V){var O=document.createElement("div"),B=O;return O.className="CodeMirror-lint-marker CodeMirror-lint-marker-"+D,E&&(B=O.appendChild(document.createElement("div")),B.className="CodeMirror-lint-marker CodeMirror-lint-marker-multiple"),V!=!1&&n.on(B,"mouseover",function(z){a(I,z,M,B)}),O}function p(I,M){return I=="error"?I:M}function h(I){for(var M=[],D=0;D<I.length;++D){var E=I[D],V=E.from.line;(M[V]||(M[V]=[])).push(E)}return M}function g(I){var M=I.severity;M||(M="error");var D=document.createElement("div");return D.className="CodeMirror-lint-message CodeMirror-lint-message-"+M,typeof I.messageHTML!="undefined"?D.innerHTML=I.messageHTML:D.appendChild(document.createTextNode(I.message)),D}function v(I,M,D){var E=I.state.lint,V=++E.waitingFor;function O(){V=-1,I.off("change",O)}I.on("change",O),M(I.getValue(),function(B,z){I.off("change",O),E.waitingFor==V&&(z&&B instanceof n&&(B=z),I.operation(function(){x(I,B)}))},D,I)}function b(I){var M=I.state.lint,D=M.options,E=D.options||D,V=D.getAnnotations||I.getHelper(n.Pos(0,0),"lint");if(!!V)if(D.async||V.async)v(I,V,E);else{var O=V(I.getValue(),E,I);if(!O)return;O.then?O.then(function(B){I.operation(function(){x(I,B)})}):I.operation(function(){x(I,O)})}}function x(I,M){c(I);for(var D=I.state.lint,E=D.options,V=h(M),O=0;O<V.length;++O){var B=V[O];if(!!B){var z=[];B=B.filter(function(pe){return z.indexOf(pe.message)>-1?!1:z.push(pe.message)});for(var _=null,F=D.hasGutter&&document.createDocumentFragment(),N=0;N<B.length;++N){var J=B[N],ae=J.severity;ae||(ae="error"),_=p(_,ae),E.formatAnnotation&&(J=E.formatAnnotation(J)),D.hasGutter&&F.appendChild(g(J)),J.to&&D.marked.push(I.markText(J.from,J.to,{className:"CodeMirror-lint-mark CodeMirror-lint-mark-"+ae,__annotation:J}))}D.hasGutter&&I.setGutterMarker(O,e,d(I,F,_,V[O].length>1,D.options.tooltips))}}E.onUpdateLinting&&E.onUpdateLinting(M,V,I)}function C(I){var M=I.state.lint;!M||(clearTimeout(M.timeout),M.timeout=setTimeout(function(){b(I)},M.options.delay||500))}function T(I,M,D){for(var E=D.target||D.srcElement,V=document.createDocumentFragment(),O=0;O<M.length;O++){var B=M[O];V.appendChild(g(B))}a(I,D,V,E)}function P(I,M){var D=M.target||M.srcElement;if(!!/\bCodeMirror-lint-mark-/.test(D.className)){for(var E=D.getBoundingClientRect(),V=(E.left+E.right)/2,O=(E.top+E.bottom)/2,B=I.findMarksAt(I.coordsChar({left:V,top:O},"client")),z=[],_=0;_<B.length;++_){var F=B[_].__annotation;F&&z.push(F)}z.length&&T(I,z,M)}}n.defineOption("lint",!1,function(I,M,D){if(D&&D!=n.Init&&(c(I),I.state.lint.options.lintOnChange!==!1&&I.off("change",C),n.off(I.getWrapperElement(),"mouseover",I.state.lint.onMouseOver),clearTimeout(I.state.lint.timeout),delete I.state.lint),M){for(var E=I.getOption("gutters"),V=!1,O=0;O<E.length;++O)E[O]==e&&(V=!0);var B=I.state.lint=new o(I,l(I,M),V);B.options.lintOnChange!==!1&&I.on("change",C),B.options.tooltips!=!1&&B.options.tooltips!="gutter"&&n.on(I.getWrapperElement(),"mouseover",B.onMouseOver),b(I)}}),n.defineExtension("performLint",function(){this.state.lint&&b(this)})})});var eV=qt((mwe,Z_)=>{Z_.exports=function(n){n.defineMode("glsl",function(a,o){var l=a.indentUnit,c=o.keywords||e(t),d=o.builtins||e(r),p=o.blockKeywords||e("case do else for if switch while struct"),h=o.atoms||e("null"),g=o.hooks||{},v=o.multiLineStrings,b=/[+\-*&%=<>!?|\/]/,x;function C(E,V){var O=E.next();if(g[O]){var B=g[O](E,V);if(B!==!1)return B}if(O=='"'||O=="'")return V.tokenize=T(O),V.tokenize(E,V);if(/[\[\]{}\(\),;\:\.]/.test(O))return x=O,"bracket";if(/\d/.test(O))return E.eatWhile(/[\w\.]/),"number";if(O=="/"){if(E.eat("*"))return V.tokenize=P,P(E,V);if(E.eat("/"))return E.skipToEnd(),"comment"}if(O=="#")return E.eatWhile(/[\S]+/),E.eatWhile(/[\s]+/),E.eatWhile(/[\S]+/),E.eatWhile(/[\s]+/),"comment";if(b.test(O))return E.eatWhile(b),"operator";E.eatWhile(/[\w\$_]/);var z=E.current();return c.propertyIsEnumerable(z)?(p.propertyIsEnumerable(z)&&(x="newstatement"),"keyword"):d.propertyIsEnumerable(z)?"builtin":h.propertyIsEnumerable(z)?"atom":"word"}function T(E){return function(V,O){for(var B=!1,z,_=!1;(z=V.next())!=null;){if(z==E&&!B){_=!0;break}B=!B&&z=="\\"}return(_||!(B||v))&&(O.tokenize=C),"string"}}function P(E,V){for(var O=!1,B;B=E.next();){if(B=="/"&&O){V.tokenize=C;break}O=B=="*"}return"comment"}function I(E,V,O,B,z){this.indented=E,this.column=V,this.type=O,this.align=B,this.prev=z}function M(E,V,O){return E.context=new I(E.indented,V,O,null,E.context)}function D(E){var V=E.context.type;return(V==")"||V=="]"||V=="}")&&(E.indented=E.context.indented),E.context=E.context.prev}return{startState:function(E){return{tokenize:null,context:new I((E||0)-l,0,"top",!1),indented:0,startOfLine:!0}},token:function(E,V){var O=V.context;if(E.sol()&&(O.align==null&&(O.align=!1),V.indented=E.indentation(),V.startOfLine=!0),E.eatSpace())return null;x=null;var B=(V.tokenize||C)(E,V);if(B=="comment"||B=="meta")return B;if(O.align==null&&(O.align=!0),(x==";"||x==":")&&O.type=="statement")D(V);else if(x=="{")M(V,E.column(),"}");else if(x=="[")M(V,E.column(),"]");else if(x=="(")M(V,E.column(),")");else if(x=="}"){for(;O.type=="statement";)O=D(V);for(O.type=="}"&&(O=D(V));O.type=="statement";)O=D(V)}else x==O.type?D(V):(O.type=="}"||O.type=="top"||O.type=="statement"&&x=="newstatement")&&M(V,E.column(),"statement");return V.startOfLine=!1,B},indent:function(E,V){if(E.tokenize!=C&&E.tokenize!=null)return 0;var O=V&&V.charAt(0),B=E.context,z=O==B.type;return B.type=="statement"?B.indented+(O=="{"?0:l):B.align?B.column+(z?0:1):B.indented+(z?0:l)},electricChars:"{}"}});function e(a){for(var o={},l=a.split(" "),c=0;c<l.length;++c)o[l[c]]=!0;return o}var t="attribute const uniform varying break continue do for while if else in out inout float int void bool true false lowp mediump highp precision invariant discard return mat2 mat3 mat4 vec2 vec3 vec4 ivec2 ivec3 ivec4 bvec2 bvec3 bvec4 sampler2D samplerCube struct gl_FragCoord gl_FragColor",r="radians degrees sin cos tan asin acos atan pow exp log exp2 log2 sqrt inversesqrt abs sign floor ceil fract mod min max clamp mix step smoothstep length distance dot cross normalize faceforward reflect refract matrixCompMult lessThan lessThanEqual greaterThan greaterThanEqual equal notEqual any all not dFdx dFdy fwidth texture2D texture2DProj texture2DLod texture2DProjLod textureCube textureCubeLod require export";function i(a,o){return o.startOfLine?(a.skipToEnd(),"meta"):!1}(function(){function a(o,l){for(var c;(c=o.next())!=null;)if(c=='"'&&!o.eat('"')){l.tokenize=null;break}return"string"}n.defineMIME("text/x-glsl",{name:"glsl",keywords:e(t),builtins:e(r),blockKeywords:e("case do else for if switch while struct"),atoms:e("null"),hooks:{"#":i}})})()}});var iN=qt((nN,rN)=>{(function(n){typeof nN=="object"&&typeof rN=="object"?n(Cs()):typeof define=="function"&&define.amd?define(["../../lib/codemirror"],n):n(CodeMirror)})(function(n){"use strict";n.defineMode("javascript",function(e,t){var r=e.indentUnit,i=t.statementIndent,a=t.jsonld,o=t.json||a,l=t.trackScope!==!1,c=t.typescript,d=t.wordCharacters||/[\w$\xa1-\uffff]/,p=function(){function R(Fn){return{type:Fn,style:"keyword"}}var j=R("keyword a"),te=R("keyword b"),ue=R("keyword c"),Ge=R("keyword d"),st=R("operator"),ve={type:"atom",style:"atom"};return{if:R("if"),while:j,with:j,else:te,do:te,try:te,finally:te,return:Ge,break:Ge,continue:Ge,new:R("new"),delete:ue,void:ue,throw:ue,debugger:R("debugger"),var:R("var"),const:R("var"),let:R("var"),function:R("function"),catch:R("catch"),for:R("for"),switch:R("switch"),case:R("case"),default:R("default"),in:st,typeof:st,instanceof:st,true:ve,false:ve,null:ve,undefined:ve,NaN:ve,Infinity:ve,this:R("this"),class:R("class"),super:R("atom"),yield:ue,export:R("export"),import:R("import"),extends:ue,await:ue}}(),h=/[+\-*&%=<>!?|~^@]/,g=/^@(context|id|value|language|type|container|list|set|reverse|index|base|vocab|graph)"/;function v(R){for(var j=!1,te,ue=!1;(te=R.next())!=null;){if(!j){if(te=="/"&&!ue)return;te=="["?ue=!0:ue&&te=="]"&&(ue=!1)}j=!j&&te=="\\"}}var b,x;function C(R,j,te){return b=R,x=te,j}function T(R,j){var te=R.next();if(te=='"'||te=="'")return j.tokenize=P(te),j.tokenize(R,j);if(te=="."&&R.match(/^\d[\d_]*(?:[eE][+\-]?[\d_]+)?/))return C("number","number");if(te=="."&&R.match(".."))return C("spread","meta");if(/[\[\]{}\(\),;\:\.]/.test(te))return C(te);if(te=="="&&R.eat(">"))return C("=>","operator");if(te=="0"&&R.match(/^(?:x[\dA-Fa-f_]+|o[0-7_]+|b[01_]+)n?/))return C("number","number");if(/\d/.test(te))return R.match(/^[\d_]*(?:n|(?:\.[\d_]*)?(?:[eE][+\-]?[\d_]+)?)?/),C("number","number");if(te=="/")return R.eat("*")?(j.tokenize=I,I(R,j)):R.eat("/")?(R.skipToEnd(),C("comment","comment")):se(R,j,1)?(v(R),R.match(/^\b(([gimyus])(?![gimyus]*\2))+\b/),C("regexp","string-2")):(R.eat("="),C("operator","operator",R.current()));if(te=="`")return j.tokenize=M,M(R,j);if(te=="#"&&R.peek()=="!")return R.skipToEnd(),C("meta","meta");if(te=="#"&&R.eatWhile(d))return C("variable","property");if(te=="<"&&R.match("!--")||te=="-"&&R.match("->")&&!/\S/.test(R.string.slice(0,R.start)))return R.skipToEnd(),C("comment","comment");if(h.test(te))return(te!=">"||!j.lexical||j.lexical.type!=">")&&(R.eat("=")?(te=="!"||te=="=")&&R.eat("="):/[<>*+\-|&?]/.test(te)&&(R.eat(te),te==">"&&R.eat(te))),te=="?"&&R.eat(".")?C("."):C("operator","operator",R.current());if(d.test(te)){R.eatWhile(d);var ue=R.current();if(j.lastType!="."){if(p.propertyIsEnumerable(ue)){var Ge=p[ue];return C(Ge.type,Ge.style,ue)}if(ue=="async"&&R.match(/^(\s|\/\*([^*]|\*(?!\/))*?\*\/)*[\[\(\w]/,!1))return C("async","keyword",ue)}return C("variable","variable",ue)}}function P(R){return function(j,te){var ue=!1,Ge;if(a&&j.peek()=="@"&&j.match(g))return te.tokenize=T,C("jsonld-keyword","meta");for(;(Ge=j.next())!=null&&!(Ge==R&&!ue);)ue=!ue&&Ge=="\\";return ue||(te.tokenize=T),C("string","string")}}function I(R,j){for(var te=!1,ue;ue=R.next();){if(ue=="/"&&te){j.tokenize=T;break}te=ue=="*"}return C("comment","comment")}function M(R,j){for(var te=!1,ue;(ue=R.next())!=null;){if(!te&&(ue=="`"||ue=="$"&&R.eat("{"))){j.tokenize=T;break}te=!te&&ue=="\\"}return C("quasi","string-2",R.current())}var D="([{}])";function E(R,j){j.fatArrowAt&&(j.fatArrowAt=null);var te=R.string.indexOf("=>",R.start);if(!(te<0)){if(c){var ue=/:\s*(?:\w+(?:<[^>]*>|\[\])?|\{[^}]*\})\s*$/.exec(R.string.slice(R.start,te));ue&&(te=ue.index)}for(var Ge=0,st=!1,ve=te-1;ve>=0;--ve){var Fn=R.string.charAt(ve),Wr=D.indexOf(Fn);if(Wr>=0&&Wr<3){if(!Ge){++ve;break}if(--Ge==0){Fn=="("&&(st=!0);break}}else if(Wr>=3&&Wr<6)++Ge;else if(d.test(Fn))st=!0;else if(/["'\/`]/.test(Fn))for(;;--ve){if(ve==0)return;var Ql=R.string.charAt(ve-1);if(Ql==Fn&&R.string.charAt(ve-2)!="\\"){ve--;break}}else if(st&&!Ge){++ve;break}}st&&!Ge&&(j.fatArrowAt=ve)}}var V={atom:!0,number:!0,variable:!0,string:!0,regexp:!0,this:!0,import:!0,"jsonld-keyword":!0};function O(R,j,te,ue,Ge,st){this.indented=R,this.column=j,this.type=te,this.prev=Ge,this.info=st,ue!=null&&(this.align=ue)}function B(R,j){if(!l)return!1;for(var te=R.localVars;te;te=te.next)if(te.name==j)return!0;for(var ue=R.context;ue;ue=ue.prev)for(var te=ue.vars;te;te=te.next)if(te.name==j)return!0}function z(R,j,te,ue,Ge){var st=R.cc;for(_.state=R,_.stream=Ge,_.marked=null,_.cc=st,_.style=j,R.lexical.hasOwnProperty("align")||(R.lexical.align=!0);;){var ve=st.length?st.pop():o?Ve:qe;if(ve(te,ue)){for(;st.length&&st[st.length-1].lex;)st.pop()();return _.marked?_.marked:te=="variable"&&B(R,ue)?"variable-2":j}}}var _={state:null,column:null,marked:null,cc:null};function F(){for(var R=arguments.length-1;R>=0;R--)_.cc.push(arguments[R])}function N(){return F.apply(null,arguments),!0}function J(R,j){for(var te=j;te;te=te.next)if(te.name==R)return!0;return!1}function ae(R){var j=_.state;if(_.marked="def",!!l){if(j.context){if(j.lexical.info=="var"&&j.context&&j.context.block){var te=pe(R,j.context);if(te!=null){j.context=te;return}}else if(!J(R,j.localVars)){j.localVars=new le(R,j.localVars);return}}t.globalVars&&!J(R,j.globalVars)&&(j.globalVars=new le(R,j.globalVars))}}function pe(R,j){if(j)if(j.block){var te=pe(R,j.prev);return te?te==j.prev?j:new Ae(te,j.vars,!0):null}else return J(R,j.vars)?j:new Ae(j.prev,new le(R,j.vars),!1);else return null}function me(R){return R=="public"||R=="private"||R=="protected"||R=="abstract"||R=="readonly"}function Ae(R,j,te){this.prev=R,this.vars=j,this.block=te}function le(R,j){this.name=R,this.next=j}var we=new le("this",new le("arguments",null));function _e(){_.state.context=new Ae(_.state.context,_.state.localVars,!1),_.state.localVars=we}function Fe(){_.state.context=new Ae(_.state.context,_.state.localVars,!0),_.state.localVars=null}function rt(){_.state.localVars=_.state.context.vars,_.state.context=_.state.context.prev}rt.lex=!0;function ye(R,j){var te=function(){var ue=_.state,Ge=ue.indented;if(ue.lexical.type=="stat")Ge=ue.lexical.indented;else for(var st=ue.lexical;st&&st.type==")"&&st.align;st=st.prev)Ge=st.indented;ue.lexical=new O(Ge,_.stream.column(),R,null,ue.lexical,j)};return te.lex=!0,te}function Le(){var R=_.state;R.lexical.prev&&(R.lexical.type==")"&&(R.indented=R.lexical.indented),R.lexical=R.lexical.prev)}Le.lex=!0;function je(R){function j(te){return te==R?N():R==";"||te=="}"||te==")"||te=="]"?F():N(j)}return j}function qe(R,j){return R=="var"?N(ye("vardef",j),Eu,je(";"),Le):R=="keyword a"?N(ye("form"),Yn,qe,Le):R=="keyword b"?N(ye("form"),qe,Le):R=="keyword d"?_.stream.match(/^\s*$/,!1)?N():N(ye("stat"),at,je(";"),Le):R=="debugger"?N(je(";")):R=="{"?N(ye("}"),Fe,Lr,Le,rt):R==";"?N():R=="if"?(_.state.lexical.info=="else"&&_.state.cc[_.state.cc.length-1]==Le&&_.state.cc.pop()(),N(ye("form"),Yn,qe,Le,sf)):R=="function"?N(ai):R=="for"?N(ye("form"),Fe,lf,qe,rt,Le):R=="class"||c&&j=="interface"?(_.marked="keyword",N(ye("form",R=="class"?R:j),Xl,Le)):R=="variable"?c&&j=="declare"?(_.marked="keyword",N(qe)):c&&(j=="module"||j=="enum"||j=="type")&&_.stream.match(/^\s*\w/,!1)?(_.marked="keyword",j=="enum"?N(sa):j=="type"?N(cf,je("operator"),Ue,je(";")):N(ye("form"),lr,je("{"),ye("}"),Lr,Le,Le)):c&&j=="namespace"?(_.marked="keyword",N(ye("form"),Ve,qe,Le)):c&&j=="abstract"?(_.marked="keyword",N(qe)):N(ye("stat"),jl):R=="switch"?N(ye("form"),Yn,je("{"),ye("}","switch"),Fe,Lr,Le,Le,rt):R=="case"?N(Ve,je(":")):R=="default"?N(je(":")):R=="catch"?N(ye("form"),_e,it,qe,Le,rt):R=="export"?N(ye("stat"),Au,Le):R=="import"?N(ye("stat"),Wt,Le):R=="async"?N(qe):j=="@"?N(Ve,qe):F(ye("stat"),Ve,je(";"),Le)}function it(R){if(R=="(")return N(Fa,je(")"))}function Ve(R,j){return Zi(R,j,!1)}function ft(R,j){return Zi(R,j,!0)}function Yn(R){return R!="("?F():N(ye(")"),at,je(")"),Le)}function Zi(R,j,te){if(_.state.fatArrowAt==_.stream.start){var ue=te?ii:ra;if(R=="(")return N(_e,ye(")"),Dt(Fa,")"),Le,je("=>"),ue,rt);if(R=="variable")return F(_e,lr,je("=>"),ue,rt)}var Ge=te?ea:Tr;return V.hasOwnProperty(R)?N(Ge):R=="function"?N(ai,Ge):R=="class"||c&&j=="interface"?(_.marked="keyword",N(ye("form"),Kl,Le)):R=="keyword c"||R=="async"?N(te?ft:Ve):R=="("?N(ye(")"),at,je(")"),Le,Ge):R=="operator"||R=="spread"?N(te?ft:Ve):R=="["?N(ye("]"),ht,Le,Ge):R=="{"?As(Nn,"}",null,Ge):R=="quasi"?F(ta,Ge):R=="new"?N(wi(te)):N()}function at(R){return R.match(/[;\}\)\],]/)?F():F(Ve)}function Tr(R,j){return R==","?N(at):ea(R,j,!1)}function ea(R,j,te){var ue=te==!1?Tr:ea,Ge=te==!1?Ve:ft;if(R=="=>")return N(_e,te?ii:ra,rt);if(R=="operator")return/\+\+|--/.test(j)||c&&j=="!"?N(ue):c&&j=="<"&&_.stream.match(/^([^<>]|<[^<>]*>)*>\s*\(/,!1)?N(ye(">"),Dt(Ue,">"),Le,ue):j=="?"?N(Ve,je(":"),Ge):N(Ge);if(R=="quasi")return F(ta,ue);if(R!=";"){if(R=="(")return As(ft,")","call",ue);if(R==".")return N(To,ue);if(R=="[")return N(ye("]"),at,je("]"),Le,ue);if(c&&j=="as")return _.marked="keyword",N(Ue,ue);if(R=="regexp")return _.state.lastType=_.marked="operator",_.stream.backUp(_.stream.pos-_.stream.start-1),N(Ge)}}function ta(R,j){return R!="quasi"?F():j.slice(j.length-2)!="${"?N(ta):N(Ve,na)}function na(R){if(R=="}")return _.marked="string-2",_.state.tokenize=M,N(ta)}function ra(R){return E(_.stream,_.state),F(R=="{"?qe:Ve)}function ii(R){return E(_.stream,_.state),F(R=="{"?qe:ft)}function wi(R){return function(j){return j=="."?N(R?wo:Na):j=="variable"&&c?N(Ms,R?ea:Tr):F(R?ft:Ve)}}function Na(R,j){if(j=="target")return _.marked="keyword",N(Tr)}function wo(R,j){if(j=="target")return _.marked="keyword",N(ea)}function jl(R){return R==":"?N(Le,qe):F(Tr,je(";"),Le)}function To(R){if(R=="variable")return _.marked="property",N()}function Nn(R,j){if(R=="async")return _.marked="property",N(Nn);if(R=="variable"||_.style=="keyword"){if(_.marked="property",j=="get"||j=="set")return N(ku);var te;return c&&_.state.fatArrowAt==_.stream.start&&(te=_.stream.match(/^\s*:\s*/,!1))&&(_.state.fatArrowAt=_.stream.pos+te[0].length),N(or)}else{if(R=="number"||R=="string")return _.marked=a?"property":_.style+" property",N(or);if(R=="jsonld-keyword")return N(or);if(c&&me(j))return _.marked="keyword",N(Nn);if(R=="[")return N(Ve,Ba,je("]"),or);if(R=="spread")return N(ft,or);if(j=="*")return _.marked="keyword",N(Nn);if(R==":")return F(or)}}function ku(R){return R!="variable"?F(or):(_.marked="property",N(ai))}function or(R){if(R==":")return N(ft);if(R=="(")return F(ai)}function Dt(R,j,te){function ue(Ge,st){if(te?te.indexOf(Ge)>-1:Ge==","){var ve=_.state.lexical;return ve.info=="call"&&(ve.pos=(ve.pos||0)+1),N(function(Fn,Wr){return Fn==j||Wr==j?F():F(R)},ue)}return Ge==j||st==j?N():te&&te.indexOf(";")>-1?F(R):N(je(j))}return function(Ge,st){return Ge==j||st==j?N():F(R,ue)}}function As(R,j,te){for(var ue=3;ue<arguments.length;ue++)_.cc.push(arguments[ue]);return N(ye(j,te),Dt(R,j),Le)}function Lr(R){return R=="}"?N():F(qe,Lr)}function Ba(R,j){if(c){if(R==":")return N(Ue);if(j=="?")return N(Ba)}}function Ne(R,j){if(c&&(R==":"||j=="in"))return N(Ue)}function Jl(R){if(c&&R==":")return _.stream.match(/^\s*\w+\s+is\b/,!1)?N(Ve,sr,Ue):N(Ue)}function sr(R,j){if(j=="is")return _.marked="keyword",N()}function Ue(R,j){if(j=="keyof"||j=="typeof"||j=="infer"||j=="readonly")return _.marked="keyword",N(j=="typeof"?ft:Ue);if(R=="variable"||j=="void")return _.marked="type",N(Fr);if(j=="|"||j=="&")return N(Ue);if(R=="string"||R=="number"||R=="atom")return N(Fr);if(R=="[")return N(ye("]"),Dt(Ue,"]",","),Le,Fr);if(R=="{")return N(ye("}"),ql,Le,Fr);if(R=="(")return N(Dt(Yl,")"),Zt,Fr);if(R=="<")return N(Dt(Ue,">"),Ue);if(R=="quasi")return F(ia,Fr)}function Zt(R){if(R=="=>")return N(Ue)}function ql(R){return R.match(/[\}\)\]]/)?N():R==","||R==";"?N(ql):F(Pn,ql)}function Pn(R,j){if(R=="variable"||_.style=="keyword")return _.marked="property",N(Pn);if(j=="?"||R=="number"||R=="string")return N(Pn);if(R==":")return N(Ue);if(R=="[")return N(je("variable"),Ne,je("]"),Pn);if(R=="(")return F(Ur,Pn);if(!R.match(/[;\}\)\],]/))return N()}function ia(R,j){return R!="quasi"?F():j.slice(j.length-2)!="${"?N(ia):N(Ue,Bn)}function Bn(R){if(R=="}")return _.marked="string-2",_.state.tokenize=M,N(ia)}function Yl(R,j){return R=="variable"&&_.stream.match(/^\s*[?:]/,!1)||j=="?"?N(Yl):R==":"?N(Ue):R=="spread"?N(Yl):F(Ue)}function Fr(R,j){if(j=="<")return N(ye(">"),Dt(Ue,">"),Le,Fr);if(j=="|"||R=="."||j=="&")return N(Ue);if(R=="[")return N(Ue,je("]"),Fr);if(j=="extends"||j=="implements")return _.marked="keyword",N(Ue);if(j=="?")return N(Ue,je(":"),Ue)}function Ms(R,j){if(j=="<")return N(ye(">"),Dt(Ue,">"),Le,Fr)}function Lo(){return F(Ue,af)}function af(R,j){if(j=="=")return N(Ue)}function Eu(R,j){return j=="enum"?(_.marked="keyword",N(sa)):F(lr,Ba,aa,Pu)}function lr(R,j){if(c&&me(j))return _.marked="keyword",N(lr);if(R=="variable")return ae(j),N();if(R=="spread")return N(lr);if(R=="[")return As(Du,"]");if(R=="{")return As(of,"}")}function of(R,j){return R=="variable"&&!_.stream.match(/^\s*:/,!1)?(ae(j),N(aa)):(R=="variable"&&(_.marked="property"),R=="spread"?N(lr):R=="}"?F():R=="["?N(Ve,je("]"),je(":"),of):N(je(":"),lr,aa))}function Du(){return F(lr,aa)}function aa(R,j){if(j=="=")return N(ft)}function Pu(R){if(R==",")return N(Eu)}function sf(R,j){if(R=="keyword b"&&j=="else")return N(ye("form","else"),qe,Le)}function lf(R,j){if(j=="await")return N(lf);if(R=="(")return N(ye(")"),Iu,Le)}function Iu(R){return R=="var"?N(Eu,ko):R=="variable"?N(ko):F(ko)}function ko(R,j){return R==")"?N():R==";"?N(ko):j=="in"||j=="of"?(_.marked="keyword",N(Ve,ko)):F(Ve,ko)}function ai(R,j){if(j=="*")return _.marked="keyword",N(ai);if(R=="variable")return ae(j),N(ai);if(R=="(")return N(_e,ye(")"),Dt(Fa,")"),Le,Jl,qe,rt);if(c&&j=="<")return N(ye(">"),Dt(Lo,">"),Le,ai)}function Ur(R,j){if(j=="*")return _.marked="keyword",N(Ur);if(R=="variable")return ae(j),N(Ur);if(R=="(")return N(_e,ye(")"),Dt(Fa,")"),Le,Jl,rt);if(c&&j=="<")return N(ye(">"),Dt(Lo,">"),Le,Ur)}function cf(R,j){if(R=="keyword"||R=="variable")return _.marked="type",N(cf);if(j=="<")return N(ye(">"),Dt(Lo,">"),Le)}function Fa(R,j){return j=="@"&&N(Ve,Fa),R=="spread"?N(Fa):c&&me(j)?(_.marked="keyword",N(Fa)):c&&R=="this"?N(Ba,aa):F(lr,Ba,aa)}function Kl(R,j){return R=="variable"?Xl(R,j):Ti(R,j)}function Xl(R,j){if(R=="variable")return ae(j),N(Ti)}function Ti(R,j){if(j=="<")return N(ye(">"),Dt(Lo,">"),Le,Ti);if(j=="extends"||j=="implements"||c&&R==",")return j=="implements"&&(_.marked="keyword"),N(c?Ue:Ve,Ti);if(R=="{")return N(ye("}"),Li,Le)}function Li(R,j){if(R=="async"||R=="variable"&&(j=="static"||j=="get"||j=="set"||c&&me(j))&&_.stream.match(/^\s+[\w$\xa1-\uffff]/,!1))return _.marked="keyword",N(Li);if(R=="variable"||_.style=="keyword")return _.marked="property",N(Gr,Li);if(R=="number"||R=="string")return N(Gr,Li);if(R=="[")return N(Ve,Ba,je("]"),Gr,Li);if(j=="*")return _.marked="keyword",N(Li);if(c&&R=="(")return F(Ur,Li);if(R==";"||R==",")return N(Li);if(R=="}")return N();if(j=="@")return N(Ve,Li)}function Gr(R,j){if(j=="!"||j=="?")return N(Gr);if(R==":")return N(Ue,aa);if(j=="=")return N(ft);var te=_.state.lexical.prev,ue=te&&te.info=="interface";return F(ue?Ur:ai)}function Au(R,j){return j=="*"?(_.marked="keyword",N(kr,je(";"))):j=="default"?(_.marked="keyword",N(Ve,je(";"))):R=="{"?N(Dt(Mu,"}"),kr,je(";")):F(qe)}function Mu(R,j){if(j=="as")return _.marked="keyword",N(je("variable"));if(R=="variable")return F(ft,Mu)}function Wt(R){return R=="string"?N():R=="("?F(Ve):R=="."?F(Tr):F(Te,oa,kr)}function Te(R,j){return R=="{"?As(Te,"}"):(R=="variable"&&ae(j),j=="*"&&(_.marked="keyword"),N(Ru))}function oa(R){if(R==",")return N(Te,oa)}function Ru(R,j){if(j=="as")return _.marked="keyword",N(Te)}function kr(R,j){if(j=="from")return _.marked="keyword",N(Ve)}function ht(R){return R=="]"?N():F(Dt(ft,"]"))}function sa(){return F(ye("form"),lr,je("{"),ye("}"),Dt(Rs,"}"),Le,Le)}function Rs(){return F(lr,aa)}function _u(R,j){return R.lastType=="operator"||R.lastType==","||h.test(j.charAt(0))||/[,.]/.test(j.charAt(0))}function se(R,j,te){return j.tokenize==T&&/^(?:operator|sof|keyword [bcd]|case|new|export|default|spread|[\[{}\(,;:]|=>)$/.test(j.lastType)||j.lastType=="quasi"&&/\{\s*$/.test(R.string.slice(0,R.pos-(te||0)))}return{startState:function(R){var j={tokenize:T,lastType:"sof",cc:[],lexical:new O((R||0)-r,0,"block",!1),localVars:t.localVars,context:t.localVars&&new Ae(null,null,!1),indented:R||0};return t.globalVars&&typeof t.globalVars=="object"&&(j.globalVars=t.globalVars),j},token:function(R,j){if(R.sol()&&(j.lexical.hasOwnProperty("align")||(j.lexical.align=!1),j.indented=R.indentation(),E(R,j)),j.tokenize!=I&&R.eatSpace())return null;var te=j.tokenize(R,j);return b=="comment"?te:(j.lastType=b=="operator"&&(x=="++"||x=="--")?"incdec":b,z(j,te,b,x,R))},indent:function(R,j){if(R.tokenize==I||R.tokenize==M)return n.Pass;if(R.tokenize!=T)return 0;var te=j&&j.charAt(0),ue=R.lexical,Ge;if(!/^\s*else\b/.test(j))for(var st=R.cc.length-1;st>=0;--st){var ve=R.cc[st];if(ve==Le)ue=ue.prev;else if(ve!=sf&&ve!=rt)break}for(;(ue.type=="stat"||ue.type=="form")&&(te=="}"||(Ge=R.cc[R.cc.length-1])&&(Ge==Tr||Ge==ea)&&!/^[,\.=+\-*:?[\(]/.test(j));)ue=ue.prev;i&&ue.type==")"&&ue.prev.type=="stat"&&(ue=ue.prev);var Fn=ue.type,Wr=te==Fn;return Fn=="vardef"?ue.indented+(R.lastType=="operator"||R.lastType==","?ue.info.length+1:0):Fn=="form"&&te=="{"?ue.indented:Fn=="form"?ue.indented+r:Fn=="stat"?ue.indented+(_u(R,j)?i||r:0):ue.info=="switch"&&!Wr&&t.doubleIndentSwitch!=!1?ue.indented+(/^(?:case|default)\b/.test(j)?r:2*r):ue.align?ue.column+(Wr?0:1):ue.indented+(Wr?0:r)},electricInput:/^\s*(?:case .*?:|default:|\{|\})$/,blockCommentStart:o?null:"/*",blockCommentEnd:o?null:"*/",blockCommentContinue:o?null:" * ",lineComment:o?null:"//",fold:"brace",closeBrackets:"()[]{}''\"\"``",helperType:o?"json":"javascript",jsonldMode:a,jsonMode:o,expressionAllowed:se,skipExpression:function(R){z(R,"atom","atom","true",new n.StringStream("",2,null))}}}),n.registerHelper("wordChars","javascript",/[\w$]/),n.defineMIME("text/javascript","javascript"),n.defineMIME("text/ecmascript","javascript"),n.defineMIME("application/javascript","javascript"),n.defineMIME("application/x-javascript","javascript"),n.defineMIME("application/ecmascript","javascript"),n.defineMIME("application/json",{name:"javascript",json:!0}),n.defineMIME("application/x-json",{name:"javascript",json:!0}),n.defineMIME("application/manifest+json",{name:"javascript",json:!0}),n.defineMIME("application/ld+json",{name:"javascript",jsonld:!0}),n.defineMIME("text/typescript",{name:"javascript",typescript:!0}),n.defineMIME("application/typescript",{name:"javascript",typescript:!0})})});var T0=qt((aN,oN)=>{(function(n){typeof aN=="object"&&typeof oN=="object"?n(Cs()):typeof define=="function"&&define.amd?define(["../../lib/codemirror"],n):n(CodeMirror)})(function(n){"use strict";function e(a,o,l,c){if(l&&l.call){var d=l;l=null}else var d=i(a,l,"rangeFinder");typeof o=="number"&&(o=n.Pos(o,0));var p=i(a,l,"minFoldSize");function h(x){var C=d(a,o);if(!C||C.to.line-C.from.line<p)return null;for(var T=a.findMarksAt(C.from),P=0;P<T.length;++P)if(T[P].__isFold&&c!=="fold"){if(!x)return null;C.cleared=!0,T[P].clear()}return C}var g=h(!0);if(i(a,l,"scanUp"))for(;!g&&o.line>a.firstLine();)o=n.Pos(o.line-1,0),g=h(!1);if(!(!g||g.cleared||c==="unfold")){var v=t(a,l,g);n.on(v,"mousedown",function(x){b.clear(),n.e_preventDefault(x)});var b=a.markText(g.from,g.to,{replacedWith:v,clearOnEnter:i(a,l,"clearOnEnter"),__isFold:!0});b.on("clear",function(x,C){n.signal(a,"unfold",a,x,C)}),n.signal(a,"fold",a,g.from,g.to)}}function t(a,o,l){var c=i(a,o,"widget");if(typeof c=="function"&&(c=c(l.from,l.to)),typeof c=="string"){var d=document.createTextNode(c);c=document.createElement("span"),c.appendChild(d),c.className="CodeMirror-foldmarker"}else c&&(c=c.cloneNode(!0));return c}n.newFoldFunction=function(a,o){return function(l,c){e(l,c,{rangeFinder:a,widget:o})}},n.defineExtension("foldCode",function(a,o,l){e(this,a,o,l)}),n.defineExtension("isFolded",function(a){for(var o=this.findMarksAt(a),l=0;l<o.length;++l)if(o[l].__isFold)return!0}),n.commands.toggleFold=function(a){a.foldCode(a.getCursor())},n.commands.fold=function(a){a.foldCode(a.getCursor(),null,"fold")},n.commands.unfold=function(a){a.foldCode(a.getCursor(),null,"unfold")},n.commands.foldAll=function(a){a.operation(function(){for(var o=a.firstLine(),l=a.lastLine();o<=l;o++)a.foldCode(n.Pos(o,0),null,"fold")})},n.commands.unfoldAll=function(a){a.operation(function(){for(var o=a.firstLine(),l=a.lastLine();o<=l;o++)a.foldCode(n.Pos(o,0),null,"unfold")})},n.registerHelper("fold","combine",function(){var a=Array.prototype.slice.call(arguments,0);return function(o,l){for(var c=0;c<a.length;++c){var d=a[c](o,l);if(d)return d}}}),n.registerHelper("fold","auto",function(a,o){for(var l=a.getHelpers(o,"fold"),c=0;c<l.length;c++){var d=l[c](a,o);if(d)return d}});var r={rangeFinder:n.fold.auto,widget:"\u2194",minFoldSize:0,scanUp:!1,clearOnEnter:!0};n.defineOption("foldOptions",null);function i(a,o,l){if(o&&o[l]!==void 0)return o[l];var c=a.options.foldOptions;return c&&c[l]!==void 0?c[l]:r[l]}n.defineExtension("foldOption",function(a,o){return i(this,a,o)})})});var cN=qt((sN,lN)=>{(function(n){typeof sN=="object"&&typeof lN=="object"?n(Cs(),T0()):typeof define=="function"&&define.amd?define(["../../lib/codemirror","./foldcode"],n):n(CodeMirror)})(function(n){"use strict";n.defineOption("foldGutter",!1,function(v,b,x){x&&x!=n.Init&&(v.clearGutter(v.state.foldGutter.options.gutter),v.state.foldGutter=null,v.off("gutterClick",d),v.off("changes",p),v.off("viewportChange",h),v.off("fold",g),v.off("unfold",g),v.off("swapDoc",p)),b&&(v.state.foldGutter=new t(r(b)),c(v),v.on("gutterClick",d),v.on("changes",p),v.on("viewportChange",h),v.on("fold",g),v.on("unfold",g),v.on("swapDoc",p))});var e=n.Pos;function t(v){this.options=v,this.from=this.to=0}function r(v){return v===!0&&(v={}),v.gutter==null&&(v.gutter="CodeMirror-foldgutter"),v.indicatorOpen==null&&(v.indicatorOpen="CodeMirror-foldgutter-open"),v.indicatorFolded==null&&(v.indicatorFolded="CodeMirror-foldgutter-folded"),v}function i(v,b){for(var x=v.findMarks(e(b,0),e(b+1,0)),C=0;C<x.length;++C)if(x[C].__isFold){var T=x[C].find(-1);if(T&&T.line===b)return x[C]}}function a(v){if(typeof v=="string"){var b=document.createElement("div");return b.className=v+" CodeMirror-guttermarker-subtle",b}else return v.cloneNode(!0)}function o(v,b,x){var C=v.state.foldGutter.options,T=b-1,P=v.foldOption(C,"minFoldSize"),I=v.foldOption(C,"rangeFinder"),M=typeof C.indicatorFolded=="string"&&l(C.indicatorFolded),D=typeof C.indicatorOpen=="string"&&l(C.indicatorOpen);v.eachLine(b,x,function(E){++T;var V=null,O=E.gutterMarkers;if(O&&(O=O[C.gutter]),i(v,T)){if(M&&O&&M.test(O.className))return;V=a(C.indicatorFolded)}else{var B=e(T,0),z=I&&I(v,B);if(z&&z.to.line-z.from.line>=P){if(D&&O&&D.test(O.className))return;V=a(C.indicatorOpen)}}!V&&!O||v.setGutterMarker(E,C.gutter,V)})}function l(v){return new RegExp("(^|\\s)"+v+"(?:$|\\s)\\s*")}function c(v){var b=v.getViewport(),x=v.state.foldGutter;!x||(v.operation(function(){o(v,b.from,b.to)}),x.from=b.from,x.to=b.to)}function d(v,b,x){var C=v.state.foldGutter;if(!!C){var T=C.options;if(x==T.gutter){var P=i(v,b);P?P.clear():v.foldCode(e(b,0),T)}}}function p(v){var b=v.state.foldGutter;if(!!b){var x=b.options;b.from=b.to=0,clearTimeout(b.changeUpdate),b.changeUpdate=setTimeout(function(){c(v)},x.foldOnChangeTimeSpan||600)}}function h(v){var b=v.state.foldGutter;if(!!b){var x=b.options;clearTimeout(b.changeUpdate),b.changeUpdate=setTimeout(function(){var C=v.getViewport();b.from==b.to||C.from-b.to>20||b.from-C.to>20?c(v):v.operation(function(){C.from<b.from&&(o(v,C.from,b.from),b.from=C.from),C.to>b.to&&(o(v,b.to,C.to),b.to=C.to)})},x.updateViewportTimeSpan||400)}}function g(v,b){var x=v.state.foldGutter;if(!!x){var C=b.line;C>=x.from&&C<x.to&&o(v,C,C+1)}}})});var pN=qt((uN,dN)=>{(function(n){typeof uN=="object"&&typeof dN=="object"?n(Cs()):typeof define=="function"&&define.amd?define(["../../lib/codemirror"],n):n(CodeMirror)})(function(n){"use strict";n.registerHelper("fold","brace",function(e,t){var r=t.line,i=e.getLine(r),a;function o(D){for(var E=t.ch,V=0;;){var O=E<=0?-1:i.lastIndexOf(D,E-1);if(O==-1){if(V==1)break;V=1,E=i.length;continue}if(V==1&&O<t.ch)break;if(a=e.getTokenTypeAt(n.Pos(r,O+1)),!/^(comment|string)/.test(a))return O+1;E=O-1}}var l=o("{"),c=o("["),d,p,h;if(l!=null&&(c==null||c>l))h=l,d="{",p="}";else if(c!=null)h=c,d="[",p="]";else return;var g=1,v=e.lastLine(),b,x;e:for(var C=r;C<=v;++C)for(var T=e.getLine(C),P=C==r?h:0;;){var I=T.indexOf(d,P),M=T.indexOf(p,P);if(I<0&&(I=T.length),M<0&&(M=T.length),P=Math.min(I,M),P==T.length)break;if(e.getTokenTypeAt(n.Pos(C,P+1))==a){if(P==I)++g;else if(!--g){b=C,x=P;break e}}++P}if(!(b==null||r==b))return{from:n.Pos(r,h),to:n.Pos(b,x)}}),n.registerHelper("fold","import",function(e,t){function r(d){if(d<e.firstLine()||d>e.lastLine())return null;var p=e.getTokenAt(n.Pos(d,1));if(/\S/.test(p.string)||(p=e.getTokenAt(n.Pos(d,p.end+1))),p.type!="keyword"||p.string!="import")return null;for(var h=d,g=Math.min(e.lastLine(),d+10);h<=g;++h){var v=e.getLine(h),b=v.indexOf(";");if(b!=-1)return{startCh:p.end,end:n.Pos(h,b)}}}var i=t.line,a=r(i),o;if(!a||r(i-1)||(o=r(i-2))&&o.end.line==i-1)return null;for(var l=a.end;;){var c=r(l.line+1);if(c==null)break;l=c.end}return{from:e.clipPos(n.Pos(i,a.startCh+1)),to:l}}),n.registerHelper("fold","include",function(e,t){function r(c){if(c<e.firstLine()||c>e.lastLine())return null;var d=e.getTokenAt(n.Pos(c,1));if(/\S/.test(d.string)||(d=e.getTokenAt(n.Pos(c,d.end+1))),d.type=="meta"&&d.string.slice(0,8)=="#include")return d.start+8}var i=t.line,a=r(i);if(a==null||r(i-1)!=null)return null;for(var o=i;;){var l=r(o+1);if(l==null)break;++o}return{from:n.Pos(i,a+1),to:e.clipPos(n.Pos(o))}})})});function Bf(n,e){let t=n.length,r=0;for(let i=0;i<t;++i)e(n[i],i,n)&&(n[r]=n[i],++r);n.length=r}function zL(n,e){if(n.length===e)return n;let t=new n.constructor(e);return t.set(n),t}function cd(n,e,t,r){let i=n.length/e,a=n.length*t*r,o=new n.constructor(a),l=n.length*r,c=e,d=e*r;for(let p=0;p<i;++p)for(let h=0;h<e;++h){let g=n[p*e+h],v=p*d+h;for(let b=0;b<t;++b)for(let x=0;x<r;++x)o[b*l+x*c+v]=g}return o}function HL(n,e,t,r=0,i=n.length){for(;r<i;){let a=r+i-1>>1,o=t(e,n[a]);if(o>0)r=a+1;else if(o<0)i=a;else return a}return~r}function $L(n,e,t){let r=e-n;for(;r>0;){let i=Math.floor(r/2),a=n+i;t(a)?r=i:(n=a+1,r-=i+1)}return n}function jL(n,e){let t=[];for(let r=0,i=n.length;r<i;++r)n[r]===e&&t.push(r);return t}function xe(n,e){let t=n.length;if(e.length!==t)return!1;for(let r=0;r<t;++r)if(n[r]!==e[r])return!1;return!0}function ud(n,e,t=(r,i)=>r===i){let r=n.length;if(e.length!==r)return!1;for(let i=0;i<r;++i)if(!t(n[i],e[i]))return!1;return!0}function JL(n,e,t){let r=[];if(t===e){for(let i=0;i<n;++i)r[i]=i;return r}r[t]=e;for(let i=0,a=0;i<n;){if(i===e){++i;continue}a===t&&++a,r[a++]=i++}return r}function Sv(n,e,t){for(let r=0,i=t.length;r<i;++r){let a=t[r];a!==-1&&(n[r]=e[a])}return n}function Qn(n){let e=[];for(let t=0,r=n.length;t<r;++t){let i=n[t];for(let a=0,o=i.length;a<o;++a){let l=e[a];l===void 0&&(l=e[a]=[]),l.push(i[a])}}return e}function qL(n,e){let t=[],r=0;for(let a=0,o=e.length;a<o;++a){let{retainCount:l,deleteCount:c,insertCount:d}=e[a];l!==0&&(t.push(n.slice(r,r+l)),r+=l),r+=c,d!==0&&t.push(new Array(d))}let i=n.length;return r!==i&&t.push(n.slice(r)),new Array(0).concat(...t)}function YL(n,e,t){let r=[],i=0,a=0,o=n.length,l=e.length;for(;i<o&&a<l;){let c,d=n[i],p=e[a];if(c=t(d,p),c===0){let h=1;for(++i,++a;i<o&&a<l&&(c=t(n[i],e[a]))===0;)++h,++i,++a;r.push({retainCount:h,deleteCount:0,insertCount:0});continue}if(c<0){let h=1;for(;++i<o&&(c=t(n[i],p))<0;)++h;r.push({retainCount:0,deleteCount:h,insertCount:0});continue}if(c>0){let h=1;for(;++a<l&&(c=t(d,e[a]))>0;)++h;r.push({retainCount:0,deleteCount:0,insertCount:h});continue}}return(i<o||a<l)&&r.push({retainCount:0,deleteCount:o-i,insertCount:l-a}),r}function KL(n,e,t,r,i,a){let o=0,l=0;if(n!==0&&e!==0)for(;;){let c=t(o,l);if(c<0){if(r(o),++o===n)break}else if(c>0){if(i(l),++l===e)break}else if(a(o,l),++o,++l,o===n||l===e)break}for(;o<n;)r(o),++o;for(;l<e;)i(l),++l}var Pk=Ye(gt());var _U=!1;function Dk(n){typeof n=="object"?n.dispose():n()}function $a(n){for(let e=n.length;e>0;--e)Dk(n[e-1])}function An(n,e,t,r){return n.addEventListener(e,t,r),()=>n.removeEventListener(e,t,r)}var H=class{constructor(){this.refCount=1}addRef(){return++this.refCount,this}dispose(){if(_U){if(this.refCount===0)debugger;(this.disposedStacks=this.disposedStacks||[]).push(new Error().stack)}--this.refCount==0&&this.refCountReachedZero()}refCountReachedZero(){this.disposed();let{disposers:e}=this;e!==void 0&&($a(e),this.disposers=void 0),this.wasDisposed=!0}disposed(){}registerDisposer(e){let{disposers:t}=this;return t==null?this.disposers=[e]:t.push(e),e}unregisterDisposer(e){let{disposers:t}=this;if(t!=null){let r=t.indexOf(e);r!==-1&&t.splice(r,1)}return e}registerEventListener(e,t,r,i){this.registerDisposer(An(e,t,r,i))}registerCancellable(e){return this.registerDisposer(()=>{e.cancel()}),e}},pd=class extends H{constructor(e){super();this.value=e}};function Uf(n){return()=>{if(n!==void 0){let e=n;n=void 0,Dk(e)}}}var $e=class{constructor(){this.handlers=new Set;this.count=0;let e=this;this.dispatch=function(){++e.count,e.handlers.forEach(t=>{t.apply(this,arguments)})}}add(e){return this.handlers.add(e),()=>this.remove(e)}remove(e){return this.handlers.delete(e)}dispose(){this.handlers=void 0}};var ne=class extends $e{},Gf={count:0,add(n){return()=>{}},remove(n){return!1}};var ke=class{constructor(e){this.value_=e;this.changed=new ne}get value(){return this.value_}set value(e){e!==this.value_&&(this.value_=e,this.changed.dispatch())}},Ce=class extends ke{constructor(e,t,r=e){super(e);this.validator=t;this.defaultValue=r}toJSON(){let{value_:e}=this;if(e!==this.defaultValue)return this.value_}reset(){this.value=this.defaultValue}restoreState(e){if(e!==void 0){let{validator:t}=this;try{this.value=t(e);return}catch(r){}}this.value=this.defaultValue}},wv=class extends H{constructor(e,t){super();this.changed=new ne;this.f=e,this.ws=t;for(let r of t)this.registerDisposer(r.changed.add(this.changed.dispatch))}get value(){return this.f(...this.ws.map(e=>e.value))}};function Tv(n,...e){return new wv(n,e)}var Ik=class extends H{constructor(e,t){super();this.changed=new ne;this.valueGeneration=-1;this.f=e,this.ws=t;for(let r of t)this.registerDisposer(r.changed.add(this.changed.dispatch))}get value(){let e=this.changed.count;return e!==this.valueGeneration&&(this.value_=this.f(...this.ws.map(t=>t.value)),this.valueGeneration=e),this.value_}};function vn(n,...e){return new Ik(n,e)}var Wf=class extends H{constructor(e,t=(r,i)=>r===i){super();this.changed=new $e;this.value=e.value,this.registerDisposer(e.changed.add(()=>{let r=e.value;t(this.value,r)||(this.value=r,this.changed.dispatch())}))}};function Mt(n,e,t){let r=new wv(n,e),i=new Wf(r,t);return i.registerDisposer(r),i}var fd=class extends H{constructor(e){super();this.changed=new ne;let t=e(this),r=Object.keys(t),i=()=>{let a=Array.isArray(t)?[]:{};for(let o of r)a[o]=t[o].value;this.value=a,this.changed.dispatch()};i();for(let a of r){let o=t[a];this.registerDisposer(o.changed.add(()=>i()))}}};var Sc=class{constructor(e){this.changed=new $e;e===void 0?this.values=new Set:this.values=new Set(e)}add(e){let{values:t}=this;return t.has(e)||(t.add(e),this.changed.dispatch(e,!0)),this}delete(e){let{values:t}=this;return t.delete(e)?(this.changed.dispatch(e,!1),!0):!1}has(e){return this.values.has(e)}get size(){return this.values.size}[Symbol.iterator](){return this.values[Symbol.iterator]()}clear(){let{values:e}=this;e.size>0&&(e.clear(),this.changed.dispatch(null,!1))}};function Mn(n,...e){let t=e.map(c=>c.value),r=e.length,i=new H,a=n(i,...t),o=(0,Pk.default)(()=>{let c=!1;for(let d=0;d<r;++d){let h=e[d].value;t[d]!==h&&(t[d]=h,c=!0)}!c||(i.dispose(),i=new H,a=n(i,...t))},0),l=e.map(c=>c.changed.add(o));return{flush(){o.flush()},dispose(){o.cancel(),$a(l),i.dispose()},get value(){return o.flush(),a}}}function ja(n,...e){let t=e.map(c=>c.value),r=e.length,i=new H,a=n(i,...t),o=()=>{let c=!1;for(let d=0;d<r;++d){let h=e[d].value;t[d]!==h&&(t[d]=h,c=!0)}!c||(i.dispose(),i=new H,a=n(i,...t))},l=e.map(c=>c.changed.add(o));return{dispose(){$a(l),i.dispose()},get value(){return a}}}function Pr(n){return{changed:Gf,value:n}}function Ir(n,e){return n(e.value),e.changed.add(()=>n(e.value))}var bc=class{constructor(e,t){this.outer=e;this.getInner=t;this.changed=new ne;this.update=()=>{let{disposer:e,outer:t}=this;e!==void 0&&e();let r=this.inner=this.getInner(t.value);this.disposer=r.changed.add(this.changed.dispatch),this.changed.dispatch()};e.changed.add(this.update),this.update()}dispose(){this.outer.changed.remove(this.update),this.disposer()}get value(){return this.inner.value}set value(e){this.inner.value=e}},Oo=class extends bc{reset(){this.inner.reset()}restoreState(e){this.inner.restoreState(e)}toJSON(){return this.inner.toJSON()}};var zf=new Float32Array(1);function Ak(n){zf[0]=n,n=zf[0];for(let e=1;e<21;++e){let t=n.toPrecision(e);if(zf[0]=parseFloat(t),zf[0]===n)return t}return n.toString()}var Je=1e-6,Ct=typeof Float32Array!="undefined"?Float32Array:Array,Ar=Math.random;var s8=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var n=0,e=arguments.length;e--;)n+=arguments[e]*arguments[e];return Math.sqrt(n)});var It={};vc(It,{add:()=>r3,adjoint:()=>zU,clone:()=>OU,copy:()=>NU,create:()=>Lv,determinant:()=>HU,equals:()=>s3,exactEquals:()=>o3,frob:()=>n3,fromMat2d:()=>XU,fromMat4:()=>VU,fromQuat:()=>QU,fromRotation:()=>YU,fromScaling:()=>KU,fromTranslation:()=>qU,fromValues:()=>BU,identity:()=>UU,invert:()=>WU,mul:()=>l3,multiply:()=>Mk,multiplyScalar:()=>i3,multiplyScalarAndAdd:()=>a3,normalFromMat4:()=>ZU,projection:()=>e3,rotate:()=>jU,scale:()=>JU,set:()=>FU,str:()=>t3,sub:()=>c3,subtract:()=>Rk,translate:()=>$U,transpose:()=>GU});function Lv(){var n=new Ct(9);return Ct!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[5]=0,n[6]=0,n[7]=0),n[0]=1,n[4]=1,n[8]=1,n}function VU(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[4],n[4]=e[5],n[5]=e[6],n[6]=e[8],n[7]=e[9],n[8]=e[10],n}function OU(n){var e=new Ct(9);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],e}function NU(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[8]=e[8],n}function BU(n,e,t,r,i,a,o,l,c){var d=new Ct(9);return d[0]=n,d[1]=e,d[2]=t,d[3]=r,d[4]=i,d[5]=a,d[6]=o,d[7]=l,d[8]=c,d}function FU(n,e,t,r,i,a,o,l,c,d){return n[0]=e,n[1]=t,n[2]=r,n[3]=i,n[4]=a,n[5]=o,n[6]=l,n[7]=c,n[8]=d,n}function UU(n){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=1,n[5]=0,n[6]=0,n[7]=0,n[8]=1,n}function GU(n,e){if(n===e){var t=e[1],r=e[2],i=e[5];n[1]=e[3],n[2]=e[6],n[3]=t,n[5]=e[7],n[6]=r,n[7]=i}else n[0]=e[0],n[1]=e[3],n[2]=e[6],n[3]=e[1],n[4]=e[4],n[5]=e[7],n[6]=e[2],n[7]=e[5],n[8]=e[8];return n}function WU(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8],h=p*o-l*d,g=-p*a+l*c,v=d*a-o*c,b=t*h+r*g+i*v;return b?(b=1/b,n[0]=h*b,n[1]=(-p*r+i*d)*b,n[2]=(l*r-i*o)*b,n[3]=g*b,n[4]=(p*t-i*c)*b,n[5]=(-l*t+i*a)*b,n[6]=v*b,n[7]=(-d*t+r*c)*b,n[8]=(o*t-r*a)*b,n):null}function zU(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8];return n[0]=o*p-l*d,n[1]=i*d-r*p,n[2]=r*l-i*o,n[3]=l*c-a*p,n[4]=t*p-i*c,n[5]=i*a-t*l,n[6]=a*d-o*c,n[7]=r*c-t*d,n[8]=t*o-r*a,n}function HU(n){var e=n[0],t=n[1],r=n[2],i=n[3],a=n[4],o=n[5],l=n[6],c=n[7],d=n[8];return e*(d*a-o*c)+t*(-d*i+o*l)+r*(c*i-a*l)}function Mk(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=e[4],c=e[5],d=e[6],p=e[7],h=e[8],g=t[0],v=t[1],b=t[2],x=t[3],C=t[4],T=t[5],P=t[6],I=t[7],M=t[8];return n[0]=g*r+v*o+b*d,n[1]=g*i+v*l+b*p,n[2]=g*a+v*c+b*h,n[3]=x*r+C*o+T*d,n[4]=x*i+C*l+T*p,n[5]=x*a+C*c+T*h,n[6]=P*r+I*o+M*d,n[7]=P*i+I*l+M*p,n[8]=P*a+I*c+M*h,n}function $U(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=e[4],c=e[5],d=e[6],p=e[7],h=e[8],g=t[0],v=t[1];return n[0]=r,n[1]=i,n[2]=a,n[3]=o,n[4]=l,n[5]=c,n[6]=g*r+v*o+d,n[7]=g*i+v*l+p,n[8]=g*a+v*c+h,n}function jU(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=e[4],c=e[5],d=e[6],p=e[7],h=e[8],g=Math.sin(t),v=Math.cos(t);return n[0]=v*r+g*o,n[1]=v*i+g*l,n[2]=v*a+g*c,n[3]=v*o-g*r,n[4]=v*l-g*i,n[5]=v*c-g*a,n[6]=d,n[7]=p,n[8]=h,n}function JU(n,e,t){var r=t[0],i=t[1];return n[0]=r*e[0],n[1]=r*e[1],n[2]=r*e[2],n[3]=i*e[3],n[4]=i*e[4],n[5]=i*e[5],n[6]=e[6],n[7]=e[7],n[8]=e[8],n}function qU(n,e){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=1,n[5]=0,n[6]=e[0],n[7]=e[1],n[8]=1,n}function YU(n,e){var t=Math.sin(e),r=Math.cos(e);return n[0]=r,n[1]=t,n[2]=0,n[3]=-t,n[4]=r,n[5]=0,n[6]=0,n[7]=0,n[8]=1,n}function KU(n,e){return n[0]=e[0],n[1]=0,n[2]=0,n[3]=0,n[4]=e[1],n[5]=0,n[6]=0,n[7]=0,n[8]=1,n}function XU(n,e){return n[0]=e[0],n[1]=e[1],n[2]=0,n[3]=e[2],n[4]=e[3],n[5]=0,n[6]=e[4],n[7]=e[5],n[8]=1,n}function QU(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=t+t,l=r+r,c=i+i,d=t*o,p=r*o,h=r*l,g=i*o,v=i*l,b=i*c,x=a*o,C=a*l,T=a*c;return n[0]=1-h-b,n[3]=p-T,n[6]=g+C,n[1]=p+T,n[4]=1-d-b,n[7]=v-x,n[2]=g-C,n[5]=v+x,n[8]=1-d-h,n}function ZU(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8],h=e[9],g=e[10],v=e[11],b=e[12],x=e[13],C=e[14],T=e[15],P=t*l-r*o,I=t*c-i*o,M=t*d-a*o,D=r*c-i*l,E=r*d-a*l,V=i*d-a*c,O=p*x-h*b,B=p*C-g*b,z=p*T-v*b,_=h*C-g*x,F=h*T-v*x,N=g*T-v*C,J=P*N-I*F+M*_+D*z-E*B+V*O;return J?(J=1/J,n[0]=(l*N-c*F+d*_)*J,n[1]=(c*z-o*N-d*B)*J,n[2]=(o*F-l*z+d*O)*J,n[3]=(i*F-r*N-a*_)*J,n[4]=(t*N-i*z+a*B)*J,n[5]=(r*z-t*F-a*O)*J,n[6]=(x*V-C*E+T*D)*J,n[7]=(C*M-b*V-T*I)*J,n[8]=(b*E-x*M+T*P)*J,n):null}function e3(n,e,t){return n[0]=2/e,n[1]=0,n[2]=0,n[3]=0,n[4]=-2/t,n[5]=0,n[6]=-1,n[7]=1,n[8]=1,n}function t3(n){return"mat3("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+", "+n[4]+", "+n[5]+", "+n[6]+", "+n[7]+", "+n[8]+")"}function n3(n){return Math.hypot(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8])}function r3(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n[3]=e[3]+t[3],n[4]=e[4]+t[4],n[5]=e[5]+t[5],n[6]=e[6]+t[6],n[7]=e[7]+t[7],n[8]=e[8]+t[8],n}function Rk(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n[3]=e[3]-t[3],n[4]=e[4]-t[4],n[5]=e[5]-t[5],n[6]=e[6]-t[6],n[7]=e[7]-t[7],n[8]=e[8]-t[8],n}function i3(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n[3]=e[3]*t,n[4]=e[4]*t,n[5]=e[5]*t,n[6]=e[6]*t,n[7]=e[7]*t,n[8]=e[8]*t,n}function a3(n,e,t,r){return n[0]=e[0]+t[0]*r,n[1]=e[1]+t[1]*r,n[2]=e[2]+t[2]*r,n[3]=e[3]+t[3]*r,n[4]=e[4]+t[4]*r,n[5]=e[5]+t[5]*r,n[6]=e[6]+t[6]*r,n[7]=e[7]+t[7]*r,n[8]=e[8]+t[8]*r,n}function o3(n,e){return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]&&n[4]===e[4]&&n[5]===e[5]&&n[6]===e[6]&&n[7]===e[7]&&n[8]===e[8]}function s3(n,e){var t=n[0],r=n[1],i=n[2],a=n[3],o=n[4],l=n[5],c=n[6],d=n[7],p=n[8],h=e[0],g=e[1],v=e[2],b=e[3],x=e[4],C=e[5],T=e[6],P=e[7],I=e[8];return Math.abs(t-h)<=Je*Math.max(1,Math.abs(t),Math.abs(h))&&Math.abs(r-g)<=Je*Math.max(1,Math.abs(r),Math.abs(g))&&Math.abs(i-v)<=Je*Math.max(1,Math.abs(i),Math.abs(v))&&Math.abs(a-b)<=Je*Math.max(1,Math.abs(a),Math.abs(b))&&Math.abs(o-x)<=Je*Math.max(1,Math.abs(o),Math.abs(x))&&Math.abs(l-C)<=Je*Math.max(1,Math.abs(l),Math.abs(C))&&Math.abs(c-T)<=Je*Math.max(1,Math.abs(c),Math.abs(T))&&Math.abs(d-P)<=Je*Math.max(1,Math.abs(d),Math.abs(P))&&Math.abs(p-I)<=Je*Math.max(1,Math.abs(p),Math.abs(I))}var l3=Mk,c3=Rk;var oe={};vc(oe,{add:()=>$3,adjoint:()=>y3,clone:()=>d3,copy:()=>p3,create:()=>u3,determinant:()=>v3,equals:()=>Y3,exactEquals:()=>q3,frob:()=>H3,fromQuat:()=>O3,fromQuat2:()=>A3,fromRotation:()=>E3,fromRotationTranslation:()=>Ok,fromRotationTranslationScale:()=>_3,fromRotationTranslationScaleOrigin:()=>V3,fromScaling:()=>k3,fromTranslation:()=>L3,fromValues:()=>f3,fromXRotation:()=>D3,fromYRotation:()=>P3,fromZRotation:()=>I3,frustum:()=>N3,getRotation:()=>R3,getScaling:()=>Nk,getTranslation:()=>M3,identity:()=>_k,invert:()=>g3,lookAt:()=>G3,mul:()=>K3,multiply:()=>Vk,multiplyScalar:()=>j3,multiplyScalarAndAdd:()=>J3,ortho:()=>U3,perspective:()=>B3,perspectiveFromFieldOfView:()=>F3,rotate:()=>x3,rotateX:()=>C3,rotateY:()=>w3,rotateZ:()=>T3,scale:()=>b3,set:()=>h3,str:()=>z3,sub:()=>X3,subtract:()=>Bk,targetTo:()=>W3,translate:()=>S3,transpose:()=>m3});function u3(){var n=new Ct(16);return Ct!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=0,n[12]=0,n[13]=0,n[14]=0),n[0]=1,n[5]=1,n[10]=1,n[15]=1,n}function d3(n){var e=new Ct(16);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],e[9]=n[9],e[10]=n[10],e[11]=n[11],e[12]=n[12],e[13]=n[13],e[14]=n[14],e[15]=n[15],e}function p3(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[8]=e[8],n[9]=e[9],n[10]=e[10],n[11]=e[11],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15],n}function f3(n,e,t,r,i,a,o,l,c,d,p,h,g,v,b,x){var C=new Ct(16);return C[0]=n,C[1]=e,C[2]=t,C[3]=r,C[4]=i,C[5]=a,C[6]=o,C[7]=l,C[8]=c,C[9]=d,C[10]=p,C[11]=h,C[12]=g,C[13]=v,C[14]=b,C[15]=x,C}function h3(n,e,t,r,i,a,o,l,c,d,p,h,g,v,b,x,C){return n[0]=e,n[1]=t,n[2]=r,n[3]=i,n[4]=a,n[5]=o,n[6]=l,n[7]=c,n[8]=d,n[9]=p,n[10]=h,n[11]=g,n[12]=v,n[13]=b,n[14]=x,n[15]=C,n}function _k(n){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function m3(n,e){if(n===e){var t=e[1],r=e[2],i=e[3],a=e[6],o=e[7],l=e[11];n[1]=e[4],n[2]=e[8],n[3]=e[12],n[4]=t,n[6]=e[9],n[7]=e[13],n[8]=r,n[9]=a,n[11]=e[14],n[12]=i,n[13]=o,n[14]=l}else n[0]=e[0],n[1]=e[4],n[2]=e[8],n[3]=e[12],n[4]=e[1],n[5]=e[5],n[6]=e[9],n[7]=e[13],n[8]=e[2],n[9]=e[6],n[10]=e[10],n[11]=e[14],n[12]=e[3],n[13]=e[7],n[14]=e[11],n[15]=e[15];return n}function g3(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8],h=e[9],g=e[10],v=e[11],b=e[12],x=e[13],C=e[14],T=e[15],P=t*l-r*o,I=t*c-i*o,M=t*d-a*o,D=r*c-i*l,E=r*d-a*l,V=i*d-a*c,O=p*x-h*b,B=p*C-g*b,z=p*T-v*b,_=h*C-g*x,F=h*T-v*x,N=g*T-v*C,J=P*N-I*F+M*_+D*z-E*B+V*O;return J?(J=1/J,n[0]=(l*N-c*F+d*_)*J,n[1]=(i*F-r*N-a*_)*J,n[2]=(x*V-C*E+T*D)*J,n[3]=(g*E-h*V-v*D)*J,n[4]=(c*z-o*N-d*B)*J,n[5]=(t*N-i*z+a*B)*J,n[6]=(C*M-b*V-T*I)*J,n[7]=(p*V-g*M+v*I)*J,n[8]=(o*F-l*z+d*O)*J,n[9]=(r*z-t*F-a*O)*J,n[10]=(b*E-x*M+T*P)*J,n[11]=(h*M-p*E-v*P)*J,n[12]=(l*B-o*_-c*O)*J,n[13]=(t*_-r*B+i*O)*J,n[14]=(x*I-b*D-C*P)*J,n[15]=(p*D-h*I+g*P)*J,n):null}function y3(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8],h=e[9],g=e[10],v=e[11],b=e[12],x=e[13],C=e[14],T=e[15];return n[0]=l*(g*T-v*C)-h*(c*T-d*C)+x*(c*v-d*g),n[1]=-(r*(g*T-v*C)-h*(i*T-a*C)+x*(i*v-a*g)),n[2]=r*(c*T-d*C)-l*(i*T-a*C)+x*(i*d-a*c),n[3]=-(r*(c*v-d*g)-l*(i*v-a*g)+h*(i*d-a*c)),n[4]=-(o*(g*T-v*C)-p*(c*T-d*C)+b*(c*v-d*g)),n[5]=t*(g*T-v*C)-p*(i*T-a*C)+b*(i*v-a*g),n[6]=-(t*(c*T-d*C)-o*(i*T-a*C)+b*(i*d-a*c)),n[7]=t*(c*v-d*g)-o*(i*v-a*g)+p*(i*d-a*c),n[8]=o*(h*T-v*x)-p*(l*T-d*x)+b*(l*v-d*h),n[9]=-(t*(h*T-v*x)-p*(r*T-a*x)+b*(r*v-a*h)),n[10]=t*(l*T-d*x)-o*(r*T-a*x)+b*(r*d-a*l),n[11]=-(t*(l*v-d*h)-o*(r*v-a*h)+p*(r*d-a*l)),n[12]=-(o*(h*C-g*x)-p*(l*C-c*x)+b*(l*g-c*h)),n[13]=t*(h*C-g*x)-p*(r*C-i*x)+b*(r*g-i*h),n[14]=-(t*(l*C-c*x)-o*(r*C-i*x)+b*(r*c-i*l)),n[15]=t*(l*g-c*h)-o*(r*g-i*h)+p*(r*c-i*l),n}function v3(n){var e=n[0],t=n[1],r=n[2],i=n[3],a=n[4],o=n[5],l=n[6],c=n[7],d=n[8],p=n[9],h=n[10],g=n[11],v=n[12],b=n[13],x=n[14],C=n[15],T=e*o-t*a,P=e*l-r*a,I=e*c-i*a,M=t*l-r*o,D=t*c-i*o,E=r*c-i*l,V=d*b-p*v,O=d*x-h*v,B=d*C-g*v,z=p*x-h*b,_=p*C-g*b,F=h*C-g*x;return T*F-P*_+I*z+M*B-D*O+E*V}function Vk(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=e[4],c=e[5],d=e[6],p=e[7],h=e[8],g=e[9],v=e[10],b=e[11],x=e[12],C=e[13],T=e[14],P=e[15],I=t[0],M=t[1],D=t[2],E=t[3];return n[0]=I*r+M*l+D*h+E*x,n[1]=I*i+M*c+D*g+E*C,n[2]=I*a+M*d+D*v+E*T,n[3]=I*o+M*p+D*b+E*P,I=t[4],M=t[5],D=t[6],E=t[7],n[4]=I*r+M*l+D*h+E*x,n[5]=I*i+M*c+D*g+E*C,n[6]=I*a+M*d+D*v+E*T,n[7]=I*o+M*p+D*b+E*P,I=t[8],M=t[9],D=t[10],E=t[11],n[8]=I*r+M*l+D*h+E*x,n[9]=I*i+M*c+D*g+E*C,n[10]=I*a+M*d+D*v+E*T,n[11]=I*o+M*p+D*b+E*P,I=t[12],M=t[13],D=t[14],E=t[15],n[12]=I*r+M*l+D*h+E*x,n[13]=I*i+M*c+D*g+E*C,n[14]=I*a+M*d+D*v+E*T,n[15]=I*o+M*p+D*b+E*P,n}function S3(n,e,t){var r=t[0],i=t[1],a=t[2],o,l,c,d,p,h,g,v,b,x,C,T;return e===n?(n[12]=e[0]*r+e[4]*i+e[8]*a+e[12],n[13]=e[1]*r+e[5]*i+e[9]*a+e[13],n[14]=e[2]*r+e[6]*i+e[10]*a+e[14],n[15]=e[3]*r+e[7]*i+e[11]*a+e[15]):(o=e[0],l=e[1],c=e[2],d=e[3],p=e[4],h=e[5],g=e[6],v=e[7],b=e[8],x=e[9],C=e[10],T=e[11],n[0]=o,n[1]=l,n[2]=c,n[3]=d,n[4]=p,n[5]=h,n[6]=g,n[7]=v,n[8]=b,n[9]=x,n[10]=C,n[11]=T,n[12]=o*r+p*i+b*a+e[12],n[13]=l*r+h*i+x*a+e[13],n[14]=c*r+g*i+C*a+e[14],n[15]=d*r+v*i+T*a+e[15]),n}function b3(n,e,t){var r=t[0],i=t[1],a=t[2];return n[0]=e[0]*r,n[1]=e[1]*r,n[2]=e[2]*r,n[3]=e[3]*r,n[4]=e[4]*i,n[5]=e[5]*i,n[6]=e[6]*i,n[7]=e[7]*i,n[8]=e[8]*a,n[9]=e[9]*a,n[10]=e[10]*a,n[11]=e[11]*a,n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15],n}function x3(n,e,t,r){var i=r[0],a=r[1],o=r[2],l=Math.hypot(i,a,o),c,d,p,h,g,v,b,x,C,T,P,I,M,D,E,V,O,B,z,_,F,N,J,ae;return l<Je?null:(l=1/l,i*=l,a*=l,o*=l,c=Math.sin(t),d=Math.cos(t),p=1-d,h=e[0],g=e[1],v=e[2],b=e[3],x=e[4],C=e[5],T=e[6],P=e[7],I=e[8],M=e[9],D=e[10],E=e[11],V=i*i*p+d,O=a*i*p+o*c,B=o*i*p-a*c,z=i*a*p-o*c,_=a*a*p+d,F=o*a*p+i*c,N=i*o*p+a*c,J=a*o*p-i*c,ae=o*o*p+d,n[0]=h*V+x*O+I*B,n[1]=g*V+C*O+M*B,n[2]=v*V+T*O+D*B,n[3]=b*V+P*O+E*B,n[4]=h*z+x*_+I*F,n[5]=g*z+C*_+M*F,n[6]=v*z+T*_+D*F,n[7]=b*z+P*_+E*F,n[8]=h*N+x*J+I*ae,n[9]=g*N+C*J+M*ae,n[10]=v*N+T*J+D*ae,n[11]=b*N+P*J+E*ae,e!==n&&(n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n)}function C3(n,e,t){var r=Math.sin(t),i=Math.cos(t),a=e[4],o=e[5],l=e[6],c=e[7],d=e[8],p=e[9],h=e[10],g=e[11];return e!==n&&(n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[4]=a*i+d*r,n[5]=o*i+p*r,n[6]=l*i+h*r,n[7]=c*i+g*r,n[8]=d*i-a*r,n[9]=p*i-o*r,n[10]=h*i-l*r,n[11]=g*i-c*r,n}function w3(n,e,t){var r=Math.sin(t),i=Math.cos(t),a=e[0],o=e[1],l=e[2],c=e[3],d=e[8],p=e[9],h=e[10],g=e[11];return e!==n&&(n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[0]=a*i-d*r,n[1]=o*i-p*r,n[2]=l*i-h*r,n[3]=c*i-g*r,n[8]=a*r+d*i,n[9]=o*r+p*i,n[10]=l*r+h*i,n[11]=c*r+g*i,n}function T3(n,e,t){var r=Math.sin(t),i=Math.cos(t),a=e[0],o=e[1],l=e[2],c=e[3],d=e[4],p=e[5],h=e[6],g=e[7];return e!==n&&(n[8]=e[8],n[9]=e[9],n[10]=e[10],n[11]=e[11],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[0]=a*i+d*r,n[1]=o*i+p*r,n[2]=l*i+h*r,n[3]=c*i+g*r,n[4]=d*i-a*r,n[5]=p*i-o*r,n[6]=h*i-l*r,n[7]=g*i-c*r,n}function L3(n,e){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=e[0],n[13]=e[1],n[14]=e[2],n[15]=1,n}function k3(n,e){return n[0]=e[0],n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=e[1],n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=e[2],n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function E3(n,e,t){var r=t[0],i=t[1],a=t[2],o=Math.hypot(r,i,a),l,c,d;return o<Je?null:(o=1/o,r*=o,i*=o,a*=o,l=Math.sin(e),c=Math.cos(e),d=1-c,n[0]=r*r*d+c,n[1]=i*r*d+a*l,n[2]=a*r*d-i*l,n[3]=0,n[4]=r*i*d-a*l,n[5]=i*i*d+c,n[6]=a*i*d+r*l,n[7]=0,n[8]=r*a*d+i*l,n[9]=i*a*d-r*l,n[10]=a*a*d+c,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n)}function D3(n,e){var t=Math.sin(e),r=Math.cos(e);return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=r,n[6]=t,n[7]=0,n[8]=0,n[9]=-t,n[10]=r,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function P3(n,e){var t=Math.sin(e),r=Math.cos(e);return n[0]=r,n[1]=0,n[2]=-t,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=t,n[9]=0,n[10]=r,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function I3(n,e){var t=Math.sin(e),r=Math.cos(e);return n[0]=r,n[1]=t,n[2]=0,n[3]=0,n[4]=-t,n[5]=r,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function Ok(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=r+r,c=i+i,d=a+a,p=r*l,h=r*c,g=r*d,v=i*c,b=i*d,x=a*d,C=o*l,T=o*c,P=o*d;return n[0]=1-(v+x),n[1]=h+P,n[2]=g-T,n[3]=0,n[4]=h-P,n[5]=1-(p+x),n[6]=b+C,n[7]=0,n[8]=g+T,n[9]=b-C,n[10]=1-(p+v),n[11]=0,n[12]=t[0],n[13]=t[1],n[14]=t[2],n[15]=1,n}function A3(n,e){var t=new Ct(3),r=-e[0],i=-e[1],a=-e[2],o=e[3],l=e[4],c=e[5],d=e[6],p=e[7],h=r*r+i*i+a*a+o*o;return h>0?(t[0]=(l*o+p*r+c*a-d*i)*2/h,t[1]=(c*o+p*i+d*r-l*a)*2/h,t[2]=(d*o+p*a+l*i-c*r)*2/h):(t[0]=(l*o+p*r+c*a-d*i)*2,t[1]=(c*o+p*i+d*r-l*a)*2,t[2]=(d*o+p*a+l*i-c*r)*2),Ok(n,e,t),n}function M3(n,e){return n[0]=e[12],n[1]=e[13],n[2]=e[14],n}function Nk(n,e){var t=e[0],r=e[1],i=e[2],a=e[4],o=e[5],l=e[6],c=e[8],d=e[9],p=e[10];return n[0]=Math.hypot(t,r,i),n[1]=Math.hypot(a,o,l),n[2]=Math.hypot(c,d,p),n}function R3(n,e){var t=new Ct(3);Nk(t,e);var r=1/t[0],i=1/t[1],a=1/t[2],o=e[0]*r,l=e[1]*i,c=e[2]*a,d=e[4]*r,p=e[5]*i,h=e[6]*a,g=e[8]*r,v=e[9]*i,b=e[10]*a,x=o+p+b,C=0;return x>0?(C=Math.sqrt(x+1)*2,n[3]=.25*C,n[0]=(h-v)/C,n[1]=(g-c)/C,n[2]=(l-d)/C):o>p&&o>b?(C=Math.sqrt(1+o-p-b)*2,n[3]=(h-v)/C,n[0]=.25*C,n[1]=(l+d)/C,n[2]=(g+c)/C):p>b?(C=Math.sqrt(1+p-o-b)*2,n[3]=(g-c)/C,n[0]=(l+d)/C,n[1]=.25*C,n[2]=(h+v)/C):(C=Math.sqrt(1+b-o-p)*2,n[3]=(l-d)/C,n[0]=(g+c)/C,n[1]=(h+v)/C,n[2]=.25*C),n}function _3(n,e,t,r){var i=e[0],a=e[1],o=e[2],l=e[3],c=i+i,d=a+a,p=o+o,h=i*c,g=i*d,v=i*p,b=a*d,x=a*p,C=o*p,T=l*c,P=l*d,I=l*p,M=r[0],D=r[1],E=r[2];return n[0]=(1-(b+C))*M,n[1]=(g+I)*M,n[2]=(v-P)*M,n[3]=0,n[4]=(g-I)*D,n[5]=(1-(h+C))*D,n[6]=(x+T)*D,n[7]=0,n[8]=(v+P)*E,n[9]=(x-T)*E,n[10]=(1-(h+b))*E,n[11]=0,n[12]=t[0],n[13]=t[1],n[14]=t[2],n[15]=1,n}function V3(n,e,t,r,i){var a=e[0],o=e[1],l=e[2],c=e[3],d=a+a,p=o+o,h=l+l,g=a*d,v=a*p,b=a*h,x=o*p,C=o*h,T=l*h,P=c*d,I=c*p,M=c*h,D=r[0],E=r[1],V=r[2],O=i[0],B=i[1],z=i[2],_=(1-(x+T))*D,F=(v+M)*D,N=(b-I)*D,J=(v-M)*E,ae=(1-(g+T))*E,pe=(C+P)*E,me=(b+I)*V,Ae=(C-P)*V,le=(1-(g+x))*V;return n[0]=_,n[1]=F,n[2]=N,n[3]=0,n[4]=J,n[5]=ae,n[6]=pe,n[7]=0,n[8]=me,n[9]=Ae,n[10]=le,n[11]=0,n[12]=t[0]+O-(_*O+J*B+me*z),n[13]=t[1]+B-(F*O+ae*B+Ae*z),n[14]=t[2]+z-(N*O+pe*B+le*z),n[15]=1,n}function O3(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=t+t,l=r+r,c=i+i,d=t*o,p=r*o,h=r*l,g=i*o,v=i*l,b=i*c,x=a*o,C=a*l,T=a*c;return n[0]=1-h-b,n[1]=p+T,n[2]=g-C,n[3]=0,n[4]=p-T,n[5]=1-d-b,n[6]=v+x,n[7]=0,n[8]=g+C,n[9]=v-x,n[10]=1-d-h,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function N3(n,e,t,r,i,a,o){var l=1/(t-e),c=1/(i-r),d=1/(a-o);return n[0]=a*2*l,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=a*2*c,n[6]=0,n[7]=0,n[8]=(t+e)*l,n[9]=(i+r)*c,n[10]=(o+a)*d,n[11]=-1,n[12]=0,n[13]=0,n[14]=o*a*2*d,n[15]=0,n}function B3(n,e,t,r,i){var a=1/Math.tan(e/2),o;return n[0]=a/t,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=a,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=-1,n[12]=0,n[13]=0,n[15]=0,i!=null&&i!==Infinity?(o=1/(r-i),n[10]=(i+r)*o,n[14]=2*i*r*o):(n[10]=-1,n[14]=-2*r),n}function F3(n,e,t,r){var i=Math.tan(e.upDegrees*Math.PI/180),a=Math.tan(e.downDegrees*Math.PI/180),o=Math.tan(e.leftDegrees*Math.PI/180),l=Math.tan(e.rightDegrees*Math.PI/180),c=2/(o+l),d=2/(i+a);return n[0]=c,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=d,n[6]=0,n[7]=0,n[8]=-((o-l)*c*.5),n[9]=(i-a)*d*.5,n[10]=r/(t-r),n[11]=-1,n[12]=0,n[13]=0,n[14]=r*t/(t-r),n[15]=0,n}function U3(n,e,t,r,i,a,o){var l=1/(e-t),c=1/(r-i),d=1/(a-o);return n[0]=-2*l,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=-2*c,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=2*d,n[11]=0,n[12]=(e+t)*l,n[13]=(i+r)*c,n[14]=(o+a)*d,n[15]=1,n}function G3(n,e,t,r){var i,a,o,l,c,d,p,h,g,v,b=e[0],x=e[1],C=e[2],T=r[0],P=r[1],I=r[2],M=t[0],D=t[1],E=t[2];return Math.abs(b-M)<Je&&Math.abs(x-D)<Je&&Math.abs(C-E)<Je?_k(n):(p=b-M,h=x-D,g=C-E,v=1/Math.hypot(p,h,g),p*=v,h*=v,g*=v,i=P*g-I*h,a=I*p-T*g,o=T*h-P*p,v=Math.hypot(i,a,o),v?(v=1/v,i*=v,a*=v,o*=v):(i=0,a=0,o=0),l=h*o-g*a,c=g*i-p*o,d=p*a-h*i,v=Math.hypot(l,c,d),v?(v=1/v,l*=v,c*=v,d*=v):(l=0,c=0,d=0),n[0]=i,n[1]=l,n[2]=p,n[3]=0,n[4]=a,n[5]=c,n[6]=h,n[7]=0,n[8]=o,n[9]=d,n[10]=g,n[11]=0,n[12]=-(i*b+a*x+o*C),n[13]=-(l*b+c*x+d*C),n[14]=-(p*b+h*x+g*C),n[15]=1,n)}function W3(n,e,t,r){var i=e[0],a=e[1],o=e[2],l=r[0],c=r[1],d=r[2],p=i-t[0],h=a-t[1],g=o-t[2],v=p*p+h*h+g*g;v>0&&(v=1/Math.sqrt(v),p*=v,h*=v,g*=v);var b=c*g-d*h,x=d*p-l*g,C=l*h-c*p;return v=b*b+x*x+C*C,v>0&&(v=1/Math.sqrt(v),b*=v,x*=v,C*=v),n[0]=b,n[1]=x,n[2]=C,n[3]=0,n[4]=h*C-g*x,n[5]=g*b-p*C,n[6]=p*x-h*b,n[7]=0,n[8]=p,n[9]=h,n[10]=g,n[11]=0,n[12]=i,n[13]=a,n[14]=o,n[15]=1,n}function z3(n){return"mat4("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+", "+n[4]+", "+n[5]+", "+n[6]+", "+n[7]+", "+n[8]+", "+n[9]+", "+n[10]+", "+n[11]+", "+n[12]+", "+n[13]+", "+n[14]+", "+n[15]+")"}function H3(n){return Math.hypot(n[0],n[1],n[3],n[4],n[5],n[6],n[7],n[8],n[9],n[10],n[11],n[12],n[13],n[14],n[15])}function $3(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n[3]=e[3]+t[3],n[4]=e[4]+t[4],n[5]=e[5]+t[5],n[6]=e[6]+t[6],n[7]=e[7]+t[7],n[8]=e[8]+t[8],n[9]=e[9]+t[9],n[10]=e[10]+t[10],n[11]=e[11]+t[11],n[12]=e[12]+t[12],n[13]=e[13]+t[13],n[14]=e[14]+t[14],n[15]=e[15]+t[15],n}function Bk(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n[3]=e[3]-t[3],n[4]=e[4]-t[4],n[5]=e[5]-t[5],n[6]=e[6]-t[6],n[7]=e[7]-t[7],n[8]=e[8]-t[8],n[9]=e[9]-t[9],n[10]=e[10]-t[10],n[11]=e[11]-t[11],n[12]=e[12]-t[12],n[13]=e[13]-t[13],n[14]=e[14]-t[14],n[15]=e[15]-t[15],n}function j3(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n[3]=e[3]*t,n[4]=e[4]*t,n[5]=e[5]*t,n[6]=e[6]*t,n[7]=e[7]*t,n[8]=e[8]*t,n[9]=e[9]*t,n[10]=e[10]*t,n[11]=e[11]*t,n[12]=e[12]*t,n[13]=e[13]*t,n[14]=e[14]*t,n[15]=e[15]*t,n}function J3(n,e,t,r){return n[0]=e[0]+t[0]*r,n[1]=e[1]+t[1]*r,n[2]=e[2]+t[2]*r,n[3]=e[3]+t[3]*r,n[4]=e[4]+t[4]*r,n[5]=e[5]+t[5]*r,n[6]=e[6]+t[6]*r,n[7]=e[7]+t[7]*r,n[8]=e[8]+t[8]*r,n[9]=e[9]+t[9]*r,n[10]=e[10]+t[10]*r,n[11]=e[11]+t[11]*r,n[12]=e[12]+t[12]*r,n[13]=e[13]+t[13]*r,n[14]=e[14]+t[14]*r,n[15]=e[15]+t[15]*r,n}function q3(n,e){return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]&&n[4]===e[4]&&n[5]===e[5]&&n[6]===e[6]&&n[7]===e[7]&&n[8]===e[8]&&n[9]===e[9]&&n[10]===e[10]&&n[11]===e[11]&&n[12]===e[12]&&n[13]===e[13]&&n[14]===e[14]&&n[15]===e[15]}function Y3(n,e){var t=n[0],r=n[1],i=n[2],a=n[3],o=n[4],l=n[5],c=n[6],d=n[7],p=n[8],h=n[9],g=n[10],v=n[11],b=n[12],x=n[13],C=n[14],T=n[15],P=e[0],I=e[1],M=e[2],D=e[3],E=e[4],V=e[5],O=e[6],B=e[7],z=e[8],_=e[9],F=e[10],N=e[11],J=e[12],ae=e[13],pe=e[14],me=e[15];return Math.abs(t-P)<=Je*Math.max(1,Math.abs(t),Math.abs(P))&&Math.abs(r-I)<=Je*Math.max(1,Math.abs(r),Math.abs(I))&&Math.abs(i-M)<=Je*Math.max(1,Math.abs(i),Math.abs(M))&&Math.abs(a-D)<=Je*Math.max(1,Math.abs(a),Math.abs(D))&&Math.abs(o-E)<=Je*Math.max(1,Math.abs(o),Math.abs(E))&&Math.abs(l-V)<=Je*Math.max(1,Math.abs(l),Math.abs(V))&&Math.abs(c-O)<=Je*Math.max(1,Math.abs(c),Math.abs(O))&&Math.abs(d-B)<=Je*Math.max(1,Math.abs(d),Math.abs(B))&&Math.abs(p-z)<=Je*Math.max(1,Math.abs(p),Math.abs(z))&&Math.abs(h-_)<=Je*Math.max(1,Math.abs(h),Math.abs(_))&&Math.abs(g-F)<=Je*Math.max(1,Math.abs(g),Math.abs(F))&&Math.abs(v-N)<=Je*Math.max(1,Math.abs(v),Math.abs(N))&&Math.abs(b-J)<=Je*Math.max(1,Math.abs(b),Math.abs(J))&&Math.abs(x-ae)<=Je*Math.max(1,Math.abs(x),Math.abs(ae))&&Math.abs(C-pe)<=Je*Math.max(1,Math.abs(C),Math.abs(pe))&&Math.abs(T-me)<=Je*Math.max(1,Math.abs(T),Math.abs(me))}var K3=Vk,X3=Bk;var Qe={};vc(Qe,{add:()=>vG,calculateW:()=>sG,clone:()=>hG,conjugate:()=>dG,copy:()=>gG,create:()=>Bv,dot:()=>iE,equals:()=>TG,exactEquals:()=>wG,exp:()=>eE,fromEuler:()=>pG,fromMat3:()=>nE,fromValues:()=>mG,getAngle:()=>rG,getAxisAngle:()=>nG,identity:()=>tG,invert:()=>uG,len:()=>xG,length:()=>aE,lerp:()=>bG,ln:()=>tE,mul:()=>SG,multiply:()=>Zk,normalize:()=>Fv,pow:()=>lG,random:()=>cG,rotateX:()=>iG,rotateY:()=>aG,rotateZ:()=>oG,rotationTo:()=>LG,scale:()=>rE,set:()=>yG,setAxes:()=>EG,setAxisAngle:()=>Qk,slerp:()=>qf,sqlerp:()=>kG,sqrLen:()=>CG,squaredLength:()=>oE,str:()=>fG});var K={};vc(K,{add:()=>t4,angle:()=>x4,bezier:()=>f4,ceil:()=>n4,clone:()=>Q3,copy:()=>Z3,create:()=>Hf,cross:()=>md,dist:()=>P4,distance:()=>zk,div:()=>D4,divide:()=>Wk,dot:()=>$f,equals:()=>L4,exactEquals:()=>T4,floor:()=>r4,forEach:()=>M4,fromValues:()=>xc,hermite:()=>p4,inverse:()=>u4,len:()=>kv,length:()=>Fk,lerp:()=>d4,max:()=>a4,min:()=>i4,mul:()=>E4,multiply:()=>Gk,negate:()=>c4,normalize:()=>hd,random:()=>h4,rotateX:()=>v4,rotateY:()=>S4,rotateZ:()=>b4,round:()=>o4,scale:()=>s4,scaleAndAdd:()=>l4,set:()=>e4,sqrDist:()=>I4,sqrLen:()=>A4,squaredDistance:()=>Hk,squaredLength:()=>$k,str:()=>w4,sub:()=>k4,subtract:()=>Uk,transformMat3:()=>g4,transformMat4:()=>m4,transformQuat:()=>y4,zero:()=>C4});function Hf(){var n=new Ct(3);return Ct!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n}function Q3(n){var e=new Ct(3);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e}function Fk(n){var e=n[0],t=n[1],r=n[2];return Math.hypot(e,t,r)}function xc(n,e,t){var r=new Ct(3);return r[0]=n,r[1]=e,r[2]=t,r}function Z3(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n}function e4(n,e,t,r){return n[0]=e,n[1]=t,n[2]=r,n}function t4(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n}function Uk(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n}function Gk(n,e,t){return n[0]=e[0]*t[0],n[1]=e[1]*t[1],n[2]=e[2]*t[2],n}function Wk(n,e,t){return n[0]=e[0]/t[0],n[1]=e[1]/t[1],n[2]=e[2]/t[2],n}function n4(n,e){return n[0]=Math.ceil(e[0]),n[1]=Math.ceil(e[1]),n[2]=Math.ceil(e[2]),n}function r4(n,e){return n[0]=Math.floor(e[0]),n[1]=Math.floor(e[1]),n[2]=Math.floor(e[2]),n}function i4(n,e,t){return n[0]=Math.min(e[0],t[0]),n[1]=Math.min(e[1],t[1]),n[2]=Math.min(e[2],t[2]),n}function a4(n,e,t){return n[0]=Math.max(e[0],t[0]),n[1]=Math.max(e[1],t[1]),n[2]=Math.max(e[2],t[2]),n}function o4(n,e){return n[0]=Math.round(e[0]),n[1]=Math.round(e[1]),n[2]=Math.round(e[2]),n}function s4(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n}function l4(n,e,t,r){return n[0]=e[0]+t[0]*r,n[1]=e[1]+t[1]*r,n[2]=e[2]+t[2]*r,n}function zk(n,e){var t=e[0]-n[0],r=e[1]-n[1],i=e[2]-n[2];return Math.hypot(t,r,i)}function Hk(n,e){var t=e[0]-n[0],r=e[1]-n[1],i=e[2]-n[2];return t*t+r*r+i*i}function $k(n){var e=n[0],t=n[1],r=n[2];return e*e+t*t+r*r}function c4(n,e){return n[0]=-e[0],n[1]=-e[1],n[2]=-e[2],n}function u4(n,e){return n[0]=1/e[0],n[1]=1/e[1],n[2]=1/e[2],n}function hd(n,e){var t=e[0],r=e[1],i=e[2],a=t*t+r*r+i*i;return a>0&&(a=1/Math.sqrt(a)),n[0]=e[0]*a,n[1]=e[1]*a,n[2]=e[2]*a,n}function $f(n,e){return n[0]*e[0]+n[1]*e[1]+n[2]*e[2]}function md(n,e,t){var r=e[0],i=e[1],a=e[2],o=t[0],l=t[1],c=t[2];return n[0]=i*c-a*l,n[1]=a*o-r*c,n[2]=r*l-i*o,n}function d4(n,e,t,r){var i=e[0],a=e[1],o=e[2];return n[0]=i+r*(t[0]-i),n[1]=a+r*(t[1]-a),n[2]=o+r*(t[2]-o),n}function p4(n,e,t,r,i,a){var o=a*a,l=o*(2*a-3)+1,c=o*(a-2)+a,d=o*(a-1),p=o*(3-2*a);return n[0]=e[0]*l+t[0]*c+r[0]*d+i[0]*p,n[1]=e[1]*l+t[1]*c+r[1]*d+i[1]*p,n[2]=e[2]*l+t[2]*c+r[2]*d+i[2]*p,n}function f4(n,e,t,r,i,a){var o=1-a,l=o*o,c=a*a,d=l*o,p=3*a*l,h=3*c*o,g=c*a;return n[0]=e[0]*d+t[0]*p+r[0]*h+i[0]*g,n[1]=e[1]*d+t[1]*p+r[1]*h+i[1]*g,n[2]=e[2]*d+t[2]*p+r[2]*h+i[2]*g,n}function h4(n,e){e=e||1;var t=Ar()*2*Math.PI,r=Ar()*2-1,i=Math.sqrt(1-r*r)*e;return n[0]=Math.cos(t)*i,n[1]=Math.sin(t)*i,n[2]=r*e,n}function m4(n,e,t){var r=e[0],i=e[1],a=e[2],o=t[3]*r+t[7]*i+t[11]*a+t[15];return o=o||1,n[0]=(t[0]*r+t[4]*i+t[8]*a+t[12])/o,n[1]=(t[1]*r+t[5]*i+t[9]*a+t[13])/o,n[2]=(t[2]*r+t[6]*i+t[10]*a+t[14])/o,n}function g4(n,e,t){var r=e[0],i=e[1],a=e[2];return n[0]=r*t[0]+i*t[3]+a*t[6],n[1]=r*t[1]+i*t[4]+a*t[7],n[2]=r*t[2]+i*t[5]+a*t[8],n}function y4(n,e,t){var r=t[0],i=t[1],a=t[2],o=t[3],l=e[0],c=e[1],d=e[2],p=i*d-a*c,h=a*l-r*d,g=r*c-i*l,v=i*g-a*h,b=a*p-r*g,x=r*h-i*p,C=o*2;return p*=C,h*=C,g*=C,v*=2,b*=2,x*=2,n[0]=l+p+v,n[1]=c+h+b,n[2]=d+g+x,n}function v4(n,e,t,r){var i=[],a=[];return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],a[0]=i[0],a[1]=i[1]*Math.cos(r)-i[2]*Math.sin(r),a[2]=i[1]*Math.sin(r)+i[2]*Math.cos(r),n[0]=a[0]+t[0],n[1]=a[1]+t[1],n[2]=a[2]+t[2],n}function S4(n,e,t,r){var i=[],a=[];return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],a[0]=i[2]*Math.sin(r)+i[0]*Math.cos(r),a[1]=i[1],a[2]=i[2]*Math.cos(r)-i[0]*Math.sin(r),n[0]=a[0]+t[0],n[1]=a[1]+t[1],n[2]=a[2]+t[2],n}function b4(n,e,t,r){var i=[],a=[];return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],a[0]=i[0]*Math.cos(r)-i[1]*Math.sin(r),a[1]=i[0]*Math.sin(r)+i[1]*Math.cos(r),a[2]=i[2],n[0]=a[0]+t[0],n[1]=a[1]+t[1],n[2]=a[2]+t[2],n}function x4(n,e){var t=xc(n[0],n[1],n[2]),r=xc(e[0],e[1],e[2]);hd(t,t),hd(r,r);var i=$f(t,r);return i>1?0:i<-1?Math.PI:Math.acos(i)}function C4(n){return n[0]=0,n[1]=0,n[2]=0,n}function w4(n){return"vec3("+n[0]+", "+n[1]+", "+n[2]+")"}function T4(n,e){return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]}function L4(n,e){var t=n[0],r=n[1],i=n[2],a=e[0],o=e[1],l=e[2];return Math.abs(t-a)<=Je*Math.max(1,Math.abs(t),Math.abs(a))&&Math.abs(r-o)<=Je*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(i-l)<=Je*Math.max(1,Math.abs(i),Math.abs(l))}var k4=Uk,E4=Gk,D4=Wk,P4=zk,I4=Hk,kv=Fk,A4=$k,M4=function(){var n=Hf();return function(e,t,r,i,a,o){var l,c;for(t||(t=3),r||(r=0),i?c=Math.min(i*t+r,e.length):c=e.length,l=r;l<c;l+=t)n[0]=e[l],n[1]=e[l+1],n[2]=e[l+2],a(n,n,o),e[l]=n[0],e[l+1]=n[1],e[l+2]=n[2];return e}}();var an={};vc(an,{add:()=>Av,ceil:()=>R4,clone:()=>Ev,copy:()=>Pv,create:()=>jk,cross:()=>G4,dist:()=>K4,distance:()=>Kk,div:()=>Y4,divide:()=>Yk,dot:()=>_v,equals:()=>Nv,exactEquals:()=>Ov,floor:()=>_4,forEach:()=>eG,fromValues:()=>Dv,inverse:()=>U4,len:()=>Q4,length:()=>jf,lerp:()=>Vv,max:()=>O4,min:()=>V4,mul:()=>q4,multiply:()=>qk,negate:()=>F4,normalize:()=>Rv,random:()=>W4,round:()=>N4,scale:()=>Mv,scaleAndAdd:()=>B4,set:()=>Iv,sqrDist:()=>X4,sqrLen:()=>Z4,squaredDistance:()=>Xk,squaredLength:()=>Jf,str:()=>j4,sub:()=>J4,subtract:()=>Jk,transformMat4:()=>z4,transformQuat:()=>H4,zero:()=>$4});function jk(){var n=new Ct(4);return Ct!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0,n[3]=0),n}function Ev(n){var e=new Ct(4);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e}function Dv(n,e,t,r){var i=new Ct(4);return i[0]=n,i[1]=e,i[2]=t,i[3]=r,i}function Pv(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n}function Iv(n,e,t,r,i){return n[0]=e,n[1]=t,n[2]=r,n[3]=i,n}function Av(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n[3]=e[3]+t[3],n}function Jk(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n[3]=e[3]-t[3],n}function qk(n,e,t){return n[0]=e[0]*t[0],n[1]=e[1]*t[1],n[2]=e[2]*t[2],n[3]=e[3]*t[3],n}function Yk(n,e,t){return n[0]=e[0]/t[0],n[1]=e[1]/t[1],n[2]=e[2]/t[2],n[3]=e[3]/t[3],n}function R4(n,e){return n[0]=Math.ceil(e[0]),n[1]=Math.ceil(e[1]),n[2]=Math.ceil(e[2]),n[3]=Math.ceil(e[3]),n}function _4(n,e){return n[0]=Math.floor(e[0]),n[1]=Math.floor(e[1]),n[2]=Math.floor(e[2]),n[3]=Math.floor(e[3]),n}function V4(n,e,t){return n[0]=Math.min(e[0],t[0]),n[1]=Math.min(e[1],t[1]),n[2]=Math.min(e[2],t[2]),n[3]=Math.min(e[3],t[3]),n}function O4(n,e,t){return n[0]=Math.max(e[0],t[0]),n[1]=Math.max(e[1],t[1]),n[2]=Math.max(e[2],t[2]),n[3]=Math.max(e[3],t[3]),n}function N4(n,e){return n[0]=Math.round(e[0]),n[1]=Math.round(e[1]),n[2]=Math.round(e[2]),n[3]=Math.round(e[3]),n}function Mv(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n[3]=e[3]*t,n}function B4(n,e,t,r){return n[0]=e[0]+t[0]*r,n[1]=e[1]+t[1]*r,n[2]=e[2]+t[2]*r,n[3]=e[3]+t[3]*r,n}function Kk(n,e){var t=e[0]-n[0],r=e[1]-n[1],i=e[2]-n[2],a=e[3]-n[3];return Math.hypot(t,r,i,a)}function Xk(n,e){var t=e[0]-n[0],r=e[1]-n[1],i=e[2]-n[2],a=e[3]-n[3];return t*t+r*r+i*i+a*a}function jf(n){var e=n[0],t=n[1],r=n[2],i=n[3];return Math.hypot(e,t,r,i)}function Jf(n){var e=n[0],t=n[1],r=n[2],i=n[3];return e*e+t*t+r*r+i*i}function F4(n,e){return n[0]=-e[0],n[1]=-e[1],n[2]=-e[2],n[3]=-e[3],n}function U4(n,e){return n[0]=1/e[0],n[1]=1/e[1],n[2]=1/e[2],n[3]=1/e[3],n}function Rv(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=t*t+r*r+i*i+a*a;return o>0&&(o=1/Math.sqrt(o)),n[0]=t*o,n[1]=r*o,n[2]=i*o,n[3]=a*o,n}function _v(n,e){return n[0]*e[0]+n[1]*e[1]+n[2]*e[2]+n[3]*e[3]}function G4(n,e,t,r){var i=t[0]*r[1]-t[1]*r[0],a=t[0]*r[2]-t[2]*r[0],o=t[0]*r[3]-t[3]*r[0],l=t[1]*r[2]-t[2]*r[1],c=t[1]*r[3]-t[3]*r[1],d=t[2]*r[3]-t[3]*r[2],p=e[0],h=e[1],g=e[2],v=e[3];return n[0]=h*d-g*c+v*l,n[1]=-(p*d)+g*o-v*a,n[2]=p*c-h*o+v*i,n[3]=-(p*l)+h*a-g*i,n}function Vv(n,e,t,r){var i=e[0],a=e[1],o=e[2],l=e[3];return n[0]=i+r*(t[0]-i),n[1]=a+r*(t[1]-a),n[2]=o+r*(t[2]-o),n[3]=l+r*(t[3]-l),n}function W4(n,e){e=e||1;var t,r,i,a,o,l;do t=Ar()*2-1,r=Ar()*2-1,o=t*t+r*r;while(o>=1);do i=Ar()*2-1,a=Ar()*2-1,l=i*i+a*a;while(l>=1);var c=Math.sqrt((1-o)/l);return n[0]=e*t,n[1]=e*r,n[2]=e*i*c,n[3]=e*a*c,n}function z4(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3];return n[0]=t[0]*r+t[4]*i+t[8]*a+t[12]*o,n[1]=t[1]*r+t[5]*i+t[9]*a+t[13]*o,n[2]=t[2]*r+t[6]*i+t[10]*a+t[14]*o,n[3]=t[3]*r+t[7]*i+t[11]*a+t[15]*o,n}function H4(n,e,t){var r=e[0],i=e[1],a=e[2],o=t[0],l=t[1],c=t[2],d=t[3],p=d*r+l*a-c*i,h=d*i+c*r-o*a,g=d*a+o*i-l*r,v=-o*r-l*i-c*a;return n[0]=p*d+v*-o+h*-c-g*-l,n[1]=h*d+v*-l+g*-o-p*-c,n[2]=g*d+v*-c+p*-l-h*-o,n[3]=e[3],n}function $4(n){return n[0]=0,n[1]=0,n[2]=0,n[3]=0,n}function j4(n){return"vec4("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+")"}function Ov(n,e){return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]}function Nv(n,e){var t=n[0],r=n[1],i=n[2],a=n[3],o=e[0],l=e[1],c=e[2],d=e[3];return Math.abs(t-o)<=Je*Math.max(1,Math.abs(t),Math.abs(o))&&Math.abs(r-l)<=Je*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(i-c)<=Je*Math.max(1,Math.abs(i),Math.abs(c))&&Math.abs(a-d)<=Je*Math.max(1,Math.abs(a),Math.abs(d))}var J4=Jk,q4=qk,Y4=Yk,K4=Kk,X4=Xk,Q4=jf,Z4=Jf,eG=function(){var n=jk();return function(e,t,r,i,a,o){var l,c;for(t||(t=4),r||(r=0),i?c=Math.min(i*t+r,e.length):c=e.length,l=r;l<c;l+=t)n[0]=e[l],n[1]=e[l+1],n[2]=e[l+2],n[3]=e[l+3],a(n,n,o),e[l]=n[0],e[l+1]=n[1],e[l+2]=n[2],e[l+3]=n[3];return e}}();function Bv(){var n=new Ct(4);return Ct!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n[3]=1,n}function tG(n){return n[0]=0,n[1]=0,n[2]=0,n[3]=1,n}function Qk(n,e,t){t=t*.5;var r=Math.sin(t);return n[0]=r*e[0],n[1]=r*e[1],n[2]=r*e[2],n[3]=Math.cos(t),n}function nG(n,e){var t=Math.acos(e[3])*2,r=Math.sin(t/2);return r>Je?(n[0]=e[0]/r,n[1]=e[1]/r,n[2]=e[2]/r):(n[0]=1,n[1]=0,n[2]=0),t}function rG(n,e){var t=iE(n,e);return Math.acos(2*t*t-1)}function Zk(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=t[0],c=t[1],d=t[2],p=t[3];return n[0]=r*p+o*l+i*d-a*c,n[1]=i*p+o*c+a*l-r*d,n[2]=a*p+o*d+r*c-i*l,n[3]=o*p-r*l-i*c-a*d,n}function iG(n,e,t){t*=.5;var r=e[0],i=e[1],a=e[2],o=e[3],l=Math.sin(t),c=Math.cos(t);return n[0]=r*c+o*l,n[1]=i*c+a*l,n[2]=a*c-i*l,n[3]=o*c-r*l,n}function aG(n,e,t){t*=.5;var r=e[0],i=e[1],a=e[2],o=e[3],l=Math.sin(t),c=Math.cos(t);return n[0]=r*c-a*l,n[1]=i*c+o*l,n[2]=a*c+r*l,n[3]=o*c-i*l,n}function oG(n,e,t){t*=.5;var r=e[0],i=e[1],a=e[2],o=e[3],l=Math.sin(t),c=Math.cos(t);return n[0]=r*c+i*l,n[1]=i*c-r*l,n[2]=a*c+o*l,n[3]=o*c-a*l,n}function sG(n,e){var t=e[0],r=e[1],i=e[2];return n[0]=t,n[1]=r,n[2]=i,n[3]=Math.sqrt(Math.abs(1-t*t-r*r-i*i)),n}function eE(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=Math.sqrt(t*t+r*r+i*i),l=Math.exp(a),c=o>0?l*Math.sin(o)/o:0;return n[0]=t*c,n[1]=r*c,n[2]=i*c,n[3]=l*Math.cos(o),n}function tE(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=Math.sqrt(t*t+r*r+i*i),l=o>0?Math.atan2(o,a)/o:0;return n[0]=t*l,n[1]=r*l,n[2]=i*l,n[3]=.5*Math.log(t*t+r*r+i*i+a*a),n}function lG(n,e,t){return tE(n,e),rE(n,n,t),eE(n,n),n}function qf(n,e,t,r){var i=e[0],a=e[1],o=e[2],l=e[3],c=t[0],d=t[1],p=t[2],h=t[3],g,v,b,x,C;return v=i*c+a*d+o*p+l*h,v<0&&(v=-v,c=-c,d=-d,p=-p,h=-h),1-v>Je?(g=Math.acos(v),b=Math.sin(g),x=Math.sin((1-r)*g)/b,C=Math.sin(r*g)/b):(x=1-r,C=r),n[0]=x*i+C*c,n[1]=x*a+C*d,n[2]=x*o+C*p,n[3]=x*l+C*h,n}function cG(n){var e=Ar(),t=Ar(),r=Ar(),i=Math.sqrt(1-e),a=Math.sqrt(e);return n[0]=i*Math.sin(2*Math.PI*t),n[1]=i*Math.cos(2*Math.PI*t),n[2]=a*Math.sin(2*Math.PI*r),n[3]=a*Math.cos(2*Math.PI*r),n}function uG(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=t*t+r*r+i*i+a*a,l=o?1/o:0;return n[0]=-t*l,n[1]=-r*l,n[2]=-i*l,n[3]=a*l,n}function dG(n,e){return n[0]=-e[0],n[1]=-e[1],n[2]=-e[2],n[3]=e[3],n}function nE(n,e){var t=e[0]+e[4]+e[8],r;if(t>0)r=Math.sqrt(t+1),n[3]=.5*r,r=.5/r,n[0]=(e[5]-e[7])*r,n[1]=(e[6]-e[2])*r,n[2]=(e[1]-e[3])*r;else{var i=0;e[4]>e[0]&&(i=1),e[8]>e[i*3+i]&&(i=2);var a=(i+1)%3,o=(i+2)%3;r=Math.sqrt(e[i*3+i]-e[a*3+a]-e[o*3+o]+1),n[i]=.5*r,r=.5/r,n[3]=(e[a*3+o]-e[o*3+a])*r,n[a]=(e[a*3+i]+e[i*3+a])*r,n[o]=(e[o*3+i]+e[i*3+o])*r}return n}function pG(n,e,t,r){var i=.5*Math.PI/180;e*=i,t*=i,r*=i;var a=Math.sin(e),o=Math.cos(e),l=Math.sin(t),c=Math.cos(t),d=Math.sin(r),p=Math.cos(r);return n[0]=a*c*p-o*l*d,n[1]=o*l*p+a*c*d,n[2]=o*c*d-a*l*p,n[3]=o*c*p+a*l*d,n}function fG(n){return"quat("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+")"}var hG=Ev,mG=Dv,gG=Pv,yG=Iv,vG=Av,SG=Zk,rE=Mv,iE=_v,bG=Vv,aE=jf,xG=aE,oE=Jf,CG=oE,Fv=Rv,wG=Ov,TG=Nv,LG=function(){var n=Hf(),e=xc(1,0,0),t=xc(0,1,0);return function(r,i,a){var o=$f(i,a);return o<-.999999?(md(n,e,i),kv(n)<1e-6&&md(n,t,i),hd(n,n),Qk(r,n,Math.PI),r):o>.999999?(r[0]=0,r[1]=0,r[2]=0,r[3]=1,r):(md(n,i,a),r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=1+o,Fv(r,r))}}(),kG=function(){var n=Bv(),e=Bv();return function(t,r,i,a,o,l){return qf(n,r,o,l),qf(e,i,a,l),qf(t,n,e,2*l*(1-l)),t}}(),EG=function(){var n=Lv();return function(e,t,r,i){return n[0]=r[0],n[3]=r[1],n[6]=r[2],n[1]=i[0],n[4]=i[1],n[7]=i[2],n[2]=-t[0],n[5]=-t[1],n[8]=-t[2],Fv(e,nE(e,n))}}();var hr={};vc(hr,{add:()=>MG,angle:()=>QG,ceil:()=>RG,clone:()=>DG,copy:()=>IG,create:()=>sE,cross:()=>HG,dist:()=>sW,distance:()=>dE,div:()=>oW,divide:()=>uE,dot:()=>zG,equals:()=>nW,exactEquals:()=>tW,floor:()=>_G,forEach:()=>uW,fromValues:()=>PG,inverse:()=>GG,len:()=>rW,length:()=>fE,lerp:()=>$G,max:()=>OG,min:()=>VG,mul:()=>aW,multiply:()=>cE,negate:()=>UG,normalize:()=>WG,random:()=>jG,rotate:()=>XG,round:()=>NG,scale:()=>BG,scaleAndAdd:()=>FG,set:()=>AG,sqrDist:()=>lW,sqrLen:()=>cW,squaredDistance:()=>pE,squaredLength:()=>hE,str:()=>eW,sub:()=>iW,subtract:()=>lE,transformMat2:()=>JG,transformMat2d:()=>qG,transformMat3:()=>YG,transformMat4:()=>KG,zero:()=>ZG});function sE(){var n=new Ct(2);return Ct!=Float32Array&&(n[0]=0,n[1]=0),n}function DG(n){var e=new Ct(2);return e[0]=n[0],e[1]=n[1],e}function PG(n,e){var t=new Ct(2);return t[0]=n,t[1]=e,t}function IG(n,e){return n[0]=e[0],n[1]=e[1],n}function AG(n,e,t){return n[0]=e,n[1]=t,n}function MG(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n}function lE(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n}function cE(n,e,t){return n[0]=e[0]*t[0],n[1]=e[1]*t[1],n}function uE(n,e,t){return n[0]=e[0]/t[0],n[1]=e[1]/t[1],n}function RG(n,e){return n[0]=Math.ceil(e[0]),n[1]=Math.ceil(e[1]),n}function _G(n,e){return n[0]=Math.floor(e[0]),n[1]=Math.floor(e[1]),n}function VG(n,e,t){return n[0]=Math.min(e[0],t[0]),n[1]=Math.min(e[1],t[1]),n}function OG(n,e,t){return n[0]=Math.max(e[0],t[0]),n[1]=Math.max(e[1],t[1]),n}function NG(n,e){return n[0]=Math.round(e[0]),n[1]=Math.round(e[1]),n}function BG(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n}function FG(n,e,t,r){return n[0]=e[0]+t[0]*r,n[1]=e[1]+t[1]*r,n}function dE(n,e){var t=e[0]-n[0],r=e[1]-n[1];return Math.hypot(t,r)}function pE(n,e){var t=e[0]-n[0],r=e[1]-n[1];return t*t+r*r}function fE(n){var e=n[0],t=n[1];return Math.hypot(e,t)}function hE(n){var e=n[0],t=n[1];return e*e+t*t}function UG(n,e){return n[0]=-e[0],n[1]=-e[1],n}function GG(n,e){return n[0]=1/e[0],n[1]=1/e[1],n}function WG(n,e){var t=e[0],r=e[1],i=t*t+r*r;return i>0&&(i=1/Math.sqrt(i)),n[0]=e[0]*i,n[1]=e[1]*i,n}function zG(n,e){return n[0]*e[0]+n[1]*e[1]}function HG(n,e,t){var r=e[0]*t[1]-e[1]*t[0];return n[0]=n[1]=0,n[2]=r,n}function $G(n,e,t,r){var i=e[0],a=e[1];return n[0]=i+r*(t[0]-i),n[1]=a+r*(t[1]-a),n}function jG(n,e){e=e||1;var t=Ar()*2*Math.PI;return n[0]=Math.cos(t)*e,n[1]=Math.sin(t)*e,n}function JG(n,e,t){var r=e[0],i=e[1];return n[0]=t[0]*r+t[2]*i,n[1]=t[1]*r+t[3]*i,n}function qG(n,e,t){var r=e[0],i=e[1];return n[0]=t[0]*r+t[2]*i+t[4],n[1]=t[1]*r+t[3]*i+t[5],n}function YG(n,e,t){var r=e[0],i=e[1];return n[0]=t[0]*r+t[3]*i+t[6],n[1]=t[1]*r+t[4]*i+t[7],n}function KG(n,e,t){var r=e[0],i=e[1];return n[0]=t[0]*r+t[4]*i+t[12],n[1]=t[1]*r+t[5]*i+t[13],n}function XG(n,e,t,r){var i=e[0]-t[0],a=e[1]-t[1],o=Math.sin(r),l=Math.cos(r);return n[0]=i*l-a*o+t[0],n[1]=i*o+a*l+t[1],n}function QG(n,e){var t=n[0],r=n[1],i=e[0],a=e[1],o=t*t+r*r;o>0&&(o=1/Math.sqrt(o));var l=i*i+a*a;l>0&&(l=1/Math.sqrt(l));var c=(t*i+r*a)*o*l;return c>1?0:c<-1?Math.PI:Math.acos(c)}function ZG(n){return n[0]=0,n[1]=0,n}function eW(n){return"vec2("+n[0]+", "+n[1]+")"}function tW(n,e){return n[0]===e[0]&&n[1]===e[1]}function nW(n,e){var t=n[0],r=n[1],i=e[0],a=e[1];return Math.abs(t-i)<=Je*Math.max(1,Math.abs(t),Math.abs(i))&&Math.abs(r-a)<=Je*Math.max(1,Math.abs(r),Math.abs(a))}var rW=fE,iW=lE,aW=cE,oW=uE,sW=dE,lW=pE,cW=hE,uW=function(){var n=sE();return function(e,t,r,i,a,o){var l,c;for(t||(t=2),r||(r=0),i?c=Math.min(i*t+r,e.length):c=e.length,l=r;l<c;l+=t)n[0]=e[l],n[1]=e[l+1],a(n,n,o),e[l]=n[0],e[l+1]=n[1];return e}}();var Yf=oe.create(),mE=["x","y","z"],$r=[K.fromValues(1,0,0),K.fromValues(0,1,0),K.fromValues(0,0,1)],T8=K.fromValues(0,0,0),gd=an.fromValues(0,0,0,0),Kf=K.fromValues(1,1,1),L8=K.fromValues(Infinity,Infinity,Infinity),k8=Qe.create();function yd(n){return n[0]*n[1]*n[2]}function No(n){return`${n[0]},${n[1]},${n[2]}`}function gE(n,e,t){let r=e[0],i=e[1],a=e[2];return n[0]=t[0]*r+t[4]*i+t[8]*a,n[1]=t[1]*r+t[5]*i+t[9]*a,n[2]=t[2]*r+t[6]*i+t[10]*a,n}function Xf(n,e,t){let r=e[0],i=e[1],a=e[2];return n[0]=t[0]*r+t[1]*i+t[2]*a,n[1]=t[4]*r+t[5]*i+t[6]*a,n[2]=t[8]*r+t[9]*i+t[10]*a,n}function dW(n,e,t){let r=t.length,i=0;for(let o=0;o<r;++o)i+=(n[o]-e[o])**2;let a=0;for(let o=0;o<r;++o){let l=n[o];a-=(l-t[o])*(e[o]-l)}return a/Math.max(i,1e-6)}function yE(n,e,t,r){let i=n.length,a=dW(e,t,r);a=Math.max(0,Math.min(1,a));for(let o=0;o<i;++o){let l=e[o];n[o]=l+a*(t[o]-l)}return n}function Hs(n,e){let t=e[0],r=e[1],i=e[2],a=e[4],o=e[5],l=e[6],c=e[8],d=e[9],p=e[10];return n[0]=t,n[1]=r,n[2]=i,n[3]=a,n[4]=o,n[5]=l,n[6]=c,n[7]=d,n[8]=p,n}function $s(n,e){let t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8],h=e[9],g=e[10],v=e[11],b=e[12],x=e[13],C=e[14],T=e[15];n[0]=a+t,n[1]=d+o,n[2]=v+p,n[3]=T+b,n[4]=a-t,n[5]=d-o,n[6]=v-p,n[7]=T-b,n[8]=a+r,n[9]=d+l,n[10]=v+h,n[11]=T+x,n[12]=a-r,n[13]=d-l,n[14]=v-h,n[15]=T-x;let P=a+i,I=d+c,M=v+g,D=T+C,E=a-i,V=d-c,O=v-g,B=T-C,z=Math.sqrt(P**2+I**2+M**2);n[16]=P/z,n[17]=I/z,n[18]=M/z,n[19]=D/z;let _=Math.sqrt(E**2+V**2+O**2);return n[20]=E/_,n[21]=V/_,n[22]=O/_,n[23]=B/_,n}function Qf(n,e,t,r,i,a,o){for(let l=0;l<6;++l){let c=o[l*4],d=o[l*4+1],p=o[l*4+2],h=o[l*4+3];if(Math.max(c*n,c*r)+Math.max(d*e,d*i)+Math.max(p*t,p*a)+h<0)return!1}return!0}function vE(n,e,t,r,i,a,o){for(let l=0;l<4;++l){let c=o[l*4],d=o[l*4+1],p=o[l*4+2],h=o[l*4+3];if(Math.max(c*n,c*r)+Math.max(d*e,d*i)+Math.max(p*t,p*a)+h<0)return!1}{let l=5,c=o[l*4],d=o[l*4+1],p=o[l*4+2],h=o[l*4+3],g=Math.max(c*n,c*r)+Math.max(d*e,d*i)+Math.max(p*t,p*a),v=Math.min(c*n,c*r)+Math.min(d*e,d*i)+Math.min(p*t,p*a),b=Math.abs(h)*1e-6;if(v>-h+b||g<-h-b)return!1}return!0}function js(n,e,t,r=!1){let i=t.length,a=[],o=r?1:e+1,l=r?e+1:1;for(let c=0;c<i;++c){let d=t[c];for(let p=0;p<e;++p)n[p*o+d*l]!==0&&(a[p]=!0)}return jL(a,!0)}function Uv(n,e,t){for(let r=0;r<3;++r){let i=t[r];for(let a=0;a<3;++a)n[r+a*3]=i*e[r+a*3]}return n}function SE(n){if(n[15]===1){let o=2/Math.abs(n[10]),l=2/Math.abs(n[0]),c=2/Math.abs(n[5]);return l*c*o}let e=n[10],t=n[14],r=2*t/(2*e-2),i=(e-1)*r/(e+1);return 4/(n[0]*n[5])/3*(Math.abs(i)**3-Math.abs(r)**3)}function Zf(n){if(n[15]===1)return 2/Math.abs(n[10]);let e=n[10],t=n[14],r=2*t/(2*e-2),i=(e-1)*r/(e+1);return Math.abs(i-r)}function bE(n){return n[2]=0,n[6]=0,n[10]=0,n[14]=0,n}var Cc=K.create();function xE(n,e){e[0]=e[1]=e[2]=Number.POSITIVE_INFINITY,e[3]=e[4]=e[5]=Number.NEGATIVE_INFINITY;for(let t=0;t<8;++t){Cc[0]=2*(t&1)-1,Cc[1]=2*(t>>>1&1)-1,Cc[2]=2*(t>>>2&1)-1,K.transformMat4(Cc,Cc,n);for(let r=0;r<3;++r){let i=Cc[r];e[r]=Math.min(e[r],i),e[r+3]=Math.max(e[r+3],i)}}}function Gv(n){return("0"+n.toString(16)).slice(-2)}function CE(n){return Array.prototype.map.call(n,Gv).join("")}function wE(n){if(!/^(?:[0-9a-fA-F]{2})*$/.test(n))throw new Error("Invalid hex-encoded string");let e=n.length/2,t=new Uint8Array(e);for(let r=0;r<e;++r)t[r]=parseInt(n.substr(r*2,2),16);return t}function pW(n){let e=/^rgba\(([0-9]+), ([0-9]+), ([0-9]+), (0(?:\.[0-9]+)?)\)$/;{let r=n.match(e);if(r!==null)return[parseInt(r[1],10),parseInt(r[2],10),parseInt(r[3],10),parseFloat(r[4])]}let t=/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/;{let r=n.match(t);if(r!==null)return[parseInt(r[1],16),parseInt(r[2],16),parseInt(r[3],16),1]}throw new Error(`Invalid serialized color: ${JSON.stringify(n)}.`)}function Wv(n){try{if(typeof n!="string")throw new Error(`Expected string, but received ${JSON.stringify(n)}.`);let e=document.createElement("canvas").getContext("2d");e.fillStyle=n;let t=pW(e.fillStyle);return an.fromValues(t[0]/255,t[1]/255,t[2]/255,t[3])}catch(e){throw new Error(`Failed to parse color specification: ${e.message}`)}}function fa(n){return Wv(n).subarray(0,3)}function Ja(n){let e=n[3]===void 0?3:4,t=0;for(let r=0;r<e;r++)t=(t<<8>>>0)+Math.min(255,Math.max(0,Math.round(n[e-1-r]*255)));return t}function qa(n){return K.fromValues((n>>>0&255)/255,(n>>>8&255)/255,(n>>>16&255)/255)}function vd(n){return an.fromValues((n>>>0&255)/255,(n>>>8&255)/255,(n>>>16&255)/255,(n>>>24&255)/255)}function Sn(n){if(n[3]===void 0||n[3]===1){let e="#";for(let t=0;t<3;++t)e+=Gv(Math.min(255,Math.max(0,Math.round(n[t]*255))));return e}else{let e="rgba(";for(let t=0;t<3;++t)t!==0&&(e+=", "),e+=Math.min(255,Math.max(0,Math.round(n[t]*255)));return e+=`, ${Ak(n[3])})`,e}}function zv(n){return n<=.03928?n/12.92:((n+.055)/1.055)**2.4}function fW(n){let[e,t,r]=n;return .2126*zv(e)+.7152*zv(t)+.0722*zv(r)}function Sd(n){return fW(n)<=.179}var Bo=class extends ke{constructor(e){super(K.clone(e));this.defaultValue=e}toString(){return Sn(this.value)}toJSON(){if(!K.equals(this.value,this.defaultValue))return Sn(this.value)}reset(){this.value=K.clone(this.defaultValue)}restoreState(e){if(e===void 0){this.reset();return}let{value:t}=this,r=fa(e);K.equals(t,r)||(this.value=r)}},Hv=class extends ke{constructor(){super(void 0)}toJSON(){let{value:e}=this;if(e!==void 0)return Sn(e)}reset(){this.value=void 0}restoreState(e){if(e===void 0){this.reset();return}let{value:t}=this,r=fa(e);(t===void 0||!K.equals(t,r))&&(this.value=r)}};var W;(function(c){c[c.UINT8=0]="UINT8",c[c.INT8=1]="INT8",c[c.UINT16=2]="UINT16",c[c.INT16=3]="INT16",c[c.UINT32=4]="UINT32",c[c.INT32=5]="INT32",c[c.UINT64=6]="UINT64",c[c.FLOAT32=7]="FLOAT32"})(W||(W={}));var wc={[0]:!1,[1]:!0,[2]:!1,[3]:!0,[4]:!1,[5]:!0,[6]:!1,[7]:void 0},eh={[0]:1,[1]:1,[2]:2,[3]:2,[4]:4,[5]:4,[6]:8,[7]:4},th={[0]:Uint8Array,[1]:Int8Array,[2]:Uint16Array,[3]:Int16Array,[4]:Uint32Array,[5]:Int32Array,[6]:Uint32Array,[7]:Float32Array},TE={[0]:1,[1]:1,[2]:1,[3]:1,[4]:1,[5]:1,[6]:2,[7]:1};var nn;(function(t){t[t.LITTLE=0]="LITTLE",t[t.BIG=1]="BIG"})(nn||(nn={}));function hW(){let n=Uint16Array.of(4386);return new Uint8Array(n.buffer)[0]===17?1:0}var Pi=hW();function mW(n){let e=new Uint8Array(n.buffer,n.byteOffset,n.byteLength);for(let t=0,r=e.length;t<r;t+=4){let i=e[t];e[t]=e[t+3],e[t+3]=i,i=e[t+1],e[t+1]=e[t+2],e[t+2]=i}}function LE(n,e,t=Pi){e!==t&&mW(n)}function bn(n){let e=typeof n;if(e==="number"||e==="string"){let t=parseFloat(""+n);if(!Number.isNaN(t))return t}throw new Error(`Expected floating-point number, but received: ${JSON.stringify(n)}.`)}function Ke(n){let e=bn(n);if(Number.isFinite(e))return e;throw new Error(`Expected finite floating-point number, but received: ${e}.`)}function nh(n){let e=bn(n);if(Number.isFinite(e)&&e>=0)return e;throw new Error(`Expected finite non-negative floating-point number, but received: ${e}.`)}function ot(n){let e=Ke(n);if(e>0)return e;throw new Error(`Expected positive finite floating-point number, but received: ${e}.`)}function bd(n,e,t=bn){Q(e),n[0]=n[1]=n[2]=0;for(let r of Object.keys(e))switch(r){case"x":n[0]=t(e[r]);break;case"y":n[1]=t(e[r]);break;case"z":n[2]=t(e[r]);break;default:throw new Error(`Expected object to have keys ['x', 'y', 'z'], but received: ${JSON.stringify(e)}.`)}return n}function Tc(n,e){let t=n.length;if(!Array.isArray(e)||e.length!==t)throw new Error("Incompatible sizes");for(let r=0;r<t;++r)if(!Number.isFinite(parseFloat(e[r])))throw new Error("Non-finite value.");for(let r=0;r<t;++r)n[r]=parseFloat(e[r]);return n}function $v(n,e){let t=n.length;if(!Array.isArray(e)||e.length!==t)throw new Error("Incompatible sizes.");for(let r=0;r<t;++r){let i=parseInt(e[r],void 0);if(!Number.isInteger(i))throw new Error("Non-integer value.")}for(let r=0;r<t;++r)n[r]=parseInt(e[r],void 0);return n}function xn(n){if(typeof n=="object"){if(n===null)return"null";if(Array.isArray(n)){let a="[",o=n.length,l=0;if(l<o)for(a+=xn(n[l]);++l<o;)a+=",",a+=xn(n[l]);return a+="]",a}let e="{",t=Object.keys(n).sort(),r=0,i=t.length;if(r<i){let a=t[r];for(e+=JSON.stringify(a),e+=":",e+=xn(n[a]);++r<i;)e+=",",a=t[r],e+=JSON.stringify(a),e+=":",e+=xn(n[a])}return e+="}",e}return JSON.stringify(n)}var kE=/('(?:[^'\\]|(?:\\.))*')/,EE=/("(?:[^"\\]|(?:\\.))*")/,gW=new RegExp(`${kE.source}|${EE.source}`),yW=new RegExp(`${EE.source}|${kE.source}`),vW=/^((?:[^"'\\]|(?:\\[^']))*)("|\\')/,SW=/^((?:[^"'\\]|(?:\\.))*)'/;function bW(n,e,t,r){if(n.length>=2&&n.charAt(0)===e&&n.charAt(n.length-1)===e){let i=n.substr(1,n.length-2),a=t;for(;i.length>0;){let o=i.match(r);if(o===null){a+=i;break}a+=o[1],o[2]===t?(a+="\\",a+=t):a+=e,i=i.substr(o.index+o[0].length)}return a+=t,a}return n}function xW(n,e,t){let r=/[&_,]/g,i,a,o;t==='"'?(i="'",a=vW,o=gW):(i='"',a=SW,o=yW);let l="";for(;n.length>0;){let c=n.match(o),d,p;if(c===null)d=n,n="",p="";else{d=n.substr(0,c.index),n=n.substr(c.index+c[0].length);let h=c[1];h!==void 0?p=bW(h,i,t,a):p=c[2]}l+=d.replace(r,e),l+=p}return l}function CW(n){return xW(n,",",'"')}function rh(n){return JSON.parse(CW(n))}function jr(n,e){if(!Array.isArray(n))throw new Error(`Expected array, but received: ${JSON.stringify(n)}.`);if(e!==void 0&&n.length!==e)throw new Error(`Expected array of length ${e}, but received: ${JSON.stringify(n)}.`);return n}function ge(n,e){if(!Array.isArray(n))throw new Error(`Expected array, but received: ${JSON.stringify(n)}.`);return n.map(e)}function Pe(n,e,t){let r=n.length;if(!Array.isArray(e)||e.length!==r)throw new Error(`Expected length ${r} array, but received: ${JSON.stringify(e)}.`);for(let i=0;i<r;++i)n[i]=t(e[i],i);return n}function Q(n){if(typeof n!="object"||n==null||Array.isArray(n))throw new Error(`Expected JSON object, but received: ${JSON.stringify(n)}.`);return n}function ze(n){let e=parseInt(n,10);if(!Number.isInteger(e))throw new Error(`Expected integer, but received: ${JSON.stringify(n)}.`);return e}function ct(n){let e=ze(n);if(e<=0)throw new Error(`Expected positive integer, but received: ${e}.`);return e}function DE(n){let e=ze(n);if(e<0)throw new Error(`Expected non-negative integer, but received: ${e}.`);return e}function ih(n,e){let t=e.get(n);if(t===void 0)throw new Error(`Expected one of ${JSON.stringify(Array.from(e.keys()))}, but received: ${JSON.stringify(n)}.`);return t}function Z(n){if(typeof n!="string")throw new Error(`Expected string, but received: ${JSON.stringify(n)}.`);return n}function Vt(n){if(n!==void 0)return Z(n)}function oi(n){if(n!==void 0)return ze(n)}function PE(n){if(n!==void 0){if(typeof n=="boolean")return n;if(n==="true")return!0;if(n==="false")return!1;throw new Error(`Expected string or boolean but received: ${JSON.stringify(n)}`)}}function U(n,e,t){let r=Object.prototype.hasOwnProperty.call(n,e)?n[e]:void 0;try{return t(r)}catch(i){throw new Error(`Error parsing ${JSON.stringify(e)} property: ${i.message}`)}}function ie(n,e,t,r){return U(n,e,i=>i===void 0?r:t(i))}function Ii(n,e){Q(n);let t=new Map;for(let r of Object.keys(n))try{t.set(r,e(n[r]))}catch(i){throw new Error(`Error parsing value associated with key ${JSON.stringify(r)}: ${i.message}`)}return t}function ah(n){if(typeof n!="number"||!Number.isFinite(n)||n<0||n>1)throw new Error(`Expected floating point number in [0,1], but received: ${JSON.stringify(n)}.`);return n}function si(n){if(n==="")return{};if(n.startsWith("{"))return rh(n);{let e={},t=n.split(/[&;]/);for(let r of t){let i=r.match(/^([^=&;]+)=([^&;]*)$/);if(i===null)throw new Error(`Invalid query string part: ${JSON.stringify(r)}.`);e[i[1]]=decodeURIComponent(i[2])}return e}}function IE(n){if(n===void 0)return"";let e=Object.keys(n);return e.length===0?"":e.some(t=>typeof n[t]!="string")?JSON.stringify(n):e.map(t=>`${encodeURIComponent(t)}=${encodeURIComponent(n[t])}`).join("&")}function yt(n,e){if(typeof n=="string"&&n.match(/^[a-zA-Z]/)!==null&&(n=n.toUpperCase(),e.hasOwnProperty(n)))return e[n];throw new Error(`Invalid enum value: ${JSON.stringify(n)}.`)}function oh(n){return Pe(K.create(),n,Ke)}function AE(n){return Pe(K.create(),n,ot)}function ME(n){return Pe(K.create(),n,ct)}function on(n){if(!Array.isArray(n))throw new Error(`Expected array, received: ${JSON.stringify(n)}.`);for(let e of n)if(typeof e!="string")throw new Error(`Expected string, received: ${JSON.stringify(e)}.`);return n}function RE(n){if(!Array.isArray(n))throw new Error(`Expected array, received: ${JSON.stringify(n)}.`);for(let e of n)if(!Number.isInteger(e))throw new Error(`Expected integer, received: ${JSON.stringify(e)}.`);return n}function ha(n){if(typeof n!="boolean")throw new Error(`Expected boolean, received: ${JSON.stringify(n)}`);return n}function Ai(n){for(let e in n)return n}var _E=2**-1074,jv=new Float64Array(1),Fo=new Uint32Array(jv.buffer);function VE(n,e){if(isNaN(n)||isNaN(e))return NaN;if(n===e)return e;if(n===0)return e<0?-_E:_E;jv[0]=n;let t=Pi===nn.LITTLE?0:1,r=1-t;return e>n==n>0?Fo[t]===4294967295?(Fo[t]=0,Fo[r]+=1):Fo[t]+=1:Fo[t]===0?(Fo[t]=4294967295,Fo[r]-=1):Fo[t]-=1,jv[0]}var Jv=new Uint32Array(2),xd=4294967296,qv=[];for(let n=2;n<=36;++n){let e=Math.floor(32/Math.log2(n)),t=Math.pow(n,e),r=`^[0-${String.fromCharCode("0".charCodeAt(0)+Math.min(9,n-1))}`;n>10&&(r+=`a-${String.fromCharCode("a".charCodeAt(0)+n-11)}`,r+=`A-${String.fromCharCode("A".charCodeAt(0)+n-11)}`),r+=`]{1,${Math.ceil(64/Math.log2(n))}}$`;let a=new RegExp(r);qv[n]={lowDigits:e,lowBase:t,pattern:a}}function OE(n,e){n>>>=0,e>>>=0;let t=n&65535,r=n>>>16,i=e&65535,a=e>>>16,l=(t*i>>>16)+r*i,c=l>>>16;l=(l&65535)+t*a,c+=l>>>16;let d=c>>>16;return c=(c&65535)+r*a,d+=c>>>16,((d&65535)<<16|c&65535)>>>0}var Jr=class{constructor(e=0,t=0){this.low=e;this.high=t}clone(){return new Jr(this.low,this.high)}assign(e){this.low=e.low,this.high=e.high}toString(e=10){let t=this.low,r=this.high;if(r===0)return t.toString(e);r*=xd;let{lowBase:i,lowDigits:a}=qv[e],o=r%i;r=Math.floor(r/i),t+=o,r+=Math.floor(t/i),t=t%i;let l=t.toString(e);return r.toString(e)+"0".repeat(a-l.length)+l}static less(e,t){return e.high<t.high||e.high===t.high&&e.low<t.low}static compare(e,t){return e.high-t.high||e.low-t.low}static equal(e,t){return e.low===t.low&&e.high===t.high}static min(e,t){return Jr.less(e,t)?e:t}static max(e,t){return Jr.less(e,t)?t:e}static random(){return crypto.getRandomValues(Jv),new Jr(Jv[0],Jv[1])}tryParseString(e,t=10){let{lowDigits:r,lowBase:i,pattern:a}=qv[t];if(!a.test(e))return!1;if(e.length<=r)return this.low=parseInt(e,t),this.high=0,!0;let o=e.length-r,l=parseInt(e.substr(o),t),c=parseInt(e.substr(0,o),t),d,p;if(i===xd)d=c,p=l;else{let h=Math.imul(c,i)>>>0;d=OE(c,i)+(Math.imul(Math.floor(c/xd),i)>>>0),p=l+h,p>=xd&&(++d,p-=xd)}return p>>>0!==p||d>>>0!==d?!1:(this.low=p,this.high=d,!0)}parseString(e,t=10){if(!this.tryParseString(e,t))throw new Error(`Failed to parse string as uint64 value: ${JSON.stringify(e)}.`);return this}static parseString(e,t=10){return new Jr().parseString(e,t)}valid(){let{low:e,high:t}=this;return e>>>0===e&&t>>>0===t}toJSON(){return this.toString()}static lshift(e,t,r){let{low:i,high:a}=t;return r===0?(e.low=i,e.high=a):r<32?(e.low=i<<r,e.high=a<<r|i>>>32-r):(e.low=0,e.high=i<<r-32),e}static rshift(e,t,r){let{low:i,high:a}=t;return r===0?(e.low=i,e.high=a):r<32?(e.low=i>>>r|a<<32-r,e.high=a>>>r):(e.low=a>>>r-32,e.high=0),e}static or(e,t,r){return e.low=t.low|r.low,e.high=t.high|r.high,e}static xor(e,t,r){return e.low=t.low^r.low,e.high=t.high^r.high,e}static and(e,t,r){return e.low=t.low&r.low,e.high=t.high&r.high,e}static add(e,t,r){let i=t.low+r.low,a=t.high+r.high,o=i>>>0;return o!==i&&(a+=1),e.low=o,e.high=a>>>0,e}static addUint32(e,t,r){let i=t.low+r,a=t.high,o=i>>>0;return o!==i&&(a+=1),e.low=o,e.high=a>>>0,e}static decrement(e,t){let{low:r,high:i}=t;return r===0&&(i-=1),e.low=r-1>>>0,e.high=i>>>0,e}static increment(e,t){let{low:r,high:i}=t;return r===4294967295&&(i+=1),e.low=r+1>>>0,e.high=i>>>0,e}static subtract(e,t,r){let i=t.low-r.low,a=t.high-r.high,o=i>>>0;return o!==i&&(a-=1),e.low=o,e.high=a>>>0,e}static absDifference(e,t,r){return Jr.less(t,r)?Jr.subtract(e,r,t):Jr.subtract(e,t,r)}static multiplyUint32(e,t,r){let{low:i,high:a}=t;return e.low=Math.imul(i,r)>>>0,e.high=Math.imul(a,r)+OE(i,r)>>>0,e}static lowMask(e,t){return t===0?e.high=e.low=0:t<=32?(e.high=0,e.low=4294967295>>>32-t):(e.high=4294967295>>>t-32,e.low=4294967295),e}toNumber(){return this.low+this.high*4294967296}setFromNumber(e){e=Math.round(e),e<0?this.low=this.high=0:e>=18446744073709552e3?this.low=this.high=4294967295:(this.low=e%4294967296,this.high=Math.floor(e/4294967296))}static fromNumber(e){let t=new Jr;return t.setFromNumber(e),t}},X=Jr;X.ZERO=new Jr(0,0),X.ONE=new Jr(1,0);var qr={[W.UINT8]:[0,255],[W.INT8]:[-128,127],[W.UINT16]:[0,65535],[W.INT16]:[-32768,32767],[W.UINT32]:[0,4294967295],[W.INT32]:[-2147483648,2147483647],[W.UINT64]:[X.ZERO,new X(4294967295,4294967295)],[W.FLOAT32]:[0,1]};function Mr(n,e){if(typeof e=="number"){let t=n[0],r=n[1];return(e-t)/(r-t)}else{let t=n[0],r=n[1],i;X.compare(e,t)<0?i=-X.subtract(Yr,t,e).toNumber():i=X.subtract(Yr,e,t).toNumber();let a=X.absDifference(Yr,r,t).toNumber();return X.compare(t,r)>0&&(a*=-1),i/a}}function ma(n,e,t){if(typeof n[0]=="number"){let r=n[0],i=n[1],a=r*(1-t)+i*t;if(e!==W.FLOAT32){let o=qr[e];a=Math.round(a),a=Math.max(o[0],a),a=Math.min(o[1],a)}return a}else{let r=n[0],i=n[1];X.compare(r,i)>0&&([r,i]=[i,r],t=1-t);let a=X.subtract(Yr,i,r).toNumber(),o=new X;return t<=0?(Yr.setFromNumber(a*-t),X.subtract(o,r,X.min(Yr,r))):t>=1?(Yr.setFromNumber(a*(t-1)),X.add(o,i,Yr),X.less(o,i)&&(o.low=o.high=4294967295)):(Yr.setFromNumber(a*t),X.add(o,r,Yr),X.less(o,r)&&(o.low=o.high=4294967295)),o}}function Js(n,e){return typeof e=="number"?Math.min(Math.max(n[0],e),n[1]):X.min(X.max(n[0],e),n[1])}function qs(n,e){return[Js(n,e[0]),Js(n,e[1])]}function sh(n){if(mr(n[0],n[1])<=0)return n;throw new Error(`Invalid interval: [${n[0]}, ${n[1]}]`)}function lh(n){return mr(n[0],n[1])<=0?n:[n[1],n[0]]}function mr(n,e){return typeof n=="number"?n-e:X.compare(n,e)}var Yr=new X,wW=new X;function NE(n,e){return typeof e=="number"?Math.abs(e-n[0])<Math.abs(e-n[1])?0:1:X.less(X.absDifference(Yr,n[0],e),X.absDifference(wW,n[1],e))?0:1}function Ya(n,e){let t;switch(typeof e!="string"?t=""+e:t=e,n){case W.UINT64:return X.parseString(t);case W.FLOAT32:{let r=parseFloat(t);if(!Number.isFinite(r))throw new Error(`Invalid float32 value: ${JSON.stringify(t)}`);return r}default:{let r=parseInt(t),i=qr[n];if(!Number.isInteger(r)||r<i[0]||r>i[1])throw new Error(`Invalid ${W[n].toLowerCase()} value: ${JSON.stringify(t)}`);return r}}}function TW(n){if(typeof n=="number")return n;if(typeof n=="string"){let e=new X,t=Number(n);if(e.tryParseString(n))return t.toString()===e.toString()?t:e;if(!Number.isFinite(t))throw new Error(`Invalid value: ${JSON.stringify(n)}`);return t}throw new Error(`Invalid value: ${JSON.stringify(n)}`)}function Ys(n,e){return Pe(new Array(2),n,t=>Ya(e,t))}function Yv(n){return Pe(new Array(2),n,e=>TW(e))}function li(n,e,t){return n===W.UINT64?X.equal(e[0],t[0])&&X.equal(e[1],t[1]):e[0]===t[0]&&e[1]===t[1]}function Cd(n,e,t=qr[e]){if(!li(e,n,t))return e===W.UINT64?[n[0].toString(),n[1].toString()]:n}function wd(n,e,t){switch(n){case W.FLOAT32:return VE(e,t*Infinity);case W.UINT64:let r=e;return t===-1?r.low===0&&r.high===0?r:X.decrement(new X,r):r.low===4294967295&&r.high===4294967295?r:X.increment(new X,r);default:{let i=qr[n];return Math.max(i[0],Math.min(i[1],e+t))}}}function BE(n,e){switch(n){case W.FLOAT32:return 0;case W.UINT64:return .5/X.absDifference(Yr,e[0],e[1]).toNumber();default:return .5/Math.abs(e[0]-e[1])}}function Lc(n,e){switch(n){case W.FLOAT32:return 1;case W.UINT64:{let t=X.absDifference(Yr,e[0],e[1]).toNumber();return t/(t+1)}default:{let t=Math.abs(e[0]-e[1]);return t/(t+1)}}}function kc(n,e){if(n===void 0)return qr[e];let[t,r]=n;if(e===W.UINT64)return typeof t=="number"&&(t=X.fromNumber(t)),typeof r=="number"&&(r=X.fromNumber(r)),[t,r];if(typeof t!="number"&&(t=t.toNumber()),typeof r!="number"&&(r=r.toNumber()),e!==W.FLOAT32){t=Math.round(t),r=Math.round(r);let i=qr[e];Number.isFinite(t)?t=Math.min(Math.max(i[0],t),i[1]):t=i[0],Number.isFinite(r)?r=Math.min(Math.max(i[0],r),i[1]):r=i[1]}return[t,r]}function Ks(n=128){let e=Math.ceil(n/32),t=new Uint32Array(e);crypto.getRandomValues(t);let r="";for(let i=0;i<e;++i)r+=("00000000"+t[i].toString(16)).slice(-8);return r}function FE(n){let e=new Uint8Array(n.buffer,n.byteOffset,n.byteLength),t=65536;for(let r=0,i=e.length;r<i;r+=t)crypto.getRandomValues(e.subarray(r,Math.min(i,r+t)));return n}function Kv(){let n=new Uint32Array(1);return crypto.getRandomValues(n),n[0]}var Td=class extends H{constructor(e){super();this.id=e;this.changed=new ne}},Be;(function(i){i[i.POINT=0]="POINT",i[i.LINE=1]="LINE",i[i.AXIS_ALIGNED_BOUNDING_BOX=2]="AXIS_ALIGNED_BOUNDING_BOX",i[i.ELLIPSOID=3]="ELLIPSOID"})(Be||(Be={}));var Mi=[0,1,2,3],Ld={float32:W.FLOAT32,uint32:W.UINT32,int32:W.INT32,uint16:W.UINT16,int16:W.INT16,uint8:W.UINT8,int8:W.INT8,rgb:void 0,rgba:void 0},Uo={rgb:{serializedBytes(){return 3},alignment(){return 1},serializeCode(n,e){return`dv.setUint16(${e}, ${n}, true);dv.setUint8(${e} + 2, ${n} >>> 16);`},deserializeCode(n,e){return`${n} = dv.getUint16(${e}, true) | (dv.getUint8(${e} + 2) << 16);`},deserializeJson(n){return Ja(fa(n))},serializeJson(n){return Sn(qa(n))}},rgba:{serializedBytes(){return 4},alignment(){return 1},serializeCode(n,e){return`dv.setUint32(${e}, ${n}, true);`},deserializeCode(n,e){return`${n} = dv.getUint32(${e}, true);`},deserializeJson(n){return Ja(Wv(n))},serializeJson(n){return Sn(vd(n))}},float32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(n,e){return`dv.setFloat32(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getFloat32(${e}, isLittleEndian);`},deserializeJson(n){return bn(n)},serializeJson(n){return n}},uint32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(n,e){return`dv.setUint32(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getUint32(${e}, isLittleEndian);`},deserializeJson(n){return ze(n)},serializeJson(n){return n}},int32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(n,e){return`dv.setInt32(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getInt32(${e}, isLittleEndian);`},deserializeJson(n){return ze(n)},serializeJson(n){return n}},uint16:{serializedBytes(){return 2},alignment(){return 2},serializeCode(n,e){return`dv.setUint16(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getUint16(${e}, isLittleEndian);`},deserializeJson(n){return ze(n)},serializeJson(n){return n}},int16:{serializedBytes(){return 2},alignment(){return 2},serializeCode(n,e){return`dv.setInt16(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getInt16(${e}, isLittleEndian);`},deserializeJson(n){return ze(n)},serializeJson(n){return n}},uint8:{serializedBytes(){return 1},alignment(){return 1},serializeCode(n,e){return`dv.setUint8(${e}, ${n});`},deserializeCode(n,e){return`${n} = dv.getUint8(${e});`},deserializeJson(n){return ze(n)},serializeJson(n){return n}},int8:{serializedBytes(){return 2},alignment(){return 1},serializeCode(n,e){return`dv.setInt8(${e}, ${n});`},deserializeCode(n,e){return`${n} = dv.getInt8(${e});`},deserializeJson(n){return ze(n)},serializeJson(n){return n}}},LW=255;function Xv(n,e,t){let r=0,i=t.length,a=new Array(i),o=[];for(let g=0;g<i;++g)a[g]=g;let l=g=>Uo[t[g].type].alignment(n);a.sort((g,v)=>l(v)-l(g));let c=0,d=new Array(i),p=e,h=()=>{p+=(4-p%4)%4,r+=p,o[c]=p,p=0,++c};for(let g=0;g<i;++g){let v=a[g],b=t[v],x=Uo[b.type],C=x.serializedBytes(n),T=x.alignment(n),P=(T-p%T)%T,M=p+P+C;M+(4-M%4)%4<=LW?p+=P:h(),d[v]={offset:p,group:c},p+=C}return h(),{serializedBytes:r,offsets:d,propertyGroupBytes:o}}var ch=class{constructor(e,t,r){this.rank=e;this.firstGroupInitialOffset=t;this.propertySpecs=r;if(r.length===0){this.serializedBytes=t,this.serialize=this.deserialize=()=>{},this.propertyGroupBytes=[t];return}let{serializedBytes:i,offsets:a,propertyGroupBytes:o}=Xv(e,t,r);this.propertyGroupBytes=o;let l="let groupOffset0 = offset;";for(let h=1;h<o.length;++h)l+=`let groupOffset${h} = groupOffset${h-1} + ${o[h-1]}*annotationCount;`;for(let h=0;h<o.length;++h)l+=`groupOffset${h} += ${o[h]}*annotationIndex;`;let c=l,d=l,p=r.length;for(let h=0;h<p;++h){let{group:g,offset:v}=a[h],b=r[h],x=Uo[b.type],C=`properties[${h}]`,T=`groupOffset${g} + ${v}`;c+=x.serializeCode(C,T,e),d+=x.deserializeCode(C,T,e)}this.serializedBytes=i,this.serialize=new Function("dv","offset","annotationIndex","annotationCount","isLittleEndian","properties",c),this.deserialize=new Function("dv","offset","annotationIndex","annotationCount","isLittleEndian","properties",d)}};function uh(n,e){let t=[];for(let r of Mi){let i=Wn[r];t[r]=new ch(n,i.serializedBytes(n),e)}return t}function Qv(n,e){let t=n.type==="float32"?e.toPrecision(6):e.toString(),{enumValues:r,enumLabels:i}=n;if(r!==void 0){let a=r.indexOf(e);if(a!==-1)return`${i[a]} (${t})`}return t}function UE(n,e){switch(n.type){case"rgb":return Sn(qa(e));case"rgba":return Sn(vd(e));default:return Qv(n,e)}}function kW(n){let e=Z(n);if(e.match(/^[a-z][a-zA-Z0-9_]*$/)===null)throw new Error(`Invalid property identifier: ${JSON.stringify(n)}`);return e}function EW(n){if(Z(n),!Object.prototype.hasOwnProperty.call(Uo,n))throw new Error("Unsupported property type: $JSON.stringify(obj)}");return n}function DW(n){let e=new Set;for(let t of n){if(e.has(t.identifier))throw new Error(`Duplicate property identifier: ${t.identifier}`);e.add(t.identifier)}}function PW(n){Q(n);let e=U(n,"id",kW),t=U(n,"type",EW),r=ie(n,"description",Z),i=ie(n,"default",l=>Uo[t].deserializeJson(l),0),a,o;switch(t){case"rgb":case"rgba":break;default:{let l=W[t.toUpperCase()];a=ie(n,"enum_values",c=>ge(c,d=>Ya(l,d))),a!==void 0&&(o=U(n,"enum_labels",c=>Pe(new Array(a.length),c,Z)))}}return{type:t,identifier:e,description:r,default:i,enumValues:a,enumLabels:o}}function IW(n){let e=n.default;return{id:n.identifier,description:n.description,type:n.type,default:e===0?void 0:Uo[n.type].serializeJson(e)}}function GE(n){if(!(n===void 0||n.length===0))return n.map(IW)}function dh(n){if(n===void 0)return[];let e=ge(n,PW);return DW(e),e}function Zv(n,e,t,r,i){for(let a=0;a<r;++a)n.setFloat32(e,i[a],t),e+=4;return e}function eS(n,e,t,r,i,a){return e=Zv(n,e,t,r,i),e=Zv(n,e,t,r,a),e}function tS(n,e,t,r,i){for(let a=0;a<r;++a)i[a]=n.getFloat32(e,t),e+=4;return e}function nS(n,e,t,r,i,a){return e=tS(n,e,t,r,i),e=tS(n,e,t,r,a),e}var Wn={[1]:{icon:"\uA579",description:"Line",toJSON(n){return{pointA:Array.from(n.pointA),pointB:Array.from(n.pointB)}},restoreState(n,e,t){n.pointA=U(e,"pointA",r=>Pe(new Float32Array(t),r,Ke)),n.pointB=U(e,"pointB",r=>Pe(new Float32Array(t),r,Ke))},serializedBytes(n){return 2*4*n},serialize(n,e,t,r,i){eS(n,e,t,r,i.pointA,i.pointB)},deserialize:(n,e,t,r,i)=>{let a=new Float32Array(r),o=new Float32Array(r);return nS(n,e,t,r,a,o),{type:1,pointA:a,pointB:o,id:i,properties:[]}},visitGeometry(n,e){e(n.pointA,!1),e(n.pointB,!1)}},[0]:{icon:"\u26AC",description:"Point",toJSON:n=>({point:Array.from(n.point)}),restoreState:(n,e,t)=>{n.point=U(e,"point",r=>Pe(new Float32Array(t),r,Ke))},serializedBytes:n=>n*4,serialize:(n,e,t,r,i)=>{Zv(n,e,t,r,i.point)},deserialize:(n,e,t,r,i)=>{let a=new Float32Array(r);return tS(n,e,t,r,a),{type:0,point:a,id:i,properties:[]}},visitGeometry(n,e){e(n.point,!1)}},[2]:{icon:"\u2751",description:"Bounding Box",toJSON:n=>({pointA:Array.from(n.pointA),pointB:Array.from(n.pointB)}),restoreState:(n,e,t)=>{n.pointA=U(e,"pointA",r=>Pe(new Float32Array(t),r,Ke)),n.pointB=U(e,"pointB",r=>Pe(new Float32Array(t),r,Ke))},serializedBytes:n=>2*4*n,serialize(n,e,t,r,i){eS(n,e,t,r,i.pointA,i.pointB)},deserialize:(n,e,t,r,i)=>{let a=new Float32Array(r),o=new Float32Array(r);return nS(n,e,t,r,a,o),{type:2,pointA:a,pointB:o,id:i,properties:[]}},visitGeometry(n,e){e(n.pointA,!1),e(n.pointB,!1)}},[3]:{icon:"\u25CE",description:"Ellipsoid",toJSON:n=>({center:Array.from(n.center),radii:Array.from(n.radii)}),restoreState:(n,e,t)=>{n.center=U(e,"center",r=>Pe(new Float32Array(t),r,Ke)),n.radii=U(e,"radii",r=>Pe(new Float32Array(t),r,nh))},serializedBytes:n=>2*4*n,serialize(n,e,t,r,i){eS(n,e,t,r,i.center,i.radii)},deserialize:(n,e,t,r,i)=>{let a=new Float32Array(r),o=new Float32Array(r);return nS(n,e,t,r,a,o),{type:3,center:a,radii:o,id:i,properties:[]}},visitGeometry(n,e){e(n.center,!1),e(n.radii,!0)}}};function ph(n,e){let t=Wn[n.type].toJSON(n,e.rank);t.type=Be[n.type].toLowerCase(),t.id=n.id,t.description=n.description||void 0;let{relatedSegments:r}=n;if(r!==void 0&&r.some(i=>i.length!==0)&&(t.segments=r.map(i=>i.map(a=>a.toString()))),e.properties.length!==0){let i=e.properties;t.props=n.properties.map((a,o)=>Uo[i[o].type].serializeJson(a))}return t}function AW(n,e,t=!1){Q(n);let r=U(n,"type",c=>yt(c,Be)),i=U(n,"id",t?Vt:Z)||fh(),a=U(n,"segments",c=>{if(c===void 0)return e.relationships.map(()=>[]);let d=jr(c);return d.length===0?e.relationships.map(()=>[]):e.relationships.length===1&&!Array.isArray(d[0])?[ge(d,p=>X.parseString(p))]:ge(jr(c,e.relationships.length),p=>ge(p,h=>X.parseString(h)))}),o=U(n,"props",c=>{let d=e.properties;return c===void 0?d.map(p=>p.default):ge(jr(c,e.properties.length),(p,h)=>Uo[d[h].type].deserializeJson(p))}),l={id:i,description:U(n,"description",Vt),relatedSegments:a,properties:o,type:r};return Wn[r].restoreState(l,n,e.rank),l}var Ka=class extends H{constructor(e,t=[],r=[]){super();this.relationships=t;this.properties=r;this.annotationMap=new Map;this.changed=new ne;this.readonly=!1;this.childAdded=new $e;this.childUpdated=new $e;this.childDeleted=new $e;this.pending=new Set;this.references=new Map;this.rank_=e,this.annotationPropertySerializers=uh(e,r)}get rank(){return this.rank_}hasNonSerializedProperties(){return!0}add(e,t=!0){if(this.ensureUpdated(),!e.id)e.id=fh();else if(this.annotationMap.has(e.id))throw new Error(`Annotation id already exists: ${JSON.stringify(e.id)}.`);return this.annotationMap.set(e.id,e),this.changed.dispatch(),this.childAdded.dispatch(e),t||this.pending.add(e.id),this.getReference(e.id)}commit(e){this.ensureUpdated();let t=e.id;this.pending.delete(t),this.changed.dispatch()}update(e,t){if(this.ensureUpdated(),e.value===null)throw new Error("Annotation already deleted.");e.value=t,this.annotationMap.set(t.id,t),e.changed.dispatch(),this.changed.dispatch(),this.childUpdated.dispatch(t)}[Symbol.iterator](){return this.ensureUpdated(),this.annotationMap.values()}get(e){return this.ensureUpdated(),this.annotationMap.get(e)}delete(e){e.value!==null&&(e.value=null,this.annotationMap.delete(e.id),this.pending.delete(e.id),e.changed.dispatch(),this.changed.dispatch(),this.childDeleted.dispatch(e.id))}getReference(e){let t=this.references.get(e);return t!==void 0?t.addRef():(t=new Td(e),t.value=this.annotationMap.get(e)||null,this.references.set(e,t),t.registerDisposer(()=>{this.references.delete(e)}),t)}ensureUpdated(){}toJSON(){this.ensureUpdated();let e=[],{pending:t}=this;for(let r of this)t.has(r.id)||e.push(ph(r,this));return e}clear(){this.annotationMap.clear(),this.pending.clear(),this.changed.dispatch()}restoreState(e){this.ensureUpdated();let{annotationMap:t}=this;t.clear(),this.pending.clear(),e!==void 0&&ge(e,r=>{let i=AW(r,this);t.set(i.id,i)});for(let r of this.references.values()){let{id:i}=r,a=t.get(i);r.value=a||null,r.changed.dispatch()}this.changed.dispatch()}reset(){this.clear()}},kd=class extends Ka{constructor(e,t,r){super(e.value.sourceRank,r,t);this.watchableTransform=e;this.curCoordinateTransform=e.value,this.registerDisposer(e.changed.add(()=>this.ensureUpdated()))}get rank(){return this.ensureUpdated(),this.rank_}ensureUpdated(){let e=this.watchableTransform.value,{curCoordinateTransform:t}=this;if(e===t)return;this.curCoordinateTransform=e;let r=e.sourceRank,i=t.sourceRank;if(i===r&&(t.inputSpace===e.inputSpace||xe(t.inputSpace.ids.slice(0,r),e.inputSpace.ids.slice(0,r))))return;let{ids:a}=e.inputSpace,o=t.inputSpace.ids,l=[];for(let d=0;d<r;++d){let p=o.indexOf(a[d]);p>=i&&(p=-1),l.push(p)}let c=d=>{let p=new Float32Array(r);for(let h=0;h<r;++h){let g=l[h];p[h]=g===-1?0:d[h]}return p};for(let d of this.annotationMap.values())switch(d.type){case 0:d.point=c(d.point);break;case 1:case 2:d.pointA=c(d.pointA),d.pointB=c(d.pointB);break;case 3:d.center=c(d.center),d.radii=c(d.radii);break}this.rank_!==r&&(this.rank_=r,this.annotationPropertySerializers=uh(this.rank_,this.properties)),this.changed.dispatch()}},MW="Data Bounds";function fh(){return Ks(160)}function RW(n){return{type:2,id:"data-bounds",description:MW,pointA:new Float32Array(n.lowerBounds),pointB:new Float32Array(n.upperBounds),properties:[]}}function sn(n){let e=new Ka(n.lowerBounds.length);return e.readonly=!0,e.add(RW(n)),e}function _W(n,e){let t=0,r=[];for(let d of Mi){let h=e[d].serializedBytes;r[d]=t;let v=n[d].length;t+=h*v}let i=[],a=[],o=new ArrayBuffer(t),l=new DataView(o),c=Pi===nn.LITTLE;for(let d of Mi){let p=e[d],{rank:h}=p,g=p.serialize,v=n[d];i[d]=v.map(P=>P.id),a[d]=new Map(v.map((P,I)=>[P.id,I]));let x=Wn[d].serialize,C=r[d],T=p.propertyGroupBytes[0];for(let P=0,I=v.length;P<I;++P){let M=v[P];x(l,C+P*T,c,h,M),g(l,C,P,I,c,M.properties)}}return{data:new Uint8Array(o),typeToIds:i,typeToOffset:r,typeToIdMaps:a}}var rS=class{constructor(e){this.propertySerializers=e;this.annotations=[[],[],[],[]]}add(e){this.annotations[e.type].push(e)}serialize(){return _W(this.annotations,this.propertySerializers)}};function iS(n){if(n==null)return n;let{relatedSegments:e}=n;if(e!==void 0)for(let t=0,r=e.length;t<r;++t){let i=e[t];i!==void 0&&(e[t]=i.map(a=>new X(a.low,a.high)))}return n}function We(n){let e=-1;return Object.assign(()=>{e===-1&&(e=requestAnimationFrame(()=>{e=-1,n()}))},{flush:()=>{e!==-1&&(e=-1,n())},cancel:()=>{e!==-1&&(cancelAnimationFrame(e),e=-1)}})}var Ec=class{constructor(){this.map=new Map}get(e,t){let{map:r}=this,i=r.get(e);return i===void 0?(i=t(),i.registerDisposer(()=>{r.delete(e)}),r.set(e,i)):i.addRef(),i}},Ed=class extends Ec{get(e,t){return typeof e!="string"&&(e=xn(e)),super.get(e,t)}getUncounted(e,t){return this.get(e,()=>new pd(t())).value}};var VW=!1;function WE(n){let e={antialias:!1,stencil:!0};VW&&(console.log("DEBUGGING via preserveDrawingBuffer"),e.preserveDrawingBuffer=!0);let t=n.getContext("webgl2",e);if(t==null)throw new Error("WebGL not supported.");t.memoize=new Ec,t.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),t.max3dTextureSize=t.getParameter(t.MAX_3D_TEXTURE_SIZE),t.maxTextureImageUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),t.tempTextureUnit=t.maxTextureImageUnits-1;for(let r of["EXT_color_buffer_float"])if(!t.getExtension(r))throw new Error(`${r} extension not available`);for(let r of["EXT_float_blend"])t.getExtension(r);return t}var Dc=class{constructor(){this.width=0;this.height=0;this.logicalWidth=0;this.logicalHeight=0;this.visibleLeftFraction=0;this.visibleTopFraction=0;this.visibleWidthFraction=0;this.visibleHeightFraction=0}};function hh(n,e){let t=1/n.visibleWidthFraction,r=1/n.visibleHeightFraction,i=-1-(-1+2*n.visibleLeftFraction)*t,a=-1-(-1+2*n.visibleTopFraction)*r;a=-a,e[0]=e[0]*t+e[3]*i,e[4]=e[4]*t+e[7]*i,e[8]=e[8]*t+e[11]*i,e[12]=e[12]*t+e[15]*i,e[1]=e[1]*r+e[3]*a,e[5]=e[5]*r+e[7]*a,e[9]=e[9]*r+e[11]*a,e[13]=e[13]*r+e[15]*a}function mh(n,e){return n.width===e.width&&n.height===e.height&&n.logicalWidth===e.logicalWidth&&n.logicalHeight===e.logicalHeight&&n.visibleLeftFraction===e.visibleLeftFraction&&n.visibleTopFraction===e.visibleTopFraction}var gh=class extends H{constructor(e,t,r){super();this.context=e;this.element=t;this.visibility=r;this.boundsGeneration=-1;this.canvasRelativeClippedLeft=0;this.canvasRelativeClippedTop=0;this.canvasRelativeLogicalLeft=0;this.canvasRelativeLogicalTop=0;this.renderViewport=new Dc;this.boundsObserversRegistered=!1;this.gl=e.gl,e.addPanel(this)}scheduleRedraw(){this.visible&&this.context.scheduleRedraw()}ensureBoundsUpdated(){let{context:e}=this;e.ensureBoundsUpdated();let{boundsGeneration:t}=e;if(t===this.boundsGeneration)return;this.boundsGeneration=t;let{element:r}=this;!this.boundsObserversRegistered&&e.monitorPanel(r)&&(this.boundsObserversRegistered=!0);let i=r.getBoundingClientRect(),a=e.container,o=e.canvasRect,{canvas:l}=e,{width:c,height:d}=l,p=c/o.width,h=d/o.height,g=o.left,v=o.top,b=this.canvasRelativeLogicalLeft=Math.round((i.left-g)*p+r.clientLeft),x=this.canvasRelativeLogicalTop=Math.round((i.top-v)*h+r.clientTop),C=r.clientWidth,T=r.clientHeight,P=b+C,I=x+T,M=x,D=b,E=P,V=I;for(let _=r.parentElement;_!==null&&_!==a;_=_.parentElement){let F=_.getBoundingClientRect();F.x===0&&F.y===0&&F.width===0&&F.height===0||(D=Math.max(D,(F.left-g)*p),M=Math.max(M,(F.top-v)*h),E=Math.min(E,(F.right-g)*p),V=Math.min(V,(F.bottom-v)*h))}M=this.canvasRelativeClippedTop=Math.round(Math.max(M,0)),D=this.canvasRelativeClippedLeft=Math.round(Math.max(D,0)),E=Math.round(Math.min(E,c)),V=Math.round(Math.min(V,d));let O=this.renderViewport,B=O.width=Math.max(0,E-D),z=O.height=Math.max(0,V-M);O.logicalWidth=C,O.logicalHeight=T,O.visibleLeftFraction=(D-b)/C,O.visibleTopFraction=(M-x)/T,O.visibleWidthFraction=B/C,O.visibleHeightFraction=z/T}setGLClippedViewport(){let{gl:e,canvasRelativeClippedTop:t,canvasRelativeClippedLeft:r,renderViewport:{width:i,height:a}}=this,o=t+a;e.enable(WebGL2RenderingContext.SCISSOR_TEST);let l=this.context.canvas.height-o;e.viewport(r,l,i,a),e.scissor(r,l,i,a)}setGLLogicalViewport(){let{gl:e,renderViewport:{width:t,height:r,logicalWidth:i,logicalHeight:a}}=this,o=this.context.canvas.height;e.enable(WebGL2RenderingContext.SCISSOR_TEST),e.viewport(this.canvasRelativeLogicalLeft,o-(this.canvasRelativeLogicalTop+a),i,a),e.scissor(this.canvasRelativeClippedLeft,o-(this.canvasRelativeClippedTop+r),t,r)}disposed(){this.boundsObserversRegistered&&this.context.unmonitorPanel(this.element),this.context.removePanel(this),super.disposed()}get visible(){return this.visibility.visible}getDepthArray(){}get shouldDraw(){if(!this.visible)return!1;let{element:e}=this;return!(e.clientWidth===0||e.clientHeight===0||e.offsetWidth===0||e.offsetHeight===0)}get drawOrder(){return 0}},yh=class extends gh{constructor(e,t,r){super(e,t,r);this.canvas=document.createElement("canvas");this.canvasRenderingContext=this.canvas.getContext("2d");let{canvas:i}=this;t.appendChild(i),t.style.position="relative",i.style.position="absolute",i.style.left="0",i.style.right="0",i.style.top="0",i.style.bottom="0"}draw(){this.drawIndirect();let{renderViewport:e,canvas:t}=this,{logicalWidth:r,logicalHeight:i}=e;t.width=r,t.height=i;let{canvasRenderingContext:a}=this;a==null||a.drawImage(this.context.canvas,this.canvasRelativeLogicalLeft,this.canvasRelativeLogicalTop,r,i,0,0,r,i)}},aS=class extends Ce{constructor(){super(Float64Array.of(0,0,1,1),e=>Pe(new Float64Array(4),e,ah))}toJSON(){let{value:e}=this,[t,r,i,a]=e;if(!(t===0&&r==0&&i===1&&a===1))return Array.from(e)}},oS=class extends H{constructor(e){super();this.container=e;this.canvas=document.createElement("canvas");this.updateStarted=new ne;this.updateFinished=new ne;this.changed=this.updateFinished;this.panels=new Set;this.resizeGeneration=0;this.boundsGeneration=-1;this.orderedPanels=[];this.frameNumber=0;this.panelAncestors=new Map;this.resizeCallback=()=>{++this.resizeGeneration,this.scheduleRedraw()};this.resizeObserver=new ResizeObserver(this.resizeCallback);this.scheduleRedraw=this.registerCancellable(We(()=>this.draw()));let{canvas:t,resizeObserver:r}=this;e.style.position="relative",t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.width="100%",t.style.height="100%",t.style.zIndex="0",r.observe(t),e.appendChild(t),this.registerEventListener(t,"webglcontextlost",i=>{console.log(`Lost WebGL context: ${i.statusMessage}`),i.preventDefault()}),this.registerEventListener(t,"webglcontextrestored",()=>{console.log("WebGL context restored"),window.location.reload()}),this.gl=WE(t)}monitorPanel(e){let{panelAncestors:t,container:r}=this;if(!r.contains(e))return!1;for(;e!==r;){let i=t.get(e);if(i!==void 0){++i.count;break}let a=e.parentElement;i={parent:a,count:1},t.set(e,i),e.addEventListener("scroll",this.resizeCallback,{capture:!0}),this.resizeObserver.observe(e),e=a}return!0}unmonitorPanel(e){let{panelAncestors:t,container:r}=this;for(;e!==r;){let i=t.get(e);if(i.count!==1){--i.count;break}e.removeEventListener("scroll",this.resizeCallback,{capture:!0}),this.resizeObserver.unobserve(e),t.delete(e),e=i.parent}}applyWindowedViewportToElement(e,t){let[r,i,a,o]=t,l=1/a,c=1/o;e.style.position="absolute",e.style.top=`${-c*i*100}%`,e.style.left=`${-l*r*100}%`,e.style.width=`${l*100}%`,e.style.height=`${c*100}%`,++this.resizeGeneration,this.scheduleRedraw()}isReady(){for(let e of this.panels)if(!!e.visible&&!e.isReady())return!1;return!0}makeCanvasOverlayElement(){let e=document.createElement("div");return e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.width="100%",e.style.height="100%",e.style.zIndex="2",this.container.appendChild(e),e}disposed(){this.orderedPanels.length=0,this.resizeObserver.disconnect()}addPanel(e){this.panels.add(e),this.orderedPanels.length=0,++this.resizeGeneration,this.scheduleRedraw()}removePanel(e){this.panels.delete(e),this.orderedPanels.length=0,++this.resizeGeneration,this.scheduleRedraw()}ensureBoundsUpdated(){let{resizeGeneration:e}=this;if(this.boundsGeneration===e)return;let{canvas:t}=this;t.width=t.offsetWidth,t.height=t.offsetHeight,this.canvasRect=t.getBoundingClientRect(),this.boundsGeneration=e}draw(){++this.frameNumber,this.updateStarted.dispatch();let e=this.gl;this.ensureBoundsUpdated(),this.gl.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);let{orderedPanels:t,panels:r}=this;t.length!==r.size&&(t.push(...r),t.sort((i,a)=>i.drawOrder-a.drawOrder));for(let i of t){if(!i.shouldDraw)continue;i.ensureBoundsUpdated();let{renderViewport:a}=i;a.width===0||a.height===0||i.draw()}e.disable(e.SCISSOR_TEST),this.gl.clearColor(1,1,1,1),this.gl.colorMask(!1,!1,!1,!0),e.clear(e.COLOR_BUFFER_BIT),this.gl.colorMask(!0,!0,!0,!0),this.updateFinished.dispatch()}getDepthArray(){let{width:e,height:t}=this.canvas,r=new Float32Array(e*t);for(let i of this.panels){if(!i.shouldDraw)continue;let a=i.getDepthArray();if(a===void 0)continue;let{canvasRelativeClippedTop:o,canvasRelativeClippedLeft:l,renderViewport:{width:c,height:d}}=i;for(let p=0;p<d;++p){let h=(d-1-p)*c;r.set(a.subarray(h,h+c),(o+p)*c+l)}}return r}};function Pc(n,e,t){let r=n.length;for(let i=0;i<r;++i)n[i]=e[i]+t[i];return n}function vh(n,e,t){let r=n.length;for(let i=0;i<r;++i)n[i]=e[i]-t[i];return n}function zE(n,e,t,r){let i=n.length;for(let a=0;a<i;++a)n[a]=e[a]+t[a]*r;return n}function HE(n,e,t){let r=n.length;for(let i=0;i<r;++i)n[i]=e[i]*t;return n}function Ic(n){let e=1;for(let t=0,r=n.length;t<r;++t)e*=n[t];return e}function $E(n,e,t){let r=n.length;for(let i=0;i<r;++i)n[i]=Math.min(e[i],t[i]);return n}var Xa=new Float32Array(0),sS=new Float64Array(0),CY=Float64Array.of(1,1,1);var Dd=class extends Dc{constructor(){super(...arguments);this.globalPosition=Xa;this.projectionMat=oe.create();this.viewMatrix=oe.create();this.invViewMatrix=oe.create();this.viewProjectionMat=oe.create();this.invViewProjectionMat=oe.create()}};function jE(n,e){return n.displayDimensionRenderInfo===e.displayDimensionRenderInfo&&mh(n,e)&&xe(n.globalPosition,e.globalPosition)&&xe(n.projectionMat,e.projectionMat)&&xe(n.viewMatrix,e.viewMatrix)}function Sh(n){let{viewMatrix:e,viewProjectionMat:t}=n;oe.invert(e,n.invViewMatrix),oe.multiply(t,n.projectionMat,e),oe.invert(n.invViewProjectionMat,t)}function ci(n,e,t,r,i,a,o,l,c){for(let d=0;d<o;++d)for(let p=0;p<c;++p){let h=0;for(let g=0;g<l;++g)h+=t[d+r*g]*i[g+a*p];n[d+e*p]=h}return n}function lS(n,e,t){for(let r=0;r<t;++r){let i=e*r;n.fill(0,i,i+t),n[i+r]=1}return n}function Yt(n,e,t=e){return lS(new n(e*t),e,Math.min(e,t))}function Ac(n,e,t=!0){let r=e.length,i=t?r+1:r,a=new n(i*(r+1));t&&(a[a.length-1]=1);for(let o=0;o<r;++o)a[(i+1)*o]=e[o];return a}function JE(n,e,t=!0){let r=e.length,i=t?r+1:r,a=Yt(n,i,r+1);for(let o=0;o<r;++o)a[i*r+o]=e[o];return a}function qE(n,e,t){for(let r=0;r<t;++r)for(let i=0;i<t;++i)if(n[r*e+i]!=(r===i?1:0))return!1;return!0}function bh(n,e,t,r,i,a){for(let o=0;o<a;++o){let l=o*r,c=o*e;for(let d=0;d<i;++d)n[c+d]=t[l+d]}return n}function Pd(n,e,t,r){bh(n,e+1,t,r+1,r,r);for(let i=0;i<r;++i)n[(e+1)*e+i]=t[(r+1)*r+i];n[n.length-1]=1;for(let i=r;i<e;++i)n[(e+1)*i+i]=1;return n}var ui;function OW(n,e,t){let r=1;(ui===void 0||ui.length<t)&&(ui=new Uint32Array(t));for(let i=0;i<t;++i)ui[i]=i;for(let i=0;i<t;++i){let a=e*i,o=i;{let d=Math.abs(n[a+i]);for(let p=i+1;p<t;++p){let h=Math.abs(n[a+p]);h>d&&(d=h,o=p)}}if(i!==o){r*=-1;for(let d=0;d<t;++d){let p=e*d,h=n[p+i];n[p+i]=n[p+o],n[p+o]=h}{let d=ui[i];ui[i]=ui[o],ui[o]=d}}let l=n[a+i],c=1/l;r*=l;for(let d=0;d<t;++d)n[e*d+i]*=c;n[a+i]=c;for(let d=0;d<t;++d){if(d===i)continue;let p=-n[e*i+d];for(let h=0;h<t;++h){let g=e*h;n[g+d]+=p*n[g+i]}n[e*i+d]=p*c}}for(let i=0;i<t;++i){let a=ui[i];for(;a!==i;){let o=e*i,l=e*a;for(let d=0;d<t;++d){let p=o+d,h=l+d,g=n[p];n[p]=n[h],n[h]=g}let c=ui[i]=ui[a];ui[a]=a,a=c}}return r}function Mc(n,e,t,r,i){return bh(n,e,t,r,i,i),OW(n,e,i)}function YE(n,e,t,r,i,a){for(let o=0;o<a;++o){let l=e*o,c=r*o;for(let d=0;d<i;++d)if(n[l+d]!==t[c+d])return!1}return!0}function Kr(n,e,t,r,i){for(let a=0;a<i;++a){let o=e[t*i+a];for(let l=0;l<i;++l)o+=e[t*l+a]*r[l];n[a]=o}return n}function xh(n,e,t,r,i){for(let a=0;a<i;++a){let o=0;for(let l=0;l<i;++l)o+=e[t*l+a]*r[l];n[a]=o}return n}function KE(n,e,t,r,i,a){let o=i.length;for(let l=0;l<o;++l){let c=i[l];for(let d=0;d<a;++d)n[d*e+l]=t[d*r+c]}return n}var Ch=[{prefix:"Y",exponent:24,longPrefix:"yotta"},{prefix:"Z",exponent:21,longPrefix:"zetta"},{prefix:"E",exponent:18,longPrefix:"exa"},{prefix:"P",exponent:15,longPrefix:"peta"},{prefix:"T",exponent:12,longPrefix:"tera"},{prefix:"G",exponent:9,longPrefix:"giga"},{prefix:"M",exponent:6,longPrefix:"mega"},{prefix:"k",exponent:3,longPrefix:"kilo"},{prefix:"",exponent:0,longPrefix:""},{prefix:"m",exponent:-3,longPrefix:"milli"},{prefix:"\xB5",exponent:-6,longPrefix:"micro"},{prefix:"n",exponent:-9,longPrefix:"nano"},{prefix:"p",exponent:-12,longPrefix:"pico"},{prefix:"f",exponent:-15,longPrefix:"femto"},{prefix:"a",exponent:-18,longPrefix:"atto"},{prefix:"z",exponent:-21,longPrefix:"zepto"},{prefix:"y",exponent:-24,longPrefix:"yocto"}],cS=[...Ch,{prefix:"h",exponent:2,longPrefix:"hecto"},{prefix:"da",exponent:1,longPrefix:"deca"},{prefix:"d",exponent:-1,longPrefix:"deci"},{prefix:"c",exponent:-2,longPrefix:"centi"}],NW=[{prefix:"u",exponent:-6},...cS],Rc=new Map;Rc.set("",{unit:"",exponent:0});var BW=new Map;for(let{prefix:n,exponent:e}of NW){BW.set(e,n);for(let t of["m","s","Hz","rad/s"])Rc.set(`${n}${t}`,{unit:t,exponent:e})}function uS(n){let e=Math.log10(n),t=Ch.length,r=$L(0,t,i=>Ch[i].exponent<=e);return Ch[Math.min(r,t-1)]}function dS(n,e,t={}){let{precision:r=6,elide1:i=!0}=t,a=n,o="";if(e!==""){let c=uS(n);o=c.prefix,a=Id(n,-c.exponent)}if(i&&a===1)return{scale:"",unit:e,prefix:o};let l;if(r!=0){a<1||a>=1e3?l=a.toPrecision(r):l=a.toFixed(r);let c=l.indexOf("e"),d,p;c!==-1?(d=l.substring(0,c),p=l.substring(c)):(d=l,p="");let h=d.match(/.*\.(?:[0-9]*[1-9])?(0+)$/);h!==null&&(d=d.substring(0,d.length-h[1].length),d.endsWith(".")&&(d=d.substring(0,d.length-1)),l=d+p)}else l=a.toString();return{scale:l,unit:e,prefix:o}}function Ri(n,e,t){let{scale:r,unit:i,prefix:a}=dS(n,e,t);return`${r}${a}${i}`}function Go(n){if(n==="")return{scale:1,unit:""};let e=n.match(/^((?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?)?([µa-zA-Z]+)?$/);if(e===null)return;let t=e[1],r=t===void 0?1:Number(t);if(Number.isNaN(r))return;let i="";if(e[2]!==void 0){let a=Rc.get(e[2]);if(a===void 0)return;i=a.unit,a.exponent>0?r*=10**a.exponent:r/=10**-a.exponent}if(!(r<=0||!Number.isFinite(r)))return{scale:r,unit:i}}function wh(n){let e=Rc.get(n);if(e===void 0)throw new Error(`Invalid unit: ${JSON.stringify(n)}`);return e}function Id(n,e){return e>=0?n*10**e:n/10**-e}var FW=0;function Xs(){return++FW}function UW(n,e){return xe(n.lowerBounds,e.lowerBounds)&&xe(n.upperBounds,e.upperBounds)}function GW(n,e){return n===void 0?e===void 0:e===void 0?!1:n.explicit===e.explicit&&xe(n.coordinates,e.coordinates)&&xe(n.labels,e.labels)}function WW(n,e){let t=new Map;for(let r=0,i=n.length;r<i;++r)t.set(n[r],e[r]);return n=Array.from(t.keys()),n.sort((r,i)=>r-i),e=Array.from(n,r=>t.get(r)),{coordinates:n,labels:e}}function XE(n){if(n.length===1)return n[0];let e=new Map,t=!1;for(let a of n){a.explicit&&(t=!0);let{coordinates:o,labels:l}=a;for(let c=0,d=o.length;c<d;++c)e.set(o[c],l[c])}let r=Array.from(e.keys());r.sort((a,o)=>a-o);let i=Array.from(r,a=>e.get(a));return{explicit:t,coordinates:r,labels:i}}function QE(n){if(n=n.filter(e=>e!==void 0),n.length!==0)return XE(n)}function zW(n,e){return xe(n.transform,e.transform)&&UW(n.box,e.box)}function Th(n,e){return n.valid===e.valid&&n.rank===e.rank&&xe(n.names,e.names)&&xe(n.ids,e.ids)&&xe(n.timestamps,e.timestamps)&&xe(n.units,e.units)&&xe(n.scales,e.scales)&&ud(n.boundingBoxes,e.boundingBoxes,zW)&&ud(n.coordinateArrays,e.coordinateArrays,GW)}function Oe(n){let{names:e,units:t,scales:r}=n,{valid:i=!0,rank:a=e.length,timestamps:o=e.map(()=>Number.NEGATIVE_INFINITY),ids:l=e.map((h,g)=>-g),boundingBoxes:c=[]}=n,{coordinateArrays:d=new Array(a)}=n,{bounds:p=$W(c,a)}=n;return{valid:i,rank:a,names:e,timestamps:o,ids:l,units:t,scales:r,boundingBoxes:c,bounds:p,coordinateArrays:d}}var Xr=Oe({valid:!1,names:[],units:[],scales:sS,boundingBoxes:[]}),_i=Oe({valid:!0,names:[],units:[],scales:sS,boundingBoxes:[]});function HW(n){let[e,t]=jr(n,2),r=ot(e),i=Z(t),a=Rc.get(i);if(a===void 0)throw new Error(`Invalid unit: ${JSON.stringify(i)}`);return{unit:a.unit,scale:Id(r,a.exponent)}}function Qs(n,e=!1){if(n===void 0)return Xr;Q(n);let t=Md(Object.keys(n),e),r=t.length,i=new Array(r),a=new Float64Array(r),o=new Array(r);for(let l=0;l<r;++l)U(n,t[l],c=>{if(Array.isArray(c)){let{unit:d,scale:p}=HW(c);i[l]=d,a[l]=p}else{Q(c);let d=U(c,"coordinates",RE),p=U(c,"labels",on),h=d.length;if(h!==p.length)throw new Error(`Length of coordinates array (${h}) does not match length of labels array (${p.length})`);i[l]="",a[l]=1,o[l]={explicit:!0,...WW(d,p)}}});return Oe({valid:!1,names:t,units:i,scales:a,coordinateArrays:o})}function pS(n){let{rank:e}=n;if(e===0)return;let{names:t,units:r,scales:i,coordinateArrays:a}=n,o={};for(let l=0;l<e;++l){let c=t[l],d=a[l];(d==null?void 0:d.explicit)?o[c]={coordinates:Array.from(d.coordinates),labels:d.labels}:o[c]=[i[l],r[l]]}return o}var Zs=class extends ke{constructor(){super(Xr)}toJSON(){return pS(this.value)}reset(){this.value=Xr}restoreState(e){this.value=Qs(e)}};function fS(n,e){let t=(n+e)/2;return Number.isFinite(t)||(t=Math.min(Math.max(0,n),e)),t}function ZE(n,e){let{lowerBounds:t,upperBounds:r}=e,i=n.length;for(let a=0;a<i;++a)n[a]=fS(t[a],r[a]);return n}function Rn(n){let e=n.lowerBounds.length;return{box:n,transform:Yt(Float64Array,e,e+1)}}function hS(n,e,t){let{box:{lowerBounds:r,upperBounds:i},transform:a}=n,o=r.length,l=t,c=a[l*o+e],d=c,p=c,h=!1;for(let g=0;g<o;++g){let v=a[l*g+e];if(v===0)continue;let b=v*r[g],x=v*i[g];d+=Math.min(b,x),p+=Math.max(b,x),h=!0}if(!!h)return{lower:d,upper:p}}function $W(n,e){let t=new Float64Array(e),r=new Float64Array(e);t.fill(Number.NEGATIVE_INFINITY),r.fill(Number.POSITIVE_INFINITY);for(let i of n)for(let a=0;a<e;++a){let o=hS(i,a,e);if(o===void 0)continue;let{lower:l,upper:c}=o;t[a]=t[a]===Number.NEGATIVE_INFINITY?l:Math.min(t[a],l),r[a]=r[a]===Number.POSITIVE_INFINITY?c:Math.max(r[a],c)}return{lowerBounds:t,upperBounds:r}}function jW(n,e,t){let{transform:r,box:i}=n,a=t.length,o=i.lowerBounds.length,l=new Float64Array((o+1)*e);for(let c=0;c<a;++c){let d=t[c];if(d!==-1)for(let p=0;p<=o;++p)l[p*e+d]=r[p*a+c]}return{transform:l,box:i}}function mS(n,e){let t={lowerBounds:Float64Array.of(0),upperBounds:Float64Array.of(1)},r=new Float64Array(2*n);return r[e]=1,{transform:r,box:t}}function gS(n,e,t){if(e===t)return n;let{box:r}=n,i=r.lowerBounds.length,a=new Float64Array((i+1)*t);return bh(a,t,n.transform,e,e,i+1),{box:r,transform:a}}function eD(n,e){let{rank:t,sourceRank:r}=n;if(t!==e.rank||r!==e.sourceRank)return!1;let{inputSpace:i}=n,{inputSpace:a}=e;return!xe(a.scales,i.scales)||!xe(a.units,i.units)||!xe(e.outputSpace.names,n.outputSpace.names)?!1:iD(n.transform,t,n.outputSpace.scales,e.transform,t,e.outputSpace.scales)}function vt(n){return{rank:n.rank,sourceRank:n.rank,inputSpace:n,outputSpace:n,transform:Yt(Float64Array,n.rank+1)}}function JW(n,e,t,r){let{transform:i,box:a}=n,o=n.box.lowerBounds.length,l=r.length,c=new Float64Array((o+1)*l);for(let d=0;d<l;++d){let p=r[d];for(let g=0;g<o;++g){let v=0;for(let b=0;b<l;++b){let x=t[b];v+=e[(l+1)*b+d]*i[l*g+b]*(x/p)}c[l*g+d]=v}let h=e[(l+1)*l+d];for(let g=0;g<l;++g){let v=t[g];h+=e[(l+1)*g+d]*i[l*o+g]*(v/p)}c[o*l+d]=h}return{transform:c,box:a}}function tD(n,e,t){return n.boundingBoxes.map(r=>JW(r,e,n.scales,t))}function yS(n,e,t){let r=Oe({valid:n.valid,rank:t.rank,ids:t.ids,names:t.names,timestamps:t.timestamps,scales:t.scales,units:t.units,boundingBoxes:tD(n,e,t.scales),coordinateArrays:t.coordinateArrays});return Th(r,t)?t:r}function vS(n,e=!1){if(e){let t=Number(n);if(Number.isInteger(t)&&t>=0)return!0}return n.match(/^[a-zA-Z][a-zA-Z_0-9]*['^]?$/)!==null}function _c(n,e=!1){let t=new Set;for(let r of n){if(!vS(r,e)||t.has(r))return!1;t.add(r)}return!0}function Ad(n){let e=n.length,t=new Array(e);t.fill(!0);for(let r=0;r<e;++r){let i=n[r];if(!vS(i)){t[r]=!1;continue}let a=n.indexOf(i,r+1);a!==-1&&(t[r]=!1,t[a]=!1)}return t}function Wo(n){return n.endsWith("'")}function SS(n){return n.endsWith("'")||n.endsWith("^")}function nD(n){return n.endsWith("^")}function rD(n){return!SS(n)}function qW(n,e,t){let r=new Float64Array(n),i=e.length,a=(i+1)*i;for(let o=0;o<i;++o)r[a+o]*=e[o]/t[o];return r}function iD(n,e,t,r,i,a){if(!YE(n,e+1,r,i+1,e,e))return!1;for(let o=0;o<e;++o){let l=n[(e+1)*e+o],c=r[(i+1)*i+o];if(l*(t[o]/a[o])!==c)return!1}for(let o=e;o<i;++o)if(r[(i+1)*i+o]!==0)return!1;for(let o=e;o<i;++o){for(let l=0;l<e;++l)if(r[(i+1)*l+o]!==0)return!1;for(let l=0;l<i;++l){let c=r[(i+1)*o+l];if(o===l){if(c!==1)return!1}else if(c!==0)return!1}}return!0}function YW(n,e){if(!e.includes(n))return n;let[,t,r]=n.match(/^([^']*)('?)$/);for(let i=0;;++i){let a=`${t}${i}${r}`;if(!e.includes(a))return a}}function KW(n,e){let{inputSpace:t,transform:r}=n,{ids:i,rank:a}=t,{rank:o,names:l,units:c,scales:d}=e,p=new Array(a);p.fill(!0);let h=[],g=e.ids.map((J,ae)=>{let pe=i.indexOf(J);return pe!==-1?p[pe]=!1:h.push(ae),pe}),{outputSpace:v}=n,{names:b,units:x,scales:C,ids:T,timestamps:P,coordinateArrays:I}=v,M=p,D=[],E=[],V=new Float64Array(o),O=[],B=[],z=new Array(o),_=0,F=new Float64Array((o+1)**2);F[F.length-1]=1;for(let J=0;J<a;++J)if(!M[J]){D[_]=b[J],O[_]=T[J],E[_]=x[J],V[_]=C[J],B[_]=P[J],z[_]=I[J];for(let ae=0;ae<o;++ae){let pe=g[ae];pe!==-1&&(F[ae*(o+1)+_]=r[pe*(a+1)+J])}F[o*(o+1)+_]=r[a*(a+1)+J],++_}for(let J of h)O[_]=Xs(),D[_]=YW(l[J],D),V[_]=d[J],E[_]=c[J],F[J*(o+1)+_]=1,++_;let N=Oe({valid:e.valid,rank:o,names:D,ids:O,timestamps:B,units:E,scales:V,boundingBoxes:tD(e,F,V),coordinateArrays:z});return{rank:o,sourceRank:n.sourceRank,inputSpace:e,outputSpace:N,transform:F}}function aD(n){let e=yS(n.inputSpace,n.transform,n.outputSpace);return e===n.outputSpace?n:{rank:n.rank,sourceRank:n.sourceRank,inputSpace:n.inputSpace,transform:n.transform,outputSpace:e}}var Lh=class{constructor(e,t=!1){this.mutableSourceRank=t;this.value_=void 0;this.changed=new ne;this.inputSpaceChanged=new ne;this.defaultTransform=aD(e);let r=this;this.outputSpace={changed:r.changed,get value(){return r.value.outputSpace},set value(i){let{value:a}=r;if(Th(a.outputSpace,i)||a.rank!==i.rank)return;let o=qW(a.transform,a.outputSpace.scales,i.scales);r.value_={sourceRank:a.sourceRank,rank:a.rank,inputSpace:a.inputSpace,outputSpace:yS(a.inputSpace,o,i),transform:o},r.changed.dispatch()}},this.inputSpace={changed:r.inputSpaceChanged,get value(){return r.value.inputSpace},set value(i){let{value:a}=r;Th(a.inputSpace,i)||(r.value_=KW(a,i),r.inputSpaceChanged.dispatch(),r.changed.dispatch())}}}set value(e){let t=this.value;e!==t&&(this.value_=aD(e),e.inputSpace!==t.inputSpace&&this.inputSpaceChanged.dispatch(),this.changed.dispatch())}get value(){let{value_:e}=this;return e===void 0&&(e=this.value_=this.defaultTransform),e}reset(){this.value_!==this.defaultTransform&&(this.value_=this.defaultTransform,this.inputSpaceChanged.dispatch(),this.changed.dispatch())}get defaultInputSpace(){return this.defaultTransform.inputSpace}get spec(){let{value:e}=this,{rank:t,transform:r,inputSpace:i,outputSpace:a,sourceRank:o}=e,{defaultTransform:l,mutableSourceRank:c}=this,{inputSpace:d,rank:p,transform:h,outputSpace:g}=l,{units:v,scales:b}=i,x=o===t&&xe(b,c?a.scales:d.scales)&&xe(v,c?a.units:d.units),C=iD(h,p,g.scales,r,t,a.scales),T=xe(g.names,a.names);if(!(C&&T&&x))return{sourceRank:o,transform:C?void 0:r,outputSpace:e.outputSpace,inputSpace:x?void 0:i}}set transform(e){let{value:t}=this,{inputSpace:r}=t;this.value_={rank:t.rank,sourceRank:t.sourceRank,inputSpace:r,transform:e,outputSpace:yS(r,e,t.outputSpace)},this.changed.dispatch()}set spec(e){if(e===void 0){this.reset();return}if(this.mutableSourceRank){let _=e.inputSpace||e.outputSpace,F=_.rank,N=Oe({rank:F,names:_.names.map((J,ae)=>`${ae}`),units:_.units,scales:_.scales,coordinateArrays:_.coordinateArrays});this.value={rank:F,transform:e.transform||Yt(Float64Array,F+1),sourceRank:e.sourceRank,outputSpace:e.outputSpace,inputSpace:N};return}let{inputSpace:t,sourceRank:r,outputSpace:i,transform:a,rank:o}=this.defaultTransform,{inputSpace:l,sourceRank:c,outputSpace:d,transform:p}=e,h=e.outputSpace.rank,g=t.names,v=l!==void 0?l.names:g,b=new Array(r);for(let _=0;_<r;++_){let F=v.indexOf(g[_]);F>=c&&(F=-1),b[_]=F}let x=h-c+r;for(let _=c;_<h;++_)b[r+_-c]=_;let C=new Float64Array(x),T=new Array(x),P=[];for(let _=0;_<r;++_){let F=b[_];F===-1||l===void 0?(C[_]=t.scales[_],P[_]=t.units[_],T[_]=t.coordinateArrays[_]):(C[_]=l.scales[F],P[_]=l.units[F],T[_]=QE([t.coordinateArrays[_],l.coordinateArrays[F]]))}let I=l||d,M=g.slice(0,r),D=i.names.slice(0,r),E=i.coordinateArrays.slice(0,r),V=new Float64Array(x),O=[];for(let _=0;_<x;++_){let F=b[_];F===-1?(V[_]=i.scales[_],O[_]=i.units[_],E[_]=i.coordinateArrays[_]):(D[_]=d.names[F],O[_]=d.units[F],V[_]=d.scales[F],E[_]=d.coordinateArrays[F])}if(!_c(D)){this.reset();return}for(let _=r;_<x;++_){let F=_-r+c;C[_]=I.scales[F],P[_]=I.units[F],M[_]=`${_}`}let B=new Float64Array((x+1)**2);B[B.length-1]=1;for(let _=0;_<x;++_){let F=b[_],N;F===-1||p===void 0?_>=r?N=0:N=a[o*(o+1)+_]*(i.scales[_]/V[_]):N=p[h*(h+1)+F],B[x*(x+1)+_]=N;for(let J=0;J<x;++J){let ae=b[J],pe;F===-1!=(ae===-1)?pe=0:F===-1||p===void 0?F>=r||ae>=r?pe=F===ae?1:0:pe=a[J*(o+1)+_]:pe=p[ae*(h+1)+F],B[J*(x+1)+_]=pe}}let z=t.boundingBoxes.map(_=>gS(_,o,x));for(let _=r;_<x;++_)z.push(mS(x,_));for(let _=0;_<x;++_){if(B[x*(x+1)+_]!==0)continue;let N;for(let ae=0;ae<x;++ae){let pe=B[ae*(x+1)+_];if(pe!==0)if(pe===1)if(N===void 0)N=ae;else{N=null;break}else{N=null;break}}if(N==null)continue;let J=T[N];J!==void 0&&(J.explicit&&(J={...J,explicit:!1}),E[_]=QE([J,E[_]]))}this.value={rank:x,transform:B,sourceRank:r,outputSpace:Oe({rank:x,names:D,scales:V,units:O,coordinateArrays:E}),inputSpace:Oe({rank:x,names:M,scales:C,units:P,coordinateArrays:T,boundingBoxes:z})}}toJSON(){return xS(this.spec)}restoreState(e){this.spec=bS(e)}};function XW(n,e=!1){let t=Z(n);if(!vS(t,e))throw new Error(`Invalid dimension name: ${JSON.stringify(t)}`);return t}function Md(n,e=!1){let t=ge(n,r=>XW(r,e));if(!_c(t,e))throw new Error(`Invalid dimensions: ${JSON.stringify(t)}`);return t}var Vc=class{constructor(e,t){this.combined=e;this.bindings=new Set;this.retainCount=0;this.prevCombined=this.combined.value;this.dimensionRefCounts=new Map;this.handleCombinedChanged=()=>{this.combined.value!==this.prevCombined&&this.update()};this.includeDimensionPredicate_=t}getRenameValidity(e){let t=this.combined.value.names,r=Ad(e),i=e.length;for(let a=0;a<i;++a){if(!r[a])continue;let o=e[a];if(t.includes(o))continue;let l=!0;for(let c of this.bindings)if(c.space.value.names.includes(o)){l=!1;break}r[a]=l}return r}get includeDimensionPredicate(){return this.includeDimensionPredicate_}set includeDimensionPredicate(e){this.includeDimensionPredicate_=e,this.update()}update(){let{combined:e,bindings:t}=this,r=this.retainCount>0?1:0;if(t.size===0&&!r){e.value=Xr;return}let i=this.includeDimensionPredicate_,a=e.value,o=Array.from(a.names),l=Array.from(a.units),c=Array.from(a.scales),d=Array.from(a.ids),p=Array.from(a.timestamps),h=a.names.map(()=>r?1:0),g=[],v=!1;for(let D of t){let{space:{value:E},prevValue:V,mappedDimensionIds:O}=D;v=v||E.valid;let{names:B,units:z,scales:_,ids:F,timestamps:N}=E,J=[],ae=[];g.push(ae),D.mappedDimensionIds=J,D.prevValue=E;let pe=B.length;for(let me=0;me<pe;++me){let Ae=B[me];if(!i(Ae))continue;if(V!==void 0){let _e=F[me],Fe=V.ids.indexOf(_e);if(Fe!==-1){let rt=O[Fe];if(rt!==void 0){let ye=d.indexOf(rt);if(ye!==-1){J[me]=rt,++h[ye],ae[me]=ye;let Le=N[me];Le!==void 0&&!(Le<=p[ye])&&(o[ye]=Ae,c[ye]=_[me],l[ye]=z[me],p[ye]=Le);continue}}}}let le=o.indexOf(Ae);if(le!==-1){J[me]=d[le],++h[le],ae[me]=le;continue}le=o.length,ae[me]=le,h[le]=1+r,o[le]=Ae,l[le]=z[me],c[le]=_[me],p[le]=N[me];let we=Xs();d[le]=we,J[me]=we}}let{dimensionRefCounts:b}=this;b.clear();let x=0,C=o.length;for(let D of t){let{space:{value:E}}=D,V=g[x++],{rank:O}=E,B=Array.from(E.names),z=Array.from(E.timestamps),_=Float64Array.from(E.scales),F=Array.from(E.units);for(let N=0;N<O;++N){let J=V[N];J!==void 0&&(F[N]=l[J],_[N]=c[J],z[N]=p[J],B[N]=o[J])}for(let N of B){let J=b.get(N);J===void 0?J=1:++J,b.set(N,J)}if(!xe(F,E.units)||!xe(_,E.scales)||!xe(B,E.names)||!xe(z,E.timestamps)){let N=Oe({valid:E.valid,ids:E.ids,scales:_,units:F,names:B,timestamps:z,boundingBoxes:E.boundingBoxes,coordinateArrays:E.coordinateArrays});D.prevValue=N,D.space.value=N}}{for(let E=0;E<C;++E)i(o[E])||(h[E]=0);let D=(E,V)=>h[V]!==0;o=o.filter(D),l=l.filter(D),c=c.filter(D),d=d.filter(D),p=p.filter(D),h=h.filter(D),C=o.length}let T=[],P=new Array(C);for(let D=0,E=a.rank;D<E;++D){let V=a.coordinateArrays[D];if(!(V==null?void 0:V.explicit))continue;let O=d.indexOf(a.ids[D]);O!==-1&&(P[O]=[V])}for(let D of t){let{space:{value:E}}=D,{rank:V,boundingBoxes:O,coordinateArrays:B}=E,z=E.names.map(_=>o.indexOf(_));for(let _ of O)T.push(jW(_,C,z));for(let _=0;_<V;++_){let F=B[_];if(F===void 0)continue;let N=z[_],J=P[N];J===void 0?P[N]=[F]:J.push(F)}}let I=new Array(C);for(let D=0;D<C;++D){let E=P[D];E!==void 0&&(I[D]=XE(E))}let M=Oe({valid:v,ids:d,names:o,units:l,scales:new Float64Array(c),boundingBoxes:T,coordinateArrays:I});if(r)for(let D=0;D<C;++D)--h[D];Th(a,M)||(this.prevCombined=M,e.value=M)}retain(){return++this.retainCount,()=>{--this.retainCount==0&&this.update()}}bind(e){let t={space:e,mappedDimensionIds:[],prevValue:void 0},{bindings:r}=this;r.size===0&&this.combined.changed.add(this.handleCombinedChanged),r.add(t);let i=e.changed.add(()=>{e.value!==t.prevValue&&this.update()}),a=()=>{i();let{bindings:o}=this;o.delete(t),o.size===0&&this.combined.changed.remove(this.handleCombinedChanged),this.update()};return this.update(),a}};function kh(n,e,t,r,i){let a=i.length,o=new n((a+1)**2);o[o.length-1]=1;for(let l=0;l<a;++l){let c=r[l];o[(a+1)*a+l]=e[(t+1)*t+c];for(let d=0;d<a;++d){let p=i[d];o[(a+1)*d+l]=e[(t+1)*p+c]}}return o}function oD(n){if(n===void 0)return;let e=new Float64Array(16);if(Array.isArray(n))if(n.length===16)for(let t=0;t<4;++t)for(let r=0;r<4;++r)e[t*4+r]=Ke(n[r*4+t]);else{jr(n,4);for(let t=0;t<4;++t){let r=jr(n[t],4);for(let i=0;i<4;++i)e[i*4+t]=Ke(r[i])}}else{Q(n);let t=Qe.create(),r=K.create(),i=K.fromValues(1,1,1);ie(n,"rotation",o=>{Tc(t,o),Qe.normalize(t,t)}),ie(n,"translation",o=>{Tc(r,o)}),ie(n,"scale",o=>{Tc(i,o)});let a=oe.create();oe.fromRotationTranslationScale(a,t,r,i),e.set(a)}return{sourceRank:3,transform:e,outputSpace:Oe({valid:!0,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)}),inputSpace:void 0}}function bS(n){if(n===void 0)return;let e=Q(n),t=U(e,"outputDimensions",Qs),r=t.rank,i=U(e,"sourceRank",l=>{if(l===void 0)return r;if(!Number.isInteger(l)||l<0||l>r)throw new Error(`Expected integer in range [0, ${r}] but received: ${JSON.stringify(l)}`);return l}),a=ie(e,"inputDimensions",l=>{let c=Qs(l,!0);if(c.rank!==r)throw new Error(`Expected rank of ${r}, but received rank of: ${c.rank}`);return c});return{transform:ie(e,"matrix",l=>{let c=new Float64Array((r+1)**2),d=jr(l,r);c[c.length-1]=1;for(let p=0;p<r;++p)try{let h=jr(d[p],r+1);for(let g=0;g<=r;++g)c[(r+1)*g+p]=Ke(h[g])}catch(h){throw new Error(`Error in row ${p}: ${h.message}`)}return c}),outputSpace:t,inputSpace:a,sourceRank:i}}function xS(n){if(n===void 0)return;let{transform:e,outputSpace:t,inputSpace:r,sourceRank:i}=n,a,o=t.rank;if(e!==void 0){a=[];for(let l=0;l<o;++l){let c=[];a[l]=c;for(let d=0;d<=o;++d)c[d]=e[(o+1)*d+l]}}return{sourceRank:i===o?void 0:i,matrix:a,outputDimensions:pS(t),inputDimensions:r===void 0?void 0:pS(r)}}function QW(n,e,t){let{box:r,transform:i}=n,a=n.box.lowerBounds.length,o=e.length,l=new Float64Array((a+1)*o);if(KE(l,o,i,t,e,a+1),!l.every(c=>c===0))return{transform:l,box:r}}function Eh(n,e){let{ids:t,names:r,scales:i,units:a,timestamps:o,coordinateArrays:l}=n;return Oe({rank:e.length,valid:n.valid,ids:e.map(c=>t[c]),names:e.map(c=>r[c]),timestamps:e.map(c=>o[c]),scales:Float64Array.from(e,c=>i[c]),units:e.map(c=>a[c]),coordinateArrays:e.map(c=>l[c]),boundingBoxes:n.boundingBoxes.map(c=>QW(c,e,n.rank)).filter(c=>c!==void 0)})}function Dh(n,e,t){return e===t?n:Eh(n,JL(n.rank,t,e))}function CS(n,e){let{transform:t,rank:r}=n,i=js(t,r,[e]);if(i.length!==1)return;let[a]=i,o=Math.abs(t[(r+1)*a+e]),{inputSpace:l}=n;return{scale:l.scales[a]*o,unit:l.units[a]}}function wS(n,e){let{scales:t,units:r}=n.defaultInputSpace;return e<t.length?{scale:t[e],unit:r[e]}:void 0}var rK={channelCoordinateSpace:_i,shape:new Uint32Array(0),numChannels:1,coordinates:new Uint32Array(0)};function sD(n){let{rank:e}=n,{bounds:{lowerBounds:t,upperBounds:r}}=n;if(t.some(l=>l!==0))throw new Error("Lower bounds of channel coordinate space must all be 0");if(r.some(l=>!Number.isInteger(l)||l<=0||l>=2**32))throw new Error("Upper bounds of channel coordinate space must all be positive integers");let i=new Uint32Array(r),a=Ic(i),o=new Uint32Array(a*e);for(let l=0;l<a;++l){let c=l;for(let d=0;d<e;++d){let p=c%i[d];c=(c-p)/i[d],o[l*e+d]=p}}return{channelCoordinateSpace:n,shape:i,numChannels:a,coordinates:o}}function TS(n,e,t,r,i,a){let{scales:o}=t,{scales:l,rank:c}=i,d=e+1;for(let p=0;p<c;++p){let h=a[p];if(h===-1)continue;let g=l[p];for(let v=0;v<e;++v){let b=r[v],x=o[b];n[d*v+h]*=x/g}}}function ZW(n,e,t,r,i=_i){let{inputSpace:a,rank:o,sourceRank:l,outputSpace:c,transform:d}=t,{names:p}=a,{names:h}=c,g;if(r!==void 0)g=Array.from(r.modelSubspaceDimensionIndices);else{g=[];for(let z=0;z<l;++z)g[z]=z}let v=g.length;for(let z=l;z<o;++z)g.push(z);let b=js(t.transform,o,g,!0),x=g.length,C=g.map(z=>p[z]||`${z}`),T=b.map(z=>h[z]);if(x!==b.length)return{error:"Rank mismatch between model subspace dimensions ("+C.join(", ")+") and corresponding layer/global dimensions ("+T.join(", ")+")"};let P=kh(Float32Array,d,o,b,g),I=b.map(z=>h[z]),M=e.names.map(z=>I.indexOf(z)),D=n.names.map(z=>I.indexOf(z));TS(P,x,a,g,n,D),TS(P,x,a,g,e,M);let E=i.names.map(z=>I.indexOf(z));TS(P,x,a,g,i,E);let V=[],O=i.rank;if(r!==void 0){let{subsourceToModelSubspaceTransform:z}=r;v!==x&&(z=Pd(new Float32Array((x+1)**2),x,z,v)),P=ci(new Float32Array((x+1)**2),x+1,P,x+1,z,x+1,x+1,x+1,x+1)}let B=new Uint32Array(O);for(let z=0;z<O;++z){let _=i.bounds.lowerBounds[z],F=i.bounds.upperBounds[z];if(_!==0||!Number.isInteger(F)||F<=0||F>=2**32)return{error:`Channel dimension ${i.names[z]} must have lower bound of 0 and positive integer upper bound`};B[z]=F;let N=E[z],J=-1;if(N!==-1)for(let ae=0;ae<x;++ae){let pe=P[N+ae*(x+1)];if(pe!==0){if(pe!==1||J!==-1)return{error:`Channel dimension ${T[N]} must map to a single source dimension`};J=ae}}V[z]=J}return{rank:x,unpaddedRank:v,modelDimensionNames:C,layerDimensionNames:T,localToRenderLayerDimensions:M,globalToRenderLayerDimensions:D,channelToRenderLayerDimensions:E,modelToRenderLayerTransform:P,channelToModelDimensions:V,channelSpaceShape:B}}function ez(n,e){return n===e?!0:n.error!==void 0||e.error!==void 0?!1:xe(n.modelDimensionNames,e.modelDimensionNames)&&xe(n.layerDimensionNames,e.layerDimensionNames)&&xe(n.globalToRenderLayerDimensions,e.globalToRenderLayerDimensions)&&xe(n.localToRenderLayerDimensions,e.localToRenderLayerDimensions)&&xe(n.channelToRenderLayerDimensions,e.channelToRenderLayerDimensions)&&xe(n.modelToRenderLayerTransform,e.modelToRenderLayerTransform)&&xe(n.channelSpaceShape,e.channelSpaceShape)}function Ph(n,e,t,r,i){return Mt((a,o,l,c)=>ZW(a,o,l,r,c),[n,e,t,i===void 0?Pr(void 0):i],ez)}function lD(n,e,t,r){let{globalToRenderLayerDimensions:i}=t;for(let a=0;a<3;++a){let o=0,l=r[a];if(l!==-1){let c=i[l];c!==-1&&(o=e[c])}n[a]=o}}function cD(n,e,t,r){let{globalToRenderLayerDimensions:i}=t;for(let a=0;a<3;++a){let o=r[a];if(o!==-1){let l=i[o];l!==-1&&(n[l]=e[a])}}}function el(n,e){let t=n.rank,r=n.unpaddedRank,i;r!==t&&e!==void 0&&(e=Pd(new Float32Array((t+1)**2),t,e,r)),e!==void 0?(i=new Float32Array((t+1)*(t+1)),ci(i,t+1,n.modelToRenderLayerTransform,t+1,e,t+1,t+1,t+1,t+1)):i=n.modelToRenderLayerTransform;let a=new Float32Array((t+1)*(t+1)),o=Mc(a,t+1,i,t+1,t+1);if(o===0)throw new Error("Transform is singular");let{globalToRenderLayerDimensions:l,localToRenderLayerDimensions:c,channelToRenderLayerDimensions:d}=n,p=l.length,h=c.length,g=p+h,v=new Float32Array((g+1)*t);for(let D=0;D<t;++D){for(let E=0;E<p;++E){let V=l[E];V!==-1&&(v[D+E*t]=a[D+V*(t+1)])}for(let E=0;E<h;++E){let V=c[E];V!==-1&&(v[D+(p+E)*t]=a[D+V*(t+1)])}v[D+g*t]=a[D+t*(t+1)]}let b=d.length,x=new Array(b),C=[];for(let D=0;D<b;++D){let E=d[D],V=-1;if(E!==-1){for(let O=0;O<t;++O){let B=i[E+O*(t+1)];if(B!==0){if(B!==1||V!==-1)throw new Error(`Channel dimension ${n.layerDimensionNames[E]} must map with stride 1 to a single data chunk dimensions`);V=O}}if(V!==-1){if(i[E+t*(t+1)]!==0)throw new Error(`Channel dimension ${n.layerDimensionNames[E]} must have an offset of 0 in the chunk coordinate space`);C.push(V)}}x[D]=V}let{channelSpaceShape:T}=n,P=Ic(T),I=C.length,M=new Uint32Array(P*I);for(let D=0;D<P;++D){let E=D,V=0;for(let O=0;O<b;++O){let B=E%T[O];E=(E-B)/T[O],x[O]!==-1&&(M[D*I+V]=B,++V)}}return{layerRank:t,modelTransform:n,chunkToLayerTransform:i,layerToChunkTransform:a,chunkToLayerTransformDet:o,combinedGlobalLocalRank:g,combinedGlobalLocalToChunkTransform:v,channelToChunkDimensionIndices:x,chunkChannelDimensionIndices:C,numChannels:P,chunkChannelCoordinates:M,channelSpaceShape:T}}function Ih(n,e){let{globalToRenderLayerDimensions:t}=n,r=[],i=[];for(let a=0;a<3;++a){let o=e[a];if(o==-1)continue;let l=t[o];i.push(l),l!==-1&&r.push(l)}for(let a=i.length;a<3;++a)i[a]=-1;return{layerDisplayDimensionIndices:r,displayToLayerDimensionIndices:i}}function Ah(n,e){let{chunkToLayerTransform:t,modelTransform:r}=n,i=r.rank,{layerDisplayDimensionIndices:a,displayToLayerDimensionIndices:o}=e,l=a.length,c=js(t,i,a);if(c.length!==l){let{modelDimensionNames:h,layerDimensionNames:g}=r;throw new Error(`Rank mismatch between displayed layer dimensions (${Array.from(a,v=>g[v]).join(",\xA0")}) and corresponding chunk dimensions (${Array.from(c,v=>h[v]).join(",\xA0")})`)}let d=oe.create();for(let h=0;h<3;++h){let g=o[h];if(g!==-1){for(let v=0;v<l;++v){let b=c[v];d[v*4+h]=t[b*(i+1)+g]}d[12+h]=t[i*(i+1)+g]}}let p=oe.create();oe.invert(p,d);for(let h=c.length;h<3;++h)c[h]=-1;return{modelTransform:n.modelTransform,chunkTransform:n,displaySubspaceModelMatrix:d,displaySubspaceInvModelMatrix:p,chunkDisplayDimensionIndices:c,numChunkDisplayDims:l}}function Vi(n,e,t,r,i){let a=e.length,o=t.length,l=n.length,c=!0;for(let d=0;d<r;++d){let p=d,h=0;for(let g=0;g<a;++g)h+=i[p+g*r]*e[g];p+=a*r;for(let g=0;g<o;++g)h+=i[p+g*r]*t[g];h+=i[p+o*r],d<l?n[d]=h:(h<0||h>=1)&&(c=!1)}return c}function uD(n,e,t){n.fill(0),n[15]=1;let r=!0,{displayDimensionIndices:i}=e,{globalToRenderLayerDimensions:a,modelToRenderLayerTransform:o}=t,l=t.rank;for(let c=0;c<3;++c){let d=i[c];if(d===-1){r=!1;continue}let p=a[d];if(p===-1){r=!1;continue}n[c+12]=o[p+l*(l+1)];for(let h=0;h<3;++h)n[c+4*h]=o[p+(l+1)*h]}if(!r){let{globalDimensionNames:c}=e,d=Array.from(i.filter(p=>p!==-1),p=>c[p]).join(",\xA0");throw new Error(`Transform from model dimensions (${t.modelDimensionNames.join(",\xA0")}) to display dimensions (${d}) does not have full rank`)}}var tl=class{constructor(e,t,r){this.size=K.clone(e),this.transform=oe.clone(t),this.finiteRank=r;let i=oe.create(),a=Mc(i,4,t,4,4);if(a===0)throw new Error("Transform is singular");this.invTransform=i,this.detTransform=a}toObject(){return{size:this.size,transform:this.transform,finiteRank:this.finiteRank}}static fromObject(e){return new tl(e.size,e.transform,e.finiteRank)}globalToLocalSpatial(e,t){return K.transformMat4(e,t,this.invTransform)}localSpatialVectorToGlobal(e,t){return gE(e,t,this.transform)}globalToLocalNormal(e,t){return Xf(e,t,this.transform)}};var dD=class{constructor(){this.name="CancellationError";this.message="CANCELED"}toString(){return"CANCELED"}},zo=new dD;function pD(n){if(n.isCanceled===!0)throw zo}var LS=()=>{},St={isCanceled:!1,add:()=>LS,remove:LS},Qa=class{cancel(){let{handlers:e}=this;if(e!==null&&(this.handlers=null,e!==void 0))for(let t of e)t()}get isCanceled(){return this.handlers===null}add(e){let{handlers:t}=this;return t===null?(e(),LS):(t===void 0&&(t=this.handlers=new Set),t.add(e),()=>{this.remove(e)})}remove(e){let{handlers:t}=this;t!=null&&t.delete(e)}},kS=class extends Qa{constructor(){super(...arguments);this.consumers=new Set}addConsumer(e=St){let{consumers:t}=this;t.has(e)||e.isCanceled||(t.add(e),e.add(()=>{t.delete(e),t.size===0&&this.cancel()}))}};function fD(n,e){return new Promise((t,r)=>{if(n===St){e(t,r,St);return}let i=new Qa,a=n.add(()=>{i.cancel()});e(o=>{a(),t(o)},o=>{a(),r(o)},i)})}var Mh=!(typeof Window!="undefined"&&self instanceof Window),hD=!1,mD=!1,ES="rpc.promise.response",gD="rpc.promise.cancel",yD=new Map;function Lt(n,e){yD.set(n,e)}var vD=class extends Error{constructor(e,t){super(t);this.name=e;this.message=t}};function Rh(n,e){Lt(n,function(t){let r=t.id,i=new Qa,a=e.call(this,t,i);this.set(r,{promise:a,cancellationToken:i}),a.then(({value:o,transfers:l})=>{this.delete(r),this.invoke(ES,{id:r,value:o},l)},o=>{this.delete(r),this.invoke(ES,{id:r,error:o.message,errorName:o.name})})})}Lt(gD,function(n){let e=n.id,t=this.get(e);if(t!==void 0){let{cancellationToken:r}=t;r.cancel()}});Lt(ES,function(n){let e=n.id,{resolve:t,reject:r}=this.get(e);this.delete(e),n.hasOwnProperty("value")?t(n.value):n.errorName===zo.name?r(zo):r(new vD(n.errorName,n.error))});var tz=Mh?-1:0,DS=class{constructor(e){this.target=e;this.objects=new Map;this.nextId=tz;e.onmessage=t=>{let r=t.data;mD&&console.log("Received message",r),yD.get(r.functionName).call(this,r)}}get numObjects(){return this.objects.size}set(e,t){this.objects.set(e,t)}delete(e){this.objects.delete(e)}get(e){return this.objects.get(e)}getRef(e){let t=e.id,r=this.get(t);return r.referencedGeneration=e.gen,r.addRef(),r}getOptionalRef(e){if(e===void 0)return;let t=e.id,r=this.get(t);return r.referencedGeneration=e.gen,r.addRef(),r}invoke(e,t,r){t.functionName=e,mD&&console.trace("Sending message",t),this.target.postMessage(t,r)}promiseInvoke(e,t,r=St,i){return fD(r,(a,o,l)=>{let c=t.id=this.newId();this.set(c,{resolve:a,reject:o}),this.invoke(e,t,i),l.add(()=>{this.invoke(gD,{id:c})})})}newId(){return Mh?this.nextId--:this.nextId++}},Cn=class extends H{constructor(){super(...arguments);this.rpc=null;this.rpcId=null}initializeSharedObject(e,t=e.newId()){this.rpc=e,this.rpcId=t,this.isOwner=!1,e.set(t,this)}initializeCounterpart(e,t={}){this.initializeSharedObject(e),this.unreferencedGeneration=0,this.referencedGeneration=0,this.isOwner=!0,t.id=this.rpcId,t.type=this.RPC_TYPE_ID,e.invoke("SharedObject.new",t)}dispose(){super.dispose()}addCounterpartRef(){return{id:this.rpcId,gen:++this.referencedGeneration}}refCountReachedZero(){this.isOwner===!0?this.referencedGeneration===this.unreferencedGeneration&&this.ownerDispose():this.isOwner===!1?this.rpc.invoke("SharedObject.refCountReachedZero",{id:this.rpcId,gen:this.referencedGeneration}):super.refCountReachedZero()}ownerDispose(){hD&&console.log(`[${Mh}] #rpc object = ${this.rpc.numObjects}`);let{rpc:e,rpcId:t}=this;super.refCountReachedZero(),e.delete(t),e.invoke("SharedObject.dispose",{id:t})}counterpartRefCountReachedZero(e){this.unreferencedGeneration=e,this.refCount===0&&e===this.referencedGeneration&&this.ownerDispose()}};function nz(n,e,t={}){e!=null&&n.initializeSharedObject(e,t.id)}var Za=class extends Cn{constructor(e,t={}){super();nz(this,e,t)}};Lt("SharedObject.dispose",function(n){let e=this.get(n.id);if(e.refCount!==0)throw new Error("Attempted to dispose object with non-zero reference count.");hD&&console.log(`[${Mh}] #rpc objects: ${this.numObjects}`),e.disposed(),this.delete(e.rpcId),e.rpcId=null,e.rpc=null});var rz="Worker";Lt(rz,function(n){let{port:e,path:t}=n;new Worker(t).postMessage({port:e},[e])});Lt("SharedObject.refCountReachedZero",function(n){let e=this.get(n.id),t=n.gen;e.counterpartRefCountReachedZero(t)});var SD=new Map;function wn(n){return e=>{e.prototype.RPC_TYPE_ID=n}}function Ho(n){return e=>{if(n!==void 0)e.prototype.RPC_TYPE_ID=n;else if(n=e.prototype.RPC_TYPE_ID,n===void 0)throw new Error("RPC_TYPE_ID should have already been defined");SD.set(n,e)}}Lt("SharedObject.new",function(n){let e=this,t=n.type,r=SD.get(t),i=new r(e,n);--i.refCount});var _h=!1,iz=!1,az=oe.create();function oz(n,e){let t=0,r=Math.abs(n.detTransform),{transform:i,size:a}=n;for(let o=0;o<3;++o){let l=0;for(let d=0;d<3;++d)l+=e[d*4+2]*i[4*o+d];let c=a[o];t+=Math.abs(l)*c,r*=c}return r/t}function bD(n,e,t){let{curPositionInChunks:r,fixedPositionWithinChunk:i}=n,{nonDisplayLowerClipBound:a,nonDisplayUpperClipBound:o}=n,{rank:l,chunkDataSize:c}=n.source.spec;if(!Vi(r,e,t,n.layerRank,n.fixedLayerToChunkTransform))return!1;for(let d=0;d<l;++d){let p=r[d];if(p<a[d]||p>=o[d])return _h&&console.log("excluding source",n,`because of chunkDim=${d}, sum=${p}`,a,o,n.fixedLayerToChunkTransform),!1;let h=c[d],g=r[d]=Math.floor(p/h);i[d]=p-g*h}return!0}function sz(n,e){let t=e.length,r=0;if(_h&&console.log(e),t>1){let i=0;for(let a=0;a<t;++a){let o=e[a],{chunkLayout:l}=o,c=oz(l,n);_h&&console.log(`chunksize = ${l.size}, sliceArea = ${c}`),c>i&&(i=c,r=a)}}return r}var Oc=new tl(K.create(),oe.create(),0),PS=class extends Dd{constructor(){super(...arguments);this.viewportNormalInGlobalCoordinates=K.create();this.viewportNormalInCanonicalCoordinates=K.create();this.centerDataPosition=K.create();this.pixelSize=0}};function lz(n,e){if(n.displayDimensionRenderInfo!==e.displayDimensionRenderInfo||n.pixelSize!==e.pixelSize)return!0;let{viewMatrix:t}=n,{viewMatrix:r}=e;for(let i=0;i<12;++i)if(t[i]!==r[i])return!0;return!1}var IS=class extends Cn{constructor(e){super();this.projectionParameters=e;this.visibleLayers=new Map;this.visibleSourcesStale=!0;this.registerDisposer(e.changed.add((t,r)=>{lz(t,r)&&this.invalidateVisibleSources(),this.invalidateVisibleChunks()}))}invalidateVisibleSources(){this.visibleSourcesStale=!0}invalidateVisibleChunks(){}updateVisibleSources(){if(!this.visibleSourcesStale)return;this.visibleSourcesStale=!1;let e=this.projectionParameters.value.displayDimensionRenderInfo,{visibleLayers:t}=this;for(let[r,{allSources:i,visibleSources:a,displayDimensionRenderInfo:o}]of t){if(a.length=0,o!==e||i.length===0)continue;let l=sz(this.projectionParameters.value.viewMatrix,i.map(d=>d[0])),c=i[l];for(let d of r.filterVisibleSources(this,c))a.push(d);a.reverse(),_h&&console.log("visible sources chosen",a)}}},AS=18;function Rd(n){let{rank:e,upperVoxelBound:t,maxVoxelsPerChunkLog2:r=AS,chunkToViewTransform:i,displayRank:a,minBlockSize:o,maxBlockSize:l}=n,{lowerVoxelBound:c=new Uint32Array(e)}=n,d=new Float32Array(e);for(let v=0;v<e;++v){let b=0;for(let x=0;x<a;++x){let C=i[v*a+x];b+=C*C}d[v]=Math.sqrt(b)}let p=new Uint32Array(e);o!==void 0?p.set(o):p.fill(1);let h=new Array(e);for(let v=0;v<e;++v){let b=Number.POSITIVE_INFINITY;d[v]===0?b=p[v]:(t!==void 0&&(b=Math.pow(2,Math.floor(Math.log2(t[v]-c[v])))),l!==void 0&&(b=Math.min(b,l[v]))),h[v]=b}function g(){let v=Infinity,b=-1;for(let x=0;x<e;++x){if(p[x]>=h[x])continue;let C=p[x]*d[x];C<v&&(v=C,b=x)}return b}r-=Math.log2(Ic(p));for(let v=0;v<r;++v){let b=g();if(b===-1)break;p[b]*=2}return p}function cz(n){let e=[],{displayRank:t,chunkToViewTransform:r,rank:i}=n;if(t>3)throw new Error("Unsupported view transform");if(t<3)return[Rd(n)];for(let a=0;a<3;++a){let o=(a+2)%3,l=new Float32Array(r);for(let c=0;c<i;++c)l[c*t+o]=0;e[a]=Rd({...n,chunkToViewTransform:l})}return e}var Qr;(function(t){t[t.ISOTROPIC=0]="ISOTROPIC",t[t.FLAT=1]="FLAT"})(Qr||(Qr={}));function xD(n){if(n.chunkDataSizes!==void 0)return n.chunkDataSizes;let{chunkLayoutPreference:e=0}=n;switch(e){case 0:return[Rd(n)];case 1:return cz(n)}}function $o(n){let{rank:e,chunkDataSize:t,upperVoxelBound:r}=n,{lowerVoxelBound:i=new Float32Array(e)}=n,a=new Float32Array(e),o=new Float32Array(e);for(let l=0;l<e;++l)a[l]=Math.floor(i[l]/t[l]),o[l]=Math.floor((r[l]-1)/t[l]+1);return{rank:e,chunkDataSize:t,lowerChunkBound:a,upperChunkBound:o,lowerVoxelBound:i,upperVoxelBound:r}}function*CD(n,e,t){let r=n.projectionParameters.value.pixelSize*1.1,i=t[0].effectiveVoxelSize,a=e.renderScaleTarget.value,o=p=>{let h=r*a;for(let g=0;g<3;++g){let v=p[g];if(v>h&&v>1.01*i[g])return!0}return!1},l=(p,h)=>{let g=r*a;for(let v=0;v<3;++v){let b=p[v],x=h[v];if(Math.abs(g-b)<Math.abs(g-x)&&b<1.01*x)return!0}return!1},c=t.length-1,d;for(;;){let p=t[c];if(d!==void 0&&!l(p.effectiveVoxelSize,d)||(yield p,c===0||!o(p.effectiveVoxelSize)))break;d=p.effectiveVoxelSize,--c}}var wD="SliceView",TD="sliceview/RenderLayer",LD="SliceView.addVisibleLayer",kD="SliceView.removeVisibleLayer",MS=new Float32Array(3),RS=new Float32Array(3),ED=oe.create(),DD=new Float32Array(24);function PD(n,e,t,r){let i=MS,a=RS,{lowerChunkDisplayBound:o,upperChunkDisplayBound:l}=e;for(let h=0;h<3;++h)i[h]=Math.max(i[h],o[h]),a[h]=Math.min(a[h],l[h]);let{curPositionInChunks:c,chunkDisplayDimensionIndices:d}=e;function p(){if(!r(i[0],i[1],i[2],a[0],a[1],a[2],n))return;let h=0,g=Math.max(0,a[0]-i[0]),v=g;for(let T=1;T<3;++T){let P=Math.max(0,a[T]-i[T]);v*=P,P>g&&(g=P,h=T)}if(v===0)return;if(v===1){c[d[0]]=i[0],c[d[1]]=i[1],c[d[2]]=i[2],t(i,n);return}let b=i[h],x=a[h],C=Math.floor(.5*(b+x));a[h]=C,p(),a[h]=x,i[h]=C,p(),i[h]=b}p()}function Vh(n,e,t,r){if(!bD(t,n.globalPosition,e))return;let{size:i}=t.chunkLayout,a=oe.multiply(ED,n.viewProjectionMat,t.chunkLayout.transform);for(let d=0;d<3;++d){let p=i[d];for(let h=0;h<4;++h)a[4*d+h]*=p}let o=DD;$s(o,a);let l=MS,c=RS;l.fill(Number.NEGATIVE_INFINITY),c.fill(Number.POSITIVE_INFINITY),PD(o,t,r,Qf)}function ID(n,e,t,r,i){if(!bD(t,n.globalPosition,e))return;let{size:a}=r,o=oe.multiply(ED,n.viewProjectionMat,r.transform);for(let g=0;g<3;++g){let v=a[g];for(let b=0;b<4;++b)o[4*g+b]*=v}let l=az;oe.invert(l,o);let c=MS,d=RS,p=.001;for(let g=0;g<3;++g){let v=l[12+g]+p/a[g],b=Math.abs(l[g]),x=Math.abs(l[4+g]);c[g]=Math.floor(v-b-x),d[g]=Math.floor(v+b+x+1)}let h=DD;for(let g=0;g<3;++g){let v=o[4*g],b=o[4*g+1],x=o[4*g+2];h[g]=v,h[4+g]=-v,h[8+g]=+b,h[12+g]=-b,h[16+g]=+x,h[20+g]=-x}{let g=3,v=o[4*g],b=o[4*g+1],x=o[4*g+2];h[g]=1+v,h[4+g]=1-v,h[8+g]=1+b,h[12+g]=1-b,h[16+g]=x,h[20+g]=-x}iz&&(console.log("clippingPlanes",h),console.log("modelViewProjection",o.join(",")),console.log(`lower=${c.join(",")}, upper=${d.join(",")}`)),PD(h,t,i,vE)}function Nc(n,e){let{finiteRank:t}=e;if(t===3)return e;Oc.finiteRank=t,K.copy(Oc.size,e.size);let r=oe.copy(Oc.transform,e.transform),i=oe.copy(Oc.invTransform,e.invTransform);Oc.detTransform=e.detTransform;let{invViewMatrix:a,width:o,height:l}=n,c=Zf(n.projectionMat);for(let d=t;d<3;++d){let p=a[12+d],h=p,g=p,v=Math.abs(a[d]*o);h-=v,g+=v;let b=Math.abs(a[d+4]*l);h-=b,g+=b;let x=Math.abs(a[d+8]*c);h-=x,g+=x;let C=Math.max(1,g-h);r[12+d]=h,r[5*d]=C}return oe.invert(i,r),Oc}var AD="annotation.MetadataChunkSource",MD="annotation.GeometryChunkSource",RD="annotation.SubsetGeometryChunkSource",_D="annotation.reference.add",VD="annotation.reference.delete",OD="annotation.commit",ND="annotation.commit",BD="annotation/SpatiallyIndexedRenderLayer",FD="annotation/PerspectiveRenderLayer:updateSources",UD="annotation/RenderLayer",GD="annotation/RenderLayer.updateSegmentation",uz=It.create();function _S(n,e,t,r,i,a){let{displayDimensionRenderInfo:o,viewMatrix:l,projectionMat:c,width:d,height:p}=n,{voxelPhysicalScales:h}=o,g=Math.abs(It.determinant(Hs(uz,l))),v=yd(h),b=SE(c)/g*v;if(r.length===0)return;let x=r[0],C=Math.abs(x.chunkLayout.detTransform)*v,{lowerClipDisplayBound:T,upperClipDisplayBound:P}=x;for(let O=0;O<3;++O)C*=P[O]-T[O];let I=Math.min(C,b),M=d*p,E=M/t**2/I,V=0;for(let O=r.length-1;O>=0&&V<E;--O){let B=r[O],z=B.source.spec,{chunkLayout:_}=B,F=yd(_.size)*Math.abs(_.detTransform)*v,{limit:N,rank:J}=z,{nonDisplayLowerClipBound:ae,nonDisplayUpperClipBound:pe}=B,me=1;for(let Le=0;Le<J;++Le){let je=pe[Le]-ae[Le];Number.isFinite(je)&&(me/=je)}let Ae=N*me/F,le=!0,we=V+Ae,_e=Math.pow(1/we,1/3),Fe=Math.sqrt(M/(we*I)),rt=(E-V)*F/me,ye=Math.min(1,rt/z.limit);Vh(n,e,B,()=>{le&&(i(B,O),le=!1),a(B,O,ye,_e,Fe)}),V=we}}var Oi=`vec3 colormapJet(float x) {
  vec3 result;
  result.r = x < 0.89 ? ((x - 0.35) / 0.31) : (1.0 - (x - 0.89) / 0.11 * 0.5);
  result.g = x < 0.64 ? ((x - 0.125) * 4.0) : (1.0 - (x - 0.64) / 0.27);
  result.b = x < 0.34 ? (0.5 + x * 0.5 / 0.11) : (1.0 - (x - 0.34) / 0.31);
  return clamp(result, 0.0, 1.0);
}
vec3 colormapCubehelix(float x) {
  float xclamp = clamp(x, 0.0, 1.0);
  float angle = 2.0 * 3.1415926 * (4.0 / 3.0 + xclamp);
  float amp = xclamp * (1.0 - xclamp) / 2.0;
  vec3 result;
  float cosangle = cos(angle);
  float sinangle = sin(angle);
  result.r = -0.14861 * cosangle + 1.78277 * sinangle;
  result.g = -0.29227 * cosangle + -0.90649 * sinangle;
  result.b = 1.97294 * cosangle;
  result = clamp(xclamp + amp * result, 0.0, 1.0);
  return result;
}
`;var WD=Symbol("objectId"),dz=0;function lt(n){if(n instanceof Object){let e=n[WD];return e===void 0&&(e=n[WD]=dz++),`o${e}`}else return""+JSON.stringify(n)}var VS=!1,OS;(function(t){t[t.VERTEX=WebGL2RenderingContext.VERTEX_SHADER]="VERTEX",t[t.FRAGMENT=WebGL2RenderingContext.FRAGMENT_SHADER]="FRAGMENT"})(OS||(OS={}));function pz(n){n=n.replace("\0","");let e=[];for(let t of n.split(`
`)){let r=t.match(/^ERROR:\s*(\d+):(\d+)\s*(.+)$/);r!==null?e.push({message:r[3].trim(),file:parseInt(r[1],10),line:parseInt(r[2],10)}):(r=t.match(/^ERROR:\s*(.+)$/),r!==null?e.push({message:r[1]}):(t=t.trim(),t&&e.push({message:t})))}return e}var zD=class extends Error{constructor(e,t,r,i){let a=`Error compiling ${OS[e].toLowerCase()} shader: ${r}`;super(a);this.name="ShaderCompilationError",this.log=r,this.message=a,this.shaderType=e,this.source=t,this.errorMessages=i}},HD=class extends Error{constructor(e,t,r){let i=`Error linking shader: ${r}`;super(i);this.name="ShaderLinkError",this.log=r,this.message=i,this.vertexSource=e,this.fragmentSource=t}};function $D(n,e,t){var r=n.createShader(t);if(n.shaderSource(r,e),n.compileShader(r),!n.getShaderParameter(r,n.COMPILE_STATUS)){let i=n.getShaderInfoLog(r)||"";if(VS){let a=e.replace("<","&lt;").replace(">","&gt;").split(`
`),o="<pre>";o+=i.replace("<","&lt;").replace(">","&gt;")+`
`,a.forEach((c,d)=>{o+=`${d+1}: ${c}
`}),o+=`
</pre>`,console.log(o);let l=window.open("about:blank","_blank");if(l!==null)try{l.document.write(o)}catch(c){}}throw new zD(t,e,i,pz(i))}return r}var _d,jD=class extends H{constructor(e,t,r,i,a,o){super();this.gl=e;this.vertexSource=t;this.fragmentSource=r;this.attributes=new Map;this.uniforms=new Map;this.vertexShaderInputBinders={};let l=this.vertexShader=$D(e,t,e.VERTEX_SHADER),c=this.fragmentShader=$D(e,r,e.FRAGMENT_SHADER),d=e.createProgram();if(e.attachShader(d,l),e.attachShader(d,c),VS&&(o==null?void 0:o.length)&&(e.transformFeedbackVaryings(d,o.map(g=>g.name),WebGL2RenderingContext.INTERLEAVED_ATTRIBS),this.vertexDebugOutputs=o),e.linkProgram(d),!e.getProgramParameter(d,e.LINK_STATUS)){let g=e.getProgramInfoLog(d)||"";throw new HD(t,r,g)}this.program=d;let{uniforms:p,attributes:h}=this;if(i)for(let g of i)p.set(g,e.getUniformLocation(d,g));if(a)for(let g of a)h.set(g,e.getAttribLocation(d,g))}uniform(e){return this.uniforms.get(e)}attribute(e){return this.attributes.get(e)}textureUnit(e){return this.textureUnits.get(e)}bind(){_d=this,this.gl.useProgram(this.program)}disposed(){let{gl:e}=this;e.deleteShader(this.vertexShader),this.vertexShader=void 0,e.deleteShader(this.fragmentShader),this.fragmentShader=void 0,e.deleteProgram(this.program),this.program=void 0,this.gl=void 0,this.attributes=void 0,this.uniforms=void 0}};function JD(n,e,t,r,i){if(n.drawArraysInstanced(e,t,r,i),!VS||!(_d==null?void 0:_d.vertexDebugOutputs))return;let{vertexDebugOutputs:a}=_d,o=0;for(let g of a)o+=fz[g.typeName];let l=n.createBuffer(),c=o*r*i;n.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,l),n.bufferData(WebGL2RenderingContext.ARRAY_BUFFER,c,WebGL2RenderingContext.DYNAMIC_DRAW),n.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,null),n.bindBufferBase(WebGL2RenderingContext.TRANSFORM_FEEDBACK_BUFFER,0,l),n.beginTransformFeedback(WebGL2RenderingContext.POINTS),n.enable(WebGL2RenderingContext.RASTERIZER_DISCARD),n.drawArraysInstanced(WebGL2RenderingContext.POINTS,t,r,i),n.disable(WebGL2RenderingContext.RASTERIZER_DISCARD),n.endTransformFeedback(),n.bindBufferBase(WebGL2RenderingContext.TRANSFORM_FEEDBACK_BUFFER,0,null),n.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,l);let d=new Uint8Array(c);n.getBufferSubData(WebGL2RenderingContext.ARRAY_BUFFER,0,d,0,c),n.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,null),n.deleteBuffer(l);let p=0,h=new Float32Array(d.buffer);for(let g=0;g<i;++g)for(let v=0;v<r;++v){let b=`i=${g} v=${v}:`;for(let x of a)switch(b+=` ${x.name}=`,x.typeName){case"float":b+=`${h[p++]}`;break;case"vec2":b+=`${h[p++]},${h[p++]}`;break;case"vec3":b+=`${h[p++]},${h[p++]},${h[p++]}`;break;case"vec4":b+=`${h[p++]},${h[p++]},${h[p++]},${h[p++]}`;break}console.log(b)}}var NS=class{constructor(){this.code="";this.parts=new Set}add(e){if(!this.parts.has(e))switch(this.parts.add(e),typeof e){case"string":this.code+=e;break;case"function":this.add(e());break;default:if(Array.isArray(e))for(let t of e)this.add(t);else throw console.log("Invalid code type",e),new Error("Invalid code type")}}toString(){return this.code}},jo={sampler2D:WebGL2RenderingContext.TEXTURE_2D,isampler2D:WebGL2RenderingContext.TEXTURE_2D,usampler2D:WebGL2RenderingContext.TEXTURE_2D,sampler3D:WebGL2RenderingContext.TEXTURE_3D,isampler3D:WebGL2RenderingContext.TEXTURE_3D,usampler3D:WebGL2RenderingContext.TEXTURE_3D},fz={float:4,vec2:8,vec3:12,vec4:16},gr=class{constructor(e){this.gl=e;this.nextSymbolID=0;this.nextTextureUnit=0;this.uniformsCode="";this.attributesCode="";this.varyingsCodeVS="";this.varyingsCodeFS="";this.fragmentExtensionsSet=new Set;this.fragmentExtensions="";this.vertexCode=new NS;this.vertexMain="";this.fragmentCode=new NS;this.outputBufferCode="";this.fragmentMain="";this.required=new Set;this.uniforms=new Array;this.attributes=new Array;this.initializers=[];this.textureUnits=new Map;this.vertexDebugOutputs=[]}addVertexPositionDebugOutput(){this.vertexDebugOutputs.push({typeName:"vec4",name:"gl_Position"})}addVertexDebugOutput(e,t){this.addVarying(e,t),this.vertexDebugOutputs.push({typeName:e,name:t})}allocateTextureUnit(e,t=1){if(this.textureUnits.has(e))throw new Error("Duplicate texture unit symbol: "+e.toString());let r=this.nextTextureUnit;return this.nextTextureUnit+=t,this.textureUnits.set(e,r),r}addTextureSampler(e,t,r,i){let a=this.allocateTextureUnit(r,i);return this.addUniform(`highp ${e}`,t,i),this.addInitializer(o=>{if(i){let l=new Int32Array(i);for(let c=0;c<i;++c)l[c]=c+a;o.gl.uniform1iv(o.uniform(t),l)}else o.gl.uniform1i(o.uniform(t),a)}),a}symbol(e){return e+this.nextSymbolID++}addAttribute(e,t,r){return this.attributes.push(t),r!==void 0&&(this.attributesCode+=`layout(location = ${r})`),this.attributesCode+=`in ${e} ${t};
`,t}addVarying(e,t,r=""){this.varyingsCodeVS+=`${r} out ${e} ${t};
`,this.varyingsCodeFS+=`${r} in ${e} ${t};
`}addOutputBuffer(e,t,r){r!==null&&(this.outputBufferCode+=`layout(location = ${r}) `),this.outputBufferCode+=`out ${e} ${t};
`}addUniform(e,t,r){return this.uniforms.push(t),r!=null?this.uniformsCode+=`uniform ${e} ${t}[${r}];
`:this.uniformsCode+=`uniform ${e} ${t};
`,t}addFragmentExtension(e){this.fragmentExtensionsSet.has(e)||(this.fragmentExtensionsSet.add(e),this.fragmentExtensions+=`#extension ${e} : require
`)}addVertexCode(e){this.vertexCode.add(e)}addFragmentCode(e){this.fragmentCode.add(e)}setVertexMain(e){this.vertexMain=e}addVertexMain(e){this.vertexMain=(this.vertexMain||"")+e}setFragmentMain(e){this.fragmentMain=`void main() {
${e}
}
`}setFragmentMainFunction(e){this.fragmentMain=e}addInitializer(e){this.initializers.push(e)}require(e){this.required.has(e)||(this.required.add(e),e(this))}build(){let e=`#version 300 es
precision highp float;
precision highp int;
${this.uniformsCode}
${this.attributesCode}
${this.varyingsCodeVS}
${this.vertexCode}
void main() {
${this.vertexMain}
}
`,t=`#version 300 es
${this.fragmentExtensions}
precision highp float;
precision highp int;
${this.uniformsCode}
${this.varyingsCodeFS}
${this.outputBufferCode}
${this.fragmentCode}
${this.fragmentMain}
`,r=new jD(this.gl,e,t,this.uniforms,this.attributes,this.vertexDebugOutputs);r.textureUnits=this.textureUnits;let{initializers:i}=this;if(i.length>0){r.bind();for(let a of i)a(r)}return r}};function ga(){return new ke(void 0)}function Jo(n){return new Ce(n,Z)}function Vd(n,e,t){let r=new Map,{parameters:i,fallbackParameters:a,shaderError:o,encodeParameters:l=C=>C,extraParameters:c=Pr(void 0),encodeExtraParameters:d=C=>C,getContextKey:p,defineShader:h}=t;o!==void 0&&(o.value=void 0);let{encodeContext:g=p}=t,v=xn(t.memoizeKey);function b(C,T,P){let I=JSON.stringify({id:v,context:g(C),parameters:l(T),extraParameters:d(P)});return e.memoize.get(I,()=>{let M=new gr(e);return h(M,C,T,P),M.build()})}function x(C){let T=p(C),P=r.get(T);P===void 0&&(P={parametersGeneration:-1,extraParametersGeneration:-1,shader:null,fallback:!1,parameters:i.value,extraParameters:c.value},r.set(T,P));let I=i.changed.count,M=c.changed.count;if(I===P.parametersGeneration&&M===P.extraParametersGeneration)return P;let D=P.parameters=i.value,E=P.extraParameters=c.value,V=P.shader;P.parametersGeneration=I,P.extraParametersGeneration=M;let O=null;try{O=b(C,D,E),P.fallback=!1,a!==void 0&&(a.value=D),o!==void 0&&(o.value=null)}catch(B){if(o!==void 0&&(o.value=B),a!==void 0)try{let z=a.value;O=b(C,z,E),P.parameters=z,P.fallback=!0}catch{}}return V!==null&&V.dispose(),P.shader=O,P}return n.registerDisposer(()=>{for(let C of r.values()){let{shader:T}=C;T!==null&&T.dispose()}}),x}function Zr(n,e,t){return Vd(n,e,{...t,getContextKey:r=>r,encodeContext:r=>lt(r),defineShader:(r,i,a,o)=>(r.require(i),t.defineShader(r,a,o))})}function Ni(n,e=1,t=0){return`
#line ${t} ${e}
`+n}var qD=`
float mixLinear(float x, float y, float a) { return mix(x, y, a); }
`,YD=`
vec3 hueToRgb(float hue) {
  float hue6 = hue * 6.0;
  float r = abs(hue6 - 3.0) - 1.0;
  float g = 2.0 - abs(hue6 - 2.0);
  float b = 2.0 - abs(hue6 - 4.0);
  return clamp(vec3(r, g, b), 0.0, 1.0);
}
vec3 hsvToRgb(vec3 c) {
  vec3 hueRgb = hueToRgb(c.x);
  return c.z * ((hueRgb - 1.0) * c.y + 1.0);
}
`,At=`
struct uint64_t {
  highp uvec2 value;
};
struct uint64x2_t {
  highp uvec4 value;
};
uint64_t mixLinear(uint64_t x, uint64_t y, float a) {
  return x;
}
uint64_t toUint64(uint64_t x) { return x; }
`,KD=[At,`
uint64_t unpackUint64leFromUint32(highp uvec2 x) {
  uint64_t result;
  result.value = x;
  return result;
}
uint64x2_t unpackUint64leFromUint32(highp uvec4 x) {
  uint64x2_t result;
  result.value = x;
  return result;
}
`],Oh=[At,`
bool equals(uint64_t a, uint64_t b) {
  return a.value == b.value;
}
`],Od=[At,`
bool compareLessThan(uint64_t a, uint64_t b) {
  return (a.value[1] < b.value[1])||
         (a.value[1] == b.value[1] && a.value[0] < b.value[0]);
}
`],BS=[At,`
uint64_t subtract(uint64_t a, uint64_t b) {
  if (a.value[0] < b.value[0]) {
    --a.value[1];
  }
  a.value -= b.value;
  return a;
}
`],hz=[At,`
uint64_t add(uint64_t a, uint64_t b) {
  a.value[0] += b.value[0];
  if (a.value[0] < b.value[0]) {
    ++a.value[1];
  }
  a.value[1] += b.value[1];
  return a;
}
`],XD=[hz,Od,`
uint64_t addSaturate(uint64_t a, uint64_t b) {
  a = add(a, b);
  if (compareLessThan(a, b)) {
    a.value = uvec2(0xffffffffu, 0xffffffffu);
  }
  return a;
}
`],QD=[BS,Od,`
uint64_t subtractSaturate(uint64_t a, uint64_t b) {
  b = subtract(a, b);
  if (compareLessThan(a, b)) {
    b.value = uvec2(0u, 0u);
  }
  return b;
}
`],FS=[At,`
uint64_t shiftRight(uint64_t a, int shift) {
  if (shift >= 32) {
    return uint64_t(uvec2(a.value[1] >> (shift - 32), 0u));
  } else if (shift == 0) {
    return a;
  } else {
    return uint64_t(uvec2((a.value[0] >> shift) | (a.value[1] << (32 - shift)), a.value[1] >> shift));
  }
}
`],ZD=[At,`
uint64_t shiftLeft(uint64_t a, int shift) {
  if (shift >= 32) {
    return uint64_t(uvec2(0u, a.value[0] << (shift - 32)));
  } else if (shift == 0) {
    return a;
  } else {
    return uint64_t(uvec2(a.value[0] << shift, (a.value[1] << shift) | (a.value[0] >> (32 - shift))));
  }
}
`],US=[At,`
struct uint8_t {
  highp uint value;
};
struct uint8x2_t {
  highp uvec2 value;
};
struct uint8x3_t {
  highp uvec3 value;
};
struct uint8x4_t {
  highp uvec4 value;
};
uint8_t mixLinear(uint8_t x, uint8_t y, highp float a) {
  return uint8_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp uint toRaw(uint8_t x) { return x.value; }
highp float toNormalized(uint8_t x) { return float(x.value) / 255.0; }
highp uvec2 toRaw(uint8x2_t x) { return x.value; }
highp vec2 toNormalized(uint8x2_t x) { return vec2(x.value) / 255.0; }
highp uvec3 toRaw(uint8x3_t x) { return x.value; }
vec3 toNormalized(uint8x3_t x) { return vec3(x.value) / 255.0; }
highp uvec4 toRaw(uint8x4_t x) { return x.value; }
vec4 toNormalized(uint8x4_t x) { return vec4(x.value) / 255.0; }
uint64_t toUint64(uint8_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint8_t uint8FromFloat(highp float x) {
  return uint8_t(uint(clamp(x, 0.0, 255.0)));
}
`],GS=[At,`
struct int8_t {
  highp int value;
};
struct int8x2_t {
  highp ivec2 value;
};
struct int8x3_t {
  highp ivec3 value;
};
struct int8x4_t {
  highp ivec4 value;
};
int8_t mixLinear(int8_t x, int8_t y, highp float a) {
  return int8_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int8_t x) { return x.value; }
highp ivec2 toRaw(int8x2_t x) { return x.value; }
highp ivec3 toRaw(int8x3_t x) { return x.value; }
highp ivec4 toRaw(int8x4_t x) { return x.value; }
uint64_t toUint64(int8_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int8_t int8FromFloat(highp float x) {
  return int8_t(int(clamp(x, -128.0, 127.0)));
}
`],Nh=`
highp float toRaw(highp float x) { return x; }
highp float toNormalized(highp float x) { return x; }
vec2 toRaw(vec2 x) { return x; }
vec2 toNormalized(vec2 x) { return x; }
vec3 toRaw(vec3 x) { return x; }
vec3 toNormalized(vec3 x) { return x; }
vec4 toRaw(vec4 x) { return x; }
vec4 toNormalized(vec4 x) { return x; }
`,WS=[At,`
struct uint16_t {
  highp uint value;
};
struct uint16x2_t {
  highp uvec2 value;
};
uint16_t mixLinear(uint16_t x, uint16_t y, highp float a) {
  return uint16_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp uint toRaw(uint16_t x) { return x.value; }
highp float toNormalized(uint16_t x) { return float(toRaw(x)) / 65535.0; }
highp uvec2 toRaw(uint16x2_t x) { return x.value; }
highp vec2 toNormalized(uint16x2_t x) { return vec2(toRaw(x)) / 65535.0; }
uint64_t toUint64(uint16_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint16_t uint16FromFloat(highp float x) {
  return uint16_t(uint(clamp(x, 0.0, 65535.0)));
}
`],zS=[At,`
struct int16_t {
  highp int value;
};
struct int16x2_t {
  highp ivec2 value;
};
int16_t mixLinear(int16_t x, int16_t y, highp float a) {
  return int16_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int16_t x) { return x.value; }
highp ivec2 toRaw(int16x2_t x) { return x.value; }
uint64_t toUint64(int16_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int16_t int16FromFloat(highp float x) {
  return int16_t(int(clamp(x, -32768.0, 32767.0)));
}
`],nl=[At,`
struct uint32_t {
  highp uint value;
};
uint32_t mixLinear(uint32_t x, uint32_t y, highp float a) {
  return uint32_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp float toNormalized(uint32_t x) { return float(x.value) / 4294967295.0; }
highp uint toRaw(uint32_t x) { return x.value; }
uint64_t toUint64(uint32_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint32_t uint32FromFloat(highp float x) {
  return uint32_t(uint(clamp(x, 0.0, 4294967295.0)));
}
`],HS=[At,`
struct int32_t {
  highp int value;
};
int32_t mixLinear(int32_t x, int32_t y, highp float a) {
  return int32_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int32_t x) { return x.value; }
uint64_t toUint64(int32_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int32_t int32FromFloat(highp float x) {
  return int32_t(int(clamp(x, 2147483648.0, 2147483647.0)));
}
`],eP=`
highp int getFortranOrderIndex(ivec3 subscripts, ivec3 size) {
  return subscripts.x + size.x * (subscripts.y + size.y * subscripts.z);
}
`,tP=`
highp uint log2Exact(highp uint i) {
  highp uint r;
  r = uint((i & 0xAAAAAAAAu) != 0u);
  r |= uint((i & 0xFFFF0000u) != 0u) << 4;
  r |= uint((i & 0xFF00FF00u) != 0u) << 3;
  r |= uint((i & 0xF0F0F0F0u) != 0u) << 2;
  r |= uint((i & 0xCCCCCCCCu) != 0u) << 1;
  return r;
}
`,nP=`
bool clipLineToDepthRange(inout highp vec4 a, inout highp vec4 b) {
  highp float tmin = 0.0, tmax = 1.0;
  highp float k1 = b.w - a.w + a.z - b.z;
  highp float k2 = a.w - b.w + a.z - b.z;
  highp float q1 = (a.z - a.w) / k1;
  highp float q2 = (a.z + a.w) / k2;
  if (k1 > 0.0) tmin = max(tmin, q1);
  else if (k1 < 0.0) tmax = min(tmax, q1);
  if (k2 > 0.0) tmax = min(tmax, q2);
  else if (k2 < 0.0) tmin = max(tmin, q2);
  if (tmin <= tmax) {
    highp vec4 tempA = a;
    highp vec4 tempB = b;
    a = mix(tempA, tempB, tmin);
    b = mix(tempA, tempB, tmax);
    return true;
  }
  return false;
}
`,rP=`
highp float simpleFloatHash(highp vec2 co) {
    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
}
`,iP=`
highp uint shiftLeftSaturate(highp uint x, int shiftAmount) {
  highp uint result = x << shiftAmount;
  if ((result >> shiftAmount) != x) return 0xffffffffu;
  return result;
}
`,Bh=`
highp uint addSaturate(highp uint x, highp uint y) {
  highp uint result = x + y;
  if (result < x) return 0xffffffffu;
  return result;
}
`,aP=`
highp uint subtractSaturate(highp uint x, highp uint y) {
  highp uint result = x - y;
  if (result > x) return 0u;
  return result;
}
`,oP=[Bh,`
highp int addSaturate(highp int x, highp uint y) {
  if (x >= 0) {
    return int(min(addSaturate(y, uint(x)), 0x7fffffffu));
  } else if (y >= uint(-x)) {
    return int(min(y - uint(-x), 0x7fffffffu));
  } else {
    return -int(min(uint(-x) - y, 0x80000000u));
  }
}
`],sP=[Bh,`
highp int subtractSaturate(highp int x, highp uint y) {
  if (x < 0) {
    return -int(min(addSaturate(uint(-x), uint(y)), 0x80000000u));
  } else if (uint(x) >= y) {
    return x - int(y);
  } else {
    return -int(min(y - uint(x), 0x80000000u));
  }
}
`];function Ot(n,e=1){switch(n){case W.FLOAT32:if(e===1)return"float";if(e>1&&e<=4)return`vec${e}`;break;case W.UINT8:case W.INT8:case W.UINT16:case W.INT16:case W.UINT32:case W.INT32:case W.UINT64:{let t=wc[n]?"":"u",r=eh[n]*8;if(e===1)return`${t}int${r}_t`;if(e>1&&e*r<=32)return`${t}int${r}x${e}_t`;break}}throw new Error(`No shader type for ${W[n]}[${e}].`)}var rl={[W.UINT8]:US,[W.INT8]:GS,[W.UINT16]:WS,[W.INT16]:zS,[W.UINT32]:nl,[W.INT32]:HS,[W.UINT64]:At,[W.FLOAT32]:Nh};function mz(n,e){return e===1?n:n==="float"?`vec${e}`:`${n[0]}vec${e}`}var gz={[WebGL2RenderingContext.UNSIGNED_BYTE]:1,[WebGL2RenderingContext.BYTE]:1,[WebGL2RenderingContext.UNSIGNED_SHORT]:2,[WebGL2RenderingContext.SHORT]:2,[WebGL2RenderingContext.FLOAT]:4,[WebGL2RenderingContext.INT]:4,[WebGL2RenderingContext.UNSIGNED_INT]:4};function qo(n,e,t,r,i,a,o=1){let l=0,c=a*o;for(;c>0;){let h=Math.min(4,c),g=mz(e,h);c-=h,n.addAttribute("highp "+g,`a${i}${l}`),++l}c=a*o;let d="";for(let h=0;h<o;++h){d+=`highp ${e}[${a}] get${i}${h}() {
  highp ${e}[${a}] result;
`;for(let g=0;g<a;++g){let v=h*a+g,b=Math.floor(v/4),x=v%4;d+=`  result[${g}] = a${i}${b}`,(x!==0||v!==c-1)&&(d+=`[${x}]`),d+=`;
`}d+=`  return result;
`,d+=`}
`}n.addVertexCode(d);let p=gz[t];n.addInitializer(h=>{let g=[];for(let v=0;v<l;++v)g[v]=h.attribute(`a${i}${v}`);h.vertexShaderInputBinders[i]={enable(v){let{gl:b}=h;for(let x=0;x<l;++x){let C=g[x];b.enableVertexAttribArray(C),b.vertexAttribDivisor(C,v)}},disable(){let{gl:v}=h;for(let b=0;b<l;++b){let x=g[b];v.vertexAttribDivisor(x,0),v.disableVertexAttribArray(x)}},bind(v,b){let{gl:x}=h;for(let C=0;C<l;++C){let T=g[C],P=Math.min(4,c-4*C);e==="float"?x.vertexAttribPointer(T,P,t,r,v,b):x.vertexAttribIPointer(T,Math.min(4,c-4*C),t,v,b),b+=p*P}}}})}var $S={[W.UINT8]:"vec2",[W.INT8]:"vec2",[W.UINT16]:"vec2",[W.INT16]:"vec2",[W.FLOAT32]:"vec2",[W.UINT32]:"Uint32LerpParameters",[W.INT32]:"Int32LerpParameters",[W.UINT64]:"Uint64LerpParameters"},Nd={[W.UINT8]:"",[W.INT8]:"",[W.UINT16]:"",[W.INT16]:"",[W.FLOAT32]:"",[W.UINT32]:`
struct Uint32LerpParameters {
  uint offset;
  int shift;
  float multiplier;
};
`,[W.INT32]:`
struct Int32LerpParameters {
  int offset;
  int shift;
  float multiplier;
};
`,[W.UINT64]:[At,`
struct Uint64LerpParameters {
  uint64_t offset;
  int shift;
  float multiplier;
};
`]},lP=`
float computeInvlerp(float inputValue, vec2 p) {
  float outputValue = inputValue;
  outputValue = (outputValue - p[0]) * p[1];
  return outputValue;
}
`;function Fh(n){let t=`
float computeInvlerp(${Ot(n)} inputValue, vec2 p) {
  return computeInvlerp(float(toRaw(inputValue)), p);
}
`;return[rl[n],lP,t]}function cP(n){let e=Ot(n),t=n===W.INT32?"int":"uint",r=$S[n];return[rl[n],Nd[n],`
float computeInvlerp(${t} v, ${r} p) {
  uint x;
  if (v >= p.offset) {
    x = uint(v - p.offset);
  } else {
    x = uint(p.offset - v);
    p.multiplier = -p.multiplier;
  }
  x >>= p.shift;
  return float(x) * p.multiplier;
}
float computeInvlerp(${e} inputValue, ${r} p) {
  return computeInvlerp(toRaw(inputValue), p);
}
`]}var yz={[W.UINT8]:Fh(W.UINT8),[W.INT8]:Fh(W.INT8),[W.UINT16]:Fh(W.UINT16),[W.INT16]:Fh(W.INT16),[W.FLOAT32]:lP,[W.UINT32]:cP(W.UINT32),[W.INT32]:cP(W.INT32),[W.UINT64]:[At,Od,BS,FS,Nd[W.UINT64],`
float computeInvlerp(uint64_t inputValue, Uint64LerpParameters p) {
  if (compareLessThan(inputValue, p.offset)) {
    inputValue = subtract(p.offset, inputValue);
    p.multiplier = -p.multiplier;
  } else {
    inputValue = subtract(inputValue, p.offset);
  }
  uint shifted = shiftRight(inputValue, p.shift).value[0];
  return float(shifted) * p.multiplier;
}
`]};function Bd(n){let t=`
${Ot(n)} computeLerp(float inputValue, vec2 p) {
  inputValue = inputValue / p[1] + p[0];
`;return n===W.FLOAT32?t+=`return inputValue;
`:t+=`return ${W[n].toLowerCase()}FromFloat(round(inputValue));
`,t+=`
}
`,[rl[n],t]}function uP(n){let e=Ot(n),t=$S[n];return[rl[n],Nd[n],iP,n===W.UINT32?Bh:oP,n===W.UINT32?aP:sP,`
${e} computeLerp(float inputValue, ${t} p) {
  inputValue = inputValue / p.multiplier;
  uint x = uint(clamp(round(abs(inputValue)), 0.0, 4294967295.0));
  uint xShifted = shiftLeftSaturate(x, p.shift);
  if (inputValue >= 0.0) {
    return ${e}(addSaturate(p.offset, xShifted));
  } else {
    return ${e}(subtractSaturate(p.offset, xShifted));
  }
}
`]}var vz={[W.UINT8]:Bd(W.UINT8),[W.INT8]:Bd(W.INT8),[W.UINT16]:Bd(W.UINT16),[W.INT16]:Bd(W.INT16),[W.FLOAT32]:Bd(W.FLOAT32),[W.UINT32]:uP(W.UINT32),[W.INT32]:uP(W.INT32),[W.UINT64]:[At,Od,Oh,XD,QD,FS,ZD,Nd[W.UINT64],`
uint64_t computeLerp(float inputValue, Uint64LerpParameters p) {
  inputValue = inputValue / p.multiplier;
  uint64_t x = uint64_t(uvec2(uint(clamp(round(abs(inputValue)), 0.0, 4294967295.0)), 0u));
  uint64_t shifted = shiftLeft(x, p.shift);
  if (!equals(shiftRight(shifted, p.shift), x)) {
    return uint64_t(uvec2(0xffffffffu, 0xffffffffu));
  }
  if (inputValue >= 0.0) {
    return addSaturate(p.offset, shifted);
  } else {
    return subtractSaturate(p.offset, shifted);
  }
}
`]};function dP(n,e,t){let r=`uLerpParams_${e}`,i=`uLerpBounds_${e}`,a=`uLerpScalar_${e}`,o="";switch(t){case W.INT8:case W.UINT8:case W.INT16:case W.UINT16:case W.FLOAT32:n.addUniform("vec2",r);break;case W.INT32:case W.UINT32:{let l=$S[t];n.addUniform(`${t===W.INT32?"i":"u"}vec2`,i),n.addUniform("float",a),o+=`
#define ${r} ${l}(${i}[0], int(${i}[1]), ${a})
`;break}case W.UINT64:{n.addUniform("uvec3",i),n.addUniform("float",a),o+=`
#define ${r} Uint64LerpParameters(uint64_t(${i}.xy), int(${i}[2]), ${a})
`;break}}return[Nd[t],o]}function il(n,e,t,r=!1){let i=Ot(t),a=`
float ${e}(${i} inputValue) {
  float v = computeInvlerp(inputValue, uLerpParams_${e});
  ${r?"v = clamp(v, 0.0, 1.0);":""}
  return v;
}
`;if(t!==W.UINT64&&t!==W.FLOAT32){let o=wc[t]?"int":"uint";a+=`
float ${e}(${o} inputValue) {
  return ${e}(${i}(inputValue));
}
`}return[rl[t],dP(n,e,t),yz[t],a]}function pP(n,e,t){return[rl[t],dP(n,e,t),vz[t],`
${Ot(t)} ${e}(float inputValue) {
  return computeLerp(inputValue, uLerpParams_${e});
}
`]}var al=new X;function eo(n,e,t,r){let{gl:i}=n;switch(t){case W.INT8:case W.UINT8:case W.INT16:case W.UINT16:case W.FLOAT32:i.uniform2f(n.uniform(`uLerpParams_${e}`),r[0],1/(r[1]-r[0]));break;case W.INT32:case W.UINT32:{let a=r[0],o=r[1]-a,l=Math.max(0,Math.ceil(Math.log2(Math.abs(o)))-24),c=Math.pow(2,l)/o,d=n.uniform(`uLerpBounds_${e}`);t===W.UINT32?i.uniform2ui(d,a,l):i.uniform2i(d,a,l),i.uniform1f(n.uniform(`uLerpScalar_${e}`),c);break}case W.UINT64:{let a=r[0],o=r[1];X.absDifference(al,o,a);let l=al.high>0?32+Math.ceil(Math.log2(al.high)):Math.ceil(Math.log2(al.low)),c=Math.max(0,l-24);X.rshift(al,al,c);let d=1/al.low;X.compare(a,o)>0&&(d*=-1);let p=n.uniform(`uLerpBounds_${e}`);i.uniform3ui(p,a.low,a.high,c),i.uniform1f(n.uniform(`uLerpScalar_${e}`),d)}}}var fP=Ye(gt());var Xe=class{constructor(e,t=e){this.value_=e;this.defaultValue=t;this.changed=new ne}get value(){return this.value_}set value(e){e!==this.value_&&(this.value_=e,this.changed.dispatch())}toggle(){this.value=!this.value}toJSON(){let{value_:e}=this;if(e!==this.defaultValue)return this.value_}restoreState(e){if(e===!0||e===!1){this.value=e;return}this.value=this.defaultValue}reset(){this.value=this.defaultValue}},zn=class extends H{constructor(e,t={}){super();this.model=e;this.element=document.createElement("input");let{element:r}=this;r.type="checkbox";let i=()=>{var o;let a=this.model.value;this.element.checked=a,(t.enableTitle!==void 0||t.disableTitle!==void 0)&&(this.element.title=(o=a?t.enableTitle:t.disableTitle)!=null?o:"")};this.registerDisposer(e.changed.add(i)),i(),this.registerEventListener(r,"change",function(a){e.value=this.checked}),r.addEventListener("mousedown",a=>{a.preventDefault()})}disposed(){let{element:e}=this,{parentElement:t}=e;t&&t.removeChild(e),super.disposed()}},Zn=class extends H{constructor(e,t){super();this.model=e;this.element=t;this.initialDisplay=this.element.style.display;this.updateVisibility(),this.registerDisposer(e.changed.add(this.registerCancellable((0,fP.default)(()=>this.updateVisibility(),0))))}updateVisibility(){this.element.style.display=this.model.value?this.initialDisplay:"none"}};var hP="SharedWatchableValue.changed",bt=class extends Za{constructor(e,t={}){super(e,t);this.updatingValue_=!1;e!==void 0&&(this.base=new ke(t.value),this.setupChangedHandler())}initializeCounterpart(e,t={}){t.value=this.value,super.initializeCounterpart(e,t)}setupChangedHandler(){this.registerDisposer(this.base.changed.add(()=>{if(this.updatingValue_)this.updatingValue_=!1;else{let{rpc:e}=this;e!==null&&e.invoke(hP,{id:this.rpcId,value:this.value})}}))}static makeFromExisting(e,t){let r=new bt;return r.base=t,r.setupChangedHandler(),r.initializeCounterpart(e),r}static make(e,t){return bt.makeFromExisting(e,new ke(t))}get value(){return this.base.value}set value(e){this.base.value=e}get changed(){return this.base.changed}};bt=Pt([Ho("SharedWatchableValue")],bt);Lt(hP,function(n){let e=this.get(n.id);e.updatingValue_=!0,e.base.value=n.value,e.updatingValue_=!1});var wt=class extends ke{constructor(e=Number.NEGATIVE_INFINITY){super(e)}get visible(){return this.value===Number.POSITIVE_INFINITY}get ignored(){return this.value===Number.NEGATIVE_INFINITY}};wt.VISIBLE=Number.POSITIVE_INFINITY,wt.IGNORED=Number.NEGATIVE_INFINITY;var to=class extends wt{constructor(){super(...arguments);this.contributors=new Map}add(e){let{contributors:t}=this,r=e.changed.add(()=>{this.update()}),i=()=>{t.delete(i),r(),this.update()};return t.set(i,e),this.update(),i}update(){let e=Number.NEGATIVE_INFINITY;for(let t of this.contributors.values())e=Math.max(e,t.value);this.value=e}};function ya(n){return class extends n{constructor(){super(...arguments);this.visibility=new to}initializeCounterpart(e,t={}){t.visibility=this.registerDisposer(bt.makeFromExisting(e,this.visibility)).rpcId,super.initializeCounterpart(e,t)}}}var Gt=class{constructor(e,t=WebGL2RenderingContext.ARRAY_BUFFER){this.gl=e;this.bufferType=t;this.gl=e,this.buffer=e.createBuffer()}bind(){this.gl.bindBuffer(this.bufferType,this.buffer)}bindToVertexAttrib(e,t,r=WebGL2RenderingContext.FLOAT,i=!1,a=0,o=0){this.bind(),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribPointer(e,t,r,i,a,o)}bindToVertexAttribI(e,t,r=WebGL2RenderingContext.UNSIGNED_INT,i=0,a=0){this.bind(),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribIPointer(e,t,r,i,a)}setData(e,t=WebGL2RenderingContext.STATIC_DRAW){let r=this.gl;this.bind(),r.bufferData(this.bufferType,e,t)}dispose(){this.gl.deleteBuffer(this.buffer),this.buffer=void 0,this.gl=void 0}static fromData(e,t,r,i){let a=new Gt(e,r);return a.setData(t,i),a}};function no(n,e,t,...r){return n.memoize.get(xn({id:"getMemoizedBuffer",getter:lt(t),args:r}),()=>{let i=new pd(Gt.fromData(n,t(...r),e,WebGL2RenderingContext.STATIC_DRAW));return i.registerDisposer(i.value),i})}function Sz(n=-1,e=-1,t=1,r=1,i=1,a=1){return cd(new Float32Array([n,e,n,r,t,r,t,e]),2,i,a)}function Yo(n,e=-1,t=-1,r=1,i=1,a=1,o=1){return no(n,WebGL2RenderingContext.ARRAY_BUFFER,Sz,e,t,r,i,a,o).value}function ro(n){n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE)}function mP(n){n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE),n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_R,WebGL2RenderingContext.CLAMP_TO_EDGE)}function gP(n,e,t,r,i=WebGL2RenderingContext.RGBA8,a=WebGL2RenderingContext.RGBA,o=WebGL2RenderingContext.UNSIGNED_BYTE){n.activeTexture(WebGL2RenderingContext.TEXTURE0+n.tempTextureUnit),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,e),ro(n),n.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,i,t,r,0,a,o,null),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}function yP(n,e,t){n.activeTexture(WebGL2RenderingContext.TEXTURE0+n.tempTextureUnit),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,e),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.LINEAR),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.LINEAR),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE),n.pixelStorei(WebGL2RenderingContext.UNPACK_FLIP_Y_WEBGL,1),n.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,4),n.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE,t),n.pixelStorei(WebGL2RenderingContext.UNPACK_FLIP_Y_WEBGL,0),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}function jS(n){n.addOutputBuffer("vec4","v4f_fragColor",null),n.setFragmentMain("v4f_fragColor = getValue0();")}function vP(n,e=jS,t=1){return n.memoize.get(`elementWiseTextureShader:${t}:${lt(e)}`,()=>{let r=new gr(n);r.addVarying("vec2","vTexCoord"),r.addUniform("sampler2D","uSampler",t),r.addInitializer(i=>{let a=[];for(let o=0;o<t;++o)a[o]=o;n.uniform1iv(i.uniform("uSampler"),a)});for(let i=0;i<t;++i)r.addFragmentCode(`
vec4 getValue${i}() {
  return texture(uSampler[${i}], vTexCoord);
}
`);return r.addUniform("mat4","uProjectionMatrix"),r.require(e),r.addAttribute("vec4","aVertexPosition"),r.addAttribute("vec2","aTexCoord"),r.setVertexMain("vTexCoord = aTexCoord; gl_Position = uProjectionMatrix * aVertexPosition;"),r.build()})}function SP(n){return n.memoize.get("trivialColorShader",()=>{let e=new gr(n);return e.addVarying("vec4","vColor"),e.addOutputBuffer("vec4","v4f_fragColor",null),e.setFragmentMain("v4f_fragColor = vColor;"),e.addAttribute("vec4","aVertexPosition"),e.addAttribute("vec4","aColor"),e.addUniform("mat4","uProjectionMatrix"),e.setVertexMain("vColor = aColor; gl_Position = uProjectionMatrix * aVertexPosition;"),e.build()})}var JS=class extends H{constructor(){super(...arguments);this.width=Number.NaN;this.height=Number.NaN}hasSize(e,t){return this.width===e&&this.height===t}resize(e,t){this.hasSize(e,t)||(this.width=e,this.height=t,this.performResize())}},bP=class extends JS{constructor(e,t){super();this.gl=e;this.internalformat=t;this.renderbuffer=null;this.renderbuffer=e.createRenderbuffer()}performResize(){let{gl:e}=this;e.bindRenderbuffer(e.RENDERBUFFER,this.renderbuffer),e.renderbufferStorage(e.RENDERBUFFER,this.internalformat,this.width,this.height),e.bindRenderbuffer(e.RENDERBUFFER,null)}disposed(){this.gl.deleteRenderbuffer(this.renderbuffer)}attachToFramebuffer(e){let{gl:t}=this;t.framebufferRenderbuffer(t.FRAMEBUFFER,e,t.RENDERBUFFER,this.renderbuffer)}},xP=class extends bP{constructor(e,t=!1){super(e,t?e.DEPTH_STENCIL:e.DEPTH_COMPONENT16);this.gl=e;this.includeStencilBuffer=t}attachToFramebuffer(){let{gl:e}=this;super.attachToFramebuffer(this.includeStencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT)}},qS=class extends xP{constructor(e){super(e,!0)}};var CP=class extends H{constructor(e){super();this.gl=e;this.framebuffer=this.gl.createFramebuffer()}disposed(){let{gl:e}=this;e.deleteFramebuffer(this.framebuffer)}bind(){let{gl:e}=this;e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer)}unbind(){let{gl:e}=this;e.bindFramebuffer(e.FRAMEBUFFER,null)}},va=class extends JS{constructor(e,t,r,i){super();this.gl=e;this.internalFormat=t;this.format=r;this.dataType=i;this.texture=e.createTexture()}performResize(){gP(this.gl,this.texture,this.width,this.height,this.internalFormat,this.format,this.dataType)}disposed(){this.gl.deleteTexture(this.texture)}attachToFramebuffer(e){let{gl:t}=this;t.framebufferTexture2D(t.FRAMEBUFFER,e,t.TEXTURE_2D,this.texture,0)}},YS=class extends va{constructor(e,t=WebGL2RenderingContext.DEPTH_COMPONENT16,r=WebGL2RenderingContext.DEPTH_COMPONENT,i=WebGL2RenderingContext.UNSIGNED_SHORT){super(e,t,r,i)}attachToFramebuffer(){super.attachToFramebuffer(this.format===WebGL2RenderingContext.DEPTH_COMPONENT?WebGL2RenderingContext.DEPTH_ATTACHMENT:WebGL2RenderingContext.DEPTH_STENCIL_ATTACHMENT)}};function ol(n,e,t=WebGL2RenderingContext.RGBA8,r=WebGL2RenderingContext.RGBA,i=WebGL2RenderingContext.UNSIGNED_BYTE){let a=new Array;for(let o=0;o<e;++o)a[o]=new va(n,t,r,i);return a}var Bi=class extends H{constructor(e,t){super();this.gl=e;this.width=Number.NaN;this.height=Number.NaN;this.fullAttachmentList=new Array;this.attachmentVerified=!1;this.singleAttachmentList=[this.gl.COLOR_ATTACHMENT0];let{framebuffer:r=new CP(e),colorBuffers:i,depthBuffer:a}=t;this.framebuffer=this.registerDisposer(r),this.colorBuffers=i,this.depthBuffer=a,a!==void 0&&this.registerDisposer(a);let{fullAttachmentList:o}=this;i.forEach((l,c)=>{this.registerDisposer(l),o[c]=e.COLOR_ATTACHMENT0+c})}hasSize(e,t){return this.width===e&&this.height===t}bind(e,t){this.width=e,this.height=t,this.framebuffer.bind();let{gl:r,depthBuffer:i}=this;i!==void 0?(i.resize(e,t),i.attachToFramebuffer()):r.framebufferRenderbuffer(WebGL2RenderingContext.FRAMEBUFFER,WebGL2RenderingContext.DEPTH_STENCIL_ATTACHMENT,WebGL2RenderingContext.RENDERBUFFER,null),this.colorBuffers.forEach((a,o)=>{a.resize(e,t),a.attachToFramebuffer(r.COLOR_ATTACHMENT0+o)}),r.drawBuffers(this.fullAttachmentList),this.verifyAttachment(),r.viewport(0,0,e,t)}bindSingle(e){let{gl:t}=this;this.framebuffer.bind(),e!==0&&t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.TEXTURE_2D,null,0),t.bindTexture(t.TEXTURE_2D,null),this.colorBuffers[e].attachToFramebuffer(t.COLOR_ATTACHMENT0),t.drawBuffers(this.singleAttachmentList)}unbind(){this.framebuffer.unbind()}readPixelFloat32IntoBuffer(e,t,r,i,a=1,o=1){let{gl:l}=this;try{this.bindSingle(e),l.readPixels(t,r,a,o,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,i)}finally{this.framebuffer.unbind()}}verifyAttachment(){if(this.attachmentVerified)return;let{gl:e}=this,t=e.checkFramebufferStatus(e.FRAMEBUFFER);if(t!==e.FRAMEBUFFER_COMPLETE)throw new Error(`Framebuffer configuration not supported: ${t}`);this.attachmentVerified=!0}},Sa=class extends H{constructor(e,t){super();this.gl=e;this.shader=t;this.copyVertexPositionsBuffer=Yo(this.gl);this.copyTexCoordsBuffer=Yo(this.gl,0,0,1,1);this.registerDisposer(t)}draw(...e){let{gl:t,shader:r}=this;r.bind();let i=e.length;for(let l=0;l<i;++l)t.activeTexture(t.TEXTURE0+l),t.bindTexture(t.TEXTURE_2D,e[l]);t.uniformMatrix4fv(r.uniform("uProjectionMatrix"),!1,Yf);let a=r.attribute("aVertexPosition");this.copyVertexPositionsBuffer.bindToVertexAttrib(a,2);let o=r.attribute("aTexCoord");this.copyTexCoordsBuffer.bindToVertexAttrib(o,2),t.drawArrays(t.TRIANGLE_FAN,0,4),t.disableVertexAttribArray(a),t.disableVertexAttribArray(o);for(let l=0;l<i;++l)t.activeTexture(t.TEXTURE0+l),t.bindTexture(t.TEXTURE_2D,null)}static get(e,t=jS,r=1){return e.memoize.get(`OffscreenCopyHelper:${r}:${lt(t)}`,()=>new Sa(e,vP(e,t,r)))}};var bz=!1,Fd=class extends H{constructor(e,t,r,i=new to){super();this.channels=e;this.properties=t;this.bounds=r;this.visibility=i;this.framebuffers=[];this.producerVisibility=new to;this.frameNumber=-1}getFramebuffers(e){let{framebuffers:t}=this,r=this.bounds.value.length;for(;t.length<r;){let i=new Bi(e,{colorBuffers:ol(e,1,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)});t.push(i)}return t}get visibleHistograms(){return this.visibility.visible?this.bounds.value.length:0}disposed(){for(let e of this.framebuffers)e.dispose();this.framebuffers.length=0}},wP=Symbol("histogramDataSamplerTextureUnit"),TP=Symbol("histogramDepthTextureUnit"),KS=4096,xz=2**14,Ud=class extends H{constructor(e){super();this.gl=e;this.shader=this.registerDisposer((()=>{let e=new gr(this.gl);return e.addOutputBuffer("vec4","outputValue",0),e.addAttribute("float","aInput1"),e.addTextureSampler("sampler2D","uDataSampler",wP),e.addTextureSampler("sampler2D","uDepthSampler",TP),e.addVertexCode(rP),e.setVertexMain(`
float uRandomSeed = 0.0;
vec2 p = vec2(simpleFloatHash(vec2(aInput1 + float(gl_VertexID), uRandomSeed + float(gl_InstanceID))),
              simpleFloatHash(vec2(aInput1 + float(gl_VertexID) + 10.0, 5.0 + uRandomSeed + float(gl_InstanceID))));
float dataValue = texture(uDataSampler, p).x;
float stencilValue = texture(uDepthSampler, p).x;
if (stencilValue == 1.0) {
  gl_Position = vec4(2.0, 2.0, 2.0, 1.0);
} else {
  gl_Position = vec4(2.0 * (dataValue * 255.0 + 0.5) / 256.0 - 1.0, 0.0, 0.0, 1.0);
}
gl_PointSize = 1.0;
`),e.setFragmentMain(`
outputValue = vec4(1.0, 1.0, 1.0, 1.0);
`),e.build()})());this.inputIndexBuffer=this.registerDisposer(no(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>new Uint8Array(KS)))}static get(e){return e.memoize.get("textureHistogramGeneration",()=>new Ud(e))}compute(e,t,r,i,a){let{gl:o}=this,{shader:l}=this,c=i.getFramebuffers(o);l.bind(),o.enable(WebGL2RenderingContext.BLEND),o.disable(WebGL2RenderingContext.SCISSOR_TEST),o.disable(WebGL2RenderingContext.DEPTH_TEST),o.blendFunc(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE),this.inputIndexBuffer.value.bindToVertexAttrib(l.attribute("aInput1"),1,WebGL2RenderingContext.UNSIGNED_BYTE,!0);let d=l.textureUnit(wP),p=l.textureUnit(TP);o.activeTexture(WebGL2RenderingContext.TEXTURE0+p),o.bindTexture(WebGL2RenderingContext.TEXTURE_2D,t),ro(o),o.activeTexture(WebGL2RenderingContext.TEXTURE0+d);let h=i.frameNumber;i.frameNumber=a;for(let g=0;g<e;++g)if(o.bindTexture(WebGL2RenderingContext.TEXTURE_2D,r[g].texture),ro(o),c[g].bind(256,1),a!==h&&(o.clearColor(0,0,0,0),o.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT)),o.drawArraysInstanced(WebGL2RenderingContext.POINTS,0,KS,xz/KS),bz){let v=new Float32Array(256*4);o.readPixels(0,0,256,1,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,v);let b=new Float32Array(256);for(let x=0;x<256;++x)b[x]=v[x*4];console.log("histogram",b.join(" "))}o.disable(WebGL2RenderingContext.BLEND)}};function Cz(n){let e=/\/\/.*?$|\/\*(?:.|\n)*?\*\/|'(?:\\.|[^\\'])*'|"(?:\\.|[^\\"])*"/mg;return n.replace(e,t=>t.startsWith("/")?t.replace(/[^\s]/g," "):t)}function wz(n){let e=/^(?:-?(?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?|"(?:\\.|[^\\"])*"|true|false|:|\s+|,|\[|\]|\{|\})/,t=0,r=n;e:for(;n.length;){let i=n.match(e);if(i===null)break;let a=i[0];switch(a.charAt(0)){case"[":case"{":++t;break;case"]":case"}":if(--t<0)return-1;break;case",":if(t===0)break e;break;default:if(t===0){n=n.substring(a.length);break e}break}n=n.substring(a.length)}return t!==0?-1:r.length-n.length}function Tz(n){let e=[],t=new Map;if(n===void 0)return{errors:e,parameters:t};let r=/^([_a-z][_a-zA-Z0-9]*)[ \t]*=/;for(;n=n.trim(),n.length!=0;){let i=n.match(r);if(i===null){e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ...");break}let a=i[1];n=n.substring(i[0].length);let o=wz(n);if(o<=0){e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ...");break}let l;try{l=JSON.parse(n.substring(0,o))}catch{e.push(`Invalid #uicontrol parameter value for ${a}: ${l}`);break}t.has(a)?e.push(`Duplicate #uicontrol parameter: ${a}`):t.set(a,l),n=n.substring(o),n=n.trim(),n.length>0&&!n.startsWith(",")&&e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ..."),n=n.substring(1)}return{parameters:t,errors:e}}function Lz(n,e){let t,r,i,a,o=[];n!=="float"&&n!=="uint"&&n!=="int"&&o.push("type must be float, int, or uint");for(let[l,c]of e){let d=()=>{if(typeof c!="number"){o.push(`Expected ${l} argument to be a number`);return}return(n==="int"||n==="uint")&&(Number.isInteger(c)||o.push(`Expected ${l} argument to be an integer`),n==="uint"&&c<0&&o.push(`Expected ${l} argument to be an unsigned integer`)),c};l==="min"?t=d():l==="max"?r=d():l==="default"?a=d():l==="step"?i=d():o.push(`Invalid parameter: ${l}`)}return t===void 0&&o.push("min must be specified"),r===void 0&&o.push("max must be specified"),t!==void 0&&r!==void 0&&(t>r&&o.push("min must be less than max"),i===void 0&&(n==="float"?i=(r-t)/100:i=1),a!==void 0?(a<t||a>r)&&o.push("default must be within valid range"):n==="float"?a=(t+r)/2:a=t),o.length>0?{errors:o}:{control:{type:"slider",valueType:n,min:t,max:r,step:i,default:a},errors:void 0}}function kz(n,e){let t=!1,r=[];n!=="bool"&&r.push("type must be bool");for(let[i,a]of e)if(i==="default"){if(typeof a!="boolean"){r.push(`Expected ${i} argument to be a boolean`);continue}t=a}else r.push(`Invalid parameter: ${i}`);return r.length>0?{errors:r}:{control:{type:"checkbox",valueType:n,default:t},errors:void 0}}function Ez(n,e){let t="white",r=[];n!=="vec3"&&r.push("type must be vec3");for(let[i,a]of e)i==="default"?typeof a!="string"?r.push("Expected default argument to be a string"):t=a:r.push(`Invalid parameter: ${i}`);return r.length>0?{errors:r}:{control:{type:"color",valueType:n,defaultString:t,default:fa(t)},errors:void 0}}function LP(n,e){typeof n=="number"&&(n=[n]);let t=new Array(e);return Pe(t,n,r=>{if(!Number.isInteger(r)||r<0)throw new Error(`Expected non-negative integer, but received: ${JSON.stringify(r)}`);return r}),t}function Dz(n,e,t){let{imageData:r,properties:i}=t;if(r!==void 0)return Pz(n,e,r);if(i!==void 0)return Iz(n,e,i);let a=[];return a.push("invlerp control not supported"),{errors:a}}function Pz(n,e,t){let r=[];n!=="invlerp"&&r.push("type must be invlerp");let i=new Array(t.channelRank).fill(0),{dataType:a}=t,o=!0,l=qr[a],c;for(let[d,p]of e)try{switch(d){case"range":{l=Ys(p,a);break}case"window":{c=sh(Ys(p,a));break}case"clamp":{typeof p!="boolean"?r.push(`Invalid clamp value: ${JSON.stringify(p)}`):o=p;break}case"channel":{i=LP(p,i.length);break}default:r.push(`Invalid parameter: ${d}`);break}}catch(h){r.push(`Invalid ${d} value: ${h.message}`)}return r.length>0?{errors:r}:{control:{type:"imageInvlerp",dataType:a,clamp:o,default:{range:l,window:c!=null?c:lh(l),channel:i}},errors:void 0}}function Iz(n,e,t){let r=[];n!=="invlerp"&&r.push("type must be invlerp");let i=!0,a,o,l;for(let[d,p]of e)try{switch(d){case"range":{a=Yv(p);break}case"window":{o=Yv(p);break}case"clamp":{typeof p!="boolean"?r.push(`Invalid clamp value: ${JSON.stringify(p)}`):i=p;break}case"property":{let h=Z(p);if(!t.has(h))throw new Error(`Property not defined: ${JSON.stringify(l)}`);l=h;break}default:r.push(`Invalid parameter: ${d}`);break}}catch(h){r.push(`Invalid ${d} value: ${h.message}`)}if(r.length>0)return{errors:r};if(l===void 0)for(let d of t.keys()){l=d;break}let c=t.get(l);return a!==void 0&&(a=kc(a,c)),o!==void 0&&(o=kc(o,c)),{control:{type:"propertyInvlerp",clamp:i,properties:t,default:{range:a,window:o,property:l,dataType:c}},errors:void 0}}var Az=new Map([["slider",Lz],["color",Ez],["invlerp",Dz],["checkbox",kz]]);function io(n,e={}){n=Cz(n);let t=/^[ \t]*#[ \t]*uicontrol[ \t]+(.*)$/mg,r=/^([_a-zA-Z][_a-zA-Z0-9]*)[ \t]+([a-z][a-zA-Z0-9_]*)(?:[ \t]+([a-z]+))?[ \t]*(?:\([ \t]*(.*)\)[ \t]*)?/,i=[],a=new Map,o=n.replace(t,(l,c,d)=>{var M;let p=c.match(r),h=()=>Math.max(0,n.substring(0,d).split(`
`).length-1);if(p===null)return i.push({line:h(),message:"Invalid #uicontrol syntax, expected: #uicontrol <type> <name> <control>(<param>=<value>, ...)"}),"";let g=p[1],v=p[2],b=(M=p[3])!=null?M:g,x=p[4],{parameters:C,errors:T}=Tz(x);for(let D of T)i.push({line:h(),message:D});if(a.has(v)&&i.push({line:h(),message:`Duplicate definition for control ${v}`}),T.length>0)return"";let P=Az.get(b);if(P===void 0)return i.push({line:h(),message:`Invalid control type ${b}`}),"";let I=P(g,C,e);if(I.errors!==void 0){for(let D of I.errors)i.push({line:h(),message:D});return""}return a.set(v,I.control),""});return{source:n,code:o,errors:i,controls:a}}function kP(n){return`u_shaderControl_${n}`}function Fi(n,e){let{builderValues:t}=n;for(let[r,i]of n.parseResult.controls){let a=kP(r),o=t[r];switch(i.type){case"imageInvlerp":{let l=[il(e,a,i.dataType,i.clamp),`
float ${a}() {
  return ${a}(getDataValue(${o.channel.join(",")}));
}
`];e.addFragmentCode(l),e.addFragmentCode(`#define ${r} ${a}
`);break}case"propertyInvlerp":{let l=o.property,c=i.properties.get(l),d=[il(e,a,c,i.clamp),`
float ${a}() {
  return ${a}(prop_${l}());
}
`];e.addVertexCode(d),e.addVertexCode(`#define ${r} ${a}
`);break}case"checkbox":{let l=`#define ${r} ${o.value}
`;e.addFragmentCode(l),e.addVertexCode(l);break}default:{e.addUniform(`highp ${i.valueType}`,a),e.addVertexCode(`#define ${r} ${a}
`),e.addFragmentCode(`#define ${r} ${a}
`);break}}}}function Mz(n){let e={};for(let[t,r]of n)e[t]=r;return e}function Rz(n,e){return e instanceof Map?Array.from(e.entries()):e}function EP(n){if(n!==void 0)return JSON.stringify(Mz(n),Rz)}var DP=class{constructor(){this.changed=new ne;this.controls=void 0}get value(){return this.controls}set value(e){EP(e)!==EP(this.controls)&&(this.controls=e,this.changed.dispatch())}};function _z(n,e,t){return n===void 0?t:(Q(n),{range:ie(n,"range",r=>Ys(r,e),t.range),window:ie(n,"window",r=>sh(Ys(r,e)),t.window),channel:ie(n,"channel",r=>LP(r,t.channel.length),t.channel)})}var PP=class extends Ce{constructor(e,t){super(t,r=>_z(r,e,t));this.dataType=e;this.defaultValue=t}toJSON(){let{value:{range:e,window:t,channel:r},dataType:i,defaultValue:a}=this,o=Cd(e,i,a.range),l=Cd(t,i,a.window),c=xe(a.channel,r)?void 0:r;if(!(o===void 0&&l===void 0&&c===void 0))return{range:o,window:l,channel:c}}};function Vz(n,e,t){if(n===void 0)return t;Q(n);let r=ie(n,"property",a=>{if(a=Z(a),!e.has(a))throw new Error(`Invalid value: ${JSON.stringify(a)}`);return a},t.property),i=e.get(r);return{property:r,dataType:i,range:ie(n,"range",a=>Ys(a,i),t.range),window:ie(n,"window",a=>sh(Ys(a,i)),t.window)}}var IP=class extends Ce{constructor(e,t){super(t,r=>Vz(r,e,t));this.properties=e;this.defaultValue=t}toJSON(){var p,h;let{value:{range:e,window:t,property:r,dataType:i},defaultValue:a}=this,o=qr[i],l=Cd(e!=null?e:o,i,(p=a.range)!=null?p:o),c=Cd(t!=null?t:o,i,(h=a.window)!=null?h:o),d=r===a.property?void 0:r;if(!(l===void 0&&c===void 0&&d===void 0))return{range:l,window:c,property:d}}};function AP(n){switch(n.type){case"slider":return{trackable:new Ce(n.default,e=>{let t;if(n.valueType==="float"?t=Ke(e):t=ze(e),t<n.min||t>n.max)throw new Error(`${JSON.stringify(e)} is outside valid range [${n.min}, ${n.max}]`);return t}),getBuilderValue:()=>null};case"color":return{trackable:new Bo(n.default),getBuilderValue:()=>null};case"imageInvlerp":return{trackable:new PP(n.dataType,n.default),getBuilderValue:e=>({channel:e.channel,dataType:n.dataType})};case"propertyInvlerp":return{trackable:new IP(n.properties,n.default),getBuilderValue:e=>({property:e.property,dataType:e.dataType})};case"checkbox":return{trackable:new Xe(n.default),getBuilderValue:e=>({value:e})}}}function MP(n,e){return JSON.stringify(n)+"\0"+e.source}function Ko(n){let e={},t=[];for(let[r,i]of n.controls){let{trackable:a,getBuilderValue:o}=AP(i),l=o(a.value);e[r]=l,i.type==="propertyInvlerp"&&t.push(l.property)}return{builderValues:e,parseResult:n,key:MP(e,n),referencedProperties:t}}var ao=class extends H{constructor(e,t=Pr({}),r){super();this.fragmentMain=e;this.dataContext=t;this.channelCoordinateSpaceCombiner=r;this.changed=new ne;this.controls=new DP;this.fragmentMainGeneration=-1;this.dataContextGeneration=-1;this.parseErrors_=[];this.processedFragmentMain_="";this.controlsGeneration=-1;this.parseResultChanged=new ne;this.state_=new Map;this.unparsedJson=void 0;this.registerDisposer(e.changed.add(()=>this.handleFragmentMainChanged())),this.registerDisposer(this.controls.changed.add(()=>this.handleControlsChanged())),this.registerDisposer(this.dataContext.changed.add(()=>this.handleFragmentMainChanged())),this.handleFragmentMainChanged();let i=this;this.parseErrors={changed:this.parseResultChanged,get value(){return i.handleFragmentMainChanged(),i.parseErrors_}},this.processedFragmentMain={changed:this.parseResultChanged,get value(){return i.handleFragmentMainChanged(),i.processedFragmentMain_}},this.parseResult={changed:this.parseResultChanged,get value(){return i.parseResult_}},this.builderState=Mt((c,d)=>{let p={},h=[];for(let[g,{control:v,trackable:b,getBuilderValue:x}]of d){let C=x(b.value);p[g]=C,v.type==="propertyInvlerp"&&h.push(C.property)}return{key:MP(p,c),parseResult:c,builderValues:p,referencedProperties:h}},[this.parseResult,this],(c,d)=>c.key===d.key);let a=Mt(c=>{let d=[];for(let{control:p,trackable:h}of c.values())p.type==="imageInvlerp"&&d.push({channel:h.value.channel});return d},[this],(c,d)=>ud(c,d,(p,h)=>xe(p.channel,h.channel))),o=Mt(c=>{let d=[];for(let{control:p,trackable:h}of c.values())p.type==="propertyInvlerp"&&d.push(h.value.property);return d},[this],xe),l=vn(c=>{var p;let d=[];for(let{control:h,trackable:g}of c.values())if(h.type==="imageInvlerp")d.push(g.value.window);else if(h.type==="propertyInvlerp"){let{dataType:v,range:b,window:x}=g.value;d.push((p=x!=null?x:b)!=null?p:qr[v])}return d},this);this.histogramSpecifications=this.registerDisposer(new Fd(a,o,l))}handleFragmentMainChanged(){let e=this.fragmentMain.changed.count,t=this.dataContext.changed.count;if(e===this.fragmentMainGeneration&&t===this.dataContextGeneration)return;this.fragmentMainGeneration=e,this.dataContextGeneration=t;let r=this.dataContext.value;if(r===null)this.parseResult_={source:"",code:"",controls:new Map,errors:[{line:0,message:"Loading"}]},this.parseErrors_=[],this.processedFragmentMain_="",this.controls.value=void 0;else{let i=this.parseResult_=io(this.fragmentMain.value,r);this.parseErrors_=i.errors,this.processedFragmentMain_=i.code,i.errors.length===0&&(this.controls.value=i.controls)}this.parseResultChanged.dispatch()}handleControlsChanged(){let e=this.controls.changed.count;if(e===this.controlsGeneration)return;this.controlsGeneration=e;let t=this.controls.value;if(t===void 0)return;let r=!1,{state_:i,unparsedJson:a}=this;for(let[o,l]of i)if(t.get(o)===void 0){l.trackable.changed.remove(this.changed.dispatch),i.delete(o),r=!0;continue}for(let[o,l]of t){let c=i.get(o);if(c!==void 0&&JSON.stringify(c.control)!==JSON.stringify(l)&&(c.trackable.changed.remove(this.changed.dispatch),c=void 0),c===void 0){let{trackable:d,getBuilderValue:p}=AP(l);c={control:l,trackable:d,getBuilderValue:p},c.trackable.changed.add(this.changed.dispatch),i.set(o,c),r=!0}if(a!==void 0&&a.hasOwnProperty(o)){r=!0;try{c.trackable.restoreState(a[o])}catch{}}}a!==void 0&&(r=!0),this.unparsedJson=void 0,r&&this.changed.dispatch()}get state(){return this.controls.changed.count!==this.controlsGeneration&&this.handleControlsChanged(),this.state_}get value(){return this.state}restoreState(e){if(e===void 0)return;let{state:t}=this;if(Q(e),this.controls.value===void 0){this.unparsedJson=e,this.changed.dispatch();return}for(let[i,a]of t){let{trackable:o}=a;if(o.reset(),e.hasOwnProperty(i))try{o.restoreState(e[i])}catch{}}this.unparsedJson=void 0}reset(){for(let e of this.state.values())e.trackable.reset();this.unparsedJson!==void 0&&(this.unparsedJson=void 0,this.changed.dispatch())}toJSON(){let{state:e}=this,{unparsedJson:t}=this;if(t!==void 0)return t;let r={},i=!0;for(let[a,o]of e){let l=o.trackable.toJSON();l!==void 0&&(r[a]=l,i=!1)}if(!i)return r}};function RP(n,e,t,r,i){var l;let a=kP(t),o=e.uniform(a);switch(r.type){case"slider":switch(r.valueType){case"int":case"uint":n.uniform1i(o,i);break;case"float":n.uniform1f(o,i)}break;case"color":n.uniform3fv(o,i);break;case"imageInvlerp":eo(e,a,r.dataType,i.range);break;case"propertyInvlerp":{let{dataType:c}=i;eo(e,a,c,(l=i.range)!=null?l:qr[c]);break}case"checkbox":break}}function ei(n,e,t,r){let{state:i}=t;if(t.controls.value===r)for(let[a,o]of i)RP(n,e,a,o.control,o.trackable.value);else for(let[a,o]of r){let l=i.get(a),c=l!==void 0&&JSON.stringify(l.control)===JSON.stringify(o)?l.trackable.value:o.default;RP(n,e,a,o,c)}}var Oz=!1;function _P(n,e){return{defineShader(t,r){let i=`prop_${r}`,a=`a_${i}`;t.addAttribute(`${n}`,a),t.addVertexCode(`${n} ${i}() { return ${a}; }`),t.addInitializer(o=>{let l=o.attribute(a),{gl:c}=o;o.vertexShaderInputBinders[i]=l===-1?{enable(){},disable(){},bind(){}}:{enable(d){c.enableVertexAttribArray(l),c.vertexAttribDivisor(l,d)},disable(){c.vertexAttribDivisor(l,0),c.disableVertexAttribArray(l)},bind(d,p){e(c,l,d,p)}}})}}}function XS(n,e,t,r){return _P(n,(i,a,o,l)=>{i.vertexAttribPointer(a,e,t,r,o,l)})}function Bc(n,e,t){return _P(n,(r,i,a,o)=>{r.vertexAttribIPointer(i,e,t,a,o)})}var VP={rgb:XS("highp vec3",3,WebGL2RenderingContext.UNSIGNED_BYTE,!0),rgba:XS("highp vec4",4,WebGL2RenderingContext.UNSIGNED_BYTE,!0),float32:XS("highp float",1,WebGL2RenderingContext.FLOAT,!1),uint32:Bc("highp uint",1,WebGL2RenderingContext.UNSIGNED_INT),int32:Bc("highp int",1,WebGL2RenderingContext.INT),uint16:Bc("highp uint",1,WebGL2RenderingContext.UNSIGNED_SHORT),int16:Bc("highp int",1,WebGL2RenderingContext.SHORT),uint8:Bc("highp uint",1,WebGL2RenderingContext.UNSIGNED_BYTE),int8:Bc("highp int",1,WebGL2RenderingContext.BYTE)},OP=class extends H{constructor(e,t,r,i){super();this.gl=e;this.annotationType=t;this.rank=r;this.properties=i;let a=this.serializedGeometryBytesPerAnnotation=Wn[t].serializedBytes(r),{offsets:o,serializedBytes:l,propertyGroupBytes:c}=Xv(r,a,i);this.serializedBytesPerAnnotation=l,this.propertyOffsets=o,this.propertyGroupBytes=c,this.geometryDataStride=c[0];let d=this.propertyGroupCumulativeBytes=new Array(c.length);d[0]=0;for(let p=1;p<c.length;++p)d[p]=d[p-1]+c[p-1]}defineProperties(e,t){let{properties:r,rank:i}=this;for(let c of t){let d=r[c];VP[d.type].defineShader(e,d.identifier,i)}let{propertyOffsets:a}=this,{propertyGroupBytes:o,propertyGroupCumulativeBytes:l}=this;e.addInitializer(c=>{let d=t.map(h=>c.vertexShaderInputBinders[`prop_${r[h].identifier}`]),p=d.length;c.vertexShaderInputBinders.properties={enable(h){for(let g=0;g<p;++g)d[g].enable(h)},bind(h,g){for(let v=0;v<p;++v){let{group:b,offset:x}=a[t[v]];d[v].bind(o[b],g+x+l[b]*h)}},disable(){for(let h=0;h<p;++h)d[h].disable()}}})}},oo=class extends OP{constructor(e,t,r,i,a,o,l){super(e,t,r,i);this.shaderControlState=a;this.fallbackShaderParameters=o;this.shaderError=l;this.histogramShaders=new Map}getDependentShader(e,t){return Zr(this,this.gl,{memoizeKey:{t:"annotation",targetIsSliceView:this.targetIsSliceView,type:this.annotationType,subType:e,properties:this.properties,rank:this.rank},fallbackParameters:this.fallbackShaderParameters,parameters:this.shaderControlState.builderState,shaderError:this.shaderError,defineShader:(r,i)=>{let{rank:a,properties:o}=this,l=[],c=i.referencedProperties,d=i.parseResult.code;for(let h=0,g=o.length;h<g;++h){let v=o[h],b=`prop_${v.identifier}`;!c.includes(v.identifier)&&!d.match(new RegExp(`\\b${b}\\b`))||l.push(h)}this.defineProperties(r,l),r.addUniform("highp vec3","uColor"),r.addUniform("highp uint","uSelectedIndex"),r.addVarying("highp vec4","vColor"),r.addUniform("highp vec3","uSubspaceMatrix",a),r.addUniform("highp mat4","uModelViewProjection"),r.addUniform("highp float","uModelClipBounds",a*2),r.addUniform("highp uint","uPickID"),r.addVarying("highp uint","vPickID","flat"),r.addVertexCode(Oi),r.addVertexCode(`
vec3 defaultColor() { return uColor; }
highp uint getPickBaseOffset() { return uint(gl_InstanceID) * ${this.pickIdsPerInstance}u; }
`),r.addFragmentCode(`
void emitAnnotation(vec4 color) {
  emit(color, vPickID);
}
`);let p=`
float getSubspaceClipCoefficient(float modelPoint[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${a}; ++i) {
    float d = abs(modelPoint[i] - uModelClipBounds[i]) * uModelClipBounds[${a} + i];
    coefficient *= max(0.0, 1.0 - d);
  }
  return coefficient;
}
`;r.addVertexCode(p),r.addFragmentCode(p),r.addVertexCode(`
vec3 projectModelVectorToSubspace(float modelPoint[${this.rank}]) {
  vec3 result = vec3(0.0, 0.0, 0.0);
  for (int i = 0; i < ${a}; ++i) {
    result += uSubspaceMatrix[i] * modelPoint[i];
  }
  return result;
}

float getMaxEndpointSubspaceClipCoefficient(float modelPointA[${this.rank}],  float modelPointB[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${a}; ++i) {
    float dA = abs(modelPointA[i] - uModelClipBounds[i]) * uModelClipBounds[${a} + i];
    float dB = abs(modelPointB[i] - uModelClipBounds[i]) * uModelClipBounds[${a} + i];
    coefficient *= max(0.0, 1.0 - min(dA, dB));
  }
  return coefficient;
}

float getMaxSubspaceClipCoefficient(float modelPointA[${this.rank}],  float modelPointB[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${a}; ++i) {
    float a = modelPointA[i];
    float b = modelPointB[i];
    float c = uModelClipBounds[i];
    float x = clamp(c, min(a, b), max(a, b));
    float d = abs(x - c) * uModelClipBounds[${a} + i];
    coefficient *= max(0.0, 1.0 - d);
  }
  return coefficient;
}

`),Fi(i,r),r.addVertexCode(`
const bool PROJECTION_VIEW = ${!this.targetIsSliceView};
bool ng_discardValue;
#define discard ng_discard()
void ng_discard() {
  ng_discardValue = true;
}
void setLineColor(vec4 startColor, vec4 endColor);
void setLineWidth(float width);

void setEndpointMarkerColor(vec4 startColor, vec4 endColor);
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor);
void setEndpointMarkerSize(float startSize, float endSize);
void setEndpointMarkerBorderWidth(float startSize, float endSize);

void setPointMarkerColor(vec4 color);
void setPointMarkerBorderColor(vec4 color);
void setPointMarkerSize(float size);
void setPointMarkerBorderWidth(float size);
void setPointMarkerBorderColor(vec3 color) { setPointMarkerBorderColor(vec4(color, 1.0)); }

void setEllipsoidFillColor(vec4 color);

void setBoundingBoxBorderColor(vec4 color);
void setBoundingBoxBorderWidth(float size);
void setBoundingBoxFillColor(vec4 color);

void setEndpointMarkerColor(vec3 startColor, vec3 endColor) {
  setEndpointMarkerColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setEndpointMarkerBorderColor(vec3 startColor, vec3 endColor) {
  setEndpointMarkerBorderColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setEndpointMarkerColor(vec3 color) { setEndpointMarkerColor(color, color); }
void setEndpointMarkerColor(vec4 color) { setEndpointMarkerColor(color, color); }
void setEndpointMarkerBorderColor(vec3 color) { setEndpointMarkerBorderColor(color, color); }
void setEndpointMarkerBorderColor(vec4 color) { setEndpointMarkerBorderColor(color, color); }
void setEndpointMarkerSize(float size) { setEndpointMarkerSize(size, size); }
void setEndpointMarkerBorderWidth(float size) { setEndpointMarkerBorderWidth(size, size); }
void setLineColor(vec4 color) { setLineColor(color, color); }
void setLineColor(vec3 color) { setLineColor(vec4(color, 1.0)); }
void setLineColor(vec3 startColor, vec3 endColor) { setLineColor(vec4(startColor, 1.0), vec4(endColor, 1.0)); }
void setColor(vec4 color) {
  setPointMarkerColor(color);
  setLineColor(color);
  setEndpointMarkerColor(color);
  setBoundingBoxBorderColor(color);
  setEllipsoidFillColor(vec4(color.rgb, color.a * (PROJECTION_VIEW ? 1.0 : 0.5)));
}
void setEllipsoidFillColor(vec3 color) { setEllipsoidFillColor(vec4(color, 1.0)); }

void setBoundingBoxFillColor(vec3 color) { setBoundingBoxFillColor(vec4(color, 1.0)); }
void setBoundingBoxBorderColor(vec3 color) { setBoundingBoxBorderColor(vec4(color, 1.0)); }

void setColor(vec3 color) { setColor(vec4(color, 1.0)); }
void userMain();
`);for(let[h,g]of QS)h!==this.annotationType&&g.defineShaderNoOpSetters(r);t(r),r.addVertexCode(`
#define main userMain
`+Ni(i.parseResult.code)+`
#undef main
`)}})}setPartIndex(e,...t){let r=`
void setPartIndex(${t.map((i,a)=>`highp uint partIndex${a}`).join()}) {
  highp uint pickID = uPickID;
  highp uint pickBaseOffset = getPickBaseOffset();
${t.map((i,a)=>`highp uint pickOffset${a} = pickBaseOffset + partIndex${a};`).join(`
`)}
`;return t.length===0&&(r+=`
  highp uint pickOffset0 = pickBaseOffset;
`),r+=`
  vPickID = pickID + pickOffset0;
  highp uint selectedIndex = uSelectedIndex;
if (selectedIndex == pickBaseOffset${t.map((i,a)=>` || selectedIndex == pickOffset${a}`).join("")}) {
    vColor = vec4(mix(vColor.rgb, vec3(1.0, 1.0, 1.0), 0.75), vColor.a);
  }
}
`,e.addVertexCode(r),`setPartIndex(${t.join()})`}get invokeUserMain(){return`
ng_discardValue = false;
userMain();
if (ng_discardValue) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
`}getCrossSectionFadeFactor(){return this.targetIsSliceView?"(clamp(1.0 - 2.0 * abs(0.5 - gl_FragCoord.z), 0.0, 1.0))":"(1.0)"}enable(e,t,r){let{shader:i,parameters:a}=e(t.renderContext.emitter);if(i===null)return;i.bind();let{gl:o}=this,{renderContext:l}=t,{annotationLayer:c}=t;if(ei(o,i,this.shaderControlState,a.parseResult.controls),o.uniform3fv(i.uniform("uSubspaceMatrix"),t.subspaceMatrix),o.uniform1fv(i.uniform("uModelClipBounds"),t.modelClipBounds),o.uniformMatrix4fv(i.uniform("uModelViewProjection"),!1,t.modelViewProjectionMatrix),l.emitPickID&&o.uniform1ui(i.uniform("uPickID"),t.basePickId),l.emitColor){let p=c.state.displayState.color.value;o.uniform3f(i.uniform("uColor"),p[0],p[1],p[2]),o.uniform1ui(i.uniform("uSelectedIndex"),t.selectedIndex)}let d=i.vertexShaderInputBinders.properties;d.enable(1),o.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),d.bind(t.count,t.bufferOffset),r(i),d.disable()}getHistogramShader(e){let{histogramShaders:t}=this,r=t.get(e);if(r===void 0){let{gl:i}=this;r=i.memoize.get(JSON.stringify({t:"propertyHistogramGenerator",propertyType:e}),()=>{let a=new gr(i);return this.defineHistogramShader(a,e),a.build()}),t.set(e,r)}return r}defineHistogramShader(e,t){VP[t].defineShader(e,"histogram",0),e.addOutputBuffer("vec4","out_histogram",0);let i="invlerpForHistogram",a=Ld[t];e.addVertexCode(il(e,i,a,!1)),e.setVertexMain(`
float x = invlerpForHistogram(prop_histogram());
if (x < 0.0) x = 0.0;
else if (x > 1.0) x = 1.0;
else x = (1.0 + x * 253.0) / 255.0;
gl_Position = vec4(2.0 * (x * 255.0 + 0.5) / 256.0 - 1.0, 0.0, 0.0, 1.0);
gl_PointSize = 1.0;
`),e.setFragmentMain("out_histogram = vec4(1.0, 1.0, 1.0, 1.0);")}computeHistograms(e,t){let{histogramSpecifications:r}=this.shaderControlState,i=r.properties.value,a=i.length,{properties:o}=this,l=o.length,{propertyOffsets:c}=this,{propertyGroupBytes:d,propertyGroupCumulativeBytes:p}=this,{gl:h}=this;h.enable(WebGL2RenderingContext.BLEND),h.disable(WebGL2RenderingContext.SCISSOR_TEST),h.disable(WebGL2RenderingContext.DEPTH_TEST),h.blendFunc(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE);let g=r.getFramebuffers(h),v=r.frameNumber;r.frameNumber=t,h.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,e.buffer.buffer);for(let b=0;b<a;++b){let x=i[b];for(let C=0;C<l;++C){let T=o[C];if(T.identifier!==x)continue;let P=T.type,I=Ld[P],M=this.getHistogramShader(P);M.bind();let D=M.vertexShaderInputBinders.prop_histogram;D.enable(0);let{group:E,offset:V}=c[C];if(eo(M,"invlerpForHistogram",I,r.bounds.value[b]),D.bind(d[E],e.bufferOffset+V+p[E]*e.count),g[b].bind(256,1),t!==v&&(h.clearColor(0,0,0,0),h.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT)),h.drawArrays(WebGL2RenderingContext.POINTS,0,e.count),Oz){let O=new Float32Array(256*4);h.readPixels(0,0,256,1,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,O);let B=new Float32Array(256);for(let z=0;z<256;++z)B[z]=O[z*4];console.log("histogram",B.join(" "))}D.disable();break}}h.disable(WebGL2RenderingContext.BLEND)}},QS=new Map;function Xo(n,e){QS.set(n,e)}function Qo(n){return QS.get(n)}var tt;(function(c){c[c.GPU_MEMORY=0]="GPU_MEMORY",c[c.SYSTEM_MEMORY=1]="SYSTEM_MEMORY",c[c.SYSTEM_MEMORY_WORKER=2]="SYSTEM_MEMORY_WORKER",c[c.DOWNLOADING=3]="DOWNLOADING",c[c.QUEUED=4]="QUEUED",c[c.NEW=5]="NEW",c[c.FAILED=6]="FAILED",c[c.EXPIRED=7]="EXPIRED"})(tt||(tt={}));var Uh=8,ba;(function(l){l[l.FIRST_TIER=0]="FIRST_TIER",l[l.FIRST_ORDERED_TIER=0]="FIRST_ORDERED_TIER",l[l.VISIBLE=0]="VISIBLE",l[l.PREFETCH=1]="PREFETCH",l[l.LAST_ORDERED_TIER=1]="LAST_ORDERED_TIER",l[l.RECENT=2]="RECENT",l[l.LAST_TIER=2]="LAST_TIER"})(ba||(ba={}));var ZS=3,Gd;(function(t){t[t.totalTime=0]="totalTime",t[t.totalChunks=1]="totalChunks"})(Gd||(Gd={}));var xa;(function(r){r[r.numChunks=0]="numChunks",r[r.systemMemoryBytes=1]="systemMemoryBytes",r[r.gpuMemoryBytes=2]="gpuMemoryBytes"})(xa||(xa={}));var Ca=3,Nz=2,eb=Uh*ZS*Ca+Nz;function Zo(n,e){return n*ZS+e}function tb(n){return Uh*ZS*Ca+n}var NP="ChunkQueueManager",BP="ChunkManager",FP="ChunkSource.invalidate",UP="ChunkQueueManager.requestChunkStatistics",GP="ChunkManager.chunkLayerStatistics",so=class{constructor(){this.numVisibleChunksNeeded=0;this.numVisibleChunksAvailable=0;this.numPrefetchChunksNeeded=0;this.numPrefetchChunksAvailable=0}};var WP=!1,yr=class{constructor(e){this.source=e;this.state=tt.SYSTEM_MEMORY}get gl(){return this.source.gl}copyToGPU(e){this.state=tt.GPU_MEMORY}freeGPUMemory(e){this.state=tt.SYSTEM_MEMORY}};function zP(n){if(typeof n!="number"||n<0)throw new Error(`Expected non-negative number as limit, but received: ${JSON.stringify(n)}`);return n}var Fc=class{constructor({defaultItemLimit:e=Number.POSITIVE_INFINITY,defaultSizeLimit:t=Number.POSITIVE_INFINITY}={}){this.sizeLimit=new Ce(t,zP),this.itemLimit=new Ce(e,zP)}},Wd=class extends Cn{constructor(e,t,r,i){super();this.gl=t;this.frameNumberCounter=r;this.capacities=i;this.visibleChunksChanged=new ne;this.pendingChunkUpdates=null;this.pendingChunkUpdatesTail=null;this.chunkUpdateDeadline=null;this.chunkUpdateDelay=30;this.enablePrefetch=new Xe(!0,!0);let a=o=>({itemLimit:this.registerDisposer(bt.makeFromExisting(e,o.itemLimit)).rpcId,sizeLimit:this.registerDisposer(bt.makeFromExisting(e,o.sizeLimit)).rpcId});this.initializeCounterpart(e,{gpuMemoryCapacity:a(i.gpuMemory),systemMemoryCapacity:a(i.systemMemory),downloadCapacity:a(i.download),computeCapacity:a(i.compute),enablePrefetch:this.registerDisposer(bt.makeFromExisting(e,this.enablePrefetch)).rpcId})}scheduleChunkUpdate(){let e=this.chunkUpdateDeadline,t;e===null||Date.now()<e?t=0:t=this.chunkUpdateDelay,setTimeout(this.processPendingChunkUpdates.bind(this),t)}processPendingChunkUpdates(e=!1){let t=this.chunkUpdateDeadline;!e&&t===null&&(t=Date.now()+30);let r=!1,i=0;for(;;){if(!e&&Date.now()>t){this.chunkUpdateDeadline=null,setTimeout(()=>this.processPendingChunkUpdates(),this.chunkUpdateDelay);break}let a=this.pendingChunkUpdates;if(a==null)break;if(this.applyChunkUpdate(a)&&(r=!0),++i,(this.pendingChunkUpdates=a.nextUpdate)==null){this.pendingChunkUpdatesTail=null;break}}return r&&this.visibleChunksChanged.dispatch(),i}handleFetch_(e,t){let{resolve:r,reject:i,cancellationToken:a}=t.promise;if(a.isCanceled){i(zo);return}let o=t.key,l=e.chunks.get(o);if(!l){i(new Error(`No chunk found at ${o} for source ${e.constructor.name}`));return}let c=l.data;if(!c){i(new Error(`At ${o} for source ${e.constructor.name}: chunk has no data`));return}r({value:c})}applyChunkUpdate(e){let t=!1,{rpc:r}=this,i=r.get(e.source);if(WP&&console.log(`${Date.now()} Chunk.update processed: ${i.rpcId} ${e.id} ${e.state}`),e.promise!==void 0)this.handleFetch_(i,e);else if(e.id===void 0){for(let a of i.chunks.keys())i.deleteChunk(a);t=!0}else{let a=e.state;if(a===tt.EXPIRED)i.deleteChunk(e.id);else{let o,l=e.id;e.new?(o=i.getChunk(e),i.addChunk(l,o)):o=i.chunks.get(l);let c=o.state;if(a!==c)switch(a){case tt.GPU_MEMORY:o.copyToGPU(this.gl),t=!0;break;case tt.SYSTEM_MEMORY:o.freeGPUMemory(this.gl);break;default:throw new Error(`INTERNAL ERROR: Invalid chunk state: ${tt[a]}`)}}}return t}flushPendingChunkUpdates(){return this.processPendingChunkUpdates(!0)}async getStatistics(){let e=this.rpc,t=await e.promiseInvoke(UP,{queue:this.rpcId}),r=new Map;for(let[i,a]of t){let o=e.get(i);o!==void 0&&r.set(o,a)}return r}};Wd=Pt([wn(NP)],Wd);function HP(n,e){let t=n.get(e.source);WP&&console.log(`${Date.now()} Chunk.update received: ${t.rpcId} ${e.id} ${e.state} with chunkDataSize ${e.chunkDataSize}`);let r=t.chunkManager.chunkQueueManager;if(t.immediateChunkUpdates){r.applyChunkUpdate(e)&&r.visibleChunksChanged.dispatch();return}let i=r.pendingChunkUpdatesTail;i==null?(r.pendingChunkUpdates=e,r.pendingChunkUpdatesTail=e,r.scheduleChunkUpdate()):(i.nextUpdate=e,r.pendingChunkUpdatesTail=e)}Lt("Chunk.update",function(n){HP(this,n)});Rh("Chunk.retrieve",function(n,e){return new Promise((t,r)=>{n.promise={resolve:t,reject:r,cancellationToken:e},HP(this,n)})});Lt(GP,function(n){let e=this.get(n.id);for(let t of e.prevStatisticsLayers)t.numVisibleChunksNeeded=0,t.numVisibleChunksAvailable=0,t.numPrefetchChunksNeeded=0,t.numPrefetchChunksAvailable=0;e.prevStatisticsLayers.length=0;for(let t of n.layers){let r=this.get(t.id);if(r===void 0)continue;let i=r.layerChunkProgressInfo;i.numVisibleChunksAvailable=t.numVisibleChunksAvailable,i.numVisibleChunksNeeded=t.numVisibleChunksNeeded,i.numPrefetchChunksAvailable=t.numPrefetchChunksAvailable,i.numPrefetchChunksNeeded=t.numPrefetchChunksNeeded,e.prevStatisticsLayers.push(i)}e.layerChunkStatisticsUpdated.dispatch()});var zd=class extends Cn{constructor(e){super();this.chunkQueueManager=e;this.memoize=new Ed;this.prevStatisticsLayers=[];this.layerChunkStatisticsUpdated=new ne;this.registerDisposer(e.addRef()),this.initializeCounterpart(e.rpc,{chunkQueueManager:e.rpcId})}get gl(){return this.chunkQueueManager.gl}getChunkSource(e,t){let r=e.encodeOptions(t);r.constructorId=lt(e);let i=xn(r);return this.memoize.get(i,()=>{let a=new e(this,t);return a.initializeCounterpart(this.rpc,{}),a.key=r,a})}};zd=Pt([wn(BP)],zd);var Hn=class extends Cn{constructor(e,t={}){super();this.chunkManager=e;this.chunks=new Map;this.immediateChunkUpdates=!1}initializeCounterpart(e,t){t.chunkManager=this.chunkManager.rpcId,super.initializeCounterpart(e,t)}get gl(){return this.chunkManager.chunkQueueManager.gl}deleteChunk(e){let t=this.chunks.get(e);t.state===tt.GPU_MEMORY&&t.freeGPUMemory(this.gl),this.chunks.delete(e)}addChunk(e,t){this.chunks.set(e,t)}getChunk(e){throw new Error("Not implemented.")}invalidateCache(){this.rpc.invoke(FP,{id:this.rpcId})}static encodeOptions(e){return{}}};function nt(n,e){let t=class extends n{constructor(...i){super(...i);let a=i[1];this.parameters=a.parameters}initializeCounterpart(i,a){a.parameters=this.parameters,super.initializeCounterpart(i,a)}static encodeOptions(i){return Object.assign({parameters:i.parameters},super.encodeOptions(i))}};return t=Pt([wn(e.RPC_ID)],t),t}var wa=class extends Cn{constructor(e){super();this.layerChunkProgressInfo=e}};function Me(n){for(;;){let e=n.firstChild;if(!e)break;n.removeChild(e)}}function et(n){let{parentElement:e}=n;return e?(e.removeChild(n),!0):!1}function Tn(n,e=Math.max(1,n.value.length)){let t=`${e}ch`;n.style.width!==t&&(n.style.width="0px",n.offsetWidth,n.style.width=t)}function $n(n,e){let t=n.firstElementChild;for(let r of e)r!==t&&n.insertBefore(r,t),t=r.nextElementSibling;for(;t!==null;){let r=t.nextElementSibling;n.removeChild(t),t=r}}function Hd(n){return n instanceof HTMLElement?!!(n instanceof HTMLInputElement||n instanceof HTMLTextAreaElement||n.isContentEditable):!1}function $P(n){let e=n.cloneNode(!0);return e.style.position="absolute",document.body.appendChild(e),e.getBoundingClientRect()}var jP=class extends H{constructor(e){super();this.redraw=e}},Ln=class extends H{constructor(e,t,r=new wt(wt.VISIBLE)){super();this.model=e;this.render=t;this.visibility=r;this.element=document.createElement("div");this.generation=-1;this.currentViewDisposer=void 0;this.debouncedUpdateView=this.registerCancellable(We(()=>this.updateView()));this.element.style.display="contents",this.registerDisposer(e.changed.add(this.debouncedUpdateView)),this.registerDisposer(r.changed.add(()=>{this.visible&&this.debouncedUpdateView()})),this.updateView()}get visible(){return this.visibility.visible}updateView(){if(!this.visible)return;let{model:e}=this;if(e.changed.count===this.generation)return;this.disposeCurrentView();let r=this.currentViewDisposer=new jP(this.debouncedUpdateView);this.render(e.value,this.element,r)}disposeCurrentView(){let{currentViewDisposer:e}=this;e!==void 0&&e.dispose(),Me(this.element)}disposed(){this.disposeCurrentView(),super.disposed()}};var Nt=class extends H{constructor(e=new wt(wt.VISIBLE)){super();this.visibility=e;this.element=document.createElement("div");let{element:t}=this;t.classList.add("neuroglancer-tab-content")}get visible(){return this.visibility.visible}disposed(){et(this.element),super.disposed()}},JP=class extends H{constructor(){super(...arguments);this.changed=new ne;this.options=new Map;this.optionsChanged=new ne;this.selectedValue=void 0;this.defaultValue=void 0;this.ready_=!0}get value(){let{selectedValue:e}=this;return e!==void 0?e:this.defaultValue}set default(e){this.defaultValue!==e&&(this.defaultValue=e,this.changed.dispatch())}get default(){return this.defaultValue}set value(e){e!==void 0&&this.ready_&&!this.options.has(e)&&(e=void 0);let{selectedValue:t}=this;t!==e&&(this.selectedValue=e,this.changed.dispatch())}get validValue(){let e=this.selectedValue;return e===void 0||!this.options.has(e)?this.defaultValue:e}add(e,t){let{options:r}=this;if(r.has(e))throw new Error(`Option already defined: ${JSON.stringify(e)}.`);r.set(e,t),this.optionsChanged.dispatch(),this.defaultValue===void 0&&(this.default=e)}remove(e){let{options:t}=this;if(!t.has(e))throw new Error(`Option is not defined: ${JSON.stringify(e)}.`);t.delete(e),this.optionsChanged.dispatch()}toJSON(){let{value:e,defaultValue:t}=this;if(e!==t)return e}reset(){this.value=void 0}get ready(){return this.ready_}set ready(e){e!==this.ready_&&(this.ready_=e,e&&(this.value=this.value),this.changed.dispatch())}restoreState(e){typeof e!="string"&&(e=void 0),this.value=e}},qP=class extends H{constructor(e,t,r=new wt(wt.VISIBLE),i=!1){super();this.getter=e;this.selected=t;this.visibility=r;this.invalidateByDefault=i;this.element=document.createElement("div");this.tabs=new Map;this.tabVisibilityChanged=new $e;this.debouncedUpdateSelectedTab=this.registerCancellable(We(()=>this.updateSelectedTab()));let{element:a}=this;a.className="neuroglancer-stack-view",this.registerDisposer(r.changed.add(this.debouncedUpdateSelectedTab)),this.registerDisposer(t.changed.add(this.debouncedUpdateSelectedTab)),this.updateSelectedTab()}get visible(){return this.visibility.visible}flush(){this.debouncedUpdateSelectedTab.flush()}invalidate(e){let{tabs:t}=this,r=t.get(e);r!==void 0&&(r.dispose(),t.delete(e),e===this.displayedTab&&(this.displayedTab=void 0,this.debouncedUpdateSelectedTab()))}hideTab(e){let t=this.tabs.get(e);t!==void 0&&(t.visibility.value=wt.IGNORED,t.element.style.display="none"),this.tabVisibilityChanged.dispatch(e,!1)}showTab(e){let{tabs:t}=this,r=t.get(e);r===void 0&&(r=this.getter(e),this.element.appendChild(r.element),t.set(e,r)),r.element.style.display="",r.visibility.value=wt.VISIBLE,this.tabVisibilityChanged.dispatch(e,!0)}updateSelectedTab(){let{displayedTab:e}=this,t=this.visible?this.selected.value:void 0;t===e&&(t===void 0||this.tabs.has(t))||(e!==void 0&&this.hideTab(e),this.invalidateByDefault&&this.invalidateAll(),this.displayedTab=t,t!==void 0&&this.showTab(t))}invalidateAll(e=void 0){let{tabs:t}=this;for(let[r,i]of t)e!==void 0&&e(r)||(t.delete(r),i.dispose());this.debouncedUpdateSelectedTab()}disposed(){this.invalidateAll(),et(this.element),super.disposed()}},nb=class extends JP{};function Bz(n,e){let t="neuroglancer-selected-tab-label";e?n.classList.add(t):n.classList.remove(t)}var rb=class extends H{constructor(e,t=new wt(wt.VISIBLE)){super();this.visibility=t;this.element=document.createElement("div");this.tabBar=document.createElement("div");this.tabLabels=new Map;this.tabsGeneration=-1;this.debouncedUpdateView=this.registerCancellable(We(()=>this.updateTabs()));this.tabs=e.tabs,this.selectedTab=e.selectedTab,this.handleTabElement=e.handleTabElement;let{element:r,tabBar:i}=this;r.className="neuroglancer-tab-view",i.className="neuroglancer-tab-view-bar",r.appendChild(i),this.registerDisposer(t.changed.add(this.debouncedUpdateView));let a=this.stack=this.registerDisposer(new qP(e.makeTab,e.selectedTab,this.visibility));r.appendChild(a.element),this.registerDisposer(e.tabs.changed.add(this.debouncedUpdateView));let o=this.selectedTab.value;this.registerDisposer(e.selectedTab.changed.add(()=>{let c=this.tabs.value.find(({id:d})=>d===o);(c==null?void 0:c.hidden)?(this.tabs.changed.count++,this.debouncedUpdateView()):this.updateTabLabelStyles(),o=this.selectedTab.value})),this.updateTabs()}get visible(){return this.visibility.visible}updateTabLabelStyles(){let e=this.selectedTab.value;for(let[t,r]of this.tabLabels)Bz(r,t===e)}updateTabs(){this.tabsGeneration!==this.tabs.changed.count&&(this.destroyTabs(),this.visible&&this.makeTabs())}destroyTabs(){if(this.tabsGeneration!==-1){if(this.tabLabels.clear(),!this.visible)this.stack.invalidateAll();else{let e=this.tabs.value;this.stack.invalidateAll(t=>e.find(({id:r})=>r===t)!==void 0)}Me(this.tabBar),this.tabsGeneration=-1}}makeTabs(){let{tabBar:e,tabLabels:t,handleTabElement:r}=this;for(let{id:i,label:a,hidden:o}of this.tabs.value){if(o&&i!==this.selectedTab.value)continue;let l=document.createElement("div");l.classList.add("neuroglancer-tab-label"),l.textContent=a,l.addEventListener("click",()=>{this.selectedTab.value=i}),r!==void 0&&r(i,l),t.set(i,l),e.appendChild(l)}this.updateTabLabelStyles(),this.tabsGeneration=this.tabs.changed.count}disposed(){Me(this.tabBar),this.tabLabels.clear(),et(this.element),super.disposed()}};var Kt;(function(i){i[i.MIN_REPRESENTATIVE=0]="MIN_REPRESENTATIVE",i[i.MAX_REPRESENTATIVE=1]="MAX_REPRESENTATIVE",i[i.REPRESENTATIVE_EXCLUDED=2]="REPRESENTATIVE_EXCLUDED",i[i.NONREPRESENTATIVE_EXCLUDED=4]="NONREPRESENTATIVE_EXCLUDED"})(Kt||(Kt={}));var ib=class extends Nt{constructor(e){super();this.layer=e;let{element:t}=this;t.appendChild(this.registerDisposer(new Ln(e.displayState.segmentationGroupState.value.graph,(r,i,a)=>{(r==null?void 0:r.tabContents)&&i.appendChild(r.tabContents(e,a,this))})).element)}},sl=class{},ll=class extends H{constructor(e,t){super();this.graph=e;this.segmentsState=t}createRenderLayers(e,t,r){return[]}};function Uc(n){return!(n.high>>>31)}var ab=new X(4294967295,4294967295);var ob=["visibleSegments","segmentEquivalences","temporaryVisibleSegments","temporarySegmentEquivalences","useTemporaryVisibleSegments","useTemporarySegmentEquivalences"];function YP(n,e,t){n.registerDisposer(e.visibleSegments.changed.add(t)),n.registerDisposer(e.segmentEquivalences.changed.add(t))}function KP(n,e,t){n.registerDisposer(e.temporaryVisibleSegments.changed.add(t)),n.registerDisposer(e.temporarySegmentEquivalences.changed.add(t)),n.registerDisposer(e.useTemporaryVisibleSegments.changed.add(t)),n.registerDisposer(e.useTemporarySegmentEquivalences.changed.add(t))}function Rr(n){return`${n.low},${n.high}`}function Fz(n){return!!(n.high>>>31)}function sb(n){return n.useTemporaryVisibleSegments.value?n.temporaryVisibleSegments:n.visibleSegments}function Uz(n){return n.useTemporarySegmentEquivalences.value?n.temporarySegmentEquivalences:n.segmentEquivalences}function Ta(n,e){let t=sb(n),r=Uz(n),i=r.disjointSets.visibleSegmentEquivalencePolicy.value;for(let a of t.unsafeKeys())if(i&Kt.NONREPRESENTATIVE_EXCLUDED){let o=r.get(a);e(a,o)}else{if(!r.disjointSets.isMinElement(a))continue;for(let o of r.setElements(a))i&Kt.REPRESENTATIVE_EXCLUDED&&i&Kt.MAX_REPRESENTATIVE&&Fz(o)||e(o,a)}}var a1=Ye(gt());var lb=Ye(gt());var XP="rendered_view.addLayer",QP="rendered_view.removeLayer",ZP="SharedProjectionParameters",e1="SharedProjectionParameters.changed";var vr;(function(r){r[r.info=0]="info",r[r.warning=1]="warning",r[r.error=2]="error"})(vr||(vr={}));var Ui=class{constructor(){this.changed=new ne;this.messages=[];this.children=[]}addMessage(e){this.messages.push(e),this.changed.dispatch()}clearMessages(){let{messages:e}=this;e.length!==0&&(e.length=0,this.changed.dispatch())}isEmpty(){return this.messages.length===0&&!this.children.some(e=>!e.isEmpty())}addChild(e){return this.children.push(e),e.changed.add(this.changed.dispatch),e.isEmpty()||this.changed.dispatch(),()=>{let{children:t}=this;t.splice(t.indexOf(e),1),e.changed.remove(this.changed.dispatch),e.isEmpty()||this.changed.dispatch()}}*[Symbol.iterator](){yield*this.messages;for(let e of this.children)yield*e}};var _n;(function(r){r[r.DATA=0]="DATA",r[r.ANNOTATION=1]="ANNOTATION",r[r.DEFAULT_ANNOTATION=2]="DEFAULT_ANNOTATION"})(_n||(_n={}));function t1(){return new Sc([0,1,2])}var Gh=class extends H{constructor(){super(...arguments);this.role=0;this.messages=new Ui;this.layerChanged=new ne;this.redrawNeeded=new ne;this.layerChunkProgressInfo=new so}handleAction(e){}getValueAt(e){}transformPickedValue(e){return e.pickedValue}updateMouseState(e,t,r,i){}},$d=class extends Gh{constructor(){super(...arguments);this.visibility=new to}attach(e){}};function es(n,e,t){let{state:r}=t;if(r===void 0||r.transform!==n||r.displayDimensionRenderInfo!==e){if(t.messages.clearMessages(),r=t.state={transform:n,displayDimensionRenderInfo:e,modelTransform:void 0},n.error!==void 0){t.messages.addMessage({severity:vr.error,message:n.error});return}try{let i=oe.create();uD(i,e,n),r.modelTransform=i}catch(i){t.messages.addMessage({severity:vr.error,message:i.message})}}return r.modelTransform}var jd=class extends H{constructor(e){super();this.renderViewport=new Dc;this.changed=new $e;let{parametersConstructor:t=Dd,navigationState:r,update:i,isEqual:a=jE}=e;this.oldValue_=new t,this.value_=new t;let o=()=>{let{oldValue_:c,value_:d}=this;c.displayDimensionRenderInfo=r.displayDimensionRenderInfo.value,Object.assign(c,this.renderViewport);let{globalPosition:p}=c,h=r.position.value,g=h.length;p.length!==g&&(c.globalPosition=p=new Float32Array(g)),p.set(h),i(c,r),!a(c,d)&&(this.value_=c,this.oldValue_=d,this.changed.dispatch(d,c))},l=this.update=this.registerCancellable((0,lb.default)(o,0));this.registerDisposer(r.changed.add(l)),o()}setViewport(e){mh(e,this.renderViewport)||(Object.assign(this.renderViewport,e),this.update())}get value(){return this.update.flush(),this.value_}},cl=class extends Cn{constructor(e,t,r=10){super();this.base=t;this.updateInterval=r;this.prevDisplayDimensionRenderInfo=void 0;this.update=this.registerCancellable((0,lb.default)((e,t)=>{let r;if(t.displayDimensionRenderInfo!==this.prevDisplayDimensionRenderInfo)r=t,this.prevDisplayDimensionRenderInfo=t.displayDimensionRenderInfo;else{let{displayDimensionRenderInfo:i,...a}=t;r=a}this.rpc.invoke(e1,{id:this.rpcId,value:r})},this.updateInterval));this.initializeCounterpart(e,{value:t.value}),this.registerDisposer(t.changed.add(this.update))}flush(){this.update.flush()}};cl=Pt([wn(ZP)],cl);var ln=40,n1=.5,r1=-4;function Jd(n){return(Math.log2(n)-r1)/n1}function i1(n){return 2**(n*n1+r1)}function Gi(n){return new Ce(n,ot)}var La=class{constructor(){this.visibility=new to;this.changed=new ne;this.frameNumber=-1;this.spatialScales=new Map;this.numHistogramRows=1;this.value=new Uint32Array(ln*this.numHistogramRows*2)}begin(e){e!==this.frameNumber&&(this.value.fill(0),this.frameNumber=e,this.spatialScales.clear(),this.changed.dispatch())}add(e,t,r,i){let{spatialScales:a,numHistogramRows:o,value:l}=this,c=a.get(e);if(c===void 0&&(c=a.size,a.set(e,c)),c>=o){this.numHistogramRows=o*=2;let p=new Uint32Array(o*ln*2);p.set(l),this.value=l=p}let d=c*ln*2+Math.min(Math.max(0,Math.round(Jd(t))),ln-1);l[d]+=r,l[d+ln]+=i}};var Gc=class extends Gh{constructor(e,t,r){super();this.chunkManager=e;this.multiscaleSource=t;this.rpcId=null;this.rpcTransfer={};this.visibleSources=new Map;this.visibleSourcesList_=[];var a;let{renderScaleTarget:i=Gi(1)}=r;this.renderScaleTarget=i,this.renderScaleHistogram=r.renderScaleHistogram,this.transform=r.transform,this.localPosition=r.localPosition,this.rpcTransfer=r.rpcTransfer||{},this.dataHistogramSpecifications=this.registerDisposer((a=r.dataHistogramSpecifications)!=null?a:new Fd(Pr([]),Pr([]),Pr([]))),this.registerDisposer(this.dataHistogramSpecifications.visibility.changed.add(this.redrawNeeded.dispatch))}getDataHistogramCount(){return this.dataHistogramSpecifications.visibleHistograms}getSources(e){return this.multiscaleSource.getSources(e)}addSource(e,t){let{visibleSources:r}=this,i=r.get(e);i!==void 0?(++i.refCount,i.chunkTransform=t):(r.set(e,{source:e,refCount:1,chunkTransform:t}),this.visibleSourcesList_.length=0)}removeSource(e){let{visibleSources:t}=this,r=t.get(e);r.refCount!==1?--r.refCount:(t.delete(e),this.visibleSourcesList_.length=0)}get visibleSourcesList(){let{visibleSources:e,visibleSourcesList_:t}=this;if(t.length===0&&e.size!==0){for(let r of e.values())t.push(r);t.sort((r,i)=>r.chunkTransform.chunkToLayerTransformDet-i.chunkTransform.chunkToLayerTransformDet)}return t}initializeCounterpart(){let e=this.registerDisposer(new wa(this.layerChunkProgressInfo)),t=this.chunkManager.rpc;e.RPC_TYPE_ID=this.RPC_TYPE_ID,e.initializeCounterpart(t,{localPosition:this.registerDisposer(bt.makeFromExisting(t,this.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(bt.makeFromExisting(t,this.renderScaleTarget)).rpcId,...this.rpcTransfer}),this.rpcId=e.rpcId}get gl(){return this.chunkManager.chunkQueueManager.gl}setGLBlendMode(e,t){t>0?(e.enable(WebGL2RenderingContext.BLEND),e.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA)):e.disable(WebGL2RenderingContext.BLEND)}filterVisibleSources(e,t){return CD(e,this,t)}};Gc.prototype.RPC_TYPE_ID=TD;var di=class extends $d{draw(e,t){}isReady(e,t){return!0}};var o1=class extends IS{},Gz=ya(o1);function Wz(n){return{source:n.source.addCounterpartRef(),effectiveVoxelSize:n.effectiveVoxelSize,layerRank:n.layerRank,nonDisplayLowerClipBound:n.nonDisplayLowerClipBound,nonDisplayUpperClipBound:n.nonDisplayUpperClipBound,lowerClipBound:n.lowerClipBound,upperClipBound:n.upperClipBound,lowerClipDisplayBound:n.lowerClipDisplayBound,upperClipDisplayBound:n.upperClipDisplayBound,chunkDisplayDimensionIndices:n.chunkDisplayDimensionIndices,lowerChunkDisplayBound:n.lowerChunkDisplayBound,upperChunkDisplayBound:n.upperChunkDisplayBound,fixedLayerToChunkTransform:n.fixedLayerToChunkTransform,combinedGlobalLocalToChunkTransform:n.combinedGlobalLocalToChunkTransform,chunkLayout:n.chunkLayout.toObject()}}function ul(n){return n.map(e=>e.map(Wz))}function cb(n,e){for(let t of e)for(let{source:r}of t)n.removeSource(r),r.dispose()}var Wc=class extends Gz{constructor(e,t,r,i){super(new jd({parametersConstructor:PS,navigationState:r,update:(l,c)=>{let{invViewMatrix:d,centerDataPosition:p}=l;c.toMat4(d);let{canonicalVoxelFactors:h,voxelPhysicalScales:g}=l.displayDimensionRenderInfo;for(let D=0;D<3;++D)p[D]=d[12+D];let{logicalWidth:v,logicalHeight:b,projectionMat:x,viewportNormalInGlobalCoordinates:C,viewportNormalInCanonicalCoordinates:T}=l,{relativeDepthRange:P}=c;oe.ortho(x,-v/2,v/2,b/2,-b/2,-P,P),hh(l,x),Sh(l);let{viewMatrix:I}=l;for(let D=0;D<3;++D){let E=C[D]=I[D*4+2];T[D]=E/h[D]}K.normalize(C,C),K.normalize(T,T);let M=0;for(let D=0;D<3;++D){let E=g[D],V=d[D];M+=(E*V)**2}M=Math.sqrt(M),l.pixelSize=M}}));this.chunkManager=e;this.layerManager=t;this.navigationState=r;this.wireFrame=i;this.gl=this.chunkManager.gl;this.viewChanged=new ne;this.renderingStale=!0;this.visibleChunksStale=!0;this.visibleLayerList=new Array;this.offscreenFramebuffer=this.registerDisposer(new Bi(this.gl,{colorBuffers:ol(this.gl,1),depthBuffer:new YS(this.gl)}));this.histogramInputTextures=[];this.offscreenFramebuffersWithHistograms=[this.offscreenFramebuffer];this.histogramGenerator=Ud.get(this.gl);this.updateVisibleLayers=this.registerCancellable((0,a1.default)(()=>{this.updateVisibleLayersNow()},0));this.registerDisposer(r),this.registerDisposer(this.projectionParameters),this.registerDisposer(this.projectionParameters.changed.add((l,c)=>{l.displayDimensionRenderInfo!==c.displayDimensionRenderInfo&&this.updateVisibleLayers()}));let a=this.chunkManager.rpc,o=this.sharedProjectionParameters=this.registerDisposer(new cl(a,this.projectionParameters));this.initializeCounterpart(a,{chunkManager:e.rpcId,projectionParameters:o.rpcId}),this.registerDisposer(t.layersChanged.add(()=>{this.updateVisibleLayers()})),this.wireFrame.changed.add(this.viewChanged.dispatch),this.viewChanged.add(()=>{this.renderingStale=!0}),this.registerDisposer(e.chunkQueueManager.visibleChunksChanged.add(this.viewChanged.dispatch)),this.updateVisibleLayers()}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}computeHistograms(e,t){this.histogramGenerator.compute(e,this.offscreenFramebuffer.depthBuffer.texture,this.histogramInputTextures,t,this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber)}flushBackendProjectionParameters(){this.sharedProjectionParameters.flush()}forEachVisibleChunk(e,t,r){ID(this.projectionParameters.value,e.renderLayer.localPosition.value,e,t,()=>{r(e.curPositionInChunks.join())})}isReady(){if(!this.navigationState.valid)return!1;this.updateVisibleLayers.flush(),this.updateVisibleSources();let e=0,t=0;for(let{visibleSources:r}of this.visibleLayers.values())for(let i of r){let a=Nc(this.projectionParameters.value,i.chunkLayout),{source:o}=i,{chunks:l}=o;this.forEachVisibleChunk(i,a,c=>{let d=l.get(c);++t,d&&d.state===tt.GPU_MEMORY&&++e})}return e===t}invalidateVisibleSources(){super.invalidateVisibleSources(),this.viewChanged.dispatch()}bindVisibleRenderLayer(e,t){t.push(e.localPosition.changed.add(()=>this.invalidateVisibleChunks())),t.push(e.redrawNeeded.add(this.viewChanged.dispatch)),t.push(e.transform.changed.add(this.updateVisibleLayers)),t.push(e.renderScaleTarget.changed.add(()=>this.invalidateVisibleSources()));let{renderScaleHistogram:r}=e;r!==void 0&&t.push(r.visibility.add(this.visibility)),t.push(e.dataHistogramSpecifications.producerVisibility.add(this.visibility))}updateVisibleLayersNow(){if(this.wasDisposed||!this.navigationState.valid)return!1;let e=Date.now(),{visibleLayers:t,visibleLayerList:r}=this,{displayDimensionRenderInfo:i}=this.projectionParameters.value,a=this.rpc,o={id:this.rpcId},l=!1;r.length=0;for(let c of this.layerManager.readyRenderLayers())if(c instanceof Gc){r.push(c);let d=t.get(c);if(d===void 0){let p=[],h=new Ui;d={messages:h,allSources:this.getTransformedSources(c,h),transformGeneration:c.transform.changed.count,visibleSources:[],disposers:p,lastSeenGeneration:e,displayDimensionRenderInfo:i},p.push(c.messages.addChild(d.messages)),t.set(c.addRef(),d),this.bindVisibleRenderLayer(c,p)}else{d.lastSeenGeneration=e;let p=c.transform.changed.count;if(d.transformGeneration===p&&d.displayDimensionRenderInfo===i)continue;let h=d.allSources;d.allSources=this.getTransformedSources(c,d.messages),cb(c,h),d.visibleSources.length=0,d.displayDimensionRenderInfo=i,d.transformGeneration=p}o.layerId=c.rpcId,o.sources=ul(d.allSources),this.flushBackendProjectionParameters(),a.invoke(LD,o),l=!0}for(let[c,d]of t)d.lastSeenGeneration!==e&&(o.layerId=c.rpcId,a.invoke(kD,o),t.delete(c),cb(c,d.allSources),$a(d.disposers),c.dispose(),l=!0);return l&&(this.visibleSourcesStale=!0),this.viewChanged.dispatch(),l}invalidateVisibleChunks(){super.invalidateVisibleChunks(),this.viewChanged.dispatch()}get valid(){return this.navigationState.valid}getOffscreenFramebufferWithHistograms(e){let{offscreenFramebuffersWithHistograms:t}=this,r=t[e];if(r===void 0){let{gl:i,histogramInputTextures:a,offscreenFramebuffer:o}=this;a.length<e&&a.push(...ol(i,e-a.length,WebGL2RenderingContext.R8,WebGL2RenderingContext.RED));let l=[o.colorBuffers[0].addRef()];for(let c=0;c<e;++c)l.push(a[c].addRef());r=this.registerDisposer(new Bi(i,{colorBuffers:l,depthBuffer:o.depthBuffer.addRef()})),t[e]=r}return r}updateRendering(){let e=this.projectionParameters.value,{width:t,height:r}=e;if(!this.renderingStale||!this.valid||t===0||r===0)return;this.renderingStale=!1,this.updateVisibleLayers.flush(),this.updateVisibleSources();let{gl:i,offscreenFramebuffer:a}=this;a.bind(t,r),i.disable(i.SCISSOR_TEST),i.clearColor(0,0,0,0),i.colorMask(!0,!0,!0,!0),i.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);let o=0,l=this.wireFrame.value,c={sliceView:this,projectionParameters:e,wireFrame:l};for(let d of this.visibleLayerList){let p=l?0:d.getDataHistogramCount();this.getOffscreenFramebufferWithHistograms(p).bind(t,r);for(let g=0;g<p;++g)i.clearBufferfv(WebGL2RenderingContext.COLOR,1+g,gd);i.enable(WebGL2RenderingContext.DEPTH_TEST),i.depthFunc(WebGL2RenderingContext.LESS),i.clearDepth(1),i.clear(WebGL2RenderingContext.DEPTH_BUFFER_BIT),d.setGLBlendMode(i,o),d.draw(c),++o}i.disable(WebGL2RenderingContext.BLEND),i.disable(WebGL2RenderingContext.DEPTH_TEST),a.unbind()}disposed(){for(let[e,t]of this.visibleLayers)cb(e,t.allSources),$a(t.disposers),e.dispose();this.visibleLayers.clear(),this.visibleLayerList.length=0}getTransformedSources(e,t){let r=fl(this.projectionParameters.value.displayDimensionRenderInfo,e.transform.value,i=>e.getSources(i),t,e);for(let i of r)for(let a of i)e.addSource(a.source,a.chunkTransform);return r}};Wc=Pt([wn(wD)],Wc);var dl=class extends Hn{constructor(e,t){super(e,t);this.spec=t.spec}static encodeSpec(e){return{chunkDataSize:Array.from(e.chunkDataSize),lowerVoxelBound:Array.from(e.lowerVoxelBound),upperVoxelBound:Array.from(e.upperVoxelBound)}}static encodeOptions(e){let t=super.encodeOptions(e);return t.spec=this.encodeSpec(e.spec),t}initializeCounterpart(e,t){t.spec=this.spec,super.initializeCounterpart(e,t)}},qd=class extends yr{constructor(e,t){super(e);this.chunkGridPosition=t.chunkGridPosition,this.state=tt.SYSTEM_MEMORY}},pl=class extends H{constructor(e,t){super();this.gl=e;this.copyVertexPositionsBuffer=Yo(this.gl);this.textureCoordinateAdjustment=new Float32Array(4);let r=new gr(e);r.addVarying("vec2","vTexCoord"),r.addUniform("sampler2D","uSampler"),r.addInitializer(i=>{e.uniform1i(i.uniform("uSampler"),0)}),r.addUniform("vec4","uColorFactor"),r.addUniform("vec4","uBackgroundColor"),r.addUniform("mat4","uProjectionMatrix"),r.addUniform("vec4","uTextureCoordinateAdjustment"),r.require(t),r.setFragmentMain(`
vec4 sampledColor = texture(uSampler, vTexCoord);
if (sampledColor.a == 0.0) {
  sampledColor = uBackgroundColor;
}
emit(sampledColor * uColorFactor, 0u);
`),r.addAttribute("vec4","aVertexPosition"),r.setVertexMain(`
vTexCoord = uTextureCoordinateAdjustment.xy + 0.5 * (aVertexPosition.xy + 1.0) * uTextureCoordinateAdjustment.zw;
gl_Position = uProjectionMatrix * aVertexPosition;
`),this.shader=this.registerDisposer(r.build())}draw(e,t,r,i,a,o,l,c){let{gl:d,shader:p,textureCoordinateAdjustment:h}=this;h[0]=a,h[1]=o,h[2]=l-a,h[3]=c-o,p.bind(),d.activeTexture(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,e),d.disable(WebGL2RenderingContext.BLEND),d.uniformMatrix4fv(p.uniform("uProjectionMatrix"),!1,t),d.uniform4fv(p.uniform("uColorFactor"),r),d.uniform4fv(p.uniform("uBackgroundColor"),i),d.uniform4fv(p.uniform("uTextureCoordinateAdjustment"),h);let g=p.attribute("aVertexPosition");this.copyVertexPositionsBuffer.bindToVertexAttrib(g,2),d.drawArrays(d.TRIANGLE_FAN,0,4),d.disableVertexAttribArray(g),d.bindTexture(d.TEXTURE_2D,null)}static get(e,t){return e.memoize.get(`sliceview/SliceViewRenderHelper:${lt(t)}`,()=>new pl(e,t))}},ub=class{constructor(e){this.chunkManager=e}};function fl(n,e,t,r,i){r.clearMessages();let a=T=>(r.addMessage({severity:vr.error,message:T}),[]);if(e.error!==void 0)return a(e.error);let o=e.rank,l=e.unpaddedRank,{displayDimensionIndices:c,displayRank:d,canonicalVoxelFactors:p}=n,h=Ih(e,c),{displayToLayerDimensionIndices:g}=h,v=new Float32Array(d*l),{modelToRenderLayerTransform:b}=e;for(let T=0;T<d;++T){let P=g[T];if(P===-1)continue;let I=p[T];for(let M=0;M<l;++M)v[d*M+T]=b[(o+1)*M+P]*I}let x=t({displayRank:d,multiscaleToViewTransform:v,modelChannelDimensionIndices:e.channelToRenderLayerDimensions}),{voxelPhysicalScales:C}=n;try{let T=P=>{let{chunkSource:I}=P,{spec:M}=I,{lowerClipBound:D=M.lowerVoxelBound,upperClipBound:E=M.upperVoxelBound}=P,V=el(e,P.chunkToMultiscaleTransform),{chunkDataSize:O}=M,{channelToChunkDimensionIndices:B}=V,z=new Float32Array(l),_=new Float32Array(l);z.set(D),_.set(E);let F=B.length,{channelSpaceShape:N}=e;for(let it=0;it<F;++it){let Ve=B[it];if(Ve===-1)continue;let ft=N[it];if(O[Ve]!==ft)throw new Error("Channel dimension "+e.layerDimensionNames[e.channelToRenderLayerDimensions[it]]+` has extent ${ft} but corresponding chunk dimension has extent ${O[Ve]}`);z[Ve]=Number.NEGATIVE_INFINITY,_[Ve]=Number.POSITIVE_INFINITY}let J=Ah(V,h),ae=K.create(),pe=K.create(),me=K.create(),Ae=K.create(),le=K.create(),{numChunkDisplayDims:we,chunkDisplayDimensionIndices:_e}=J,{combinedGlobalLocalToChunkTransform:Fe,layerRank:rt,combinedGlobalLocalRank:ye}=V,Le=new Float32Array(Fe);for(let it=0;it<we;++it){let Ve=_e[it];for(let ft=0;ft<=ye;++ft)Le[Ve+ft*rt]=0;Ve<l?(le[it]=M.chunkDataSize[Ve],ae[it]=M.lowerChunkBound[Ve],pe[it]=M.upperChunkBound[Ve],me[it]=D[Ve],Ae[it]=E[Ve],z[Ve]=Number.NEGATIVE_INFINITY,_[Ve]=Number.POSITIVE_INFINITY):(le[it]=1,ae[it]=0,pe[it]=1,me[it]=0,Ae[it]=1)}le.fill(1,we),ae.fill(0,we),pe.fill(1,we),me.fill(0,we),Ae.fill(1,we);let je=new tl(le,J.displaySubspaceModelMatrix,we),qe=je.localSpatialVectorToGlobal(K.create(),Kf);for(let it=0;it<d;++it)qe[it]=Math.abs(qe[it]*C[it]);return qe.fill(1,d),{layerRank:rt,lowerClipBound:D,upperClipBound:E,nonDisplayLowerClipBound:z,nonDisplayUpperClipBound:_,renderLayer:i,source:I,lowerChunkDisplayBound:ae,upperChunkDisplayBound:pe,lowerClipDisplayBound:me,upperClipDisplayBound:Ae,effectiveVoxelSize:qe,chunkLayout:je,chunkDisplayDimensionIndices:_e,fixedLayerToChunkTransform:Le,curPositionInChunks:new Float32Array(l),combinedGlobalLocalToChunkTransform:V.combinedGlobalLocalToChunkTransform,fixedPositionWithinChunk:new Uint32Array(l),chunkTransform:V,chunkDisplayTransform:J}};return x.map(P=>P.map(I=>T(I)))}catch(T){for(let D of x)for(let{chunkSource:E}of D)E.dispose();let{globalDimensionNames:P}=n,M=`Cannot render (${Array.from(n.displayDimensionIndices.filter(D=>D!==-1),D=>P[D]).join(",\xA0")}) cross section: ${T.message}`;return a(M)}}var hl=null,zz=200,Ee=class{constructor(e=!1){if(hl===null){hl=document.createElement("ul"),hl.id="statusContainer";let r=document.getElementById("neuroglancer-container");r?r.appendChild(hl):document.body.appendChild(hl)}let t=document.createElement("li");this.element=t,e===!0&&(e=zz),e!==!1?(this.setVisible(!1),this.timer=window.setTimeout(this.setVisible.bind(this,!0),e)):this.timer=null,hl.appendChild(t)}dispose(){hl.removeChild(this.element),this.element=void 0,this.timer!==null&&clearTimeout(this.timer)}setText(e,t){this.element.textContent=e,t&&this.setVisible(!0)}setHTML(e,t){this.element.innerHTML=e,t&&this.setVisible(!0)}setVisible(e){this.timer!==null&&(clearTimeout(this.timer),this.timer=null),this.element.style.display=e?"block":"none"}static forPromise(e,t){let r=new Ee(t.delay);r.setText(t.initialMessage);let i=r.dispose.bind(r);return e.then(i,a=>{let o;a instanceof Error?o=a.message:o=""+a;let{errorPrefix:l=""}=t;r.setErrorMessage(l+o),r.setVisible(!0)}),e}setErrorMessage(e){this.element.textContent=e+" ";let t=document.createElement("button");t.textContent="Dismiss",t.addEventListener("click",()=>{this.dispose()}),this.element.appendChild(t)}static showMessage(e){let t=new Ee;return t.element.textContent=e,t.setVisible(!0),t}static showTemporaryMessage(e,t=2e3){let r=this.showMessage(e);return window.setTimeout(()=>r.dispose(),t),r}};function db(n){let e=0,{typeToIds:t}=n;for(let r of Mi)e+=Qo(r).pickIdsPerInstance*t[r].length;return e}var pb=class{constructor(e){this.bufferValid=!1;this.numPickIds=0;this.serializedAnnotations={data:e.data,typeToIds:e.typeToIds,typeToOffset:e.typeToOffset,typeToIdMaps:e.typeToIdMaps}}freeGPUMemory(e){let{buffer:t}=this;t!==void 0&&(t.dispose(),this.bufferValid=!1,this.buffer=void 0)}},s1=class extends yr{constructor(e,t){super(e);t.data!==void 0&&(this.data=new pb(t))}freeGPUMemory(e){super.freeGPUMemory(e);let{data:t}=this;t!==void 0&&t.freeGPUMemory(e)}dispose(){this.data=void 0}},fb=class extends qd{constructor(e,t){super(e,t);t.data!==void 0&&(this.data=new pb(t))}freeGPUMemory(e){super.freeGPUMemory(e);let{data:t}=this;t!==void 0&&t.freeGPUMemory(e)}dispose(){this.data=void 0}},ml=class extends dl{constructor(e,t){super(e,t);this.immediateChunkUpdates=!0;(this.parent=t.parent).spatiallyIndexedSources.add(this);let{rank:i,chunkDataSize:a}=this.spec,o=this.multiscaleToChunkTransform=new Float32Array((i+1)**2);Mc(o,i+1,this.spec.chunkToMultiscaleTransform,i+1,i+1);for(let l=0;l<i;++l)for(let c=0;c<i+1;++c)o[(i+1)*c+l]/=a[l]}disposed(){this.parent.spatiallyIndexedSources.delete(this),super.disposed()}initializeCounterpart(e,t){t.parent=this.parent.rpcId,super.initializeCounterpart(e,t)}addChunk(e,t){super.addChunk(e,t)}getChunk(e){return new fb(this,e)}};ml=Pt([wn(MD)],ml);var Wh=class extends Hn{constructor(e,t,r){super(e,{});this.parent=t;this.relationshipIndex=r;this.immediateChunkUpdates=!0}addChunk(e,t){super.addChunk(e,t)}getChunk(e){return new s1(this,e)}};Wh=Pt([wn(RD)],Wh);var l1=class extends yr{constructor(e,t){super(e);this.annotation=iS(t.annotation)}},zh=class extends Hn{constructor(e,t){super(e);this.parent=t}getChunk(e){return new l1(this,e)}addChunk(e,t){super.addChunk(e,t);let{references:r}=this.parent,i=r.get(e);i!==void 0&&(i.value=t.annotation,i.changed.dispatch())}deleteChunk(e){let{references:t}=this.parent,r=t.get(e);r!==void 0&&(r.value=void 0,r.changed.dispatch())}};zh=Pt([wn(AD)],zh);function c1(n,e,t,r){let i=new Uint8Array(n.data.length+r);for(let a of Mi){if(a===t)continue;let o=n.typeToOffset[a],l=o;a>t&&(l+=r,n.typeToOffset[a]=l),i.set(n.data.subarray(o,o+n.typeToIds[a].length*e[a].serializedBytes),l)}return i}function hb(n,e,t,r,i,a,o,l){let c=n.typeToOffset[t],d=c,p=c,{propertyGroupBytes:h}=e[t],g=h.length,v=n.typeToIds[t].length;for(let b=0;b<g;++b){let x=h[b];r.set(n.data.subarray(d+i*x,d+a*x),p+o*x),d+=x*v,p+=x*l}}function Hh(n,e,t){let r=e.type,{rank:i}=t[r],{serializedAnnotations:a}=n,o=a.typeToIds[r],l=a.typeToIdMaps[r],c=Wn[r],d=t[r].serializedBytes,p=l.get(e.id);if(p===void 0){p=l.size,l.set(e.id,p);let x=c1(a,t,r,d);hb(a,t,r,x,0,p,0,p+1),o.push(e.id),a.data=x}let h=a.typeToOffset[r],g=new DataView(a.data.buffer,a.data.byteOffset,a.data.byteLength),v=Pi===nn.LITTLE,b=t[r];c.serialize(g,h+b.propertyGroupBytes[0]*p,v,i,e),b.serialize(g,h,p,o.length,v,e.properties),n.bufferValid=!1}function $h(n,e,t,r){let{serializedAnnotations:i}=n,a=i.typeToIdMaps[e],o=a.get(t);if(o===void 0)return!1;let l=i.typeToIds[e],c=r[e].serializedBytes,d=c1(i,r,e,-c);hb(i,r,e,d,0,o,0,l.length-1),hb(i,r,e,d,o+1,l.length,o,l.length-1),l.splice(o,1),a.delete(t);for(let p=o,h=l.length;p<h;++p)a.set(l[p],p);return i.data=d,n.bufferValid=!1,!0}function Hz(){let n=[],e=[],t=[];for(let r of Mi)n[r]=[],e[r]=0,t[r]=new Map;return new fb(void 0,{data:new Uint8Array(0),numPickIds:0,typeToOffset:e,typeToIds:n,typeToIdMaps:t})}var Wi=class extends Cn{constructor(e,t){super();this.chunkManager=e;this.metadataChunkSource=this.registerDisposer(new zh(this.chunkManager,this));this.spatiallyIndexedSources=new Set;this.temporary=Hz();this.references=new Map;this.localUpdates=new Map;this.numCommitsInProgress=0;this.changed=new ne;this.readonly=!1;this.rank=t.rank,this.properties=t.properties,this.annotationPropertySerializers=uh(this.rank,this.properties);let r=this.segmentFilteredSources=[],{relationships:i}=t;this.relationships=i;for(let a=0,o=i.length;a<o;++a)r.push(this.registerDisposer(new Wh(e,this,a)))}hasNonSerializedProperties(){return this.relationships.length>0}getSources(e){throw new Error("not implemented")}initializeCounterpart(e,t){this.metadataChunkSource.initializeCounterpart(e,{});for(let r of this.segmentFilteredSources)r.initializeCounterpart(e,{});t.segmentFilteredSource=this.segmentFilteredSources.map(r=>r.addCounterpartRef()),t.metadataChunkSource=this.metadataChunkSource.addCounterpartRef(),t.chunkManager=this.chunkManager.rpcId,super.initializeCounterpart(e,t)}add(e,t=!0){e.id=fh();let r=new Td(e.id);return r.value=e,this.references.set(r.id,r),r.registerDisposer(()=>{this.references.delete(r.id)}),this.applyLocalUpdate(r,!1,t,e),r}applyLocalUpdate(e,t,r,i){let{localUpdates:a}=this,{id:o}=e,l=this.localUpdates.get(o),c=e.value;if(c==null)throw new Error("Cannot create local update from null annotation");if(l===void 0?(l={type:c.type,reference:e.addRef(),existingAnnotation:t?c:void 0,pendingCommit:void 0,commitInProgress:void 0},a.set(o,l),this.forEachPossibleChunk(c,d=>{let{data:p}=d;if(p===void 0)return;let h=c.type;$h(p,h,o,this.annotationPropertySerializers)}),i!==null&&Hh(this.temporary.data,i,this.annotationPropertySerializers)):(i===null?$h(this.temporary.data,c.type,c.id,this.annotationPropertySerializers):Hh(this.temporary.data,i,this.annotationPropertySerializers),e.value=i),r)if(l.commitInProgress!==void 0)l.pendingCommit=i;else{if(i===null&&l.existingAnnotation===void 0){a.delete(o),l.reference.dispose();return}this.sendCommitRequest(l,i)}this.notifyChanged(e.id,i||void 0)}sendCommitRequest(e,t){this.updateCommitsInProgress(1),e.commitInProgress=t,this.rpc.invoke(OD,{id:this.rpcId,annotationId:e.existingAnnotation&&e.reference.id,newAnnotation:t})}delete(e){this.applyLocalUpdate(e,!0,!0,null)}update(e,t){this.applyLocalUpdate(e,!0,!1,t)}notifyChanged(e,t){let r=this.references.get(e),i=this.metadataChunkSource.chunks.get(e);i!==void 0&&(i.annotation=t||null),r!==void 0&&(r.value=t||null,r.changed.dispatch()),this.chunkManager.chunkQueueManager.visibleChunksChanged.dispatch()}commit(e){this.applyLocalUpdate(e,!0,!0,e.value)}getReference(e){let t=this.references.get(e);if(t!==void 0)return t.addRef();t=new Td(e),this.references.set(e,t),this.rpc.invoke(_D,{id:this.rpcId,annotation:e}),t.registerDisposer(()=>{this.references.delete(e),this.rpc.invoke(VD,{id:this.rpcId,annotation:e})});let r=this.metadataChunkSource.chunks.get(e);return r!==void 0&&(t.value=r.annotation),t}forEachPossibleChunk(e,t){let{relatedSegments:r}=e;if(r!==void 0){let c=r.length,{segmentFilteredSources:d}=this;for(let p=0;p<c;++p){let h=r[p];if(h===void 0)return;let g=d[p];for(let v of h){let b=g.chunks.get(Rr(v));b!==void 0&&t(b)}}}let{rank:i}=this,a=new Float32Array(i),o=new Float32Array(i),l=new Float32Array(i);for(let c of this.spatiallyIndexedSources){switch(e.type){case Be.POINT:Kr(a,c.multiscaleToChunkTransform,i+1,e.point,i),o.set(a);break;case Be.LINE:case Be.AXIS_ALIGNED_BOUNDING_BOX:Kr(a,c.multiscaleToChunkTransform,i+1,e.pointA,i),Kr(o,c.multiscaleToChunkTransform,i+1,e.pointB,i);break;case Be.ELLIPSOID:Kr(a,c.multiscaleToChunkTransform,i+1,e.center,i),xh(o,c.multiscaleToChunkTransform,i+1,e.radii,i);for(let h=0;h<i;++h){let g=a[h],v=o[h];a[h]=g-v,o[h]=g+v}break}let d=1;for(let h=0;h<i;++h){let g=a[h],v=o[h],b=Math.min(g,v),x=Math.max(g,v);a[h]=Math.ceil(b-1),o[h]=Math.floor(x+1),d*=o[h]-a[h]}let{chunks:p}=c;for(let h=0;h<d;++h){let g=h;for(let b=0;b<i;++b){let x=a[b],T=o[b]-x,P=l[b]=g%T;g=(g-P)/T}let v=p.get(l.join());v!==void 0&&t(v)}}}static encodeOptions(e){return{}}handleSuccessfulUpdate(e,t){let r=this.localUpdates.get(e);if(r===void 0||r.commitInProgress===void 0)throw new Error("Received invalid successful update notification");if(this.updateCommitsInProgress(-1),t!==null&&r.reference.id!==t.id){if(r.commitInProgress===null)throw new Error("Received invalid successful update notification");r.reference.id=t.id,this.references.delete(e),this.references.set(t.id,r.reference),this.localUpdates.delete(e),this.localUpdates.set(t.id,r),r.reference.value!==null&&(r.reference.value.id=t.id,$h(this.temporary.data,r.type,e,this.annotationPropertySerializers),Hh(this.temporary.data,r.reference.value,this.annotationPropertySerializers)),r.reference.changed.dispatch()}r.existingAnnotation=t||void 0,r.commitInProgress=void 0;let{pendingCommit:i}=r;r.pendingCommit=void 0,t===null&&(i=void 0),i!==void 0?(i!==null&&(i.id=t.id),this.sendCommitRequest(r,i)):this.revertLocalUpdate(r)}disposed(){let{commitStatus:e}=this;e!==void 0&&e.dispose()}updateCommitsInProgress(e){this.numCommitsInProgress+=e,this.numCommitsInProgress===0?this.commitStatus!==void 0&&(this.commitStatus.dispose(),this.commitStatus=void 0):this.commitStatus===void 0&&(this.commitStatus=new Ee(!0)).setText("Commiting annotations")}handleFailedUpdate(e,t){let r=this.localUpdates.get(e);if(r===void 0||r.commitInProgress===void 0)throw new Error("Received invalid update notification");new Ee().setErrorMessage(`Error commiting annotation update: ${t}`),this.revertLocalUpdate(r),this.updateCommitsInProgress(-1)}revertLocalUpdate(e){$h(this.temporary.data,e.type,e.reference.id,this.annotationPropertySerializers);let{existingAnnotation:t}=e;t!==void 0&&this.forEachPossibleChunk(t,a=>{let{data:o}=a;o!==void 0&&Hh(o,t,this.annotationPropertySerializers)});let{reference:r}=e,{id:i}=r;r.value=t||null,r.changed.dispatch(),r.dispose(),this.localUpdates.delete(i)}*[Symbol.iterator](){}};Lt(ND,function(n){let e=this.get(n.id),t=n.annotationId,r=n.error;if(r!==void 0)e.handleFailedUpdate(t,r);else{let i=iS(n.newAnnotation);e.handleSuccessfulUpdate(t,i)}});var u1="CredentialsProvider",d1="CredentialsProvider.get";var Yd=class extends Cn{constructor(e,t){super();this.provider=e;this.registerDisposer(e),this.initializeCounterpart(t)}get(e,t){return this.provider.get(e,t)}};Yd=Pt([wn(u1)],Yd);Rh(d1,function(n,e){return this.get(n.providerId).get(n.invalidCredentials,e).then(r=>({value:r}))});function Kd(n,e){if(e===void 0)return;let t=n.memoize.get({type:"getSharedCredentialsProvider",credentialsProvider:lt(e)},()=>new Yd(e.addRef(),n.rpc)),r=t.addCounterpartRef();return t.dispose(),r}function ut(){return function(n){class e extends n{constructor(...r){super(...r);var a;let i=r[1];this.credentialsProvider=(a=i.credentialsProvider)==null?void 0:a.addRef()}initializeCounterpart(r,i){let{credentialsProvider:a}=this;i.credentialsProvider=Kd(this.chunkManager,a),super.initializeCounterpart(r,i)}static encodeOptions(r){let i=super.encodeOptions(r),{credentialsProvider:a}=r;return i.credentialsProvider=a===void 0?void 0:lt(a),i}}return e}}function lo(n,e){return n<e?-1:n>e?1:0}var p1={offset:0,completions:[]};function _r(n,e){return e.offset+=n,e}function jh(n,e){let t=[];for(let r of e)r.startsWith(n)&&t.push({value:r});return t.sort((r,i)=>lo(r.value,i.value)),t}function cn(n,e,t,r){let i=[];for(let a of e){let o=t(a);o.startsWith(n)&&i.push({value:o,description:r(a)})}return i.sort((a,o)=>lo(a.value,o.value)),i}async function $z(n,e,t){if(n.startsWith("{"))return p1;let i=n.match(/^(?:(.*)[&;])?([^&;]*)$/)[2],a=n.length-i.length,o=i.indexOf("=");if(o===-1){let l=await e(i);return{offset:l.offset+a,completions:l.completions.map(c=>({...c,value:`${c.value}=`}))}}return _r(a+o+1,await t(i.substring(0,o),i.substring(o+1)))}async function Jh(n,e){return $z(n,async t=>{let r=[];for(let i of e){let a=i.key;a.value.startsWith(t)&&r.push(a)}return{offset:0,completions:r}},async(t,r)=>{for(let i of e)if(i.key.value===t)return{offset:0,completions:i.values.filter(a=>a.value.startsWith(r))};return p1})}var zc=class extends Error{constructor(e){super(`Redirected to: ${e}`);this.redirectTarget=e}};function f1(n,e){e===void 0&&(n.indexOf("/")===-1?e=":":e="/");let t=n.lastIndexOf(e);return t===-1?0:t+1}function jz(n,e){let t=f1(n,e);return n.substring(t)}var pi;(function(t){t[t.annotations=0]="annotations",t[t.equivalences=1]="equivalences"})(pi||(pi={}));function qh(){return{url:"",transform:void 0,enableDefaultSubsources:!0,subsources:new Map}}var Rt=class extends H{normalizeUrl(e){return e.url}convertLegacyUrl(e){return e.url}async completeUrl(e){throw null}},mb="local://annotations",Yh="local://equivalences",h1=class extends Rt{get description(){return"Local in-memory"}async get(e){switch(e.url){case mb:{let{transform:t}=e,r;if(t===void 0){let i=e.globalCoordinateSpace.value,{rank:a,names:o,scales:l,units:c}=i,d=Oe({rank:a,scales:l,units:c,names:o.map((h,g)=>`${g}`)}),p=Oe({rank:a,scales:l,units:c,names:o});r={rank:a,sourceRank:a,inputSpace:d,outputSpace:p,transform:Yt(Float64Array,a+1)}}else r=vt(_i);return{modelTransform:r,canChangeModelSpaceRank:!0,subsources:[{id:"default",default:!0,subsource:{local:0}}]}}case Yh:return{modelTransform:vt(_i),canChangeModelSpaceRank:!1,subsources:[{id:"default",default:!0,subsource:{local:1}}]}}throw new Error("Invalid local data source URL")}async completeUrl(e){return{offset:0,completions:cn(e.providerUrl,[{value:"annotations",description:"Annotations stored in the JSON state"},{value:"equivalences",description:"Segmentation equivalence graph stored in the JSON state"}],t=>t.value,t=>t.description)}}},m1=/^(?:([a-zA-Z][a-zA-Z0-9-+_]*):\/\/)?(.*)$/,gb=class extends H{constructor(e){super();this.credentialsManager=e;this.dataSources=new Map([["local",new h1]])}register(e,t){this.dataSources.set(e,this.registerDisposer(t))}getProvider(e){let t=e.match(m1);if(t===null||t[1]===void 0)throw new Error('Data source URL must have the form "<protocol>://<path>".');let[,r,i]=t,a=this.dataSources.get(r);if(a===void 0)throw new Error(`Unsupported data source: ${JSON.stringify(r)}.`);return[a,i,r]}async get(e){let t=new Set,{cancellationToken:r=St}=e,i=e.url;for(;;){let[a,o,l]=this.getProvider(e.url);t.add(e.url);try{return a.get({...e,url:i,providerProtocol:l,providerUrl:o,registry:this,cancellationToken:r,credentialsManager:this.credentialsManager})}catch(c){if(c instanceof zc){let d=c.redirectTarget;if(t.has(d))throw Error(`Layer source redirection contains loop: ${JSON.stringify(Array.from(t))}`);if(t.size>=10)throw Error(`Too many layer source redirections: ${JSON.stringify(Array.from(t))}`);i=d;continue}throw c}}}convertLegacyUrl(e){try{let[t,r,i]=this.getProvider(e.url);return t.convertLegacyUrl({...e,providerUrl:r,providerProtocol:i,registry:this})}catch{return e.url}}normalizeUrl(e){try{let[t,r,i]=this.getProvider(e.url);return t.normalizeUrl({...e,providerUrl:r,providerProtocol:i,registry:this})}catch{return e.url}}async completeUrl(e){let{url:t,cancellationToken:r=St}=e,i=t.match(m1),a=i[1];if(a===void 0)return Promise.resolve({offset:0,completions:cn(t,this.dataSources,([o])=>`${o}://`,([,o])=>o.description)});{let o=this.dataSources.get(a);if(o!==void 0){let l=await o.completeUrl({registry:this,url:t,providerUrl:i[2],chunkManager:e.chunkManager,cancellationToken:r,credentialsManager:this.credentialsManager});return _r(a.length+3,l)}throw null}}suggestLayerName(e){let[t,r]=this.getProvider(e);r.endsWith("/")&&(r=r.substring(0,r.length-1));let i=t.suggestLayerName;return i!==void 0?i(r):jz(r)}findSourceGroup(e){let[t,r,i]=this.getProvider(e);return(t.findSourceGroup||f1)(r)+i.length+3}};var Sr=class extends Error{constructor(e,t,r,i){let a=`Fetching ${JSON.stringify(e)} resulted in HTTP error ${t}`;r&&(a+=`: ${r}`),a+=".",super(a),this.name="HttpError",this.message=a,this.url=e,this.status=t,this.statusText=r,i&&(this.response=i)}static fromResponse(e){return new Sr(e.url,e.status,e.statusText,e)}static fromRequestError(e,t){if(t instanceof TypeError){let r;return typeof e=="string"?r=e:r=e.url,new Sr(r,0,"Network or CORS error")}return t}},Jz=32,qz=500,Yz=1e4;function yb(n){return Math.min(2**n*qz,Yz/2)*(1+Math.random())}async function co(n,e){var t;for(let r=0;;){if((t=e==null?void 0:e.signal)==null?void 0:t.aborted)throw zo;let i;try{i=await fetch(n,e)}catch(a){throw Sr.fromRequestError(n,a)}if(!i.ok){let{status:a}=i;if((a===429||a===503||a===504)&&++r!==Jz){await new Promise(o=>setTimeout(o,yb(r-1)));continue}throw Sr.fromResponse(i)}return i}}function Kh(n){return n.arrayBuffer()}function kt(n){return n.json()}async function uo(n,e,t,r=St){if(r===St){let o=await co(n,e);return await t(o)}let i=new AbortController,a=r.add(()=>i.abort());try{let o=await co(n,{...e,signal:i.signal});return await t(o)}finally{a()}}var _Z=new X;function gl(n){let e=/^([^:\/]+):\/\/([^\/]+)((?:\/.*)?)$/,t=n.match(e);if(t===null)throw new Error(`Invalid URL: ${JSON.stringify(n)}`);return{protocol:t[1],host:t[2],path:t[3]}}function zi(n){return n instanceof Sr?n.status===0||n.status===403||n.status===404:!1}var Kz=3;async function ts(n,e,t,r,i,a,o=St){let l;e:for(let c=0;;){pD(o),c>1&&await new Promise(d=>setTimeout(d,yb(c-2))),l=await n.get(l,o);try{return await uo(typeof e=="function"?e(l.credentials):e,i(l.credentials,t),r,o)}catch(d){if(d instanceof Sr&&a(d,l.credentials)==="refresh"){if(++c===Kz)throw d;continue e}throw d}}}function ka(n,e,t,r,i=St){return n===void 0?uo(e,t,r,i):ts(n,e,t,r,(a,o)=>{if(!a.accessToken)return o;let l=new Headers(o.headers);return l.set("Authorization",`${a.tokenType} ${a.accessToken}`),{...o,headers:l}},(a,o)=>{let{status:l}=a;if(l===401)return"refresh";if(l===403&&!o.accessToken)return"refresh";throw a instanceof Error&&o.email!==void 0&&(a.message+=`  (Using credentials for ${JSON.stringify(o.email)})`),a},i)}var vb="google-brainmaps";function yl(n,e,t,r=St){return ka(e,`${n.serverUrl}${t.path}`,{method:t.method,body:t.payload},t.responseType==="json"?kt:Kh,r)}var Ea;(function(r){r[r.RAW=0]="RAW",r[r.JPEG=1]="JPEG",r[r.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION"})(Ea||(Ea={}));var Xh=class{};Xh.RPC_ID="brainmaps/VolumeChunkSource";var Qh=class{};Qh.RPC_ID="brainmaps/MultiscaleMeshSource";var Zh=class{};Zh.RPC_ID="brainmaps/MeshSource";var em=class{};em.RPC_ID="brainmaps/SkeletonSource";var tm=class{};tm.RPC_ID="brainmaps/Annotation";var nm=class{};nm.RPC_ID="brainmaps/AnnotationSpatialIndex";var g1="mesh/MeshLayer",y1="mesh/MultiscaleMeshLayer",v1="mesh/FragmentSource",S1="mesh/MultiscaleFragmentSource",fi;(function(r){r[r.float32=0]="float32",r[r.uint10=1]="uint10",r[r.uint16=2]="uint16"})(fi||(fi={}));function b1(n,e,t){return n&1|e<<1&2|t<<2&4}var rm=!1;function Xz(n,e,t,r,i,a,o){let{octree:l,lodScales:c,chunkGridSpatialOrigin:d,chunkShape:p}=n,h=c.length-1,g=e[0],v=e[4],b=e[8],x=e[1],C=e[5],T=e[9],P=e[3],I=e[7],M=e[11],D=e[15],E=P>0?0:1,V=I>0?0:1,O=M>0?0:1,B=t[4*4],z=t[4*4+1],_=t[4*4+2],F=t[4*4+3];function N(qe,it,Ve){return P*qe+I*it+M*Ve+D}function J(qe,it,Ve,ft,Yn,Zi){return N(qe+E*(ft-qe),it+V*(Yn-it),Ve+O*(Zi-Ve))}let ae=N(-F*B,-F*z,-F*_),pe=n.clipLowerBound[0],me=n.clipLowerBound[1],Ae=n.clipLowerBound[2],le=n.clipUpperBound[0],we=n.clipUpperBound[1],_e=n.clipUpperBound[2],Fe=Math.sqrt((g*i)**2+(x*a)**2),rt=Math.sqrt((v*i)**2+(C*a)**2),ye=Math.sqrt((b*i)**2+(T*a)**2),Le=Math.max(Fe,rt,ye);function je(qe,it,Ve){let ft=1<<qe,Yn=it*5,Zi=l[Yn],at=l[Yn+1],Tr=l[Yn+2],ea=l[Yn+3],ta=l[Yn+4],na=Zi*ft*p[0]+d[0],ra=at*ft*p[1]+d[1],ii=Tr*ft*p[2]+d[2],wi=na+ft*p[0],Na=ra+ft*p[1],wo=ii+ft*p[2];if(na=Math.max(na,pe),ra=Math.max(ra,me),ii=Math.max(ii,Ae),wi=Math.min(wi,le),Na=Math.min(Na,we),wo=Math.min(wo,_e),Qf(na,ra,ii,wi,Na,wo,t)){let To=Math.max(ae,J(na,ra,ii,wi,Na,wo))/Le;if(Ve===0||To*r<Ve){let Nn=c[qe];if(Nn!==0&&o(qe,it,Nn/To,ta>>>31),qe>0&&(Nn===0||To*r<Nn)){let ku=Nn===0?Ve:Nn,or=(ta&2147483647)>>>0;for(let Dt=ea;Dt<or;++Dt)je(qe-1,Dt,ku)}}}}je(h,l.length/5-1,0)}function Sb(n,e,t,r,i,a,o,l){let{lodScales:c}=n,d=0;for(;d+1<c.length&&c[d+1]!==0;)++d;let p=3,h=[],g=0,v=0;function b(T,P){for(rm&&console.log(`emitChunksUpTo: stackDepth=${g}, targetStackIndex=${T}, subChunkIndex=${P}, priorSubChunkIndex=${v}`);;){if(g===0)return;let I=g-1,M=d-I,D=h[I*p],E=M===0?1:8,V=h[I*p+1],O=h[I*p+2];if(T===g){let B=P&E-1;v!==B&&D!==-1&&(rm&&console.log(`  drawing chunk because priorSubChunkIndex (${v}) != endSubChunk (${B})`),l(M,D,v,B,O)),v=B+1;return}v!==E&&D!==-1&&l(M,D,v,E,O),v=V+1,--g}}let x=0;rm&&(console.log(""),console.log("Starting to draw"));let{octree:C}=n;Xz(n,e,t,r,i,a,(T,P,I,M)=>{if(!M&&!o(T,P,I)){x=Math.max(T,x);return}if(T<x)return;x=0;let D=P*5,E=C[D],V=C[D+1],O=C[D+2],B=b1(E,V,O),z=d-T;b(z,B);let _=z*p;h[_]=M?-1:P,h[_+1]=B,h[_+2]=I,rm&&console.log(`Adding to stack: lod=${T}, row=${h[_]}, subChunkIndex=${B}`),v=0,g=z+1}),b(0,0)}function x1(n){if(n.length%5!=0)throw new Error("Invalid length");let e=n.length/5,t=new Set;function r(i){if(t.has(i))throw new Error("Previously seen node");if(t.add(i),i<0||i>=e)throw new Error("Invalid node reference");let a=n[i*5],o=n[i*5+1],l=n[i*5+2],c=n[i*5+3],d=n[i*5+4];if(c<0||d<0||d<c||d>e||c+8<d)throw new Error("Invalid child references");for(let p=c;p<d;++p){let h=n[p*5],g=n[p*5+1],v=n[p*5+2];if(h>>>1!==a||g>>>1!==o||v>>>1!=l)throw new Error("invalid child");r(p)}}if(e!==0&&(r(e-1),t.size!==e))throw new Error("Orphan nodes in octree")}function bb(n,e,t){return`${n}/${e}:${t}`}var Vr=class extends $d{draw(e,t){}isReady(e,t){return!0}get transparentPickEnabled(){return!0}};var Qz=3432918353,Zz=461845907;function Hc(n,e){return e>>>=0,n>>>=0,e=Math.imul(e,Qz)>>>0,e=(e<<15|e>>>17)>>>0,e=Math.imul(e,Zz)>>>0,n=(n^e)>>>0,n=(n<<13|n>>>19)>>>0,n=n*5+3864292196>>>0,n}var im=3,e6=.8,ns=!1,Da=0,Pa=0,C1=0,w1=0,$c=class{constructor(e=$c.generateHashSeeds(im)){this.hashSeeds=e;this.loadFactor=e6;this.size=0;this.emptyLow=4294967295;this.emptyHigh=4294967295;this.maxRehashAttempts=5;this.maxAttempts=5;this.generation=0;this.mungedEmptyKey=-1;let t=8;for(;t<2*e.length;)t*=2;this.allocate(t)}updateHashFunctions(e){this.hashSeeds=$c.generateHashSeeds(e),this.mungedEmptyKey=-1}tableWithMungedEmptyKey(e){let t=this.hashSeeds.length,r=new Array(t);for(let c=0;c<t;++c)r[c]=this.getHash(c,this.emptyLow,this.emptyHigh);let{mungedEmptyKey:i}=this;if(i===-1){e:for(;;){i=Math.random()*16777216>>>0;for(let c=0;c<t;++c){let d=this.getHash(c,i,i);for(let p=0;p<t;++p)if(r[p]===d)continue e}this.mungedEmptyKey=i;break}}let{table:a,emptyLow:o,emptyHigh:l}=this;for(let c=0;c<t;++c){let d=r[c];a[d]===o&&a[d+1]===l&&(a[d]=i,a[d+1]=i)}try{e(a)}finally{for(let c=0;c<t;++c){let d=r[c];a[d]===i&&a[d+1]===i&&(a[d]=o,a[d+1]=l)}}}static generateHashSeeds(e=im){return FE(new Uint32Array(e))}getHash(e,t,r){let i=this.hashSeeds[e];return i=Hc(i,t),i=Hc(i,r),this.entryStride*(i&this.tableSize-1)}*keys(){let{emptyLow:e,emptyHigh:t,entryStride:r}=this,{table:i}=this;for(let a=0,o=i.length;a<o;a+=r){let l=i[a],c=i[a+1];(l!==e||c!==t)&&(yield new X(l,c))}}*unsafeKeys(e=new X){let{emptyLow:t,emptyHigh:r,entryStride:i}=this,{table:a}=this;for(let o=0,l=a.length;o<l;o+=i){let c=a[o],d=a[o+1];(c!==t||d!==r)&&(e.low=c,e.high=d,yield e)}}indexOfPair(e,t){let{table:r,emptyLow:i,emptyHigh:a}=this;if(e===i&&t===a)return-1;for(let o=0,l=this.hashSeeds.length;o<l;++o){let c=this.getHash(o,e,t);if(r[c]===e&&r[c+1]===t)return c}return-1}indexOf(e){return this.indexOfPair(e.low,e.high)}chooseAnotherEmptyKey(){let{emptyLow:e,emptyHigh:t,table:r,entryStride:i}=this,a,o;for(;a=Math.random()*4294967296>>>0,o=Math.random()*4294967296>>>0,!(!(a===e&&o===t)&&!this.hasPair(a,o)););this.emptyLow=a,this.emptyHigh=o;for(let l=0,c=r.length;l<c;l+=i)r[l]===e&&r[l+1]===t&&(r[l]=a,r[l+1]=o)}has(e){return this.indexOf(e)!==-1}hasPair(e,t){return this.indexOfPair(e,t)!==-1}delete(e){let t=this.indexOf(e);if(t!==-1){let{table:r}=this;return r[t]=this.emptyLow,r[t+1]=this.emptyHigh,++this.generation,this.size--,!0}return!1}clearTable(){let{table:e,entryStride:t,emptyLow:r,emptyHigh:i}=this,a=e.length;for(let o=0;o<a;o+=t)e[o]=r,e[o+1]=i}clear(){return this.size===0?!1:(this.size=0,++this.generation,this.clearTable(),!0)}reserve(e){return e>this.capacity?(this.backupPending(),this.grow(e),this.restorePending(),!0):!1}swapPending(e,t){let r=Da,i=Pa;this.storePending(e,t),e[t]=r,e[t+1]=i}storePending(e,t){Da=e[t],Pa=e[t+1]}backupPending(){C1=Da,w1=Pa}restorePending(){Da=C1,Pa=w1}tryToInsert(){ns&&console.log(`tryToInsert: ${Da}, ${Pa}`);let e=0,{emptyLow:t,emptyHigh:r,maxAttempts:i,table:a}=this,o=this.hashSeeds.length,l=Math.floor(Math.random()*o);for(;;){let c=this.getHash(l,Da,Pa);if(this.swapPending(a,c),Da===t&&Pa===r)return!0;if(++e===i)break;l=(l+Math.floor(Math.random()*(o-1))+1)%o}return!1}allocate(e){this.tableSize=e;let{entryStride:t}=this;this.table=new Uint32Array(e*t),this.maxAttempts=e,this.clearTable(),this.capacity=e*this.loadFactor,this.mungedEmptyKey=-1}rehash(e,t){ns&&console.log("rehash begin"),this.allocate(t),this.updateHashFunctions(this.hashSeeds.length);let{emptyLow:r,emptyHigh:i,entryStride:a}=this;for(let o=0,l=e.length;o<l;o+=a){let c=e[o],d=e[o+1];if((c!==r||d!==i)&&(this.storePending(e,o),!this.tryToInsert()))return ns&&console.log("rehash failed"),!1}return ns&&console.log("rehash end"),!0}grow(e){ns&&console.log(`grow: ${e}`);let t=this.table,{tableSize:r}=this;for(;r<e;)r*=2;for(;;){for(let i=0;i<this.maxRehashAttempts;++i)if(this.rehash(t,r)){ns&&console.log("grow end");return}r*=2}}insertInternal(){for(++this.generation,Da===this.emptyLow&&Pa===this.emptyHigh&&this.chooseAnotherEmptyKey(),++this.size>this.capacity&&(this.backupPending(),this.grow(this.tableSize*2),this.restorePending());!this.tryToInsert();)this.backupPending(),this.grow(this.tableSize),this.restorePending()}},am=class extends $c{add(e){let{low:t,high:r}=e;return this.hasPair(t,r)?!1:(ns&&console.log(`add: ${t},${r}`),Da=t,Pa=r,this.insertInternal(),!0)}[Symbol.iterator](){return this.unsafeKeys()}};am.prototype.entryStride=2;var Xd=0,Qd=0,T1=0,L1=0,jc=class extends $c{set(e,t){let{low:r,high:i}=e;return this.hasPair(r,i)?!1:(ns&&console.log(`add: ${r},${i} -> ${t.low},${t.high}`),Da=r,Pa=i,Xd=t.low,Qd=t.high,this.insertInternal(),!0)}get(e,t){let r=this.indexOf(e);if(r===-1)return!1;let{table:i}=this;return t.low=i[r+2],t.high=i[r+3],!0}swapPending(e,t){let r=Xd,i=Qd;super.swapPending(e,t),e[t+2]=r,e[t+3]=i}storePending(e,t){super.storePending(e,t),Xd=e[t+2],Qd=e[t+3]}backupPending(){super.backupPending(),T1=Xd,L1=Qd}restorePending(){super.restorePending(),Xd=T1,Qd=L1}[Symbol.iterator](){return this.unsafeEntries()}*entries(){let{emptyLow:e,emptyHigh:t,entryStride:r}=this,{table:i}=this;for(let a=0,o=i.length;a<o;a+=r){let l=i[a],c=i[a+1];if(l!==e||c!==t){let d=new X(l,c),p=new X(i[a+2],i[a+3]);yield[d,p]}}}*unsafeEntries(e=[new X,new X]){let{emptyLow:t,emptyHigh:r,entryStride:i}=this,{table:a}=this,[o,l]=e;for(let c=0,d=a.length;c<d;c+=i){let p=a[c],h=a[c+1];(p!==t||h!==r)&&(o.low=p,o.high=h,l.low=a[c+2],l.high=a[c+3],yield e)}}};jc.prototype.entryStride=4;var Hi=class{},vl=[-1,WebGL2RenderingContext.RED_INTEGER,WebGL2RenderingContext.RG_INTEGER,WebGL2RenderingContext.RGB_INTEGER,WebGL2RenderingContext.RGBA_INTEGER],t6=[-1,WebGL2RenderingContext.RED,WebGL2RenderingContext.RG,WebGL2RenderingContext.RGB,WebGL2RenderingContext.RGBA],om=["","r","rg","rgb","rgba"],n6=[-1,WebGL2RenderingContext.R8UI,WebGL2RenderingContext.RG8UI,WebGL2RenderingContext.RGB8UI,WebGL2RenderingContext.RGBA8UI],r6=[-1,WebGL2RenderingContext.R8I,WebGL2RenderingContext.RG8I,WebGL2RenderingContext.RGB8I,WebGL2RenderingContext.RGBA8I],i6=[-1,WebGL2RenderingContext.R16UI,WebGL2RenderingContext.RG16UI,WebGL2RenderingContext.RGB16UI,WebGL2RenderingContext.RGBA16UI],a6=[-1,WebGL2RenderingContext.R16I,WebGL2RenderingContext.RG16I,WebGL2RenderingContext.RGB16I,WebGL2RenderingContext.RGBA16I],k1=[-1,WebGL2RenderingContext.R32UI,WebGL2RenderingContext.RG32UI,WebGL2RenderingContext.RGB32UI,WebGL2RenderingContext.RGBA32UI],o6=[-1,WebGL2RenderingContext.R32I,WebGL2RenderingContext.RG32I,WebGL2RenderingContext.RGB32I,WebGL2RenderingContext.RGBA32I],s6=[-1,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RG32F,WebGL2RenderingContext.RGB32F,WebGL2RenderingContext.RGBA32F];function Jc(n){return n===W.FLOAT32?"":wc[n]?"i":"u"}function hi(n,e,t=1){switch(e){case W.UINT8:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=n6[t],n.textureFormat=vl[t],n.texelType=WebGL2RenderingContext.UNSIGNED_BYTE,n.arrayElementsPerTexel=t,n.arrayConstructor=Uint8Array,n.samplerPrefix="u",n;case W.INT8:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=r6[t],n.textureFormat=vl[t],n.texelType=WebGL2RenderingContext.BYTE,n.arrayElementsPerTexel=t,n.arrayConstructor=Int8Array,n.samplerPrefix="i",n;case W.UINT16:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=i6[t],n.textureFormat=vl[t],n.texelType=WebGL2RenderingContext.UNSIGNED_SHORT,n.arrayElementsPerTexel=t,n.arrayConstructor=Uint16Array,n.samplerPrefix="u",n;case W.INT16:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=a6[t],n.textureFormat=vl[t],n.texelType=WebGL2RenderingContext.SHORT,n.arrayElementsPerTexel=t,n.arrayConstructor=Int16Array,n.samplerPrefix="i",n;case W.UINT32:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=k1[t],n.textureFormat=vl[t],n.texelType=WebGL2RenderingContext.UNSIGNED_INT,n.arrayElementsPerTexel=1,n.arrayConstructor=Uint32Array,n.samplerPrefix="u",n;case W.INT32:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=o6[t],n.textureFormat=vl[t],n.texelType=WebGL2RenderingContext.INT,n.arrayElementsPerTexel=1,n.arrayConstructor=Int32Array,n.samplerPrefix="i",n;case W.UINT64:if(t<1||t>2)break;return n.texelsPerElement=1,n.textureInternalFormat=k1[t*2],n.textureFormat=vl[t*2],n.texelType=WebGL2RenderingContext.UNSIGNED_INT,n.arrayElementsPerTexel=2*t,n.arrayConstructor=Uint32Array,n.samplerPrefix="u",n;case W.FLOAT32:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=s6[t],n.textureFormat=t6[t],n.texelType=WebGL2RenderingContext.FLOAT,n.arrayElementsPerTexel=t,n.arrayConstructor=Float32Array,n.samplerPrefix="",n}throw new Error(`No supported texture format for ${W[e]}[${t}].`)}function rs(n,e,t){let{arrayConstructor:r,arrayElementsPerTexel:i,textureInternalFormat:a,textureFormat:o,texelsPerElement:l}=e,{maxTextureSize:c}=n,d=t.length/i;if(d*l>c*c)throw new Error("Number of elements exceeds maximum texture size: "+l+" * "+d);let p=Math.ceil(d/c),h=Math.ceil(Math.log2(p)),g=(1<<h)*l,v=Math.ceil(d/(1<<h)),b=g*v*i;t.constructor!==r&&(t=new r(t.buffer,t.byteOffset,t.byteLength/r.BYTES_PER_ELEMENT));let x=zL(t,b);n.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),ro(n),n.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,a,g,v,0,o,e.texelType,x)}function E1(n,e,t,r,i){let{arrayConstructor:a,textureInternalFormat:o,textureFormat:l,texelsPerElement:c}=e;t.constructor!==a&&(t=new a(t.buffer,t.byteOffset,t.byteLength/a.BYTES_PER_ELEMENT)),n.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),ro(n),n.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,o,r*c,i,0,l,e.texelType,t)}function D1(n,e,t,r,i,a){let{arrayConstructor:o,textureInternalFormat:l,textureFormat:c,texelsPerElement:d}=e;t.constructor!==o&&(t=new o(t.buffer,t.byteOffset,t.byteLength/o.BYTES_PER_ELEMENT)),n.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),mP(n),n.texImage3D(WebGL2RenderingContext.TEXTURE_3D,0,l,r*d,i,a,0,c,e.texelType,t)}function l6(n){switch(n){case W.UINT8:return US;case W.INT8:return GS;case W.UINT16:return WS;case W.INT16:return zS;case W.UINT32:return nl;case W.INT32:return HS;case W.UINT64:return At;case W.FLOAT32:return Nh}}function P1(n,e,t,r,i,a){let o=Ot(i,a),l=[l6(i)],c=`
${o} ${n}(${r} index) {
`;switch(i){case W.UINT8:case W.UINT16:case W.UINT32:c+=`
  ${o} result;
  highp uvec4 temp;
  ${e}(${t}, index, temp);
  result.value = temp.${om[a]};
  return result;
`;break;case W.INT8:case W.INT16:case W.INT32:c+=`
  ${o} result;
  highp ivec4 temp;
  ${e}(${t}, index, temp);
  result.value = temp.${om[a]};
  return result;
`;break;case W.UINT64:l.push(KD),c+=`
  highp uvec4 temp;
  ${e}(${t}, index, temp);
  return unpackUint64leFromUint32(temp.${om[a*2]});
`;break;case W.FLOAT32:l.push(Nh),c+=`
  highp vec4 temp;
  ${e}(${t}, index, temp);
  return temp.${om[a]};
`;break}return c+=`
}
`,l.push(c),l}var po=class{constructor(e){this.key=e;this.readTextureValue=`readTextureValue_${this.key}`}defineShader(e){}getReadTextureValueCode(e,t){let r=`
void ${this.readTextureValue}(highp ${t}sampler2D sampler, highp uint index`;for(let i=0;i<e;++i)r+=`, out ${t}vec4 output${i}`;r+=`) {
  highp int width = textureSize(sampler, 0).x / ${e};
  highp uint log2width = log2Exact(uint(width));
  highp int y = int(index >> log2width);
  highp int x = int((index - (uint(y) << log2width)) * ${e}u);
`;for(let i=0;i<e;++i)r+=`
  output${i} = texelFetch(sampler, ivec2(x + ${i}, y), 0);
`;return r+=`
}
`,[tP,r]}getAccessor(e,t,r,i=1){let a=Jc(r);return[this.getReadTextureValueCode(1,a),...P1(e,this.readTextureValue,t,"highp uint",r,i)]}},xb=class{constructor(e,t){this.key=e;this.textureDims=t;this.readTextureValue=`readTextureValue_${this.key}`}getReadTextureValueCode(e,t){let{textureDims:r}=this,i=`
void ${this.readTextureValue}(highp ${t}sampler${this.textureDims}D sampler, highp ivec${r} p`;for(let a=0;a<e;++a)i+=`, out ${t}vec4 output${a}`;i+=`) {
`;for(let a=0;a<e;++a)i+=`
  output${a} = texelFetch(sampler, ivec${r}(p.x * ${e} + ${a}, p.y
                                         ${r===3?", p.z":""}), 0);
`;return i+=`
}
`,i}getAccessor(e,t,r,i=1){let a=Jc(r);return[this.getReadTextureValueCode(1,a),...P1(e,this.readTextureValue,t,`highp ivec${this.textureDims}`,r,i)]}};var Cb=[At,`
highp uint hashCombine(highp uint state, highp uint value) {
  value *= 0xcc9e2d51u;
  value = (value << 15u) | (value >> 17u);
  value *= 0x1b873593u;
  state ^= value;
  state = (state << 13u) | (state >> 19u);
  state = (state * 5u) + 0xe6546b64u;
  return state;
}
highp uint hashCombine(highp uint state, uint64_t x) {
  state = hashCombine(state, x.value[0]);
  return hashCombine(state, x.value[1]);
}
`],c6=hi(new Hi,W.UINT64,1),Sl=class extends H{constructor(e,t){super();this.gl=e;this.hashTable=t;this.generation=-1;this.texture=null;this.texture=e.createTexture()}copyToGPU(){let{hashTable:e}=this,{generation:t}=e;if(this.generation===t)return;let{gl:r,texture:i}=this;this.generation=t,r.activeTexture(WebGL2RenderingContext.TEXTURE0+r.tempTextureUnit),r.bindTexture(WebGL2RenderingContext.TEXTURE_2D,i),e.tableWithMungedEmptyKey(a=>{rs(this.gl,c6,a)}),r.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}disposed(){let{gl:e}=this;e.deleteTexture(this.texture),this.texture=null,this.gl=void 0,this.hashTable=void 0,super.disposed()}static get(e,t){return e.memoize.get(t,()=>new this(e,t))}},sm=class{constructor(e,t=im){this.prefix=e;this.numAlternatives=t;this.textureUnitSymbol=Symbol.for(`gpuhashtable:${this.prefix}`);this.accessHelper=new po(`gpuhashtable_${this.prefix}`);this.samplerName=this.prefix+"_sampler";this.hashSeedsName=this.prefix+"_seeds";this.hashKeyMask=this.prefix+"_keyMask";this.readTable=this.prefix+"_readTable"}defineShader(e){let{hashSeedsName:t,samplerName:r,numAlternatives:i,hashKeyMask:a}=this;e.addUniform("highp uint",t,i),e.addUniform("highp uint",a),e.addTextureSampler("usampler2D",r,this.textureUnitSymbol),e.addFragmentCode(Cb),e.addFragmentCode(At),e.addFragmentCode(Oh),this.accessHelper.defineShader(e),e.addFragmentCode(this.accessHelper.getAccessor(this.readTable,this.samplerName,W.UINT64,1));let o="";o+=`
bool ${this.hasFunctionName}(uint64_t x) {
`;for(let l=0;l<i;++l)o+=`
  {
    uint h = hashCombine(${t}[${l}], x) & ${a};
    uint64_t key = ${this.readTable}(h);
    if (equals(key, x)) {
      return true;
    }
  }
`;o+=`
  return false;
}
`,e.addFragmentCode(o)}get hasFunctionName(){return`${this.prefix}_has`}enable(e,t,r){r.copyToGPU();let i=t.textureUnit(this.textureUnitSymbol);e.activeTexture(WebGL2RenderingContext.TEXTURE0+i),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,r.texture),e.uniform1ui(t.uniform(this.hashKeyMask),r.hashTable.tableSize-1),e.uniform1uiv(t.uniform(this.hashSeedsName),r.hashTable.hashSeeds)}disable(e,t){let r=t.textureUnit(this.textureUnitSymbol);e.activeTexture(WebGL2RenderingContext.TEXTURE0+r),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}},Zd=class extends sm{defineShader(e){super.defineShader(e);let{numAlternatives:t,hashSeedsName:r,hashKeyMask:i}=this,a=`
bool ${this.getFunctionName}(uint64_t x, out uint64_t value) {
`;for(let o=0;o<t;++o)a+=`
  {
    uint h = hashCombine(${r}[${o}], x) & ${i};
    uint64_t key = ${this.readTable}(h * 2u);
    if (equals(key, x)) {
      value = ${this.readTable}(h * 2u + 1u);
      return true;
    }
  }
`;a+=`
  return false;
}
`,e.addFragmentCode(a)}get getFunctionName(){return`${this.prefix}_get`}};function bl(n,e,t,r){e*=6;let i=Math.floor(e),a=e-i,o=r*(1-t),l=r*(1-t*a),c=r*(1-t*(1-a));switch(i%6){case 0:n[0]=r,n[1]=c,n[2]=o;break;case 1:n[0]=l,n[1]=r,n[2]=o;break;case 2:n[0]=o,n[1]=r,n[2]=c;break;case 3:n[0]=o,n[1]=l,n[2]=r;break;case 4:n[0]=c,n[1]=o,n[2]=r;break;case 5:n[0]=r,n[1]=o,n[2]=l;break}return n}function I1(n,e,t,r){let i=Math.max(Math.max(e,t),r),a=Math.min(Math.min(e,t),r);if(n[2]=i,a===i)n[0]=0,n[1]=0;else{let o=i-a;n[1]=o/i,e===i?n[0]=(t-r)/o:t===i?n[0]=2+(r-e)/o:n[0]=4+(e-t)/o,n[0]/=6,n[0]<0&&(n[0]+=1),n[0]>1&&(n[0]-=1)}return n}var A1=2,wb=class{constructor(e){this.prefix=e;this.seedName=this.prefix+"_seed"}defineShader(e){let{seedName:t}=this;e.addUniform("highp uint",t),e.addFragmentCode(At),e.addFragmentCode(Cb),e.addFragmentCode(YD);let r=`
vec3 ${this.prefix}(uint64_t x) {
  uint h = hashCombine(${t}, x);
  vec${A1} v;
`;for(let i=0;i<A1;++i)r+=`
  v[${i}] = float(h & 0xFFu) / 255.0;
  h >>= 8u;
`;r+=`
  vec3 hsv = vec3(v.x, 0.5 + v.y * 0.5, 1.0);
  return hsvToRgb(hsv);
}
`,e.addFragmentCode(r)}enable(e,t,r){e.uniform1ui(t.uniform(this.seedName),r)}},M1=new Float32Array(3);function Tb(n){return`rgb(${n[0]*100}%,${n[1]*100}%,${n[2]*100}%)`}var ep=class{constructor(e=Kv()){this.hashSeed=e;this.changed=new ne}static getDefault(){return new ep(0)}get value(){return this.hashSeed}set value(e){e!==this.hashSeed&&(this.hashSeed=e,this.changed.dispatch())}compute(e,t){let r=Hc(this.hashSeed,t.low);r=Hc(r,t.high);let i=(r&255)/255,a=(r>>8&255)/255;return bl(e,i,.5+.5*a,1),e}computeCssColor(e){return this.compute(M1,e),Tb(M1)}randomize(){this.hashSeed=Kv(),this.changed.dispatch()}toString(){return`new SegmentColorHash(${this.hashSeed})`}toJSON(){return this.hashSeed===0?void 0:this.hashSeed}reset(){this.restoreState(0)}restoreState(e){let t=e>>>0;t!==this.hashSeed&&(this.hashSeed=t,this.changed.dispatch())}},Lb=class{constructor(e){this.prefix=e;this.hashMapShaderManager=new Zd("segmentStatedColorHash")}defineShader(e){this.hashMapShaderManager.defineShader(e);let t=`
bool ${this.getFunctionName}(uint64_t x, out vec4 value) {
  uint64_t uint64Value;
  if (${this.hashMapShaderManager.getFunctionName}(x, uint64Value)) {
    uint uintValue = uint64Value.value[0];
    value.r = float((uintValue & 0x0000ffu))       / 255.0;
    value.g = float((uintValue & 0x00ff00u) >>  8) / 255.0;
    value.b = float((uintValue & 0xff0000u) >> 16) / 255.0;
    value.a = float((uintValue & 0xff000000u) >> 24) / 255.0;
    return true;
  }
  return false;
}
`;e.addFragmentCode(t)}get getFunctionName(){return`${this.prefix}_get`}enable(e,t,r){this.hashMapShaderManager.enable(e,t,r)}disable(e,t){this.hashMapShaderManager.disable(e,t)}};var lm='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="arrowLeftIconTitle"><path d="M9 6l-6 6 6 6"></path><path d="M21 12H4"></path><path stroke-linecap="round" d="M3 12h1"></path></svg>';var cm='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="arrowRightIconTitle"><path d="M15 18l6-6-6-6"></path><path d="M3 12h17"></path><path stroke-linecap="round" d="M21 12h-1"></path></svg>';var kb=class{constructor(e){this.parents=new Array;this.parentPriorities=new Array;this.bindings=new Map;if(e!==void 0){this.parents.push(...e.parents),this.parentPriorities.push(...e.parentPriorities);for(let[t,r]of e.bindings)this.bindings.set(t,r)}}addParent(e,t){let{parents:r,parentPriorities:i}=this,a=0,{length:o}=r;for(;a<o&&t<i[a];)++a;return r.splice(a,0,e),i.splice(a,0,t),()=>{this.removeParent(e)}}removeParent(e){let t=this.parents.indexOf(e);if(t===-1)throw new Error("Attempt to remove non-existent parent map.");this.parents.splice(t,1),this.parentPriorities.splice(t,1)}set(e,t){this.bindings.set(e,t)}delete(e){this.bindings.delete(e)}clear(){this.bindings.clear(),this.parents.length=0,this.parentPriorities.length=0}get(e){let{parents:t,parentPriorities:r}=this,i=r.length,a=0,o;for(;a<i&&r[a]>0;++a)if(o=t[a].get(e),o!==void 0)return o;if(o=this.bindings.get(e),o!==void 0)return o;for(;a<i;++a)if(o=t[a].get(e),o!==void 0)return o}*getAll(e){let{parents:t,parentPriorities:r}=this,i=r.length,a=0,o;for(;a<i&&r[a]>0;)o=t[a].get(e),o!==void 0&&(yield o);for(o=this.bindings.get(e),o!==void 0&&(yield o);a<i;)o=t[a].get(e),o!==void 0&&(yield o)}*entries(){let{parents:e,parentPriorities:t}=this,r=t.length,i=0;for(;i<r&&t[i]>0;++i)yield*e[i].entries();for(yield*this.bindings.entries();i<r;++i)yield*e[i].entries()}};var Et;(function(i){i[i.CONTROL=1]="CONTROL",i[i.ALT=2]="ALT",i[i.META=4]="META",i[i.SHIFT=8]="SHIFT"})(Et||(Et={}));function um(n){return(n.ctrlKey?1:0)|(n.altKey?2:0)|(n.metaKey?4:0)|(n.shiftKey?8:0)}function Eb(n,e){let t="";return e&1&&(t+="control+"),e&2&&(t+="alt+"),e&4&&(t+="meta+"),e&8&&(t+="shift+"),t+=n,t}function u6(n,e,t){let r="";return e&1&&(r+="control+"),t&1&&(r+="control?+"),e&2&&(r+="alt+"),t&2&&(r+="alt?+"),e&4&&(r+="meta+"),t&4&&(r+="meta?+"),e&8&&(r+="shift+"),t&8&&(r+="shift?+"),r+=n,r}function R1(n){let e=n.indexOf(":"),t;if(e!==-1&&(t=n.substring(0,e),t!=="at"&&t!=="bubble"))throw new Error(`Invalid event phase: ${JSON.stringify(t)}`);let r=n.substring(e+1).split("+"),i,a=0,o=0;e:for(let l of r)switch(l){case"control":a|=1;break;case"control?":o|=1;break;case"alt":a|=2;break;case"alt?":o|=2;break;case"meta":a|=4;break;case"meta?":o|=4;break;case"shift":a|=8;break;case"shift?":o|=8;break;default:if(i===void 0)i=l;else{i=void 0;break e}}if(i===void 0||a&o)throw new Error(`Invalid event identifier: ${JSON.stringify(n)}`);return{phase:t,keyName:i,modifiers:a,optionalModifiers:o}}function*d6(n,e,t){t===0&&(yield Eb(n,e));for(let r=0;r<16;++r)(r&(e|t))===r&&(r&e)===e&&(yield Eb(n,r))}function*_1(n){let{phase:e}=n,t=d6(n.keyName,n.modifiers,n.optionalModifiers);if(e===void 0)for(let r of t)yield`at:${r}`,yield`bubble:${r}`;else for(let r of t)yield`${e}:${r}`}function p6(n,e){let t=u6(n.keyName,n.modifiers,n.optionalModifiers);return typeof e=="string"?{action:e,originalEventIdentifier:t}:{...e,originalEventIdentifier:t}}var Ie=class extends kb{static fromObject(e,t={}){let r=new Ie;if(r.label=t.label,t.parents!==void 0)for(let[i,a]of t.parents)r.addParent(i,a);for(let i of Object.keys(e))r.set(i,e[i]);return r}setFromObject(e){for(let t of Object.keys(e))this.set(t,e[t])}set(e,t){let r=R1(e),i=p6(r,t);for(let a of _1(r))super.set(a,i)}delete(e){for(let t of _1(R1(e)))super.delete(t)}describe(){let e=[],t=new Map;for(let[,r]of this.entries())t.set(r.originalEventIdentifier,r.action);for(let[r,i]of t)e.push(`${r}\u2192${i}`);return e.join(", ")}};function Db(n,e,t){if(t===void 0)return;t.stopPropagation!==!1&&n.stopPropagation();let r=new CustomEvent("action:"+t.action,{bubbles:!0,detail:e,cancelable:!0}),i=!n.target.dispatchEvent(r);(t.preventDefault!==!1||i)&&n.preventDefault()}var dm=[];dm[Event.AT_TARGET]="at";dm[Event.CAPTURING_PHASE]="capture";dm[Event.BUBBLING_PHASE]="bubble";function Pb(n,e,t,r,i){let a=dm[t]+":"+n,o=i.get(a);Db(e,r,o)}function pm(n,e,t,r){Pb(Eb(n,um(e)),e,e.eventPhase,t,r)}function ce(n,e,t,r){return An(n,`action:${e}`,t,r)}var Ib;function f6(){if(Ib===void 0){let n=new Ie;n.set("keyl","recolor"),n.set("keyx","clear-segments"),n.set("keys","toggle-show-slices"),n.set("keyb","toggle-scale-bar"),n.set("keyv","toggle-default-annotations"),n.set("keya","toggle-axis-lines"),n.set("keyo","toggle-orthographic-projection");for(let e=1;e<=9;++e)n.set("digit"+e,"toggle-layer-"+e),n.set("control+digit"+e,"select-layer-"+e),n.set("alt+digit"+e,"toggle-pick-layer-"+e);for(let e=0;e<26;++e){let t=String.fromCharCode(97+e),r=String.fromCharCode(65+e);n.set(`alt?+control?+shift+key${t}`,`tool-${r}`)}n.set("keyn","add-layer"),n.set("keyh","help"),n.set("space","toggle-layout"),n.set("shift+space","toggle-layout-alternative"),n.set("backslash","toggle-show-statistics"),Ib=n}return Ib}var Ab;function qc(){return Ab===void 0&&(Ab=Ie.fromObject({"control+mousedown2":"select-position"})),Ab}var Mb;function V1(){return Mb===void 0&&(Mb=Ie.fromObject({click0:"pin-annotation",mousedown2:"move-to-annotation"},{parents:[[qc(),0]]})),Mb}var Rb;function O1(){return Rb===void 0&&(Rb=Ie.fromObject({arrowleft:"x-",arrowright:"x+",arrowup:"y-",arrowdown:"y+",comma:"z-",period:"z+",bracketleft:"t-",bracketright:"t+",keyz:"snap","control+equal":"zoom-in","alt+equal":"depth-range-decrease","control+shift+equal":"zoom-in","alt+shift+equal":"depth-range-decrease","control+minus":"zoom-out","alt+minus":"depth-range-increase",keyr:"rotate-relative-z-",keye:"rotate-relative-z+","shift+arrowdown":"rotate-relative-x-","shift+arrowup":"rotate-relative-x+","shift+arrowleft":"rotate-relative-y-","shift+arrowright":"rotate-relative-y+","control+wheel":{action:"zoom-via-wheel",preventDefault:!0},"alt+wheel":{action:"adjust-depth-range-via-wheel",preventDefault:!0},"at:wheel":{action:"z+1-via-wheel",preventDefault:!0},"at:shift+wheel":{action:"z+10-via-wheel",preventDefault:!0},"at:dblclick0":"select","at:control+mousedown0":"annotate","at:mousedown2":"move-to-mouse-position","at:alt+mousedown0":"move-annotation","at:control+alt+mousedown2":"delete-annotation","at:touchpinch":"zoom-via-touchpinch","at:touchrotate":"rotate-in-plane-via-touchrotate","at:touchtranslate2":"translate-in-plane-via-touchtranslate","at:touchhold1":"move-to-mouse-position","at:touchtap1x2":"select","at:touchtap2x3":"snap"},{label:"All Data Panels",parents:[[qc(),0]]})),Rb}var _b;function h6(){return _b===void 0&&(_b=Ie.fromObject({"at:mousedown0":{action:"rotate-via-mouse-drag",stopPropagation:!0},"at:shift+mousedown0":{action:"translate-via-mouse-drag",stopPropagation:!0},"at:touchtranslate1":"rotate-out-of-plane-via-touchtranslate"},{parents:[[O1(),Number.NEGATIVE_INFINITY]]})),_b}var Vb;function m6(){return Vb===void 0&&(Vb=Ie.fromObject({"at:mousedown0":{action:"translate-via-mouse-drag",stopPropagation:!0},"at:shift+mousedown0":{action:"rotate-via-mouse-drag",stopPropagation:!0},"at:touchtranslate1":"translate-z-via-touchtranslate"},{parents:[[O1(),Number.NEGATIVE_INFINITY]]})),Vb}function N1(n){n.global.addParent(f6(),Number.NEGATIVE_INFINITY),n.sliceView.addParent(m6(),Number.NEGATIVE_INFINITY),n.perspectiveView.addParent(h6(),Number.NEGATIVE_INFINITY)}var Yc,tp=[];function g6(){if(Yc===void 0){let n=Yc=document.createElement("div");n.classList.add("neuroglancer-drag-status"),document.body.appendChild(n)}return Yc}function y6(){Yc!==void 0&&(Me(Yc),Yc.style.display="none")}function B1(n){let e=g6();Me(e),typeof n=="string"?e.appendChild(document.createTextNode(n)):e.appendChild(n()),e.style.display=""}function F1(n,e){Bf(tp,t=>!(t.target===n&&t.operation===e))}function er(n,e,t){F1(n,e),tp.push({target:n,operation:e,status:t}),B1(t)}function Xt(n,e){F1(n,e);let t=tp.length===0?void 0:tp[tp.length-1];t===void 0?y6():B1(t.status)}var v6=300,S6=100,mi={side:"right",col:0,row:Infinity,flex:1,size:v6,minSize:S6,visible:!1},tr=class{constructor(e=mi,t=e){this.defaultValue=e;this.value=t;this.changed=new $e;this.locationChanged=new $e;this.locationChanged.add(this.changed.dispatch);let r=this;this.watchableVisible={get value(){return r.visible},set value(i){r.visible=i},changed:r.locationChanged}}toJSON(e=this.defaultValue){let t={},{value:r}=this;for(let i in r)r[i]!==e[i]&&(t[i]=r[i]);return t}get visible(){return this.value.visible}set visible(e){let{value:t}=this;t.visible!==e&&(this.value={...t,visible:e},this.locationChanged.dispatch())}reset(){this.value!==this.defaultValue&&(this.value=this.defaultValue,this.locationChanged.dispatch())}restoreState(e,t=this.defaultValue){if(e===void 0)return;Q(e);let r={side:ie(e,"side",i=>{if(i!=="left"&&i!=="right"&&i!=="top"&&i!=="bottom")throw new Error(`Expected "left", "right", "top", or "bottom", but received: ${JSON.stringify(i)}`);return i},t.side),col:ie(e,"col",Ke,t.col),row:ie(e,"row",Ke,t.row),flex:ie(e,"flex",Ke,t.flex),size:ie(e,"size",ct,t.size),visible:ie(e,"visible",ha,t.visible),minSize:t.minSize};this.value=r,this.locationChanged.dispatch()}};function un(n,e,t){let{document:r}=n.view,i=n.clientX,a=n.clientY,o=p=>{let h=p.clientX-i,g=p.clientY-a;i=p.clientX,a=p.clientY,e(p,h,g)},l=n.button,c=p=>{r.removeEventListener("pointermove",o,!0),r.removeEventListener("pointerup",d,!1),t!==void 0&&t(p,p.clientX-i,p.clientY-a)},d=p=>{p.button===l&&c(p)};r.addEventListener("pointermove",o,!0),r.addEventListener("pointerup",d,!1),r.addEventListener("pointercancel",c,!1)}var U1='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="closeIconTitle"><path d="M6.34314575 6.34314575L17.6568542 17.6568542M6.34314575 17.6568542L17.6568542 6.34314575"></path></svg>';function He(n){let{title:e,onClick:t,href:r}=n,i;r!==void 0?(i=document.createElement("a"),i.href=r,i.target="_blank"):i=document.createElement("div"),e!==void 0&&(i.title=e),t!==void 0&&i.addEventListener("click",t);let{svg:a}=n;return i.className="neuroglancer-icon",a!==void 0&&(i.innerHTML=a),n.text!==void 0&&i.appendChild(document.createTextNode(n.text)),i}function Kc(n={}){return He({svg:U1,...n})}var xl="neuroglancer-drag-over",G1={row:"row",column:"col"},b6={left:"right",right:"left",top:"bottom",bottom:"top"},is={left:"column",right:"column",top:"row",bottom:"row"},fm={left:"row",right:"row",top:"column",bottom:"column"},as={row:"width",column:"height"},W1={row:"left",column:"top"},x6={row:"right",column:"bottom"},z1={left:"marginLeft",right:"marginRight",top:"marginTop",bottom:"marginBottom"},hm={left:-1,right:1,top:-1,bottom:1},Or=class extends H{constructor(e,t=new tr){super();this.sidePanelManager=e;this.location=t;this.element=document.createElement("div");this.visibility=new wt(wt.VISIBLE);let{element:r}=this;r.classList.add("neuroglancer-side-panel"),r.draggable=!0,r.addEventListener("dragstart",i=>{this.sidePanelManager.startDrag(this.makeDragSource(),i),r.style.backgroundColor="black",setTimeout(()=>{r.style.backgroundColor=""},0),er(r,"drag",()=>document.createTextNode("Drag side panel to move it to the left/right/top/bottom of another panel"))}),r.addEventListener("dragend",i=>{this.sidePanelManager.endDrag(),Xt(r,"drag")})}makeDragSource(){return{dropAsNewPanel:e=>{let t=this.location.value;this.location.value={...t,...e},this.location.locationChanged.dispatch()}}}close(){this.location.visible=!1}addTitleBar(e){let t=document.createElement("div");t.classList.add("neuroglancer-side-panel-titlebar");let{title:r}=e,i;r!==void 0&&(i=document.createElement("div"),i.classList.add("neuroglancer-side-panel-title"),i.textContent=r,t.appendChild(i));let a=Kc({title:"Close panel",onClick:()=>{this.close()}});return a.style.order="100",t.appendChild(a),this.element.appendChild(t),{titleBar:t,titleElement:i,closeButton:a}}addBody(e){e.draggable=!0,e.addEventListener("dragstart",t=>{t.preventDefault(),t.stopPropagation()}),this.element.appendChild(e)}},Ob=class extends H{constructor(e,t,r=new wt(wt.VISIBLE)){super();this.display=e;this.center=t;this.visibility=r;this.element=document.createElement("div");this.centerColumn=document.createElement("div");this.beforeRender=new $e;this.sides={left:this.makeSidePanelSideState("left"),right:this.makeSidePanelSideState("right"),top:this.makeSidePanelSideState("top"),bottom:this.makeSidePanelSideState("bottom")};this.registeredPanels=new Set;this.layoutNeedsUpdate=!1;this.invalidateLayout=()=>{this.layoutNeedsUpdate=!0,this.display.scheduleRedraw()};let{element:i,centerColumn:a}=this;i.style.display="flex",i.style.flex="1",i.style.flexDirection="row",a.style.display="flex",a.style.flex="1",a.style.flexDirection="column",a.style.flexBasis="0px",a.style.minWidth="0px",this.render(),this.registerDisposer(e.updateStarted.add(()=>{this.beforeRender.dispatch(),!!this.layoutNeedsUpdate&&(this.render(),++e.resizeGeneration)})),this.registerDisposer(this.visibility.changed.add(this.invalidateLayout))}get visible(){return this.visibility.visible}makeSidePanelSideState(e){return{flexGroups:[],outerDropZoneElement:this.makeDropZone(e,hm[e]*Infinity,0,e,!1)}}hasDroppablePanel(){return this.dragSource!==void 0}startDrag(e,t){setTimeout(()=>{this.dragSource===e&&(this.element.dataset.neuroglancerSidePanelDrag="true")},0),this.dragSource=e,t.stopPropagation(),t.dataTransfer.setData("neuroglancer-side-panel","")}endDrag(){delete this.element.dataset.neuroglancerSidePanelDrag,this.dragSource=void 0}makeDropZone(e,t,r,i,a=!1){let o=document.createElement("div");o.className="neuroglancer-side-panel-drop-zone";let l=10,c=is[i],d=fm[i];return o.style[as[d]]=`${l}px`,o.style[as[c]]="100%",a?(o.style.position="absolute",o.style[i]="50%",o.style[z1[i]]="-${size/2}px"):(o.style.position="relative",o.style[z1[b6[i]]]=`-${l}px`),o.addEventListener("dragenter",p=>{!this.hasDroppablePanel()||(o.classList.add(xl),p.preventDefault(),er(o,"drop",()=>document.createTextNode(`Drop side panel as new ${c}`)))}),o.addEventListener("dragleave",()=>{Xt(o,"drop"),o.classList.remove(xl)}),o.addEventListener("dragover",p=>{!this.hasDroppablePanel()||p.preventDefault()}),o.addEventListener("drop",p=>{let{dragSource:h}=this;if(h===void 0)return;Xt(o,"drop"),o.classList.remove(xl);let g=is[e];h.dropAsNewPanel({side:e,row:g==="column"?r:t,col:g==="row"?r:t}),this.dragSource=void 0,p.preventDefault(),p.stopPropagation()}),o}registerPanel(e){return this.registeredPanels.add(e),this.invalidateLayout(),e.location.locationChanged.add(this.invalidateLayout),()=>{this.unregisterPanel(e)}}unregisterPanel(e){var t;this.registeredPanels.delete(e),e.location.locationChanged.remove(this.invalidateLayout),(t=e.panel)==null||t.dispose(),this.invalidateLayout()}disposed(){for(let{panel:e}of this.registeredPanels)e==null||e.dispose();super.disposed()}render(){this.layoutNeedsUpdate=!1;let e={left:[],right:[],top:[],bottom:[]};for(let o of this.registeredPanels)e[o.location.value.side].push(o);let t=o=>this.renderSide(o,this.sides[o].flexGroups,e[o]),r=this;function*i(){yield r.sides.left.outerDropZoneElement,yield*t("left"),yield r.centerColumn,yield*t("right"),yield r.sides.right.outerDropZoneElement}$n(this.element,i());function*a(){yield r.sides.top.outerDropZoneElement,yield*t("top"),yield r.center,yield*t("bottom"),yield r.sides.bottom.outerDropZoneElement}$n(this.centerColumn,a())}makeCrossGutter(e,t){let r=document.createElement("div");r.style.position="relative";let i=fm[e];r.className=`neuroglancer-resize-gutter-${i==="row"?"horizontal":"vertical"}`,r.addEventListener("pointerdown",o=>{if("button"in o&&o.button!==0)return;o.preventDefault();let l=this.sides[e].flexGroups[t];if(l===void 0||!l.visible)return;let d=l.element.getBoundingClientRect()[as[i]],p=l.minSize,h=()=>{er(r,"drag",`Drag to resize, current ${as[i]} is ${l.crossSize}px`)};h(),un(o,(g,v,b)=>{let x=i==="row"?v:b;d-=hm[e]*x,l.crossSize=Math.max(p,Math.round(d)),h(),this.invalidateLayout()},()=>{Xt(r,"drag")})});let a=this.makeDropZone(e,t-hm[e]*.5,0,e,!0);return r.appendChild(a),r}makeFlexGutter(e,t,r){let i=document.createElement("div");i.style.position="relative";let a=is[e];i.className=`neuroglancer-resize-gutter-${a==="row"?"horizontal":"vertical"}`,i.addEventListener("pointerdown",l=>{if("button"in l&&l.button!==0)return;l.preventDefault();let c=this.sides[e].flexGroups[t];if(c===void 0||!c.visible)return;let{cells:d}=c,p=d[r];if(p===void 0||!p.registeredPanel.location.visible)return;let h=r+1;for(;h<d.length&&!d[h].registeredPanel.location.visible;)++h;if(h===d.length)return;let g=d[h],v=()=>{er(i,"drag",`Drag to resize, current ${as[a]} ratio is ${p.registeredPanel.location.value.flex} : ${g.registeredPanel.location.value.flex}`)};v(),un(l,b=>{let x=p.registeredPanel.panel,C=g.registeredPanel.panel;if(x===void 0||C===void 0)return;let T=x.element.getBoundingClientRect(),P=C.element.getBoundingClientRect(),I=Math.max(.1,Math.min(.9,a==="column"?(b.clientY-T.top)/(P.bottom-T.top):(b.clientX-T.left)/(P.right-T.left))),M=p.registeredPanel.location.value,D=g.registeredPanel.location.value,E=M.flex+D.flex;p.registeredPanel.location.value={...M,flex:Math.round(I*E*100)/100},g.registeredPanel.location.value={...D,flex:Math.round((1-I)*E*100)/100},v(),p.registeredPanel.location.locationChanged.dispatch(),g.registeredPanel.location.locationChanged.dispatch(),this.invalidateLayout()},()=>{Xt(i,"drag")})});let o=this.makeDropZone(e,t,r+.5,W1[is[e]],!0);return i.appendChild(o),i}renderSide(e,t,r){let i=G1[fm[e]],a=G1[is[e]];r.sort((c,d)=>{let p=c.location.value,h=d.location.value,g=p[a]-h[a];return g!==0?g:p[i]-h[i]});let o=this;function*l(){let c=0,d=r.length,p=0;for(;c<d;){let h=r[c].location.value[a],g=c,v=0,b=0;do{let P=r[g].location.value;if(P[a]!==h)break;P.visible&&(++v,b=Math.max(b,P.minSize)),++g}while(g<d);let x=v>0,C=t[p];if(C===void 0){let P=o.makeCrossGutter(e,p),I=document.createElement("div");I.className=`neuroglancer-side-panel-${is[e]}`,C=t[p]={element:I,gutterElement:P,cells:[],crossSize:-1,minSize:b,visible:x,beginDropZone:o.makeDropZone(e,p,-Infinity,W1[is[e]]),endDropZone:o.makeDropZone(e,p,Infinity,x6[is[e]])}}else C.visible=x,C.minSize=b,C.crossSize=Math.max(C.crossSize,b);function*T(){yield C.beginDropZone;let P=0;for(let I=c,M=0;I<g;++I,++M){let D=r[I],E=C.cells[M];E===void 0?E=C.cells[M]={registeredPanel:D,gutterElement:void 0}:E.registeredPanel=D;let V=E.registeredPanel.location.value;C.crossSize==-1&&(C.crossSize=Math.max(b,V.size)),(V[a]!==p||V[i]!==M||V.visible&&V.size!==C.crossSize)&&(E.registeredPanel.location.value={...V,[a]:p,[i]:M,size:V.visible?C.crossSize:V.size},E.registeredPanel.location.changed.dispatch());let O=V.visible&&o.visibility.visible,{panel:B}=D;if(!O){B!==void 0&&(B.dispose(),D.panel=void 0);continue}++P,B===void 0&&(B=D.panel=D.makePanel()),B.element.style.flex=v>1?`${V.flex}`:"1",yield B.element,P===v?E.gutterElement=void 0:(E.gutterElement===void 0&&(E.gutterElement=o.makeFlexGutter(e,p,M)),yield E.gutterElement)}yield C.endDropZone}$n(C.element,T()),C.cells.length=g-c,x&&(C.element.style[as[fm[e]]]=`${C.crossSize}px`,hm[e]>0?(yield C.gutterElement,yield C.element):(yield C.element,yield C.gutterElement)),c=g,++p}t.length=p}return l()}};function br(n,e="text/plain"){let t=!1,r=An(document,"copy",i=>{let{clipboardData:a}=i;a!==null&&(a.setData(e,n),t=!0),i.stopPropagation(),i.preventDefault()},!0);try{document.execCommand("copy")}finally{r()}return t}var kn=class extends H{constructor(e,t,r){super();this.target=e;this.eventMap=t;this.registerEventListener(e,"wheel",i=>{r!==void 0&&r(i),this.dispatch("wheel",i)}),this.registerEventListener(e,"click",i=>{r!==void 0&&r(i),this.dispatch(`click${i.button}`,i)}),this.registerEventListener(e,"dblclick",i=>{r!==void 0&&r(i),this.dispatch(`dblclick${i.button}`,i)}),this.registerEventListener(e,"mousedown",i=>{r!==void 0&&r(i);let a=i.button;a===2&&(i.buttons&3)==1&&(a=0),this.dispatch(`mousedown${a}`,i)}),this.registerEventListener(e,"mouseup",i=>{r!==void 0&&r(i),this.dispatch(`mouseup${i.button}`,i)})}dispatch(e,t){pm(e,t,t,this.eventMap)}};var nr=class extends H{constructor(e,t){super();this.element=He({...t,onClick:()=>{e.value=!e.value}}),this.element.classList.add("neuroglancer-checkbox-icon"),this.element.classList.add(t.backgroundScheme==="dark"?"dark-background":"light-background");let r=()=>{let i=e.value;this.element.dataset.checked=i?"true":"false",this.element.title=(i?t.disableTitle:t.enableTitle)||""};this.registerDisposer(e.changed.add(r)),r()}};var H1='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="copyIconTitle"><rect width="12" height="14" x="8" y="7"></rect><polyline points="16 3 4 3 4 17"></polyline></svg>';function xr(n={}){return He({svg:H1,...n})}function mm(n={}){return He({text:"\u2197",...n})}function Nb(n){return n.closest(".neuroglancer-selection-details")}var Bb=class extends Or{constructor(e,t,r,i){super(e,t.location);this.sidePanelManager=e;this.state=t;this.manager=r;this.selectedLayer=i;this.body=document.createElement("div");let{element:a,body:o}=this;a.classList.add("neuroglancer-selection-details"),this.registerDisposer(new kn(this.element,qc()));let{titleBar:l}=this.addTitleBar({title:"Selection"}),c=He({svg:lm,title:"Previous selection",onClick:()=>{this.state.goBack()}}),d=He({svg:cm,title:"Next selection",onClick:()=>{this.state.goForward()}});l.appendChild(c),l.appendChild(d),l.appendChild(this.registerDisposer(new nr(t.pin,{text:"\u{1F4CC}\uFE0E",enableTitle:"Pin selection",disableTitle:"Unpin selection"})).element),o.classList.add("neuroglancer-selection-details-body"),this.addBody(o),o.appendChild(this.registerDisposer(new Ln(t,(p,h,g)=>{if(!t.location.visible||(c.style.visibility=t.canGoBack()?"visible":"hidden",d.style.visibility=t.canGoForward()?"visible":"hidden",p===void 0))return;let{position:v}=p;if(v!==void 0){let b=document.createElement("div");b.classList.add("neuroglancer-selection-details-position");let x=xr({title:"Copy position",onClick:()=>{br(P.map(M=>Math.floor(M)).join(", "))}});b.appendChild(x);let{coordinateSpace:{rank:C,names:T},position:P}=p;for(let M=0;M<C;++M){let D=document.createElement("span");D.classList.add("neuroglancer-selection-details-position-dimension");let E=document.createElement("span");E.classList.add("neuroglancer-selection-details-position-dimension-name"),E.textContent=T[M];let V=document.createElement("span");V.classList.add("neuroglancer-selection-details-position-dimension-coordinate"),V.textContent=Math.floor(P[M]).toString(),D.appendChild(E),D.appendChild(V),b.appendChild(D)}let I=mm({title:"Move to position",onClick:()=>{this.manager.globalPosition.value=P}});b.appendChild(I),h.appendChild(b)}for(let b of p.layers){let{layer:x}=b;h.appendChild(g.registerDisposer(new Ln({value:void 0,changed:x.managedLayer.layerChanged},(C,T,P)=>{if(x.wasDisposed||!x.isReady)return;let I=document.createElement("div");if(I.classList.add("neuroglancer-selection-details-layer-body"),!x.displaySelectionState(b.state,I,P))return;let M=document.createElement("div");T.appendChild(M),M.classList.add("neuroglancer-selection-details-layer");let D=document.createElement("div");D.classList.add("neuroglancer-selection-details-layer-title"),D.textContent=x.managedLayer.name,D.addEventListener("click",()=>{this.selectedLayer.layer=x.managedLayer,this.selectedLayer.visible=!0}),D.title="Click to show layer side panel",M.appendChild(D),M.appendChild(I)})).element)}})).element)}close(){super.close(),this.state.value=void 0,this.state.pin.value=!0}};var $1='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="filterIconTitle"><path d="M10 12.261L4.028 3.972h16L14 12.329V17l-4 3z"></path></svg>';function j1(n={}){return He({svg:$1,...n})}var $i=class{constructor(e,t,r){this.key=e;this.value=t;this.label=r}toString(){let{key:e,value:t,label:r}=this,i;return t===void 0?i=`${e}`:i=`${e}\u2192${t}`,r===void 0?i:`${i} ${r}`}},Fb=class extends H{constructor(){super(...arguments);this.selectedSegment=new X;this.baseSelectedSegment=new X;this.hasSelectedSegment=!1;this.changed=new ne}get value(){return this.hasSelectedSegment?this.selectedSegment:void 0}get baseValue(){return this.hasSelectedSegment?this.baseSelectedSegment:void 0}set(e,t=!1){let{selectedSegment:r,baseSelectedSegment:i}=this,a=0,o=0,l=0,c=0,d;if(e==null)d=!1;else if(typeof e=="number")a=l=e>>>0,o=c=e<0?4294967295:0,d=!0;else if(e instanceof $i){let p=e.value||e.key;a=p.low,o=p.high,l=e.key.low,c=e.key.high,d=!0}else e instanceof X?(a=l=e.low,o=c=e.high,d=!0):d=!1;t&&a===0&&o===0&&(d=!1),d?d&&(!this.hasSelectedSegment||r.low!==a||r.high!==o||i.low!==l||i.high!==c)&&(r.low=a,r.high=o,i.low=l,i.high=c,this.hasSelectedSegment=!0,this.changed.dispatch()):this.hasSelectedSegment&&(this.hasSelectedSegment=!1,this.changed.dispatch())}isSelected(e){return this.hasSelectedSegment&&X.equal(e,this.selectedSegment)}bindTo(e,t){this.registerDisposer(e.changed.add(()=>{let r=e.get(t),i;r!==void 0&&(i=r.value),this.set(i,t.displayState.segmentationGroupState.value.hideSegmentZero.value)}))}};function Cl(n){n.useTemporarySegmentEquivalences.value=!1,n.useTemporaryVisibleSegments.value=!1,n.temporaryVisibleSegments.clear(),n.temporarySegmentEquivalences.clear()}function Ub(n,e,t=!1){let r,i,a,o;if(typeof e=="number"?r=new X(e>>>0,e<0?4294967295:0):typeof e=="string"?r=X.parseString(e):r=t?e.clone():e,n==null)return r;let{segmentEquivalences:l,segmentPropertyMap:{value:c}}=n.segmentationGroupState.value;return l.size!==0?(i=l.get(r),X.equal(i,r)?a=void 0:a=i):i=r,o=c==null?void 0:c.getSegmentLabel(i),o===void 0&&a==null?r:new $i(r,a,o)}function Ia(n,e){if(e instanceof $i)return e;let t=Ub(n,e);return t instanceof X?new $i(t):t}function J1(n,e){let{length:t}=e;n.value<t&&(n.value=t)}function os(n,e){return Ir(t=>e.style.setProperty("--neuroglancer-segment-list-width",`${t}ch`),n.segmentationGroupState.value.maxIdLength)}var Gb=(()=>{let n=document.createElement("div");n.classList.add("neuroglancer-segment-list-entry");let e=document.createElement("div");e.classList.add("neuroglancer-segment-list-entry-sticky"),n.appendChild(e);let t=xr({title:"Copy segment ID"});t.classList.add("neuroglancer-segment-list-entry-copy");let r=document.createElement("div");r.classList.add("neuroglancer-segment-list-entry-copy-container");let i=r.childElementCount;r.appendChild(t);let a=e.childElementCount;e.appendChild(r);let o=e.childElementCount,l=document.createElement("input");l.type="checkbox",l.title="Toggle segment visibility",l.classList.add("neuroglancer-segment-list-entry-visible-checkbox"),e.appendChild(l);let c=document.createElement("div");c.classList.add("neuroglancer-segment-list-entry-id-container");let d=e.childElementCount;e.appendChild(c);let p=document.createElement("div");p.classList.add("neuroglancer-segment-list-entry-id");let h=c.childElementCount;c.appendChild(p);let g=document.createElement("span");g.classList.add("neuroglancer-segment-list-entry-name");let v=n.childElementCount;n.appendChild(g);let b=j1({title:"Filter by label"});b.classList.add("neuroglancer-segment-list-entry-filter");let x=n.childElementCount;return n.appendChild(b),{template:n,copyContainerIndex:a,copyIndex:i,visibleIndex:o,idContainerIndex:d,idIndex:h,labelIndex:v,filterIndex:x,unmappedIdIndex:-1,unmappedCopyIndex:-1}})(),C6=(()=>{let n=Gb,e=n.template.cloneNode(!0),t=e.children[0],r=t.children[n.idContainerIndex],i=r.childElementCount,a=r.children[n.idIndex].cloneNode(!0);a.classList.add("neuroglancer-segment-list-entry-unmapped-id"),r.appendChild(a);let o=t.children[n.copyContainerIndex],l=o.childElementCount;return o.appendChild(o.children[n.copyIndex].cloneNode(!0)),{...n,template:e,unmappedIdIndex:i,unmappedCopyIndex:l}})();function w6(n){let e=Gb,t=e.template.cloneNode(!0),r=[];for(let i=0;i<n;++i){r.push(t.childElementCount);let a=document.createElement("div");a.classList.add("neuroglancer-segment-list-entry-extra-property"),a.style.width=`max(var(--neuroglancer-column-${i}-width), var(--neuroglancer-column-${i}-label-width))`,t.appendChild(a)}return{...e,template:t,numericalPropertyIndices:r}}var q1=new WeakMap;function T6(n){let e=p=>{let h=p.currentTarget,g=h.dataset.id,v=ji;v.tryParseString(g),n.segmentSelectionState.set(v),Nb(h)||n.selectSegment(v,!1)},t=p=>{let h=p.currentTarget,g=h.dataset.id,v=ji;v.tryParseString(g),n.selectSegment(v,Nb(h)?"toggle":!0)},r=()=>{n.segmentSelectionState.set(null)},i=p=>p.currentTarget.closest(".neuroglancer-segment-list-entry"),a=p=>{let h=i(p);br(h.dataset.id),p.stopPropagation()},o=p=>{let h=i(p);br(h.dataset.unmappedId),p.stopPropagation()},l=p=>{let g=i(p).dataset.id,v=ji;v.tryParseString(g);let{visibleSegments:b}=n.segmentationGroupState.value;b.set(v,!b.has(v)),p.stopPropagation()},c=p=>{let g=i(p).dataset.id,v=ji;v.tryParseString(g),n.filterBySegmentLabel(v),p.stopPropagation()},d=p=>{if(p.button!==2||p.ctrlKey||p.altKey||p.metaKey||p.shiftKey)return;let g=p.currentTarget.dataset.id,v=ji;v.tryParseString(g),n.moveToSegment(v)};return(p,h)=>{let{children:g}=p,v=g[0].children;p.addEventListener("mousedown",d);let b=v[h.copyContainerIndex];h.unmappedCopyIndex!==-1&&b.children[h.unmappedCopyIndex].addEventListener("click",o),b.children[h.copyIndex].addEventListener("click",a),p.addEventListener("mouseenter",e),p.addEventListener("mouseleave",r),v[h.visibleIndex].addEventListener("click",l),g[h.filterIndex].addEventListener("click",c),p.addEventListener("action:select-position",t)}}var wl=class{constructor(e,t){this.displayState=e;this.template=t;if(e!==void 0){let r=q1.get(e);r===void 0&&(r=T6(e),q1.set(e,r)),this.registerEventHandlers=r}}static make(e,t){return new wl(e,t?C6:Gb)}get(e){let{displayState:t}=this;return this.getWithNormalizedId(Ia(t,e))}getWithNormalizedId(e){var g,v;let{displayState:t}=this,{template:r}=this,i=r.template.cloneNode(!0),a=e.key,o=(g=e.value)!=null?g:a,l=o.toString();i.dataset.id=l;let{children:c}=i,d=c[0].children,p=d[r.idContainerIndex];p.children[r.idIndex].textContent=l;let{unmappedIdIndex:h}=r;if(t!==void 0?this.registerEventHandlers(i,r):d[r.visibleIndex].style.display="none",h!==-1){let b=p.children[h];if(X.equal(a,o)){b.style.display="none";let x=d[r.copyContainerIndex];x.children[r.unmappedCopyIndex].style.display="none"}else{let x=a.toString();i.dataset.unmappedId=x,b.textContent=x,t!==void 0&&J1(t.segmentationGroupState.value.maxIdLength,x)}}return c[r.labelIndex].textContent=(v=e.label)!=null?v:"",t!==void 0&&(this.updateWithId(i,o),J1(t.segmentationGroupState.value.maxIdLength,l)),i}update(e){let t=ji,r=e.dataset.id;r!==void 0&&(t.parseString(r),this.updateWithId(e,t))}updateWithId(e,t){let{children:r}=e,i=r[0].children,{template:a}=this,{displayState:o}=this,{segmentSelectionState:l}=o,{visibleSegments:c}=o.segmentationGroupState.value;i[a.visibleIndex].checked=c.has(t),e.dataset.selected=(l.hasSelectedSegment&&X.equal(l.selectedSegment,t)).toString();let d=i[a.idContainerIndex];Y1(d.children[a.idIndex],Hb(this.displayState,t));let{unmappedIdIndex:p}=a;if(p!==-1){let h,g;if(o.baseSegmentColoring.value&&(h=e.dataset.unmappedId)!==void 0){let v=ji;v.parseString(h),g=Hb(this.displayState,v)}else g=Kf;Y1(d.children[p],g)}}};function Y1(n,e){n.style.backgroundColor=Tb(e),n.style.color=Sd(e)?"white":"black"}var Wb=class extends wl{constructor(e,t,r){var c;let i=e.segmentationGroupState.value.segmentPropertyMap.value,a=((c=i==null?void 0:i.numericalProperties)!=null?c:[]).filter(r),o=w6(a.length);super(e,o);this.parentElement=t,this.segmentPropertyMap=i,this.numericalProperties=a,(this.numericalPropertyWidths=new Array(this.numericalProperties.length)).fill(0)}getWithNormalizedId(e){var a,o,l;let t=super.getWithNormalizedId(e),{numericalProperties:r}=this,{numericalPropertyIndices:i}=this.template;if(i.length>0){let c=(l=(o=this.segmentPropertyMap)==null?void 0:o.getSegmentInlineIndex((a=e.value)!=null?a:e.key))!=null?l:-1;if(c!==-1){let{numericalPropertyWidths:d}=this;for(let p=0,h=i.length;p<h;++p){let g=r[p].values[c];if(!isNaN(g)){let v=g.toString(),b=v.length;b>d[p]&&(d[p]=b,this.parentElement.style.setProperty(`--neuroglancer-column-${p}-width`,`${b}ch`)),t.children[i[p]].textContent=v}}}}return t}makeHeaderLabel(e,t,r){let i=document.createElement("span");i.textContent=e,i.classList.add("neuroglancer-segment-list-header-label"),i.classList.add("neuroglancer-segment-list-header-label"),e==="label"&&(r.style.textAlign="left");let a=document.createElement("span");a.classList.add("neuroglancer-segment-list-header-label-sort"),i.appendChild(a),a.textContent="\u25B2";let o=$P(i).width;return this.parentElement.style.setProperty(t,`${o}px`),r.appendChild(i),{id:e,label:i,sortIcon:a}}getHeader(){let{template:e}=this,t=e.template.cloneNode(!0),{children:r}=t,i=r[0].children,a=i[e.copyContainerIndex];a.style.visibility="hidden",i[e.visibleIndex].style.visibility="hidden",r[e.filterIndex].style.visibility="hidden";let o=i[e.idContainerIndex],l=[this.makeHeaderLabel("id","--neuroglancer-id-column-label-width",o.children[e.idIndex]),this.makeHeaderLabel("label","--neuroglancer-label-column-label-width",r[e.labelIndex])],{numericalProperties:c}=this,{numericalPropertyIndices:d}=this.template;for(let p=0,h=d.length;p<h;++p){let g=c[p],v=this.makeHeaderLabel(g.id,`--neuroglancer-column-${p}-label-width`,t.children[d[p]]),{description:b}=g;b&&(v.label.title=b),l.push(v)}return{container:t,propertyLabels:l}}};function Tl(n,e){return wl.make(n!=null?n:void 0,!0).getWithNormalizedId(e)}function ss(n,e,t){e.registerDisposer(ja((r,i)=>{YP(r,i,t)},n.segmentationGroupState)),e.registerDisposer(ja((r,i)=>{r.registerDisposer(i.segmentColorHash.changed.add(t)),r.registerDisposer(i.segmentDefaultColor.changed.add(t))},n.segmentationColorGroupState)),e.registerDisposer(n.saturation.changed.add(t)),e.registerDisposer(n.segmentSelectionState.changed.add(t)),e.registerDisposer(n.baseSegmentColoring.changed.add(t)),e.registerDisposer(n.hoverHighlight.changed.add(t))}function zb(n,e){let t=e.redrawNeeded.dispatch;ss(n,e,t),e.registerDisposer(ja((r,i)=>{KP(r,i,t)},n.segmentationGroupState))}function L6(n,e){zb(n,e),e.registerDisposer(n.objectAlpha.changed.add(e.redrawNeeded.dispatch))}function np(n,e){L6(n,e),e.registerDisposer(n.transform.changed.add(e.redrawNeeded.dispatch)),e.registerDisposer(n.renderScaleTarget.changed.add(e.redrawNeeded.dispatch)),e.registerDisposer(n.transparentPickEnabled.changed.add(e.redrawNeeded.dispatch))}var K1=an.create(),ji=new X;function Hb(n,e,t=K1){if(n==null)return t.fill(1),t;let r=n.segmentationColorGroupState.value,{segmentStatedColors:i}=r;if(i.size!==0&&r.segmentStatedColors.get(e,ji))return t[0]=(ji.low&255)/255,t[1]=((ji.low&65280)>>>8)/255,t[2]=((ji.low&16711680)>>>16)/255,t;let a=r.segmentDefaultColor.value;return a!==void 0?(t[0]=a[0],t[1]=a[1],t[2]=a[2],t):(r.segmentColorHash.compute(t,e),t)}function k6(n,e,t=1){let r=K1;r[3]=t,Hb(n,e,r);let i=n.saturation.value;n.hoverHighlight.value&&n.segmentSelectionState.isSelected(e)&&(i>.5?i=i-=.5:i+=.5);for(let a=0;a<3;++a)r[a]=r[a]*i+(1-i);return r[0]*=t,r[1]*=t,r[2]*=t,r}function $b(n,e={}){for(let t of ob)e[t]=n[t].rpcId;return e}var E6=ya(wa),ls=class extends E6{constructor(e,t,r){super(r);this.chunkManager=e;this.displayState=t;let i=t.segmentationGroupState.value;for(let a of ob)this.registerDisposer(i[a].addRef())}initializeCounterpartWithChunkManager(e){let{displayState:t}=this;e.chunkManager=this.chunkManager.rpcId,$b(t.segmentationGroupState.value,e),e.transform=this.registerDisposer(bt.makeFromExisting(this.chunkManager.rpc,this.displayState.transform)).rpcId,e.renderScaleTarget=this.registerDisposer(bt.makeFromExisting(this.chunkManager.rpc,this.displayState.renderScaleTarget)).rpcId,super.initializeCounterpart(this.chunkManager.rpc,e)}};function rp(n,e,t,r,i){let a=Math.min(1,n.objectAlpha.value),o=n.baseSegmentColoring.value;Ta(n.segmentationGroupState.value,(l,c)=>{let d=r==null?void 0:r.registerUint64(e,l),p=t?k6(n,o?l:c,a):void 0;i(l,p,d,c)})}var D6=oe.create(),gi=It.create(),X1=!1;function Q1(n,e){e.vertexBuffer=Gt.fromData(n,e.meshData.vertexPositions,n.ARRAY_BUFFER,n.STATIC_DRAW),e.indexBuffer=Gt.fromData(n,e.meshData.indices,n.ELEMENT_ARRAY_BUFFER,n.STATIC_DRAW),e.normalBuffer=Gt.fromData(n,e.meshData.vertexNormals,n.ARRAY_BUFFER,n.STATIC_DRAW)}function Z1(n){n.vertexBuffer.dispose(),n.indexBuffer.dispose(),n.normalBuffer.dispose()}var P6=`
highp vec3 decodeNormalOctahedronSnorm8(highp vec2 e) {
  vec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));
  if (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * vec2(v.x > 0.0 ? 1.0 : -1.0, v.y > 0.0 ? 1.0 : -1.0);
  return normalize(v);
}
`;function eI(n){return{defineShader:e=>{e.addAttribute("highp vec3","aVertexPosition"),e.addVertexCode("highp vec3 getVertexPosition() { return aVertexPosition; }")},bind(e,t,r){r.vertexBuffer.bindToVertexAttrib(t.attribute("aVertexPosition"),3,n,!0)},endLayer:(e,t)=>{e.disableVertexAttribArray(t.attribute("aVertexPosition"))}}}var I6={[fi.float32]:eI(WebGL2RenderingContext.FLOAT),[fi.uint16]:eI(WebGL2RenderingContext.UNSIGNED_SHORT),[fi.uint10]:{defineShader:n=>{n.addAttribute("highp uint","aVertexPosition"),n.addVertexCode(`
highp vec3 getVertexPosition() {
  return vec3(float(aVertexPosition & 1023u),
              float((aVertexPosition >> 10) & 1023u),
              float((aVertexPosition >> 20) & 1023u)) / 1023.0;
}
`)},bind(n,e,t){t.vertexBuffer.bindToVertexAttribI(e.attribute("aVertexPosition"),1,WebGL2RenderingContext.UNSIGNED_INT)},endLayer:(n,e)=>{n.disableVertexAttribArray(e.attribute("aVertexPosition"))}}},jb=class{constructor(e,t){this.fragmentRelativeVertices=e;this.vertexPositionFormat=t;this.tempLightVec=new Float32Array(4);this.vertexPositionHandler=I6[this.vertexPositionFormat]}beginLayer(e,t,r,i){let{lightDirection:a,ambientLighting:o,directionalLighting:l}=r,c=this.tempLightVec;K.scale(c,a,l),c[3]=o,e.uniform4fv(t.uniform("uLightDirection"),c);let d=i.silhouetteRendering.value;d>0&&e.uniform1f(t.uniform("uSilhouettePower"),d)}setColor(e,t,r){e.uniform4fv(t.uniform("uColor"),r)}setPickID(e,t,r){e.uniform1ui(t.uniform("uPickID"),r)}beginModel(e,t,r,i){let{projectionParameters:a}=r;e.uniformMatrix4fv(t.uniform("uModelViewProjection"),!1,oe.multiply(D6,a.viewProjectionMat,i)),Hs(gi,i),Uv(gi,gi,a.displayDimensionRenderInfo.canonicalVoxelFactors),It.invert(gi,gi),It.transpose(gi,gi),e.uniformMatrix3fv(t.uniform("uNormalMatrix"),!1,gi)}drawFragmentHelper(e,t,r,i,a){this.vertexPositionHandler.bind(e,t,r);let{meshData:o}=r;r.normalBuffer.bindToVertexAttrib(t.attribute("aVertexNormal"),2,WebGL2RenderingContext.BYTE,!0),r.indexBuffer.bind();let{indices:l}=o;e.drawElements(o.strips?WebGL2RenderingContext.TRIANGLE_STRIP:WebGL2RenderingContext.TRIANGLES,a-i,l.BYTES_PER_ELEMENT===2?WebGL2RenderingContext.UNSIGNED_SHORT:WebGL2RenderingContext.UNSIGNED_INT,i*l.BYTES_PER_ELEMENT)}drawFragment(e,t,r){let{meshData:i}=r,{indices:a}=i;this.drawFragmentHelper(e,t,r,0,a.length)}drawMultiscaleFragment(e,t,r,i,a){let o=r.meshData.subChunkOffsets[i],l=r.meshData.subChunkOffsets[a];this.drawFragmentHelper(e,t,r,o,l)}endLayer(e,t){this.vertexPositionHandler.endLayer(e,t),e.disableVertexAttribArray(t.attribute("aVertexNormal"))}makeGetter(e){let t=e.registerDisposer(Mt(r=>r>0,[e.displayState.silhouetteRendering]));return Zr(e,e.gl,{memoizeKey:`mesh/MeshShaderManager/${this.fragmentRelativeVertices}/${this.vertexPositionFormat}`,parameters:t,defineShader:(r,i)=>{this.vertexPositionHandler.defineShader(r),r.addAttribute("highp vec2","aVertexNormal"),r.addVarying("highp vec4","vColor"),r.addUniform("highp vec4","uLightDirection"),r.addUniform("highp vec4","uColor"),r.addUniform("highp mat3","uNormalMatrix"),r.addUniform("highp mat4","uModelViewProjection"),r.addUniform("highp uint","uPickID"),i&&r.addUniform("highp float","uSilhouettePower"),this.fragmentRelativeVertices&&(r.addUniform("highp vec3","uFragmentOrigin"),r.addUniform("highp vec3","uFragmentShape")),r.addVertexCode(P6);let a="";this.fragmentRelativeVertices?a+=`
highp vec3 vertexPosition = uFragmentOrigin + uFragmentShape * getVertexPosition();
highp vec3 normalMultiplier = 1.0 / uFragmentShape;
`:a+=`
highp vec3 vertexPosition = getVertexPosition();
highp vec3 normalMultiplier = vec3(1.0, 1.0, 1.0);
`,a+=`
gl_Position = uModelViewProjection * vec4(vertexPosition, 1.0);
vec3 origNormal = decodeNormalOctahedronSnorm8(aVertexNormal);
vec3 normal = normalize(uNormalMatrix * (normalMultiplier * origNormal));
float absCosAngle = abs(dot(normal, uLightDirection.xyz));
float lightingFactor = absCosAngle + uLightDirection.w;
vColor = vec4(lightingFactor * uColor.rgb, uColor.a);
`,i&&(a+=`
vColor *= pow(1.0 - absCosAngle, uSilhouettePower);
`),r.setVertexMain(a),r.setFragmentMain("emit(vColor, uPickID);")}})}},gm=class extends Vr{constructor(e,t,r){super();this.chunkManager=e;this.source=t;this.displayState=r;this.meshShaderManager=new jb(!1,fi.float32);this.getShader=this.meshShaderManager.makeGetter(this);np(r,this),this.registerDisposer(r.silhouetteRendering.changed.add(this.redrawNeeded.dispatch));let i=this.backend=this.registerDisposer(new ls(e,r,this.layerChunkProgressInfo));i.RPC_TYPE_ID=g1,i.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()}),i.visibility.add(this.visibility),this.registerDisposer(r.renderScaleHistogram.visibility.add(this.visibility))}get isTransparent(){let{displayState:e}=this;return e.objectAlpha.value<1||e.silhouetteRendering.value>0}get transparentPickEnabled(){return this.displayState.transparentPickEnabled.value}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;let{gl:r,displayState:i,meshShaderManager:a}=this;if(i.objectAlpha.value<=0)return;let o=es(i.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(o===void 0)return;let{shader:l}=this.getShader(e.emitter);if(l===null)return;l.bind(),a.beginLayer(r,l,e,this.displayState),a.beginModel(r,l,e,o);let c=this.source.chunks,d=0,p=0,{renderScaleHistogram:h}=this.displayState,g=this.source.fragmentSource.chunks;rp(i,this,e.emitColor,e.emitPickID?e.pickIDs:void 0,(v,b,x)=>{let C=Rr(v),T=c.get(C);if(++d,T!==void 0){++p,e.emitColor&&a.setColor(r,l,b),e.emitPickID&&a.setPickID(r,l,x),d+=T.fragmentIds.length;for(let P of T.fragmentIds){let{key:I}=this.source.getFragmentKey(C,P),M=g.get(I);M!==void 0&&M.state===tt.GPU_MEMORY&&(a.drawFragment(r,l,M),++p)}}}),e.emitColor&&(h.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),h.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,p,d-p)),a.endLayer(r,l)}isReady(){let{displayState:e,source:t}=this,r=!0,i=t.fragmentSource.chunks;return Ta(e.segmentationGroupState.value,a=>{let o=Rr(a),l=t.chunks.get(o);if(l===void 0){r=!1;return}for(let c of l.fragmentIds){let{key:d}=this.source.getFragmentKey(o,c),p=i.get(d);if(p===void 0||p.state!==tt.GPU_MEMORY){r=!1;return}}}),r}},tI=class extends yr{constructor(e,t){super(e);this.fragmentIds=t.fragmentIds}},nI=class extends yr{constructor(e,t){super(e);this.meshData=t}copyToGPU(e){super.copyToGPU(e),Q1(e,this)}freeGPUMemory(e){super.freeGPUMemory(e),Z1(this)}},Vn=class extends Hn{constructor(e,t){super(e,t);this.fragmentSource=this.registerDisposer(new ym(this.chunkManager,this))}initializeCounterpart(e,t){this.fragmentSource.initializeCounterpart(this.chunkManager.rpc,{}),t.fragmentSource=this.fragmentSource.addCounterpartRef(),super.initializeCounterpart(e,t)}getChunk(e){return new tI(this,e)}getFragmentKey(e,t){return{key:`${e}/${t}`,fragmentId:t}}},ym=class extends Hn{constructor(e,t){super(e);this.meshSource=t}get key(){return this.meshSource.key}getChunk(e){return new nI(this,e)}};ym=Pt([wn(v1)],ym);function rI(n,e,t,r){let i=n.get(bb(e,t,r));return i!==void 0&&i.state===tt.GPU_MEMORY}var ip=class extends Vr{constructor(e,t,r){super();this.chunkManager=e;this.source=t;this.displayState=r;this.meshShaderManager=new jb(this.source.format.fragmentRelativeVertices,this.source.format.vertexPositionFormat);this.getShader=this.meshShaderManager.makeGetter(this);np(r,this),this.registerDisposer(r.silhouetteRendering.changed.add(this.redrawNeeded.dispatch));let i=this.backend=this.registerDisposer(new ls(e,r,this.layerChunkProgressInfo));i.RPC_TYPE_ID=y1,i.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()}),i.visibility.add(this.visibility),this.registerDisposer(r.renderScaleHistogram.visibility.add(this.visibility))}get isTransparent(){let{displayState:e}=this;return e.objectAlpha.value<1||e.silhouetteRendering.value>0}get transparentPickEnabled(){return this.displayState.transparentPickEnabled.value}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;let{gl:r,displayState:i,meshShaderManager:a}=this;if(i.objectAlpha.value<=0)return;let o=es(i.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(o===void 0)return;let{shader:l}=this.getShader(e.emitter);if(l===null)return;l.bind(),a.beginLayer(r,l,e,this.displayState);let{renderScaleHistogram:c}=this.displayState;e.emitColor&&c.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),Hs(gi,o),Uv(gi,gi,e.projectionParameters.displayDimensionRenderInfo.voxelPhysicalScales);let d=Math.pow(Math.abs(It.determinant(gi)),1/3),{chunks:p}=this.source,h=this.source.fragmentSource.chunks,{projectionParameters:g}=e,v=oe.multiply(oe.create(),g.viewProjectionMat,o),b=$s(new Float32Array(24),v),x=this.displayState.renderScaleTarget.value,{fragmentRelativeVertices:C}=this.source.format;a.beginModel(r,l,e,o);let T=0,P=0;rp(i,this,e.emitColor,e.emitPickID?e.pickIDs:void 0,(I,M,D)=>{let E=Rr(I),V=p.get(E);if(++T,V===void 0)return;++P;let{manifest:O}=V,{octree:B,chunkShape:z,chunkGridSpatialOrigin:_,vertexOffsets:F}=O;if(X1)try{x1(B)}catch(N){console.log(`invalid octree for object=${I}: ${N.message}`)}e.emitColor&&a.setColor(r,l,M),e.emitPickID&&a.setPickID(r,l,D),Sb(O,v,b,x,g.width,g.height,(N,J,ae)=>{let pe=rI(h,E,N,J);return e.emitColor&&c.add(O.lodScales[N]*d,ae,pe?1:0,pe?0:1),pe},(N,J,ae,pe)=>{let me=bb(E,N,J),Ae=h.get(me),le=B[5*J],we=B[5*J+1],_e=B[5*J+2],Fe=1<<N;if(C&&(r.uniform3f(l.uniform("uFragmentOrigin"),_[0]+le*z[0]*Fe+F[N*3+0],_[1]+we*z[1]*Fe+F[N*3+1],_[2]+_e*z[2]*Fe+F[N*3+2]),r.uniform3f(l.uniform("uFragmentShape"),z[0]*Fe,z[1]*Fe,z[2]*Fe)),X1){let rt=`lod=${N}, chunkIndex=${J}, subChunkBegin=${ae}, subChunkEnd=${pe}, uFragmentOrigin=${[_[0]+le*z[0]*Fe+F[N*3+0],_[1]+we*z[1]*Fe+F[N*3+1],_[2]+_e*z[2]*Fe+F[N*3+2]]}, uFragmentShape=${[z[0]*Fe,z[1]*Fe,z[2]*Fe]}`,ye=e.pickIDs.registerUint64(this,I,1,rt);e.emitPickID&&a.setPickID(r,l,ye)}a.drawMultiscaleFragment(r,l,Ae,ae,pe)})}),c.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,P,T-P),a.endLayer(r,l)}isReady(e,t){let{displayState:r}=this;if(r.objectAlpha.value<=0)return!0;let i=es(r.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(i===void 0)return!1;let{chunks:a}=this.source,o=this.source.fragmentSource.chunks,{projectionParameters:l}=e,c=oe.multiply(oe.create(),l.viewProjectionMat,i),d=$s(new Float32Array(24),c),p=this.displayState.renderScaleTarget.value,h=!0;return Ta(r.segmentationGroupState.value,g=>{if(!h)return;let v=Rr(g),b=a.get(v);if(b===void 0){h=!1;return}let{manifest:x}=b;Sb(x,c,d,p,l.width,l.height,(C,T)=>(h=h&&rI(o,v,C,T),h),()=>{})}),h}getObjectPosition(e){let t=this.displayState.transform.value;if(t.error!==void 0)return;let r=this.source.chunks.get(Rr(e));if(r===void 0)return;let{manifest:i}=r,{clipLowerBound:a,clipUpperBound:o}=i,{rank:l}=t,c=new Float32Array(l);for(let p=0;p<3;++p)c[p]=(a[p]+o[p])/2;let d=new Float32Array(l);return Kr(d,t.modelToRenderLayerTransform,l+1,c,l),d}},iI=class extends yr{constructor(e,t){super(e);this.manifest=t.manifest}},aI=class extends yr{constructor(e,t){super(e);this.meshData=t}copyToGPU(e){super.copyToGPU(e),Q1(e,this)}freeGPUMemory(e){super.freeGPUMemory(e),Z1(this)}},fo=class extends Hn{constructor(e,t){super(e,t);this.fragmentSource=this.registerDisposer(new vm(this.chunkManager,this));this.format=t.format}static encodeOptions(e){return{format:e.format,...super.encodeOptions(e)}}initializeCounterpart(e,t){this.fragmentSource.initializeCounterpart(this.chunkManager.rpc,{}),t.fragmentSource=this.fragmentSource.addCounterpartRef(),t.format=this.format,super.initializeCounterpart(e,t)}getChunk(e){return new iI(this,e)}},vm=class extends Hn{constructor(e,t){super(e);this.meshSource=t}get key(){return this.meshSource.key}getChunk(e){return new aI(this,e)}};vm=Pt([wn(S1)],vm);var oI="skeleton/SkeletonLayer";function dn(n,e,t){ie(n,e,r=>t.restoreState(r))}var jn=class extends H{constructor(){super(...arguments);this.children=new Map;this.changed=new ne}add(e,t){let{children:r}=this;if(r.has(e))throw new Error(`Key ${JSON.stringify(e)} already registered.`);return this.children.set(e,t),t.changed.add(this.changed.dispatch),this.changed.dispatch(),()=>{this.remove(e)}}remove(e){let{children:t}=this;if(t.has(e))throw new Error(`Key ${JSON.stringify(e)} not registered.`);let r=t.get(e);this.children.delete(e),r.changed.remove(this.changed.dispatch),this.changed.dispatch()}disposed(){let{changed:e}=this;for(let t of this.children.values())t.changed.remove(e.dispatch);this.children=void 0,super.disposed()}toJSON(){console.log(this.children);let e=this.baseJSON();for(let[t,r]of this.children)e[t]=r.toJSON();return e}baseJSON(){return{}}reset(){for(let e of this.children.values())e.reset()}restoreState(e){Q(e);for(let[t,r]of this.children)try{if(e.hasOwnProperty(t)){let i=e[t];if(i===void 0)continue;r.restoreState(i)}}catch(i){throw new Error(`Error restoring property ${JSON.stringify(t)}: ${i.message}`)}}};var sI=new WeakMap;function Ht(n){let e=sI.get(n),t=n.changed.count;if(e!==void 0&&e.generation===t)return e;let r;if(n instanceof jn){r=n.baseJSON();for(let[i,a]of n.children)r[i]=Ht(a).value}else r=n.toJSON();return e===void 0?(e={generation:t,value:r},sI.set(n,e)):(e.generation=t,e.value=r),e}var cs=class{constructor(e,t,r=t){this.enumType=e;this.value_=t;this.defaultValue=r;this.changed=new ne}set value(e){this.value_!==e&&(this.value_=e,this.changed.dispatch())}get value(){return this.value_}reset(){this.value=this.defaultValue}restoreState(e){this.value=yt(e,this.enumType)}toJSON(){if(this.value_!==this.defaultValue)return this.enumType[this.value_].toLowerCase()}};var ap=6;var Xc=`
vec2 getQuadVertexPosition(vec2 lower, vec2 upper) {
  const vec2 coeffs[] = vec2[](
    vec2(0.0, 0.0),
    vec2(0.0, 1.0),
    vec2(1.0, 1.0),
    vec2(1.0, 1.0),
    vec2(1.0, 0.0),
    vec2(0.0, 0.0)
  );
  int v = gl_VertexID % 6;
  return mix(lower, upper, coeffs[v]);
}
`;function Qc(n,e,t){n.drawArraysInstanced(WebGL2RenderingContext.TRIANGLES,0,ap*e,t)}var Sm=ap;function us(n,e){n.addVertexCode(Xc),n.addUniform("highp vec3","uCircleParams"),n.addVarying("highp vec4","vCircleCoord"),n.addVertexCode(`
void emitCircle(vec4 position, float diameter, float borderWidth) {
  gl_Position = position;
  float totalDiameter = diameter + 2.0 * (borderWidth + uCircleParams.z);
  if (diameter == 0.0) totalDiameter = 0.0;
  vec2 circleCornerOffset = getQuadVertexPosition(vec2(-1.0, -1.0), vec2(1.0, 1.0));
  gl_Position.xy += circleCornerOffset * uCircleParams.xy * gl_Position.w * totalDiameter;
  vCircleCoord.xy = circleCornerOffset;
  if (borderWidth == 0.0) {
    vCircleCoord.z = totalDiameter;
    vCircleCoord.w = 1e-6;
  } else {
    vCircleCoord.z = diameter / totalDiameter;
    vCircleCoord.w = uCircleParams.z / totalDiameter;
  }
}
`),e?n.addFragmentCode(`
float getCircleAlphaMultiplier() {
  return 1.0 - 2.0 * abs(0.5 - gl_FragCoord.z);
}
`):n.addFragmentCode(`
float getCircleAlphaMultiplier() {
  return 1.0;
}
`),n.addFragmentCode(`
vec4 getCircleColor(vec4 interiorColor, vec4 borderColor) {
  float radius = length(vCircleCoord.xy);
  if (radius > 1.0) {
    discard;
  }

  float borderColorFraction = clamp((radius - vCircleCoord.z) / vCircleCoord.w, 0.0, 1.0);
  float feather = clamp((1.0 - radius) / vCircleCoord.w, 0.0, 1.0);
  vec4 color = mix(interiorColor, borderColor, borderColorFraction);

  return vec4(color.rgb, color.a * feather * getCircleAlphaMultiplier());
}
`)}function ds(n,e,t){let{gl:r}=n;r.uniform3f(n.uniform("uCircleParams"),1/e.width,1/e.height,Math.max(1e-6,t.featherWidthInPixels))}function ps(n,e,t){Qc(n,e,t)}var yi=ap;function rr(n,e=!1){n.addVertexCode(Xc),n.addUniform("highp vec3","uLineParams"),n.addVarying("highp float","vLineCoord"),n.addVarying("highp float","vLineFeatherFraction"),e&&(n.addVarying("highp float","vEndpointFraction"),n.addVarying("highp float","vLineCoordT"),n.addVarying("highp float","vLineBorderStartFraction")),n.addVertexCode(nP),n.addVertexCode(`
vec2 getLineOffset() { return getQuadVertexPosition(vec2(0.0, -1.0), vec2(1.0, 1.0)); }
float getLineEndpointCoefficient() { return getLineOffset().x; }
uint getLineEndpointIndex() { return uint(getLineEndpointCoefficient()); }
void emitLine(vec4 vertexAClip, vec4 vertexBClip, float lineWidthInPixels
              ${e?", float borderWidth":""}) {
  if (!clipLineToDepthRange(vertexAClip, vertexBClip)) {
    gl_Position = vec4(2.0, 2.0, 2.0, 1.0);
    return;
  }
  vec3 vertexADevice = vertexAClip.xyz / vertexAClip.w;
  vec3 vertexBDevice = vertexBClip.xyz / vertexBClip.w;

  vec2 lineDirectionUnnormalized = vertexBDevice.xy - vertexADevice.xy;
  vec2 lineDirection;
  float linePixelLength = length(lineDirectionUnnormalized / uLineParams.xy * 0.5);

  if (linePixelLength < 1e-3) {
    lineDirection = vec2(1.0, 0.0);
    vertexADevice.z = vertexBDevice.z = 0.0;
  } else {
    lineDirection = normalize(lineDirectionUnnormalized);
  }
  vec2 lineNormal = normalize(vec2(lineDirection.y, -lineDirection.x) / uLineParams.yx * uLineParams.xy);

  vec2 lineOffset = getLineOffset();
  gl_Position = vec4(mix(vertexADevice, vertexBDevice, lineOffset.x), 1.0);
  float totalLineWidth = lineWidthInPixels + 2.0 * uLineParams.z ${e?" + 2.0 * borderWidth":""};
  if (lineWidthInPixels == 0.0) totalLineWidth = 0.0;
  vLineFeatherFraction = max(1e-6, uLineParams.z) / totalLineWidth;
  gl_Position.xy += (lineOffset.y * lineNormal
                     ${e?"+ lineDirection * (2.0 * lineOffset.x - 1.0)":""})
                  * totalLineWidth * uLineParams.xy;
  vLineCoord = lineOffset.y;
  ${e?"vEndpointFraction = totalLineWidth / (linePixelLength + totalLineWidth * 2.0);":""}
  ${e?"vLineCoordT = lineOffset.x; vLineBorderStartFraction = lineWidthInPixels / totalLineWidth;":""}
}
void emitLine(mat4 projection, vec3 vertexA, vec3 vertexB, float lineWidthInPixels
              ${e?", float borderWidth":""}) {
  emitLine(projection * vec4(vertexA, 1.0), projection * vec4(vertexB, 1.0),
           lineWidthInPixels
           ${e?", borderWidth":""});
}
`),e&&n.addFragmentCode(`
vec4 getRoundedLineColor(vec4 interiorColor, vec4 borderColor) {
  float radius;
  if (vLineCoordT < vEndpointFraction || vLineCoordT > 1.0 - vEndpointFraction) {
    radius = length(vec2(1.0 - min(vLineCoordT, 1.0 - vLineCoordT) / vEndpointFraction,
                         vLineCoord));
    if (radius > 1.0) {
      discard;
    }
  } else {
    radius = abs(vLineCoord);
  }
  float borderColorFraction = clamp((radius - vLineBorderStartFraction) / vLineFeatherFraction, 0.0, 1.0);
  float feather = clamp((1.0 - radius) / vLineFeatherFraction, 0.0, 1.0);
  vec4 color = mix(interiorColor, borderColor, borderColorFraction);
  return vec4(color.rgb, color.a * feather);
}
`),n.addFragmentCode(`
float getLineAlpha() {
  return clamp((1.0 - abs(vLineCoord)) / vLineFeatherFraction, 0.0, 1.0);
}
`)}function ir(n,e,t){Qc(n,e,t)}function ar(n,e,t){let{gl:r}=n;r.uniform3f(n.uniform("uLineParams"),1/e.width,1/e.height,t)}function Cr(n){n.addAttribute("int","aDummyVertexId",0),n.addVertexCode(`
int getVertexId () {
  return aDummyVertexId + gl_VertexID;
}
#define gl_VertexID (getVertexId())
`)}var Jn=class extends H{constructor(e){super();this.buffer=new Gt(e),this.size=0}disposed(){this.buffer.dispose()}enable(e=256){let{buffer:t}=this,{gl:r}=t;t.bind(),e>this.size&&(this.size=e,r.bufferData(WebGL2RenderingContext.ARRAY_BUFFER,new Int32Array(e),WebGL2RenderingContext.STATIC_DRAW)),r.vertexAttribIPointer(0,1,WebGL2RenderingContext.INT,0,0),r.vertexAttribDivisor(0,0),r.enableVertexAttribArray(0)}disable(){let{gl:e}=this.buffer;e.disableVertexAttribArray(0)}static get(e){return e.memoize.get("VertexIdHelper",()=>new Jn(e))}};var A6=oe.create(),lI=`void main() {
  emitDefault();
}
`,op=[],M6=hi(new Hi,W.FLOAT32,3),Jb=class extends H{constructor(e,t){super();this.base=e;this.targetIsSliceView=t;this.textureAccessHelper=new po("vertexData");this.vertexIdHelper=this.registerDisposer(Jn.get(this.gl));this.edgeShaderGetter=Zr(this,this.gl,{memoizeKey:{type:"skeleton/SkeletonShaderManager/edge",vertexAttributes:this.vertexAttributes},fallbackParameters:this.base.fallbackShaderParameters,parameters:this.base.displayState.skeletonRenderingOptions.shaderControlState.builderState,shaderError:this.base.displayState.shaderError,defineShader:(e,t)=>{if(t.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");this.defineCommonShader(e),this.defineAttributeAccess(e),rr(e),e.addAttribute("highp uvec2","aVertexIndex"),e.addUniform("highp float","uLineWidth");let r=`
highp vec3 vertexA = readAttribute0(aVertexIndex.x);
highp vec3 vertexB = readAttribute0(aVertexIndex.y);
emitLine(uProjection, vertexA, vertexB, uLineWidth);
highp uint lineEndpointIndex = getLineEndpointIndex();
highp uint vertexIndex = aVertexIndex.x * lineEndpointIndex + aVertexIndex.y * (1u - lineEndpointIndex);
`;e.addFragmentCode(`
vec4 segmentColor() {
  return uColor;
}
void emitRGB(vec3 color) {
  emit(vec4(color * uColor.a, uColor.a * getLineAlpha() * ${this.getCrossSectionFadeFactor()}), uPickID);
}
void emitDefault() {
  emit(vec4(uColor.rgb, uColor.a * getLineAlpha() * ${this.getCrossSectionFadeFactor()}), uPickID);
}
`),e.addFragmentCode(Oi);let{vertexAttributes:i}=this,a=i.length;for(let o=1;o<a;++o){let l=i[o];e.addVarying(`highp ${l.glslDataType}`,`vCustom${o}`),r+=`vCustom${o} = readAttribute${o}(vertexIndex);
`,e.addFragmentCode(`#define ${l.name} vCustom${o}
`)}e.setVertexMain(r),Fi(t,e),e.setFragmentMainFunction(Ni(t.parseResult.code))}});this.nodeShaderGetter=Zr(this,this.gl,{memoizeKey:{type:"skeleton/SkeletonShaderManager/node",vertexAttributes:this.vertexAttributes},fallbackParameters:this.base.fallbackShaderParameters,parameters:this.base.displayState.skeletonRenderingOptions.shaderControlState.builderState,shaderError:this.base.displayState.shaderError,defineShader:(e,t)=>{if(t.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");this.defineCommonShader(e),this.defineAttributeAccess(e),us(e,this.targetIsSliceView),e.addUniform("highp float","uNodeDiameter");let r=`
highp uint vertexIndex = uint(gl_InstanceID);
highp vec3 vertexPosition = readAttribute0(vertexIndex);
emitCircle(uProjection * vec4(vertexPosition, 1.0), uNodeDiameter, 0.0);
`;e.addFragmentCode(`
vec4 segmentColor() {
  return uColor;
}
void emitRGBA(vec4 color) {
  vec4 borderColor = color;
  emit(getCircleColor(color, borderColor), uPickID);
}
void emitRGB(vec3 color) {
  emitRGBA(vec4(color, 1.0));
}
void emitDefault() {
  emitRGBA(uColor);
}
`),e.addFragmentCode(Oi);let{vertexAttributes:i}=this,a=i.length;for(let o=1;o<a;++o){let l=i[o];e.addVarying(`highp ${l.glslDataType}`,`vCustom${o}`),r+=`vCustom${o} = readAttribute${o}(vertexIndex);
`,e.addFragmentCode(`#define ${l.name} vCustom${o}
`)}e.setVertexMain(r),Fi(t,e),e.setFragmentMainFunction(Ni(t.parseResult.code))}})}get vertexAttributes(){return this.base.vertexAttributes}defineCommonShader(e){Cr(e),e.addUniform("highp vec4","uColor"),e.addUniform("highp mat4","uProjection"),e.addUniform("highp uint","uPickID")}get gl(){return this.base.gl}defineAttributeAccess(e){let{textureAccessHelper:t}=this;t.defineShader(e);let r=this.vertexAttributes.length;for(let i=op.length;i<r;++i)op[i]=Symbol(`SkeletonShader.vertexAttributeTextureUnit${i}`);this.vertexAttributes.forEach((i,a)=>{e.addTextureSampler(`${Jc(i.dataType)}sampler2D`,`uVertexAttributeSampler${a}`,op[a]),e.addVertexCode(t.getAccessor(`readAttribute${a}`,`uVertexAttributeSampler${a}`,i.dataType,i.numComponents))})}getCrossSectionFadeFactor(){return this.targetIsSliceView?"(clamp(1.0 - 2.0 * abs(0.5 - gl_FragCoord.z), 0.0, 1.0))":"(1.0)"}beginLayer(e,t,r,i){let{viewProjectionMat:a}=r.projectionParameters,o=oe.multiply(A6,a,i);e.uniformMatrix4fv(t.uniform("uProjection"),!1,o),this.vertexIdHelper.enable()}setColor(e,t,r){e.uniform4fv(t.uniform("uColor"),r)}setPickID(e,t,r){e.uniform1ui(t.uniform("uPickID"),r)}drawSkeleton(e,t,r,i,a){let{vertexAttributes:o}=this,l=o.length,{vertexAttributeTextures:c}=i;for(let d=0;d<l;++d){let p=WebGL2RenderingContext.TEXTURE0+t.textureUnit(op[d]);e.activeTexture(p),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,c[d])}{t.bind();let d=t.attribute("aVertexIndex");i.indexBuffer.bindToVertexAttribI(d,2,WebGL2RenderingContext.UNSIGNED_INT),e.vertexAttribDivisor(d,1),ar(t,a,this.targetIsSliceView?1:0),ir(e,1,i.numIndices/2),e.vertexAttribDivisor(d,0),e.disableVertexAttribArray(d)}r!==null&&(r.bind(),ds(r,a,{featherWidthInPixels:this.targetIsSliceView?1:0}),ps(r.gl,2,i.numVertices))}endLayer(e,t){let{vertexAttributes:r}=this,i=r.length;for(let a=0;a<i;++a){let o=t.textureUnit(op[a])+WebGL2RenderingContext.TEXTURE0;e.activeTexture(o),e.bindTexture(e.TEXTURE_2D,null)}this.vertexIdHelper.disable()}},Zc;(function(t){t[t.LINES=0]="LINES",t[t.LINES_AND_POINTS=1]="LINES_AND_POINTS"})(Zc||(Zc={}));var qb=class extends cs{constructor(e,t=e){super(Zc,e,t)}},Yb=class extends Ce{constructor(e,t=e){super(e,ot,t)}},Kb=class{constructor(){this.compound=new jn;this.shader=Jo(lI);this.shaderControlState=new ao(this.shader);this.params2d={mode:new qb(1),lineWidth:new Yb(2)};this.params3d={mode:new qb(0),lineWidth:new Yb(1)};let{compound:e}=this;e.add("shader",this.shader),e.add("shaderControls",this.shaderControlState),e.add("mode2d",this.params2d.mode),e.add("lineWidth2d",this.params2d.lineWidth),e.add("mode3d",this.params3d.mode),e.add("lineWidth3d",this.params3d.lineWidth)}get changed(){return this.compound.changed}reset(){this.compound.reset()}restoreState(e){e!==void 0&&this.compound.restoreState(e)}toJSON(){let e=this.compound.toJSON();for(let t of Object.values(e))if(t!==void 0)return e}},Xb=class extends H{constructor(e,t,r){super();this.chunkManager=e;this.source=t;this.displayState=r;this.layerChunkProgressInfo=new so;this.redrawNeeded=new ne;this.fallbackShaderParameters=new ke(Ko(io(lI)));np(r,this),this.displayState.shaderError.value=void 0;let{skeletonRenderingOptions:i}=r;this.registerDisposer(i.shader.changed.add(()=>{this.displayState.shaderError.value=void 0,this.redrawNeeded.dispatch()}));let a=this.sharedObject=this.registerDisposer(new ls(e,r,this.layerChunkProgressInfo));a.RPC_TYPE_ID=oI,a.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()});let o=this.vertexAttributes=[_6];for(let[l,c]of t.vertexAttributes)o.push({name:l,dataType:c.dataType,numComponents:c.numComponents,webglDataType:R6(c.dataType),glslDataType:c.numComponents>1?`vec${c.numComponents}`:"float"})}get visibility(){return this.sharedObject.visibility}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t,r,i,a){let o=i.lineWidth.value,{gl:l,source:c,displayState:d}=this;if(d.objectAlpha.value<=0)return;let p=es(d.transform.value,e.projectionParameters.displayDimensionRenderInfo,a);if(p===void 0)return;let h;i.mode.value===1?h=Math.max(5,o*2):h=o;let g=r.edgeShaderGetter(e.emitter),v=r.nodeShaderGetter(e.emitter),{shader:b,parameters:x}=g,{shader:C,parameters:T}=v;if(b===null||C===null)return;let{shaderControlState:P}=this.displayState.skeletonRenderingOptions;b.bind(),r.beginLayer(l,b,e,p),ei(l,b,P,x.parseResult.controls),l.uniform1f(b.uniform("uLineWidth"),o),C.bind(),r.beginLayer(l,C,e,p),l.uniform1f(C.uniform("uNodeDiameter"),h),ei(l,C,P,T.parseResult.controls);let I=c.chunks;rp(d,t,e.emitColor,e.emitPickID?e.pickIDs:void 0,(M,D,E)=>{let V=Rr(M),O=I.get(V);O===void 0||O.state!==tt.GPU_MEMORY||(D!==void 0&&(b.bind(),r.setColor(l,b,D),C.bind(),r.setColor(l,C,D)),E!==void 0&&(b.bind(),r.setPickID(l,b,E),C.bind(),r.setPickID(l,C,E)),r.drawSkeleton(l,b,C,O,e.projectionParameters))}),r.endLayer(l,b)}isReady(){let{source:e,displayState:t}=this;if(t.objectAlpha.value<=0)return!0;let r=e.chunks,i=!0;return Ta(t.segmentationGroupState.value,a=>{let o=Rr(a),l=r.get(o);if(l===void 0||l.state!==tt.GPU_MEMORY){i=!1;return}}),i}},sp=class extends Vr{constructor(e){super();this.base=e;this.renderHelper=this.registerDisposer(new Jb(this.base,!1));this.renderOptions=this.base.displayState.skeletonRenderingOptions.params3d;this.layerChunkProgressInfo=e.layerChunkProgressInfo,this.registerDisposer(e),this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch));let{renderOptions:t}=this;this.registerDisposer(t.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.lineWidth.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.visibility.add(this.visibility))}get gl(){return this.base.gl}get isTransparent(){return this.base.displayState.objectAlpha.value<1}draw(e,t){!e.emitColor&&e.alreadyEmittedPickID||this.base.draw(e,this,this.renderHelper,this.renderOptions,t)}isReady(){return this.base.isReady()}},bm=class extends di{constructor(e){super();this.base=e;this.renderHelper=this.registerDisposer(new Jb(this.base,!0));this.renderOptions=this.base.displayState.skeletonRenderingOptions.params2d;this.layerChunkProgressInfo=e.layerChunkProgressInfo,this.registerDisposer(e);let{renderOptions:t}=this;this.registerDisposer(t.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.lineWidth.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.visibility.add(this.visibility))}get gl(){return this.base.gl}draw(e,t){this.base.draw(e,this,this.renderHelper,this.renderOptions,t)}isReady(){return this.base.isReady()}};function R6(n){switch(n){case W.FLOAT32:return WebGL2RenderingContext.FLOAT;default:throw new Error(`Data type not supported by WebGL: ${W[n]}`)}}var _6={dataType:W.FLOAT32,numComponents:3,name:"",webglDataType:WebGL2RenderingContext.FLOAT,glslDataType:"vec3"},cI=class extends yr{constructor(e,t){super(e);this.vertexAttributes=t.vertexAttributes;let r=this.indices=t.indices;this.numVertices=t.numVertices,this.vertexAttributeOffsets=t.vertexAttributeOffsets,this.numIndices=r.length}copyToGPU(e){super.copyToGPU(e);let{attributeTextureFormats:t}=this.source,{vertexAttributes:r,vertexAttributeOffsets:i}=this,a=this.vertexAttributeTextures=[];for(let o=0,l=i.length;o<l;++o){let c=e.createTexture();e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,c),rs(e,t[o],r.subarray(i[o],o+1!==l?i[o+1]:r.length)),a[o]=c}e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null),this.indexBuffer=Gt.fromData(e,this.indices,WebGL2RenderingContext.ARRAY_BUFFER,WebGL2RenderingContext.STATIC_DRAW)}freeGPUMemory(e){super.freeGPUMemory(e);let{vertexAttributeTextures:t}=this;for(let r of t)e.deleteTexture(r);t.length=0,this.indexBuffer.dispose()}},V6=new Map;function O6(n){let e=[M6];for(let t of n.values())e.push(hi(new Hi,t.dataType,t.numComponents));return e}var Ji=class extends Hn{get attributeTextureFormats(){let e=this.attributeTextureFormats_;return e===void 0&&(e=this.attributeTextureFormats_=O6(this.vertexAttributes)),e}getChunk(e){return new cI(this,e)}constructor(e,t){super(e,t)}get vertexAttributes(){return V6}};var dt;(function(r){r[r.UNKNOWN=0]="UNKNOWN",r[r.IMAGE=1]="IMAGE",r[r.SEGMENTATION=2]="SEGMENTATION"})(dt||(dt={}));function xm(n){let{rank:e,dataType:t,fillValue:r=t===W.UINT64?X.ZERO:0,compressedSegmentationBlockSize:i}=n,{baseVoxelOffset:a=new Float32Array(e)}=n;return{...$o(n),compressedSegmentationBlockSize:i,baseVoxelOffset:a,dataType:t,fillValue:r}}function N6(n){if(n.compressedSegmentationBlockSize!==void 0||n.volumeType!==2&&!n.volumeSourceOptions.discreteValues)return!1;switch(n.dataType){case W.UINT32:case W.UINT64:break;default:return!1}switch(n.rank){case 3:return!0;case 4:{let{chunkDataSize:e}=n;return e[3]===1}default:return!1}}function Qb(n){let{rank:e,lowerVoxelBound:t,upperVoxelBound:r}=n;if(!N6(n))return xm(n);let{volumeSourceOptions:{displayRank:i,multiscaleToViewTransform:a},chunkToMultiscaleTransform:o,chunkToViewTransform:l}=n;l===void 0&&(l=ci(new Float32Array(e*i),i,a,i,o,e+1,i,e,e));let{maxCompressedSegmentationBlockSize:c,chunkDataSize:d}=n;return xm({...n,compressedSegmentationBlockSize:Float32Array.from(Rd({rank:e,chunkToViewTransform:l,displayRank:i,lowerVoxelBound:t,upperVoxelBound:r,maxVoxelsPerChunkLog2:9,maxBlockSize:c===void 0?d:$E(new Uint32Array(e),d,c)}))})}function Nr(n){let{rank:e}=n,{volumeSourceOptions:{displayRank:t,multiscaleToViewTransform:r,modelChannelDimensionIndices:i},chunkToMultiscaleTransform:a}=n,o=ci(new Float32Array(t*e),t,r,t,a,e+1,t,e,e),{minBlockSize:l}=n;l===void 0?(l=new Uint32Array(e),l.fill(1)):l=new Uint32Array(l);let{lowerVoxelBound:c,upperVoxelBound:d}=n;if(i.length!==0)for(let h of js(a,e,i)){let g=d[h];c!==void 0&&(g-=c[h]),l[h]=g}let{chunkDataSizes:p=xD({...n,minBlockSize:l,chunkToViewTransform:o,displayRank:t})}=n;return p.map(h=>Qb({...n,chunkDataSize:h,chunkToViewTransform:o}))}function Cm(n,e,t,r){let{dataType:i}=e;e.defineShader(n,t);let a="",o="";if(t===0)a+="highp int ignoredChannelIndex";else for(let c=0;c<t;++c)c!==0&&(a+=", "),a+=`highp int channelIndex${c}`,o+=`, channelIndex${c}`;n.addFragmentCode(qD);let l=`
${Ot(i)} getDataValue(${a}) {
  highp ivec3 p = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(${r}), uChunkDataSize - 1.0)));
  return getDataValueAt(p${o});
}
${Ot(i)} getInterpolatedDataValue(${a}) {
  highp vec3 positionWithinChunk = ${r};
  highp ivec3[2] points;
  points[0] = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(positionWithinChunk - 0.5), uChunkDataSize - 1.0)));
  points[1] = ivec3(max(vec3(0.0, 0.0, 0.0), min(ceil(positionWithinChunk - 0.5), uChunkDataSize - 1.0)));
  highp vec3 mixCoeff = fract(positionWithinChunk - 0.5);
  ${Ot(i)} xvalues[2];
  for (int ix = 0; ix < 2; ++ix) {
    ${Ot(i)} yvalues[2];
    for (int iy = 0; iy < 2; ++iy) {
      ${Ot(i)} zvalues[2];
      for (int iz = 0; iz < 2; ++iz) {
        zvalues[iz] = getDataValueAt(ivec3(points[ix].x, points[iy].y, points[iz].z)
                                     ${o});
      }
      yvalues[iy] = mixLinear(zvalues[0], zvalues[1], mixCoeff.z);
    }
    xvalues[ix] = mixLinear(yvalues[0], yvalues[1], mixCoeff.y);
  }
  return mixLinear(xvalues[0], xvalues[1], mixCoeff.x);
}
`;n.addFragmentCode(l),t<=1&&n.addFragmentCode(`
${Ot(i)} getDataValue() { return getDataValue(0); }
${Ot(i)} getInterpolatedDataValue() { return getInterpolatedDataValue(0); }
`)}var uI=new Array;function wm(n){uI.push(n)}function B6(n,e){for(let t of uI){let r=t(n,e);if(r!=null)return r}throw new Error("No chunk format handler found.")}var En=class extends dl{constructor(e,t){super(e,t);this.chunkFormatHandler=this.registerDisposer(B6(e.chunkQueueManager.gl,this.spec));let r=this.spec.upperVoxelBound.length;this.tempChunkGridPosition=new Float32Array(r),this.tempPositionWithinChunk=new Uint32Array(r)}static encodeSpec(e){let t=e;return{...super.encodeSpec(e),dataType:t.dataType,compressedSegmentationBlockSize:t.compressedSegmentationBlockSize&&Array.from(t.compressedSegmentationBlockSize),baseVoxelOffset:Array.from(t.baseVoxelOffset)}}get chunkFormat(){return this.chunkFormatHandler.chunkFormat}getValueAt(e,t){let r=this.spec.rank,i=this.tempChunkGridPosition,a=this.tempPositionWithinChunk,{spec:o}=this;{let{chunkDataSize:x}=o;for(let C=0;C<r;++C){let T=e[C],P=x[C],I=Math.floor(T/P);i[C]=I,a[C]=Math.floor(T-P*I)}}let l=this.chunks.get(i.join());if(l===void 0)return null;let c=l.chunkDataSize;for(let x=0;x<3;++x)if(a[x]>=c[x])return;if(t.channelSpaceShape.length===0)return l.getValueAt(a);let{numChannels:d,chunkChannelCoordinates:p,chunkChannelDimensionIndices:h}=t,g=h.length,v=0,b=new Array(d);for(let x=0;x<d;++x){for(let C=0;C<g;++C)a[h[C]]=p[v++];b[x]=l.getValueAt(a)}return b}getChunk(e){return this.chunkFormatHandler.getChunk(this,e)}},Zb=class extends qd{get chunkFormat(){return this.source.chunkFormat}constructor(e,t){super(e,t);this.chunkDataSize=t.chunkDataSize||e.spec.chunkDataSize}},Bt=class extends ub{};var dI=class extends nt(ut()(En),Xh){},pI=class extends nt(ut()(fo),Qh){},fI=class extends nt(ut()(Vn),Zh){},hI=class extends nt(ut()(Ji),em){},mI=class extends nt(ut()(ml),nm){},lp=new Map;lp.set("UINT8",W.UINT8);lp.set("FLOAT",W.FLOAT32);lp.set("UINT32",W.UINT32);lp.set("UINT64",W.UINT64);function F6(n){Q(n);try{return{corner:U(n,"corner",e=>bd(K.create(),e,Ke)),size:U(n,"size",e=>bd(K.create(),e,ot)),metadata:U(n,"metadata",Vt)}}catch(e){throw new Error(`Failed to parse bounding box: ${e.message}`)}}var gI=class{constructor(e){try{Q(e),this.numChannels=U(e,"channelCount",ct),this.dataType=U(e,"channelType",t=>ih(t,lp)),this.voxelSize=U(e,"pixelSize",t=>bd(K.create(),t,ot)),this.upperVoxelBound=U(e,"volumeSize",t=>bd(K.create(),t,ct)),this.boundingBoxes=U(e,"boundingBox",t=>t===void 0?[]:ge(t,F6))}catch(t){throw new Error(`Failed to parse BrainMaps volume geometry: ${t.message}`)}}};function U6(n){return Q(n),{name:U(n,"name",Z),type:U(n,"type",Z)}}function G6(n){try{return Q(n),U(n,"meshes",e=>e===void 0?[]:ge(e,U6))}catch(e){throw new Error(`Failed to parse BrainMaps meshes specification: ${e.message}`)}}var W6="([0-9]*\\.?[0-9]+(?:[eE][-+]?[0-9]+)?)",ex="([0-9]+)",yI=new RegExp(`^(.*)_${ex}x${ex}x${ex}_lod([0-9]+)_${W6}$`);function z6(n,e){let t=new Map,r=n.scales[0],i=new Set;for(let o of e){if(o.type!=="TRIANGLES")continue;let l=o.name.match(yI);if(l===null)continue;let c=l[1],d=t.get(c);d===void 0&&(d={key:c,chunkShape:K.create(),lods:[]},t.set(c,d));let p=parseInt(l[5]);if(d.lods[p]!==void 0){i.add(c);continue}let h=K.fromValues(parseInt(l[2],10),parseInt(l[3],10),parseInt(l[4],10)),g=new Uint32Array(3);for(let v=0;v<3;++v)g[v]=Math.ceil(r.upperVoxelBound[v]/h[v]);d.lods[p]={info:o,scale:parseFloat(l[6]),relativeBlockShape:h,gridShape:g}}let a=[];e:for(let o of t.values()){if(i.has(o.key))continue e;let l=o.lods[0];if(l===void 0)continue e;let c=l.relativeBlockShape;K.multiply(o.chunkShape,c,r.voxelSize);for(let d=1;d<o.lods.length;++d){let p=o.lods[d];if(p===void 0)continue e;let{relativeBlockShape:h}=p;for(let g=0;g<3;++g){let v=h[g],b=c[g];if(v<b||v%b!=0)continue e;h[g]=v/b}}c.fill(1),a.push(o)}return a}function H6(n,e){let t=z6(n,e),r=[],i=o=>{r.some(l=>l.name===o.name)||r.push(o)},a=new Set;for(let o of t){i({multi:o,single:void 0,name:o.key,partOfMultiscale:!1});for(let l of o.lods)a.add(l.info)}for(let o of e)i({single:o,multi:void 0,name:o.name,partOfMultiscale:a.has(o)});return r}var vI=class{constructor(e){try{Q(e);let t=this.scales=U(e,"geometry",o=>ge(o,l=>new gI(l)));if(t.length===0)throw new Error("Expected at least one scale.");let r=t[0],i=this.numChannels=r.numChannels,a=this.dataType=r.dataType;for(let o=1,l=t.length;o<l;++o){let c=t[o];if(c.dataType!==a)throw new Error(`Scale ${o} has data type ${W[c.dataType]} but scale 0 has data type ${W[a]}.`);if(c.numChannels!==i)throw new Error(`Scale ${o} has ${c.numChannels} channel(s) but scale 0 has ${i} channels.`)}this.box={lowerBounds:new Float64Array(3),upperBounds:new Float64Array(r.upperVoxelBound)}}catch(t){throw new Error(`Failed to parse BrainMaps multiscale volume specification: ${t.message}`)}}getModelSpace(e=!1){let t=this.scales[0],r=["x","y","z"],i=["m","m","m"],a=Array.from(t.voxelSize,c=>c/1e9),o=[0,0,0],l=Array.from(t.upperVoxelBound);return e&&(r.push("c^"),i.push(""),a.push(1),o.push(0),l.push(this.numChannels)),Oe({names:r,units:i,scales:Float64Array.from(a),boundingBoxes:[Rn({lowerBounds:new Float64Array(r.length),upperBounds:Float64Array.from(l)})]})}},SI=class extends Bt{constructor(e,t,r,i,a,o,l){super(e);this.instance=t;this.credentialsProvider=r;this.volumeId=i;this.changeSpec=a;this.multiscaleVolumeInfo=o;this.encoding=l.encoding,this.jpegQuality=l.jpegQuality,this.chunkLayoutPreference=l.chunkLayoutPreference;let c=dt.IMAGE;this.dataType===W.UINT64&&(c=dt.SEGMENTATION),this.volumeType=c}get scales(){return this.multiscaleVolumeInfo.scales}get dataType(){return this.multiscaleVolumeInfo.dataType}get rank(){return this.multiscaleVolumeInfo.numChannels!==1?4:3}getSources(e){let t=Ea.RAW;(this.dataType===W.UINT64||this.dataType===W.UINT32)&&this.volumeType===dt.SEGMENTATION&&this.encoding!==Ea.RAW?t=Ea.COMPRESSED_SEGMENTATION:this.volumeType===dt.IMAGE&&this.dataType===W.UINT8&&this.multiscaleVolumeInfo.numChannels===1&&this.encoding!==Ea.RAW&&e.discreteValues!==!0&&(t=Ea.JPEG);let r=t===Ea.JPEG?this.jpegQuality:void 0,i=this.scales[0],{upperVoxelBound:a}=i,o=K.create(),{rank:l}=this;return Qn(this.scales.map((c,d)=>{K.divide(o,c.voxelSize,i.voxelSize);let p=c.upperVoxelBound,h,{numChannels:g}=c,v=new Float32Array((l+1)**2);v[(l+1)*l+l]=1;let b=new Float32Array(l);g!==1&&(p=Float32Array.of(...p,g),h=Uint32Array.of(1,1,1,g),v[(l+1)*3+3]=1,b[3]=g);for(let x=0;x<3;++x)v[(l+1)*x+x]=o[x],b[x]=a[x]/o[x];return Nr({rank:l,minBlockSize:h,chunkToMultiscaleTransform:v,dataType:c.dataType,upperVoxelBound:p,volumeType:this.volumeType,volumeSourceOptions:e,chunkLayoutPreference:this.chunkLayoutPreference,maxCompressedSegmentationBlockSize:K.fromValues(64,64,64)}).map(x=>({chunkSource:this.chunkManager.getChunkSource(dI,{credentialsProvider:this.credentialsProvider,spec:x,parameters:{volumeId:this.volumeId,changeSpec:this.changeSpec,scaleIndex:d,encoding:t,jpegQuality:r,instance:this.instance}}),chunkToMultiscaleTransform:v,upperClipBound:b}))}))}};function $6(n){let e=oe.create(),t=n.scales[0].voxelSize;for(let r=0;r<3;++r)e[5*r]=1/t[r];return e}function j6(n){let e=n.match(/^([^:?\/]+:[^:?\/]+:[^:?\/]+)(?::([^:?\/]+))?(?:\/([^?]+))?(?:\?(.*))?$/);if(e===null)throw new Error(`Invalid Brain Maps volume key: ${JSON.stringify(n)}.`);let t;e[2]!==void 0&&(t={changeStackId:e[2]});let r=si(e[4]||"");return{volumeId:e[1],changeSpec:t,meshName:e[3],parameters:r}}function J6(n){try{return Q(n),{id:U(n,"id",Z),label:U(n,"label",Z),description:U(n,"description",Vt)}}catch(e){throw new Error(`Failed to parse project: ${e.message}`)}}function q6(n){try{return Q(n),U(n,"project",e=>e===void 0?[]:ge(e,J6))}catch(e){throw new Error(`Error parsing project list: ${e.message}`)}}function bI(n,e){try{return Q(n),U(n,e,t=>t===void 0?[]:ge(t,Z))}catch(t){throw new Error(`Error parsing dataset list: ${t.message}`)}}function Y6(n){return U(n,"changeStackId",e=>e===void 0?void 0:ge(e,Z))}var K6=nt(ut()(Wi),tm),xI=class extends K6{constructor(e,t){super(e,{rank:3,relationships:["segments"],properties:[],...t});this.credentialsProvider=this.registerDisposer(t.credentialsProvider.addRef())}hasNonSerializedProperties(){return!0}getSources(){let{upperVoxelBound:e}=this.parameters,t=$o({rank:3,chunkDataSize:e,upperVoxelBound:e}),r=oe.create();return[[{chunkSource:this.chunkManager.getChunkSource(mI,{parent:this,spec:{limit:0,chunkToMultiscaleTransform:r,...t},parameters:this.parameters,credentialsProvider:this.credentialsProvider}),chunkToMultiscaleTransform:r}]]}},X6=[{key:{value:"encoding",description:"Volume chunk data encoding"},values:[{value:"raw",description:""},{value:"jpeg",description:""},{value:"compressed_segmentation",description:""}]},{key:{value:"chunkLayout",description:"Volume chunk layout preference"},values:[{value:"isotropic",description:""},{value:"flat",description:""}]},{key:{value:"jpegQuality",description:"JPEG quality (1 to 100)"},values:[]}],Tm=class extends Rt{constructor(e,t){super();this.instance=e;this.credentialsProvider=t}get description(){return this.instance.description}getMultiscaleInfo(e,t){return e.memoize.getUncounted({type:"brainmaps:getMultiscaleInfo",volumeId:t,instance:this.instance,credentialsProvider:lt(this.credentialsProvider)},()=>yl(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/volumes/${t}`,responseType:"json"}).then(r=>new vI(r)))}getMeshesInfo(e,t){return e.memoize.getUncounted({type:"brainmaps:getMeshesInfo",volumeId:t,instance:this.instance,credentialsProvider:lt(this.credentialsProvider)},()=>yl(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/objects/${t}/meshes`,responseType:"json"}).then(r=>G6(r)))}get(e){let{volumeId:t,changeSpec:r,meshName:i,parameters:a}=j6(e.providerUrl);Q(a);let o=ie(a,"encoding",p=>yt(p,Ea)),l=ie(a,"jpegQuality",p=>{let h=ze(p);if(h<1||h>100)throw new Error(`Expected integer in range [1, 100], but received: ${p}`);return h},70),c=ie(a,"chunkLayout",p=>yt(p,Qr)),d={encoding:o,chunkLayoutPreference:c,jpegQuality:l};return e.chunkManager.memoize.getUncounted({type:"brainmaps:get",instance:this.instance,volumeId:t,changeSpec:r,brainmapsOptions:d},async()=>{let[p,h]=await Promise.all([this.getMultiscaleInfo(e.chunkManager,t),this.getMeshesInfo(e.chunkManager,t)]),g=new SI(e.chunkManager,this.instance,this.credentialsProvider,t,r,p,d),v={modelTransform:vt(p.getModelSpace(p.numChannels!==1)),subsources:[{id:i===void 0?"default":"volume",subsource:{volume:g},default:i===void 0}]},b=sn(p.box);p.scales[0].boundingBoxes.forEach((P,I)=>{b.add({type:Be.AXIS_ALIGNED_BOUNDING_BOX,description:P.metadata,pointA:P.corner,pointB:K.add(K.create(),P.corner,P.size),id:`boundingBox${I}`,properties:[]})}),v.subsources.push({id:"bounds",subsource:{staticAnnotations:b},default:!0});let C=H6(p,h),T=(P,I)=>{let M,{single:D}=P;if(D!==void 0)D.type==="TRIANGLES"?M=e.chunkManager.getChunkSource(fI,{credentialsProvider:this.credentialsProvider,parameters:{instance:this.instance,volumeId:t,meshName:D.name,changeSpec:r}}):M=e.chunkManager.getChunkSource(hI,{credentialsProvider:this.credentialsProvider,parameters:{instance:this.instance,volumeId:t,meshName:P.name,changeSpec:r}});else{let E=P.multi;M=e.chunkManager.getChunkSource(pI,{credentialsProvider:this.credentialsProvider,format:{fragmentRelativeVertices:!1,vertexPositionFormat:fi.float32},parameters:{instance:this.instance,volumeId:t,info:E,changeSpec:r}})}v.subsources.push({id:i===void 0?`/${P.name}`:"default",subsource:{mesh:M},subsourceToModelSubspaceTransform:$6(p),modelSubspaceDimensionIndices:[0,1,2],default:I})};if(i!==void 0){let P=C.find(I=>I.name===i);if(P===void 0)throw new Error(`Mesh/skeleton source not found: ${JSON.stringify(P)}`);T(P,!0)}else{let P=!0;for(let I of C)I.partOfMultiscale||(T(I,P),P=!1)}return r!==void 0&&v.subsources.push({id:"spatials",default:!0,modelSubspaceDimensionIndices:[0,1,2],subsource:{annotation:e.chunkManager.getChunkSource(xI,{parameters:{volumeId:t,changestack:r.changeStackId,instance:this.instance,upperVoxelBound:p.scales[0].upperVoxelBound},credentialsProvider:this.credentialsProvider})}}),v})}getProjectList(e){return e.memoize.getUncounted({instance:this.instance,type:"brainmaps:getProjectList"},()=>{let t=yl(this.instance,this.credentialsProvider,{method:"GET",path:"/v1beta2/projects",responseType:"json"}).then(i=>q6(i)),r=`${this.instance.description} project list`;return Ee.forPromise(t,{delay:!0,initialMessage:`Retrieving ${r}.`,errorPrefix:`Error retrieving ${r}: `}),t})}getDatasetList(e,t){return e.memoize.getUncounted({instance:this.instance,type:`brainmaps:${t}:getDatasetList`},()=>{let r=yl(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/datasets?project_id=${t}`,responseType:"json"}).then(a=>bI(a,"datasetIds")),i=`${this.instance.description} dataset list`;return Ee.forPromise(r,{delay:!0,initialMessage:`Retrieving ${i}`,errorPrefix:`Error retrieving ${i}`}),r})}getVolumeList(e,t,r){return e.memoize.getUncounted({instance:this.instance,type:`brainmaps:${t}:${r}:getVolumeList`},()=>{let i=yl(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/volumes?project_id=${t}&dataset_id=${r}`,responseType:"json"}).then(o=>{let l=bI(o,"volumeId"),c=t.length+r.length+2,d=[];for(let p of l)d.push(p.substring(c));return d}),a=`${this.instance.description} volume list`;return Ee.forPromise(i,{delay:!0,initialMessage:`Retrieving ${a}`,errorPrefix:`Error retrieving ${a}`}),i})}getChangeStackList(e,t){return e.memoize.getUncounted({instance:this.instance,type:"brainmaps:getChangeStackList",volumeId:t},()=>{let r=yl(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/changes/${t}/change_stacks`,responseType:"json"}).then(a=>Y6(a)),i=`change stacks for ${t}`;return Ee.forPromise(r,{delay:!0,initialMessage:`Retrieving ${i}.`,errorPrefix:`Error retrieving ${i}: `}),r})}async completeUrl(e){let{providerUrl:t}=e,r=t.match(/^([^:\/?]*)(?::([^:\/?]*)(?::([^:\/?]*)(?::([^:\/?]*))?(?:\/([^?]*))?(?:\?(.*))?)?)?$/);if(r===null)throw null;let[,i,a,o,l,c,d]=r;if(d!==void 0)return _r(t.length-d.length,await Jh(d,X6));if(c!==void 0){let h=`${i}:${a}:${o}`,g=await this.getMeshesInfo(e.chunkManager,h),v=[],b=new Set;for(let x of g)if(!!x.name.startsWith(c))switch(x.type){case"LINE_SEGMENTS":v.push({value:x.name,description:"Skeletons"});break;case"TRIANGLES":{v.push({value:x.name,description:"Mesh (single-resolution)"});let C=x.name.match(yI);if(C!==null){let T=C[1];if(b.has(T))break;b.add(T),v.push({value:T,description:"Mesh (multi-resolution)"})}break}}return v.sort((x,C)=>lo(x.value,C.value)),{offset:t.length-c.length,completions:v}}if(l!==void 0){let h=`${i}:${a}:${o}`,g=await this.getChangeStackList(e.chunkManager,h);if(g===void 0)throw null;return{offset:t.length-l.length,completions:jh(l,g)}}if(o!==void 0)return{offset:t.length-o.length,completions:jh(o,await this.getVolumeList(e.chunkManager,i,a))};if(a!==void 0){let h=await this.getDatasetList(e.chunkManager,i);return{offset:t.length-a.length,completions:jh(a,h.map(g=>`${g}:`))}}let p=await this.getProjectList(e.chunkManager);return{offset:0,completions:cn(i,p,h=>`${h.id}:`,h=>h.label)}}},CI={description:"Google Brain Maps",serverUrl:"https://brainmaps.googleapis.com"};var wI=new Map;function Ft(n,e){wI.set(n,e)}function Lm(n){let e=new gb(n.credentialsManager);for(let[t,r]of wI)e.register(t,r(n));return e}Ft("brainmaps",n=>new Tm(CI,n.credentialsManager.getCredentialsProvider(vb)));if(typeof NEUROGLANCER_BRAINMAPS_SERVERS!="undefined")for(let[n,e]of Object.entries(NEUROGLANCER_BRAINMAPS_SERVERS))Ft(`brainmaps-${n}`,t=>new Tm(e,t.credentialsManager.getCredentialsProvider(vb)));var TI="boss";function Ll(n,e,t,r,i=St){return uo(e,t,r,i).catch(a=>{if(a.status!==500&&a.status!==401&&a.status!==403&&a.status!==504)throw a;return ts(n,e,t,r,o=>{let l=new Headers(t.headers);return l.set("Authorization",`Bearer ${o}`),{...t,headers:l}},o=>{let{status:l}=o;if(l===403||l===401)return"refresh";throw o},i)})}var LI=class{},km=class extends LI{static stringify(e){return`boss:volume:${e.baseUrl}/${e.collection}/${e.experiment}/${e.channel}/${e.resolution}/${e.encoding}`}};km.RPC_ID="boss/VolumeChunkSource";var Em=class{static stringify(e){return`boss:mesh:${e.baseUrl}`}};Em.RPC_ID="boss/MeshChunkSource";var kI=class extends nt(ut()(En),km){},EI=class extends nt(ut()(Vn),Em){},tx=new Map;tx.set("image",dt.IMAGE);tx.set("annotation",dt.SEGMENTATION);var Q6=new Set(["npz","jpeg"]),Z6=Uint32Array.of(512,512,16),kl;(function(i){i[i.NANOMETERS=0]="NANOMETERS",i[i.MICROMETERS=1]="MICROMETERS",i[i.MILLIMETERS=2]="MILLIMETERS",i[i.CENTIMETERS=3]="CENTIMETERS"})(kl||(kl={}));function eH(n){switch(n){case 1:return 1e6;case 2:return 1e3;case 3:return 100;case 0:return 1e9}}function tH(n,e){Q(n);let t=U(n,"voxel_unit",d=>yt(d,kl)),r=eH(t),i=new Float32Array(3),a=new Float64Array(3),o=new Float64Array(3),l=new Float64Array(3),c=["x","y","z"];for(let d=0;d<3;++d){let p=c[d];i[d]=U(n,`${p}_voxel_size`,ot),a[d]=i[d]/r,o[d]=U(n,`${p}_start`,ze),l[d]=U(n,`${p}_stop`,ze)}return e.coordFrame={voxelSizeBaseInMeters:a,voxelSizeBaseInOriginalUnits:i,voxelOffsetBase:o,imageSizeBase:l,voxelUnit:t,names:c},e}function nH(n){let e=tx.get(n);return e===void 0&&(e=dt.UNKNOWN),e}function rH(n){Q(n);let e=U(n,"type",Z),t=!1;return U(n,"downsample_status",Z)==="DOWNSAMPLED"&&(t=!0),{channelType:e,description:U(n,"description",Z),volumeType:nH(e),dataType:U(n,"datatype",i=>yt(i,W)),downsampled:t,scales:[],key:U(n,"name",Z),baseResolution:U(n,"base_resolution",ze)}}function iH(n,e,t,r,i,a){Q(n);let o=U(n,"channels",l=>ge(l,c=>oH(e,t,r,a,i,c)));return Promise.all(o).then(l=>{let c=new Map;l.forEach(p=>{c.set(p.key,p)});let d={channels:c,scalingLevels:U(n,"num_hierarchy_levels",ze),coordFrameKey:U(n,"coord_frame",Z),coordFrame:void 0,key:U(n,"name",Z),collection:U(n,"collection",Z)};return fH(e,t,r,d)})}var DI=class extends Bt{constructor(e,t,r,i,a,o){super(e);this.baseUrl=t;this.credentialsProvider=r;this.experimentInfo=i;this.parameters=o;this.meshPath=void 0;this.meshUrl=void 0;if(a===void 0){let h=Array.from(i.channels.keys());if(h.length!==1)throw new Error(`Experiment contains multiple channels: ${JSON.stringify(h)}`);a=h[0]}let l=i.channels.get(a);if(l===void 0)throw new Error(`Specified channel ${JSON.stringify(a)} is not one of the supported channels ${JSON.stringify(Array.from(i.channels.keys()))}`);if(this.channel=a,this.channelInfo=l,this.scales=l.scales,i.coordFrame===void 0)throw new Error(`Specified experiment ${JSON.stringify(i.key)} does not have a valid coordinate frame`);this.coordinateFrame=i.coordFrame,this.channelInfo.downsampled===!1&&(this.scales=[l.scales[0]]),this.experiment=i.key;let c=Vt(o.window);if(c!==void 0){let h=hr.create(),g=c.split(/,/);if(g.length===2)h[0]=Ke(g[0]),h[1]=Ke(g[1]);else if(g.length===1)h[0]=0,h[1]=Ke(g[1]);else throw new Error(`Invalid window. Must be either one value or two comma separated values: ${JSON.stringify(c)}`);if(this.window=h,this.window[0]===this.window[1])throw new Error(`Invalid window. First element must be different from second: ${JSON.stringify(c)}.`)}let d=Vt(o.meshurl);d!==void 0&&(this.meshUrl=d);let p=Vt(o.encoding);if(p===void 0)p=this.dataType===W.UINT8?"jpeg":"npz";else if(!Q6.has(p))throw new Error(`Invalid encoding: ${JSON.stringify(p)}.`);this.encoding=p}get dataType(){return this.channelInfo.dataType}get volumeType(){return this.channelInfo.volumeType}get rank(){return 3}getSources(e){let t=this.scales[0].downsampleFactors,{rank:r}=this;return Qn(this.scales.map(i=>{let a=this.coordinateFrame.voxelOffsetBase,o=K.create();for(let h=0;h<3;++h)o[h]=Math.ceil(a[h]);let l=i.downsampleFactors,c=r+1,d=new Float32Array(c*c);d[d.length-1]=1;for(let h=0;h<3;++h){let g=l[h]/t[h];d[c*h+h]=g,d[c*r+h]=o[h]*g}r===4&&(d[c*3+3]=1);let p=i.imageSize;return Nr({rank:3,volumeType:this.volumeType,dataType:this.dataType,chunkToMultiscaleTransform:d,chunkDataSizes:[Z6],baseVoxelOffset:o,upperVoxelBound:p,volumeSourceOptions:e}).map(h=>({chunkSource:this.chunkManager.getChunkSource(kI,{credentialsProvider:this.credentialsProvider,spec:h,parameters:{baseUrl:this.baseUrl,collection:this.experimentInfo.collection,experiment:this.experimentInfo.key,channel:this.channel,resolution:i.key,encoding:this.encoding,window:this.window}}),chunkToMultiscaleTransform:d}))}))}getMeshSource(){return this.meshUrl!==void 0?this.chunkManager.getChunkSource(EI,{credentialsProvider:this.credentialsProvider,parameters:{baseUrl:this.meshUrl}}):null}},aH=/^([^\/?]+)\/([^\/?]+)(?:\/([^\/?]+))?(?:\?(.*))?$/;function PI(n,e,t,r,i){return n.memoize.getUncounted({hostname:e,collection:i,experiment:r,type:"boss:getExperimentInfo"},()=>Ll(t,`${e}/latest/collection/${i}/experiment/${r}/`,{},kt).then(a=>iH(a,n,e,t,i,r)))}function oH(n,e,t,r,i,a){return n.memoize.getUncounted({hostname:e,collection:i,experiment:r,channel:a,type:"boss:getChannelInfo"},()=>Ll(t,`${e}/latest/collection/${i}/experiment/${r}/channel/${a}/`,{},kt).then(rH))}function sH(n,e,t,r,i,a){return n.memoize.getUncounted({hostname:e,collection:r,experiment:i.key,channel:a,downsample:!0,type:"boss:getDownsampleInfoForChannel"},()=>Ll(t,`${e}/latest/downsample/${r}/${i.key}/${a}`,{},kt)).then(o=>cH(o,i,a))}function lH(n,e){Q(n);let t=U(n,"voxel_size",o=>Ii(o,AE)),r=U(n,"extent",o=>Ii(o,ME)),i=U(n,"num_hierarchy_levels",ze),a=new Array;for(let o=0;o<i;o++){let l=String(o),c=t.get(l),d=r.get(l);if(c===void 0||d===void 0)throw new Error(`Missing voxel_size/extent for resolution ${l}.`);let p=new Float32Array(3);for(let h=0;h<3;++h)p[h]=c[h]/e[h];a[o]={downsampleFactors:p,imageSize:d,key:l}}return a}function cH(n,e,t){let r=e.coordFrame;if(r===void 0)throw new Error(`Missing coordinate frame information for experiment ${e.key}. A valid coordinate frame is required to retrieve downsampling information.`);let i=e.channels.get(t);if(i===void 0)throw new Error(`Specified channel ${JSON.stringify(t)} is not one of the supported channels ${JSON.stringify(Array.from(e.channels.keys()))}`);return i.scales=lH(n,r.voxelSizeBaseInOriginalUnits),e.channels.set(t,i),e}function uH(n,e,t,r){let i=r.match(aH);if(i===null)throw new Error(`Invalid volume path ${JSON.stringify(r)}`);let a=i[1],o=i[2],l=i[3],c=si(i[4]||"");return n.memoize.getUncounted({hostname:e,path:r,type:"boss:getVolume"},async()=>{let d=await PI(n,e,t,o,a),p=await sH(n,e,t,a,d,l),h=new DI(n,e,t,p,l,c),g=p.coordFrame,v={lowerBounds:g.voxelOffsetBase,upperBounds:Float64Array.from(g.imageSizeBase,(C,T)=>g.voxelOffsetBase[T]+C)},b=Oe({rank:3,names:g.names,units:["m","m","m"],scales:g.voxelSizeBaseInMeters,boundingBoxes:[Rn(v)]});return{modelTransform:vt(b),subsources:[{id:"default",default:!0,subsource:{volume:h}},{id:"bounds",default:!0,subsource:{staticAnnotations:sn(v)}}]}})}var II=/^((?:http|https):\/\/[^\/?]+)\/(.*)$/;function dH(n,e,t){return n.memoize.getUncounted({hostname:e,type:"boss:getCollections"},()=>Ll(t,`${e}/latest/collection/`,{},kt).then(r=>U(r,"collections",i=>ge(i,Z))))}function pH(n,e,t,r){return n.memoize.getUncounted({hostname:e,collection:r,type:"boss:getExperiments"},()=>Ll(t,`${e}/latest/collection/${r}/experiment/`,{},kt).then(i=>U(i,"experiments",a=>ge(a,Z))))}function fH(n,e,t,r){let i=r.coordFrameKey;return n.memoize.getUncounted({hostname:e,coordinateframe:i,experimentInfo:r,type:"boss:getCoordinateFrame"},()=>Ll(t,`${e}/latest/coord/${i}/`,{},kt).then(a=>tH(a,r)))}function hH(n,e,t,r){let i=r.match(/^(?:([^\/]+)(?:\/?([^\/]*)(?:\/?([^\/]*)(?:\/?([^\/]*)?))?)?)?$/);if(i===null||i[1]===void 0)return Promise.reject(null);if(i[2]===void 0){let a=i[1]||"";return dH(n,e,t).then(o=>({offset:0,completions:cn(a,o,l=>l+"/",()=>{})}))}if(i[3]===void 0){let a=i[2]||"";return pH(n,e,t,i[1]).then(o=>({offset:i[1].length+1,completions:cn(a,o,l=>l+"/",()=>{})}))}return PI(n,e,t,i[2],i[1]).then(a=>{let o=cn(i[3],a.channels,l=>l[0],l=>`${l[1].channelType} (${W[l[1].dataType]})`);return{offset:i[1].length+i[2].length+2,completions:o}})}function mH(n){let e=n.match(/^(?:https:\/\/[^.]+([^\/]+))/);if(e===null)throw new Error(`Unable to construct auth server hostname from base hostname ${n}.`);return`https://auth${e[1]}/auth`}var nx=class extends Rt{constructor(e){super();this.credentialsManager=e}get description(){return"bossDB: Block & Object Storage System"}getCredentialsProvider(e){let t=mH(e);return this.credentialsManager.getCredentialsProvider(TI,t)}get(e){let t=e.providerUrl.match(II);if(t===null)throw new Error(`Invalid boss volume path: ${JSON.stringify(e.providerUrl)}`);let r=this.getCredentialsProvider(e.providerUrl);return uH(e.chunkManager,t[1],r,t[2])}async completeUrl(e){let t=e.providerUrl.match(II);if(t===null)throw null;let r=t[1],i=this.getCredentialsProvider(t[1]),a=t[2],o=await hH(e.chunkManager,r,i,a);return _r(t[1].length+1,o)}};Ft("boss",n=>new nx(n.credentialsManager));var rx="DVID";function gH(n){return n.text()}function AI(n,e,t=St){return yH(n,e.url,{method:e.method,body:e.payload},e.responseType===""?gH:e.responseType==="json"?kt:Kh,t)}function yH(n,e,t,r,i=St){return ts(n,e,t,r,(a,o)=>{let l={...o};return a.token&&(l.headers={...l.headers,Authorization:`Bearer ${a}`}),l},a=>{let{status:o}=a;if(o===403||o===401)return"refresh";throw a},i)}var ti;(function(i){i[i.JPEG=0]="JPEG",i[i.RAW=1]="RAW",i[i.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION",i[i.COMPRESSED_SEGMENTATIONARRAY=3]="COMPRESSED_SEGMENTATIONARRAY"})(ti||(ti={}));var Dm=class{},Pm=class extends Dm{};Pm.RPC_ID="dvid/VolumeChunkSource";var Im=class extends Dm{};Im.RPC_ID="dvid/SkeletonSource";var Am=class extends Dm{};Am.RPC_ID="dvid/MeshSource";var Mm=new Map;Mm.set("uint8",W.UINT8);Mm.set("uint32",W.UINT32);Mm.set("uint64",W.UINT64);var MI=class{constructor(e){this.obj=e;Q(e),U(e,"TypeName",Z)}get typeName(){return this.obj.TypeName}get compressionName(){return this.obj.Compression}},RI=class{constructor(e,t,r){this.obj=e;this.name=t;this.base=r}},_I=class extends nt(ut()(En),Pm){},VI=class extends nt(ut()(Ji),Im){},OI=class extends nt(ut()(Vn),Am){},cp=class extends RI{constructor(e,t,r,i,a){super(e,t,r);this.encoding=i;let o=U(e,"Extended",Q),l=U(o,"Values",d=>ge(d,Q));if(l.length<1)throw new Error("Expected Extended.Values property to have length >= 1, but received: ${JSON.stringify(extendedValues)}.");this.numLevels=1;let c=new Set(a);if(i===ti.COMPRESSED_SEGMENTATIONARRAY){let d=U(o,"MaxDownresLevel",ct);this.numLevels=d+1}else for(;c.has(t+"_"+this.numLevels.toString());)this.numLevels+=1;c.has(t+"_meshes")?this.meshSrc=t+"_meshes":this.meshSrc="",c.has(t+"_skeletons")?this.skeletonSrc=t+"_skeletons":this.skeletonSrc="",this.dataType=U(l[0],"DataType",d=>ih(d,Mm)),this.voxelSize=U(o,"VoxelSize",d=>Pe(K.create(),d,ot)),this.blockSize=U(o,"BlockSize",d=>Pe(K.create(),d,ot)),this.lowerVoxelBound=U(o,"MinPoint",d=>$v(K.create(),d)),this.upperVoxelBoundInclusive=U(o,"MaxPoint",d=>$v(K.create(),d))}get volumeType(){return this.encoding===ti.COMPRESSED_SEGMENTATION||this.encoding===ti.COMPRESSED_SEGMENTATIONARRAY?dt.SEGMENTATION:dt.IMAGE}getSources(e,t,r,i){let{encoding:a}=this,o=[],l=64;for(let c=0;c<this.numLevels;++c){let d=Math.pow(2,c),p=Math.pow(2,-c),h=K.create(),g=K.create();for(let T=0;T<3;++T){let P=Math.floor(this.lowerVoxelBound[T]*p);h[T]=P-P%l;let I=Math.ceil((this.upperVoxelBoundInclusive[T]+1)*p);g[T]=I,I%l!=0&&(g[T]+=l-I%l)}let v=t.dataInstanceKey;a!==ti.COMPRESSED_SEGMENTATIONARRAY&&c>0&&(v+="_"+c.toString());let b={baseUrl:t.baseUrl,nodeKey:t.nodeKey,dataInstanceKey:v,dataScale:c.toString(),encoding:a},x=oe.create();for(let T=0;T<3;++T)x[5*T]=d,x[12+T]=h[T]*d;let C=Nr({rank:3,chunkToMultiscaleTransform:x,dataType:this.dataType,baseVoxelOffset:h,upperVoxelBound:K.subtract(K.create(),g,h),volumeType:this.volumeType,volumeSourceOptions:r,compressedSegmentationBlockSize:a===ti.COMPRESSED_SEGMENTATION||a===ti.COMPRESSED_SEGMENTATIONARRAY?K.fromValues(8,8,8):void 0}).map(T=>({chunkSource:e.getChunkSource(_I,{spec:T,parameters:b,credentialsProvider:i}),chunkToMultiscaleTransform:x}));o.push(C)}return Qn(o)}};function vH(n,e,t){Q(n);let r=U(n,"Base",i=>new MI(i));switch(r.typeName){case"uint8blk":case"grayscale8":let i=r.compressionName.indexOf("jpeg")!==-1;return new cp(n,e,r,i?ti.JPEG:ti.RAW,t);case"labels64":case"labelblk":return new cp(n,e,r,ti.COMPRESSED_SEGMENTATION,t);case"labelarray":case"labelmap":return new cp(n,e,r,ti.COMPRESSED_SEGMENTATIONARRAY,t);default:throw new Error(`DVID data type ${JSON.stringify(r.typeName)} is not supported.`)}}var up=class{constructor(e){this.errors=[];this.dataInstances=new Map;this.vnodes=new Set;if(e instanceof up){this.alias=e.alias,this.description=e.description,this.errors=e.errors,this.dataInstances=e.dataInstances;return}Q(e),this.alias=U(e,"Alias",Z),this.description=U(e,"Description",Z);let t=U(e,"DataInstances",Q),r=Object.keys(t);for(let o of r)try{this.dataInstances.set(o,vH(t[o],o,r))}catch(l){let c=`Failed to parse data instance ${JSON.stringify(o)}: ${l.message}`;console.log(c),this.errors.push(c)}let i=U(e,"DAG",Q),a=U(i,"Nodes",Q);for(let o of Object.keys(a))this.vnodes.add(o)}};function SH(n){try{let e=Ii(n,r=>new up(r)),t=new Map;for(let[r,i]of e){t.set(r,i);for(let a of i.vnodes)if(a!==r){let o=new up(i);t.set(a,o)}}for(let[r,i]of t)i.uuid=r;return t}catch(e){throw new Error(`Failed to parse DVID repositories info: ${e.message}`)}}var NI=class{constructor(e){this.repositories=SH(e)}getNode(e){let t=[];for(let r of this.repositories.keys())r.startsWith(e)&&t.push(r);if(t.length!==1)throw new Error(`Node key ${JSON.stringify(e)} matches ${JSON.stringify(t)} nodes.`);return this.repositories.get(t[0])}};function BI(n,e,t){return n.memoize.getUncounted({type:"dvid:getServerInfo",baseUrl:e},()=>{let r=AI(t,{url:`${e}/api/repos/info`,method:"GET",responseType:"json"}).then(a=>new NI(a)),i=`repository info for DVID server ${e}`;return Ee.forPromise(r,{initialMessage:`Retrieving ${i}.`,delay:!0,errorPrefix:`Error retrieving ${i}: `}),r})}var FI=class extends Bt{constructor(e,t,r,i,a,o){super(e);this.baseUrl=t;this.nodeKey=r;this.dataInstanceKey=i;this.info=a;this.credentialsProvider=o}get dataType(){return this.info.dataType}get volumeType(){return this.info.volumeType}get rank(){return 3}getSources(e){return this.info.getSources(this.chunkManager,{baseUrl:this.baseUrl,nodeKey:this.nodeKey,dataInstanceKey:this.dataInstanceKey},e,this.credentialsProvider)}},bH=/^((?:http|https):\/\/[^\/]+)\/([^\/]+)\/([^\/]+)(\?.*)?$/;function UI(n){if(n.startsWith("https"))return n+"/api/server/token"}function xH(n){let e=n.match(bH);if(e===null)throw new Error(`Invalid DVID URL: ${JSON.stringify(n)}.`);let t={baseUrl:e[1],nodeKey:e[2],dataInstanceKey:e[3]},r=e[4];if(r&&r.length>1){let i=si(r.substring(1));i.user&&(t.user=i.user)}return t.authServer=UI(t.baseUrl),t}function CH(n,e,t,r){let i=e.baseUrl,a=e.nodeKey,o=e.dataInstanceKey,l=t,c={lowerBounds:new Float64Array(l.lowerVoxelBound),upperBounds:Float64Array.from(l.upperVoxelBoundInclusive,g=>g+1)},d=Oe({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(l.voxelSize,g=>g/1e9),boundingBoxes:[Rn(c)]}),p=new FI(n.chunkManager,i,a,o,l,r),h={modelTransform:vt(d),subsources:[{id:"default",subsource:{volume:p},default:!0}]};if(l.meshSrc){let g=oe.create();for(let v=0;v<3;++v)g[5*v]=1/l.voxelSize[v];h.subsources.push({id:"meshes",default:!0,subsource:{mesh:n.chunkManager.getChunkSource(OI,{parameters:{...e,dataInstanceKey:l.meshSrc},credentialsProvider:r})},subsourceToModelSubspaceTransform:g})}return l.skeletonSrc&&h.subsources.push({id:"skeletons",default:!0,subsource:{mesh:n.chunkManager.getChunkSource(VI,{parameters:{...e,dataInstanceKey:l.skeletonSrc},credentialsProvider:r})}}),h.subsources.push({id:"bounds",subsource:{staticAnnotations:sn(c)},default:!0}),h}function wH(n){let e=xH(n.providerUrl),{baseUrl:t,nodeKey:r,dataInstanceKey:i}=e;return n.chunkManager.memoize.getUncounted({type:"dvid:MultiscaleVolumeChunkSource",baseUrl:t,nodeKey:r,dataInstanceKey:i},async()=>{let a=n.credentialsManager.getCredentialsProvider(rx,{dvidServer:e.baseUrl,authServer:e.authServer}),l=(await BI(n.chunkManager,t,a)).getNode(r);if(l===void 0)throw new Error(`Invalid node: ${JSON.stringify(r)}.`);let c=l.dataInstances.get(i);if(!(c instanceof cp))throw new Error(`Invalid data instance ${i}.`);return CH(n,e,c,a)})}function TH(n,e){return{offset:0,completions:cn(e,n.dataInstances.values(),t=>t.name,t=>`${t.base.typeName}`)}}function LH(n,e){let t=e.match(/^(?:([^\/]+)(?:\/([^\/]*))?)?$/);if(t===null)throw new Error("Invalid DVID URL syntax.");if(t[2]===void 0)return{offset:0,completions:cn(e,n.repositories.values(),a=>a.uuid+"/",a=>`${a.alias}: ${a.description}`)};let r=t[1],i=n.getNode(r);return _r(r.length+1,TH(i,t[2]))}async function kH(n){let e=/^((?:http|https):\/\/[^\/]+)\/([^\?]*).*$/,r=n.providerUrl.match(e);if(r===null)throw null;let i=r[1],a=r[2],o=UI(i),l=await BI(n.chunkManager,i,n.credentialsManager.getCredentialsProvider(rx,{dvidServer:i,authServer:o}));return _r(i.length+1,LH(l,a))}var ix=class extends Rt{constructor(e){super();this.credentialsManager=e}get description(){return"DVID"}get(e){return wH(e)}completeUrl(e){return kH(e)}};Ft("dvid",n=>new ix(n.credentialsManager));var GI=class{},WI=class extends GI{},Rm=class extends WI{};Rm.RPC_ID="render/TileChunkSource";var EH=new Set(["jpg","raw16"]),DH=nt(En,Rm),zI=class extends DH{},PH=new Set(["COMPLETE","READ_ONLY"]),IH=new Set(["LOADING"]);function AH(n){let e=ge(n,Q);if(e.length<1)throw new Error("No stacks found for owner object.");let t=new Map,r=U(e[0],"stackId",RH);for(let i of e){let a=U(i,"stackId",MH),o=_H(i);if(o!==void 0){let l=o.project,c=t.get(l);if(c===void 0){let d=new Map;t.set(l,{stacks:d}),c=t.get(l)}c.stacks.set(a,o)}}return{owner:r,projects:t}}function MH(n){return Q(n),U(n,"stack",Z)}function RH(n){return Q(n),U(n,"owner",Z)}function _H(n){Q(n);let e=U(n,"state",Z),t=[],r=K.create(),i=K.create();if(PH.has(e)){let l=U(n,"stats",Q);r=OH(l),i=VH(l),l.hasOwnProperty("channelNames")&&(t=NH(l))}else if(!IH.has(e))return;let a=U(n,"currentVersion",BH),o=U(n,"stackId",FH);return{lowerVoxelBound:r,upperVoxelBound:i,voxelResolution:a,project:o,channels:t}}function VH(n){Q(n);let e=U(n,"stackBounds",Q),t=K.create();return t[0]=U(e,"maxX",bn)+1,t[1]=U(e,"maxY",bn)+1,t[2]=U(e,"maxZ",bn)+1,t}function OH(n){Q(n);let e=U(n,"stackBounds",Q),t=K.create();return t[0]=U(e,"minX",bn),t[1]=U(e,"minY",bn),t[2]=U(e,"minZ",bn),t}function NH(n){return Q(n),U(n,"channelNames",e=>ge(e,Z))}function BH(n){Q(n);let e=K.create();try{e[0]=U(n,"stackResolutionX",bn),e[1]=U(n,"stackResolutionY",bn),e[2]=U(n,"stackResolutionZ",bn)}catch(t){e[0]=1,e[1]=1,e[2]=1}return e}function FH(n){return Q(n),U(n,"project",Z)}var HI=class extends Bt{constructor(e,t,r,i,a,o,l){super(e);this.baseUrl=t;this.ownerInfo=r;this.project=a;this.parameters=l;let c=r.projects.get(a);if(c===void 0)throw new Error(`Specified project ${JSON.stringify(a)} does not exist for specified owner ${JSON.stringify(r.owner)}`);if(i===void 0){let g=Array.from(c.stacks.keys());if(g.length!==1)throw new Error(`Dataset contains multiple stacks: ${JSON.stringify(g)}`);i=g[0]}let d=c.stacks.get(i);if(d===void 0)throw new Error(`Specified stack ${JSON.stringify(i)} is not one of the supported stacks: `+JSON.stringify(Array.from(c.stacks.keys())));this.stack=i,this.stackInfo=d,o!==void 0&&o.length>0&&(this.channel=o),this.minIntensity=oi(l.minIntensity),this.maxIntensity=oi(l.maxIntensity),this.maxTileSpecsToRender=oi(l.maxTileSpecsToRender),this.filter=PE(l.filter),this.minX=oi(l.minX),this.minY=oi(l.minY),this.minZ=oi(l.minZ),this.maxX=oi(l.maxX),this.maxY=oi(l.maxY),this.maxZ=oi(l.maxZ),this.minX!==void 0&&(d.lowerVoxelBound[0]=this.minX),this.minY!==void 0&&(d.lowerVoxelBound[1]=this.minY),this.minZ!==void 0&&(d.lowerVoxelBound[2]=this.minZ),this.maxX!==void 0&&(d.upperVoxelBound[0]=this.maxX),this.maxY!==void 0&&(d.upperVoxelBound[1]=this.maxY),this.maxZ!==void 0&&(d.upperVoxelBound[2]=this.maxZ);let p=Vt(l.encoding);if(p===void 0)p="jpg";else if(!EH.has(p))throw new Error(`Invalid encoding: ${JSON.stringify(p)}.`);this.encoding=p,this.numLevels=oi(l.numlevels),this.dims=K.create();let h=oi(l.tilesize);h===void 0&&(h=1024),this.dims[0]=h,this.dims[1]=h,this.dims[2]=1}get dataType(){return this.parameters.encoding==="raw16"?W.UINT16:W.UINT8}get volumeType(){return dt.IMAGE}get rank(){return 3}getSources(e){let t=[],r=this.numLevels;r===void 0&&(r=UH(this.stackInfo,this.dims[0]));let{lowerVoxelBound:i,upperVoxelBound:a}=this.stackInfo;for(let o=0;o<r;o++){let l=oe.create(),c=Uint32Array.of(1,1,1);for(let x=0;x<2;++x)l[5*x]=Math.pow(2,o),c[x]=this.dims[x];let d=K.create(),p=K.create(),h=K.create(),g=K.create();for(let x=0;x<3;x++){let C=l[5*x],T=h[x]=i[x]/C,P=g[x]=a[x]/C;d[x]=Math.floor(T),p[x]=Math.ceil(P)}let v=xm({rank:3,chunkDataSize:c,dataType:this.dataType,lowerVoxelBound:d,upperVoxelBound:p}),b=this.chunkManager.getChunkSource(zI,{spec:v,parameters:{baseUrl:this.baseUrl,owner:this.ownerInfo.owner,project:this.stackInfo.project,stack:this.stack,channel:this.channel,minIntensity:this.minIntensity,maxIntensity:this.maxIntensity,maxTileSpecsToRender:this.maxTileSpecsToRender,filter:this.filter,dims:`${this.dims[0]}_${this.dims[1]}`,level:o,encoding:this.encoding}});t.push([{chunkSource:b,chunkToMultiscaleTransform:l,lowerClipBound:h,upperClipBound:g}])}return Qn(t)}};function UH(n,e){let t=0;for(let i=0;i<2;i++)t=Math.max(t,n.upperVoxelBound[i]);if(e>=t)return 1;let r=0;for(;t>e;)t=t/2,r++;return r}function _m(n,e,t){return n.memoize.getUncounted({type:"render:getOwnerInfo",hostname:e,owner:t},()=>co(`${e}/render-ws/v1/owner/${t}/stacks`).then(r=>r.json()).then(AH))}var GH=/^([^\/?]+)(?:\/([^\/?]+))?(?:\/([^\/?]+))(?:\/([^\/?]*))?(?:\?(.*))?$/,$I=/^((?:(?:(?:http|https):\/\/[^,\/]+)[^\/?]))\/(.*)$/;function WH(n,e){let t,r;{let p=e.match($I);if(p===null)throw new Error(`Invalid render volume path: ${JSON.stringify(e)}`);t=p[1],r=p[2]}let i=r.match(GH);if(i===null)throw new Error(`Invalid volume path ${JSON.stringify(r)}`);let a=i[1],o=i[2],l=i[3],c=i[4],d=si(i[5]||"");return n.memoize.getUncounted({type:"render:MultiscaleVolumeChunkSource",hostname:t,path:r},async()=>{let p=await _m(n,t,a),h=new HI(n,t,p,l,o,c,d),g=Oe({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(h.stackInfo.voxelResolution,b=>b/1e9),boundingBoxes:[Rn({lowerBounds:new Float64Array(h.stackInfo.lowerVoxelBound),upperBounds:new Float64Array(h.stackInfo.upperVoxelBound)})]});return{modelTransform:vt(g),subsources:[{id:"default",default:!0,subsource:{volume:h}},{id:"bounds",default:!0,subsource:{staticAnnotations:sn(g.bounds)}}]}})}async function zH(n,e,t){let r=t.match(/^(?:([^\/]+)(?:\/([^\/]*))?(?:\/([^\/]*))?(\/.*?)?)?$/);if(r===null||r[2]===void 0)throw null;if(r[3]===void 0){let p=r[2]||"",h=await _m(n,e,r[1]),g=cn(p,h.projects,v=>v[0]+"/",()=>{});return{offset:r[1].length+1,completions:g}}if(r[4]===void 0){let p=r[3]||"",g=(await _m(n,e,r[1])).projects.get(r[2]);if(g===void 0)throw null;let v=cn(p,g.stacks,b=>b[0]+"/",b=>b[1].project);return{offset:r[1].length+r[2].length+2,completions:v}}let i=r[4].substr(1)||"",o=(await _m(n,e,r[1])).projects.get(r[2]);if(o===void 0)throw null;let l=o.stacks.get(r[3]);if(l===void 0)throw null;let c=l.channels;if(c.length===0)throw null;let d=cn(i,c,p=>p,()=>{});return{offset:r[1].length+r[2].length+r[3].length+3,completions:d}}async function HH(n,e){let t=n.match($I);if(t===null)throw null;let r=t[1],i=t[2],a=await zH(e,r,i);return _r(t[1].length+1,a)}var ax=class extends Rt{get description(){return"Render"}get(e){return WH(e.chunkManager,e.providerUrl)}completeUrl(e){return HH(e.providerUrl,e.chunkManager)}};Ft("render",()=>new ax);var dp;(function(a){a[a.RAW=0]="RAW",a[a.JPEG=1]="JPEG",a[a.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION",a[a.COMPRESSO=3]="COMPRESSO",a[a.PNG=4]="PNG"})(dp||(dp={}));var Vm=class{};Vm.RPC_ID="precomputed/VolumeChunkSource";var pp=class{};pp.RPC_ID="precomputed/MeshSource";var fs;(function(t){t[t.RAW=0]="RAW",t[t.GZIP=1]="GZIP"})(fs||(fs={}));var eu;(function(t){t[t.IDENTITY=0]="IDENTITY",t[t.MURMURHASH3_X86_128=1]="MURMURHASH3_X86_128"})(eu||(eu={}));var Om=class{};Om.RPC_ID="precomputed/MultiscaleMeshSource";var Nm=class{};Nm.RPC_ID="precomputed/SkeletonSource";var Bm=class{};Bm.RPC_ID="precomputed/AnnotationSpatialIndexSource";var Fm=class{};Fm.RPC_ID="precomputed/AnnotationSource";var Um=class{};Um.RPC_ID="precomputed/IndexedSegmentPropertySource";function jI(n,e){return e=Math.imul(e,3432918353)>>>0,e=(e<<15|e>>>17)>>>0,e=Math.imul(e,461845907)>>>0,n^=e,n=(n<<13|n>>>19)>>>0,n=Math.imul(n,5)+3864292196>>>0,n}function $H(n,e){return n^=e,n^=n>>>16,n=Math.imul(n,2246822507)>>>0,n^=n>>>13,n*=3266489909,n^=n>>>16,n>>>0}function ox(n,e,t){let r=n;return r=jI(r,e),r=jI(r,t),$H(r,8)}var sx=class extends Hn{constructor(e,t){super(e,t);this.properties=t.properties}static encodeOptions(e){return{properties:e.properties}}};function jH(n,e,t){let r=n.length-1;for(;;){if(e=e&r,n[e]===0){n[e]=t;return}++e}}function Gm(n,e){return e<=255?new Uint8Array(n):e<=65535?new Uint16Array(n):new Uint32Array(n)}function JH(n){let e=n.length/2,t=Math.ceil(Math.log2(e))+1,r=2**t,i=Gm(r,e+1);for(let a=0;a<e;++a){let o=n[2*a],l=n[2*a+1];jH(i,ox(0,o,l),a+1)}return i}function qH(n,e,t,r){let i=ox(0,t,r),a=n.length-1;for(;;){i=i&a;let o=n[i];if(o===0)return-1;if(--o,e[2*o]===t&&e[2*o+1]===r)return o;++i}}var Wm=class{constructor(e){this.inlineProperties=e.inlineProperties}},JI=class{constructor(e){this.segmentPropertyMap=e;var r;let{inlineProperties:t}=e;t!==void 0&&(this.inlineIdToIndex=JH(t.ids)),this.tags=t==null?void 0:t.properties.find(i=>i.type==="tags"),this.labels=t==null?void 0:t.properties.find(i=>i.type==="label"),this.numericalProperties=(r=t==null?void 0:t.properties.filter(i=>i.type==="number"))!=null?r:[]}getSegmentInlineIndex(e){let{inlineIdToIndex:t}=this;return t===void 0?-1:qH(t,this.segmentPropertyMap.inlineProperties.ids,e.low,e.high)}getSegmentLabel(e){let t=this.getSegmentInlineIndex(e);if(t===-1)return;let{labels:r,tags:i}=this,a="";if(r!==void 0&&(a=r.values[t]),i!==void 0){let{tags:o,values:l}=i,c=l[t];for(let d=0,p=c.length;d<p;++d){let h=o[c.charCodeAt(d)];a.length>0&&(a+=" "),a+="#",a+=h}}if(a.length!==0)return a}};function qI(n,e,t){for(let r=0,i=t.length;r<i;++r)e[t[r]]=n[r]}function YH(n){let e=n.length;if(e===0)return!0;let t=n[0],r=n[1];for(let i=0;i<e;i+=2){let a=n[i],o=n[i+1];if((o-r||a-t)<=0)return!1;t=a,r=o}return!0}function YI(n){let{ids:e}=n;if(YH(e))return n;let t=e.length/2,r=Gm(t,t-1);for(let o=0;o<t;++o)r[o]=o;r.sort((o,l)=>{let c=e[o*2],d=e[o*2+1],p=e[l*2],h=e[l*2+1];return d-h||c-p});let i=new Uint32Array(t*2);for(let o=0;o<t;++o){let l=r[o];i[o*2]=e[l*2],i[o*2+1]=e[l*2+1]}let a=n.properties.map(o=>{let{values:l}=o,c=new l.constructor(t);for(let d=0;d<t;++d)c[d]=l[r[d]];return{...o,values:c}});return{ids:i,properties:a}}function KH(n,e,t){let r=new Array(e);return r.fill(""),qI(n.values,r,t),{...n,values:r}}function XH(n,e,t){let r=new Float32Array(e);return r.fill(Number.NaN),qI(n.values,r,t),{...n,values:r}}function KI(n,e,t){let{type:r}=n;return r==="label"||r==="description"||r==="string"||r==="tags"?KH(n,e,t):XH(n,e,t)}function QH(n,e){if(n===void 0)return e;if(e===void 0)return n;let t=0,r=n.ids.length/2,i=e.ids.length/2,a=new Uint32Array(r),o=new Uint32Array(i),l=n.ids,c=e.ids;KL(r,i,(h,g)=>{let v=l[2*h+1],b=l[2*h],x=c[2*g+1],C=c[2*g];return v-x||b-C},h=>{a[h]=t,++t},h=>{o[h]=t,++t},(h,g)=>{a[h]=t,o[g]=t,++t});let d;if(t===r)d=l;else if(t===i)d=c;else{d=new Uint32Array(t*2);for(let h=0;h<r;++h){let g=a[h];d[2*g]=l[2*h],d[2*g+1]=l[2*h+1]}for(let h=0;h<i;++h){let g=o[h];d[2*g]=c[2*h],d[2*g+1]=c[2*h+1]}}let p=[];if(t===r)p.push(...n.properties);else for(let h of n.properties)p.push(KI(h,t,a));if(t===i)p.push(...e.properties);else for(let h of e.properties)p.push(KI(h,t,o));return{ids:d,properties:p}}function ZH(n,e){return new Wm({inlineProperties:QH(n.inlineProperties,e.inlineProperties)})}function e$(n){for(;;){if(n.length===0)return;if(n.length===1)return n[0];let e=[];for(let t=0,r=n.length;t<r;t+=2)t+1===r?e.push(n[t]):e.push(ZH(n[t],n[t+1]));n=e}}function XI(n,e){return n.memoize.getUncounted({id:"getPreprocessedSegmentPropertyMap",maps:e.map(t=>lt(t))},()=>{let t=e$(e);if(t!==void 0)return new JI(t)})}var t$=/^[,\s]*[0-9]+(?:[,\s]+[0-9]+)*[,\s]*$/;function QI(n,e){var p;if(e.match(t$)!==null){let h=e.split(/[\s,]+/),g=[],v=new Set;for(let b=0,x=h.length;b<x;++b){let C=h[b];if(C==="")continue;let T=new X;if(!T.tryParseString(C))continue;let P=T.toString();v.has(P)||(v.add(P),g.push(T))}return g.sort(X.compare),{ids:g}}let t={regexp:void 0,prefix:void 0,includeTags:[],excludeTags:[],numericalConstraints:[],sortBy:[],includeColumns:[]},r=(p=n==null?void 0:n.segmentPropertyMap.inlineProperties)==null?void 0:p.properties,i=n==null?void 0:n.tags,a=(i==null?void 0:i.tags)||[],o=a.map(h=>h.toLowerCase()),l=n==null?void 0:n.labels,c=[],d;for(let h=0;h<e.length;h=d){let g=e.indexOf(" ",h),v;if(g===-1?d=g=e.length:d=g+1,v=e.substring(h,g),v.length===0)continue;let b=(C,T)=>{let P=C.toLowerCase(),I=o.indexOf(P);if(I===-1){c.push({begin:T,end:g,message:`Invalid tag: ${C}`});return}if(C=a[I],t.includeTags.includes(C)||t.excludeTags.includes(C)){c.push({begin:T,end:g,message:`Duplicate tag: ${C}`});return}return C};if(v.startsWith("#")){let C=b(v.substring(1),h+1);C!==void 0&&t.includeTags.push(C);continue}if(v.startsWith("-#")){let C=b(v.substring(2),h+2);C!==void 0&&t.excludeTags.push(C);continue}if(v.startsWith("<")||v.startsWith(">")){let C=v.substring(1).toLowerCase();if(C!=="id"&&C!=="label"){let T=r==null?void 0:r.find(P=>P.id.toLowerCase()===C&&(P.type==="number"||P.type==="label"||P.type==="string"));if(T===void 0){c.push({begin:h+1,end:g,message:`Invalid field: ${C}`});continue}C=T.id}if(t.sortBy.find(T=>T.fieldId===C)!==void 0){c.push({begin:h+1,end:g,message:`Duplicate sort field: ${C}`});continue}t.sortBy.push({order:v[0],fieldId:C});continue}if(v.startsWith("|")){let C=v.substring(1).toLowerCase();if(C==="id"||C==="label")continue;let T=r==null?void 0:r.find(P=>P.id.toLowerCase()===C&&(P.type==="number"||P.type==="string"));if(T===void 0){c.push({begin:h+1,end:g,message:`Invalid field: ${C}`});continue}if(C=T.id,t.sortBy.find(P=>P.fieldId===C)||t.includeColumns.find(P=>P===C))continue;t.includeColumns.push(C);continue}if(v.startsWith("/")){if(t.regexp!==void 0){c.push({begin:h,end:g,message:"Only one regular expression allowed"});continue}if(t.prefix!==void 0){c.push({begin:h,end:g,message:"Prefix cannot be combined with regular expression"});continue}if(l===void 0){c.push({begin:h,end:g,message:"No label property"});continue}try{t.regexp=new RegExp(v.substring(1))}catch(C){c.push({begin:h,end:g,message:"Invalid regular expression syntax"})}continue}let x=v.match(/^([a-zA-Z][a-zA-Z0-9_]*)(<|<=|=|>=|>)([0-9.].*)$/);if(x!==null){let C=x[1].toLowerCase(),T=x[2],P=n==null?void 0:n.numericalProperties.find(B=>B.id.toLowerCase()===C);if(P===void 0){c.push({begin:h,end:h+C.length,message:`Invalid numerical field: ${C}`});continue}C=P.id;let I;try{I=Ya(P.dataType,x[3])}catch(B){c.push({begin:h+x[1].length+x[2].length,end:g,message:B.message});continue}let M=t.numericalConstraints.find(B=>B.fieldId===C);M===void 0&&(M={fieldId:C,bounds:P.bounds},t.numericalConstraints.push(M));let D=Js(P.bounds,M.bounds[0]),E=Js(P.bounds,M.bounds[1]),V=E,O=D;switch(T){case"<":V=wd(P.dataType,I,-1);break;case"<=":V=I;break;case"=":V=O=I;break;case">=":O=I;break;case">":O=wd(P.dataType,I,1);break}if(O=mr(D,O)>0?D:O,V=mr(E,V)<0?E:V,mr(O,V)>0){c.push({begin:h,end:g,message:"Constraint would not match any values"});continue}M.bounds=[O,V];continue}if(t.regexp!==void 0){c.push({begin:h,end:g,message:"Prefix cannot be combined with regular expression"});continue}if(l===void 0){c.push({begin:h,end:g,message:"No label property"});continue}t.prefix!==void 0?t.prefix+=` ${v}`:t.prefix=v}return c.length>0?{errors:c}:(t.sortBy.length===0&&t.sortBy.push({fieldId:tA(n),order:"<"}),t)}function lx(n){return"\\u"+n.toString(16).padStart(4,"0")}function ZI(n,e){var T;if(e.errors!==void 0)return{query:e,total:-1,count:0,errors:e.errors};if(e.ids!==void 0){let{ids:P}=e;return{query:e,total:-1,explicitIds:P,count:P.length}}let t=(T=n==null?void 0:n.segmentPropertyMap)==null?void 0:T.inlineProperties;if(t===void 0)return{query:e,count:0,total:-1};let r=t==null?void 0:t.properties,i=t.ids.length/2,a=Gm(i,i);for(let P=0;P<i;++P)a[P]=P;let o=P=>{let I=a.length,M=0;for(let D=0;D<I;++D){let E=a[D];P(E)&&(a[M]=E,++M)}a=a.subarray(0,M)};if(e.regexp!==void 0||e.prefix!==void 0){let P=n.labels.values,{regexp:I,prefix:M}=e;I!==void 0&&o(D=>P[D].match(I)!==null),M!==void 0&&o(D=>P[D].startsWith(M))}let{includeTags:l,excludeTags:c}=e,d=n.tags;if(l.length>0||c.length>0){let{values:P,tags:I}=d,M=[];for(let B of l)M.push([I.indexOf(B),1]);for(let B of c)M.push([I.indexOf(B),0]);M.sort((B,z)=>B[0]-z[0]);let D="^",E=0,V=B=>{B<E||(D+=`[${lx(E)}-${lx(B)}]*`)};for(let[B,z]of M)V(B-1),z&&(D+=lx(B)),E=B+1;V(65535),D+="$";let O=new RegExp(D);o(B=>P[B].match(O)!==null)}let p,h,{numericalConstraints:g}=e;if(g.length>0){let P=n.numericalProperties,I=g.length,M=2**I-1;p=Gm(a.length,M);for(let V=0;V<I;++V){let O=g[V],B=P.find(J=>J.id===O.fieldId),{values:z}=B,_=2**V,[F,N]=O.bounds;for(let J=0,ae=a.length;J<ae;++J){let pe=z[a[J]];p[J]|=_*(pe>=F&&pe<=N)}}h=a,a=h.slice();let D=a.length,E=0;for(let V=0;V<D;++V)p[V]===M&&(a[E]=a[V],++E);a=a.subarray(0,E)}let v=[];if(d!==void 0){let P=[],{tags:I,values:M}=d,D=new Uint32Array(I.length);for(let E=0,V=a.length;E<V;++E){let O=M[a[E]];for(let B=0,z=O.length;B<z;++B)++D[O.charCodeAt(B)]}for(let E=0,V=I.length;E<V;++E){let O=D[E],B=I[E],z={tag:B,tagIndex:E,count:D[E]};e.includeTags.includes(B)||e.excludeTags.includes(B)?P.push(z):O>0&&v.push(z)}P.push(...v),v=P}let b=(P,I)=>{if(P.type!=="number"){let{values:M}=P;a.sort((D,E)=>lo(M[D],M[E])*I)}else{let M=P.values;a.sort((D,E)=>(M[D]-M[E])*I)}},x=P=>{d!==void 0&&b(d,P);let I=n==null?void 0:n.labels;I!==void 0&&b(I,P)},{sortBy:C}=e;for(let P=C.length-1;P>=0;--P){let{fieldId:I,order:M}=C[P],D=M==="<"?1:-1;if(I==="id"){if(P+1===C.length){if(M==="<")continue;a.reverse();continue}a.sort((E,V)=>D*(E-V));continue}else I==="label"?x(D):b(r.find(E=>E.id===I),D)}return{query:e,intermediateIndices:h,intermediateIndicesMask:p,indices:a,tags:v,count:a.length,total:i}}function n$(n,e,t){let r=256,{values:i}=e,[a,o]=t,l=o<=a?0:r/(o-a),c=new Uint32Array(r+2),{numericalConstraints:d}=n.query,p=d.findIndex(h=>h.fieldId===e.id);if(p===-1){let h=n.indices;for(let g=0,v=h.length;g<v;++g){let b=i[h[g]];isNaN(b)||++c[Math.min(r-1,Math.max(-1,(b-a)*l))+1>>>0]}}else{let h=n.intermediateIndices,g=n.intermediateIndicesMask,v=2**d.length-1-2**p;for(let b=0,x=h.length;b<x;++b)if((g[b]&v)==v){let T=i[h[b]];isNaN(T)||++c[Math.min(r-1,Math.max(-1,(T-a)*l))+1>>>0]}}return{queryResult:n,histogram:c,window:t}}function eA(n,e,t,r){if(n===void 0){t.length=0,r.length=0;return}let{numericalProperties:i}=n,a=i.length;if((e==null?void 0:e.indices)===void 0){t.length=0;return}for(let l=0;l<a;++l){let c=t[l],d=r[l],p=i[l];c!==void 0&&c.queryResult===e&&li(p.dataType,c.window,d)||(t[l]=n$(e,p,d))}}function tA(n){return(n==null?void 0:n.tags)||(n==null?void 0:n.labels)?"label":"id"}function nA(n,e){let{ids:t}=e;if(t!==void 0)return t.map(l=>l.toString()).join(", ");let r="";e=e;let{prefix:i,regexp:a}=e;i!==void 0?r=i:a!==void 0&&(r=`/${a}`);for(let l of e.includeTags)r.length>0&&(r+=" "),r+=`#${l}`;for(let l of e.excludeTags)r.length>0&&(r+=" "),r+=`-#${l}`;for(let l of e.numericalConstraints){let{fieldId:c,bounds:d}=l,[p,h]=d,g=n.numericalProperties.find(v=>v.id===c);if(!li(g.dataType,g.bounds,d)){if(mr(p,h)===0){r.length>0&&(r+=" "),r+=`${c}=${p}`;continue}if(mr(p,g.bounds[0])>0){r.length>0&&(r+=" ");let v=wd(g.dataType,p,-1),b=p.toString(),x=v.toString();g.dataType!==W.FLOAT32||b.length<=x.length?r+=`${c}>=${b}`:r+=`${c}>${x}`}if(mr(h,g.bounds[1])<0){r.length>0&&(r+=" ");let v=wd(g.dataType,h,1),b=h.toString(),x=v.toString();g.dataType!==W.FLOAT32||b.length<=x.length?r+=`${c}<=${b}`:r+=`${c}<${x}`}}}let{sortBy:o}=e;if(o.length===1){let l=o[0];l.order==="<"&&l.fieldId===tA(n)&&(o=[])}for(let l of o)r.length>0&&(r+=" "),r+=`${l.order}${l.fieldId}`;for(let l of e.includeColumns)r.length>0&&(r+=" "),r+=`|${l}`;return r}var cx=new X;function fp(n,e,t){if(e===void 0)return;let{explicitIds:r}=e;if(r!==void 0){r.forEach(t);return}let{indices:i}=e;if(i!==void 0){let{ids:a}=n==null?void 0:n.segmentPropertyMap.inlineProperties;for(let o=0,l=i.length;o<l;++o){let c=i[o];cx.low=a[c*2],cx.high=a[c*2+1],t(cx,o)}}}function rA(n,e,t){if(t.size===0)return 0;let r=0;return fp(n,e,i=>{t.has(i)&&++r}),r}function ux(n,e,t,r){let i=n.includeTags.filter(o=>o!==e),a=n.excludeTags.filter(o=>o!==e);return r===!0&&(t?i:a).push(e),{...n,includeTags:i,excludeTags:a}}function iA(n){return n.ids!==void 0?!1:n.errors!==void 0?!0:!(n.numericalConstraints.length>0||n.includeTags.length>0||n.excludeTags.length>0||n.prefix||n.regexp)}function zm(n,e){if(n===void 0||n.ids!==void 0||n.errors!==void 0)return!1;let{sortBy:t,includeColumns:r}=n;return t.find(i=>i.fieldId===e)!==void 0||r.includes(e)}async function r$(n,e,t,r,i){let a=await ka(n,`https://www.googleapis.com/storage/v1/b/${e}/o?delimiter=${encodeURIComponent(r)}&prefix=${encodeURIComponent(t)}&neuroglancerOrigin=${encodeURIComponent(location.origin)}`,{},kt,i);Q(a);let o=ie(a,"prefixes",on,[]),l=ie(a,"items",c=>ge(c,d=>(Q(d),U(d,"name",Z))),[]).filter(c=>!c.endsWith("_$folder$"));return[...o,...l]}async function aA(n,e,t,r,i){if(!r.startsWith("/"))throw null;let o=await r$(n,t,r.substring(1),"/",i),l=r.lastIndexOf("/");return{offset:l+e.length+1,completions:o.map(c=>({value:c.substring(l)}))}}async function i$(n,e,t,r,i){let a=await ka(n,`${e}?prefix=${encodeURIComponent(t)}&delimiter=${encodeURIComponent(r)}`,{},p=>p.text(),i),o=new DOMParser().parseFromString(a,"application/xml"),l=o.evaluate('//*[name()="CommonPrefixes"]/*[name()="Prefix"]',o,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),c=[];for(let p=0,h=l.snapshotLength;p<h;++p)c.push(l.snapshotItem(p).textContent||"");let d=o.evaluate('//*[name()="Contents"]/*[name()="Key"]',o,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null);for(let p=0,h=d.snapshotLength;p<h;++p)c.push(d.snapshotItem(p).textContent||"");return c}async function hp(n,e,t,r,i){if(!r.startsWith("/"))throw null;let o=await i$(n,t,r.substring(1),"/",i),l=r.lastIndexOf("/");return{offset:l+e.length+1,completions:o.map(c=>({value:c.substring(l)}))}}async function oA(n,e,t,r,i=St){return await uo(`https://${n}.s3.amazonaws.com${e}`,t,r,i)}async function sA(n,e,t){return await hp(void 0,`s3://${n}`,`https://${n}.s3.amazonaws.com`,e,t)}function a$(n,e){return n.getCredentialsProvider("middleauthapp",new URL(e).origin)}function Hm(n,e,t){let r=/^\/([^\/]+)/,i=t.match(r);if(i!==null)return n.getCredentialsProvider("gcs",{bucket:i[1]})}function Dn(n,e){let t=gl(n);switch(t.protocol){case"gs":case"gs+xml":return{credentialsProvider:e.getCredentialsProvider("gcs",{bucket:t.host}),url:n};case"gs+ngauth+http":return{credentialsProvider:Hm(e,`http://${t.host}`,t.path),url:"gs:/"+t.path};case"gs+ngauth+https":return{credentialsProvider:Hm(e,`https://${t.host}`,t.path),url:"gs:/"+t.path};case"gs+xml+ngauth+http":return{credentialsProvider:Hm(e,`http://${t.host}`,t.path),url:"gs+xml:/"+t.path};case"gs+xml+ngauth+https":return{credentialsProvider:Hm(e,`https://${t.host}`,t.path),url:"gs+xml:/"+t.path};case"middleauth+https":return n=n.substr("middleauth+".length),{credentialsProvider:a$(e,n),url:n};case"s3":return{credentialsProvider:void 0,url:n};default:return{credentialsProvider:void 0,url:n}}}async function On(n,e,t,r,i=St){let a=gl(e);switch(a.protocol){case"gs":return ka(n,`https://www.googleapis.com/storage/v1/b/${a.host}/o/${encodeURIComponent(a.path.substring(1))}?alt=media&neuroglancer=${Ks()}`,t,r,i);case"gs+xml":return ka(n,`https://storage.googleapis.com/${a.host}${a.path}?neuroglancer=${Ks()}`,t,r,i);case"s3":return oA(a.host,a.path,t,r,i);default:return ka(n,e,t,r,i)}}async function o$(n,e,t){let{text:r,contentType:i}=await On(t,n,{headers:{accept:"text/html"}},async c=>({text:await c.text(),contentType:c.headers.get("content-type")}),e);if(i===null||/\btext\/html\b/i.exec(i)===null)return[];let a=new DOMParser().parseFromString(r,"text/html"),o=a.evaluate("//a/@href",a,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),l=[];for(let c=0,d=o.snapshotLength;c<d;++c){let h=o.snapshotItem(c).textContent;h&&l.push(new URL(h,n).toString())}return l}async function s$(n,e,t){console.log("getHtmlPathCompletions");let r=n.match(/^([a-z]+:\/\/.*\/)([^\/?#]*)$/);if(r===null)throw null;let i=await o$(r[1],e,t),a=r[1].length,o=[];for(let l of i)!l.startsWith(n)||o.push({value:l.substring(a)});return{offset:a,completions:o}}var l$=[{value:"gs://",description:"Google Cloud Storage (JSON API)"},{value:"gs+xml://",description:"Google Cloud Storage (XML API)"},{value:"gs+ngauth+http://",description:"Google Cloud Storage (JSON API) authenticated via ngauth"},{value:"gs+ngauth+https://",description:"Google Cloud Storage (JSON API) authenticated via ngauth"},{value:"gs+xml+ngauth+http://",description:"Google Cloud Storage (XML API) authenticated via ngauth"},{value:"gs+xml+ngauth+https://",description:"Google Cloud Storage (XML API) authenticated via ngauth"},{value:"s3://",description:"Amazon Simple Storage Service (S3)"},{value:"https://"},{value:"http://"}];async function vi(n,e,t){if(!e.includes("://"))return{offset:0,completions:cn(e,l$,h=>h.value,h=>h.description)};let{url:r,credentialsProvider:i}=Dn(e,n),a=e.length-r.length,o;try{o=gl(r)}catch{throw null}let{protocol:l,host:c,path:d}=o,p=await(async()=>{if(l==="gs+xml"&&d.length>0)return await hp(i,`${l}://${c}`,`https://storage.googleapis.com/${c}`,d,t);if(l==="gs"&&d.length>0)return await aA(i,`${l}://${c}`,c,d,t);if(l==="s3"&&d.length>0)return await sA(c,d,t);let h=r.match(/^((?:http|https):\/\/(?:storage\.googleapis\.com\/[^\/]+|[^\/]+\.storage\.googleapis\.com|[^\/]+\.s3(?:[^./]+)?\.amazonaws.com))(\/.*)$/);if(h!==null)return await hp(i,h[1],h[1],h[2],t);if((l==="http"||l==="https")&&d.length>0)return await s$(r,t,i);throw null})();return{offset:a+p.offset,completions:p.completions}}var lA=class extends nt(ut()(En),Vm){},cA=class extends nt(ut()(Vn),pp){},uA=class extends nt(ut()(Vn),pp){},dA=class extends nt(ut()(fo),Om){},pA=class extends nt(ut()(Ji),Nm){get skeletonVertexCoordinatesInVoxels(){return!1}get vertexAttributes(){return this.parameters.metadata.vertexAttributes}};function Aa(n,e){let t=n.split("/");for(let r of e.split("/")){if(r===".."&&t.length!==0){t.length=t.length-1;continue}t.push(r)}return t.join("/")}var fA=class{constructor(e,t){Q(e);let r=t===1?3:4,i=this.resolution=new Float64Array(r),a=this.voxelOffset=new Float32Array(r),o=this.size=new Float32Array(r);if(r===4&&(i[3]=1,o[3]=t),U(e,"resolution",c=>Pe(i.subarray(0,3),c,ot)),ie(e,"voxel_offset",c=>Pe(a.subarray(0,3),c,ze)),U(e,"size",c=>Pe(o.subarray(0,3),c,ct)),this.chunkSizes=U(e,"chunk_sizes",c=>ge(c,d=>{let p=new Uint32Array(r);return r===4&&(p[3]=t),Pe(p.subarray(0,3),d,ct),p})),this.chunkSizes.length===0)throw new Error("No chunk sizes specified.");if(this.sharding=U(e,"sharding",jm),this.sharding!==void 0&&this.chunkSizes.length!==1)throw new Error("Sharding requires a single chunk size per scale");(this.encoding=U(e,"encoding",c=>yt(c,dp)))===dp.COMPRESSED_SEGMENTATION&&(this.compressedSegmentationBlockSize=U(e,"compressed_segmentation_block_size",c=>Pe(K.create(),c,ct))),this.key=U(e,"key",Z)}};function dx(n){Q(n);let e=U(n,"data_type",T=>yt(T,W)),t=U(n,"num_channels",ct),r=U(n,"type",T=>yt(T,dt)),i=U(n,"mesh",Vt),a=U(n,"skeletons",Vt),o=U(n,"segment_properties",Vt),l=U(n,"scales",T=>ge(T,P=>new fA(P,t)));if(l.length===0)throw new Error("Expected at least one scale");let c=l[0],d=t===1?3:4,p=new Float64Array(d),h=new Float64Array(d),g=new Float64Array(d),v=["x","y","z"],b=["m","m","m"];for(let T=0;T<3;++T)p[T]=c.resolution[T]/1e9,h[T]=c.voxelOffset[T],g[T]=h[T]+c.size[T];d===4&&(p[3]=1,g[3]=t,v[3]="c^",b[3]="");let C=Oe({rank:d,names:v,units:b,scales:p,boundingBoxes:[Rn({lowerBounds:h,upperBounds:g})]});return{dataType:e,volumeType:r,mesh:i,skeletons:a,segmentPropertyMap:o,scales:l,modelSpace:C}}var $m=class extends Bt{constructor(e,t,r,i){super(e);this.credentialsProvider=t;this.url=r;this.info=i}get dataType(){return this.info.dataType}get volumeType(){return this.info.volumeType}get rank(){return this.info.modelSpace.rank}getSources(e){let t=this.info.scales[0].resolution,{rank:r}=this;return Qn(this.info.scales.map(i=>{let{resolution:a}=i,o=r+1,l=new Float32Array(o*o);l[l.length-1]=1;let{lowerBounds:c,upperBounds:d}=this.info.modelSpace.boundingBoxes[0].box,p=new Float32Array(r),h=new Float32Array(r);for(let g=0;g<3;++g){let v=a[g]/t[g];l[o*g+g]=v;let b=i.voxelOffset[g];l[o*r+g]=b*v,p[g]=c[g]/v-b,h[g]=d[g]/v-b}return r===4&&(l[o*3+3]=1,p[3]=c[3],h[3]=d[3]),Nr({rank:r,dataType:this.dataType,chunkToMultiscaleTransform:l,upperVoxelBound:i.size,volumeType:this.volumeType,chunkDataSizes:i.chunkSizes,baseVoxelOffset:i.voxelOffset,compressedSegmentationBlockSize:i.compressedSegmentationBlockSize,volumeSourceOptions:e}).map(g=>({chunkSource:this.chunkManager.getChunkSource(lA,{credentialsProvider:this.credentialsProvider,spec:g,parameters:{url:Aa(this.url,i.key),encoding:i.encoding,sharding:i.sharding}}),chunkToMultiscaleTransform:l,lowerClipBound:p,upperClipBound:h}))}))}},c$=nt(ut()(Wi),Fm),hA=class extends nt(ut()(ml),Bm){},mA=class extends c${constructor(e,t){let{parameters:r}=t;super(e,{rank:r.rank,relationships:r.relationships.map(i=>i.name),properties:r.properties,parameters:r});this.readonly=!0,this.metadata=t.metadata,this.credentialsProvider=t.credentialsProvider}getSources(){return[this.metadata.spatialIndices.map(e=>{let{spec:t}=e;return{chunkSource:this.chunkManager.getChunkSource(hA,{credentialsProvider:this.credentialsProvider,parent:this,spec:t,parameters:e.parameters}),chunkToMultiscaleTransform:t.chunkToMultiscaleTransform}})]}};function u$(n,e,t){return n.getChunkSource(cA,{parameters:t,credentialsProvider:e})}function d$(n,e,t){return n.getChunkSource(uA,{parameters:t,credentialsProvider:e})}function px(n){return U(n,"transform",e=>{let t=oe.create();return e!==void 0&&Pe(t.subarray(0,12),e,Ke),oe.transpose(t,t),t})}function p$(n){Q(n);let e=U(n,"@type",Z),t;if(e==="neuroglancer_legacy_mesh")t=void 0;else if(e==="neuroglancer_legacy_mesh_hierarchical"){let a=U(n,"hierarchy_size",ct),o=0,l=px(n);t={lodScaleMultiplier:o,transform:l,sharding:void 0,vertexQuantizationBits:a}}else{if(e!=="neuroglancer_multilod_draco")throw new Error(`Unsupported mesh type: ${JSON.stringify(e)}`);{let i=U(n,"lod_scale_multiplier",ot),a=U(n,"vertex_quantization_bits",ct),o=px(n),l=U(n,"sharding",jm);t={lodScaleMultiplier:i,transform:o,sharding:l,vertexQuantizationBits:a}}}let r=U(n,"segment_properties",Vt);return{metadata:t,segmentPropertyMap:r}}async function f$(n,e,t){let r;try{r=await tu(n,e,t)}catch(i){if(zi(i))return{metadata:void 0};throw i}return p$(r)}function gA(n){return n===void 0?fs.RAW:yt(n,fs)}function jm(n){if(n===void 0)return;Q(n);let e=U(n,"@type",Z);if(e!=="neuroglancer_uint64_sharded_v1")throw new Error(`Unsupported sharding format: ${JSON.stringify(e)}`);let t=U(n,"hash",c=>yt(c,eu)),r=U(n,"preshift_bits",ze),i=U(n,"shard_bits",ze),a=U(n,"minishard_bits",ze),o=U(n,"minishard_index_encoding",gA),l=U(n,"data_encoding",gA);return{hash:t,preshiftBits:r,shardBits:i,minishardBits:a,minishardIndexEncoding:o,dataEncoding:l}}function h$(n){Q(n);let e=U(n,"@type",Z);if(e!=="neuroglancer_skeletons")throw new Error(`Unsupported skeleton type: ${JSON.stringify(e)}`);let t=px(n),r=new Map;U(n,"vertex_attributes",o=>{o!==void 0&&ge(o,l=>{Q(l);let c=U(l,"id",Z);if(c==="")throw new Error("vertex attribute id must not be empty");if(r.has(c))throw new Error(`duplicate vertex attribute id ${JSON.stringify(c)}`);let d=U(l,"data_type",h=>yt(h,W)),p=U(l,"num_components",ct);r.set(c,{dataType:d,numComponents:p})})});let i=U(n,"sharding",jm),a=U(n,"segment_properties",Vt);return{metadata:{transform:t,vertexAttributes:r,sharding:i},segmentPropertyMap:a}}async function m$(n,e,t){let r=await tu(n,e,t);return h$(r)}function yA(){return Oe({names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)})}async function vA(n,e,t){let{metadata:r,segmentPropertyMap:i}=await f$(n,e,t);if(r===void 0)return{source:u$(n,e,{url:t,lod:0}),transform:oe.create(),segmentPropertyMap:i};let{vertexQuantizationBits:a}=r;if(a>100)return console.log(r.transform),{source:d$(n,e,{url:t,lod:a}),transform:r.transform,segmentPropertyMap:i};let o;if(a===10)o=fi.uint10;else if(a===16)o=fi.uint16;else throw new Error(`Invalid vertex quantization bits: ${a}`);return{source:n.getChunkSource(dA,{credentialsProvider:e,parameters:{url:t,metadata:r},format:{fragmentRelativeVertices:!0,vertexPositionFormat:o}}),transform:r.transform,segmentPropertyMap:i}}async function SA(n,e,t){let{metadata:r,segmentPropertyMap:i}=await m$(n,e,t);return{source:n.getChunkSource(pA,{credentialsProvider:e,parameters:{url:t,metadata:r}}),transform:r.transform,segmentPropertyMap:i}}function tu(n,e,t){return n.memoize.getUncounted({type:"precomputed:metadata",url:t,credentialsProvider:lt(e)},async()=>await On(e,`${t}/info`,{},kt))}function bA(n){let e=oe.create(),t=n.scales[0].resolution;for(let r=0;r<3;++r)e[5*r]=1/t[r];return e}async function g$(n,e,t,r){let i=dx(r),a=new $m(n.chunkManager,e,t,i),{modelSpace:o}=i,l=[{id:"default",default:!0,subsource:{volume:a}},{id:"bounds",default:!0,subsource:{staticAnnotations:sn(o.bounds)}}];if(i.segmentPropertyMap!==void 0){let c=Aa(t,i.segmentPropertyMap),d=await tu(n.chunkManager,e,c),p=nu(n.chunkManager,e,d,c);l.push({id:"properties",default:!0,subsource:{segmentPropertyMap:p}})}if(i.mesh!==void 0){let c=Aa(t,i.mesh),{source:d,transform:p}=await vA(n.chunkManager,e,c),h=bA(i);oe.multiply(h,h,p),l.push({id:"mesh",default:!0,subsource:{mesh:d},subsourceToModelSubspaceTransform:h})}if(i.skeletons!==void 0){let c=Aa(t,i.skeletons),{source:d,transform:p}=await SA(n.chunkManager,e,c),h=bA(i);oe.multiply(h,h,p),l.push({id:"skeletons",default:!0,subsource:{mesh:d},subsourceToModelSubspaceTransform:h})}return{modelTransform:vt(o),subsources:l}}async function y$(n,e,t){let{source:r,transform:i,segmentPropertyMap:a}=await SA(n.chunkManager,e,t),o=[{id:"default",default:!0,subsource:{mesh:r},subsourceToModelSubspaceTransform:i}];if(a!==void 0){let l=Aa(t,a),c=await tu(n.chunkManager,e,l),d=nu(n.chunkManager,e,c,l);o.push({id:"properties",default:!0,subsource:{segmentPropertyMap:d}})}return{modelTransform:vt(yA()),subsources:o}}function fx(n,e){return Q(e),{url:Aa(n,U(e,"key",Z)),sharding:U(e,"sharding",jm)}}var xA=class{constructor(e,t){this.url=e;Q(t);let r=U(t,"dimensions",Qs),{rank:i}=r,a=U(t,"lower_bound",l=>Pe(new Float64Array(i),l,Ke)),o=U(t,"upper_bound",l=>Pe(new Float64Array(i),l,Ke));this.coordinateSpace=Oe({rank:i,names:r.names,units:r.units,scales:r.scales,boundingBoxes:[Rn({lowerBounds:a,upperBounds:o})]}),this.parameters={type:U(t,"annotation_type",l=>yt(l,Be)),rank:i,relationships:U(t,"relationships",l=>ge(l,c=>{let d=fx(e,c),p=U(c,"id",Z);return{...d,name:p}})),properties:U(t,"properties",dh),byId:U(t,"by_id",l=>fx(e,l))},this.spatialIndices=U(t,"spatial",l=>ge(l,c=>{let d=fx(e,c),p=U(c,"grid_shape",C=>Pe(new Float32Array(i),C,ct)),h=U(c,"chunk_size",C=>Pe(new Float32Array(i),C,ot)),g=U(c,"limit",ct),v=new Float32Array(i);for(let C=0;C<i;++C)v[C]=p[C]*h[C];let b=Yt(Float32Array,i+1);for(let C=0;C<i;++C)b[(i+1)*i+C]=a[C];let x={limit:g,chunkToMultiscaleTransform:b,...$o({rank:i,chunkDataSize:h,upperVoxelBound:v})};return x.upperChunkBound=p,{parameters:d,spec:x,limit:g}})),this.spatialIndices.reverse()}};async function v$(n,e,t,r){let i=new xA(t,r);return{modelTransform:vt(i.coordinateSpace),subsources:[{id:"default",default:!0,subsource:{annotation:n.chunkManager.getChunkSource(mA,{credentialsProvider:e,metadata:i,parameters:i.parameters})}}]}}async function CA(n,e,t){let{source:r,transform:i,segmentPropertyMap:a}=await vA(n.chunkManager,e,t),o=[{id:"default",default:!0,subsource:{mesh:r},subsourceToModelSubspaceTransform:i}];if(a!==void 0){let l=Aa(t,a),c=await tu(n.chunkManager,e,l),d=nu(n.chunkManager,e,c,l);o.push({id:"properties",default:!0,subsource:{segmentPropertyMap:d}})}return{modelTransform:vt(yA()),subsources:o}}function S$(n){Q(n);let e=new X,t=U(n,"ids",a=>{a=on(a);let o=a.length,l=new Uint32Array(o*2);for(let c=0;c<o;++c){if(!e.tryParseString(a[c]))throw new Error(`Invalid uint64 id: ${JSON.stringify(a[c])}`);l[2*c]=e.low,l[2*c+1]=e.high}return l}),r=t.length/2,i=U(n,"properties",a=>ge(a,o=>{Q(o);let l=U(o,"id",Z),c=ie(o,"description",Z),d=U(o,"type",h=>{if(h!=="label"&&h!=="description"&&h!=="string"&&h!=="tags"&&h!=="number")throw new Error(`Invalid property type: ${JSON.stringify(h)}`);return h});if(d==="tags"){let h=U(o,"tags",on),g=ie(o,"tag_descriptions",on);if(g===void 0)g=new Array(h.length),g.fill("");else if(g.length!==h.length)throw new Error(`Expected tag_descriptions to have length: ${h.length}`);let v=U(o,"values",b=>{if(!Array.isArray(b)||b.length!==r)throw new Error(`Expected ${r} values, but received: ${b.length}`);return b.map(x=>String.fromCharCode(...x))});return{id:l,description:c,type:d,tags:h,tagDescriptions:g,values:v}}if(d==="number"){let h=U(o,"data_type",x=>yt(x,W));if(h===W.UINT64)throw new Error("uint64 properties not supported");let g=U(o,"values",x=>{if(!Array.isArray(x)||x.length!==r)throw new Error(`Expected ${r} values, but received: ${x.length}`);return th[h].from(x)}),v=Infinity,b=-Infinity;for(let x=g.length-1;x>=0;--x){let C=g[x];C<v&&(v=C),C>b&&(b=C)}return{id:l,description:c,type:d,dataType:h,values:g,bounds:[v,b]}}let p=U(o,"values",h=>{if(on(h),h.length!==r)throw new Error(`Expected ${r} values, but received: ${h.length}`);return h});return{id:l,description:c,type:d,values:p}}));return YI({ids:t,properties:i})}var Ole=nt(ut()(sx),Um);function nu(n,e,t,r){try{let i=U(t,"@type",Z);if(i!=="neuroglancer_segment_properties")throw new Error(`Unsupported segment property map type: ${JSON.stringify(i)}`);let a=ie(t,"inline",S$);return new Wm({inlineProperties:a})}catch(i){throw new Error(`Error parsing segment property map: ${i.message}`)}}async function b$(n,e,t,r){return{modelTransform:vt(_i),subsources:[{id:"default",default:!0,subsource:{segmentPropertyMap:nu(n.chunkManager,e,r,t)}}]}}var x$=/^([^#]*)(?:#(.*))?$/;function mp(n){let[,e,t]=n.match(x$);e.endsWith("/")&&(e=e.substring(0,e.length-1));let r=si(t||"");return{url:e,parameters:r}}function wA(n,e){let t=IE(e);return t&&(n+=`#${t}`),n}var gp=class extends Rt{get description(){return"Precomputed file-backed data source"}normalizeUrl(e){let{url:t,parameters:r}=mp(e.providerUrl);return e.providerProtocol+"://"+wA(t,r)}convertLegacyUrl(e){let{url:t,parameters:r}=mp(e.providerUrl);return e.type==="mesh"&&(r.type="mesh"),e.providerProtocol+"://"+wA(t,r)}get(e){let{url:t,parameters:r}=mp(e.providerUrl);return e.chunkManager.memoize.getUncounted({type:"precomputed:get",providerUrl:t,parameters:r},async()=>{let{url:i,credentialsProvider:a}=Dn(t,e.credentialsManager),o;try{o=await tu(e.chunkManager,a,i)}catch(d){if(zi(d)&&r.type==="mesh")return await CA(e,a,i);throw d}Q(o);let l=ie(o,"redirect",Z);if(l!==void 0)throw new zc(l);let c=ie(o,"@type",Z);switch(c){case"neuroglancer_skeletons":return await y$(e,a,i);case"neuroglancer_multilod_draco":case"neuroglancer_legacy_mesh":case"neuroglancer_legacy_mesh_hierarchical":return await CA(e,a,i);case"neuroglancer_annotations_v1":return await v$(e,a,i,o);case"neuroglancer_segment_properties":return await b$(e,a,i,o);case"neuroglancer_multiscale_volume":case void 0:return await g$(e,a,i,o);default:throw new Error(`Invalid type: ${JSON.stringify(c)}`)}})}completeUrl(e){return vi(e.credentialsManager,e.providerUrl,e.cancellationToken)}};Ft("precomputed",()=>new gp);var TA="nifti/getNiftiVolumeInfo",Jm=class{};Jm.RPC_ID="nifti/VolumeChunkSource";var LA=class extends nt(ut()(En),Jm){},kA=class extends Bt{constructor(e,t,r,i){super(e);this.credentialsProvider=t;this.url=r;this.info=i}get dataType(){return this.info.dataType}get volumeType(){return dt.UNKNOWN}get rank(){return this.info.rank}getSources(e){let{info:t}=this,r=Yt(Float32Array,t.rank+1),i=Qb({rank:t.rank,volumeType:dt.UNKNOWN,chunkDataSize:t.volumeSize,dataType:t.dataType,upperVoxelBound:Float32Array.from(t.volumeSize),chunkToMultiscaleTransform:r,volumeSourceOptions:e});return[[{chunkSource:this.chunkManager.getChunkSource(LA,{credentialsProvider:this.credentialsProvider,spec:i,parameters:{url:this.url}}),chunkToMultiscaleTransform:r}]]}};function C$(n,e,t,r){return n.rpc.promiseInvoke(TA,{chunkManager:n.addCounterpartRef(),credentialsProvider:Kd(n,e),url:t},r)}function w$(n,e,t){return n.memoize.getUncounted({type:"nifti/getVolume",url:t},async()=>{let{url:r,credentialsProvider:i}=Dn(t,e),a=await C$(n,i,r,St),o=new kA(n,i,r,a),l={lowerBounds:new Float64Array(a.rank),upperBounds:Float64Array.from(a.volumeSize)},c=Oe({rank:a.rank,names:a.sourceNames,scales:a.sourceScales,units:a.units,boundingBoxes:[Rn(l)]}),d=Oe({rank:a.rank,names:a.viewNames,scales:a.viewScales,units:a.units});return{subsources:[{id:"default",default:!0,subsource:{volume:o}},{id:"bounds",default:!0,subsource:{staticAnnotations:sn(l)}}],modelTransform:{sourceRank:a.rank,rank:a.rank,inputSpace:c,outputSpace:d,transform:a.transform}}})}var hx=class extends Rt{get description(){return"Single NIfTI file"}get(e){return w$(e.chunkManager,e.credentialsManager,e.providerUrl)}completeUrl(e){return vi(e.credentialsManager,e.providerUrl,e.cancellationToken)}};Ft("nifti",()=>new hx);var yp;(function(r){r[r.RAW=0]="RAW",r[r.GZIP=1]="GZIP",r[r.BLOSC=2]="BLOSC"})(yp||(yp={}));var qm=class{};qm.RPC_ID="n5/VolumeChunkSource";var EA=class extends nt(ut()(En),qm){},DA=class extends Bt{constructor(e,t,r,i){super(e);this.credentialsProvider=t;this.multiscaleMetadata=r;this.scales=i;let a,o;if(i.forEach((h,g)=>{if(h!==void 0){if(o===void 0&&(o=g),a!==void 0&&h.dataType!==a)throw new Error(`Scale s${g} has data type ${W[h.dataType]} but expected ${W[a]}.`);a=h.dataType}}),a===void 0)throw new Error("At least one scale must be specified.");let l=r.scales[o],c=i[o];this.dataType=a,this.volumeType=dt.IMAGE,this.baseScaleIndex=o;let d=r.modelSpace,{rank:p}=d;this.modelSpace=Oe({names:d.names,scales:d.scales,units:d.units,boundingBoxes:[{transform:Ac(Float64Array,l.downsamplingFactor,!1),box:{lowerBounds:new Float64Array(p),upperBounds:new Float64Array(c.size)}}],coordinateArrays:d.coordinateArrays})}get rank(){return this.modelSpace.rank}getSources(e){let{}=this,{scales:t,rank:r}=this,i=this.multiscaleMetadata.scales;return Qn(t.filter(a=>a!==void 0).map((a,o)=>{let l=i[o],c=Ac(Float32Array,l.downsamplingFactor),d=Ac(Float32Array,l.downsamplingFactor);if(console.log(`scaleDownsamplingInfo.downsamplingFactor: ${l.downsamplingFactor}`),a.offset!==void 0&&a.resolution!==void 0)for(console.log(`scale.offset: ${a.offset}`),console.log(`scale.resolution: ${a.resolution}`),o=0;o<a.offset.length;o++)d[12+o]=a.offset[o]/40;return console.log(`transform: ${d}`),Nr({rank:r,chunkToMultiscaleTransform:c,dataType:a.dataType,upperVoxelBound:a.size,volumeType:this.volumeType,chunkDataSizes:[a.chunkSize],volumeSourceOptions:e}).map(p=>({chunkSource:this.chunkManager.getChunkSource(EA,{credentialsProvider:this.credentialsProvider,spec:p,parameters:{url:l.url,encoding:a.encoding}}),chunkToMultiscaleTransform:d}))}))}},PA=class{constructor(e){Q(e),this.dataType=U(e,"dataType",r=>yt(r,W)),this.size=Float32Array.from(U(e,"dimensions",r=>ge(r,ct))),this.chunkSize=U(e,"blockSize",r=>Pe(new Uint32Array(this.size.length),r,ct)),this.offset=ie(e,"offset",r=>Pe(new Int32Array(this.size.length),r,ze)),this.resolution=ie(e,"resolution",r=>Pe(new Uint32Array(this.size.length),r,ct));let t;ie(e,"compression",r=>{t=U(r,"type",i=>yt(i,yp))}),t===void 0&&(t=U(e,"compressionType",r=>yt(r,yp))),this.encoding=t}};function T$(n,e,t){return Promise.all(t.scales.map(async r=>{let i=await IA(n,e,r.url,!0);if(i!==void 0)return new PA(i)}))}function L$(n){let{protocol:e,host:t,path:r}=gl(n);r.endsWith("/")&&(r=r.substring(0,r.length-1));let i=[];for(;;){i.push(`${e}://${t}${r}/attributes.json`);let a=r.lastIndexOf("/");if(a===-1)break;r=r.substring(0,a)}return i}function k$(n,e,t,r){return n.memoize.getUncounted({type:"n5:attributes.json",url:t,credentialsProvider:lt(e)},()=>On(e,t,{},kt).then(i=>{try{return Q(i)}catch(a){throw new Error(`Error reading attributes from ${t}: ${a.message}`)}}).catch(i=>{if(zi(i))return r?void 0:{};throw i}))}async function IA(n,e,t,r){let i=L$(t),a=await Promise.all(i.map((o,l)=>k$(n,e,o,r&&l===i.length-1)));if(a.indexOf(void 0)===-1)return a.reverse(),Object.assign({},...a)}function hs(n,e){if(n!==-1&&e!==n)throw new Error(`Rank mismatch, received ${e} but expected ${n}`);return e}function AA(n){return Float64Array.from(ge(n,ot))}function MA(n){let e=jr(n);if(e.length===0)throw new Error("Expected non-empty array");let t=-1;return{all:ge(e,i=>{let a=AA(i);return t=hs(t,a.length),a}),single:void 0,rank:t}}function E$(n){let e=jr(n);if(e.length===0)throw new Error("Expected non-empty array");if(Array.isArray(e[0]))return MA(e);let t=AA(n);return{all:void 0,single:t,rank:t.length}}var D$=["x","y","z","t","c"];function P$(n){let e=D$.slice(0,n);for(;e.length<n;)e.push(`d${e.length+1}`);return e}function I$(n,e){Q(e);let t=-1,r=ie(e,"resolution",g=>{let v=Float64Array.from(ge(g,ot));return t=hs(t,v.length),v}),i=ie(e,"axes",g=>{let v=ge(g,Z);return t=hs(t,v.length),v}),a=ie(e,"units",g=>{let v=ge(g,wh);return t=hs(t,v.length),v}),o={unit:"m",exponent:-9},l,c;ie(e,"downsamplingFactors",g=>{let{single:v,all:b,rank:x}=E$(g);t=hs(t,x),v!==void 0&&(l=v),b!==void 0&&(c=b)}),ie(e,"pixelResolution",g=>{o=U(g,"unit",wh),ie(g,"dimensions",v=>{r=Float64Array.from(ge(v,ot)),t=hs(t,r.length)})}),ie(e,"scales",g=>{let{all:v,rank:b}=MA(g);t=hs(t,b),c=v});let d=ie(e,"dimensions",g=>{let v=ge(g,ct);return t=hs(t,v.length),v});if(t===-1)throw new Error("Unable to determine rank of dataset");a===void 0&&(a=new Array(t),a.fill(o)),r===void 0&&(r=new Float64Array(t),r.fill(1));for(let g=0;g<t;++g)r[g]=Id(r[g],a[g].exponent);let p=new Array(t);i!==void 0&&ie(e,"coordinateArrays",g=>{Q(g);for(let v=0;v<t;++v){let b=i[v];if(Object.prototype.hasOwnProperty.call(g,b)){let x=on(g[b]);p[v]={explicit:!1,labels:x,coordinates:Array.from(x,(C,T)=>T)},a[v]={unit:"",exponent:0},r[v]=1}}}),i===void 0&&(i=P$(t));let h=Oe({rank:t,valid:!0,names:i,scales:r,units:a.map(g=>g.unit),coordinateArrays:p});if(d===void 0){if(c===void 0)throw new Error("Not valid single-resolution or multi-resolution dataset");return{modelSpace:h,url:n,attributes:e,scales:c.map((g,v)=>({url:`${n}/s${v}`,downsamplingFactor:g}))}}return l===void 0&&(l=new Float64Array(t),l.fill(1)),{modelSpace:h,url:n,attributes:e,scales:[{url:n,downsamplingFactor:l}]}}var mx=class extends Rt{get description(){return"N5 data source"}get(e){let{providerUrl:t}=e;return t.endsWith("/")&&(t=t.substring(0,t.length-1)),e.chunkManager.memoize.getUncounted({type:"n5:MultiscaleVolumeChunkSource",providerUrl:t},async()=>{let{url:r,credentialsProvider:i}=Dn(t,e.credentialsManager),a=await IA(e.chunkManager,i,r,!1),o=I$(r,a),l=await T$(e.chunkManager,i,o),c=new DA(e.chunkManager,i,o,l);return{modelTransform:vt(c.modelSpace),subsources:[{id:"default",default:!0,url:void 0,subsource:{volume:c}},{id:"bounds",default:!0,url:void 0,subsource:{staticAnnotations:sn(c.modelSpace.bounds)}}]}})}completeUrl(e){return vi(e.credentialsManager,e.providerUrl,e.cancellationToken)}};Ft("n5",()=>new mx);var El;(function(r){r[r.RAW=0]="RAW",r[r.GZIP=1]="GZIP",r[r.BLOSC=2]="BLOSC"})(El||(El={}));var Ym=class{};Ym.RPC_ID="zarr/VolumeChunkSource";var A$=new Set(["0.4","0.5-dev","0.5"]),RA=new Map([["angstrom",{unit:"m",scale:1e-10}],["foot",{unit:"m",scale:.3048}],["inch",{unit:"m",scale:.0254}],["mile",{unit:"m",scale:1609.34}],["parsec",{unit:"m",scale:30856775814913670}],["yard",{unit:"m",scale:.9144}],["minute",{unit:"s",scale:60}],["hour",{unit:"s",scale:60*60}],["day",{unit:"s",scale:60*60*24}]]);for(let n of["meter","second"])for(let e of cS){let{longPrefix:t}=e;t!==void 0&&RA.set(`${t}${n}`,{unit:n[0],scale:Math.pow(10,e.exponent)})}function M$(n){Q(n);let e=U(n,"name",Z),t=ie(n,"type",Z),r=ie(n,"unit",i=>{let a=RA.get(i);if(a===void 0)throw new Error(`Unsupported unit: ${JSON.stringify(i)}`);return a},{unit:"",scale:1});return{name:e,unit:r.unit,scale:r.scale,type:t}}function R$(n){let e=ge(n,M$);return Oe({names:e.map(t=>{let{name:r,type:i}=t;return i==="channel"?`${r}'`:r}),scales:Float64Array.from(e,t=>t.scale),units:e.map(t=>t.unit)})}function _$(n,e){let t=U(e,"scale",r=>Pe(new Float64Array(n),r,ot));return Ac(Float64Array,t)}function V$(n,e){return Yt(Float64Array,n+1)}function O$(n,e){let t=U(e,"translation",r=>Pe(new Float64Array(n),r,Ke));return JE(Float64Array,t)}var N$=new Map([["scale",_$],["identity",V$],["translation",O$]]);function B$(n,e){Q(e);let t=U(e,"type",Z),r=N$.get(t);if(r===void 0)throw new Error(`Unsupported coordinate transform type: ${JSON.stringify(t)}`);return r(n,e)}function _A(n,e){let t=Yt(Float64Array,n+1);return e===void 0||ge(e,r=>{let i=B$(n,r);t=ci(new Float64Array(t.length),n+1,i,n+1,t,n+1,n+1,n+1,n+1)}),t}function F$(n,e,t){let r=U(t,"path",Z),i=U(t,"coordinateTransformations",o=>_A(n,o));return{url:`${e}/${r}`,transform:i}}function U$(n,e){let t=U(e,"axes",R$),r=t.rank,i=U(e,"coordinateTransformations",c=>_A(r,c)),a=U(e,"datasets",c=>ge(c,d=>{let p=F$(r,n,d);return p.transform=ci(new Float64Array((r+1)**2),r+1,i,r+1,p.transform,r+1,r+1,r+1,r+1),p}));if(a.length===0)throw new Error("At least one scale must be specified");let o=a[0].transform,l=new Float64Array(r);for(let c=0;c<r;++c){let d=l[c]=o[c*(r+1)+c];t.scales[c]*=d}for(let c of a){let d=c.transform;for(let p=0;p<r;++p)for(let h=0;h<=r;++h)d[h*(r+1)+p]/=l[p]}return{coordinateSpace:t,scales:a}}function VA(n,e){let t=e.multiscales;if(!Array.isArray(t))return;let r=[];for(let i of t){if(typeof i!="object"||i==null||Array.isArray(i))return;let a=i.version;if(a===void 0)return;if(!A$.has(a)){r.push(`OME multiscale metadata version ${JSON.stringify(a)} is not supported`);continue}return U$(n,i)}if(r.length!==0)throw new Error(r[0])}var ho=new Map;ho.set("|u1",{endianness:nn.LITTLE,dataType:W.UINT8});ho.set("|i1",{endianness:nn.LITTLE,dataType:W.INT8});for(let[n,e]of[["<",nn.LITTLE],[">",nn.BIG]]){for(let t of["u","i"])ho.set(`${n}${t}8`,{endianness:e,dataType:W.UINT64});ho.set(`${n}u2`,{endianness:e,dataType:W.UINT16}),ho.set(`${n}i2`,{endianness:e,dataType:W.INT16}),ho.set(`${n}u4`,{endianness:e,dataType:W.UINT32}),ho.set(`${n}i4`,{endianness:e,dataType:W.INT32}),ho.set(`${n}f4`,{endianness:e,dataType:W.FLOAT32})}function OA(n){let e=ho.get(n);if(e===void 0)throw new Error(`Unsupported numpy data type: ${JSON.stringify(n)}`);return e}var NA=class extends nt(ut()(En),Ym){};function BA(n){return ie(n,"dimension_separator",e=>{if(e!=="."&&e!=="/")throw new Error(`Expected "." or "/", but received: ${JSON.stringify(e)}`);return e})}function G$(n){try{Q(n),U(n,"zarr_format",d=>{if(d!==2)throw new Error(`Expected 2 but received: ${JSON.stringify(d)}`)});let e=U(n,"shape",d=>ge(d,p=>{if(typeof p!="number"||!Number.isInteger(p)||p<0)throw new Error(`Expected non-negative integer, but received: ${JSON.stringify(p)}`);return p})),t=U(n,"chunks",d=>Pe(new Array(e.length),d,p=>{if(typeof p!="number"||!Number.isInteger(p)||p<=0)throw new Error(`Expected positive integer, but received: ${JSON.stringify(p)}`);return p})),r=U(n,"order",d=>{if(d!=="C"&&d!=="F")throw new Error(`Expected "C" or "F", but received: ${JSON.stringify(d)}`);return d}),i=BA(n),a=U(n,"dtype",d=>OA(Z(d))),o=U(n,"compressor",d=>{if(d===null)return El.RAW;Q(d);let p=U(d,"id",Z);switch(p){case"blosc":return El.BLOSC;case"gzip":return El.GZIP;case"zlib":return El.GZIP;default:throw new Error(`Unsupported compressor: ${JSON.stringify(p)}`)}}),l=a.dataType,c=U(n,"fill_value",d=>{if(d!==null)switch(l){case W.FLOAT32:return d==="NaN"?Number.NaN:d==="Infinity"?Number.POSITIVE_INFINITY:d==="-Infinity"?Number.NEGATIVE_INFINITY:bn(d);default:return ze(d)}});return{rank:e.length,shape:e,chunks:t,order:r,dataType:l,encoding:{compressor:o,endianness:a.endianness},fillValue:c,dimensionSeparator:i}}catch(e){throw new Error(`Error parsing zarr metadata: ${e.message}`)}}function W$(n,e){let t=ie(e,"_ARRAY_DIMENSIONS",r=>Pe(new Array(n),r,Z));t=new Array(n);for(let r=0;r<n;++r)t[r]=`d${r}`;return t}var FA=class extends Bt{constructor(e,t,r){super(e);this.credentialsProvider=t;this.multiscale=r;this.volumeType=dt.IMAGE}get dataType(){return this.multiscale.dataType}get modelSpace(){return this.multiscale.coordinateSpace}get rank(){return this.multiscale.coordinateSpace.rank}getSources(e){return Qn(this.multiscale.scales.map(t=>{let{metadata:r}=t,{rank:i,chunks:a,shape:o}=r,l,c,d;if(r.order==="F")l=Uint32Array.from(a),c=Float32Array.from(o),d=Yt(Float32Array,i+1);else{l=new Uint32Array(i),c=new Float32Array(i),d=new Float32Array((i+1)**2),d[(i+1)**2-1]=1;for(let h=0;h<i;++h)l[h]=a[i-1-h],c[h]=o[i-1-h],d[h+(i-1-h)*(i+1)]=1}let p=new Float32Array((i+1)**2);return ci(p,i+1,t.transform,i+1,d,i+1,i+1,i+1,i+1),Nr({rank:i,chunkToMultiscaleTransform:p,dataType:r.dataType,upperVoxelBound:c,volumeType:this.volumeType,chunkDataSizes:[l],volumeSourceOptions:e,fillValue:r.fillValue}).map(h=>({chunkSource:this.chunkManager.getChunkSource(NA,{credentialsProvider:this.credentialsProvider,spec:h,parameters:{url:t.url,encoding:r.encoding,separator:t.dimensionSeparator,order:r.order}}),chunkToMultiscaleTransform:p}))}))}};function z$(n,e,t){return n.memoize.getUncounted({type:"zarr:.zattrs json",url:t,credentialsProvider:lt(e)},async()=>{try{let r=await On(e,t+"/.zattrs",{},kt);return Q(r),r}catch(r){if(zi(r))return{};throw r}})}function UA(n,e,t,r=!0){return n.memoize.getUncounted({type:"zarr:.zarray json",url:t,credentialsProvider:lt(e)},async()=>{try{let i=await On(e,t+"/.zarray",{},kt);return G$(i)}catch(i){if(r&&zi(i))return;throw i}})}var H$=[{key:{value:"dimension_separator",description:"Dimension separator in chunk keys"},values:[{value:".",description:"(default)"},{value:"/",description:""}]}];function $$(n,e,t,r){let i=W$(t.rank,r),a=Oe({names:i,scales:Float64Array.from(t.shape,()=>1),units:Array.from(t.shape,()=>""),boundingBoxes:[Rn({lowerBounds:new Float64Array(t.rank),upperBounds:Float64Array.from(t.shape)})]}),o=Yt(Float64Array,t.rank+1);return{coordinateSpace:a,dataType:t.dataType,scales:[{url:n,transform:o,metadata:t,dimensionSeparator:GA(n,e,t.dimensionSeparator)}]}}function GA(n,e,t){var r;if(t!==void 0&&e!==void 0&&t!==e)throw new Error(`Explicitly specified dimension separator ${JSON.stringify(e)} does not match value in ${n}/.zarray ${JSON.stringify(t)}`);return(r=t!=null?t:e)!=null?r:"."}async function j$(n,e,t,r){let i=await Promise.all(r.scales.map(x=>UA(n,e,x.url,!1))),a=i[0].dataType,o=i.length,l=r.coordinateSpace.rank;for(let x=0;x<o;++x){let C=r.scales[x],T=i[x];if(T.rank!==l)throw new Error(`Expected zarr array at ${JSON.stringify(C.url)} to have rank ${l}, but received: ${T.rank}`);if(T.dataType!==a)throw new Error(`Expected zarr array at ${JSON.stringify(C.url)} to have data type ${W[a]}, but received: ${W[T.dataType]}`)}let c=new Float64Array(l),d=new Float64Array(l),p=r.scales[0],h=i[0];for(let x=0;x<l;++x){let C=c[x]=p.transform[(l+1)*l+x];d[x]=C+h.shape[x]}let g=Rn({lowerBounds:c,upperBounds:d}),{coordinateSpace:v}=r;return{coordinateSpace:Oe({names:v.names,units:v.units,scales:v.scales,boundingBoxes:[g]}),dataType:a,scales:r.scales.map((x,C)=>{let T=i[C];return{url:x.url,transform:x.transform,metadata:T,dimensionSeparator:GA(x.url,t,T.dimensionSeparator)}})}}var gx=class extends Rt{get description(){return"Zarr data source"}get(e){let[,t,r]=e.providerUrl.match(/([^?]*)(?:\?(.*))?$/),i=si(r||"");Q(i);let a=BA(i);return t.endsWith("/")&&(t=t.substring(0,t.length-1)),e.chunkManager.memoize.getUncounted({type:"zarr:MultiscaleVolumeChunkSource",providerUrl:t,dimensionSeparator:a},async()=>{let{url:o,credentialsProvider:l}=Dn(t,e.credentialsManager),[c,d]=await Promise.all([UA(e.chunkManager,l,o),z$(e.chunkManager,l,o)]),p;if(c===void 0){let g=VA(o,d);if(g===void 0)throw new Error("Neither .zarray metadata nor OME multiscale metadata found");p=await j$(e.chunkManager,l,a,g)}else p=$$(o,a,c,d);let h=new FA(e.chunkManager,l,p);return{modelTransform:vt(h.modelSpace),subsources:[{id:"default",default:!0,url:void 0,subsource:{volume:h}},{id:"bounds",default:!0,url:void 0,subsource:{staticAnnotations:sn(h.modelSpace.bounds)}}]}})}async completeUrl(e){let[,,t]=e.providerUrl.match(/([^?]*)(?:\?(.*))?$/);return t!==void 0?_r(e.providerUrl.length-t.length,await Jh(t,H$)):await vi(e.credentialsManager,e.providerUrl,e.cancellationToken)}};Ft("zarr",()=>new gx);var WA="single_mesh/SingleMeshLayer",zA="single_mesh/getSingleMeshInfo",Km="",HA=class{},Xm=class extends HA{};Xm.RPC_ID="single_mesh/SingleMeshSource";var $A=class extends H{constructor(e){super();this.gl=e;this.buffer=this.registerDisposer(new Gt(e))}resize(e){let t;if(e<256){let r=t=new Uint8Array(e);for(let i=0;i<e;++i)r[i]=i;this.webglType=WebGL2RenderingContext.UNSIGNED_BYTE}else if(e<65536){let r=t=new Uint16Array(e);for(let i=0;i<e;++i)r[i]=i;this.webglType=WebGL2RenderingContext.UNSIGNED_SHORT}else{let r=t=new Uint32Array(e);for(let i=0;i<e;++i)r[i]=i;this.webglType=WebGL2RenderingContext.UNSIGNED_INT}this.buffer.setData(t),this.length=e}ensure(e){return(this.length===void 0||this.length<e)&&this.resize(e),this}bindToVertexAttrib(e){this.buffer.bindToVertexAttribI(e,1,this.webglType)}bind(e,t=0){let r=e.attribute("aIndexRaw");r>=0&&(this.bindToVertexAttrib(r),t!==0&&this.gl.vertexAttribDivisor(r,t))}};function jA(n,e,t=!1){let r=e.attribute("aIndexRaw");r>=0&&(t&&n.vertexAttribDivisor(r,0),n.disableVertexAttribArray(r))}function JA(n){return n.memoize.get("IndexBuffer",()=>new $A(n))}function qA(n){n.addAttribute("highp uint","aIndexRaw"),n.addVertexCode(nl),n.addVertexCode(`
uint getPrimitiveIndex() {
  return aIndexRaw;
}
`)}var yx=class{constructor(e){this.name=e}defineShader(e){e.addAttribute("highp uint",this.name)}bind(e,t){let r=t.attribute(this.name);e.bindToVertexAttribI(r,1,WebGL2RenderingContext.UNSIGNED_INT)}disable(e){e.gl.disableVertexAttribArray(e.attribute(this.name))}};function YA(n,e){return Gt.fromData(n,e,WebGL2RenderingContext.ARRAY_BUFFER,WebGL2RenderingContext.STATIC_DRAW)}var KA=`void main() {
  emitGray();
}
`,vx=class{constructor(){this.shaderError=ga();this.fragmentMain=Jo(KA);this.shaderControlState=new ao(this.fragmentMain)}};function Sx(n){return Ot(n.dataType,n.numComponents)}var Dl=[],XA=hi(new Hi,W.FLOAT32,3),J$=XA;function q$(n){return n.split(/[^a-zA-Z0-9]+/).filter(e=>e).join("_")}function bx(n){let e=new Set,t=[];for(let r of n){let i=q$(r),a="",o=0;for(;e.has(i+a);)a=""+ ++o;t.push(i+a)}return t}var QA=class{constructor(e,t){this.attributeNames=e;this.attributeInfo=t;this.tempLightVec=new Float32Array(4);this.textureAccessHelper=new po("vertexData");this.indexBufferHelper=new yx("vertexIndex")}defineAttributeAccess(e,t){let{textureAccessHelper:r}=this;r.defineShader(e);let{attributeNames:i}=this,a=2+i.length;for(let l=Dl.length;l<a;++l)Dl[l]=Symbol(`SingleMeshShaderManager.vertexAttributeTextureUnit${l}`);a=0,e.addTextureSampler("sampler2D","uVertexAttributeSampler0",Dl[a++]),e.addTextureSampler("sampler2D","uVertexAttributeSampler1",Dl[a++]),e.addVertexCode(r.getAccessor("readVertexPosition","uVertexAttributeSampler0",W.FLOAT32,3)),e.addVertexCode(r.getAccessor("readVertexNormal","uVertexAttributeSampler1",W.FLOAT32,3));let o=`
vec3 vertexPosition = readVertexPosition(${t});
vec3 vertexNormal = readVertexNormal(${t});
`;this.attributeInfo.forEach((l,c)=>{e.addTextureSampler(`${Jc(l.dataType)}sampler2D`,`uVertexAttributeSampler${a}`,Dl[a]);let d=Sx(l);e.addVarying(`highp ${d}`,`vCustom${c}`),e.addFragmentCode(`
#define ${i[c]} vCustom${c}
`),e.addVertexCode(r.getAccessor(`readAttribute${c}`,`uVertexAttributeSampler${a}`,l.dataType,l.numComponents)),o+=`vCustom${c} = readAttribute${c}(${t});
`,++a}),e.addVertexMain(o)}defineShader(e){e.require(qA),this.indexBufferHelper.defineShader(e),e.addVarying("highp float","vLightingFactor"),e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp vec4","uColor"),e.addUniform("highp mat4","uModelMatrix"),e.addUniform("highp mat4","uProjection"),e.addUniform("highp uint","uPickID"),e.addVarying("highp uint","vPickID","flat"),e.addVertexMain(`
uint triangleIndex = getPrimitiveIndex() / 3u;
vPickID = uPickID + triangleIndex;
`),e.addFragmentCode(`
void emitPremultipliedRGBA(vec4 color) {
  emit(vec4(color.rgb * vLightingFactor, color.a), vPickID);
}
void emitRGBA(vec4 color) {
  color = clamp(color, 0.0, 1.0);
  color.xyz *= color.a;
  emitPremultipliedRGBA(color);
}
void emitRGB(vec3 color) {
  emitRGBA(vec4(color, 1.0));
}
void emitGray() {
  emitRGB(vec3(1.0, 1.0, 1.0));
}
`),e.addFragmentCode(Oi),this.defineAttributeAccess(e,"vertexIndex"),e.addVertexMain(`
gl_Position = uProjection * (uModelMatrix * vec4(vertexPosition, 1.0));
vec3 normal = normalize((uModelMatrix * vec4(vertexNormal, 0.0)).xyz);
vLightingFactor = abs(dot(normal, uLightDirection.xyz)) + uLightDirection.w;
`)}beginLayer(e,t,r){let{lightDirection:i,ambientLighting:a,directionalLighting:o,projectionParameters:l}=r,{viewProjectionMat:c}=l;e.uniformMatrix4fv(t.uniform("uProjection"),!1,c);let d=this.tempLightVec;K.scale(d,i,o),d[3]=a,e.uniform4fv(t.uniform("uLightDirection"),d)}setPickID(e,t,r){e.uniform1ui(t.uniform("uPickID"),r)}beginObject(e,t,r){e.uniformMatrix4fv(t.uniform("uModelMatrix"),!1,r)}bindVertexData(e,t,r){let i=0,a=l=>{let c=WebGL2RenderingContext.TEXTURE0+t.textureUnit(Dl[i]);e.activeTexture(c),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,l),++i};a(r.vertexTexture),a(r.normalTexture);let{attributeNames:o}=this;r.vertexAttributeTextures.forEach((l,c)=>{o[c]!==void 0&&a(l)})}disableVertexData(e,t){let r=2,i=this.attributeInfo.length,{attributeNames:a}=this;for(let o=0;o<i;++o)a[o]!==void 0&&++r;for(let o=0;o<r;++o){let l=t.textureUnit(Dl[o])+WebGL2RenderingContext.TEXTURE0;e.activeTexture(l),e.bindTexture(e.TEXTURE_2D,null)}}drawFragment(e,t,r,i){i.ensure(r.numIndices).bind(t),this.bindVertexData(e,t,r.vertexData),this.indexBufferHelper.bind(r.indexBuffer,t),e.drawArrays(WebGL2RenderingContext.TRIANGLES,0,r.numIndices)}endLayer(e,t){jA(e,t),this.indexBufferHelper.disable(t),this.disableVertexData(e,t)}},ZA=class{copyToGPU(e,t){let r=(i,a)=>{let o=e.createTexture();return e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,o),rs(e,a,i),o};this.vertexTexture=r(this.vertexPositions,XA),this.normalTexture=r(this.vertexNormals,J$),this.vertexAttributeTextures=this.vertexAttributes.map((i,a)=>r(i,t[a])),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}freeGPUMemory(e){e.deleteTexture(this.vertexTexture),e.deleteTexture(this.normalTexture);let{vertexAttributeTextures:t}=this;for(let r of t)e.deleteTexture(r);t.length=0}},eM=class extends yr{constructor(e,t){super(e);let r=this.vertexData=new ZA;r.vertexPositions=t.vertexPositions,r.vertexNormals=t.vertexNormals,r.vertexAttributes=t.vertexAttributes;let i=this.indices=t.indices;this.numIndices=i.length}copyToGPU(e){super.copyToGPU(e),this.vertexData.copyToGPU(e,this.source.attributeTextureFormats),this.indexBuffer=YA(e,this.indices)}freeGPUMemory(e){super.freeGPUMemory(e),this.vertexData.freeGPUMemory(e),this.indexBuffer.dispose()}};function Y$(n){return n.map(e=>hi(new Hi,e.dataType,e.numComponents))}var tM=class extends nt(ut()(Hn),Xm){constructor(){super(...arguments);this.attributeTextureFormats=Y$(this.info.vertexAttributes)}get info(){return this.parameters.info}getChunk(e){return new eM(this,e)}},K$=ya(Cn),nM=class extends K${},xx=class extends Vr{constructor(e,t,r){super();this.source=e;this.displayState=t;this.transform=r;this.shaderManager=new QA(bx(this.source.info.vertexAttributes.map(e=>e.name)),this.source.info.vertexAttributes);this.shaders=new Map;this.sharedObject=this.registerDisposer(new nM);this.shaderGetter=Zr(this,this.gl,{memoizeKey:{t:"single_mesh/RenderLayer",attributes:this.source.info.vertexAttributes},fallbackParameters:new ke(Ko(io(KA))),parameters:this.displayState.shaderControlState.builderState,encodeParameters:e=>e.key,shaderError:this.displayState.shaderError,defineShader:(e,t)=>{if(t.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");Fi(t,e),this.shaderManager.defineShader(e),e.setFragmentMainFunction(Ni(t.parseResult.code))}});this.countingBuffer=this.registerDisposer(JA(this.gl));this.registerDisposer(t.shaderControlState.parseResult.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.shaderControlState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(r.changed.add(this.redrawNeeded.dispatch));let{sharedObject:i}=this;i.visibility.add(this.visibility),i.RPC_TYPE_ID=WA,i.initializeCounterpart(e.chunkManager.rpc,{chunkManager:e.chunkManager.rpcId,source:e.addCounterpartRef()})}disposeShaders(){let{shaders:e}=this;for(let t of e.values())t!==null&&t.dispose();e.clear()}disposed(){this.disposeShaders(),super.disposed()}get isTransparent(){return this.displayState.fragmentMain.value.match(/emitRGBA|emitPremultipliedRGBA/)!==null}get gl(){return this.source.gl}isReady(){let e=this.source.chunks.get(Km);return!(e===void 0||e.state!==tt.GPU_MEMORY)}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;let r=es(this.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(r===void 0)return;let i=this.source.chunks.get(Km);if(i===void 0||i.state!==tt.GPU_MEMORY)return;let a=this.shaderGetter(e.emitter),{shader:o,parameters:l}=a;if(o===null)return;let{gl:c}=this,d=this.shaderManager;o.bind(),d.beginLayer(c,o,e),ei(c,o,this.displayState.shaderControlState,l.parseResult.controls);let{pickIDs:p}=e;d.beginObject(c,o,r),e.emitPickID&&d.setPickID(c,o,p.register(this,i.numIndices/3)),d.drawFragment(c,o,i,this.countingBuffer),d.endLayer(c,o)}transformPickedValue(e){let{pickedOffset:t}=e,r=this.source.chunks.get(Km);if(r===void 0)return;let i=t*3,{indices:a}=r;if(i>=a.length)return;let o=a[i],l=[],{attributeNames:c}=this.shaderManager;return r.vertexData.vertexAttributes.forEach((d,p)=>{let h=c[p];h!==void 0&&l.push(`${h}=${d[o].toPrecision(6)}`)}),l.join(", ")}};function X$(n,e,t){return n.memoize.getUncounted({type:"single_mesh:getMeshInfo",url:t},async()=>{let{url:r,credentialsProvider:i}=Dn(t,e);return{info:await n.rpc.promiseInvoke(zA,{chunkManager:n.addCounterpartRef(),credentialsProvider:Kd(n,i),parameters:{meshSourceUrl:r}}),url:r,credentialsProvider:i}})}async function Qm(n,e,t){let{info:r,url:i,credentialsProvider:a}=await X$(n,e,t);return n.getChunkSource(tM,{credentialsProvider:a,parameters:{meshSourceUrl:i,info:r}})}var Cx=class extends Rt{get description(){return"VTK mesh file"}async get(e){let t=await Qm(e.chunkManager,e.credentialsManager,e.url),r=Oe({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)});return{modelTransform:vt(r),subsources:[{id:"default",default:!0,subsource:{singleMesh:t}}]}}completeUrl(e){return vi(e.credentialsManager,e.providerUrl,e.cancellationToken)}};Ft("vtk",()=>new Cx);var wx=class extends Rt{get description(){return"Wavefront OBJ mesh file"}async get(e){let t=await Qm(e.chunkManager,e.credentialsManager,e.url),r=Oe({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)});return{modelTransform:vt(r),subsources:[{id:"default",default:!0,subsource:{singleMesh:t}}]}}completeUrl(e){return vi(e.credentialsManager,e.providerUrl,e.cancellationToken)}};Ft("obj",()=>new wx);var Dx=Ye(gt());var ms=class extends H{};function Zm(n){let e,t,r;return(i,a)=>t!==void 0&&(e===void 0||i===void 0||e.generation!==i.generation)?(e===void 0&&r.addConsumer(a),t):(e=void 0,r=new kS,t=n(i,r).then(o=>(e=o,r=void 0,o),o=>{throw r.isCanceled&&(r=void 0,t=void 0),o}),t)}function eg(n){let e=0;return Zm((t,r)=>n(r).then(i=>({generation:++e,credentials:i})))}var rM=class{constructor(){this.providers=new Map;this.topLevelManager=this}register(e,t){this.providers.set(e,t)}getCredentialsProvider(e,t){let r=this.providers.get(e);if(r===void 0)throw new Error(`No registered credentials provider: ${JSON.stringify(e)}`);return r(t,this.topLevelManager)}},tg=class extends H{constructor(e){super();this.base=e;this.memoize=new Ed}getCredentialsProvider(e,t){return this.memoize.get({key:e,parameters:t},()=>this.registerDisposer(this.base.getCredentialsProvider(e,t).addRef()))}},Tx=class extends tg{constructor(){super(new rM);this.base.topLevelManager=this}register(e,t){this.base.register(e,t)}},Lx=class extends ms{constructor(e,t){super();this.baseProvider=e;this.anonymousCredentials=t;this.anonymous=!0;this.get=Zm(e=>this.anonymous&&e===void 0?Promise.resolve({generation:-10,credentials:this.anonymousCredentials}):(this.anonymous=!1,this.baseProvider.get(e)))}};function iM(n){return new Error(`Nggraph server ${n} does not allow requests from Neuroglancer instance ${self.origin}`)}async function Q$(n){let e=new Ee(!1);function t(i,a){e.element.textContent=i+" ";let o=document.createElement("button");o.textContent=a,e.element.appendChild(o),o.addEventListener("click",()=>{window.open(`${n}/login?origin=${encodeURIComponent(self.origin)}`),t(`Waiting for login to nggraph server ${n}...`,"Retry")})}let r=new Promise((i,a)=>{function o(l){if((l.origin||l.originalEvent.origin)!==n||typeof l.data!="string")return;let d=()=>{window.removeEventListener("message",o,!1)};l.data==="badorigin"?(d(),a(iM(n))):(d(),i(l.data))}window.addEventListener("message",o,!1)});t(`Nggraph server ${n} login required.`,"Login");try{return{token:await r}}finally{e.dispose()}}var kx=class extends ms{constructor(e){super();this.serverUrl=e;this.get=eg(async()=>{let e=await fetch(`${this.serverUrl}/token`,{method:"POST",credentials:"include"});switch(e.status){case 200:return{token:await e.text()};case 401:return await Q$(this.serverUrl);case 403:throw iM(this.serverUrl);default:throw Sr.fromResponse(e)}})}};var ng=Symbol("disjoint_sets:rank"),mo=Symbol("disjoint_sets:parent"),rg=Symbol("disjoint_sets:next"),vp=Symbol("disjoint_sets:prev");function Ex(n){let e=n,t=n[mo];for(;t!==n;)n=t,t=n[mo];for(n=e[mo];t!==n;)e[mo]=t,e=n,n=e[mo];return t}function Z$(n,e){let t=n[ng],r=e[ng];return t>r?(e[mo]=n,n):(n[mo]=e,t===r&&(e[ng]=r+1),e)}function ej(n,e){let t=n[vp],r=e[vp];e[vp]=t,t[rg]=e,n[vp]=r,r[rg]=n}function*aM(n){let e=n;do yield e,e=e[rg];while(e!==n)}function tj(n){n[mo]=n,n[ng]=0,n[rg]=n[vp]=n}var ru=Symbol("disjoint_sets:min");function oM(n){return n[mo]===n}var Pl=class{constructor(){this.map=new Map;this.visibleSegmentEquivalencePolicy=new ke(Kt.MIN_REPRESENTATIVE);this.generation=0}has(e){let t=e.toString();return this.map.get(t)!==void 0}get(e){let t=e.toString(),r=this.map.get(t);return r===void 0?e:Ex(r)[ru]}isMinElement(e){let t=this.get(e);return t===e||X.equal(t,e)}makeSet(e){let t=e.toString(),{map:r}=this,i=r.get(t);return i===void 0?(i=e.clone(),tj(i),i[ru]=i,r.set(t,i),i):Ex(i)}link(e,t){if(e=this.makeSet(e),t=this.makeSet(t),e===t)return!1;this.generation++;let r=Z$(e,t);ej(e,t);let i=e[ru],a=t[ru],o=(this.visibleSegmentEquivalencePolicy.value&Kt.MAX_REPRESENTATIVE)!=0;return r[ru]=X.less(i,a)===o?a:i,!0}linkAll(e){for(let t=1,r=e.length;t<r;++t)this.link(e[0],e[t])}deleteSet(e){let{map:t}=this,r=!1;for(let i of this.setElements(e))t.delete(i.toString()),r=!0;return r&&++this.generation,r}*setElements(e){let t=e.toString(),r=this.map.get(t);r===void 0?yield e:yield*aM(r)}clear(){let{map:e}=this;return e.size===0?!1:(++this.generation,e.clear(),!0)}get size(){return this.map.size}*mappings(e=new Array(2)){for(let t of this.map.values())e[0]=t,e[1]=Ex(t)[ru],yield e}*roots(){for(let e of this.map.values())oM(e)&&(yield e)}[Symbol.iterator](){return this.mappings()}toJSON(){let e=new Array;for(let t of this.map.values())if(oM(t)){let r=new Array;for(let i of aM(t))r.push(i);r.sort(X.compare),e.push(r)}return e.sort((t,r)=>X.compare(t[0],r[0])),e.map(t=>t.map(r=>r.toString()))}};var nj="^(https?://[^/]+)/(.*)$";function rj(n){return Q(n),{id:U(n,"id",e=>X.parseString(Z(e))),baseSegments:U(n,"base_segment_ids",e=>ge(e,t=>X.parseString(Z(t)))),baseSegmentParents:U(n,"base_segment_parent_ids",e=>ge(e,t=>X.parseString(Z(t)))),name:U(n,"name",Z),tags:U(n,"tags",on),numVoxels:U(n,"num_voxels",ze),bounds:U(n,"bounds",e=>ge(e,t=>Ke(t))),lastLogId:U(n,"last_log_id",e=>e==null?null:X.parseString(Z(e)))}}var sM=0,lM=class extends ll{constructor(e,t){super(e,t);this.debouncedVisibleSegmentsChanged=this.registerCancellable((0,Dx.default)(()=>this.visibleSegmentsChanged(),0));this.segmentQueries=new Map;this.ignoreVisibleSegmentsChanged=!1;this.segmentEquivalencesChanged=this.registerCancellable((0,Dx.default)(()=>{this.debouncedVisibleSegmentsChanged.flush(),this.segmentEquivalencesChanged.cancel();let{segmentQueries:e}=this,{segmentEquivalences:t}=this.segmentsState;t.clear();for(let[r,i]of e){if(i.current===void 0||Uc(i.id))continue;let{id:a,baseSegments:o}=i.current;if(o.length>0){for(let l of o)t.link(l,a);i.addedEquivalences=!0}else i.addedEquivalences=!1}},0));let r=()=>{this.ignoreVisibleSegmentsChanged||this.debouncedVisibleSegmentsChanged()};this.registerDisposer(t.visibleSegments.changed.add(r)),this.registerDisposer(t.temporaryVisibleSegments.changed.add(r)),this.visibleSegmentsChanged()}computeSplit(e,t){let{segmentEquivalences:r}=this.segmentsState,i=r.get(e);if(Uc(i)||!X.equal(r.get(t),i))return;let a=this.segmentQueries.get(i.toString());if(a===void 0)return;let{current:o}=a;if(o===void 0)return;let{baseSegments:l,baseSegmentParents:c}=o,d=c.length,p=new Pl;for(let b=0;b<d;++b){let x=l[b],C=c[b];X.equal(x,t)||X.equal(C,t)||(p.link(x,C),console.log(`Linking ${x} - ${C} == ${e}? ${X.equal(e,x)} ${X.equal(e,C)} :: unioned with include = ${X.equal(e,p.get(x))}, with exclude = ${X.equal(t,p.get(x))}`))}let h=[],g=[],v=p.get(e);for(let b of l)X.equal(p.get(b),v)?h.push(b):g.push(b);return console.log("include = "+h.map(b=>b.toString()).join(",")),console.log("exclude = "+g.map(b=>b.toString()).join(",")),{includeRepresentative:i,includeBaseSegments:h,excludeRepresentative:ab,excludeBaseSegments:g}}registerVisibleSegment(e){let t={id:e,current:void 0,addedEquivalences:!1,seenGeneration:sM,disposer:this.graph.watchSegment(e,i=>this.handleSegmentUpdate(t.id.toString(),i))},r=e.toString();this.segmentQueries.set(r,t),console.log(`adding to segmentQueries: ${r}`)}handleSegmentUpdate(e,t){console.log(`handleSegmentUpdate: ${e}`);let r=this.segmentQueries.get(e);if(t==="invalid"){r.disposer(),console.log(`removing from segmentQueries: ${e} due to invalid`),this.segmentQueries.delete(e);try{this.ignoreVisibleSegmentsChanged=!0,this.segmentsState.visibleSegments.delete(r.id),this.segmentsState.temporaryVisibleSegments.delete(r.id)}finally{this.ignoreVisibleSegmentsChanged=!1}r.addedEquivalences&&this.segmentEquivalencesChanged();return}if(t==="error"){r.current=void 0,r.addedEquivalences&&this.segmentEquivalencesChanged(),console.log(`Error from ${this.graph.serverUrl}/${this.graph.entityName} watching segment ${e}`);return}r.current=t;let i=r.id,a=t.id;if(X.equal(a,i))r.current=t,Uc(r.id)||this.segmentEquivalencesChanged();else{r.id=a;let o=a.toString(),l=this.segmentQueries.get(o);console.log(`removing from segmentQueries: ${e} due to rename -> ${a}`),this.segmentQueries.delete(e);try{this.ignoreVisibleSegmentsChanged=!0,this.segmentsState.visibleSegments.has(i)&&(this.segmentsState.visibleSegments.delete(i),this.segmentsState.visibleSegments.add(a)),this.segmentsState.temporaryVisibleSegments.has(i)&&(this.segmentsState.temporaryVisibleSegments.delete(i),this.segmentsState.temporaryVisibleSegments.add(a))}finally{this.ignoreVisibleSegmentsChanged=!1}l===void 0?(console.log(`adding to segmentQueries due to rename -> ${a}`),this.segmentQueries.set(o,r),this.segmentEquivalencesChanged()):(t.lastLogId!==null&&(typeof l.current!="object"||l.current.lastLogId===null||X.less(l.current.lastLogId,t.lastLogId))&&(l.current=t,this.segmentEquivalencesChanged()),r.disposer())}}visibleSegmentsChanged(){let{segmentsState:e}=this,{segmentQueries:t}=this,r=++sM,i=a=>{for(let o of a.unsafeKeys()){if(X.equal(o,ab))continue;let l=o.toString(),c=t.get(l);if(c!==void 0){c.seenGeneration=r;continue}this.registerVisibleSegment(o.clone())}};i(e.visibleSegments),i(e.temporaryVisibleSegments);for(let[a,o]of t)o.seenGeneration!==r&&(console.log(`removing from segmentQueries due to seenGeneration: ${a}`),t.delete(a),o.disposer(),o.addedEquivalences&&this.segmentEquivalencesChanged())}},cM=class extends sl{constructor(e,t,r){super();this.chunkManager=e;this.serverUrl=t;this.entityName=r;this.startingWebsocket=!1;this.websocket=void 0;this.watchesById=new Map;this.watches=new Set;this.nextWatchId=0;this.numOpenFailures=0}get visibleSegmentEquivalencePolicy(){return Kt.MAX_REPRESENTATIVE|Kt.REPRESENTATIVE_EXCLUDED}startWebsocket(){if(this.startingWebsocket||this.watches.size===0)return;this.startingWebsocket=!0;let e=new Ee(!this.numOpenFailures);e.setText(`Opening websocket connection for nggraph://${this.serverUrl}/${this.entityName}`),(async()=>{let{numOpenFailures:t}=this;if(t>1){let o=1e3*Math.min(16,2**t);await new Promise(l=>setTimeout(l,o))}let r=(await Ix(this.chunkManager,this.serverUrl,this.entityName).get()).credentials,i=new URL("/graph/watch/"+encodeURIComponent(r.token),this.serverUrl);i.protocol=i.protocol.replace("http","ws");let a=new WebSocket(i.href);a.onclose=()=>{e!==void 0&&(e.dispose(),e=void 0),++this.numOpenFailures,this.websocket=void 0,this.startingWebsocket=!1,this.watchesById.clear(),this.startWebsocket()},a.onopen=()=>{e!==void 0&&(e.dispose(),e=void 0),this.numOpenFailures=0,this.websocket=a,this.nextWatchId=0;try{for(let o of this.watches){a.send(JSON.stringify({watch:{segment_id:o.segment.toString()}}));let l=this.nextWatchId++;o.watchId=l,this.watchesById.set(l,o)}}catch{}},a.onmessage=o=>{let l,c;try{let d=JSON.parse(o.data);Q(d);let p=U(d,"watch_id",ze),h=this.watchesById.get(p);if(h===void 0)return;c=h;let g=U(d,"state",Z);g==="invalid"||g==="error"?l=g:l=U(d,"info",rj)}catch(d){console.log(`Received unexpected websocket message from ${this.serverUrl}:`,o.data,d);return}console.log("got update",l),c.callback(l)}})()}connect(e){let t=e.displayState.segmentationGroupState.value;return new lM(this,t)}trackSegment(e,t){return this.watchSegment(e,r=>{if(r==="invalid")t(null);else{if(r==="error")return;t(r.id)}})}watchSegment(e,t){let r={callback:t,segment:e,watchId:-1};this.watches.add(r);let{websocket:i}=this;if(i!==void 0)try{i.send(JSON.stringify({watch:{segment_id:e.toString()}}));let o=this.nextWatchId++;r.watchId=o,this.watchesById.set(o,r)}catch{}else this.startWebsocket();return()=>{let{websocket:o}=this;if(o!==void 0&&o.readyState===WebSocket.OPEN){let l=r.watchId;this.watchesById.delete(l);try{o.send(JSON.stringify({unwatch:{watch_id:l}}))}catch{}}this.watches.delete(r)}}async merge(e,t){let r=await Ax(this.chunkManager,this.serverUrl,this.entityName,"/graph/mutate",{body:JSON.stringify({merge:{anchor:e.toString(),other:t.toString()}}),headers:{"Content-Type":"application/json"},method:"POST"});return Q(r),U(r,"merged",i=>X.parseString(i))}async split(e,t){let r=await Ax(this.chunkManager,this.serverUrl,this.entityName,"/graph/mutate",{body:JSON.stringify({split:{include:e.toString(),exclude:t.toString()}}),headers:{"Content-Type":"application/json"},method:"POST"});return Q(r),{include:U(r,"include",i=>X.parseString(i)),exclude:U(r,"exclude",i=>X.parseString(i))}}};function uM(n){let e=n.match(nj);if(e===null)throw new Error(`Invalid nggraph url: ${JSON.stringify(n)}`);return{serverUrl:e[1],id:e[2]}}function Px(n,e,t,r,i=St){return ts(n,`${e}${t}`,r,kt,(a,o)=>{let l=new Headers(o.headers);return l.set("Authorization",a.token),{...o,headers:l}},a=>{let{status:o}=a;if(o===401)return"refresh";throw a},i)}function ij(n,e,t,r,i=St){return Px(pM(n,e),e,t,r,i)}var dM=class extends ms{constructor(e,t,r){super();this.parentCredentialsProvider=e;this.serverUrl=t;this.entityName=r;this.get=eg(async()=>{let e=await Px(this.parentCredentialsProvider,this.serverUrl,"/entity_token",{body:JSON.stringify({entity:this.entityName}),headers:{"Content-Type":"application/json"},method:"POST"});return{token:e.token,entityType:e.entity_type,role:e.role}})}};function pM(n,e){return n.memoize.getUncounted({type:"nggraph:credentialsProvider",serverUrl:e},()=>new kx(e))}function Ix(n,e,t){return n.memoize.getUncounted({type:"nggraph:entityCredentialsProvider",serverUrl:e,entityName:t},()=>new dM(pM(n,e),e,t))}function Ax(n,e,t,r,i,a=St){return Px(Ix(n,e,t),e,r,i,a)}function aj(n){return Q(n),U(n,"entities",e=>ge(e,t=>{Q(t);let r=U(t,"entity",Z),i=U(t,"entity_type",Z),a=U(t,"access_role",Z);return{id:r,entityType:i,accessRole:a}}))}var Mx=class extends Rt{get description(){return"nggraph data source"}get(e){let{serverUrl:t,id:r}=uM(e.providerUrl);return e.chunkManager.memoize.getUncounted({type:"nggraph:get",serverUrl:t,id:r},async()=>{let i=Ix(e.chunkManager,t,r),{entityType:a}=(await i.get()).credentials;if(a!="graph")throw new Error(`Unsupported entity type: ${JSON.stringify(a)}`);let{datasource_url:o}=await Ax(e.chunkManager,t,r,"/graph/config",{method:"POST"}),l=await e.registry.get({...e,url:o}),c=new cM(e.chunkManager,t,r),d=[...l.subsources,{id:"graph",default:!0,subsource:{segmentationGraph:c}}];return{modelTransform:l.modelTransform,subsources:d}})}async completeUrl(e){let{serverUrl:t,id:r}=uM(e.providerUrl),i=await e.chunkManager.memoize.getUncounted({type:"nggraph:list",serverUrl:t},async()=>aj(await ij(e.chunkManager,t,"/list",{method:"POST"})));return{offset:t.length+1,completions:cn(r,i,a=>a.id,a=>`${a.entityType} (${a.accessRole})`)}}};Ft("nggraph",()=>new Mx);var Sp=1,fM;(function(r){r[r.RAW=0]="RAW",r[r.JPEG=1]="JPEG",r[r.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION"})(fM||(fM={}));var hM=class{};hM.RPC_ID="graphene/VolumeChunkSource";var ig=class{};ig.RPC_ID="graphene/ChunkedGraphSource";var ag=class{};ag.RPC_ID="graphene/MeshSource";var og=async n=>n;function mM(n,e){let t=X.rshift(new X,n,64-e);return X.equal(t,X.ONE)}function gM(n){if(n.charAt(0)==="~"){let t=n.substring(1).split(/:(.+)/);return{key:t[0],fragmentId:t[1]}}else return{key:n,fragmentId:n}}var yM="ChunkedGraphLayer",vM="ChunkedGraphLayer:updateSources";function SM(n){let{rank:e,dataType:t}=n,{baseVoxelOffset:r=new Float32Array(e)}=n;return{...$o(n),baseVoxelOffset:r,dataType:t}}function Il(n){try{return n()}catch(e){return{error:e.message}}}function bp(n){if(n.error!==void 0)throw new Error(n.error);return n}var Rx=Ye(gt());var oj=/^[A-Z]$/,_x=class extends H{constructor(e,t){super();this.tool=e;this.inputEventMapBinder=t}bindAction(e,t){this.registerDisposer(ce(window,e,t))}bindInputEventMap(e){this.inputEventMapBinder(e,this)}cancel(){this==this.tool.layer.manager.root.toolBinder.activeTool_&&this.tool.layer.manager.root.toolBinder.deactivate_()}},Br=class extends H{constructor(e,t=!1){super();this.layer=e;this.toggle=t;this.changed=new $e;this.keyBinding=void 0}get mouseState(){return this.layer.manager.root.layerSelectedValues.mouseState}unbind(){let{layer:e}=this,{keyBinding:t}=this;t!==void 0&&e.toolBinder.set(t,void 0)}},xp=class extends H{constructor(e){super();this.layer=e;this.changed=new $e}get mouseState(){return this.layer.manager.root.layerSelectedValues.mouseState}deactivate(){}unbind(){let{layer:e}=this;e.tool.value===this&&(e.tool.value=void 0)}};function bM(n,e){var i;if(e===void 0)return;typeof e=="string"&&(e={type:e}),Q(e);let t=U(e,"type",Z),r=(i=Vx.get(n.constructor))==null?void 0:i.get(t);if(r===void 0&&(r=lj.get(t)),r===void 0)throw new Error(`Invalid tool type: ${JSON.stringify(e)}.`);return r(n,e)}function sj(n,e){if(e===void 0)return;typeof e=="string"&&(e={type:e}),Q(e);let t=U(e,"type",Z),r=xM.get(t);if(r===void 0)throw new Error(`Invalid tool type: ${JSON.stringify(e)}.`);return r(n,e)}var xM=new Map,lj=new Map,Vx=new Map;function Cp(n,e){xM.set(n,e)}function Si(n,e,t){let r=Vx.get(n);r===void 0&&(r=new Map,Vx.set(n,r)),r.set(e,t)}var Ox=class extends H{constructor(e){super();this.layer=e;this.changed=new $e}get value(){return this.value_}set value(e){e!==this.value_&&(this.unregister(),e!==void 0&&(e.changed.add(this.changed.dispatch),this.value_=e),this.changed.dispatch())}unregister(){let e=this.value_;e!==void 0&&(e.changed.remove(this.changed.dispatch),e.dispose(),this.value_=void 0)}disposed(){this.unregister(),super.disposed()}restoreState(e){this.value=sj(this.layer,e)}reset(){this.value=void 0}toJSON(){let e=this.value_;if(e!==void 0)return e.toJSON()}},Nx=class extends H{constructor(e){super();this.inputEventMapBinder=e;this.bindings=new Map;this.changed=new $e;this.debounceDeactivate=this.registerCancellable((0,Rx.default)(()=>this.deactivate_(),100));this.debounceReactivate=this.registerCancellable((0,Rx.default)(()=>this.reactivateQueuedTool(),100))}get(e){return this.bindings.get(e)}set(e,t){let{bindings:r}=this,i=r.get(e);if(i!==void 0){i.keyBinding=void 0,r.delete(e);let a=i.layer.toolBinder;a.bindings.delete(e),a.jsonToKey.delete(JSON.stringify(i.toJSON())),this.destroyTool(i),a.changed.dispatch()}if(t!==void 0){let a=t.layer.toolBinder,o=JSON.stringify(t.toJSON()),l=a.jsonToKey.get(o);if(l!==void 0){let c=a.bindings.get(l);c.keyBinding=void 0,r.delete(l),a.bindings.delete(l),a.jsonToKey.delete(o),this.destroyTool(c)}a.bindings.set(e,t),t.keyBinding=e,a.jsonToKey.set(o,e),r.set(e,t),a.changed.dispatch()}this.changed.dispatch()}activate(e){let t=this.get(e);if(t===void 0){this.deactivate_();return}this.debounceDeactivate.cancel(),this.debounceReactivate.cancel();let r=this.activeTool_;if(t===(r==null?void 0:r.tool)){t.toggle&&this.deactivate_();return}else r!==void 0&&(r.tool.toggle&&!t.toggle&&(this.queuedTool=r.tool),this.deactivate_());let i=new _x(t,this.inputEventMapBinder);if(this.activeTool_=i,!t.toggle){let a=`Key${e}`;i.registerEventListener(window,"keyup",o=>{o.code===a&&(this.debounceDeactivate(),this.debounceReactivate())}),i.registerEventListener(window,"blur",()=>{this.debounceDeactivate(),this.debounceReactivate()})}return t.activate(i),t}reactivateQueuedTool(){if(this.queuedTool){let e=new _x(this.queuedTool,this.inputEventMapBinder);this.activeTool_=e,this.queuedTool.activate(e),this.queuedTool=void 0}}destroyTool(e){var t;this.queuedTool===e&&(this.queuedTool=void 0),((t=this.activeTool_)==null?void 0:t.tool)===e&&this.deactivate_(),e.dispose()}disposed(){this.deactivate_(),super.disposed()}deactivate_(){this.debounceDeactivate.cancel();let e=this.activeTool_;e!==void 0&&(this.activeTool_=void 0,e.dispose())}},Bx=class{constructor(e){this.layer=e;this.bindings=new Map;this.jsonToKey=new Map;this.changed=new $e;e.registerDisposer(()=>this.clear())}get globalBinder(){return this.layer.manager.root.toolBinder}get(e){return this.bindings.get(e)}set(e,t){this.globalBinder.set(e,t)}setJson(e,t){let r=bM(this.layer,t);r!==void 0&&this.set(e,r)}removeJsonString(e){let t=this.jsonToKey.get(e);t!==void 0&&this.set(t,void 0)}toJSON(){let{bindings:e}=this;if(e.size===0)return;let t={};for(let[r,i]of e)t[r]=i.toJSON();return t}clear(){let{globalBinder:e,bindings:t}=this;if(t.size!==0){for(let[r,i]of t)i.keyBinding=void 0,e.bindings.delete(r),e.destroyTool(i);t.clear(),this.jsonToKey.clear(),e.changed.dispatch(),this.changed.dispatch()}}reset(){this.clear()}restoreState(e){if(e!==void 0){Q(e);for(let[t,r]of Object.entries(e)){if(!t.match(oj))throw new Error(`Invalid tool key: ${JSON.stringify(t)}`);let i=bM(this.layer,r);if(i===void 0)return;this.set(t,i)}}}},sg=class extends H{constructor(e,t){super();this.layer=e;this.toolJson=t;this.element=document.createElement("div");this.toolJsonString=JSON.stringify(this.toolJson);let{element:r}=this;r.classList.add("neuroglancer-tool-key-binding"),this.registerDisposer(e.toolBinder.changed.add(this.registerCancellable(We(()=>this.updateView())))),this.updateView(),r.title="click \u2192 bind key, dbclick \u2192 unbind",r.addEventListener("dblclick",()=>{this.layer.toolBinder.removeJsonString(this.toolJsonString)}),Fx(this,r,i=>this.layer.toolBinder.setJson(i,this.toolJson))}updateView(){let{toolBinder:e}=this.layer,t=e.jsonToKey.get(this.toolJsonString);this.element.textContent=t!=null?t:" "}};function Fx(n,e,t){let r;e.addEventListener("mousedown",i=>{if(i.button!==0||r!==void 0)return;i.preventDefault(),i.stopPropagation(),r=new H,n.registerDisposer(r),r.registerDisposer(new Ee(!1)).setText("Press A-Z to bind key"),r.registerEventListener(window,"keydown",o=>{let{code:l}=o,c=l.match(/^Key([A-Z])$/);if(c===null)return;o.stopPropagation(),o.preventDefault();let d=c[1];t(d)},{capture:!0}),r.registerEventListener(window,"mouseup",o=>{o.button!==0||r===void 0||(o.preventDefault(),o.stopPropagation(),n.unregisterDisposer(r),r.dispose(),r=void 0)})}),e.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation()})}function Al(n,e,t){let r=document.createElement("div");r.classList.add("neuroglancer-tool-button"),r.appendChild(n.registerDisposer(new sg(e,t.toolJson)).element);let i=document.createElement("div");return i.classList.add("neuroglancer-tool-button-label"),i.textContent=t.label,t.title&&(i.title=t.title),r.appendChild(i),r}function cj(n){let e=n.registerDisposer(new Ee(!1));e.element.classList.add("neuroglancer-tool-status");let t=document.createElement("div");t.classList.add("neuroglancer-tool-status-content"),e.element.appendChild(t);let{inputEventMapBinder:r}=n;return n.inputEventMapBinder=(i,a)=>{let o=document.createElement("div");o.textContent=i.describe(),o.classList.add("neuroglancer-tool-status-bindings"),e.element.appendChild(o),r(i,a)},{message:e,content:t}}function Ma(n){let{message:e,content:t}=cj(n),r=document.createElement("div");r.classList.add("neuroglancer-tool-status-header");let i=document.createElement("div");i.classList.add("neuroglancer-tool-status-header-container"),i.appendChild(r),t.appendChild(i);let a=document.createElement("div");return a.classList.add("neuroglancer-tool-status-body"),t.appendChild(a),{message:e,body:a,header:r}}var vg=Ye(gt()),iR=Ye(Ml());function hj(n){return typeof n=="boolean"?{enabled:n}:(Q(n),{enabled:ie(n,"enabled",ha)})}function Rl(n,e=void 0){return typeof n=="string"?{url:n,transform:e,enableDefaultSubsources:!0,subsources:new Map}:(Q(n),{url:U(n,"url",Z),transform:U(n,"transform",bS)||e,enableDefaultSubsources:ie(n,"enableDefaultSubsources",ha,!0),subsources:ie(n,"subsources",t=>Ii(t,hj),new Map),state:ie(n,"state",Q)})}function mj(n){return n.enabled}function wM(n){let e=xS(n.transform),t={},r=!0;for(let[i,a]of n.subsources){let o=mj(a);o!==void 0&&(t[i]=o,r=!1)}return e===void 0&&r&&n.enableDefaultSubsources===!0&&n.state===void 0?n.url:{url:n.url,transform:e,subsources:r?void 0:t,enableDefaultSubsources:n.enableDefaultSubsources===!0?void 0:!1,state:n.state}}var TM=class{constructor(e,t,r,i,a){this.loadedDataSource=e;this.subsourceEntry=t;this.subsourceSpec=r;this.subsourceIndex=i;this.activated=void 0;this.guardValues=[];this.messages=new Ui;this.isActiveChanged=new ne;let o;r===void 0||r.enabled===void 0?o=t.default&&a:o=r.enabled;let l=e.dataSource.modelTransform.sourceRank,{modelSubspaceDimensionIndices:c}=t;if(c===void 0){c=new Array(l);for(let p=0;p<l;++p)c[p]=p}let{subsourceToModelSubspaceTransform:d=Yt(Float32Array,c.length+1)}=t;this.enabled=o,this.subsourceToModelSubspaceTransform=d,this.modelSubspaceDimensionIndices=c,this.isActiveChanged.add(e.activatedSubsourcesChanged.dispatch)}activate(e,...t){if(this.messages.clearMessages(),this.activated!==void 0){if(xe(t,this.guardValues))return;this.activated.dispose()}this.guardValues=t;let r=this.activated=new H;e(r),this.isActiveChanged.dispatch()}deactivate(e){this.messages.clearMessages(),this.messages.addMessage({severity:vr.error,message:e});let{activated:t}=this;t!==void 0&&(this.activated=void 0,t.dispose(),this.isActiveChanged.dispatch())}addRenderLayer(e){let t=this.activated;t.registerDisposer(this.loadedDataSource.layer.addRenderLayer(e)),t.registerDisposer(this.messages.addChild(e.messages))}getRenderLayerTransform(e){let t=this.activated,{layer:r,transform:i}=this.loadedDataSource;return t.registerDisposer(Ph(r.manager.root.coordinateSpace,r.localPosition.coordinateSpace,i,this,e))}},lg=class extends H{constructor(e,t,r){super();this.layerDataSource=e;this.dataSource=t;this.error=void 0;this.enabledSubsourcesChanged=new ne;this.activatedSubsourcesChanged=new ne;this.messages=new Ui;t.canChangeModelSpaceRank?(this.transform=new Lh(vt(Oe({rank:0,scales:new Float64Array(0),units:[],names:[]})),!0),this.transform.value=t.modelTransform):this.transform=new Lh(t.modelTransform),r.transform!==void 0&&(this.transform.spec=r.transform);let i=r.subsources;this.enableDefaultSubsources=r.enableDefaultSubsources,this.subsources=t.subsources.map((a,o)=>new TM(this,a,i.get(a.id),o,this.enableDefaultSubsources))}get enabledSubsources(){return this.subsources.filter(e=>e.enabled)}get layer(){return this.layerDataSource.layer}disposed(){for(let e of this.subsources){let{activated:t}=e;t!==void 0&&(e.activated=void 0,t.dispose())}}},Ux=class extends H{constructor(e,t=void 0){super();this.layer=e;this.changed=new ne;this.messages=new Ui;this.loadState_=void 0;this.specGeneration=-1;this.refCounted_=void 0;this.registerDisposer(this.changed.add(e.dataSourcesChanged.dispatch)),t===void 0?this.spec_=qh():this.spec=t}get spec(){let{loadState:e}=this;if(e!==void 0&&e.error===void 0){let t=this.changed.count;t!==this.specGeneration&&(this.specGeneration=t,this.spec_={url:this.spec.url,transform:e.transform.spec,enableDefaultSubsources:e.enableDefaultSubsources,subsources:new Map(Array.from(e.subsources,r=>{let i=e.enableDefaultSubsources&&r.subsourceEntry.default;return[r.subsourceEntry.id,{enabled:r.enabled!==i?r.enabled:void 0}]})),state:this.spec.state})}return this.spec_}get loadState(){return this.loadState_}set spec(e){let{layer:t}=this;if(this.messages.clearMessages(),e.url.length===0){if(t.dataSources.length!==1){let c=t.dataSources.indexOf(this);if(c!==-1){t.dataSources.splice(c,1),t.dataSourcesChanged.dispatch(),this.dispose();return}}this.spec_=e,this.refCounted_!==void 0&&(this.refCounted_.dispose(),this.refCounted_=void 0,this.loadState_=void 0,this.changed.dispatch());return}let r=new H,i=r.registerDisposer(Uf(t.markLoading()));this.refCounted_!==void 0&&(this.refCounted_.dispose(),this.loadState_=void 0),this.refCounted_=r,this.spec_=e;let a=t.manager.chunkManager,o=t.manager.dataSourceProviderRegistry,l=new Qa;this.messages.addMessage({severity:vr.info,message:"Loading data source"}),o.get({chunkManager:a,url:e.url,cancellationToken:l,globalCoordinateSpace:t.manager.root.coordinateSpace,transform:e.transform,state:e.state}).then(c=>{if(r.wasDisposed)return;this.messages.clearMessages();let d=r.registerDisposer(new lg(this,c,e));d.registerDisposer(t.addCoordinateSpace(d.transform.outputSpace)),d.registerDisposer(d.transform.changed.add(this.changed.dispatch)),this.loadState_=d,d.registerDisposer(d.enabledSubsourcesChanged.add(this.changed.dispatch)),this.changed.dispatch(),c.state&&r.registerDisposer(c.state.changed.add(()=>{var p;this.spec.state=(p=c.state)==null?void 0:p.toJSON(),t.specificationChanged.dispatch()})),i()}).catch(c=>{this.wasDisposed||(this.loadState_={error:c},this.messages.clearMessages(),this.messages.addMessage({severity:vr.error,message:c.message}),this.changed.dispatch())}),r.registerDisposer(()=>{l.cancel()}),this.changed.dispatch()}disposed(){let e=this.refCounted_;e!==void 0&&e.dispose()}toJSON(){let{loadState:e}=this;return e===void 0||e.error!==void 0?wM(this.spec):wM({url:this.spec.url,transform:e.transform.spec,enableDefaultSubsources:e.enableDefaultSubsources,subsources:new Map(Array.from(e.subsources,t=>{let r=e.enableDefaultSubsources&&t.subsourceEntry.default;return[t.subsourceEntry.id,{enabled:t.enabled!==r?t.enabled:void 0}]})),state:this.spec.state})}};var $t;(function(r){r[r.LINKED=0]="LINKED",r[r.RELATIVE=1]="RELATIVE",r[r.UNLINKED=2]="UNLINKED"})($t||($t={}));var cg;(function(t){t[t.LINKED=0]="LINKED",t[t.UNLINKED=2]="UNLINKED"})(cg||(cg={}));var LM=class extends cs{constructor(e=0){super($t,e)}},kM=class extends cs{constructor(e=0){super(cg,e)}},ug=K.create(),EM=Qe.create();function wp(n,e,t,r){let i=!1,a=!1,o;n.registerDisposer(e);let l=()=>{if(!a){switch(i=!0,t.value){case 2:if(r.isValid(n))break;case 0:r.assign(n,e);break;case 1:r.add(n,e,o);break}i=!1}},c=()=>{if(!i)switch(t.value){case 2:break;case 0:r.assign(e,n);break;case 1:r.subtract(e,n,o);break}},d=2,p=()=>{let h=t.value;if(h!==d)switch(h){case 2:o=void 0;break;case 0:o=void 0,r.assign(n,e);break;case 1:o=r.difference(n,e);break}d=h,n.changed.dispatch()};return n.registerDisposer(n.changed.add(c)),n.registerDisposer(e.changed.add(l)),n.registerDisposer(t.changed.add(p)),p(),n}function DM(n,e,t,r){return wp(n,e,t,r)}var qi=class extends H{constructor(e){super();this.coordinateSpace=e;this.coordinates_=Xa;this.changed=new ne;this.registerDisposer(e.changed.add(()=>{this.handleCoordinateSpaceChanged()}))}get valid(){return this.coordinateSpace.value.valid}get value(){return this.handleCoordinateSpaceChanged(),this.coordinates_}reset(){this.curCoordinateSpace=void 0,this.coordinates_=Xa,this.changed.dispatch()}set value(e){let{curCoordinateSpace:t}=this;if(t===void 0||!t.valid||t.rank!==e.length)return;let{coordinates_:r}=this;r.set(e),this.changed.dispatch()}handleCoordinateSpaceChanged(){let e=this.coordinateSpace.value,t=this.curCoordinateSpace;if(e===t)return;this.curCoordinateSpace=e;let{rank:r}=e;if(!e.valid)return;if(t===void 0||!t.valid){let{coordinates_:p}=this;if(!(p!==void 0&&p.length===r)){p=this.coordinates_=new Float32Array(r),ZE(p,e.bounds);for(let h=0;h<r;++h)p[h]=Math.floor(p[h])+.5}this.changed.dispatch();return}let i=new Float32Array(r),a=this.coordinates_,{ids:o,scales:l}=e,{ids:c,scales:d}=t;for(let p=0;p<r;++p){let h=o[p],g=c.indexOf(h);g===-1?i[p]=fS(e.bounds.lowerBounds[p],e.bounds.upperBounds[p]):i[p]=a[g]*(d[g]/l[p])}this.coordinates_=i,this.changed.dispatch()}toJSON(){if(!this.valid&&this.coordinates_.length===0)return;this.handleCoordinateSpaceChanged();let{value:e}=this;if(e.length!==0)return Array.from(e)}restoreState(e){if(e===void 0){this.reset();return}this.curCoordinateSpace=void 0,this.coordinates_=Float32Array.from(ge(e,Ke)),this.handleCoordinateSpaceChanged(),this.changed.dispatch()}snapToVoxel(){this.handleCoordinateSpaceChanged();let{coordinates_:e}=this,t=e.length;for(let r=0;r<t;++r)e[r]=Math.floor(e[r])+.5;this.changed.dispatch()}assign(e){e.handleCoordinateSpaceChanged();let{curCoordinateSpace:t,coordinates_:r}=e;this.curCoordinateSpace=t,this.coordinates_=Float32Array.from(r),this.changed.dispatch()}static getOffset(e,t){let r=e.coordinates_,i=t.coordinates_;if(r.length===i.length)return vh(new Float32Array(r.length),r,i)}static addOffset(e,t,r,i=1){e.handleCoordinateSpaceChanged();let{value:a}=t;r!==void 0&&a.length===r.length&&(zE(e.value,a,r,i),e.changed.dispatch())}get legacyJsonView(){let e=this;return{changed:e.changed,toJSON(){return e.toJSON()},reset(){e.reset()},restoreState(t){if(t===void 0||Array.isArray(t)){e.restoreState(t);return}Q(t),dn(t,"voxelCoordinates",e)}}}};function PM(n,e,t){if(t===void 0||Object.keys(t).length===0){n.value=0;return}Q(t),n.value=2,U(t,"value",r=>{r!==void 0&&e.restoreState(r)}),U(t,"link",r=>n.restoreState(r))}var iu=class{constructor(e,t=new LM){this.peer=e;this.link=t}get changed(){return this.value.changed}toJSON(){let{link:e}=this;if(e.value!==0)return{link:e.toJSON(),value:this.getValueJson()}}getValueJson(){return this.value.toJSON()}reset(){this.link.value=0}restoreState(e){PM(this.link,this.value,e)}copyToPeer(){this.link.value!==0&&(this.link.value=2,this.peer.assign(this.value),this.link.value=0)}},Gx=class extends iu{constructor(e,t=new kM){super(e,t)}},Tp=class extends iu{constructor(){super(...arguments);this.value=wp(new qi(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:e=>e.valid,difference:qi.getOffset,add:qi.addOffset,subtract:(e,t,r)=>{qi.addOffset(e,t,r,-1)}})}};function gj(n){return n[0]===0&&n[1]===0&&n[2]===0&&n[3]===1}var go=class extends H{constructor(e){super();this.changed=new ne;e==null&&(e=Qe.create()),this.orientation=e}toJSON(){let{orientation:e}=this;if(Qe.normalize(this.orientation,this.orientation),!gj(e))return Array.prototype.slice.call(this.orientation)}restoreState(e){try{Tc(this.orientation,e),Qe.normalize(this.orientation,this.orientation)}catch(t){Qe.identity(this.orientation)}this.changed.dispatch()}reset(){Qe.identity(this.orientation),this.changed.dispatch()}snap(){let e=It.create();It.fromQuat(e,this.orientation);let t=[!1,!1,!1];for(let r=0;r<3;++r){let i=0,a=0;for(let o=0;o<3;++o){let l=e[r*3+o];e[r*3+o]=0,!t[o]&&Math.abs(l)>Math.abs(i)&&(i=l,a=o)}e[r*3+a]=Math.sign(i),t[a]=!0}Qe.fromMat3(this.orientation,e),this.changed.dispatch()}static makeRelative(e,t){let r=new go(Qe.multiply(Qe.create(),e.orientation,t)),i=!1;r.registerDisposer(e.changed.add(()=>{i||(a=!0,Qe.multiply(r.orientation,e.orientation,t),r.changed.dispatch(),a=!1)}));let a=!1,o=Qe.invert(Qe.create(),t);return r.registerDisposer(r.changed.add(()=>{a||(i=!0,Qe.multiply(e.orientation,r.orientation,o),e.changed.dispatch(),i=!1)})),r}assign(e){Qe.copy(this.orientation,e.orientation),this.changed.dispatch()}},au=class extends iu{constructor(){super(...arguments);this.value=wp(new go,this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:()=>!0,difference:(e,t)=>{let r=Qe.create();return Qe.multiply(r,Qe.invert(r,t.orientation),e.orientation)},add:(e,t,r)=>{Qe.multiply(e.orientation,t.orientation,r),e.changed.dispatch()},subtract:(e,t,r)=>{Qe.multiply(e.orientation,t.orientation,Qe.invert(EM,r)),e.changed.dispatch()}})}},dg=class extends H{constructor(e){super();this.coordinateSpace=e;this.changed=new ne;this.curCoordinateSpace=Xr;this.value_={factors:new Float64Array(0)};this.registerDisposer(e.changed.add(()=>this.update())),this.update()}get value(){return this.update()}reset(){this.value_={factors:new Float64Array(0)},this.curCoordinateSpace=Xr,this.changed.dispatch()}toJSON(){let e={},t=!1,{value:r}=this,{factors:i}=r,{names:a,rank:o}=this.curCoordinateSpace;for(let l=0;l<o;++l){let c=i[l];c!==1&&(e[a[l]]=c,t=!0)}if(t)return e}restoreState(e){let{coordinateSpace:{value:t}}=this,{names:r,rank:i}=t,a=new Float64Array(i);if(a.fill(-1),e!==void 0){let o=Q(e);for(let l=0;l<i;++l)a[l]=U(o,r[l],c=>c===void 0?1:ot(c))}this.value_={factors:a},this.curCoordinateSpace=t,this.changed.dispatch()}setFactors(e){let{coordinateSpace:{value:t}}=this;e.length===t.rank&&(this.value_={factors:e},this.curCoordinateSpace=t,this.changed.dispatch())}update(){let{coordinateSpace:{value:e}}=this,t=this.value_,{curCoordinateSpace:r}=this;if(r===e)return t;let{ids:i}=r,{ids:a,rank:o}=e,l=t.factors,c=new Float64Array(o);c.fill(1);for(let d=0;d<o;++d){let p=a[d],h=i.indexOf(p);h!==-1&&(c[d]=l[h])}return xe(c,l)||(t=this.value_={factors:c},this.curCoordinateSpace=e,this.changed.dispatch()),t}assign(e){this.setFactors(e.value.factors)}};function IM(n,e,t,r,i){if(t===r)return e;let{ids:a}=t,{rank:o,ids:l}=r,c=new n(o);for(let d=0;d<o;++d){let p=l[d],h=a.indexOf(p);c[d]=h===-1?i(d):e[h]}return c}var Wx=class extends iu{constructor(){super(...arguments);this.value=wp(new dg(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),difference:(e,t)=>{let{factors:r}=e.value,i=e.coordinateSpace.value,a=t.value.factors;return{coordinateSpace:i,offsets:vh(new Float64Array(r.length),r,a)}},add:(e,t,r)=>{let i=IM(Float64Array,r.offsets,r.coordinateSpace,e.coordinateSpace.value,()=>0);e.setFactors(Pc(new Float64Array(i.length),i,t.value.factors))},subtract:(e,t,r)=>{let i=IM(Float64Array,r.offsets,r.coordinateSpace,e.coordinateSpace.value,()=>0);e.setFactors(vh(new Float64Array(i.length),t.value.factors,i))},isValid:()=>!0})}};function AM(n,e,t){let{rank:r,names:i,units:a}=n,{displayRank:o,displayDimensionIndices:l}=e,c=new Float64Array(3),d=new Float64Array(3),p,{factors:h}=t,g=new Array(3),v=new Float64Array(3);if(c.fill(1),d.fill(1),v.fill(1),g.fill(""),o===0)p=1;else{p=Number.POSITIVE_INFINITY;let{scales:b}=n;for(let x=0;x<o;++x){let C=l[x],T=d[x]=h[C]*b[C];p=Math.min(p,T),g[x]=a[C],v[x]=b[C]}for(let x=0;x<o;++x)c[x]=d[x]/p}return{globalRank:r,globalDimensionNames:i,displayRank:o,displayDimensionIndices:l,displayDimensionUnits:g,displayDimensionScales:v,canonicalVoxelFactors:c,voxelPhysicalScales:d,canonicalVoxelPhysicalSize:p}}function yj(n,e){return xe(n.globalDimensionNames,e.globalDimensionNames)&&xe(n.displayDimensionIndices,e.displayDimensionIndices)&&xe(n.canonicalVoxelFactors,e.canonicalVoxelFactors)&&xe(n.voxelPhysicalScales,e.voxelPhysicalScales)&&n.canonicalVoxelPhysicalSize===e.canonicalVoxelPhysicalSize&&xe(n.displayDimensionUnits,e.displayDimensionUnits)&&xe(n.displayDimensionScales,e.displayDimensionScales)}var Lp=class extends H{constructor(e,t){super();this.relativeDisplayScales=e;this.displayDimensions=t;this.changed=new ne;this.curRelativeDisplayScales=this.relativeDisplayScales.value;this.curDisplayDimensions=this.displayDimensions.value;this.curCoordinateSpace=this.relativeDisplayScales.coordinateSpace.value;this.value_=AM(this.curCoordinateSpace,this.curDisplayDimensions,this.curRelativeDisplayScales);this.registerDisposer(e),this.registerDisposer(t);let r=()=>{this.value};this.registerDisposer(e.changed.add(r)),this.registerDisposer(t.changed.add(r))}get value(){let{relativeDisplayScales:{value:e,coordinateSpace:{value:t}},displayDimensions:{value:r},curRelativeDisplayScales:i,curDisplayDimensions:a,curCoordinateSpace:o}=this,l=this.value_;if(i!==e||a!==r||o!==t){this.curRelativeDisplayScales=e,this.curDisplayDimensions=r,this.curCoordinateSpace=t;let c=AM(t,r,e);yj(l,c)||(this.value_=l=c,this.changed.dispatch())}return l}},pg=class extends H{constructor(e){super();this.coordinateSpace=e;this.changed=new ne;this.default_=!0;this.value_=void 0;this.registerDisposer(this.coordinateSpace.changed.add(this.changed.dispatch)),this.update()}get value(){return this.update(),this.value_}update(){let{coordinateSpace:{value:e}}=this,t=this.value_;if(t!==void 0&&t.coordinateSpace===e)return;if(t===void 0||this.default_){this.setToDefault(e);return}let r=new Int32Array(3),{ids:i}=t.coordinateSpace,{ids:a}=e,o=t.displayDimensionIndices,l=t.displayRank,c=0;for(let d=0;d<l;++d){let p=a.indexOf(i[o[d]]);p!==-1&&(r[c]=p,++c)}if(r.fill(-1,c),c===0){this.default_=!0,this.setToDefault(e);return}this.assignValue(e,c,r),this.changed.dispatch()}setToDefault(e){let t=Math.min(e.rank,3),r=new Int32Array(3);r.fill(-1);for(let i=0;i<t;++i)r[i]=i;this.assignValue(e,t,r)}assignValue(e,t,r){this.value_={coordinateSpace:e,displayRank:t,displayDimensionIndices:r},this.changed.dispatch()}reset(){this.default_=!0,this.value_=void 0,this.changed.dispatch()}restoreState(e){if(e===void 0){this.reset();return}let t=Md(e);if(t.length>3)throw new Error("Number of spatial dimensions must be <= 3");let{coordinateSpace:{value:r}}=this,i=new Int32Array(3);i.fill(-1);let{names:a}=r,o=0;for(let l of t){let c=a.indexOf(l);c!==-1&&(i[o++]=c)}if(o===0){this.reset();return}this.default_=!1,this.assignValue(r,o,i)}get default(){return this.update(),this.default_}set default(e){this.default_!==e&&(e?(this.default_=!0,this.setToDefault(this.coordinateSpace.value)):(this.default_=!1,this.changed.dispatch()))}setDimensionIndices(e,t){this.default_=!1,this.assignValue(this.coordinateSpace.value,e,t)}toJSON(){if(this.default_)return;let{value:e}=this,t=[],{displayRank:r,displayDimensionIndices:i,coordinateSpace:{names:a}}=e;if(r!==0){for(let o=0;o<r;++o)t[o]=a[i[o]];return t}}assign(e){if(e.default)this.default=!0;else{let{displayRank:t,displayDimensionIndices:r}=e.value;this.setDimensionIndices(t,r)}}},zx=class extends Gx{constructor(e){super(e);this.value=DM(new pg(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:()=>!0})}},Ra=class extends H{constructor(e,t,r){super();this.position=e;this.displayDimensionRenderInfo=t;this.orientation=r;this.changed=new ne;this.registerDisposer(e),this.registerDisposer(r),this.registerDisposer(t),this.registerDisposer(e.changed.add(this.changed.dispatch)),this.registerDisposer(r.changed.add(this.changed.dispatch)),this.registerDisposer(t.changed.add(this.changed.dispatch))}get displayDimensions(){return this.displayDimensionRenderInfo.displayDimensions}get relativeDisplayScales(){return this.displayDimensionRenderInfo.relativeDisplayScales}get valid(){return this.position.valid}reset(){this.position.reset(),this.orientation.reset(),this.displayDimensions.reset()}updateDisplayPosition(e,t=ug){let{coordinateSpace:{value:r},value:i}=this.position,{displayDimensionIndices:a,displayRank:o}=this.displayDimensions.value;if(r===void 0)return!1;t.fill(0);for(let l=0;l<o;++l){let c=a[l];t[l]=i[c]}if(e(t)!==!1){for(let l=0;l<o;++l){let c=a[l];i[c]=t[l]}return this.position.changed.dispatch(),!0}return!1}toMat4(e,t){oe.fromQuat(e,this.orientation.orientation);let{value:r}=this.position,{canonicalVoxelFactors:i,displayDimensionIndices:a}=this.displayDimensionRenderInfo.value;for(let o=0;o<3;++o){let l=a[o],c=t/i[o];e[o]*=c,e[4+o]*=c,e[8+o]*=c,e[12+o]=r[l]||0}}toMat3(e,t){It.fromQuat(e,this.orientation.orientation);let{canonicalVoxelFactors:r,displayRank:i}=this.displayDimensionRenderInfo.value;for(let a=0;a<i;++a){let o=t/r[a];e[a]*=o,e[3+a]*=o,e[6+a]*=o}}snap(){this.orientation.snap(),this.position.snapToVoxel(),this.changed.dispatch()}translateDimensionRelative(e,t){if(!this.valid)return;let{position:r}=this,{value:i}=r,{bounds:{lowerBounds:a,upperBounds:o}}=r.coordinateSpace.value,l=i[e]+t;if(t>0){let c=o[e];Number.isFinite(c)&&(l=Math.min(l,Math.ceil(c-1)))}else{let c=a[e];Number.isFinite(c)&&(l=Math.max(l,Math.floor(c)))}i[e]=l,r.changed.dispatch()}translateVoxelsRelative(e,t=!1){if(!this.valid)return;let r=K.transformQuat(ug,e,this.orientation.orientation),{position:i}=this,{value:a}=i,{displayDimensionIndices:o,displayRank:l}=this.displayDimensions.value,{bounds:{lowerBounds:c,upperBounds:d}}=i.coordinateSpace.value;for(let p=0;p<l;++p){let h=o[p],g=r[p];if(g===0)continue;let v=a[h]+g;if(g>0){let b=d[h];Number.isFinite(b)&&(v=Math.min(v,Math.ceil(b-1)))}else{let b=c[h];Number.isFinite(b)&&(v=Math.max(v,Math.floor(b)))}t&&(v=Math.floor(v)+.5),a[h]=v}this.position.changed.dispatch()}rotateRelative(e,t){var r=Qe.create();Qe.setAxisAngle(r,e,t);var i=this.orientation.orientation;Qe.multiply(i,i,r),this.orientation.changed.dispatch()}rotateAbsolute(e,t,r){let{coordinateSpace:{value:i},value:a}=this.position;if(i===void 0)return;let{relativeDisplayScales:{value:{factors:o}},displayDimensions:{value:{displayDimensionIndices:l,displayRank:c}}}=this,{scales:d}=i,p=Qe.create();Qe.setAxisAngle(p,e,t);let h=this.orientation.orientation,g=ug;ug.fill(0);for(let b=0;b<c;++b){let x=l[b],C=r[x]-a[x];g[b]=C*d[x]*o[x]}let v=Qe.invert(EM,h);K.transformQuat(g,g,v),Qe.multiply(h,p,h),K.transformQuat(g,g,h);for(let b=0;b<c;++b){let x=l[b];a[x]=r[x]-g[b]/(d[x]*o[x])}this.position.changed.dispatch(),this.orientation.changed.dispatch()}translateNonDisplayDimension(e,t){if(!this.valid)return;let{displayDimensionIndices:r}=this.displayDimensions.value,{position:i}=this,a=i.coordinateSpace.value.rank;for(let o=0;o<a;++o)if(r.indexOf(o)===-1&&e--==0){this.translateDimensionRelative(o,t);return}}},ou=class extends iu{constructor(e,t){super(e);this.value=(()=>{let r=new e.constructor(t),i=(d,p)=>{d.assign(p)},a=(d,p)=>d.value/p.value*(d.canonicalVoxelPhysicalSize/p.canonicalVoxelPhysicalSize),o=(d,p,h)=>{d.setPhysicalScale(p.value*h,p.canonicalVoxelPhysicalSize)},l=(d,p,h)=>{d.setPhysicalScale(p.value/h,p.canonicalVoxelPhysicalSize)},c=d=>d.coordinateSpaceValue.valid&&d.canonicalVoxelPhysicalSize!==0;return wp(r,this.peer,this.link,{assign:i,isValid:c,difference:a,add:o,subtract:l}),r})()}};function _l(n){return{changed:n.changed,toJSON(){return n.toJSON()},restoreState(e){PM(n.link,n.value.legacyJsonView,e)},reset(){n.reset()}}}var Hx=class extends H{constructor(e){super();this.displayDimensionRenderInfo=e;this.changed=new ne;this.curCanonicalVoxelPhysicalSize=0;this.value_=Number.NaN;this.legacyValue_=Number.NaN;this.registerDisposer(e),this.registerDisposer(e.changed.add(()=>this.handleCoordinateSpaceChanged())),this.registerDisposer(e.relativeDisplayScales.coordinateSpace.changed.add(()=>this.handleCoordinateSpaceChanged())),this.handleCoordinateSpaceChanged()}get value(){return this.handleCoordinateSpaceChanged(),this.value_}set value(e){let{canonicalVoxelPhysicalSize:t}=this;Object.is(e,this.value_)&&t===this.curCanonicalVoxelPhysicalSize||(this.curCanonicalVoxelPhysicalSize=t,this.legacyValue_=Number.NaN,this.value_=e,this.changed.dispatch())}get canonicalVoxelPhysicalSize(){return this.displayDimensionRenderInfo.value.canonicalVoxelPhysicalSize}get coordinateSpaceValue(){return this.displayDimensionRenderInfo.relativeDisplayScales.coordinateSpace.value}set legacyValue(e){Object.is(e,this.legacyValue_)||(this.value_=Number.NaN,this.legacyValue_=e,this.curCanonicalVoxelPhysicalSize=0,this.changed.dispatch())}get legacyValue(){return this.legacyValue_}handleCoordinateSpaceChanged(){let{value_:e}=this,{displayDimensionRenderInfo:{value:{canonicalVoxelPhysicalSize:t},relativeDisplayScales:{coordinateSpace:{value:r}}}}=this,{curCanonicalVoxelPhysicalSize:i}=this;if(!(!Number.isNaN(e)&&t===i)){if(!Number.isNaN(e)){i!==0&&(this.value_=e*(i/t),this.curCanonicalVoxelPhysicalSize=t,this.changed.dispatch());return}!r.valid||t===0||(this.curCanonicalVoxelPhysicalSize=t,this.value_=this.getDefaultValue(),this.changed.dispatch())}}toJSON(){let{value:e}=this;return Number.isNaN(e)?void 0:e}restoreState(e){this.curCanonicalVoxelPhysicalSize=0,this.legacyValue_=Number.NaN,e===void 0?this.value_=Number.NaN:this.value_=ot(e),this.changed.dispatch()}reset(){this.curCanonicalVoxelPhysicalSize=0,this.value_=Number.NaN,this.legacyValue_=Number.NaN,this.changed.dispatch()}get legacyJsonView(){let e=this;return{changed:e.changed,toJSON(){return e.toJSON()},reset(){return e.reset()},restoreState(t){e.legacyValue=ot(t)}}}setPhysicalScale(e,t){let r=this.curCanonicalVoxelPhysicalSize=this.canonicalVoxelPhysicalSize;this.value=e*(t/r)}assign(e){let{legacyValue:t}=e;Number.isNaN(t)?this.setPhysicalScale(e.value,e.canonicalVoxelPhysicalSize):this.legacyValue=t}},$x=class extends Hx{getDefaultValue(){let{legacyValue_:e}=this;if(Number.isNaN(e))return 1;let{canonicalVoxelPhysicalSize:t}=this;return this.legacyValue_*1e-9/t}},jx=class extends Hx{getDefaultValue(){let{legacyValue_:e}=this;if(!Number.isNaN(e)){this.legacyValue_=Number.NaN;let{canonicalVoxelPhysicalSize:l}=this;return 2*100*Math.tan(Math.PI/8)*1e-9*e/l}let{coordinateSpaceValue:{bounds:{lowerBounds:t,upperBounds:r}}}=this,{canonicalVoxelFactors:i,displayDimensionIndices:a}=this.displayDimensionRenderInfo.value,o=i.reduce((l,c,d)=>{let p=a[d],h=(r[p]-t[p])*c;return Math.max(l,h)},0);return Number.isFinite(o)?o=2**Math.ceil(Math.log2(o)):o=1024,o}},kp=class extends H{constructor(e,t){super();this.defaultValue=e;this.displayDimensionRenderInfo=t;this.changed=new ne;this.value_=e,this.canonicalVoxelPhysicalSize=t.value.canonicalVoxelPhysicalSize,this.registerDisposer(t.changed.add(()=>{this.value}))}get value(){let{value_:e}=this;if(e>0){let{canonicalVoxelPhysicalSize:t}=this.displayDimensionRenderInfo.value,r=this.canonicalVoxelPhysicalSize;t!==r&&(this.canonicalVoxelPhysicalSize=t,e=this.value_=e=r/t,this.changed.dispatch())}return e}set value(e){if(e===this.value)return;this.value_=e;let{canonicalVoxelPhysicalSize:t}=this.displayDimensionRenderInfo.value;this.canonicalVoxelPhysicalSize=t,this.changed.dispatch()}toJSON(){let{value:e}=this;if(e!==this.defaultValue)return e}reset(){this.value=this.defaultValue}restoreState(e){typeof e!="number"||!Number.isFinite(e)||e===0?this.value=this.defaultValue:this.value=e}setValueAbsolute(e,t){if(e>0){let{canonicalVoxelPhysicalSize:r}=this.displayDimensionRenderInfo.value;e=e*(t/r)}this.value=e}assign(e){this.setValueAbsolute(e.value,e.canonicalVoxelPhysicalSize)}},fg=class extends Gx{constructor(e,t){super(e);this.value=DM(new kp(e.defaultValue,t),this.peer,this.link,{assign:(r,i)=>r.assign(i),isValid:()=>!0})}},_a=class extends H{constructor(e,t,r){super();this.pose=e;this.zoomFactor=t;this.depthRange=r;this.changed=new ne;this.registerDisposer(e),this.registerDisposer(t),this.registerDisposer(r),this.registerDisposer(this.pose.changed.add(this.changed.dispatch)),this.registerDisposer(this.zoomFactor.changed.add(this.changed.dispatch)),this.registerDisposer(this.depthRange.changed.add(this.changed.dispatch))}get coordinateSpace(){return this.pose.position.coordinateSpace}reset(){this.pose.reset(),this.zoomFactor.reset()}get position(){return this.pose.position}get displayDimensions(){return this.pose.displayDimensions}get relativeDisplayScales(){return this.pose.relativeDisplayScales}get displayDimensionRenderInfo(){return this.pose.displayDimensionRenderInfo}toMat4(e){this.pose.toMat4(e,this.zoomFactor.value)}toMat3(e){this.pose.toMat3(e,this.zoomFactor.value)}get relativeDepthRange(){let e=this.depthRange.value;return e>0?e/=this.zoomFactor.value:e*=-1,e}get valid(){return this.pose.valid&&!Number.isNaN(this.zoomFactor.value)}zoomBy(e){this.zoomFactor.value*=e}};var Vl='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="plusIconTitle"><path d="M20 12L4 12M12 4L12 20"></path></svg>';function hg(n={}){return He({svg:Vl,...n})}var MM='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="arrowUpIconTitle"><path d="M18 9l-6-6-6 6"></path><path d="M12 21V4"></path><path stroke-linecap="round" d="M12 3v1"></path></svg>';var Ep=new ke(0);window.addEventListener("keydown",n=>{Ep.value=um(n)});window.addEventListener("keyup",n=>{Ep.value=um(n)});var vj=new Set(["f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12","escape","pause"]),Sj=new Set(["color","date","datetime","datetime-local","email","month","number","password","search","tel","text","time","url","week"]),jt=class extends H{constructor(e,t){super();this.target=e;this.eventMap=t;this.modifierShortcutsAreGlobal=!0;this.allShortcutsAreGlobal=!1;this.allowSpaceKeyOnButtons=!1;this.registerEventListener(e,"keydown",this.handleKeyDown.bind(this),!1)}shouldIgnoreEvent(e,t){var r=t.target;let{tagName:i}=r;if(r===this.target)return!1;var a=i==="TEXTAREA"||i==="INPUT"||i==="BUTTON"||i==="SELECT",o=!a&&(r.isContentEditable||r.ownerDocument&&r.ownerDocument.designMode==="on");return!a&&!o||this.allShortcutsAreGlobal||vj.has(e)?!1:o||this.modifierShortcutsAreGlobal&&(t.altKey||t.ctrlKey||t.metaKey)?!0:i==="INPUT"&&Sj.has(r.type)?e!=="enter":i==="INPUT"||i==="BUTTON"?this.allowSpaceKeyOnButtons?!1:e==="space":!0}handleKeyDown(e){let t=bj(e);this.shouldIgnoreEvent(t,e)||pm(t,e,e,this.eventMap)}};function bj(n){return n.code.toLowerCase()}function Dp(n,e=n.value){n.style.minWidth=e.length+1+"ch"}var RM="neuroglancer-coordinate-space-transform-singleton";function _M(n,e){let t;n===Number.NEGATIVE_INFINITY?t="(-\u221E,":t=`[${Math.floor(n)},`;let r;return e===Number.POSITIVE_INFINITY?r="+\u221E)":r=`${Math.floor(e)})`,{lower:t,upper:r}}var VM=Ie.fromObject({arrowup:{action:"move-up"},arrowdown:{action:"move-down"},arrowleft:{action:"move-left",preventDefault:!1},arrowright:{action:"move-right",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel"}});function OM(){let n=document.createElement("div"),e=document.createElement("input");n.classList.add("neuroglancer-coordinate-space-transform-scale-container"),e.spellcheck=!1,e.autocomplete="off",e.size=1,e.classList.add("neuroglancer-coordinate-space-transform-scale"),n.appendChild(e);let t=document.createElement("div"),r=document.createElement("span");r.innerHTML=MM,t.appendChild(r);let i=document.createTextNode("");return t.appendChild(i),t.classList.add("neuroglancer-coordinate-space-transform-scale-suggestion"),n.appendChild(t),{cellElement:n,inputElement:e,suggestionElement:t}}function NM(n,e,t,r,i){if(e===void 0||e.scale===t&&e.unit===r)n.style.display="none";else{n.style.display="";let a=Ri(e.scale,e.unit,{elide1:!1});n.lastChild.textContent=a,n.title=`${i}${a}`}}function BM(){let n=document.createElement("input");return n.spellcheck=!1,n.autocomplete="off",n.size=1,n.placeholder=" ",n.classList.add("neuroglancer-coordinate-space-transform-output-name"),n}function FM(n,e,t){let r=n.map(g=>Go(g.value));if(r.includes(void 0))return!1;let i=Float64Array.from(r,g=>g.scale),a=Array.from(r,g=>g.unit),o=t.value,{scales:l,units:c,rank:d}=o;for(let g=0;g<d;++g)e[g]||(i[g]=l[g],a[g]=c[g]);if(xe(l,i)&&xe(c,a))return!1;let p=o.timestamps.map((g,v)=>i[v]===l[v]&&a[v]===c[v]?g:Date.now()),h=Oe({valid:o.valid,rank:o.rank,scales:i,units:a,timestamps:p,ids:o.ids,names:o.names,boundingBoxes:o.boundingBoxes,coordinateArrays:o.coordinateArrays});return t.value=h,!0}function UM(n,e,t,r){let i=new Float64Array(n.scales),a=Array.from(n.units);if(i[e]===t&&a[e]===r)return n;let o=Array.from(n.timestamps);return i[e]=t,a[e]=r,o[e]=Date.now(),{...n,scales:i,units:a,timestamps:o}}var Jx=class extends H{constructor(e,t,r){super();this.transform=e;this.localCombiner=t;this.globalCombiner=r;this.element=document.createElement("div");this.coefficientContainer=document.createElement("div");this.translationContainer=document.createElement("div");this.outputNameContainer=document.createElement("div");this.outputScaleContainer=document.createElement("div");this.inputNameContainer=document.createElement("div");this.inputScaleContainer=document.createElement("div");this.inputLowerBoundsContainer=document.createElement("div");this.inputUpperBoundsContainer=document.createElement("div");this.coefficientElements=[];this.inputNameElements=[];this.outputNameElements=[];this.outputScaleElements=[];this.outputScaleSuggestionElements=[];this.inputScaleSuggestionElements=[];this.inputScaleElements=[];this.inputBoundsElements=[];this.outputBoundsElements=[];this.addSourceDimensionIcon=He({svg:Vl,text:"S"});this.addOutputDimensionIcon=He({svg:Vl,text:"V"});this.addOutputDimensionCell=document.createElement("div");this.addOutputDimensionInput=BM();this.inputScaleModified=[];this.outputScaleModified=[];this.curSourceRank=-1;this.curRank=-1;this.curTransform=void 0;this.addingSourceDimension=!1;this.resetToIdentityButton=He({text:"Set to identity",title:"Reset to identity transform",onClick:()=>{let{transform:e}=this,t=e.value.rank;e.transform=Yt(Float64Array,t+1)}});this.resetToDefaultButton=He({text:"Reset to default",title:"Reset to default input scales, transform, and output dimensions.",onClick:()=>{let{transform:e}=this;if(e.mutableSourceRank)return;let{defaultTransform:t}=e,{outputSpace:r}=t,i=r.ids.map(()=>Xs());e.value={...t,outputSpace:{...r,ids:i}}}});let{element:i}=this,a=this.registerDisposer(new jt(i,VM));a.allShortcutsAreGlobal=!0,i.classList.add("neuroglancer-coordinate-space-transform-widget"),this.registerDisposer(new kn(i,VM));let o=We(()=>this.updateView());this.registerDisposer(e.changed.add(o));let{coefficientContainer:l,translationContainer:c,outputNameContainer:d,inputNameContainer:p,inputScaleContainer:h,inputLowerBoundsContainer:g,inputUpperBoundsContainer:v,outputScaleContainer:b,addOutputDimensionCell:x,addOutputDimensionIcon:C,addSourceDimensionIcon:T,resetToIdentityButton:P,resetToDefaultButton:I}=this;l.style.display="contents",c.style.display="contents",d.style.display="contents",p.style.display="contents",h.style.display="contents",b.style.display="contents",g.style.display="contents",v.style.display="contents";let M=document.createElement("div");M.classList.add("neuroglancer-coordinate-space-transform-widget-reset-buttons"),P.classList.add("neuroglancer-coordinate-space-transform-widget-reset-to-identity"),I.classList.add("neuroglancer-coordinate-space-transform-widget-reset-to-default"),M.appendChild(P),M.appendChild(I),i.appendChild(M);for(let[B,z]of[["source","Source dimensions"],["output","Output dimensions"],["input-lower","Lower"],["input-upper","Upper"],["input-scale","Scale"],["translation","Translation"]]){let _=document.createElement("div");_.classList.add(`neuroglancer-coordinate-space-transform-${B}-label`),_.classList.add("neuroglancer-coordinate-space-transform-label"),_.textContent=z,i.appendChild(_)}e.mutableSourceRank&&x.appendChild(T),x.appendChild(C),x.classList.add("neuroglancer-coordinate-space-transform-output-extend");let D="Embed in additional output dimension",E="Extend to additional source dimension";C.title=D,T.title=E,x.appendChild(this.addOutputDimensionInput),x.dataset.isActive="false",C.addEventListener("click",()=>{this.addingSourceDimension=!1,this.addOutputDimensionInput.title=D,this.addOutputDimensionCell.dataset.isActive="true",this.addOutputDimensionInput.focus()}),T.addEventListener("click",()=>{this.addingSourceDimension=!0,this.addOutputDimensionInput.title=E,this.addOutputDimensionCell.dataset.isActive="true",this.addOutputDimensionInput.focus()}),this.addOutputDimensionInput.addEventListener("blur",()=>{this.updateAddOutputDimensionCellStyle()}),i.appendChild(l),i.appendChild(d),i.appendChild(p),i.appendChild(h),i.appendChild(b),i.appendChild(g),i.appendChild(v),l.appendChild(c),i.addEventListener("input",B=>{let{target:z}=B;if(z instanceof HTMLInputElement){Dp(z);let _=this.inputScaleElements.indexOf(z);if(_!==-1){this.inputScaleModified[_]=!0,this.updateScaleValidity(z);return}if(_=this.outputScaleElements.indexOf(z),_!==-1){this.outputScaleModified[_]=!0,this.updateScaleValidity(z);return}if(_=this.outputNameElements.indexOf(z),_!==-1){this.updateOutputNameValidity();return}if(this.coefficientContainer.contains(z)){this.updateCoefficientValidity(z);return}}});let V=(B,z,_)=>{ce(i,B,F=>{F.stopPropagation();let N=F.target;if(!(N instanceof HTMLInputElement)||_!==0&&(N.selectionStart!==N.selectionEnd||N.selectionStart!==(_===1?N.value.length:0)))return;let J=this.getElementGridPosition(N);if(J===void 0)return;let ae=this.getElementByGridPosition(J.row+z,J.col+_);ae!==null&&(ae.focus(),F.preventDefault())})};V("move-up",-1,0),V("move-down",1,0),V("move-left",0,-1),V("move-right",0,1);let O=(B,z)=>{B.addEventListener("focusout",_=>{let{relatedTarget:F}=_;F instanceof Node&&B.contains(F)||z(_)})};O(l,()=>{this.updateModelTransform()||this.updateViewTransformCoefficients()}),O(d,()=>{this.updateModelOutputNames()||this.updateViewOutputNames()}),O(h,()=>{this.updateModelInputScales()||this.updateViewInputScales()}),O(b,()=>{this.updateModelOutputScales()||this.updateViewOutputScales()}),ce(i,"cancel",B=>{this.curTransform=void 0,this.updateView(),B.target.blur()}),ce(l,"commit",()=>{this.updateModelTransform()}),ce(d,"commit",()=>{this.updateModelOutputNames()}),ce(h,"commit",()=>{this.updateModelInputScales()}),ce(b,"commit",()=>{this.updateModelOutputScales()}),i.addEventListener("focusin",B=>{let{target:z}=B;z instanceof HTMLInputElement&&z.select()}),this.updateView()}updateWillBeDeletedAttributes(e){let{rank:t}=this.transform.value;e===void 0&&(e=new Array(t),e.fill(!1));let{coefficientElements:r,inputBoundsElements:i,inputScaleElements:a}=this;for(let o=0;o<t;++o){let l=e[o];for(let p=0;p<=t;++p){let h=r[t*p+o],g=p<t&&e[p];h.dataset.willBeDeleted=(l||g).toString()}a[o].dataset.willBeDeleted=l.toString();let{lower:c,upper:d}=i[o];c.dataset.willBeDeleted=l.toString(),d.dataset.willBeDeleted=l.toString()}}updateAddOutputDimensionCellStyle(){let{addOutputDimensionInput:e}=this;this.addOutputDimensionCell.dataset.isActive=(e.value.length!==0||document.activeElement===e).toString()}updateOutputNameValidity(){let{outputNameElements:e}=this,t=e.map(c=>c.value),{value:{sourceRank:r,rank:i},mutableSourceRank:a}=this.transform;if(e.length!==i+1)return;let o=Ad(t),l=new Array(i);l.fill(!1);for(let c=0;c<=i;++c){let d=o[c];t[c].length===0&&(a||c>=r)&&(d=!0,l[c]=!0),e[c].dataset.isValid=d.toString()}this.updateWillBeDeletedAttributes(l),this.updateAddOutputDimensionCellStyle()}updateScaleValidity(e){let t=Go(e.value)!==void 0;e.dataset.isValid=t.toString()}updateCoefficientValidity(e){let t=Number.isFinite(Number(e.value));e.dataset.isValid=t.toString()}getElementGridPosition(e){{let t=this.outputNameElements.indexOf(e);if(t!==-1)return{row:t,col:-2}}{let t=this.inputScaleElements.indexOf(e);if(t!==-1)return{row:-1,col:t}}{let t=this.coefficientElements.indexOf(e),{rank:r}=this.transform.value;if(t!==-1)return{row:t%r,col:Math.floor(t/r)}}{let t=this.outputScaleElements.indexOf(e);if(t!==-1)return{row:t,col:-1}}}getElementByGridPosition(e,t){let{rank:r}=this.transform.value;return e===-1?t<0||t>=r?null:this.inputScaleElements[t]:t===-2?e<0||e>r?null:this.outputNameElements[e]:t===-1?e<0||e>=r?null:this.outputScaleElements[e]:e<0||e>=r||t<0||t>r?null:this.coefficientElements[t*r+e]}dimensionRefCount(e){return(Wo(e)?this.localCombiner:this.globalCombiner).dimensionRefCounts.get(e)||0}updateModelInputScales(){return FM(this.inputScaleElements,this.inputScaleModified,this.transform.inputSpace)}updateModelOutputScales(){return FM(this.outputScaleElements,this.outputScaleModified,this.transform.outputSpace)}updateModelOutputNames(){let e=this.outputNameElements.map(P=>P.value),{value:t,mutableSourceRank:r}=this.transform,{outputSpace:i,rank:a,sourceRank:o}=t;if(e.length!==a+1)return;let l=[],c=[],d=e[a].length!==0,p=o;for(let P=0;P<=a;++P){let I=e[P];if(I.length===0){if(P<o){if(!r)return!1;--p}continue}c.push(I),l.push(P)}if(!_c(c))return!1;let h=i.names;if(!d&&xe(h,c))return!0;let g=t.inputSpace,v=t.outputSpace,b=t.transform;if(d){this.addingSourceDimension&&++p;let P=e[a],I=(Wo(P)?this.localCombiner:this.globalCombiner).combined.value,M=I.names.indexOf(P),D,E;M!==-1?(D=I.units[M],E=I.scales[M]):(D="",E=1);let V=g.boundingBoxes.map(O=>gS(O,a,a+1));this.addingSourceDimension||V.push(mS(a+1,a)),g=Oe({valid:g.valid,rank:a+1,names:[...g.names,""],ids:[...g.ids,Xs()],timestamps:[...g.timestamps,Date.now()],scales:Float64Array.from([...g.scales,E]),units:[...g.units,D],boundingBoxes:V,coordinateArrays:[...g.coordinateArrays,void 0]}),v=Oe({valid:i.valid,rank:a+1,names:[...i.names,P],ids:[...i.ids,Xs()],timestamps:[...i.timestamps,Date.now()],scales:Float64Array.from([...i.scales,E]),units:[...i.units,D],coordinateArrays:[...i.coordinateArrays,void 0]}),b=Pd(new Float64Array((a+2)**2),a+1,b,a)}b=kh(Float64Array,b,g.rank,l,l),g=Eh(g,l),v=Eh(v,l);let x=v.ids.map((P,I)=>{let M=l[I];if(M===a)return P;let D=c[I],E=h[M];return D===E||this.dimensionRefCount(E)===1&&this.dimensionRefCount(D)===(h.includes(D)?1:0)?P:Xs()}),C=v.timestamps.map((P,I)=>{let M=l[I];return M===a||c[I]===h[M]?P:Date.now()});v={...v,names:c,ids:x,timestamps:C};let T={rank:v.rank,sourceRank:p,outputSpace:v,inputSpace:g,transform:b};return this.transform.value=T,!0}updateModelTransform(){let e=this.coefficientElements,{rank:t}=this.transform.value,r=new Float64Array((t+1)**2);r[r.length-1]=1;for(let i=0;i<t;++i)for(let a=0;a<=t;++a){let o=e[a*t+i],l=parseFloat(o.value);if(!Number.isFinite(l))return!1;r[a*(t+1)+i]=l}return this.transform.transform=r,!0}updateViewOutputNames(){let{transform:{value:{outputSpace:e,rank:t}}}=this;if(t!==this.curRank)return;let{outputNameElements:r}=this,{names:i}=e;for(let a=0;a<t;++a){let o=r[a];o.value=i[a],o.dataset.isValid="true",Dp(o)}r[t].value="",this.updateWillBeDeletedAttributes()}updateViewTransformCoefficients(){let{transform:{value:{transform:e,rank:t}}}=this,{coefficientElements:r}=this;for(let i=0;i<t;++i)for(let a=0;a<=t;++a){let o=r[a*t+i];o.value=e[a*(t+1)+i].toString(),o.dataset.isValid="true",Dp(o)}}ensureViewRankUpdated(){let e=this.transform.value,{rank:t}=e,r=e.sourceRank;if(this.curSourceRank===r&&this.curRank===t)return;let{inputBoundsElements:i,inputNameElements:a,inputScaleElements:o}=this,{element:l,coefficientElements:c,outputNameElements:d,outputScaleElements:p,outputScaleSuggestionElements:h,inputScaleSuggestionElements:g,outputBoundsElements:v,coefficientContainer:b,translationContainer:x,outputNameContainer:C,inputNameContainer:T,inputScaleContainer:P,inputLowerBoundsContainer:I,inputUpperBoundsContainer:M,outputScaleContainer:D}=this;l.style.gridTemplateColumns=`[outputLabel headerStart] min-content [outputNames] 1fr [outputScales] 1fr [headerEnd] repeat(${Math.max(1,t)+1}, [sourceDim] 1fr)`,l.style.gridTemplateRows=`[sourceLabel headerStart] auto [sourceNames] auto [sourceLower] auto [sourceUpper] auto [sourceScales] auto [headerEnd]repeat(${t+1}, [outputDim] auto)`,Me(b),Me(x),b.appendChild(x),Me(C),Me(T),Me(P),Me(I),Me(M),Me(D),a.length=0,o.length=0,i.length=0,p.length=0,h.length=0,g.length=0,c.length=0,d.length=0,v.length=0;for(let E=0;E<t;++E){let V=O=>{O.classList.add("neuroglancer-coordinate-space-transform-input"),E>=r&&O.classList.add(RM)};{let O=document.createElement("div");O.classList.add("neuroglancer-coordinate-space-transform-input-name"),V(O),O.style.gridRowStart="sourceNames",O.style.gridColumnStart=`sourceDim ${E+1}`,T.appendChild(O),a.push(O)}{let{cellElement:O,inputElement:B,suggestionElement:z}=OM();O.classList.add("neuroglancer-coordinate-space-transform-input-scale-container"),V(O),O.style.gridRowStart="sourceScales",O.style.gridColumnStart=`sourceDim ${E+1}`,P.appendChild(O),o.push(B),g.push(z);let _=E;z.addEventListener("click",()=>{let F=wS(this.transform,_);F!==void 0&&(this.transform.inputSpace.value=UM(this.transform.inputSpace.value,_,F.scale,F.unit))})}{let O=document.createElement("div");V(O),O.classList.add("neuroglancer-coordinate-space-transform-input-bounds"),O.style.gridRowStart="sourceLower",O.style.gridColumnStart=`sourceDim ${E+1}`,I.appendChild(O);let B=document.createElement("div");V(B),B.classList.add("neuroglancer-coordinate-space-transform-input-bounds"),B.style.gridRowStart="sourceUpper",B.style.gridColumnStart=`sourceDim ${E+1}`,M.appendChild(B),i.push({lower:O,upper:B})}}for(let E=0;E<t;++E){for(let V=0;V<=t;++V){let O=document.createElement("input");O.classList.add("neuroglancer-coordinate-space-transform-coeff"),O.spellcheck=!1,O.autocomplete="off",O.size=1,O.style.gridRowStart=`outputDim ${E+1}`,O.placeholder=" ",O.style.gridColumnStart=`sourceDim ${V+1}`,c[V*t+E]=O,V===t?O.classList.add("neuroglancer-coordinate-space-transform-translation-coeff"):V==r&&O.classList.add(RM),(V===t?x:b).appendChild(O)}{let{cellElement:V,suggestionElement:O,inputElement:B}=OM();V.classList.add("neuroglancer-coordinate-space-transform-output-scale-container"),V.style.gridRowStart=`outputDim ${E+1}`,V.style.gridColumnStart="outputScales";let z=E;O.addEventListener("click",()=>{let{value:_}=this.transform,F=CS(_,z);F!==void 0&&(this.transform.outputSpace.value=UM(_.outputSpace,z,F.scale,F.unit))}),h.push(O),D.appendChild(V),p.push(B)}{let V=document.createElement("div");V.classList.add("neuroglancer-coordinate-space-transform-output-name-container"),V.style.gridRowStart=`outputDim ${E+1}`,V.style.gridColumnStart="outputNames";let O=BM();O.title="Rebind to a different dimension",E>=r?O.title+=", or delete to remove singleton dimension":this.transform.mutableSourceRank&&(O.title+=", or delete to remove source dimension"),O.title+=".  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",d.push(O),C.appendChild(V),V.appendChild(O);let B=document.createElement("div");B.classList.add("neuroglancer-coordinate-space-transform-output-bounds"),V.appendChild(B);let z=document.createElement("div");z.classList.add("neuroglancer-coordinate-space-transform-output-bounds"),V.appendChild(z),v.push({lower:B,upper:z}),V.addEventListener("mousedown",_=>{_.target!==O&&(O.focus(),_.preventDefault())})}}d.push(this.addOutputDimensionInput),this.addOutputDimensionInput.value="",C.appendChild(this.addOutputDimensionCell),this.curSourceRank=r,this.curRank=t}updateViewInputScales(){this.ensureViewRankUpdated(),this.inputScaleModified.length=0;let{inputSpace:e,rank:t,sourceRank:r}=this.transform.value,{inputBoundsElements:i,inputNameElements:a,inputScaleElements:o,inputScaleSuggestionElements:l}=this,{names:c,scales:d,units:p,bounds:{lowerBounds:h,upperBounds:g}}=e;for(let v=0;v<t;++v){let b=o[v],x=d[v],C=p[v];b.value=Ri(x,C,{elide1:!1}),b.dataset.isValid="true",Dp(b);let T;if(v<r){let D=c[v];D||(D=`${v}`),a[v].textContent=D,T=`source dimension ${D}`,b.title=`Override scale of ${T}`}else T="singleton dimension",b.title=`Set extent of ${T}`;let{lower:P,upper:I}=_M(h[v],g[v]),M=i[v];M.lower.textContent=P,M.lower.title=`Lower bound of ${T}`,M.upper.title=`Upper bound of ${T}`,M.upper.textContent=I,NM(l[v],wS(this.transform,v),x,C,`Revert scale of ${T} to `)}}updateViewOutputScales(){let{value:e}=this.transform,{rank:t,names:r,units:i,scales:a,bounds:{lowerBounds:o,upperBounds:l}}=e.outputSpace,{outputScaleElements:c,outputBoundsElements:d,outputScaleSuggestionElements:p}=this;for(let h=0;h<t;++h){let g=c[h],v=a[h],b=i[h];g.value=Ri(v,b,{elide1:!1}),Dp(g);let x=r[h];g.dataset.isValid="true";let C=`Change coordinates of ${Wo(x)?"local":"global"} dimension ${x}`;g.title=`${C} (does not rescale the source)`;let{lower:T,upper:P}=_M(o[h],l[h]),I=d[h];I.lower.textContent=T,I.upper.textContent=P,NM(p[h],CS(e,h),v,b,`${C} to inferred scale of `)}}updateResetButtonVisibility(e=!1,t=!1){let{transform:{value:r,mutableSourceRank:i,defaultTransform:a}}=this,{rank:o}=r;this.resetToIdentityButton.style.visibility=e||!qE(r.transform,o+1,o+1)?"visible":"hidden",this.resetToDefaultButton.style.visibility=!i&&(e||t||!eD(a,r))?"visible":"hidden"}updateView(){let e=this.transform.value;this.curTransform!==e&&(this.curTransform=e,this.ensureViewRankUpdated(),this.updateViewInputScales(),this.updateViewOutputNames(),this.updateViewTransformCoefficients(),this.updateViewOutputScales(),this.updateAddOutputDimensionCellStyle(),this.updateResetButtonVisibility())}disposed(){et(this.element),super.disposed()}};var Yx=Ye(gt());function GM(n,e,{horizontal:t=!1,vertical:r=!0,topMargin:i=6,bottomMargin:a=6,leftMargin:o=6,rightMargin:l=6,maxHeight:c=!0,maxWidth:d=!0}={}){let p=e.getBoundingClientRect();if(t){let h=n.ownerDocument.documentElement.clientWidth,g=p.right,v=h-p.left;g>v?(n.style.left="",n.style.right=`${h-p.right}px`,d&&(n.style.maxWidth=g-o+"px")):(n.style.right="",n.style.left=`${p.left}px`,d&&(n.style.maxWidth=v-l+"px"))}if(r){let h=n.ownerDocument.documentElement.clientHeight,g=p.top-i,v=h-p.bottom-a;n.style.left=`${p.left}px`,n.style.width=`${p.width}px`,g>v*3?(n.style.top="",n.style.bottom=`${h-p.top}px`,c&&(n.style.maxHeight=g+"px")):(n.style.top=`${p.bottom}px`,n.style.bottom="",c&&(n.style.maxHeight=v+"px"))}}function WM(n){let e=n[Symbol.iterator](),{value:t,done:r}=e.next();if(r)return"";let i=t.length;for(;i>0;){let{value:a,done:o}=e.next();if(o)break;let l=0;for(;l<i&&t.charCodeAt(l)===a.charCodeAt(l);++l);i=l}return t.substring(0,i)}var zM=10,mg=.5,HM=class{constructor(){this.anchorIndex=0;this.anchorClientOffset=0}splice(e){let{anchorIndex:t}=this,r=0;for(let i of e){if(r+=i.retainCount,t<r)break;let{deleteCount:a}=i;if(t<r+a){t=r;break}let{insertCount:o}=i;t=t-a+o,r+=o-o}this.anchorIndex=t}},qx=class{constructor(){this.startIndex=0;this.endIndex=0;this.anchorIndex=0;this.anchorOffset=0;this.scrollOffset=0}},$M=class{constructor(){this.itemSize=[];this.totalKnownSize=0;this.numItemsInTotalKnownSize=0}get averageSize(){return this.totalKnownSize/this.numItemsInTotalKnownSize}getEstimatedSize(e){var t;return(t=this.itemSize[e])!=null?t:this.averageSize}getEstimatedTotalSize(){return this.totalKnownSize/this.numItemsInTotalKnownSize*this.itemSize.length}getEstimatedOffset(e,t=0,r=0){for(;t<e;++t)r+=this.getEstimatedSize(t);for(;t>e;--t)r-=this.getEstimatedSize(t-1);return r}getRangeSize(e,t){var o;let r=0,{itemSize:i,averageSize:a}=this;for(let l=e;l<t;++l)r+=(o=i[l])!=null?o:a;return r}splice(e){let{itemSize:t}=this;t=this.itemSize=qL(t,e),this.totalKnownSize=t.reduce((r,i)=>r+i,0),this.numItemsInTotalKnownSize=t.reduce(r=>r+1,0)}};function xj(n,e,t,r,i,a){let{anchorIndex:o,anchorClientOffset:l}=a,c=i.getEstimatedOffset(o),d,p,h,g,v;if(r===0||i.totalKnownSize===0)d=Math.max(0,o-zM/2),p=Math.min(t,d+zM),v=o,h=0,g=l;else{let b=i.getEstimatedTotalSize(),x=Math.max(0,b-r);g=c-l,g=Math.max(0,Math.min(x,g));let C=g-2*mg*r,T=g-mg*r,P=g+r+mg*r,I=c-l+r+2*mg*r;d=Math.min(t,e.startIndex);let M=i.getEstimatedOffset(d,o,c);if(M<C)for(;d+1<t;++d){let E=i.getEstimatedSize(d);if(M+E>=T)break;M+=E}if(M>=T)for(;M>C&&d>0;--d)M-=i.getEstimatedSize(d-1);p=Math.min(t,e.endIndex);let D=i.getEstimatedOffset(p,o,c);if(D<P)for(;D<=I&&p+1<=t;++p)D+=i.getEstimatedSize(p);else if(D>=I)for(;p>d;--p){let E=i.getEstimatedSize(p-1);if(D-E<P)break;D-=E}for(v=o,h=c;v<d;++v)h+=i.getEstimatedSize(v);for(;v>p;--v)h-=i.getEstimatedSize(v-1)}n.startIndex=d,n.endIndex=p,n.anchorIndex=v,n.anchorOffset=h,n.scrollOffset=g}function Cj(n,e){let t=e.getEstimatedOffset(n.anchorIndex),r=n.anchorOffset;n.anchorOffset=t,n.scrollOffset+=t-r}function wj(n,e){return n.startIndex<e.startIndex||n.endIndex>e.endIndex}var Ol=class extends H{constructor(e){super();this.element=document.createElement("div");this.scrollContent=document.createElement("div");this.header=document.createElement("div");this.body=document.createElement("div");this.topItems=document.createElement("div");this.bottomItems=document.createElement("div");this.renderedItems=[];this.renderGeneration=-1;this.listGeneration=-1;this.newRenderedItems=[];this.state=new HM;this.renderParams=new qx;this.newRenderParams=new qx;this.sizes=new $M;this.debouncedUpdateView=this.registerCancellable(We(()=>this.updateView()));this.resizeObserver=new ResizeObserver(()=>this.updateView());let{selectedIndex:t}=e;t!==void 0&&(this.state.anchorIndex=t,this.state.anchorClientOffset=0);let r=this.source=e.source;this.sizes.itemSize.length=r.length;let{element:i,header:a,body:o,scrollContent:l,topItems:c,bottomItems:d}=this;this.resizeObserver.observe(i),this.registerDisposer(()=>this.resizeObserver.disconnect()),i.appendChild(l),i.style.overflowAnchor="none",l.appendChild(a),l.appendChild(o),a.style.position="sticky",a.style.zIndex="1",a.style.top="0",e.horizontalScroll?(l.style.width="min-content",l.style.minWidth="100%",a.style.width="min-content",a.style.minWidth="100%",d.style.width="min-content",d.style.minWidth="100%"):(l.style.width="100%",a.style.width="100%",d.style.width="100%"),o.appendChild(c),o.appendChild(d),c.style.width="min-content",c.style.position="relative",c.style.height="0",c.style.minWidth="100%",d.style.height="0",d.style.position="relative",i.addEventListener("scroll",()=>{let p=i.scrollTop;this.state.anchorClientOffset=this.renderParams.anchorOffset-p,this.renderParams.scrollOffset=p,this.debouncedUpdateView()}),r.changed!==void 0&&this.registerDisposer(r.changed.add(p=>{this.sizes.splice(p),this.state.splice(p),this.renderedItems.length=0,this.debouncedUpdateView()})),r.renderChanged!==void 0&&this.registerDisposer(r.renderChanged.add(this.debouncedUpdateView))}updateView(){let{element:e}=this;if(e.offsetHeight===0)return;let t=e.clientHeight-this.header.offsetHeight,{source:r,state:i,sizes:a}=this,o=r.length,{body:l,topItems:c,bottomItems:d}=this,{changed:p,renderChanged:h}=r,g;for(;;){g=this.newRenderParams;let x=this.renderParams;xj(g,x,o,t,a,i);let C;if(h!==void 0&&h.count!==this.renderGeneration||p!==void 0&&p.count!==this.listGeneration?(this.renderGeneration=h===void 0?-1:h.count,this.listGeneration=p===void 0?-1:p.count,C=!0,this.renderedItems.length=0):C=!1,!C&&!wj(g,x)){x.scrollOffset=g.scrollOffset,g=x;break}this.renderParams=g,this.newRenderParams=x;let T=this.renderedItems,P=this.newRenderedItems;P.length=0,this.renderedItems=P,this.newRenderedItems=T;let{source:I}=this,{render:M}=I,{startIndex:D,endIndex:E,anchorIndex:V}=g;function*O(B,z){for(let _=B;_<z;++_){let F=T[_];F===void 0&&(F=M.call(I,_)),P[_]=F,yield F}}$n(c,O(D,V)),$n(d,O(V,E));for(let B=D;B<E;++B){let F=P[B].getBoundingClientRect().height,N=a.itemSize[B];N!==void 0&&(a.totalKnownSize-=N,--a.numItemsInTotalKnownSize),a.itemSize[B]=F,a.totalKnownSize+=F,++a.numItemsInTotalKnownSize}}Cj(g,a),i.anchorIndex=g.anchorIndex,i.anchorClientOffset=g.anchorOffset-g.scrollOffset;let v=a.getRangeSize(g.startIndex,g.anchorIndex),b=a.getEstimatedTotalSize();l.style.height=`${b}px`,c.style.top=`${g.anchorOffset-v}px`,d.style.top=`${g.anchorOffset}px`,e.scrollTop=g.scrollOffset}getItemElement(e){return this.renderedItems[e]}forEachRenderedItem(e){let{startIndex:t,endIndex:r}=this.renderParams,{renderedItems:i}=this;for(let a=t;a<r;++a){let o=i[a];o!==void 0&&e(o,a)}}scrollToTop(){this.state.anchorIndex=0,this.state.anchorClientOffset=0,this.debouncedUpdateView()}scrollItemIntoView(e){let t=this.sizes.getEstimatedOffset(e),r=t+this.sizes.getEstimatedSize(e),i=this.element.scrollTop;if(t<i)this.state.anchorIndex=e,this.state.anchorClientOffset=0;else if(t>i&&r>i+this.element.offsetHeight)this.state.anchorIndex=e+1,this.state.anchorClientOffset=this.element.offsetHeight;else return;this.debouncedUpdateView()}disposed(){et(this.element)}};var Kx="neuroglancer-multiline-autocomplete-completion-active",Tj=!1;function Lj(n){let e=document.createElement("div");return e.textContent=n.value,e}function*jM(n){for(;n.length>0;){let e=n.match(/[:/_]+/);if(e===null){yield n;return}let t=e.index+e[0].length;yield n.substring(0,t),n=n.substring(t)}}function JM(n){let e=document.createElement("div");e.className="neuroglancer-multiline-autocomplete-completion-with-description",e.textContent=n.value;let t=document.createElement("div");return t.className="neuroglancer-multiline-autocomplete-completion-description",t.textContent=n.description||"",e.appendChild(t),e}var kj=Ie.fromObject({arrowdown:{action:"cycle-next-active-completion"},arrowup:{action:"cycle-prev-active-completion"},home:{action:"home"},end:{action:"end"},tab:{action:"choose-active-completion-or-prefix",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel",preventDefault:!1,stopPropagation:!1}}),Ej=200,Xx=class extends H{constructor(e){super();this.element=document.createElement("div");this.inputElement=document.createElement("span");this.hintElement=document.createElement("span");this.completionsVirtualList=void 0;this.onCommit=new $e;this.onInput=new $e;this.prevInputValue="";this.completionsVisible=!1;this.activeCompletionPromise=null;this.activeCompletionCancellationToken=void 0;this.hasFocus=!1;this.completionResult=null;this.dropdownContentsStale=!0;this.hasResultForDropdown=!1;this.commonPrefix="";this.completionDisabled=-1;this.activeIndex=-1;this.dropdownStyleStale=!0;this.resizeHandler=()=>{!this.completionsVisible||this.updateDropdownStyle()};this.resizeObserver=new ResizeObserver(this.resizeHandler);this.debouncedUpdateHintState=this.registerCancellable((0,Yx.default)(()=>this.updateHintState(),0));this.completer=e.completer;let{delay:t=Ej}=e,r=this.scheduleUpdateCompletions=(0,Yx.default)(()=>{let c=this.activeCompletionCancellationToken=new Qa,d=this.activeCompletionPromise=this.completer(this.value,c);d!==null&&d.then(p=>{this.activeCompletionPromise===d&&(this.setCompletions(p),this.activeCompletionPromise=null)})},t);this.registerDisposer(()=>{r.cancel()});let{element:i,inputElement:a,hintElement:o}=this;i.classList.add("neuroglancer-multiline-autocomplete"),this.registerEventListener(window,"resize",this.resizeHandler),this.resizeObserver.observe(i),this.registerDisposer(()=>this.resizeObserver.unobserve(a)),a.contentEditable="true",a.spellcheck=!1,i.appendChild(document.createTextNode("\u200B")),i.appendChild(a),i.appendChild(o),a.classList.add("neuroglancer-multiline-autocomplete-input"),o.classList.add("neuroglancer-multiline-autocomplete-hint"),a.addEventListener("input",()=>{this.completionDisabled=-1,this.setValueAndSelection(this.value,this.getSelectionRange()),this.debouncedUpdateHintState()}),a.addEventListener("copy",c=>{let{clipboardData:d}=c;if(d!==null){let p=window.getSelection();p!==null&&!p.isCollapsed&&p.containsNode(a,!0)&&d.setData("text/plain",p.toString())}c.preventDefault(),c.stopPropagation()}),this.registerEventListener(document,"selectionchange",()=>{let c=this.getSelectionRange(),{completionDisabled:d}=this;c!==void 0&&c.begin===d&&c.end===d||(this.completionDisabled=-1,this.debouncedUpdateHintState())}),this.setValueAndSelection(""),this.updateHintState(),i.addEventListener("pointerdown",c=>{let{target:d}=c;if(d instanceof Node){if(a.contains(d))return;let{completionsVirtualList:p}=this;if(p!==void 0&&p.element.contains(d))return}a===document.activeElement&&(this.moveCaretToEndOfInput(),c.stopPropagation(),c.preventDefault())}),i.addEventListener("click",()=>{a.focus()}),this.registerEventListener(this.inputElement,"focus",()=>{if(!this.hasFocus){this.hasFocus=!0,this.dropdownStyleStale=!0,this.updateDropdown();let c=document.createRange(),{childNodes:d}=a;c.setStart(a,0),d.length===0?c.setEnd(a,0):c.setEndAfter(d[d.length-1]);let p=window.getSelection();p!==null&&(p.removeAllRanges(),p.addRange(c)),this.debouncedUpdateHintState()}}),this.registerEventListener(this.inputElement,"blur",()=>{if(this.hasFocus){if(Tj)return;this.hasFocus=!1,this.updateDropdown()}this.debouncedUpdateHintState();let c=window.getSelection();c!==null&&c.containsNode(this.inputElement,!0)&&c.removeAllRanges(),this.onCommit.dispatch(this.value,!1)}),this.registerEventListener(window,"resize",()=>{this.dropdownStyleStale=!0}),this.registerEventListener(window,"scroll",()=>{this.dropdownStyleStale=!0});let l=this.registerDisposer(new jt(a,kj));l.allShortcutsAreGlobal=!0,ce(a,"cycle-next-active-completion",()=>{this.cycleActiveCompletion(1)}),ce(a,"cycle-prev-active-completion",()=>{this.cycleActiveCompletion(-1)}),ce(a,"home",()=>{this.moveCaretToBeginningOfInput()}),ce(a,"end",()=>{this.moveCaretToEndOfInput()}),ce(a,"choose-active-completion-or-prefix",c=>{this.selectActiveCompletion(!0)&&c.preventDefault()}),ce(a,"commit",c=>{if(this.selectActiveCompletion(!1))c.stopPropagation();else{let d=!this.completionsVisible;this.disableCompletion(),this.hideCompletions(),this.onCommit.dispatch(this.value,d)}}),ce(a,"cancel",c=>{c.stopPropagation(),this.cancel()&&(c.detail.preventDefault(),c.detail.stopPropagation())})}disableCompletion(){let e=this.getSelectionRange();this.completionDisabled=e!==void 0&&e.end===e.begin?e.end:-1}get placeholder(){return this.inputElement.dataset.placeholder||""}set placeholder(e){this.inputElement.dataset.placeholder=e}getSelectionRange(){let e=window.getSelection();if(e===null||e.rangeCount===0)return;let t=e.getRangeAt(0),{inputElement:r}=this,i=document.createRange();i.setStart(r,0),i.setEnd(t.startContainer,t.startOffset);let a=i.toString().length,o=e.toString().length;return{begin:a,end:a+o}}setValueAndSelection(e,t=void 0){let r=this.completionDisabled!==-1;this.onInput.dispatch(e);let{inputElement:i}=this;Me(i);let a=0,o=t!==void 0?document.createRange():void 0,l=!0;for(let c of jM(e)){l||i.appendChild(document.createElement("wbr")),l=!1;let d=a+c.length,p=document.createTextNode(c);if(i.appendChild(p),o!==void 0){let{begin:h,end:g}=t;h>=a&&h<=d&&o.setStart(p,h-a),g>=a&&g<=d&&o.setEnd(p,g-a)}a=d}if(o!==void 0){l&&(o.setStart(i,0),o.setEnd(i,0));let c=window.getSelection();c!==null&&(c.removeAllRanges(),c.addRange(o))}this.completionDisabled=r&&t!==void 0&&t.end===t.begin?t.end:-1}shouldAttemptCompletion(){let{inputElement:e}=this;if(document.activeElement!==e)return!1;let t=this.getSelectionRange();return t!==void 0&&t.end===t.begin&&t.end!=this.completionDisabled&&t.end===this.value.length}hideCompletions(){this.cancelActiveCompletion(),this.clearCompletions(),this.hintElement.textContent=""}updateHintState(){if(this.debouncedUpdateHintState.cancel(),this.shouldAttemptCompletion()){let{value:e}=this;if(e===this.prevInputValue)return;this.hideCompletions(),this.prevInputValue=e,this.scheduleUpdateCompletions()}else{this.hideCompletions();return}}handleDropdownClick(e){let{completionsVirtualList:t}=this;if(t===void 0)return;let r=t.element;for(let i=e.target;i instanceof HTMLElement&&i!==r;i=i.parentElement){let a=i.dataset.completionIndex;if(a!==void 0){this.selectCompletion(Number(a));break}}}cycleActiveCompletion(e){if(this.completionResult===null)return;let{activeIndex:t}=this,r=this.completionResult.completions.length;t===-1?e>0?t=0:t=r-1:t=(t+e+r)%r,this.setActiveIndex(t)}shouldShowDropdown(){let{completionResult:e}=this;return e===null||!this.hasFocus?!1:this.hasResultForDropdown}updateDropdownStyle(){let{completionsVirtualList:e,element:t}=this;e!==void 0&&GM(e.element,t,{horizontal:!1}),this.dropdownStyleStale=!1}updateDropdown(){let{completionsVirtualList:e}=this;if(this.shouldShowDropdown()){if(this.dropdownContentsStale){e!==void 0&&e.dispose();let r=this.completionResult,{makeElement:i=Lj}=r;e=this.completionsVirtualList=new Ol({source:{length:r.completions.length,render:a=>{let o=r.completions[a],l=i.call(r,o);return l.classList.add("neuroglancer-multiline-autocomplete-completion"),l.dataset.completionIndex=`${a}`,this.activeIndex===a&&l.classList.add(Kx),l}},selectedIndex:this.activeIndex===-1?void 0:this.activeIndex}),e.element.classList.add("neuroglancer-multiline-autocomplete-dropdown"),e.element.addEventListener("mousedown",a=>{this.inputElement.focus(),a.preventDefault()}),e.element.addEventListener("mouseup",this.handleDropdownClick.bind(this)),this.element.appendChild(e.element),this.dropdownContentsStale=!1}this.dropdownStyleStale&&this.updateDropdownStyle(),this.completionsVisible||(this.completionsVisible=!0);let{activeIndex:t}=this;t!==-1&&this.completionsVirtualList.scrollItemIntoView(t)}else this.completionsVisible&&(e!==void 0&&(e.dispose(),this.completionsVirtualList=void 0,this.dropdownContentsStale=!0),this.completionsVisible=!1)}setCompletions(e){this.clearCompletions();let{completions:t}=e;if(t.length===0)return;let r=this.prevInputValue;if(r!==void 0){if(this.completionResult=e,t.length===1){let i=t[0];e.showSingleResult?this.hasResultForDropdown=!0:i.value.startsWith(r)?this.hasResultForDropdown=!1:this.hasResultForDropdown=!0,e.selectSingleResult?this.setActiveIndex(0):this.setHintValue(this.getCompletedValueByIndex(0))}else{this.hasResultForDropdown=!0;let i=WM(function*(){for(let o of e.completions)yield o.value}()),a=this.getCompletedValue(i);a.startsWith(r)&&(this.commonPrefix=a,this.setHintValue(a))}this.updateDropdown()}}setHintValue(e){let t=this.prevInputValue;if(t===void 0)return;(e===t||!e.startsWith(t))&&(e=""),e=e.substring(t.length);let{hintElement:r}=this;Me(r);let i=!0;for(let a of jM(e)){i||r.appendChild(document.createElement("wbr")),i=!1;let o=document.createTextNode(a);r.appendChild(o)}}setActiveIndex(e){if(!this.dropdownContentsStale){let{activeIndex:t}=this,{completionsVirtualList:r}=this;if(r!==void 0){if(t!==-1){let i=r.getItemElement(t);i!==void 0&&i.classList.remove(Kx)}if(e!==-1){let i=r.getItemElement(e);i!==void 0&&i.classList.add(Kx),r.scrollItemIntoView(e)}}}e!==-1&&this.setHintValue(this.getCompletedValueByIndex(e)),this.activeIndex=e}getCompletedValueByIndex(e){return this.getCompletedValue(this.completionResult.completions[e].value)}getCompletedValue(e){let t=this.completionResult,r=this.prevInputValue;return r===void 0?"":r.substring(0,t.offset)+e}moveCaretToBeginningOfInput(){let e=document.createRange(),{inputElement:t}=this;e.setStart(t,0),e.setEnd(t,0);let r=window.getSelection();r!==null&&(r.removeAllRanges(),r.addRange(e),this.debouncedUpdateHintState())}moveCaretToEndOfInput(){let e=document.createRange(),{inputElement:t}=this,{childNodes:r}=t,i=r[r.length-1];i===void 0?(e.setStart(t,0),e.setEnd(t,0)):(e.setStartAfter(i),e.setEndAfter(i));let a=window.getSelection();a!==null&&(a.removeAllRanges(),a.addRange(e),this.debouncedUpdateHintState())}selectActiveCompletion(e){let{activeIndex:t}=this;if(t===-1){if(!e)return!1;let{completionResult:i}=this;if(i!==null&&i.completions.length===1)t=0;else{let{commonPrefix:a}=this;return a.length>this.value.length?(this.value=a,this.moveCaretToEndOfInput(),!0):!1}}let r=this.getCompletedValueByIndex(t);return this.value===r?!1:(this.value=r,this.moveCaretToEndOfInput(),!0)}selectCompletion(e){this.value=this.getCompletedValueByIndex(e),this.moveCaretToEndOfInput()}cancel(){return!1}cancelActiveCompletion(){this.prevInputValue=void 0;let e=this.activeCompletionCancellationToken;e!==void 0&&e.cancel(),this.activeCompletionCancellationToken=void 0,this.activeCompletionPromise=null}clearCompletions(){if(this.completionResult!==null){this.activeIndex=-1,this.completionResult=null,this.dropdownContentsStale=!0,this.dropdownStyleStale=!0,this.commonPrefix="";let{completionsVirtualList:e}=this;e!==void 0&&(e.dispose(),this.completionsVirtualList=void 0),this.updateDropdown()}}get value(){return this.inputElement.textContent||""}set value(e){e!==this.value&&(this.completionDisabled=-1,this.setValueAndSelection(e),this.debouncedUpdateHintState())}disposed(){let{completionsVirtualList:e}=this;e!==void 0&&e.dispose(),et(this.element),this.cancelActiveCompletion(),super.disposed()}};var qM=class extends Xx{constructor(e){let{manager:t}=e.source.layer,r=(a,o)=>t.dataSourceProviderRegistry.completeUrl({url:a,chunkManager:t.chunkManager,cancellationToken:o}).then(l=>({completions:l.completions,makeElement:JM,offset:l.offset,showSingleResult:!0}));super({completer:r,delay:0});this.placeholder="Data source URL",this.dataSourceView=e,this.element.classList.add("neuroglancer-layer-data-source-url-input"),this.dirty=new ke(!1);let i=a=>{a!==this.dataSourceView.source.spec.url&&(this.dirty.value=!0)};i(""),this.onInput.add(i)}cancel(){return this.value=this.dataSourceView.source.spec.url,this.dirty.value=!1,this.inputElement.blur(),!0}},Qx=class extends H{constructor(e){super();this.model=e;this.element=document.createElement("ul");this.generation=-1;this.element.classList.add("neuroglancer-layer-data-sources-source-messages");let t=this.registerCancellable(We(()=>this.updateView()));this.registerDisposer(e.changed.add(t)),this.registerDisposer(()=>et(this.element)),this.updateView()}updateView(){let{model:e}=this,t=e.changed.count;if(t===this.generation)return;this.generation=t;let{element:r}=this;Me(r);let i=new Set;for(let a of e){let o=`${a.severity} ${a.message}`;if(i.has(o))continue;i.add(o);let l=document.createElement("li");r.appendChild(l),l.classList.add("neuroglancer-message"),l.classList.add(`neuroglancer-message-${vr[a.severity]}`),l.textContent=a.message}}},YM=class extends H{constructor(e,t){super();this.loadedSubsource=t;this.element=document.createElement("div");let{element:r}=this;r.classList.add("neuroglancer-layer-data-source-subsource");let i=document.createElement("label"),a=document.createElement("span"),o=()=>{i.dataset.isActive=(t.activated!==void 0||!t.enabled).toString()};o(),this.registerDisposer(t.isActiveChanged.add(o)),this.registerDisposer(e.enabledSubsourcesChanged.add(o));let l=this.registerDisposer(new zn({get value(){return t.enabled},set value(b){t.enabled=b,e.enableDefaultSubsources=!1,e.enabledSubsourcesChanged.dispatch()},changed:e.enabledSubsourcesChanged}));i.classList.add("neuroglancer-layer-data-sources-info-line"),i.appendChild(l.element);let c=document.createElement("span");c.classList.add("neuroglancer-layer-data-sources-source-id");let{id:d}=t.subsourceEntry;d!=="default"&&(c.textContent=d),i.appendChild(c),a.classList.add("neuroglancer-layer-data-sources-source-type");let p=this.registerDisposer(new Qx(this.loadedSubsource.messages));r.appendChild(i),i.appendChild(a),r.appendChild(p.element);let h="",{subsource:g}=t.subsourceEntry,{volume:v}=g;if(v instanceof Bt)h=`${W[v.dataType].toLowerCase()} volume`;else if(g.mesh instanceof Vn)h="meshes (single-res.)";else if(g.mesh instanceof fo)h="meshes (multi-res.)";else if(g.mesh instanceof Ji)h="skeletons";else if(g.segmentPropertyMap!==void 0)h="segment property map";else if(g.local!==void 0)switch(g.local){case pi.annotations:h="Local annotations";break;case pi.equivalences:h="local segmentation graph";break}else g.staticAnnotations!==void 0?h="default annotations":g.annotation!==void 0?h="annotations":g.singleMesh!==void 0?h="single mesh":g.segmentationGraph!==void 0&&(h="segmentation graph");a.textContent=h}},KM=class extends H{constructor(e){super();this.source=e;this.element=document.createElement("div");let{element:t}=this,r=document.createElement("label");r.classList.add("neuroglancer-layer-data-sources-source-default"),r.appendChild(this.registerDisposer(new zn({changed:e.enabledSubsourcesChanged,get value(){return e.enableDefaultSubsources},set value(a){if(e.enableDefaultSubsources!==a){if(e.enableDefaultSubsources=a,a)for(let o of e.subsources)o.enabled=o.subsourceEntry.default;e.enabledSubsourcesChanged.dispatch()}}})).element),r.appendChild(document.createTextNode("Enable default subsource set")),r.title="Enable the default set of subsources for this data source.",t.appendChild(r);for(let a of e.subsources)t.appendChild(this.registerDisposer(new YM(e,a)).element);let{transform:i}=e;if(i.mutableSourceRank||i.value.sourceRank!==0){let a=this.registerDisposer(new Jx(e.transform,e.layer.localCoordinateSpaceCombiner,e.layer.manager.root.coordinateSpaceCombiner));this.element.appendChild(a.element)}this.registerDisposer(()=>et(this.element))}},XM=class extends H{constructor(e,t){super();this.tab=e;this.source=t;this.element=document.createElement("div");this.seenGeneration=0;this.generation=-1;let r=this.urlInput=this.registerDisposer(new qM(this)),i=(o,l)=>{let{source:c}=this,d=c.spec,p=this.source.layer;if(o=p.manager.dataSourceProviderRegistry.normalizeUrl({url:o}),o!==r.value&&(r.disableCompletion(),r.setValueAndSelection(o,{begin:o.length,end:o.length})),r.dirty.value=!1,o&&o===d.url){l&&e.detectedLayerConstructor!==void 0&&QM(c.layer);return}if(p instanceof Yi)try{let h=p.manager.dataSourceProviderRegistry.suggestLayerName(o);gg(p.managedLayer,h)}catch{}c.spec={...d,url:o}};r.onCommit.add(i);let{element:a}=this;a.classList.add("neuroglancer-layer-data-source"),a.appendChild(r.element),a.appendChild(this.registerDisposer(new Qx(t.messages)).element),this.updateView()}updateView(){let e=this.source.changed.count;if(e===this.generation)return;this.generation=e,this.urlInput.value=this.source.spec.url,this.urlInput.dirty.value=!1;let{loadState:t}=this.source,{loadedView:r}=this;if(r!==void 0){if(r.source===t)return;r.dispose(),r=this.loadedView=void 0}t instanceof lg&&(r=this.loadedView=new KM(t),this.element.appendChild(r.element))}disposed(){let{loadedView:e}=this;e!==void 0&&e.dispose(),et(this.element),super.disposed()}};function QM(n){if(n instanceof Yi){let e=n.detectedLayerConstructor;if(e!==void 0)return Pp(n.managedLayer,e),!0}return!1}var Zx=class extends Nt{constructor(e){super();this.layer=e;this.generation=-1;this.sourceViews=new Map;this.addDataSourceIcon=hg({title:"Add additional data source"});this.layerTypeDetection=document.createElement("div");this.layerTypeElement=document.createElement("span");this.dataSourcesContainer=document.createElement("div");this.detectedLayerConstructor=void 0;let{element:t,dataSourcesContainer:r}=this;t.classList.add("neuroglancer-layer-data-sources-tab"),r.classList.add("neuroglancer-layer-data-sources-container");let{addDataSourceIcon:i}=this;if(i.style.alignSelf="start",i.addEventListener("click",()=>{let o=this.layer.addDataSource(void 0);this.updateView();let l=this.sourceViews.get(o);l!==void 0&&l.urlInput.inputElement.focus()}),t.appendChild(this.dataSourcesContainer),e instanceof Yi){let{layerTypeDetection:o,layerTypeElement:l}=this;o.style.display="none",l.classList.add("neuroglancer-layer-data-sources-tab-type-detection-type"),o.appendChild(document.createTextNode("Create as ")),o.appendChild(l),o.appendChild(document.createTextNode(" layer")),t.appendChild(o),o.classList.add("neuroglancer-layer-data-sources-tab-type-detection"),o.addEventListener("click",()=>{QM(e)})}let a=this.reRender=We(()=>this.updateView());this.registerDisposer(e.dataSourcesChanged.add(a)),this.registerDisposer(this.visibility.changed.add(a)),this.updateView()}updateLayerTypeDetection(){let e=(()=>{let r=this.layer;if(!(r instanceof Yi))return;let i=r.detectedLayerConstructor;if(i!==void 0){for(let a of this.sourceViews.values())if(a.urlInput.dirty.value)return;return i}})();if(e===this.detectedLayerConstructor)return;let{layerTypeDetection:t}=this;if(this.detectedLayerConstructor=e,e!==void 0){let{layerTypeElement:r}=this;r.textContent=e.type,t.title=`Click here or press enter in the data source URL input box to create as ${e.type} layer`,t.style.display=""}else t.style.display="none"}disposed(){let{sourceViews:e}=this;for(let t of e.values())t.dispose();e.clear(),super.disposed()}updateView(){if(!this.visible)return;let e=this.layer.dataSourcesChanged.count;if(e!==this.generation){this.generation=e;let t=Date.now(),{sourceViews:r}=this,{layer:i}=this;function*a(){let o=!0,{dataSources:l}=i;for(let c of l){let d=r.get(c);d===void 0&&(d=new XM(this,c),d.registerDisposer(d.urlInput.dirty.changed.add(this.reRender)),r.set(c,d)),d.seenGeneration=t,d.updateView();let p=c.spec.url;l.length===1&&p===""&&setTimeout(()=>{d.urlInput.inputElement.focus()},0),o=c.spec.url.length===0,yield d.element}o||(yield this.addDataSourceIcon)}$n(this.dataSourcesContainer,a.call(this));for(let[o,l]of r)l.seenGeneration!==t&&(l.dispose(),r.delete(o))}this.updateLayerTypeDetection()}};var yg="tab",ZM="tabs",eR="panels",tR={...mi,row:0},eC={...mi,visible:!0,row:0},su=class extends H{constructor(e){super();this.panels=e;this.layer=this.panels.layer;this.location=new tr(eC);this.tabsChanged=new $e;this.selectedTab=new ke(void 0);this.tabs=[]}initialize(){let{panels:e}=this;this.tabsChanged.add(e.specificationChanged.dispatch),this.selectedTab.changed.add(e.specificationChanged.dispatch),this.location.changed.add(()=>{var a;e.specificationChanged.dispatch();let{layer:t}=this,{selectedLayer:r}=t.manager.root;if(((a=r.layer)==null?void 0:a.layer)!==t||this!==t.panels.panels[0])return;let i=this.location.value;r.location.value!==i&&(r.location.value=i,r.location.locationChanged.dispatch())}),this.location.locationChanged.add(()=>{this.location.visible||this!==this.panels.panels[0]&&this.panels.removePanel(this)});for(let t of this.tabs){let{hidden:r}=this.layer.tabs.options.get(t);r&&this.registerDisposer(r.changed.add(()=>{this.panels.updateTabs(),this.tabsChanged.dispatch()}))}}normalizeTabs(){let{tabs:e}=this;if(e.length===0){this.selectedTab.value=void 0;return}let t=this.layer.tabs.options,r=o=>{var l;return(l=t.get(o).order)!=null?l:0};e.sort((o,l)=>r(o)-r(l));let{selectedTab:i}=this,a=i.value;(a===void 0||!e.includes(a))&&(i.value=e[0])}pin(){var a;let{layer:e}=this,{selectedLayer:t}=e.manager.root;if(((a=t.layer)==null?void 0:a.layer)!==e||this!==e.panels.panels[0]||this.tabs.length===0)return;let{panels:r}=this,i=e.registerDisposer(new su(r));r.panels.splice(0,1,i),r.panels.push(this),r.updateTabs(),i.initialize(),t.layerManager.layersChanged.dispatch(),this.panels.specificationChanged.dispatch()}unpin(){var l;let{panels:e}=this,t=e.panels.indexOf(this);if(t===-1||t===0)return;let{layer:r}=this,{selectedLayer:i}=r.manager.root,a=(l=i.layer)==null?void 0:l.layer;i.visible&&a!=null&&a!=r&&a.panels.panels[0].pin(),e.panels.splice(t,1);let[o]=e.panels.splice(0,1,this);if(this.explicitTabs===void 0)r.unregisterDisposer(o);else{e.panels.push(o);for(let c=1,d=e.panels.length;c<d;++c){let p=e.panels[c];p.explicitTabs===void 0&&(p.explicitTabs=new Set(p.tabs))}}this.explicitTabs=void 0,e.updateTabs(),i.layer=r.managedLayer,i.location.value=this.location.value,i.location.locationChanged.dispatch(),i.layerManager.layersChanged.dispatch(),this.panels.specificationChanged.dispatch()}splitOffTab(e,t){if(!this.tabs.includes(e))return;let{panels:r}=this;{let{explicitTabs:o}=this;o!==void 0&&o.delete(e)}let{layer:i}=this,a=i.registerDisposer(new su(r));a.location.value=t,a.explicitTabs=new Set([e]),r.panels.splice(1,0,a),r.updateTabs(),a.initialize(),i.manager.root.layerManager.layersChanged.dispatch(),r.specificationChanged.dispatch()}moveTabTo(e,t){if(!this.tabs.includes(e))return;{let{explicitTabs:i}=this;i!==void 0&&i.delete(e)}{let{explicitTabs:i}=t;i!==void 0&&i.add(e)}let{panels:r}=this;r.updateTabs(),t.selectedTab.value=e,r.specificationChanged.dispatch()}mergeInto(e){let{explicitTabs:t}=e;if(t!==void 0)for(let i of this.tabs)t.add(i);let{panels:r}=this;r.removePanel(this)}},tC=class{constructor(e){this.layer=e;this.specificationChanged=new $e;this.updating=!1;this.panels=[e.registerDisposer(new su(this))]}restoreState(e){let{panels:t}=this;t[0].selectedTab.value=ie(e,yg,Z);let{layer:r}=this,{tabs:i}=r,a=new Set(i.options.keys());ie(e,eR,o=>ge(o,l=>{Q(l);let c=new su(this);c.location.restoreState(l),!!c.location.visible&&(c.selectedTab.value=ie(l,yg,Z),c.explicitTabs=ie(l,ZM,d=>{let p=new Set;for(let h of on(d))!a.has(h)||(a.delete(h),p.add(h));return p}),c.explicitTabs===void 0?(c.tabs=Array.from(a),a.clear()):c.tabs=Array.from(c.explicitTabs),c.tabs.length!==0&&(c.normalizeTabs(),r.registerDisposer(c),c.initialize(),t.push(c)))})),t[0].tabs=Array.from(a),t[0].normalizeTabs(),this.panels[0].initialize()}removePanel(e){if(this.updating)return;let t=this.panels.indexOf(e);this.panels.splice(t,1),this.layer.unregisterDisposer(e),this.updateTabs()}updateTabs(){var o;let{layer:e}=this,{tabs:t}=e,r=new Set(t.options.keys()),{panels:i}=this;this.updating=!0;let a=l=>{let c=l.tabs;if(l.explicitTabs===void 0)l.tabs=Array.from(r),r.clear();else{l.tabs=Array.from(l.explicitTabs);for(let d of l.tabs)r.delete(d)}xe(c,l.tabs)||(l.normalizeTabs(),l.tabsChanged.dispatch())};for(let l=1;l<i.length;){let c=i[l];if(c.location.visible&&(a(c),c.tabs.length!==0)){++l;continue}i.splice(l,1),e.unregisterDisposer(c)}if(a(i[0]),i[0].tabs.length===0){let{selectedLayer:l}=this.layer.manager.root;((o=l.layer)==null?void 0:o.layer)===this.layer&&(l.location.visible=!1)}this.updating=!1}toJSON(){var r;let{panels:e}=this,t={};if(t[yg]=e[0].selectedTab.value,e.length>1){let i=[];for(let a=1,o=e.length;a<o;++a){let l=e[a],c=(r=l.location.toJSON())!=null?r:{};c[yg]=l.selectedTab.value;let{explicitTabs:d}=l;d!==void 0&&(c[ZM]=Array.from(d)),i.push(c)}t[eR]=i}return t}};function nR(n,e){n.remove(e)}function rR(n,e){n.add(e)}var aR="tool",oR="toolBindings",nC="localPosition",sR="localDimensions",lR="source",Dj="transform",cR="pick",uR=class{constructor(){this.callbacks=[]}defer(e){this.callbacks.push(e)}},bi=class extends H{constructor(e){super();this.managedLayer=e;this.pick=new Xe(!0,!0);this.layersChanged=new ne;this.readyStateChanged=new ne;this.specificationChanged=new ne;this.renderLayers=new Array;this.loadingCounter=1;this.tabs=this.registerDisposer(new nb);this.panels=new tC(this);this.tool=this.registerDisposer(new Ox(this));this.toolBinder=new Bx(this);this.dataSourcesChanged=new ne;this.dataSources=[];this.localCoordinateSpaceCombiner.includeDimensionPredicate=SS,this.tabs.changed.add(this.specificationChanged.dispatch),this.panels.specificationChanged.add(this.specificationChanged.dispatch),this.tool.changed.add(this.specificationChanged.dispatch),this.toolBinder.changed.add(this.specificationChanged.dispatch),this.localPosition.changed.add(this.specificationChanged.dispatch),this.pick.changed.add(this.specificationChanged.dispatch),this.pick.changed.add(this.layersChanged.dispatch),this.dataSourcesChanged.add(this.specificationChanged.dispatch),this.dataSourcesChanged.add(()=>this.updateDataSubsourceActivations()),this.tabs.add("source",{label:"Source",order:-100,getter:()=>new Zx(this)})}get localPosition(){return this.managedLayer.localPosition}get localCoordinateSpaceCombiner(){return this.managedLayer.localCoordinateSpaceCombiner}get localCoordinateSpace(){return this.managedLayer.localCoordinateSpace}get type(){return this.constructor.type}initializeSelectionState(e){e.generation=-1,e.localPositionValid=!1,e.localPosition=Xa,e.localCoordinateSpace=void 0,e.annotationId=void 0,e.annotationType=void 0,e.annotationBuffer=void 0,e.annotationIndex=void 0,e.annotationCount=void 0,e.annotationSourceIndex=void 0,e.annotationSubsource=void 0,e.annotationPartIndex=void 0,e.value=void 0}resetSelectionState(e){e.localPositionValid=!1,e.annotationId=void 0,e.value=void 0}selectionStateFromJson(e,t){let r=e.localCoordinateSpace=this.localCoordinateSpace.value,{rank:i}=r;if(i!==0){let o=ie(t,nC,l=>Pe(new Float32Array(i),l,Ke));o===void 0?e.localPositionValid=!1:(e.localPositionValid=!0,e.localPosition=o)}(e.annotationId=ie(t,"annotationId",Z))!==void 0&&(e.annotationSourceIndex=ie(t,"annotationSource",ze,0),e.annotationPartIndex=ie(t,"annotationPart",ze),e.annotationSubsource=ie(t,"annotationSubsource",Z)),e.value=t.value}displaySelectionState(e,t,r){return!1}selectionStateToJson(e,t){let r={};if(e.localPositionValid){let{localPosition:i}=e;i.length>0&&(r.localPosition=Array.from(i))}return e.annotationId!==void 0&&(r.annotationId=e.annotationId,r.annotationPart=e.annotationPartIndex,r.annotationSource=e.annotationSourceIndex,r.annotationSubsource=e.annotationSubsource),e.value!=null&&(r.value=e.value),r}captureSelectionState(e,t){e.localCoordinateSpace=this.localCoordinateSpace.value;let r=this.localPosition.value,{localPosition:i}=e;i.length!==r.length?e.localPosition=r.slice():i.set(r),e.localPositionValid=!0,e.value=this.getValueAt(t.position,t)}copySelectionState(e,t){e.generation=t.generation,e.localPositionValid=t.localPositionValid,e.localCoordinateSpace=t.localCoordinateSpace;let r=t.localPosition,{localPosition:i}=e;i.length!==r.length?e.localPosition=r.slice():e.localPosition.set(r),e.annotationId=t.annotationId,e.annotationType=t.annotationType,e.annotationBuffer=t.annotationBuffer,e.annotationIndex=t.annotationIndex,e.annotationCount=t.annotationCount,e.annotationSourceIndex=t.annotationSourceIndex,e.annotationSubsource=t.annotationSubsource,e.annotationPartIndex=t.annotationPartIndex,e.value=t.value}get isReady(){return this.loadingCounter===0}get manager(){return this.managedLayer.manager}canAddDataSource(){return!0}addDataSource(e){let t=new Ux(this,e);return this.dataSources.push(t),this.dataSourcesChanged.dispatch(),t}activateDataSubsources(e){}updateDataSubsourceActivations(){function*e(){for(let t of this.dataSources){let{loadState:r}=t;if(!(r===void 0||r.error!==void 0))for(let i of r.subsources)if(i.enabled)yield i;else{let{activated:a}=i;i.messages.clearMessages(),a!==void 0&&(a.dispose(),i.activated=void 0,r.activatedSubsourcesChanged.dispatch())}}}this.activateDataSubsources(e.call(this))}decrementLoadingCounter(){--this.loadingCounter==0&&this.readyStateChanged.dispatch()}markLoading(){let e=this.localCoordinateSpaceCombiner.retain(),t=this.manager.root.coordinateSpaceCombiner.retain();return++this.loadingCounter==1&&this.readyStateChanged.dispatch(),()=>{e(),t(),this.decrementLoadingCounter()}}addCoordinateSpace(e){let t=this.manager.root.coordinateSpaceCombiner.bind(e),r=this.localCoordinateSpaceCombiner.bind(e);return()=>{t(),r()}}initializationDone(){let e=this.selectionState={};this.initializeSelectionState(e),this.decrementLoadingCounter()}getLegacyDataSourceSpecifications(e,t,r,i){return e===void 0?[]:[Rl(e,r)]}getDataSourceSpecifications(e){let t,r=U(e,lR,a=>Array.isArray(a)?a.map(o=>Rl(o)):typeof a=="object"?[Rl(a)]:(t=a,[])),i=U(e,Dj,oD);return r.push(...this.getLegacyDataSourceSpecifications(t,e,i,r)),r=r.filter(a=>a.url),r.length===0&&r.push(qh()),r}restoreState(e){this.tool.restoreState(e[aR]),this.toolBinder.restoreState(e[oR]),this.panels.restoreState(e),this.localCoordinateSpace.restoreState(e[sR]),this.localPosition.restoreState(e[nC]),this.constructor.supportsPickOption&&this.pick.restoreState(e[cR]);for(let t of this.getDataSourceSpecifications(e))this.addDataSource(t)}addRenderLayer(e){this.renderLayers.push(e);let{layersChanged:t}=this;return e.layerChanged.add(t.dispatch),e.userLayer=this,t.dispatch(),()=>this.removeRenderLayer(e)}removeRenderLayer(e){let{renderLayers:t,layersChanged:r}=this,i=t.indexOf(e);if(i===-1)throw new Error("Attempted to remove invalid RenderLayer");t.splice(i,1),e.layerChanged.remove(r.dispatch),e.userLayer=void 0,e.dispose(),r.dispatch()}disposed(){let{layersChanged:e}=this;$a(this.dataSources);for(let t of this.renderLayers)t.layerChanged.remove(e.dispatch),t.dispose();this.renderLayers.length=0,super.disposed()}getValueAt(e,t){let r,{renderLayers:i}=this,{pickedRenderLayer:a}=t;if(a!==null&&i.indexOf(a)!==-1&&(r=a.transformPickedValue(t),r=this.transformPickedValue(r),r!=null))return r;for(let o of i)if(r=o.getValueAt(e),r!=null)break;return this.transformPickedValue(r)}transformPickedValue(e){return e}toJSON(){return{type:this.type,[lR]:Pj(this.dataSources),[aR]:this.tool.toJSON(),[oR]:this.toolBinder.toJSON(),[sR]:this.localCoordinateSpace.toJSON(),[nC]:this.localPosition.toJSON(),[cR]:this.pick.toJSON(),...this.panels.toJSON()}}handleAction(e,t){}selectedValueToJson(e){return e}selectedValueFromJson(e){return e}setLayerPosition(e,t){let{globalPosition:r}=this.manager.root,{localPosition:i}=this;Sv(r.value,t,e.globalToRenderLayerDimensions),Sv(i.value,t,e.localToRenderLayerDimensions),i.changed.dispatch(),r.changed.dispatch()}};bi.supportsPickOption=!1;function Pj(n){if(n.length!==0)return n.length===1?n[0].toJSON():n.map(e=>e.toJSON())}var Ip=class extends H{constructor(e,t){super();this.manager=t;this.localCoordinateSpace=new Zs;this.localCoordinateSpaceCombiner=new Vc(this.localCoordinateSpace,Wo);this.localPosition=this.registerDisposer(new qi(this.localCoordinateSpace));this.nonArchivedLayerIndex=-1;this.readyStateChanged=new ne;this.layerChanged=new ne;this.specificationChanged=new ne;this.containers=new Set;this.layer_=null;this.visible=!0;this.archived=!1;this.name_=e}get layer(){return this.layer_}set layer(e){let t=this.layer_;if(t!=null&&(this.unregisterUserLayer(),t.dispose()),this.layer_=e,e!=null){let r=[e.layersChanged.add(this.layerChanged.dispatch),e.readyStateChanged.add(this.readyStateChanged.dispatch),e.specificationChanged.add(this.specificationChanged.dispatch)];this.unregisterUserLayer=()=>{r.forEach(i=>i())},this.readyStateChanged.dispatch(),this.layerChanged.dispatch()}}isReady(){let{layer:e}=this;return e!==null&&e.isReady}get name(){return this.name_}set name(e){e!==this.name_&&(this.name_=e,this.layerChanged.dispatch())}get supportsPickOption(){let e=this.layer;return e!==null&&e.constructor.supportsPickOption}get pickEnabled(){let e=this.layer;return e!==null&&e.constructor.supportsPickOption&&e.pick.value}set pickEnabled(e){let t=this.layer;t!==null&&t.constructor.supportsPickOption&&(t.pick.value=e)}toJSON(){let e=this.layer;if(e===null)return;let t=e.toJSON();return t.name=this.name,this.visible||(this.archived?t.archived=!0:t.visible=!1),t}setVisible(e){if(e!==this.visible){if(e&&this.archived){this.visible=!0,this.setArchived(!1);return}this.visible=e,this.layerChanged.dispatch()}}setArchived(e){if(this.archived!==e){if(e===!0){this.visible=!1,this.archived=!0;for(let{layerManager:t}of this.manager.root.subsets)!t.has(this)||t.removeManagedLayer(this)}else{for(let{layerManager:t}of this.manager.root.subsets)t.has(this)||t.addManagedLayer(this.addRef());this.archived=!1}this.layerChanged.dispatch()}}disposed(){this.layer=null,super.disposed()}},Sg=class extends H{constructor(){super();this.managedLayers=new Array;this.layerSet=new Set;this.layersChanged=new ne;this.readyStateChanged=new ne;this.specificationChanged=new ne;this.boundPositions=new WeakSet;this.numDirectUsers=0;this.nonArchivedLayerIndexGeneration=-1;this.renderLayerToManagedLayerMapGeneration=-1;this.renderLayerToManagedLayerMap_=new Map;this.scheduleRemoveLayersWithSingleRef=this.registerCancellable((0,vg.default)(()=>this.removeLayersWithSingleRef(),0));this.layersChanged.add(this.scheduleRemoveLayersWithSingleRef)}updateNonArchivedLayerIndices(){let e=this.layersChanged.count;if(e===this.nonArchivedLayerIndexGeneration)return;this.nonArchivedLayerIndexGeneration=e;let t=0;for(let r of this.managedLayers)r.archived||(r.nonArchivedLayerIndex=t++);for(let r of this.managedLayers)r.archived&&(r.nonArchivedLayerIndex=t++)}getLayerByNonArchivedIndex(e){let t=0;for(let r of this.managedLayers)if(!r.archived){if(t===e)return r;++t}}get renderLayerToManagedLayerMap(){let e=this.layersChanged.count,t=this.renderLayerToManagedLayerMap_;if(this.renderLayerToManagedLayerMapGeneration!==e){this.renderLayerToManagedLayerMapGeneration=e,t.clear();for(let r of this.managedLayers){let i=r.layer;if(i!==null)for(let a of i.renderLayers)t.set(a,r)}}return t}filter(e){let t=!1;this.managedLayers=this.managedLayers.filter(r=>e(r)?!0:(this.unbindManagedLayer(r),this.layerSet.delete(r),t=!0,!1)),t&&this.layersChanged.dispatch()}removeLayersWithSingleRef(){this.numDirectUsers>0||this.filter(e=>e.refCount!==1||e.archived)}updateSignalBindings(e,t){t(e.layerChanged,this.layersChanged.dispatch),t(e.readyStateChanged,this.readyStateChanged.dispatch),t(e.specificationChanged,this.specificationChanged.dispatch)}useDirectly(){return++this.numDirectUsers==1&&this.layersChanged.remove(this.scheduleRemoveLayersWithSingleRef),()=>{--this.numDirectUsers==0&&(this.layersChanged.add(this.scheduleRemoveLayersWithSingleRef),this.scheduleRemoveLayersWithSingleRef())}}addManagedLayer(e,t){return this.updateSignalBindings(e,rR),this.layerSet.add(e),e.containers.add(this),t===void 0&&(t=this.managedLayers.length),this.managedLayers.splice(t,0,e),this.layersChanged.dispatch(),this.readyStateChanged.dispatch(),e}*readyRenderLayers(){for(let e of this.managedLayers)!e.visible||!e.layer||(yield*e.layer.renderLayers)}unbindManagedLayer(e){this.updateSignalBindings(e,nR),e.containers.delete(this),e.manager.rootLayers.layersChanged.dispatch(),e.dispose()}clear(){for(let e of this.managedLayers)this.unbindManagedLayer(e);this.managedLayers.length=0,this.layerSet.clear(),this.layersChanged.dispatch()}remove(e){let t=this.managedLayers[e];this.unbindManagedLayer(t),this.managedLayers.splice(e,1),this.layerSet.delete(t),this.layersChanged.dispatch()}removeManagedLayer(e){let t=this.managedLayers.indexOf(e);if(t===-1)throw new Error("Internal error: invalid managed layer.");this.remove(t)}reorderManagedLayer(e,t){let r=this.managedLayers.length;if(e===t||e<0||e>=r||t<0||t>=r)return;let[i]=this.managedLayers.splice(e,1);this.managedLayers.splice(t,0,i),this.layersChanged.dispatch()}disposed(){this.clear(),super.disposed()}getLayerByName(e){return this.managedLayers.find(t=>t.name===e)}getUniqueLayerName(e){let t=e,r=0;for(;this.getLayerByName(t)!==void 0;)t=e+ ++r;return t}has(e){return this.layerSet.has(e)}get renderLayers(){let e=this;return{*[Symbol.iterator](){for(let t of e.managedLayers)if(t.layer!==null)for(let r of t.layer.renderLayers)yield r}}}get visibleRenderLayers(){let e=this;return{*[Symbol.iterator](){for(let t of e.managedLayers)if(!(t.layer===null||!t.visible))for(let r of t.layer.renderLayers)yield r}}}invokeAction(e){let t=new uR;for(let r of this.managedLayers){if(r.layer===null||!r.visible)continue;let i=r.layer;i.handleAction(e,t);for(let a of i.renderLayers)a.handleAction(e)}for(let r of t.callbacks)r()}},rC=class{constructor(){this.changed=new ne;this.coordinateSpace=Xr;this.position=Xa;this.unsnappedPosition=Xa;this.active=!1;this.displayDimensions=void 0;this.pickedRenderLayer=null;this.pickedValue=new X(0,0);this.pickedOffset=0;this.pickedAnnotationLayer=void 0;this.pickedAnnotationId=void 0;this.pickedAnnotationBuffer=void 0;this.pickedAnnotationBufferBaseOffset=void 0;this.pickedAnnotationIndex=void 0;this.pickedAnnotationCount=void 0;this.pickedAnnotationType=void 0;this.forcerFunction=void 0}removeForcer(e){e===this.forcerFunction&&(this.forcerFunction=void 0,this.setActive(!1))}setForcer(e){this.forcerFunction=e,e===void 0&&this.setActive(!1)}updateUnconditionally(){let{forcerFunction:e}=this;return e===void 0?!1:(e(),this.active)}setActive(e){(this.active!==e||e===!0)&&(this.active=e,this.changed.dispatch())}},iC=class extends H{constructor(e,t){super();this.layerManager=e;this.mouseState=t;this.changed=new ne;this.needsUpdate=!0;this.registerDisposer(t.changed.add(()=>{this.handleChange()})),this.registerDisposer(e.layersChanged.add(()=>{this.handleLayerChange()}))}handleLayerChange(){this.mouseState.active&&this.handleChange()}handleChange(){this.needsUpdate=!0,this.changed.dispatch()}update(){if(!this.needsUpdate)return;this.needsUpdate=!1;let e=this.mouseState,t=this.changed.count;if(e.active)for(let r of this.layerManager.managedLayers){let i=r.layer;if(r.visible&&i!==null){let{selectionState:a}=i;i.resetSelectionState(a),a.generation=t,i.captureSelectionState(a,e)}}}get(e){this.update();let{selectionState:t}=e;if(t.generation===this.changed.count)return t}toJSON(){this.update();let e={};for(let t of this.layerManager.managedLayers){let r=t.layer;if(r){let i=this.get(r);i!==void 0&&(e[t.name]=r.selectionStateToJson(i,!0))}}return e}},dR=10,aC={...mi,minSize:150,row:1},pR={...aC,visible:!0},oC=class extends H{constructor(e,t){super();this.coordinateSpace=e;this.layerSelectedValues=t;this.changed=new ne;this.history=[];this.historyIndex=0;this.location=new tr(aC);this.pin=new ke(!0);this.registerDisposer(Mn((r,i)=>{i||(this.capture(!0),r.registerDisposer(t.changed.add(r.registerCancellable((0,iR.default)(()=>this.capture(!0),100,{leading:!0,trailing:!0})))))},this.pin)),this.pin.changed.add(this.changed.dispatch),this.location.changed.add(this.changed.dispatch)}get value(){return this.value_}goBack(){let e=this.pin.value?this.historyIndex:this.history.length;e>0&&(this.historyIndex=e-1,this.value_=this.history[e-1],this.pin.value=!0,this.changed.dispatch())}canGoBack(){return(this.pin.value?this.historyIndex:this.history.length)>0}canGoForward(){return this.pin.value?this.historyIndex+1<this.history.length:!1}goForward(){if(!this.pin.value)return;let e=this.historyIndex;e+1<this.history.length&&(this.historyIndex=e+1,this.value_=this.history[e+1],this.changed.dispatch())}set value(e){if(e!==this.value_){if(this.value_=e,e!==void 0&&this.pin.value){let{history:t}=this;t.length=Math.min(t.length,this.historyIndex+1),t.push(e),t.length>dR&&t.splice(0,t.length-dR),this.historyIndex=t.length-1}this.changed.dispatch()}}captureSingleLayerState(e,t,r=!0){if(r===!1&&(!this.location.visible||this.pin.value))return;let i={};e.initializeSelectionState(i),t(i)&&(this.location.visible=!0,r===!0?this.pin.value=!0:r==="toggle"&&(this.pin.value=!this.pin.value),this.value={layers:[{layer:e,state:i}],coordinateSpace:this.coordinateSpace.value,position:void 0})}reset(){this.location.reset(),this.pin.value=!1,this.value=void 0}toJSON(){let{value:e}=this,t;if(this.location.visible){if(t=this.location.toJSON(pR),this.pin.value&&e!==void 0){let r={};for(let i of e.layers){let{layer:a}=i,o=a.selectionStateToJson(i.state,!1);Object.keys(o).length===0&&(o=void 0),r[i.layer.managedLayer.name]=o}e.position!==void 0&&(t.position=Array.from(e.position)),t.layers=r}}else t=this.location.toJSON(aC),t=Ai(t),t!==void 0&&(t.visible=!1);return t}select(){let{pin:e}=this;this.location.visible=!0,e.value=!e.value,e.value&&this.capture()}capture(e=!1){let t=Ij(this.layerSelectedValues);e&&t===void 0||(this.value=t)}restoreState(e){if(e===void 0){this.pin.value=!0,this.value=void 0;return}if(e===null){this.pin.value=!1,this.location.visible=!0,this.value=void 0;return}Q(e),this.location.restoreState(e,pR);let t=this.coordinateSpace.value,r=ie(e,"position",a=>Pe(new Float32Array(t.rank),a,Ke)),i=[];ie(e,"layers",a=>{Q(a);let{layerManager:o}=this.layerSelectedValues;for(let[l,c]of Object.entries(a)){let d=o.getLayerByName(l);if(d===void 0)return;let p=d.layer;if(p===null)return;Q(c);let h={};p.initializeSelectionState(h),p.selectionStateFromJson(h,c),i.push({layer:p,state:h})}}),this.pin.value=i.length>0||r!==void 0,this.value={position:r,coordinateSpace:t,layers:i}}};function Ij(n){let{mouseState:e}=n;if(!e.active)return;let t=[];for(let r of n.layerManager.managedLayers){let i=r.layer;if(i===null)continue;let a=n.get(i);if(a===void 0)continue;let o={};i.initializeSelectionState(o),i.copySelectionState(o,a),t.push({layer:i,state:o})}return{position:e.position.slice(),coordinateSpace:e.coordinateSpace,layers:t}}var fR=class extends H{constructor(e){super();this.view=e;this.messages=new Ui;this.seenGeneration=-1;this.state=void 0}},Aj=0,hR=class extends H{constructor(e,t,r,i,a,o){super();this.layerManager=e;this.renderLayerType=t;this.view=r;this.roles=i;this.layerAdded=a;this.visibility=o;this.visibleLayers_=new Map;this.debouncedUpdateVisibleLayers=this.registerCancellable((0,vg.default)(()=>this.updateVisibleLayers(),0));this.registerDisposer(e.layersChanged.add(this.debouncedUpdateVisibleLayers)),this.registerDisposer(i.changed.add(this.debouncedUpdateVisibleLayers)),this.updateVisibleLayers()}disposed(){this.visibleLayers.forEach(e=>e.dispose()),this.visibleLayers.clear(),super.disposed()}updateVisibleLayers(){let e=++Aj,{visibleLayers_:t,renderLayerType:r,layerAdded:i,roles:a}=this;for(let o of this.layerManager.readyRenderLayers())if(o instanceof r&&a.has(o.role)){let l=o,c=t.get(l);c===void 0&&(c=new fR(this.view),c.registerDisposer(l.messages.addChild(c.messages)),c.registerDisposer(l.addRef()),c.registerDisposer(l.visibility.add(this.visibility)),t.set(l,c),i(l,c),l.attach(c)),c.seenGeneration=e}for(let[o,l]of t)l.seenGeneration!==e&&(t.delete(o),l.dispose())}get visibleLayers(){return this.debouncedUpdateVisibleLayers.flush(),this.visibleLayers_}};function bg(n,e,t,r,i){return r.registerDisposer(new hR(n,e,r,t,(a,o)=>{o.registerDisposer(a.redrawNeeded.add(()=>r.scheduleRedraw()));let{backend:l}=a;l&&(l.rpc.invoke(XP,{layer:l.rpcId,view:r.rpcId}),o.registerDisposer(()=>l.rpc.invoke(QP,{layer:l.rpcId,view:r.rpcId}))),i!==void 0&&i(a,o),r.scheduleRedraw(),o.registerDisposer(()=>r.scheduleRedraw())},r.visibility))}var sC=class extends H{constructor(e){super();this.layerManager=e;this.changed=new ne;this.location=new tr(tR);this.registerDisposer(e),this.location.changed.add(()=>{var r,i;this.changed.dispatch();let t=(i=(r=this.layer)==null?void 0:r.layer)!=null?i:void 0;if(t!==void 0){let a=this.location.value;if(a.visible){let o=t.panels.panels[0];o.location.value!==a&&(o.location.value=a,o.location.locationChanged.dispatch())}}})}get layer(){return this.layer_}get visible(){return this.location.visible}toggle(e){this.layer===e&&this.visible?this.visible=!1:(this.layer=e,this.visible=!0)}set visible(e){let t=this.layer_;if(e===!0&&t===void 0){let{managedLayers:r}=this.layerManager;r.length>0?t=this.layer=r[0]:e=!1}if(e===!0&&t!==void 0){let r=t.layer;(r===null||r.panels.panels[0].tabs.length===0)&&(e=!1)}this.visible!==e&&(this.location.visible=e,!e&&t!==void 0&&this.maybeDeleteNewLayer(t),this.changed.dispatch())}maybeDeleteNewLayer(e){if(e.wasDisposed)return;let t=e.layer;t!==null&&t instanceof Yi&&(t.dataSources.some(r=>r.spec.url.length!==0)||yo(e))}set layer(e){if(e===this.layer_)return;let t=this.layer_;if(t!==void 0&&(this.existingLayerDisposer(),this.existingLayerDisposer=void 0,this.maybeDeleteNewLayer(t)),this.layer_=e,e!==void 0){let r=()=>{this.layer_=void 0,this.visible=!1,this.existingLayerDisposer=void 0,this.changed.dispatch()};e.registerDisposer(r);let i=e.specificationChanged.add(()=>{this.changed.dispatch()});this.existingLayerDisposer=()=>{let a=e.layer;if(a!==null){let o=a.tool.value;o!==void 0&&o.deactivate()}e.unregisterDisposer(r),i()}}else this.location.visible=!1;this.changed.dispatch()}toJSON(){let e=this.location.toJSON();return this.layer!==void 0&&(e.layer=this.layer.name),Ai(e)}restoreState(e){if(e===void 0){this.reset();return}Q(e),this.location.restoreState(e);let t=U(e,"layer",Vt),r=t!==void 0?this.layerManager.getLayerByName(t):void 0;r===void 0&&(this.visible=!1),this.layer=r}reset(){this.location.reset(),this.layer=void 0}},lC=class extends H{constructor(e,t){super();this.layerManager=e;this.filter=t;this.changed=new ne;this.validate=(0,vg.default)(()=>{let{layerName_:e}=this;if(e!==void 0){let t=this.layerManager.getLayerByName(e);t!==void 0&&this.filter(t)?(this.layer_=t,this.changed.dispatch()):(this.layer_=void 0,this.layerName_=void 0,this.changed.dispatch())}},0);this.registerDisposer(e),this.registerDisposer(e.specificationChanged.add(()=>{let{layer_:r}=this;if(r!==void 0)if(!this.layerManager.layerSet.has(r)||!this.filter(r))this.layer_=void 0,this.layerName_=void 0,this.changed.dispatch();else{let{name:i}=r;i!==this.layerName_&&(this.layerName_=i,this.changed.dispatch())}}))}get layer(){return this.layer_}get layerName(){return this.layerName_}set layer(e){this.layer_!==e&&(e!==void 0&&this.layerManager.layerSet.has(e)&&this.filter(e)?(this.layer_=e,this.layerName_=e.name):(this.layer_=void 0,this.layerName_=void 0),this.changed.dispatch())}set layerName(e){e!==this.layerName_&&(this.layer_=void 0,this.layerName_=e,this.changed.dispatch(),this.validate())}restoreState(e){let t=Vt(e);this.layerName=t}toJSON(){let{layer_:e}=this;return e!==void 0?e.name:this.layerName_}reset(){this.layerName_=void 0,this.layer_=void 0,this.changed.dispatch()}},xg=class extends H{constructor(e,t,r,i){super();this.layerManager=e;this.layer=t;this.predicate=r;this.getGroup=i;this.linkedLayers_=new Set;this.changed=new ne;this.linkedLayersChanged=new ne;this.root_=t;let a=this;this.root={get value(){return a.root_},changed:a.changed}}get linkedLayers(){return this.linkedLayers_}get rootGroup(){return this.getGroup(this.root.value)}reset(){this.isolate()}restoreState(e){if(e===void 0)return;let t=Z(e);this.linkByName(t)}toJSON(){let{root:{value:e}}=this;if(e!==this.layer)return e.managedLayer.name}isolate(e=!0){let{getGroup:t,layer:r,root_:i}=this;if(i===r){let{linkedLayers_:o}=this;if(o.size!==0){for(let l of o){let c=t(l);c.root_=l,c.changed.dispatch()}o.clear(),this.linkedLayersChanged.dispatch()}return}let a=t(i);a.linkedLayers_.delete(r),a.linkedLayersChanged.dispatch(),this.root_=r,e&&this.changed.dispatch()}linkByName(e){let{layer:t}=this,{managedLayer:r}=t,{layerManager:i}=this,a=i.getLayerByName(e);if(a===void 0||a===r)return;let o=a.layer;o!==null&&(!this.predicate(o)||this.linkToLayer(o))}linkToLayer(e){if(e===this.layer||this.root_===e)return;this.root_!==this.layer&&this.isolate(!1);let{getGroup:t}=this,r=t(e).root_;if(r===this.layer)return;let i=t(r);i.linkedLayers_.add(this.layer),i.linkedLayersChanged.dispatch(),this.root_=r,this.changed.dispatch()}disposed(){this.isolate(!1)}};function mR(n,e){let t=ie(e,"type",Z,"auto");n.archived=ie(e,"archived",ha,!1),n.archived?n.visible=!1:n.visible=ie(e,"visible",ha,!0);let r=Mp.get(t)||Yi;return n.layer=new r(n),e}function gR(n,e){try{let t=n.layer;if(t===null)return;t.restoreState(e),t.initializationDone()}catch(t){throw yo(n),t}}function yR(n,e){try{Q(e),mR(n,e),gR(n,e)}catch(t){throw yo(n),t}}function vR(n,e){try{yR(n,e)}catch(t){new Ee().setErrorMessage(t instanceof Error?t.message:""+t)}}function cC(n,e,t){let r=new Ip(e,n);return yR(r,t),r}var uC=class extends H{constructor(){super(...arguments);this.changed=new ne}},dC=class extends uC{constructor(e,t,r,i,a,o,l,c,d){super();this.display=e;this.dataSourceProviderRegistry=t;this.layerManager=r;this.chunkManager=i;this.selectionState=a;this.selectedLayer=o;this.coordinateSpace=l;this.globalPosition=c;this.toolBinder=d;this.coordinateSpaceCombiner=new Vc(this.coordinateSpace,rD);this.subsets=new Set;this.layerSelectedValues=this.selectionState.layerSelectedValues;this.registerDisposer(r.layersChanged.add(this.changed.dispatch)),this.registerDisposer(r.specificationChanged.add(this.changed.dispatch))}get rpc(){return this.chunkManager.rpc}get root(){return this}reset(){this.layerManager.clear()}restoreState(e){this.layerManager.clear();let t;Array.isArray(e)?t=e:(Q(e),t=Object.entries(e).map(([i,a])=>typeof a=="string"?{name:i,source:a}:(Q(a),{...a,name:i})));let r=[];for(let i of t){Q(i);let a=this.layerManager.getUniqueLayerName(U(i,"name",Z)),o=new Ip(a,this);try{mR(o,i),this.layerManager.addManagedLayer(o),r.push({managedLayer:o,spec:i})}catch(l){o.dispose(),new Ee().setErrorMessage(`Error creating layer ${JSON.stringify(a)}: `+(l instanceof Error)?l.message:""+l)}}for(let{managedLayer:i,spec:a}of r)try{gR(i,a)}catch(o){new Ee().setErrorMessage(`Error creating layer ${JSON.stringify(name)}: `+(o instanceof Error)?o.message:""+o)}}add(e,t){this.layerManager.managedLayers.indexOf(e)===-1&&(e.name=this.layerManager.getUniqueLayerName(e.name)),this.layerManager.addManagedLayer(e,t)}toJSON(){let e=[],t=0;for(let r of this.layerManager.managedLayers){let i=r.toJSON();i!=null&&(e.push(i),++t)}if(t!==0)return e}get rootLayers(){return this.layerManager}},Ap=class extends uC{constructor(e){super();this.master=e;this.changed=new ne;this.layerManager=this.registerDisposer(new Sg);this.registerDisposer(e);let{layerManager:t}=this;this.registerDisposer(t.layersChanged.add(this.changed.dispatch)),this.registerDisposer(t.specificationChanged.add(this.changed.dispatch)),e.subsets.add(this)}get rpc(){return this.master.rpc}get dataSourceProviderRegistry(){return this.master.dataSourceProviderRegistry}get chunkManager(){return this.master.chunkManager}get layerSelectedValues(){return this.master.layerSelectedValues}get root(){return this.master}disposed(){super.disposed(),this.master.subsets.delete(this)}reset(){this.layerManager.clear()}restoreState(e){let t=this.master.layerManager,r=[];for(let i of new Set(ge(e,Z))){let a=t.getLayerByName(i);if(a===void 0)throw new Error(`Undefined layer referenced in subset specification: ${JSON.stringify(i)}`);a.archived||r.push(a)}this.layerManager.clear();for(let i of r)this.layerManager.addManagedLayer(i.addRef())}toJSON(){return this.layerManager.managedLayers.map(e=>e.name)}add(e,t){this.master.layerManager.managedLayers.indexOf(e)===-1&&(e.name=this.master.layerManager.getUniqueLayerName(e.name),this.master.layerManager.addManagedLayer(e.addRef())),this.layerManager.addManagedLayer(e,t)}get rootLayers(){return this.master.rootLayers}},Mp=new Map,pC=new Map,SR=[n=>{let{volume:e}=n;if(e===void 0)return;let t=pC.get(e.volumeType);if(t!==void 0)return{layerConstructor:t,priority:0}}];function Ki(n,e=n.type){Mp.set(e,n)}function gs(n){SR.push(n)}function Cg(n,e){pC.set(n,e)}function Pp(n,e){let t=n.layer;if(t===null)return;let r=t.toJSON(),i=new e(n);i.restoreState(r),i.initializationDone(),n.layer=i}function gg(n,e){return e!==n.name?(e=n.manager.root.layerManager.getUniqueLayerName(e),n.name=e,n.layerChanged.dispatch(),!0):!1}function yo(n){if(!n.wasDisposed)for(let e of n.containers)e.removeManagedLayer(n)}function fC(n,e){return n===void 0?e:e===void 0?n:n.priority<e.priority?e:n}function Mj(n){let e;for(let r of SR)e=fC(e,r(n));let{volume:t}=n;if(t!==void 0){let r=pC.get(t.volumeType);r!==void 0&&(e=fC(e,{layerConstructor:r,priority:0}))}return e}function bR(n){let e;for(let t of n){let{subsourceEntry:r}=t,{subsource:i}=r;e=fC(e,Mj(i))}return e}var Yi=class extends bi{activateDataSubsources(e){var t;this.detectedLayerConstructor=(t=bR(e))==null?void 0:t.layerConstructor}};Yi.type="new",Yi.typeAbbreviation="new";var wg=class extends bi{activateDataSubsources(e){var r;let t=(r=bR(e))==null?void 0:r.layerConstructor;t!==void 0&&Pp(this.managedLayer,t)}};wg.type="auto",wg.typeAbbreviation="auto";function Tg(n,e){let t=cC(n,"new layer",{type:"new"});n.add(t),e.layer=t,e.visible=!0}Ki(Yi);Ki(wg);var kR=Ye(gt());var Rj="DisjointUint64Sets",xR="DisjointUint64Sets.add",CR="DisjointUint64Sets.clear",wR="DisjointUint64Sets.highBitRepresentativeChanged",TR="DisjointUint64Sets.deleteSet",Va=class extends Za{constructor(){super(...arguments);this.disjointSets=new Pl;this.changed=new ne}get value(){return this}static makeWithCounterpart(e,t){let r=new this;return r.disjointSets.visibleSegmentEquivalencePolicy=t,r.registerDisposer(t.changed.add(()=>{LR(r)})),r.initializeCounterpart(e),t.value&&LR(r),r}disposed(){this.disjointSets=void 0,this.changed=void 0,super.disposed()}link(e,t){if(this.disjointSets.link(e,t)){let{rpc:r}=this;return r&&r.invoke(xR,{id:this.rpcId,al:e.low,ah:e.high,bl:t.low,bh:t.high}),this.changed.dispatch(),!0}return!1}linkAll(e){for(let t=1,r=e.length;t<r;++t)this.link(e[0],e[t])}has(e){return this.disjointSets.has(e)}get(e){return this.disjointSets.get(e)}clear(){if(this.disjointSets.clear()){let{rpc:e}=this;e&&e.invoke(CR,{id:this.rpcId}),this.changed.dispatch()}}setElements(e){return this.disjointSets.setElements(e)}deleteSet(e){if(this.disjointSets.deleteSet(e)){let{rpc:t}=this;t&&t.invoke(TR,{id:this.rpcId,l:e.low,h:e.high}),this.changed.dispatch()}}get size(){return this.disjointSets.size}toJSON(){return this.disjointSets.toJSON()}restoreState(e){if(e!==void 0){let t=[new X,new X];ge(e,r=>{ge(r,(i,a)=>{t[a%2].parseString(String(i),10),a!==0&&this.link(t[0],t[1])})})}}assignFrom(e){this.clear(),e instanceof Va&&(e=e.disjointSets);for(let[t,r]of e)this.link(t,r)}};Va=Pt([Ho(Rj)],Va);var lu=new X,hC=new X;Lt(xR,function(n){let e=this.get(n.id);lu.low=n.al,lu.high=n.ah,hC.low=n.bl,hC.high=n.bh,e.disjointSets.link(lu,hC)&&e.changed.dispatch()});Lt(CR,function(n){let e=this.get(n.id);e.disjointSets.clear()&&e.changed.dispatch()});function LR(n){n.rpc.invoke(wR,{id:n.rpcId,value:n.disjointSets.visibleSegmentEquivalencePolicy.value})}Lt(wR,function(n){let e=this.get(n.id);e.disjointSets.visibleSegmentEquivalencePolicy.value=n.value});Lt(TR,function(n){let e=this.get(n.id);lu.low=n.l,lu.high=n.h,e.disjointSets.deleteSet(lu)&&e.changed.dispatch()});var mC=class extends sl{constructor(){super(...arguments);this.spanningTreeEdges=new Map;this.equivalences=new Va;this.connections=new Set;this.changed=new $e}link(e,t){this.equivalences.link(e,t);for(let r of this.connections)r.segmentsState.segmentEquivalences.link(e,t)}linkAll(e){this.equivalences.linkAll(e);for(let t of this.connections)t.segmentsState.segmentEquivalences.linkAll(e)}deleteSet(e){this.equivalences.deleteSet(e);for(let t of this.connections)t.segmentsState.segmentEquivalences.deleteSet(e)}normalizeAll(){for(let e of this.connections)gC(e.segmentsState.visibleSegments,e.segmentsState.segmentEquivalences.disjointSets)}addSpanningTreeEdge(e,t){let r=e.toString(),i=t.toString(),{spanningTreeEdges:a}=this,o=a.get(r);o===void 0&&(o=new Set,a.set(r,o));let l=a.get(i);l===void 0&&(l=new Set,a.set(i,l)),o.add(i),l.add(r)}removeSpanningTreeEdge(e,t){let r=e.toString(),i=t.toString(),{spanningTreeEdges:a}=this,o=a.get(r),l=a.get(i);o.delete(i),o.size===0&&a.delete(r),l.delete(r),l.size===0&&a.delete(i)}*getSpanningTreeNeighbors(e){let t=new X,r=this.spanningTreeEdges.get(e.toString());if(r!==void 0)for(let i of r)t.parseString(i),yield t}restoreState(e){let{equivalences:t,spanningTreeEdges:r}=this;if(t.clear(),r.clear(),e===void 0)return;let i=[new X,new X];ge(e,a=>{ge(a,(o,l)=>{i[l%2].parseString(String(o),10),l!==0&&t.link(i[0],i[1])&&this.addSpanningTreeEdge(i[0],i[1])})})}toJSON(){let{spanningTreeEdges:e}=this;if(e.size===0)return;let t=new Array;for(let[r,i]of e){let a=X.parseString(r);for(let o of i){let l=X.parseString(o);X.compare(a,l)>0||t.push([a,l])}}return t.sort((r,i)=>X.compare(r[0],i[0])||X.compare(r[1],i[1])),t.map(r=>r.map(i=>i.toString()))}get visibleSegmentEquivalencePolicy(){return Kt.MIN_REPRESENTATIVE}async merge(e,t){let{equivalences:r}=this;return X.equal(r.get(e),r.get(t))?e:(this.addSpanningTreeEdge(e,t),this.link(e,t),this.normalizeAll(),this.changed.dispatch(),r.get(e))}async split(e,t){let r=this.computeSplit(e,t);if(r===void 0)throw new Error("Segments are already split");let{includeBaseSegments:i,includeRepresentative:a,excludeBaseSegments:o,excludeRepresentative:l}=r,{equivalences:c}=this;this.deleteSet(e),this.linkAll(i),this.linkAll(o);let d=(g,v)=>{for(let b of g)for(let x of this.getSpanningTreeNeighbors(b))X.equal(c.get(x),v)||this.removeSpanningTreeEdge(b,x)},p=c.get(e),h=c.get(t);d(i,p),d(o,h);for(let g of this.connections){let{visibleSegments:v}=g.segmentsState;v.has(l)&&(v.delete(l),v.add(a))}return this.normalizeAll(),this.changed.dispatch(),{include:p,exclude:h}}trackSegment(e,t){return()=>{}}computeSplit(e,t){let{equivalences:r}=this,i=r.get(e);if(!X.equal(i,r.get(t)))return;let a=new Pl;for(let h of r.setElements(i))if(!X.equal(h,t))for(let g of this.getSpanningTreeNeighbors(h))X.equal(g,t)||a.link(h,g);let o=[],l=[],c=a.get(e),d=e,p=t;for(let h of r.setElements(i))X.equal(a.get(h),c)?(o.push(h),X.compare(h,d)<0&&(d=h)):(l.push(h),X.compare(h,p)<0&&(p=h));return o.sort(X.compare),l.sort(X.compare),{includeBaseSegments:o,includeRepresentative:d,excludeBaseSegments:l,excludeRepresentative:p}}connect(e){let t=e.displayState.segmentationGroupState.value,r=new ER(this,t);return t.segmentEquivalences.assignFrom(this.equivalences),gC(t.visibleSegments,t.segmentEquivalences.disjointSets),r.registerDisposer(t.visibleSegments.changed.add(r.registerCancellable((0,kR.default)(()=>gC(t.visibleSegments,t.segmentEquivalences.disjointSets),0)))),this.connections.add(r),r.registerDisposer(()=>{this.connections.delete(r)}),r}};function gC(n,e){let t=[];for(let r of n.unsafeKeys()){let i=e.get(r);X.equal(r,i)||(t.push(i),n.delete(r))}for(let r of t)n.add(r)}var ER=class extends ll{computeSplit(e,t){return this.graph.computeSplit(e,t)}};var _j=K.create(),Vj=K.create(),Lg=.001,DR=.001;function PR(n){let e=0;for(var t=0;t<3;++t)n[t]<0&&(e+=1<<t);return e}var kg=new Float32Array([0,0,0,1,0,0,0,1,0,1,1,0,0,0,1,1,0,1,0,1,1,1,1,1]),IR=(()=>{let n=[0,1,2,4,5,3,6,7],e=[0,1,2,5,3,4,6,7],t=[0,1,1,4,4,7,4,7,1,5,0,1,1,4,4,7,0,2,2,5,5,7,5,7,2,6,0,2,2,5,5,7,0,3,3,6,6,7,6,7,3,4,0,3,3,6,6,7],r=[0,1,2,3,4,5,6,7,1,4,5,0,3,7,2,6,2,6,0,5,7,3,1,4,3,0,6,4,1,2,7,5,4,3,7,1,0,6,5,2,5,2,1,7,6,0,4,3,6,7,3,2,5,4,0,1,7,5,4,6,2,1,3,0],i=new Int32Array(8*8*6);for(let a=0;a<8;++a)for(let o=0;o<t.length;++o){let l=e[a]*8+t[o];i[a*8*6+o]=n[r[l]]}return i})();function Nl(n){n.addUniform("highp vec3","uPlaneNormal"),n.addUniform("highp float","uPlaneDistance"),n.addUniform("highp ivec2","uVertexIndex",24),n.addUniform("highp vec3","uVertexBasePosition",8),n.addInitializer(e=>{e.gl.uniform3fv(e.uniform("uVertexBasePosition"),kg)}),n.addVertexCode(`
vec3 getBoundingBoxPlaneIntersectionVertexPosition(vec3 chunkSize, vec3 boxLower, vec3 lowerClipBound, vec3 upperClipBound, int vertexIndex, float planeDistance) {
  for (int e = 0; e < 4; ++e) {
    highp ivec2 vidx = uVertexIndex[vertexIndex*4 + e];
    highp vec3 v1 = max(lowerClipBound, min(upperClipBound, chunkSize * uVertexBasePosition[vidx.x] + boxLower));
    highp vec3 v2 = max(lowerClipBound, min(upperClipBound, chunkSize * uVertexBasePosition[vidx.y] + boxLower));
    highp vec3 vDir = v2 - v1;
    highp float denom = dot(vDir, uPlaneNormal);
    if (abs(denom) > ${DR}) {
      highp float lambda = (planeDistance - dot(v1, uPlaneNormal)) / denom;
      if ((lambda >= -${Lg}) && (lambda <= (1.0 + ${Lg}))) {
        lambda = clamp(lambda, 0.0, 1.0);
        highp vec3 position = v1 + lambda * vDir;
        return position;
      }
    }
  }
  return vec3(0, 0, 0);
}
vec3 getBoundingBoxPlaneIntersectionVertexPosition(vec3 chunkSize, vec3 boxLower, vec3 lowerClipBound, vec3 upperClipBound, int vertexIndex) {
  return getBoundingBoxPlaneIntersectionVertexPosition(chunkSize, boxLower, lowerClipBound, upperClipBound, vertexIndex, uPlaneDistance);
}
`)}function AR(n,e,t,r,i,a,o,l=!0){let c=PR(i),d=IR.subarray(c*48,(c+1)*48),p=[0,0],h=[K.create(),K.create()],g=K.create(),v=K.create(),b=x=>kg.subarray(x*3,x*3+3);for(let x=0;x<4;++x){for(let T=0;T<2;++T)p[T]=d[2*(o*4+x)+T],K.multiply(h[T],n,b(p[T])),K.add(h[T],h[T],a),K.min(h[T],h[T],t),K.max(h[T],h[T],e);K.subtract(g,h[1],h[0]);let C=K.dot(g,i);if(Math.abs(C)>DR){let T=(r-K.dot(h[0],i))/C;if(T>=-Lg&&T<=1+Lg)return l&&console.log(`vertex ${o}, e = ${x}, good, lambda=${T}, denom=${C}, v0=${h[0].join()}, vDir=${g.join()}`),T=Math.max(0,Math.min(1,T)),K.scaleAndAdd(v,h[0],g,T),v;l&&console.log(`vertex ${o}, e = ${x}, skipped, denom = ${C}, vDir = ${g.join()}, v0=${h[0].join()}, v1=${h[1].join()}uPlaneNormal = ${No(i)}, lambda=${T}`)}else l&&console.log(`vertex ${o}, e = ${x}, skipped, deom = ${C}, vDir = ${No(g)}, uPlaneNormal = ${No(i)}, uLowerClipBound=${e.join()}, uUpperClipBound=${t.join()}, chunkSize=${n}, uVertexBasePosition(v0)=${b(p[0]).join()}, uVertexBasePosition(v1)=${b(p[1]).join()}, uTranslation=${a.join()}`)}}function Oj(n,e,t){let{gl:r}=n;r.uniform3fv(n.uniform("uPlaneNormal"),e),r.uniform1f(n.uniform("uPlaneDistance"),t);let i=PR(e);r.uniform2iv(n.uniform("uVertexIndex"),IR.subarray(i*48,(i+1)*48))}function cu(n,e,t,r,i){let a=Xf(_j,e,r);K.normalize(a,a);let o=K.dot(K.transformMat4(Vj,t,i),a);Oj(n,a,o)}var yC=!1,MR=.001,RR=oe.create();function Nj(n,e){if(Cr(n),Nl(n),n.addUniform("highp vec3","uTranslation"),n.addUniform("highp mat4","uProjectionMatrix"),n.addUniform("highp vec3","uChunkDataSize"),n.addUniform("highp vec3","uLowerClipBound"),n.addUniform("highp vec3","uUpperClipBound"),e){rr(n),n.setVertexMain(`
int vertexIndex1 = gl_VertexID / ${yi};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex2);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`),n.setFragmentMain(`
emit(vec4(1.0, 1.0, 1.0, getLineAlpha()));
`);return}n.addVarying("highp vec3","vChunkPosition"),n.setVertexMain(`
vec3 position = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, gl_VertexID);
gl_Position = uProjectionMatrix * vec4(position, 1.0);
gl_Position.z = 0.0;
vChunkPosition = (position - uTranslation) +
    ${MR} * abs(uPlaneNormal);
`)}function Bj(n,e,t,r,i,a,o){let l=K.create(),c=K.create(),d=K.fromValues(Math.abs(i[0]),Math.abs(i[1]),Math.abs(i[2])),p=K.create();for(let h=0;h<6;++h){let g=AR(n,e,t,r,i,a,h);if(g===void 0){console.log("no intersection found");return}K.transformMat4(l,g,o);let v=h!==0&&K.equals(l,p);K.copy(p,l),K.sub(c,g,a),K.scaleAndAdd(c,c,d,MR),console.log(`${v?"SKIPPED":"OUTPUT"} vertex ${h}, at ${l}, vChunkPosition = ${c}, uTranslation=${a.join()}, position=${g.join()}`)}}function Fj(n,e,t){t&&ar(n,e,1)}function Uj(n,e,t,r,i,a){let o=t.projectionParameters.value,{centerDataPosition:l}=o;cu(e,o.viewportNormalInGlobalCoordinates,l,a.transform,a.invTransform),n.uniformMatrix4fv(e.uniform("uProjectionMatrix"),!1,oe.multiply(RR,r,a.transform)),n.uniform3fv(e.uniform("uLowerClipBound"),i.lowerClipDisplayBound),n.uniform3fv(e.uniform("uUpperClipBound"),i.upperClipDisplayBound),yC&&(window.debug_sliceView_uLowerClipBound=i.lowerClipDisplayBound,window.debug_sliceView_uUpperClipBound=i.upperClipDisplayBound,window.debug_sliceView=t,window.debug_sliceView_dataToDevice=oe.clone(RR),window.debug_sliceView_chunkLayout=a)}function Gj(n,e,t){n.uniform3fv(e.uniform("uChunkDataSize"),t),yC&&(window.debug_sliceView_chunkDataSize=t)}function Wj(n,e,t,r){if(n.uniform3fv(e.uniform("uTranslation"),t),r?ir(e.gl,6,1):n.drawArrays(n.TRIANGLE_FAN,0,6),yC){let a=window.debug_sliceView.projectionParameters.value,o=window.debug_sliceView_chunkDataSize,l=window.debug_sliceView_uLowerClipBound,c=window.debug_sliceView_uUpperClipBound,d=window.debug_sliceView_dataToDevice,p=window.debug_sliceView_chunkLayout;console.log(`Drawing chunk: ${t.join()} of data size ${o.join()}, projection`,d);let h=p.globalToLocalNormal(K.create(),a.viewportNormalInGlobalCoordinates),g=K.dot(K.transformMat4(K.create(),a.centerDataPosition,p.invTransform),h);Bj(o,l,c,g,h,t,d)}}function zj(n,e,t){return n>e?t>n?n:e>t?e:t:t>e?e:n>t?n:t}var Rp=class extends Gc{constructor(e,t){let{shaderError:r=ga(),shaderParameters:i}=t;super(e.chunkManager,e,t);let{gl:a}=this;this.vertexIdHelper=this.registerDisposer(Jn.get(a)),this.shaderParameters=i;let{channelCoordinateSpace:o}=t;this.channelCoordinateSpace=o===void 0?Pr(Xr):o,this.registerDisposer(i.changed.add(this.redrawNeeded.dispatch));let l=this.registerDisposer(Mt((c,d)=>({numChannelDimensions:c.rank,dataHistogramChannelSpecifications:d}),[this.channelCoordinateSpace,this.dataHistogramSpecifications.channels]));this.shaderGetter=Vd(this,a,{memoizeKey:`volume/RenderLayer:${lt(this.constructor)}`,fallbackParameters:t.fallbackShaderParameters,parameters:i,encodeParameters:t.encodeShaderParameters,shaderError:r,extraParameters:l,defineShader:(c,d,p,h)=>{let{chunkFormat:g,dataHistogramsEnabled:v}=d,{dataHistogramChannelSpecifications:b,numChannelDimensions:x}=h;if(Nj(c,g===null),c.addOutputBuffer("vec4","v4f_fragData0",0),c.addFragmentCode(`
void emit(vec4 color) {
  v4f_fragData0 = color;
}
`),g===null)return;Cm(c,g,x,"vChunkPosition");let C=b.length;if(v&&C>0){let T="",{dataType:P}=g;for(let I=0;I<C;++I){let{channel:M}=b[I],D=`out_histogram${I}`;c.addOutputBuffer("vec4",D,1+I);let E=`getDataValue(${M.join(",")})`,V=`invlerpForHistogram${I}`;c.addFragmentCode(il(c,V,P,!1)),c.addFragmentCode(`
float getHistogramValue${I}() {
  return invlerpForHistogram${I}(${E});
}
`),T+=`{
float x = getHistogramValue${I}();
if (x < 0.0) x = 0.0;
else if (x > 1.0) x = 1.0;
else x = (1.0 + x * 253.0) / 255.0;
${D} = vec4(x, x, x, 1.0);
}`}c.addFragmentCode(`void userMain();
void main() {
  ${T}
  userMain();
}
#define main userMain
`)}this.defineShader(c,p)},getContextKey:c=>{var d;return`${(d=c.chunkFormat)==null?void 0:d.shaderKey}/${c.dataHistogramsEnabled}`}}),this.tempChunkPosition=new Float32Array(e.rank),this.initializeCounterpart()}get dataType(){return this.multiscaleSource.dataType}getValueAt(e){let{tempChunkPosition:t}=this;for(let{source:r,chunkTransform:i}of this.visibleSourcesList){if(!Vi(t,e,this.localPosition.value,i.layerRank,i.combinedGlobalLocalToChunkTransform))continue;let a=r.getValueAt(t,i);if(a!=null)return a}return null}beginChunkFormat(e,t,r){let{gl:i}=this,a=this.dataHistogramSpecifications.visibility.visible,o=this.shaderGetter({chunkFormat:t,dataHistogramsEnabled:a}),{shader:l,parameters:c,fallback:d}=o;if(l!==null&&(l.bind(),Fj(l,r,t===null),t!==null)){if(a){let{dataHistogramChannelSpecifications:p}=o.extraParameters,h=p.length,g=this.dataHistogramSpecifications.bounds.value;for(let v=0;v<h;++v)eo(l,`invlerpForHistogram${v}`,t.dataType,g[v])}this.initializeShader(e,l,c,d),t.beginDrawing(i,l)}return o}endSlice(e,t,r){}draw(e){let{sliceView:t}=e,r=t.visibleLayers.get(this),{visibleSources:i}=r;if(i.length===0)return;let{projectionParameters:a,wireFrame:o}=e,{gl:l}=this;this.vertexIdHelper.enable();let c=K.create(),{renderScaleHistogram:d}=this;d!==void 0&&d.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);let p,h=null,g,v=K.create(),b=()=>{h!==null&&(g!==null&&g.endDrawing(l,h),this.endSlice(t,h,p.parameters))},x=!0;for(let C of i){let T=Nc(a,C.chunkLayout),{chunkTransform:{channelToChunkDimensionIndices:P}}=C,I=C.source,{fixedPositionWithinChunk:M,chunkDisplayDimensionIndices:D}=C;for(let N of D)M[N]=0;let E=o?null:I.chunkFormat;if(E!==g&&(g=E,b(),p=this.beginChunkFormat(t,E,a),h=p.shader),h===null)continue;let V=I.chunks;v.fill(1);let O=T.size,B,z=I.spec.rank;Uj(l,h,t,a.viewProjectionMat,C,T),E!==null&&E.beginSource(l,h),x=!0;let _=0,F=0;if(t.forEachVisibleChunk(C,T,N=>{let J=V.get(N);if(J&&J.state===tt.GPU_MEMORY){let ae=J.chunkDataSize;if(ae!==B){B=ae;for(let me=0;me<3;++me){let Ae=D[me];v[me]=Ae===-1||Ae>=z?1:B[Ae]}Gj(l,h,v)}let{chunkGridPosition:pe}=J;for(let me=0;me<3;++me){let Ae=D[me];c[me]=Ae===-1||Ae>=z?0:O[me]*pe[Ae]}E!==null&&E.bindChunk(l,h,J,M,D,P,x),x=!1,Wj(l,h,c,o),++_}else++F}),(_!==0||F!==0)&&d!==void 0){let{effectiveVoxelSize:N}=C,J=zj(N[0],N[1],N[2]);d.add(J,J/a.pixelSize,_,F)}}if(b(),this.vertexIdHelper.disable(),!e.wireFrame){let C=this.getDataHistogramCount();C>0&&t.computeHistograms(C,this.dataHistogramSpecifications)}}};var vC=class{constructor(e){this.disjointSets=e;this.generation=Number.NaN;this.hashMap=new jc}update(){let{disjointSets:e}=this,{generation:t}=e;if(this.generation!==t){this.generation=t;let{hashMap:r}=this;r.clear();for(let[i,a]of e.mappings())r.set(i,a)}}},_R=1,VR=2,Eg=class extends Rp{constructor(e,t){super(e,{shaderParameters:new fd(r=>({hasEquivalences:r.registerDisposer(Mt(i=>i.size!==0,[t.segmentationGroupState.value.segmentEquivalences])),hasSegmentStatedColors:r.registerDisposer(Mt((i,a,o)=>(o?a:i).size!==0,[t.segmentStatedColors,t.tempSegmentStatedColors2d,t.useTempSegmentStatedColors2d])),hasSegmentDefaultColor:r.registerDisposer(Mt((i,a)=>i!==void 0||a!==void 0,[t.segmentDefaultColor,t.tempSegmentDefaultColor2d])),hasHighlightColor:r.registerDisposer(Mt(i=>i!==void 0,[t.highlightColor])),hideSegmentZero:t.hideSegmentZero,baseSegmentColoring:t.baseSegmentColoring,baseSegmentHighlighting:t.baseSegmentHighlighting})),transform:t.transform,renderScaleHistogram:t.renderScaleHistogram,renderScaleTarget:t.renderScaleTarget,localPosition:t.localPosition});this.displayState=t;this.segmentationGroupState=this.displayState.segmentationGroupState.value;this.segmentColorShaderManager=new wb("segmentColorHash");this.segmentStatedColorShaderManager=new Lb("segmentStatedColor");this.hashTableManager=new sm("visibleSegments");this.gpuHashTable=this.registerDisposer(Sl.get(this.gl,this.segmentationGroupState.visibleSegments.hashTable));this.gpuTemporaryHashTable=Sl.get(this.gl,this.segmentationGroupState.temporaryVisibleSegments.hashTable);this.equivalencesShaderManager=new Zd("equivalences");this.equivalencesHashMap=new vC(this.segmentationGroupState.segmentEquivalences.disjointSets);this.temporaryEquivalencesHashMap=new vC(this.segmentationGroupState.temporarySegmentEquivalences.disjointSets);this.gpuEquivalencesHashTable=this.registerDisposer(Sl.get(this.gl,this.equivalencesHashMap.hashMap));this.gpuTemporaryEquivalencesHashTable=this.registerDisposer(Sl.get(this.gl,this.temporaryEquivalencesHashMap.hashMap));this.registerDisposer(this.shaderParameters),zb(t,this),this.registerDisposer(t.selectedAlpha.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.notSelectedAlpha.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.ignoreNullVisibleSet.changed.add(this.redrawNeeded.dispatch))}disposed(){var e;(e=this.gpuSegmentStatedColorHashTable)==null||e.dispose()}getSources(e){return this.multiscaleSource.getSources({...e,discreteValues:!0})}defineShader(e,t){this.hashTableManager.defineShader(e);let r=`
uint64_t getUint64DataValue() {
  uint64_t x = toUint64(getDataValue());
`;r+=`return x;
}
`,e.addFragmentCode(r),t.hasEquivalences?(this.equivalencesShaderManager.defineShader(e),e.addFragmentCode(`
uint64_t getMappedObjectId(uint64_t value) {
  uint64_t mappedValue;
  if (${this.equivalencesShaderManager.getFunctionName}(value, mappedValue)) {
    return mappedValue;
  }
  return value;
}
`)):e.addFragmentCode(`
uint64_t getMappedObjectId(uint64_t value) {
  return value;
}
`),e.addUniform("highp uvec2","uSelectedSegment"),e.addUniform("highp uint","uFlags"),e.addUniform("highp float","uSelectedAlpha"),e.addUniform("highp float","uNotSelectedAlpha"),e.addUniform("highp float","uSaturation");let i=`
  uint64_t baseValue = getUint64DataValue();
  uint64_t value = getMappedObjectId(baseValue);
  uint64_t valueForColor = ${t.baseSegmentColoring?"baseValue":"value"};
  uint64_t valueForHighlight = ${t.baseSegmentHighlighting?"baseValue":"value"};

  float alpha = uSelectedAlpha;
  float saturation = uSaturation;
`;t.hideSegmentZero&&(i+=`
  if (value.value[0] == 0u && value.value[1] == 0u) {
    emit(vec4(vec4(0, 0, 0, 0)));
    return;
  }
`),i+=`
  bool has = (uFlags & ${VR}u) != 0u ? true : ${this.hashTableManager.hasFunctionName}(value);
  if ((uFlags & ${_R}u) != 0u && uSelectedSegment == valueForHighlight.value) {
    float adjustment = has ? 0.5 : 0.75;
    if (saturation > adjustment) {
      saturation -= adjustment;
    } else {
      saturation += adjustment;
    }
`,t.hasHighlightColor&&(e.addUniform("highp vec4","uHighlightColor"),i+=`
    emit(uHighlightColor);
    return;
`),i+=`
  } else if (!has) {
    alpha = uNotSelectedAlpha;
  }
`;let a=`vec4 getMappedIdColor(uint64_t value) {
`;t.hasSegmentStatedColors&&(this.segmentStatedColorShaderManager.defineShader(e),a+=`
  vec4 rgba;
  if (${this.segmentStatedColorShaderManager.getFunctionName}(value, rgba)) {
    return rgba;
  }
`),t.hasSegmentDefaultColor?(e.addUniform("highp vec4","uSegmentDefaultColor"),a+=`  return uSegmentDefaultColor;
`):(this.segmentColorShaderManager.defineShader(e),a+=`  return vec4(segmentColorHash(value), 0.0);
`),a+=`
}
`,e.addFragmentCode(a),i+=`
  vec4 rgba = getMappedIdColor(valueForColor);
  if (rgba.a > 0.0) {
    alpha = rgba.a;
  }
  emit(vec4(mix(vec3(1.0,1.0,1.0), vec3(rgba), saturation), alpha));
`,e.setFragmentMain(i)}initializeShader(e,t,r){let{gl:i}=this,{displayState:a,segmentationGroupState:o}=this,{segmentSelectionState:l}=this.displayState,{segmentDefaultColor:{value:c},segmentColorHash:{value:d},highlightColor:{value:p},tempSegmentDefaultColor2d:{value:h}}=this.displayState,g=sb(o),v=this.displayState.ignoreNullVisibleSet.value,b=0,x=0,C=0;if(l.hasSelectedSegment&&a.hoverHighlight.value){let P=a.baseSegmentHighlighting.value?l.baseSelectedSegment:l.selectedSegment;b=P.low,x=P.high,C|=_R}if(i.uniform1f(t.uniform("uSelectedAlpha"),a.selectedAlpha.value),i.uniform1f(t.uniform("uSaturation"),a.saturation.value),i.uniform1f(t.uniform("uNotSelectedAlpha"),a.notSelectedAlpha.value),i.uniform2ui(t.uniform("uSelectedSegment"),b,x),g.hashTable.size===0&&v&&(C|=VR),i.uniform1ui(t.uniform("uFlags"),C),this.hashTableManager.enable(i,t,o.useTemporaryVisibleSegments.value?this.gpuTemporaryHashTable:this.gpuHashTable),r.hasEquivalences){let P=o.useTemporarySegmentEquivalences.value;(P?this.temporaryEquivalencesHashMap:this.equivalencesHashMap).update(),this.equivalencesShaderManager.enable(i,t,P?this.gpuTemporaryEquivalencesHashTable:this.gpuEquivalencesHashTable)}let T=h||c;if(T){let[P,I,M,D]=T;i.uniform4f(t.uniform("uSegmentDefaultColor"),P,I,M,D===void 0?0:D)}else this.segmentColorShaderManager.enable(i,t,d);if(r.hasSegmentStatedColors){let P=a.useTempSegmentStatedColors2d.value?a.tempSegmentStatedColors2d.value:a.segmentStatedColors.value,{gpuSegmentStatedColorHashTable:I}=this;(I===void 0||I.hashTable!==P.hashTable)&&(I==null||I.dispose(),this.gpuSegmentStatedColorHashTable=I=Sl.get(i,P.hashTable)),this.segmentStatedColorShaderManager.enable(i,t,I)}p!==void 0&&i.uniform4fv(t.uniform("uHighlightColor"),p)}endSlice(e,t,r){let{gl:i}=this;this.hashTableManager.disable(i,t),r.hasEquivalences&&this.equivalencesShaderManager.disable(i,t),r.hasSegmentStatedColors&&this.segmentStatedColorShaderManager.disable(i,t),super.endSlice(e,t,r)}};function Bl(n=.5){return new Ce(n,ah)}var Fl=class extends H{constructor(e,t){super();this.register=e;this.changed=new ne;this.disposerMap=new Map;if(t===void 0)this.map=new Map;else{let r=this.map=new Map(t),{disposerMap:i}=this;for(let[a,o]of r){let l=new H;i.set(a,l),e(l,o,a)}}}get value(){return this.map}set(e,t){let{map:r,disposerMap:i}=this,a=i.get(e);return a!==void 0&&a.dispose(),a=new H,i.set(e,a),r.set(e,t),this.register(a,t,e),this.changed.dispatch(),this}delete(e){let{map:t,disposerMap:r}=this,i=r.get(e);return i!==void 0?(i.dispose(),r.delete(e),t.delete(e),this.changed.dispatch(),!0):!1}get(e){return this.map.get(e)}has(e){return this.map.has(e)}get size(){return this.map.size}[Symbol.iterator](){return this.map[Symbol.iterator]()}clear(){let{map:e,disposerMap:t}=this;if(e.size>0){for(let r of t.values())r.dispose();e.clear(),t.clear(),this.changed.dispatch()}}values(){return this.map.values()}keys(){return this.map.keys()}disposed(){let{map:e,disposerMap:t}=this;for(let r of t.values())r.dispose();e.clear(),t.clear(),super.disposed()}};var OR=class extends ke{},NR=class extends Fl{constructor(){super((e,{showMatches:t,segmentationState:r})=>{e.registerDisposer(t.changed.add(this.changed.dispatch)),e.registerDisposer(r.changed.add(this.changed.dispatch)),e.registerDisposer(Mn((i,a)=>{if(a==null)return;let{segmentationGroupState:o}=a;i.registerDisposer(o.changed.add(this.changed.dispatch)),i.registerDisposer(Mn((l,c)=>{let{visibleSegments:d}=c,p=d.size===0;l.registerDisposer(d.changed.add(()=>{let h=d.size===0;h!==p&&(p=h,this.changed.dispatch())}))},o))},r))})}get(e){let t=super.get(e);return t===void 0&&(t={segmentationState:new ke(void 0),showMatches:new Xe(!1)},super.set(e,t)),t}},BR=`
void main() {
  setColor(defaultColor());
}
`,_p=class extends H{constructor(){super(...arguments);this.annotationProperties=new ke(void 0);this.shader=Jo(BR);this.shaderControls=new ao(this.shader,vn(e=>{let t=new Map;if(e===void 0)return null;for(let r of e){let i=Ld[r.type];i!==void 0&&t.set(r.identifier,i)}return{properties:t}},this.annotationProperties));this.fallbackShaderControls=new ke(Ko(io(BR)));this.shaderError=ga();this.color=new Bo(K.fromValues(1,1,0));this.relationshipStates=this.registerDisposer(new NR);this.ignoreNullSegmentFilter=new Xe(!0);this.displayUnfiltered=vn((e,t)=>{for(let r of e.values())if(r.showMatches.value){if(!t)return!1;let i=r.segmentationState.value;if(i!=null&&i.segmentationGroupState.value.visibleSegments.size>0)return!1}return!0},this.relationshipStates,this.ignoreNullSegmentFilter);this.hoverState=new OR(void 0)}},ys=class extends H{constructor(e){super();let{transform:t,localPosition:r,source:i,role:a=_n.ANNOTATION}=e;this.transform=t,this.localPosition=r,this.source=this.registerDisposer(i),this.role=a,this.displayState=e.displayState,this.chunkTransform=this.registerDisposer(vn(o=>Il(()=>el(bp(o))),this.transform)),this.dataSource=e.dataSource,this.subsourceId=e.subsourceId,this.subsourceIndex=e.subsourceIndex,this.subsubsourceId=e.subsubsourceId}get sourceIndex(){let{dataSource:e}=this;return e.layer.dataSources.indexOf(e)}};var Vp=12,SC=8,Hj=6,FR=`
vec3 getBoxFaceVertexPosition(int vertexIndex) {
  const vec3 vertexPositions[] = vec3[](
  // Front face
  vec3(0.0, 0.0,  1.0), // 0
  vec3(1.0, 0.0,  1.0), // 1
  vec3(1.0,  1.0,  1.0), // 2
  vec3(0.0,  1.0,  1.0), // 3

  // Back face
  vec3(0.0, 0.0, 0.0), // 4
  vec3(0.0,  1.0, 0.0), // 5
  vec3(1.0,  1.0, 0.0), // 6
  vec3(1.0, 0.0, 0.0), // 7

  // Top face
  vec3(0.0,  1.0, 0.0), // 8
  vec3(0.0,  1.0,  1.0), // 9
  vec3(1.0,  1.0,  1.0), // 10
  vec3(1.0,  1.0, 0.0), // 11

  // Bottom face
  vec3(0.0, 0.0, 0.0), // 12
  vec3( 1.0, 0.0, 0.0), // 13
  vec3( 1.0, 0.0,  1.0), // 14
  vec3(0.0, 0.0,  1.0), // 15

  // Right face
  vec3( 1.0, 0.0, 0.0), // 16
  vec3( 1.0,  1.0, 0.0), // 17
  vec3( 1.0,  1.0,  1.0), // 18
  vec3( 1.0, 0.0,  1.0), // 19

  // Left face
  vec3(0.0, 0.0, 0.0), // 20
  vec3(0.0, 0.0,  1.0), // 21
  vec3(0.0,  1.0,  1.0), // 22
  vec3(0.0,  1.0, 0.0) // 23
  );
  const int indices[] = int[](
    0,  1,  2,      0,  2,  3,    // front
    4,  5,  6,      4,  6,  7,    // back
    8,  9,  10,     8,  10, 11,   // top
    12, 13, 14,     12, 14, 15,   // bottom
    16, 17, 18,     16, 18, 19,   // right
    20, 21, 22,     20, 22, 23   // left
  );
  return vertexPositions[indices[vertexIndex]];
}
`;function UR(n,e,t){n.drawArraysInstanced(WebGL2RenderingContext.TRIANGLES,0,6*Hj*e,t)}var GR=0,Dg=GR+1,qn=Dg+SC,bC=qn+Vp,$j=bC+6,jj=Float32Array.from([0,0,0,0,0,1,qn+0,1,0,0,1,0,1,qn+1,0,1,0,0,1,1,qn+2,1,1,0,1,1,1,qn+3,0,0,0,0,1,0,qn+4,0,0,1,0,1,1,qn+5,1,0,0,1,1,0,qn+6,1,0,1,1,1,1,qn+7,0,0,0,1,0,0,qn+8,0,0,1,1,0,1,qn+9,0,1,0,1,1,0,qn+10,0,1,1,1,1,1,qn+11]),WR=oe.create(),vs=new Float32Array(6),xC=class extends oo{constructor(){super(...arguments);this.vertexIdHelper=this.registerDisposer(Jn.get(this.gl))}defineShader(e){Cr(e);let{rank:t}=this;qo(e,"float",WebGL2RenderingContext.FLOAT,!1,"Bounds",t,2),e.addUniform("vec3","uModelSpaceBoundOffsets",2)}enable(e,t,r){oe.invert(WR,t.modelViewProjectionMatrix),xE(WR,vs);let{numChunkDisplayDims:i}=t.chunkDisplayTransform;for(let a=0;a<i;++a)vs[a]=0,vs[a+3]=0;for(let a=i;a<3;++a){let o=Math.abs(vs[a+3]-vs[a]);vs[a]-=o,vs[a+3]+=o}super.enable(e,t,a=>{let o=a.vertexShaderInputBinders.Bounds;o.enable(1);let{gl:l}=this;l.uniform3fv(a.uniform("uModelSpaceBoundOffsets"),vs),l.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),o.bind(this.geometryDataStride,t.bufferOffset);let{vertexIdHelper:c}=this;c.enable(),r(a),c.disable(),o.disable()})}};function zR(n){n.addVertexCode(`
void setBoundingBoxBorderWidth(float width) {}
void setBoundingBoxBorderColor(vec4 color) {}
`)}function HR(n){n.addVertexCode(`
void setBoundingBoxFillColor(vec4 color) {}
`)}function CC(n){HR(n),n.addVertexCode(`
float ng_lineWidth;
void setBoundingBoxBorderWidth(float size) {
  ng_lineWidth = size;
}
void setBoundingBoxBorderColor(vec4 color) {
  vColor = color;
}
`)}function Jj(n){zR(n),n.addVertexCode(`
void setBoundingBoxFillColor(vec4 color) {
  vColor = color;
}
`)}var $R=class extends xC{constructor(){super(...arguments);this.edgeBoxCornerOffsetsBuffer=this.registerDisposer(Gt.fromData(this.gl,cd(jj,7,1,yi)));this.edgeShaderGetter=this.getDependentShader("annotation/boundingBox/projection/border",e=>{let{rank:t}=this;this.defineShader(e),rr(e),e.addAttribute("highp vec3","aBoxCornerOffset1"),e.addAttribute("highp vec4","aBoxCornerOffset2"),e.addVarying("highp float","vClipCoefficient"),CC(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
vec3 endpointA = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset1);
vec3 endpointB = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset2.xyz);
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
ng_lineWidth = 1.0;
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(endpointA, 1.0),
         uModelViewProjection * vec4(endpointB, 1.0),
         ng_lineWidth);
${this.setPartIndex(e,"uint(aBoxCornerOffset2.w)")};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, getLineAlpha() * vClipCoefficient));
`)});this.boxCornerOffsetsBuffer=this.registerDisposer(Gt.fromData(this.gl,cd(kg,3,1,Sm)));this.cornerShaderGetter=this.getDependentShader("annotation/boundingBox/projection/corner",e=>{let{rank:t}=this;this.defineShader(e),us(e,this.targetIsSliceView),e.addAttribute("highp vec3","aBoxCornerOffset"),e.addVarying("highp float","vClipCoefficient"),CC(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
vClipCoefficient = getMaxEndpointSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
vec3 vertexPosition = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset);
emitCircle(uModelViewProjection * vec4(vertexPosition, 1.0), ng_lineWidth, 0.0);
uint cornerIndex = uint(aBoxCornerOffset.x + aBoxCornerOffset.y * 2.0 + aBoxCornerOffset.z * 4.0);
uint cornerPickOffset = ${Dg}u + cornerIndex;
${this.setPartIndex(e,"cornerPickOffset")};
`),e.setFragmentMain(`
vec4 borderColor = vec4(0.0, 0.0, 0.0, 1.0);
vec4 color = getCircleColor(vColor, borderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)})}drawEdges(e){let{gl:t}=this;this.enable(this.edgeShaderGetter,e,r=>{let i=r.attribute("aBoxCornerOffset1"),a=r.attribute("aBoxCornerOffset2");this.edgeBoxCornerOffsetsBuffer.bindToVertexAttrib(i,3,WebGL2RenderingContext.FLOAT,!1,4*7,0),this.edgeBoxCornerOffsetsBuffer.bindToVertexAttrib(a,4,WebGL2RenderingContext.FLOAT,!1,4*7,4*3),ar(r,e.renderContext.projectionParameters,1),ir(t,Vp,e.count),t.disableVertexAttribArray(i),t.disableVertexAttribArray(a)})}drawCorners(e){let{gl:t}=this;this.enable(this.cornerShaderGetter,e,r=>{let i=r.attribute("aBoxCornerOffset");this.boxCornerOffsetsBuffer.bindToVertexAttrib(i,3,WebGL2RenderingContext.FLOAT,!1),ds(r,e.renderContext.projectionParameters,{featherWidthInPixels:0}),ps(r.gl,SC,e.count),t.disableVertexAttribArray(i)})}draw(e){this.drawEdges(e),this.drawCorners(e)}},jR=class extends xC{constructor(){super(...arguments);this.faceShaderGetter=this.getDependentShader("annotation/boundingBox/crossSection/face",e=>{let{rank:t}=this;super.defineShader(e),Nl(e),rr(e),e.addVarying("highp float","vClipCoefficient"),CC(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
for (int i = 0; i < ${t}; ++i) {
  float a = modelPositionA[i];
  float b = modelPositionB[i];
  modelPositionA[i] = min(a, b);
  modelPositionB[i] = max(a, b);
}
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
int vertexIndex1 = gl_VertexID / ${yi};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex2);
ng_lineWidth = 1.0;
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(vertexPosition1, 1.0),
         uModelViewProjection * vec4(vertexPosition2, 1.0),
         ng_lineWidth);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() * vClipCoefficient));
`)});this.fillShaderGetter=this.getDependentShader("annotation/boundingBox/crossSection/fill",e=>{let{rank:t}=this;super.defineShader(e),Nl(e),e.addVarying("highp float","vClipCoefficient"),Jj(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
for (int i = 0; i < ${t}; ++i) {
  float a = modelPositionA[i];
  float b = modelPositionB[i];
  modelPositionA[i] = min(a, b);
  modelPositionB[i] = max(a, b);
}
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
int vertexIndex = gl_VertexID;
vec3 vertexPosition = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex);
gl_Position = uModelViewProjection * vec4(vertexPosition, 1);
${this.invokeUserMain}
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, vColor.a * vClipCoefficient));
`)})}enableForBoundingBox(e,t,r){super.enable(e,t,i=>{let a=t.renderContext.sliceView.projectionParameters.value;cu(i,a.viewportNormalInGlobalCoordinates,a.centerDataPosition,t.renderSubspaceModelMatrix,t.renderSubspaceInvModelMatrix),r(i)})}draw(e){this.shaderControlState.parseResult.value.code.match(/\bsetBoundingBoxFillColor\b/)&&this.enableForBoundingBox(this.fillShaderGetter,e,()=>{JD(this.gl,WebGL2RenderingContext.TRIANGLE_FAN,0,6,e.count)}),this.enableForBoundingBox(this.faceShaderGetter,e,t=>{ar(t,e.renderContext.projectionParameters,1),ir(t.gl,6,e.count)})}};function qj(n,e){let t=n.length;for(let r=0;r<t;++r){let i=e[r],a=e[r+t],o=n[r];n[r]=Math.abs(i-o)<Math.abs(a-o)?i:a}}Xo(Be.AXIS_ALIGNED_BOUNDING_BOX,{sliceViewRenderHelper:jR,perspectiveViewRenderHelper:$R,defineShaderNoOpSetters(n){HR(n),zR(n)},pickIdsPerInstance:$j,snapPosition(n,e,t,r){let i=n.length,a=new Float32Array(e,t,i*2);r>=Dg&&r<qn?qj(n,a):r>=qn&&r<bC},getRepresentativePoint(n,e,t){t===GR||t>=Dg&&t<qn||t>=qn&&t<bC,n.set(e.pointA)},updateViaRepresentativePoint(n,e,t){let r=e.length,{pointA:i,pointB:a}=n,o=new Float32Array(r),l=new Float32Array(r);for(let c=0;c<r;++c){let d=o[c]=e[c];l[c]=a[c]+(d-i[c])}return{...n,pointA:o,pointB:l}}});var uu=0,wC=uu+1,Yj=wC+2;function JR(n){n.addVertexCode(`
void setEndpointMarkerSize(float startSize, float endSize) {}
void setEndpointMarkerBorderWidth(float startSize, float endSize) {}
void setEndpointMarkerColor(vec4 startColor, vec4 endColor) {}
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {}
`)}function qR(n){n.addVertexCode(`
void setLineWidth(float width) {}
void setLineColor(vec4 startColor, vec4 endColor) {}
`)}var TC=class extends oo{constructor(){super(...arguments);this.vertexIdHelper=this.registerDisposer(Jn.get(this.gl));this.edgeShaderGetter=this.getDependentShader("annotation/line/edge",e=>{let{rank:t}=this;this.defineShader(e),rr(e),e.addVarying(`highp float[${t}]`,"vModelPosition"),e.addVertexCode(`
float ng_LineWidth;
`),JR(e),e.addVertexCode(`
void setLineWidth(float width) {
  ng_LineWidth = width;
}
void setLineColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, getLineEndpointCoefficient());
}
`),e.setVertexMain(`
float modelPositionA[${t}] = getVertexPosition0();
float modelPositionB[${t}] = getVertexPosition1();
for (int i = 0; i < ${t}; ++i) {
  vModelPosition[i] = mix(modelPositionA[i], modelPositionB[i], getLineEndpointCoefficient());
}
ng_LineWidth = 1.0;
vColor = vec4(0.0, 0.0, 0.0, 0.0);
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionA), 1.0),
         uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionB), 1.0),
         ng_LineWidth);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
float clipCoefficient = getSubspaceClipCoefficient(vModelPosition);
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() *
                                ${this.getCrossSectionFadeFactor()} *
                                clipCoefficient));
`)});this.endpointShaderGetter=this.getDependentShader("annotation/line/endpoint",e=>{let{rank:t}=this;this.defineShader(e),us(e,this.targetIsSliceView),e.addVarying("highp float","vClipCoefficient"),e.addVarying("highp vec4","vBorderColor"),qR(e),e.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
int getEndpointIndex() {
  return gl_VertexID / ${Sm};
}
void setEndpointMarkerSize(float startSize, float endSize) {
  ng_markerDiameter = mix(startSize, endSize, float(getEndpointIndex()));
}
void setEndpointMarkerBorderWidth(float startSize, float endSize) {
  ng_markerBorderWidth = mix(startSize, endSize, float(getEndpointIndex()));
}
void setEndpointMarkerColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, float(getEndpointIndex()));
}
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {
  vBorderColor = mix(startColor, endColor, float(getEndpointIndex()));
}
`),e.setVertexMain(`
float modelPosition[${t}] = getVertexPosition0();
float modelPositionB[${t}] = getVertexPosition1();
for (int i = 0; i < ${t}; ++i) {
  modelPosition[i] = mix(modelPosition[i], modelPositionB[i], float(getEndpointIndex()));
}
vClipCoefficient = getSubspaceClipCoefficient(modelPosition);
vColor = vec4(0.0, 0.0, 0.0, 0.0);
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
${this.invokeUserMain}
emitCircle(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
${this.setPartIndex(e,"uint(getEndpointIndex()) + 1u")};
`),e.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)})}defineShader(e){Cr(e);let{rank:t}=this;qo(e,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",t,2)}enable(e,t,r){super.enable(e,t,i=>{let a=i.vertexShaderInputBinders.VertexPosition;a.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),a.bind(this.geometryDataStride,t.bufferOffset);let{vertexIdHelper:o}=this;o.enable(),r(i),o.disable(),a.disable()})}drawEdges(e){this.enable(this.edgeShaderGetter,e,t=>{ar(t,e.renderContext.projectionParameters,1),ir(t.gl,1,e.count)})}drawEndpoints(e){this.enable(this.endpointShaderGetter,e,t=>{ds(t,e.renderContext.projectionParameters,{featherWidthInPixels:.5}),ps(t.gl,2,e.count)})}draw(e){this.drawEdges(e),this.drawEndpoints(e)}};function Kj(n,e){let t=n.length;yE(n,e.subarray(0,t),e.subarray(t),n)}function Xj(n,e,t){let r=n.length,i=r*t;for(let a=0;a<r;++a)n[a]=e[i+a]}Xo(Be.LINE,{sliceViewRenderHelper:TC,perspectiveViewRenderHelper:TC,defineShaderNoOpSetters(n){JR(n),qR(n)},pickIdsPerInstance:Yj,snapPosition(n,e,t,r){let i=n.length,a=new Float32Array(e,t,i*2);r===uu?Kj(n,a):Xj(n,a,r-wC)},getRepresentativePoint(n,e,t){n.set(t===uu||t===wC?e.pointA:e.pointB)},updateViaRepresentativePoint(n,e,t){let r={...n},i=e.length;switch(t){case uu:{let{pointA:a,pointB:o}=n,l=new Float32Array(i),c=new Float32Array(i);for(let d=0;d<i;++d){let p=l[d]=e[d];c[d]=o[d]+(p-a[d])}return{...n,pointA:l,pointB:c}}case uu+1:return{...n,pointA:new Float32Array(e)};case uu+2:return{...n,pointB:new Float32Array(e)}}return r}});var LC=class extends oo{constructor(){super(...arguments);this.shaderGetter3d=this.getDependentShader("annotation/point:3d",e=>{Cr(e),us(e,this.targetIsSliceView),this.defineShaderCommon(e),e.addVertexMain(`
emitCircle(uModelViewProjection *
           vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
`),e.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
emitAnnotation(color);
`)});this.makeShaderGetter2d=e=>this.getDependentShader(`annotation/point:2d:${e}`,t=>{Cr(t),rr(t,!0),this.defineShaderCommon(t),t.addVertexMain(`
vec3 subspacePositionA = projectModelVectorToSubspace(modelPosition);
vec3 subspacePositionB = subspacePositionA;
vec4 baseProjection = uModelViewProjection * vec4(subspacePositionA, 1.0);
vec4 zCoeffs = uModelViewProjection[${e}];
float minZ = 1e30;
float maxZ = -1e30;
for (int i = 0; i < 3; ++i) {
  // Want: baseProjection[i] + z * zCoeffs[i] = -2.0 * (baseProjection.w - z * zCoeffs.w)
  //  i.e. baseProjection[i] + 2.0 * baseProjection.w < -z * (2.0 * zCoeffs.w + zCoeffs[i])
  //  i.e. baseProjection[i] + 2.0 * baseProjection.w < -z * k1
  float k1 = 2.0 * zCoeffs.w + zCoeffs[i];
  float q1 = -(baseProjection[i] + 2.0 * baseProjection.w) / k1;
  if (k1 != 0.0) {
    minZ = min(minZ, q1);
    maxZ = max(maxZ, q1);
  }
  // Want: baseProjection[i] + z * zCoeffs[i] = 2.0 * (baseProjection.w + z * zCoeffs.w)
  //  i.e. baseProjection[i] - 2.0 * baseProjection.w > z * (2.0 * zCoeffs.w - zCoeffs[i])
  //  i.e. baseProjection[i] - 2.0 * baseProjection.w > z * k2
  float k2 = 2.0 * zCoeffs.w - zCoeffs[i];
  float q2 = (baseProjection[i] - 2.0 * baseProjection.w) / k2;
  if (k2 != 0.0) {
    minZ = min(minZ, q2);
    maxZ = max(maxZ, q2);
  }
}
if (minZ > maxZ) minZ = maxZ = 0.0;
subspacePositionA[${e}] = minZ;
subspacePositionB[${e}] = maxZ;
emitLine(uModelViewProjection, subspacePositionA, subspacePositionB, ng_markerDiameter, ng_markerBorderWidth);
`),t.setFragmentMain(`
vec4 color = getRoundedLineColor(vColor, vBorderColor);
emitAnnotation(vec4(color.rgb, color.a * ${this.getCrossSectionFadeFactor()}));
`)});this.shaderGetter2d=this.makeShaderGetter2d(2);this.shaderGetter1d=this.makeShaderGetter2d(1);this.vertexIdHelper=this.registerDisposer(Jn.get(this.gl))}defineShaderCommon(e){let{rank:t}=this;qo(e,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",t),e.addVarying("highp vec4","vBorderColor"),e.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
void setPointMarkerSize(float size) {
  ng_markerDiameter = size;
}
void setPointMarkerBorderWidth(float size) {
  ng_markerBorderWidth = size;
}
void setPointMarkerColor(vec4 color) {
  vColor = color;
}
void setPointMarkerBorderColor(vec4 color) {
  vBorderColor = color;
}
`),e.addVertexMain(`
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
float modelPosition[${t}] = getVertexPosition0();
float clipCoefficient = getSubspaceClipCoefficient(modelPosition);
if (clipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
${this.invokeUserMain}
vColor.a *= clipCoefficient;
vBorderColor.a *= clipCoefficient;
${this.setPartIndex(e)};
`)}enable(e,t,r){super.enable(e,t,i=>{let a=i.vertexShaderInputBinders.VertexPosition;a.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),a.bind(this.geometryDataStride,t.bufferOffset);let{vertexIdHelper:o}=this;o.enable(),r(i),o.disable(),a.disable()})}draw(e){let{numChunkDisplayDims:t}=e.chunkDisplayTransform;switch(t){case 3:this.enable(this.shaderGetter3d,e,r=>{ds(r,e.renderContext.projectionParameters,{featherWidthInPixels:1}),ps(r.gl,1,e.count)});break;case 2:case 1:this.enable(t===2?this.shaderGetter2d:this.shaderGetter1d,e,r=>{ar(r,e.renderContext.projectionParameters,1),ir(r.gl,1,e.count)});break}}};Xo(Be.POINT,{sliceViewRenderHelper:LC,perspectiveViewRenderHelper:LC,defineShaderNoOpSetters(n){n.addVertexCode(`
void setPointMarkerSize(float size) {}
void setPointMarkerBorderWidth(float size) {}
void setPointMarkerColor(vec4 color) {}
void setPointMarkerBorderColor(vec4 color) {}
`)},pickIdsPerInstance:1,snapPosition(n,e,t){n.set(new Float32Array(e,t,n.length))},getRepresentativePoint(n,e){n.set(e.point)},updateViaRepresentativePoint(n,e){return{...n,point:new Float32Array(e)}}});var YR=`
struct EllipseQuadraticForm {
  highp float A;  // x*x coefficient
  highp float B;  // x*y coefficient
  highp float C;  // y*y coefficient
  highp float D;  // x coefficient
  highp float E;  // y coefficient
  highp float F;  // 1 coefficient
};
`,KR=[YR,`
EllipseQuadraticForm computeCrossSectionEllipse(mat3 A, vec3 c) {
  EllipseQuadraticForm p;
  p.A = A[0][0];
  p.B = A[0][1] + A[1][0];
  p.C = A[1][1];
  p.D = -2.0 * c[0] * A[0][0] - c[1] * (A[0][1] + A[1][0]) +
        c[2] * (A[0][2] + A[2][0]);
  p.E = -c[0] * (A[0][1] + A[1][0]) - 2.0 * c[1] * A[1][1] +
        c[2] * (A[1][2] + A[2][1]);
  p.F = c[0] * c[0] * A[0][0] + c[0] * c[1] * (A[0][1] + A[1][0]) -
        c[0] * c[2] * (A[0][2] + A[2][0]) + c[1] * c[1] * A[1][1] -
        c[1] * c[2] * (A[1][2] + A[2][1]) + c[2] * c[2] * A[2][2] - 1.0;
  return p;
}
`];function XR(n,e){let t=[[n[0],n[1],n[2]],[n[3],n[4],n[5]],[n[6],n[7],n[8]]];return{A:t[0][0],B:t[0][1]+t[1][0],C:t[1][1],D:-2*e[0]*t[0][0]-e[1]*(t[0][1]+t[1][0])+e[2]*(t[0][2]+t[2][0]),E:-e[0]*(t[0][1]+t[1][0])-2*e[1]*t[1][1]+e[2]*(t[1][2]+t[2][1]),F:e[0]*e[0]*t[0][0]+e[0]*e[1]*(t[0][1]+t[1][0])-e[0]*e[2]*(t[0][2]+t[2][0])+e[1]*e[1]*t[1][1]-e[1]*e[2]*(t[1][2]+t[2][1])+e[2]*e[2]*t[2][2]-1}}var Qj=`
struct CenterOrientEllipse {
  vec2 k;   // center
  vec2 u1;  // minor axis direction
  vec2 u2;  // major axis direction
  float a;  // semimajor axis
  float b;  // semiminor axis
  bool valid; // indicates if the ellipse is valid
};
`,QR=[YR,Qj,`
CenterOrientEllipse computeCenterOrientEllipse(EllipseQuadraticForm p) {
  CenterOrientEllipse r;
  float a11 = p.A;
  float a12 = p.B / 2.0;
  float a22 = p.C;
  float b1 = p.D;
  float b2 = p.E;
  float c = p.F;
  float kdenom = 2.0 * (a12 * a12 - a11 * a22);
  float k1 = r.k.x = (a22 * b1 - a12 * b2) / kdenom;
  float k2 = r.k.y = (a11 * b2 - a12 * b1) / kdenom;
  float mu = 1.0 / (a11 * k1 * k1 + 2.0 * a12 * k1 * k2 + a22 * k2 * k2 - c);
  float m11 = mu * a11;
  float m12 = mu * a12;
  float m22 = mu * a22;
  float lambdaTerm1 = m11 + m22;
  float lambdaTerm2 = sqrt((m11 - m22) * (m11 - m22) + 4.0 * m12 * m12);
  float lambda1 = ((lambdaTerm1 + lambdaTerm2) / 2.0);
  float lambda2 = ((lambdaTerm1 - lambdaTerm2) / 2.0);
  r.a = 1.0 / sqrt(lambda1);
  r.b = 1.0 / sqrt(lambda2);
  r.valid = lambda1 > 0.0 && lambda2 > 0.0;
  if (abs(m11 - m22) < 1e-6 && abs(m12) < 1e-6) {
    r.u1 = vec2(1.0, 0.0);
  } else if (m11 >= m22) {
    r.u1 = normalize(vec2(lambda1 - m22, m12));
  } else {
    r.u1 = normalize(vec2(m12, lambda1 - m11));
  }
  r.u2 = vec2(-r.u1.y, r.u1.x);
  return r;
}
`];function ZR(n){let e=n.A,t=n.B/2,r=n.C,i=n.D,a=n.E,o=n.F,l=2*(t*t-e*r),c=(r*i-t*a)/l,d=(e*a-t*i)/l,p=1/(e*c*c+2*t*c*d+r*d*d-o),h=p*e,g=p*t,v=p*r,b=h+v,x=Math.sqrt((h-v)*(h-v)+4*g*g),C=(b+x)/2,T=(b-x)/2,P=1/Math.sqrt(C),I=1/Math.sqrt(T),M;h>=v?M=hr.fromValues(C-v,g):M=hr.fromValues(g,C-h),hr.normalize(M,M);let D=hr.fromValues(-M[1],M[0]);return{k:hr.fromValues(c,d),u1:M,u2:D,a:P,b:I,lambda1:C,lambda2:T,m11:h,m12:g,m22:v,valid:C>0&&T>0}}function Zj(n,e){let t=new Float32Array((n+1)*(e+1)*3),r=0;for(let i=0;i<=n;++i){let a=i*Math.PI/n,o=Math.sin(a),l=Math.cos(a);for(let c=0;c<=e;++c){let d=c*2*Math.PI/e,p=Math.sin(d),h=Math.cos(d);t[r++]=h*o,t[r++]=l,t[r++]=p*o}}return t}function e5(n,e){let t=new Uint16Array(n*e*6),r=0;for(let i=0;i<n;i++)for(let a=0;a<e;a++){let o=i*(e+1)+a,l=o+e+1;t[r++]=o,t[r++]=l,t[r++]=o+1,t[r++]=l,t[r++]=l+1,t[r++]=o+1}return t}var kC=class extends H{constructor(e,t,r){super();this.vertexBuffer=this.registerDisposer(no(e,WebGL2RenderingContext.ARRAY_BUFFER,Zj,t,r)).value,this.indexBuffer=this.registerDisposer(no(e,WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER,e5,t,r)).value,this.numIndices=t*r*6}defineShader(e){e.addAttribute("highp vec3","aSphereVertex"),e.addVarying("highp float","vLightingFactor"),e.addVertexCode(`
void emitSphere(mat4 projectionMatrix, mat4 normalTransformMatrix, vec3 centerPosition, vec3 radii, vec4 lightDirection) {
  vec3 vertexPosition = aSphereVertex * radii + centerPosition;
  gl_Position = projectionMatrix * vec4(vertexPosition, 1.0);
  vec3 normal = normalize((normalTransformMatrix * vec4(aSphereVertex / max(radii, 1e-6), 0.0)).xyz);
  vLightingFactor = abs(dot(normal, uLightDirection.xyz)) + uLightDirection.w;
}
`)}draw(e,t){let r=e.attribute("aSphereVertex");this.vertexBuffer.bindToVertexAttrib(r,3,WebGL2RenderingContext.FLOAT,!1),this.indexBuffer.bind(),e.gl.drawElementsInstanced(WebGL2RenderingContext.TRIANGLES,this.numIndices,WebGL2RenderingContext.UNSIGNED_SHORT,0,t),e.gl.disableVertexAttribArray(r)}};var e_=oe.create(),t5=!1,EC=class extends oo{defineShader(e){let{rank:t}=this;qo(e,"float",WebGL2RenderingContext.FLOAT,!1,"CenterAndRadii",t,2),e.addVertexCode(`
struct SubspaceParams {
  highp vec3 subspaceCenter;
  highp vec3 subspaceRadii;
  highp float clipCoefficient;
  bool cull;
};
SubspaceParams getSubspaceParams() {
  SubspaceParams params;
  highp float modelCenter[${t}] = getCenterAndRadii0();
  highp float modelRadii[${t}] = getCenterAndRadii1();
  float radiusAdjustment = 1.0;
  float clipCoefficient = 1.0;
  for (int i = 0; i < ${t}; ++i) {
    float r = modelRadii[i];
    float c = modelCenter[i];
    float x = uModelClipBounds[i];
    float clipRadius = uModelClipBounds[i + ${t}];
    if (r != 0.0 && clipRadius != 0.0) {
      float d = c - x;
      d = d * d;
      radiusAdjustment -= d / (r * r);
    }
    float e = abs(x - clamp(x, c - r, c + r)) * clipRadius;
    clipCoefficient *= max(0.0, 1.0 - e);
  }
  radiusAdjustment = sqrt(max(0.0, radiusAdjustment));
  params.subspaceCenter = projectModelVectorToSubspace(modelCenter);
  params.subspaceRadii = projectModelVectorToSubspace(modelRadii) * radiusAdjustment;
  params.clipCoefficient = clipCoefficient;
  params.cull = clipCoefficient == 0.0 || radiusAdjustment == 0.0;
  return params;
}
void setEllipsoidFillColor(vec4 color) {
  vColor = color;
}
`)}enable(e,t,r){super.enable(e,t,i=>{let a=i.vertexShaderInputBinders.CenterAndRadii;a.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),a.bind(this.geometryDataStride,t.bufferOffset),r(i),a.disable()})}},t_=class extends EC{constructor(){super(...arguments);this.sphereRenderHelper=this.registerDisposer(new kC(this.gl,10,10));this.shaderGetter=this.getDependentShader("annotation/ellipsoid/projection",e=>{this.defineShader(e),this.sphereRenderHelper.defineShader(e),e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp mat4","uNormalTransform"),e.addVarying("highp float","vClipCoefficient"),e.setVertexMain(`
SubspaceParams params = getSubspaceParams();
if (params.cull) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vClipCoefficient = params.clipCoefficient;
${this.invokeUserMain}
emitSphere(uModelViewProjection, uNormalTransform, params.subspaceCenter, params.subspaceRadii, uLightDirection);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb * vLightingFactor, vColor.a * vClipCoefficient));
`)});this.tempLightVec=new Float32Array(4)}draw(e){this.enable(this.shaderGetter,e,t=>{let{gl:r}=t,i=this.tempLightVec,{lightDirection:a,ambientLighting:o,directionalLighting:l}=e.renderContext;K.scale(i,a,l),i[3]=o,r.uniform4fv(t.uniform("uLightDirection"),i),r.uniformMatrix4fv(t.uniform("uNormalTransform"),!1,oe.transpose(oe.create(),e.renderSubspaceInvModelMatrix)),this.sphereRenderHelper.draw(t,e.count)})}},n_=class extends EC{constructor(){super(...arguments);this.shaderGetter=this.getDependentShader("annotation/ellipsoid/crossSection",e=>{Cr(e),this.defineShader(e),e.addUniform("highp mat4","uViewportToObject"),e.addUniform("highp mat4","uObjectToViewport"),e.addUniform("highp mat4","uViewportToDevice"),e.addAttribute("highp vec2","aCornerOffset"),e.addVarying("highp vec2","vCircleCoord"),e.addVarying("highp float","vClipCoefficient"),e.addVertexCode(KR),e.addVertexCode(QR),e.addVertexCode(Xc),e.setVertexMain(`
SubspaceParams params = getSubspaceParams();
if (params.cull) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vClipCoefficient = params.clipCoefficient;
mat3 Aobject = mat3(0.0);
for (int i = 0; i < 3; ++i) {
  float r = max(params.subspaceRadii[i], 1e-3);
  Aobject[i][i] = 1.0 / (r * r);
}
mat3 RviewportToObject = mat3(uViewportToObject);
mat3 Aviewport = transpose(RviewportToObject) * Aobject * RviewportToObject;
vec3 cViewport = (uObjectToViewport * vec4(params.subspaceCenter, 1.0)).xyz;
EllipseQuadraticForm quadraticForm = computeCrossSectionEllipse(Aviewport, cViewport);
vec2 u1, u2;
float a, b;
CenterOrientEllipse centerOrient = computeCenterOrientEllipse(quadraticForm);
vec2 cornerOffset = getQuadVertexPosition(vec2(-1.0, -1.0), vec2(1.0, 1.0));
vec2 viewportCorner = centerOrient.k +
  centerOrient.u1 * cornerOffset.x * centerOrient.a +
  centerOrient.u2 * cornerOffset.y * centerOrient.b;
if (centerOrient.valid) {
  gl_Position = uViewportToDevice * vec4(viewportCorner, 0.0, 1.0);
} else {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
}
vCircleCoord = cornerOffset;
${this.invokeUserMain}
${this.setPartIndex(e)};
`),e.setFragmentMain(`
if (dot(vCircleCoord, vCircleCoord) > 1.0) {
  discard;
}
emitAnnotation(vec4(vColor.rgb, vColor.a * vClipCoefficient));
`)});this.vertexIdHelper=this.registerDisposer(Jn.get(this.gl))}draw(e){this.enable(this.shaderGetter,e,t=>{let{gl:r}=t,i=e.renderContext.sliceView.projectionParameters.value,a=oe.multiply(e_,e.renderSubspaceInvModelMatrix,i.invViewMatrix);r.uniformMatrix4fv(t.uniform("uViewportToObject"),!1,a),r.uniformMatrix4fv(t.uniform("uViewportToDevice"),!1,i.projectionMat);let o=e_;oe.invert(o,a),r.uniformMatrix4fv(t.uniform("uObjectToViewport"),!1,o);let{vertexIdHelper:l}=this;if(l.enable(),Qc(r,1,e.count),l.disable(),t5){let c=K.fromValues(3406.98779296875,3234.910400390625,4045),d=K.fromValues(10,10,10),p=It.create();p[0]=1/(d[0]*d[0]),p[4]=1/(d[1]*d[1]),p[8]=1/(d[2]*d[2]);let h=It.fromMat4(It.create(),a),g=It.multiply(It.create(),It.transpose(It.create(),h),p);It.multiply(g,g,h);let v=K.transformMat4(K.create(),c,o);console.log("Aviewport",g),console.log("cViewport",v);let b=XR(g,v),x=ZR(b);console.log(b),console.log(x)}})}};Xo(Be.ELLIPSOID,{sliceViewRenderHelper:n_,perspectiveViewRenderHelper:t_,defineShaderNoOpSetters(n){n.addVertexCode(`
void setEllipsoidFillColor(vec4 color) {}
`)},pickIdsPerInstance:1,snapPosition:()=>{},getRepresentativePoint(n,e){n.set(e.center)},updateViaRepresentativePoint(n,e){return{...n,center:new Float32Array(e)}}});var r_=oe.create(),i_=K.create();function a_(n){n.addUniform("highp vec3","uTranslation"),n.addUniform("highp mat4","uProjectionMatrix"),n.addUniform("highp vec3","uChunkDataSize"),n.addUniform("highp vec3","uLowerClipBound"),n.addUniform("highp vec3","uUpperClipBound"),n.setFragmentMain(`
emit(vec4(1.0, 1.0, 1.0, getLineAlpha()), 0u);
`)}var o_={defineShader(n){a_(n),rr(n),n.addVertexCode(`
const vec3[24] boxCornerOffsets = vec3[](
  vec3(0, 0, 0), vec3(0, 0, 1),  // e1
  vec3(1, 0, 0), vec3(1, 0, 1),  // e2
  vec3(0, 1, 0), vec3(0, 1, 1),  // e3
  vec3(1, 1, 0), vec3(1, 1, 1),  // e4
  vec3(0, 0, 0), vec3(0, 1, 0),  // e5
  vec3(0, 0, 1), vec3(0, 1, 1),  // e6
  vec3(1, 0, 0), vec3(1, 1, 0),  // e7
  vec3(1, 0, 1), vec3(1, 1, 1),  // e8
  vec3(0, 0, 0), vec3(1, 0, 0),  // e9
  vec3(0, 0, 1), vec3(1, 0, 1),  // e10
  vec3(0, 1, 0), vec3(1, 1, 0),  // e11
  vec3(0, 1, 1), vec3(1, 1, 1)  // e12
);
`),n.setVertexMain(`
int edgeIndex = gl_VertexID / ${yi};
vec3 cornerA = max(uLowerClipBound, min(uUpperClipBound, uTranslation));
vec3 cornerB = max(uLowerClipBound, min(uUpperClipBound, uTranslation + uChunkDataSize));
vec3 vertexPosition1 = mix(cornerA, cornerB, boxCornerOffsets[edgeIndex * 2]);
vec3 vertexPosition2 = mix(cornerA, cornerB, boxCornerOffsets[edgeIndex * 2 + 1]);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`)},initialize(n,e){ar(n,e,1)},draw(n,e,t){let{gl:r}=n,i=r_,{chunkLayout:a}=e;oe.multiply(i,t.viewProjectionMat,a.transform),r.uniformMatrix4fv(n.uniform("uProjectionMatrix"),!1,i),r.uniform3fv(n.uniform("uChunkDataSize"),a.size),r.uniform3fv(n.uniform("uLowerClipBound"),e.lowerClipDisplayBound),r.uniform3fv(n.uniform("uUpperClipBound"),e.upperClipDisplayBound);let o=a.size,{curPositionInChunks:l,chunkDisplayDimensionIndices:c}=e,d=i_;for(let p=0;p<3;++p){let h=c[p];d[p]=(h===-1?0:l[h])*o[p]}r.uniform3fv(n.uniform("uTranslation"),d),ir(r,Vp,1)}},s_={defineShader(n){Nl(n),a_(n),rr(n),n.setVertexMain(`
int vertexIndex1 = gl_VertexID / ${yi};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex2);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`)},initialize(n,e){ar(n,e,1)},draw(n,e,t){let{gl:r}=n,i=r_,{chunkLayout:a}=e;oe.multiply(i,t.viewProjectionMat,a.transform),r.uniformMatrix4fv(n.uniform("uProjectionMatrix"),!1,i),r.uniform3fv(n.uniform("uChunkDataSize"),a.size),r.uniform3fv(n.uniform("uLowerClipBound"),e.lowerClipDisplayBound),r.uniform3fv(n.uniform("uUpperClipBound"),e.upperClipDisplayBound);let o=a.size,{curPositionInChunks:l,chunkDisplayDimensionIndices:c}=e,d=i_;for(let p=0;p<3;++p){let h=c[p];d[p]=(h===-1?0:l[h])*o[p]}r.uniform3fv(n.uniform("uTranslation"),d),cu(n,t.viewportNormalInGlobalCoordinates,t.centerDataPosition,a.transform,a.invTransform),ir(r,6,1)}};var n5=oe.create();function r5(n){if(n!==void 0)return e=>{let{relatedSegments:t}=e;if(t===void 0)return!1;for(let r=0,i=t.length;r<i;++r){let a=n[r];if(a==null)continue;let{visibleSegments:o,segmentEquivalences:l}=a.segmentationGroupState.value;for(let c of t[r])if(o.has(l.get(c)))return!0}return!1}}function i5(n,e){let t=new rS(n.annotationPropertySerializers);for(let r of n)(e===void 0||e(r))&&t.add(r);return t.serialize()}var Pg=class extends ya(wa){constructor(e,t,r,i){super(i);this.chunkManager=e;this.source=t;this.segmentationStates=r;this.initializeCounterpart(this.chunkManager.rpc,{chunkManager:this.chunkManager.rpcId,source:t.rpcId,segmentationStates:this.serializeDisplayState()});let a=()=>{let o={id:this.rpcId,segmentationStates:this.serializeDisplayState()};this.rpc.invoke(GD,o)};this.registerDisposer(r.changed.add(a))}serializeDisplayState(){let{value:e}=this.segmentationStates;if(e!==void 0)return e.map(t=>t==null?t:$b(t.segmentationGroupState.value))}};Pg=Pt([wn(UD)],Pg);var DC=class extends H{constructor(e,t){super();this.chunkManager=e;this.state=t;this.layerChunkProgressInfo=new so;this.numPickIds=0;this.generation=-1;this.redrawNeeded=new ne;this.serializedAnnotations=void 0;this.handleChangeAffectingBuffer=()=>{this.generation=-1,this.redrawNeeded.dispatch()};this.segmentationStates=this.registerDisposer(Mt((e,t)=>{let{displayState:r,source:i}=this.state,{relationshipStates:a}=r;return r.displayUnfiltered.value?void 0:i.relationships.map(o=>{let l=a.get(o);return l.showMatches.value?l.segmentationState.value:void 0})},[this.state.displayState.relationshipStates,this.state.displayState.ignoreNullSegmentFilter],(e,t)=>e===void 0||t===void 0?e===t:xe(e,t)));this.registerDisposer(t),this.registerDisposer(this.source.changed.add(this.handleChangeAffectingBuffer)),this.registerDisposer(Mn((i,a)=>{if(this.handleChangeAffectingBuffer(),a!==void 0)for(let o of a)o!=null&&i.registerDisposer(ja((l,c)=>{l.registerDisposer(c.visibleSegments.changed.add(()=>this.handleChangeAffectingBuffer())),l.registerDisposer(c.segmentEquivalences.changed.add(()=>this.handleChangeAffectingBuffer()))},o.segmentationGroupState))},this.segmentationStates)),this.source instanceof Ka||(this.sharedObject=this.registerDisposer(new Pg(e,this.source,this.segmentationStates,this.layerChunkProgressInfo)));let{displayState:r}=this.state;this.registerDisposer(r.color.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(r.shader.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(r.shaderControls.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.hoverState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.transform.changed.add(this.redrawNeeded.dispatch))}get source(){return this.state.source}get transform(){return this.state.transform}get hoverState(){return this.state.displayState.hoverState}get visibility(){let{sharedObject:e}=this;if(e!==void 0)return e.visibility}get gl(){return this.chunkManager.gl}updateBuffer(){let{source:e}=this;if(e instanceof Ka){let t=e.changed.count;if(this.generation!==t){let{buffer:r}=this;r===void 0&&(r=this.buffer=this.registerDisposer(new Gt(this.chunkManager.gl))),this.generation=t;let i=this.serializedAnnotations=i5(e,r5(this.segmentationStates.value));r.setData(this.serializedAnnotations.data),this.numPickIds=db(i)}}}};function l_(n){let{chunkTransform:e}=n,{unpaddedRank:t}=e.modelTransform,r=new Float32Array(t*2),i=new Float32Array(t*3);i.fill(0),r.fill(1,t);let{numChunkDisplayDims:a,chunkDisplayDimensionIndices:o}=n;for(let l=0;l<a;++l){let c=o[l];r[t+c]=0,i[c*3+l]=1}return{modelClipBounds:r,renderSubspaceTransform:i}}function c_(n,e,t){t.clearMessages();let r=c=>{t.addMessage({severity:vr.error,message:c})};if(n.error!==void 0)return r(n.error);let i=Ih(n.modelTransform,e.displayDimensionIndices),a;try{a=Ah(n,i)}catch(c){return r(c.message)}let{modelClipBounds:o,renderSubspaceTransform:l}=l_(a);return{chunkTransform:n,chunkDisplayTransform:a,modelClipBounds:o,renderSubspaceTransform:l}}function PC(n,e){class t extends n{constructor(i,a){super();this.base=i;this.renderScaleHistogram=a;this.curRank=-1;this.renderHelpers=[];this.isAnnotation=!0;let o=i.visibility;o!==void 0&&this.registerDisposer(o.add(this.visibility)),this.registerDisposer(this.renderScaleHistogram.visibility.add(this.visibility)),this.registerDisposer(()=>{for(let l of this.renderHelpers)l.dispose()}),this.role=i.state.role,this.registerDisposer(i.redrawNeeded.add(this.redrawNeeded.dispatch)),this.handleRankChanged(),this.registerDisposer(this.base.state.displayState.shaderControls.histogramSpecifications.producerVisibility.add(this.visibility))}handleRankChanged(){let{rank:i}=this.base.source;if(i===this.curRank)return;this.curRank=i,this.tempChunkPosition=new Float32Array(i);let{renderHelpers:a,gl:o}=this;for(let d of a)d.dispose();let{properties:l}=this.base.source,{displayState:c}=this.base.state;for(let d of Mi){let p=Qo(d),h=p[e],g=a[d]=new h(o,d,i,l,c.shaderControls,c.fallbackShaderControls,c.shaderError);g.pickIdsPerInstance=p.pickIdsPerInstance,g.targetIsSliceView=e==="sliceViewRenderHelper"}}attach(i){super.attach(i),this.handleRankChanged();let{chunkTransform:a}=this,o=i.view.displayDimensionRenderInfo.value;i.state={chunkTransform:a,displayDimensionRenderInfo:o,chunkRenderParameters:c_(a,o,i.messages)}}updateAttachmentState(i){let a=i.state;this.handleRankChanged();let{chunkTransform:o}=this,l=i.view.displayDimensionRenderInfo.value;return a!==void 0&&a.chunkTransform===o&&a.displayDimensionRenderInfo===l?a.chunkRenderParameters:(a.chunkTransform=o,a.displayDimensionRenderInfo=l,a.chunkRenderParameters=c_(o,l,i.messages))}get chunkTransform(){return this.base.state.chunkTransform.value}updateModelClipBounds(i,a){let{modelClipBounds:o}=a,l=this.curRank,{chunkTransform:c}=a;Vi(o.subarray(0,l),i.projectionParameters.globalPosition,this.base.state.localPosition.value,c.layerRank,c.combinedGlobalLocalToChunkTransform)}get gl(){return this.base.chunkManager.gl}drawGeometryChunkData(i,a,o,l=1){if(!i.bufferValid){let{buffer:c}=i;c===void 0&&(c=i.buffer=new Gt(this.gl));let{serializedAnnotations:d}=i;c.setData(d.data),i.numPickIds=db(d),i.bufferValid=!0}this.drawGeometry(i,a,o,l)}drawGeometry(i,a,o,l=1){let{base:c}=this,{chunkDisplayTransform:d}=o,{serializedAnnotations:p}=i,{typeToIdMaps:h,typeToOffset:g}=p,v=0;a.emitPickID&&(v=a.pickIDs.register(this,i.numPickIds,0,0,i));let b=c.hoverState.value,x=oe.multiply(n5,a.projectionParameters.viewProjectionMat,d.displaySubspaceModelMatrix),C={annotationLayer:c,renderContext:a,selectedIndex:0,basePickId:v,buffer:i.buffer,bufferOffset:0,count:0,modelViewProjectionMatrix:x,modelClipBounds:o.modelClipBounds,subspaceMatrix:o.renderSubspaceTransform,renderSubspaceModelMatrix:d.displaySubspaceModelMatrix,renderSubspaceInvModelMatrix:d.displaySubspaceInvModelMatrix,chunkDisplayTransform:d},T=this.base.state.displayState.shaderControls.histogramSpecifications.visibleHistograms>0;for(let P of Mi){let I=h[P],M=I.size;if(M>0){let D=Qo(P),E=4294967295;if(b!==void 0){let O=I.get(b.id);O!==void 0&&(E=O*D.pickIdsPerInstance)}M=Math.round(M*l),C.count=M,C.bufferOffset=g[P],C.selectedIndex=E;let V=this.renderHelpers[P];V.draw(C),T&&(V.computeHistograms(C,a.frameNumber),a.bindFramebuffer()),C.basePickId+=M*D.pickIdsPerInstance}}}updateMouseState(i,a,o,l){let c=l,{serializedAnnotations:d}=c,{typeToIds:p,typeToOffset:h}=d,g=this.curRank,v=this.chunkTransform;if(v.error===void 0)for(let b of Mi){let x=p[b],C=Qo(b),{pickIdsPerInstance:T}=C;if(o<x.length*T){let P=Math.floor(o/T),I=x[P],M=o%T;i.pickedAnnotationId=I,i.pickedAnnotationLayer=this.base.state,i.pickedOffset=M,i.pickedAnnotationBuffer=d.data.buffer,i.pickedAnnotationType=b,i.pickedAnnotationBufferBaseOffset=d.data.byteOffset+h[b],i.pickedAnnotationIndex=P,i.pickedAnnotationCount=x.length;let D=this.tempChunkPosition,{chunkToLayerTransform:E,combinedGlobalLocalToChunkTransform:V,layerRank:O}=v,{globalToRenderLayerDimensions:B}=v.modelTransform,{position:z}=i;if(!Vi(D,z,this.base.state.localPosition.value,O,V))return;let _=this.base.source.annotationPropertySerializers[b];C.snapPosition(D,i.pickedAnnotationBuffer,i.pickedAnnotationBufferBaseOffset+i.pickedAnnotationIndex*_.propertyGroupBytes[0],M);let F=B.length;for(let N=0;N<F;++N){let J=B[N];if(J===-1)continue;let ae=E[(g+1)*g+J];for(let pe=0;pe<g;++pe)ae+=D[pe]*E[pe*(O+1)+J];!Number.isFinite(ae)||(z[N]=ae)}return}o-=x.length*T}}transformPickedValue(i){let{pickedAnnotationBuffer:a}=i;if(a===void 0)return;let{properties:o}=this.base.source;if(o.length===0)return;let{pickedAnnotationBufferBaseOffset:l,pickedAnnotationType:c,pickedAnnotationIndex:d,pickedAnnotationCount:p}=i,{annotationPropertySerializers:h}=this.base.source,g=new Array(o.length);return h[c].deserialize(new DataView(a),l,d,p,nn.LITTLE===Pi,g),UE(o[0],g[0])}}return t}var u_=n=>class extends n{constructor(){super(...arguments);this.layerChunkProgressInfo=this.base.layerChunkProgressInfo}draw(t,r){let i=this.updateAttachmentState(r);if(this.curRank===0||i===void 0)return;this.updateModelClipBounds(t,i);let{source:a}=this.base;if(a instanceof Ka){let{base:o}=this;o.updateBuffer(),this.drawGeometry(o,t,i)}else{let{renderScaleHistogram:o}=this;o.begin(this.base.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),this.drawGeometryChunkData(a.temporary.data,t,i);let{value:l}=this.base.segmentationStates,c=0,d=0;if(l!==void 0)for(let p=0,h=l.length;p<h;++p){let g=l[p];if(g==null)continue;let v=a.segmentFilteredSources[p].chunks;Ta(g.segmentationGroupState.value,b=>{let x=Rr(b),C=v.get(x);if(C!==void 0&&C.state===tt.GPU_MEMORY){let{data:T}=C;if(T===void 0)return;this.drawGeometryChunkData(T,t,i),++c}else++d})}o.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,c,d)}}isReady(){let{base:t}=this,{source:r}=t;if(!(r instanceof Wi))return!0;let{value:i}=this.base.segmentationStates;if(i===void 0)return!0;for(let a=0,o=i.length;a<o;++a){let l=i[a];if(l===null)return!1;if(l===void 0)continue;let c=r.segmentFilteredSources[a].chunks,d=!1;if(Ta(l.segmentationGroupState.value,p=>{let h=Rr(p);c.has(h)||(d=!0)}),d)return!1}return!0}},d_=PC(Vr,"perspectiveViewRenderHelper"),IC=class extends u_(d_){},p_=n=>{class e extends n{constructor(r){super(r.annotationLayer,r.renderScaleHistogram);this.wireFrameRenderHelper=this instanceof di?s_:o_;this.wireFrameShaderGetter=Zr(this,this.gl,{memoizeKey:`annotation/wireFrameShader:${this instanceof di}`,parameters:Pr(void 0),defineShader:r=>{this.wireFrameRenderHelper.defineShader(r)}});this.renderScaleTarget=r.renderScaleTarget,this.registerDisposer(this.renderScaleTarget.changed.add(this.redrawNeeded.dispatch));let i=this.registerDisposer(new wa(this.layerChunkProgressInfo)),a=this.base.chunkManager.rpc;i.RPC_TYPE_ID=BD,i.initializeCounterpart(a,{chunkManager:this.base.chunkManager.rpcId,localPosition:this.registerDisposer(bt.makeFromExisting(a,this.base.state.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(bt.makeFromExisting(a,this.renderScaleTarget)).rpcId}),this.backend=i}attach(r){super.attach(r),r.state.sources=r.registerDisposer(Mn((i,a,o)=>{let l=fl(o,a,c=>this.base.state.source.getSources(c),r.messages,this);for(let c of l)for(let d of c)i.registerDisposer(d.source),Object.assign(d,l_(d.chunkDisplayTransform));return r.view.flushBackendProjectionParameters(),this.backend.rpc.invoke(FD,{layer:this.backend.rpcId,view:r.view.rpcId,displayDimensionRenderInfo:o,sources:ul(l)}),this.redrawNeeded.dispatch(),l},this.base.state.transform,r.view.displayDimensionRenderInfo))}draw(r,i){let a=this.updateAttachmentState(i);if(this.curRank===0||a===void 0)return;let o=i.state.sources.value;if(o.length===0)return;this.updateModelClipBounds(r,a);let{renderScaleHistogram:l}=this;l.begin(this.base.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);let{projectionParameters:c}=r,d;if(r.wireFrame){let{shader:p}=this.wireFrameShaderGetter(r.emitter);if(p===null)return;p.bind(),this.wireFrameRenderHelper.initialize(p,c),d=p}_S(c,this.base.state.localPosition.value,this.renderScaleTarget.value,o[0],()=>{},(p,h,g,v,b)=>{let x=p.source.chunks.get(p.curPositionInChunks.join()),C;if(x===void 0||x.state!==tt.GPU_MEMORY)C=0;else{let{data:T}=x;if(T===void 0)return;d!==void 0?this.wireFrameRenderHelper.draw(d,p,c):this.drawGeometryChunkData(T,r,a,g),C=1}l.add(v,b,C,1-C)})}isReady(r,i){let a=this.updateAttachmentState(i);if(this.curRank===0||a===void 0)return;let o=i.state.sources.value;if(o.length===0)return;this.updateModelClipBounds(r,a);let{projectionParameters:l}=r,c=!0;return _S(l,this.base.state.localPosition.value,this.renderScaleTarget.value,o[0],()=>{},(d,p,h,g,v)=>{let b=d.source.chunks.get(d.curPositionInChunks.join());if(b===void 0||b.state!==tt.GPU_MEMORY){c=!1;return}}),c}}return e},f_=p_(d_),h_=p_(PC(di,"sliceViewRenderHelper")),m_=u_(PC(di,"sliceViewRenderHelper"));var Ul=class extends H{constructor(e,t=()=>K.fromValues(1,0,0)){super();this.model=e;this.getDefaultColor=t;this.element=document.createElement("input");let{element:r}=this;r.classList.add("neuroglancer-color-widget"),r.type="color",r.addEventListener("change",()=>this.updateModel()),r.addEventListener("input",()=>this.updateModel()),r.addEventListener("wheel",i=>{i.stopPropagation(),i.preventDefault(),this.adjustHueViaWheel(i)}),this.registerDisposer(e.changed.add(()=>this.updateView())),this.updateView()}getRGB(){var e;return(e=this.model.value)!=null?e:this.getDefaultColor()}updateView(){this.element.value=Sn(this.getRGB())}updateModel(){this.model.value=fa(this.element.value)}adjustHueViaWheel(e){let t=this.getRGB(),r=K.create();I1(r,t[0],t[1],t[2]);let{deltaY:i}=e,a=Math.round(r[0]*256);a+=i>0?1:i<0?-1:0,a=(a+256)%256,r[0]=a/256,bl(r,r[0],r[1],r[2]),this.model.value=r}};var g_='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="binIconTitle"><path d="M19 6L5 6M14 5L10 5M6 10L6 20C6 20.6666667 6.33333333 21 7 21 7.66666667 21 11 21 17 21 17.6666667 21 18 20.6666667 18 20 18 19.3333333 18 16 18 10"></path></svg>';function xi(n={}){let e=He({svg:g_,...n}),t=e.firstElementChild;return t.style.fill="white",e}var Ig=class extends H{constructor(){super(...arguments);this.changed=new ne;this.isLoadingChanged=new ne;this.states=[];this.relationships=[];this.loadingCount=0}get value(){return this.states}get isLoading(){return this.loadingCount!==0}markLoading(){return this.loadingCount++,()=>{--this.loadingCount==0&&this.isLoadingChanged.dispatch()}}sort(){this.states.sort((e,t)=>{let r=e.sourceIndex-t.sourceIndex;return r!==0?r:e.subsourceIndex-t.subsourceIndex})}updateRelationships(){let e=new Set;for(let t of this.states)for(let r of t.source.relationships)e.add(r);this.relationships=Array.from(e)}add(e){return this.states.push(e),this.sort(),this.updateRelationships(),this.changed.dispatch(),()=>{let t=this.states.indexOf(e);this.states.splice(t,1),this.updateRelationships(),this.changed.dispatch()}}};function a5(n,e){switch(e.type){case Be.AXIS_ALIGNED_BOUNDING_BOX:case Be.LINE:Pc(n,e.pointA,e.pointB),HE(n,n,.5);break;case Be.POINT:n.set(e.point);break;case Be.ELLIPSOID:n.set(e.center);break}}function y_(n,e,t){e.error===void 0&&n.setLayerPosition(e.modelTransform,t)}function v_(n,e,t){let{layerRank:r}=e,i=new Float32Array(r);Wn[n.type].visitGeometry(n,(a,o)=>{i.set(a);let l=new Float32Array(r);(o?xh:Kr)(l,e.chunkToLayerTransform,r+1,i,r),t(l,o)})}var Ag=class extends Nt{constructor(e,t){super();this.layer=e;this.displayState=t;this.previousSelectedState=void 0;this.previousHoverId=void 0;this.previousHoverAnnotationLayerState=void 0;this.virtualListSource={length:0,render:e=>this.render(e),changed:new $e};this.virtualList=new Ol({source:this.virtualListSource});this.listElements=[];this.updated=!1;this.mutableControls=document.createElement("div");this.headerRow=document.createElement("div");this.attachedAnnotationStates=new Map;this.forceUpdateView=()=>{this.updated=!1,this.updateView()};this.globalDimensionIndices=[];this.localDimensionIndices=[];this.curCoordinateSpaceGeneration=-1;this.prevCoordinateSpaceGeneration=-1;this.columnWidths=[];this.gridTemplate="";this.selectedAnnotationState=vn((e,t)=>{var l;if(e===void 0)return;let{layer:r}=this,i=(l=e.layers.find(c=>c.layer===r))==null?void 0:l.state;if(i===void 0)return;let{annotationId:a}=i;if(a===void 0)return;let o=this.annotationStates.states.find(c=>c.sourceIndex===i.annotationSourceIndex&&(i.annotationSubsource===void 0||c.subsourceId===i.annotationSubsource));if(o!==void 0)return{annotationId:a,annotationLayerState:o,pin:t}},this.layer.manager.root.selectionState,this.layer.manager.root.selectionState.pin);this.element.classList.add("neuroglancer-annotation-layer-view"),this.registerDisposer(this.visibility.changed.add(()=>this.updateView())),this.registerDisposer(this.annotationStates.changed.add(()=>this.updateAttachedAnnotationLayerStates())),this.headerRow.classList.add("neuroglancer-annotation-list-header");let r=document.createElement("div");r.className="neuroglancer-annotation-toolbox",e.initializeAnnotationLayerViewTab(this);let i=this.registerDisposer(new Ul(this.displayState.color));i.element.title="Change annotation display color",this.registerDisposer(new Zn(vn(g=>g.match(/\bdefaultColor\b/)!==null,t.shaderControls.processedFragmentMain),i.element)),r.appendChild(i.element);let{mutableControls:a}=this,o=He({text:Wn[Be.POINT].icon,title:"Annotate point",onClick:()=>{this.layer.tool.value=new MC(this.layer,{})}});a.appendChild(o);let l=He({text:Wn[Be.AXIS_ALIGNED_BOUNDING_BOX].icon,title:"Annotate bounding box",onClick:()=>{this.layer.tool.value=new Rg(this.layer,{})}});a.appendChild(l);let c=He({text:Wn[Be.LINE].icon,title:"Annotate line",onClick:()=>{this.layer.tool.value=new _g(this.layer,{})}});a.appendChild(c);let d=He({text:Wn[Be.ELLIPSOID].icon,title:"Annotate ellipsoid",onClick:()=>{this.layer.tool.value=new VC(this.layer,{})}});a.appendChild(d),r.appendChild(a),this.element.appendChild(r),this.element.appendChild(this.headerRow);let{virtualList:p}=this;p.element.classList.add("neuroglancer-annotation-list"),this.element.appendChild(p.element),this.virtualList.element.addEventListener("mouseleave",()=>{this.displayState.hoverState.value=void 0});let h=V1();this.registerDisposer(new kn(this.virtualList.element,h)),this.virtualList.element.title=h.describe(),this.registerDisposer(this.displayState.hoverState.changed.add(()=>this.updateHoverView())),this.registerDisposer(this.selectedAnnotationState.changed.add(()=>this.updateSelectionView())),this.registerDisposer(this.layer.localCoordinateSpace.changed.add(()=>{this.updateCoordinateSpace(),this.updateView()})),this.registerDisposer(this.layer.manager.root.coordinateSpace.changed.add(()=>{this.updateCoordinateSpace(),this.updateView()})),this.updateCoordinateSpace(),this.updateAttachedAnnotationLayerStates(),this.updateSelectionView()}get annotationStates(){return this.layer.annotationStates}updateAttachedAnnotationLayerStates(){let e=this.annotationStates.states,{attachedAnnotationStates:t}=this,r=new Map;for(let[i,a]of t)e.includes(i)||(t.delete(i),a.refCounted.dispose());for(let i of e){let a=t.get(i);if(a!==void 0){r.set(i,a);continue}let o=i.source,l=new H;o instanceof Ka&&(l.registerDisposer(o.childAdded.add(c=>this.addAnnotationElement(c,i))),l.registerDisposer(o.childUpdated.add(c=>this.updateAnnotationElement(c,i))),l.registerDisposer(o.childDeleted.add(c=>this.deleteAnnotationElement(c,i)))),l.registerDisposer(i.transform.changed.add(this.forceUpdateView)),r.set(i,{refCounted:l,annotations:[],idToIndex:new Map,listOffset:0})}this.attachedAnnotationStates=r,t.clear(),this.updateCoordinateSpace(),this.forceUpdateView()}updateCoordinateSpace(){let e=this.layer.localCoordinateSpace.value,t=this.layer.manager.root.coordinateSpace.value,r=[],i=[];for(let a=0,o=t.rank;a<o;++a)this.annotationStates.states.some(l=>{let c=l.transform.value;return c.error!==void 0?!1:c.globalToRenderLayerDimensions[a]!==-1})&&r.push(a);for(let a=0,o=e.rank;a<o;++a)this.annotationStates.states.some(l=>{let c=l.transform.value;return c.error!==void 0?!1:c.localToRenderLayerDimensions[a]!==-1})&&i.push(a);(!xe(r,this.globalDimensionIndices)||!xe(i,this.localDimensionIndices))&&(this.localDimensionIndices=i,this.globalDimensionIndices=r,++this.curCoordinateSpaceGeneration)}getRenderedAnnotationListElement(e,t,r=!1){let i=this.attachedAnnotationStates.get(e);if(i==null)return;let a=i.idToIndex.get(t);if(a===void 0)return;let o=i.listOffset+a;return r&&this.virtualList.scrollItemIntoView(a),this.virtualList.getItemElement(o)}clearSelectionClass(){let{previousSelectedState:e}=this;if(e===void 0)return;this.previousSelectedState=void 0;let t=this.getRenderedAnnotationListElement(e.annotationLayerState,e.annotationId);t!==void 0&&t.classList.remove("neuroglancer-annotation-selected")}clearHoverClass(){let{previousHoverId:e,previousHoverAnnotationLayerState:t}=this;if(t!==void 0){this.previousHoverAnnotationLayerState=void 0,this.previousHoverId=void 0;let r=this.getRenderedAnnotationListElement(t,e);r!==void 0&&r.classList.remove("neuroglancer-annotation-hover")}}updateSelectionView(){let e=this.selectedAnnotationState.value,{previousSelectedState:t}=this;if(t===e||t!==void 0&&e!==void 0&&t.annotationId===e.annotationId&&t.annotationLayerState===e.annotationLayerState&&t.pin===e.pin||(this.clearSelectionClass(),this.previousSelectedState=e,e===void 0))return;let r=this.getRenderedAnnotationListElement(e.annotationLayerState,e.annotationId,e.pin);r!==void 0&&r.classList.add("neuroglancer-annotation-selected")}updateHoverView(){let e=this.displayState.hoverState.value,t,r;e!==void 0&&(t=e.id,r=e.annotationLayerState);let{previousHoverId:i,previousHoverAnnotationLayerState:a}=this;if(t===i&&r===a||(this.clearHoverClass(),this.previousHoverId=t,this.previousHoverAnnotationLayerState=r,t===void 0))return;let o=this.getRenderedAnnotationListElement(r,t);o!==void 0&&o.classList.add("neuroglancer-annotation-hover")}render(e){let{annotation:t,state:r}=this.listElements[e];return this.makeAnnotationListElement(t,r)}setColumnWidth(e,t){t+=2;let{columnWidths:r}=this;r[e]>t||(r[e]=t,this.element.style.setProperty(`--neuroglancer-column-${e}-width`,`${t}ch`))}updateView(){if(!this.visible)return;if(this.curCoordinateSpaceGeneration!==this.prevCoordinateSpaceGeneration){this.updated=!1;let{columnWidths:i}=this;i.length=0;let{headerRow:a}=this,o=document.createElement("div");o.style.gridColumn="symbol";let l=document.createElement("div");l.style.gridColumn="delete",Me(a),a.appendChild(o);let c=0,d="[symbol] 2ch",p=(v,b)=>{let x=document.createElement("div");x.classList.add("neuroglancer-annotations-view-dimension");let C=document.createElement("span");C.classList.add("neuroglancer-annotations-view-dimension-name"),C.textContent=v.names[b];let T=document.createElement("scale");T.classList.add("neuroglancer-annotations-view-dimension-scale"),T.textContent=Ri(v.scales[b],v.units[b],{precision:2}),x.appendChild(C),x.appendChild(T),x.style.gridColumn=`dim ${c+1}`,this.setColumnWidth(c,T.textContent.length+C.textContent.length+3),d+=` [dim] var(--neuroglancer-column-${c}-width)`,++c,a.appendChild(x)},h=this.layer.manager.root.coordinateSpace.value;for(let v of this.globalDimensionIndices)p(h,v);let g=this.layer.localCoordinateSpace.value;for(let v of this.localDimensionIndices)p(g,v);a.appendChild(l),d+=" [delete] 2ch",this.gridTemplate=d,a.style.gridTemplateColumns=d,this.prevCoordinateSpaceGeneration=this.curCoordinateSpaceGeneration}if(this.updated)return;let e=!1,{listElements:t}=this;t.length=0;for(let[i,a]of this.attachedAnnotationStates){if(i.source.readonly||(e=!0),i.chunkTransform.value.error!==void 0)continue;let{source:o}=i,l=Array.from(o);a.annotations=l;let{idToIndex:c}=a;c.clear();for(let d=0,p=l.length;d<p;++d)c.set(l[d].id,d);for(let d of l)t.push({state:i,annotation:d})}let r=this.virtualListSource.length;this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:0,deleteCount:r,insertCount:t.length}]),this.mutableControls.style.display=e?"contents":"none",this.resetOnUpdate()}updateListLength(){let e=0;for(let t of this.attachedAnnotationStates.values())t.listOffset=e,e+=t.annotations.length;this.virtualListSource.length=e}addAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}let r=this.attachedAnnotationStates.get(t);if(r!==void 0){let i=r.annotations.length;r.annotations.push(e),r.idToIndex.set(e.id,i);let a=r.listOffset+i;this.listElements.splice(a,0,{state:t,annotation:e}),this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:a,deleteCount:0,insertCount:1}])}this.resetOnUpdate()}updateAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}let r=this.attachedAnnotationStates.get(t);if(r!==void 0){let i=r.idToIndex.get(e.id);if(i!==void 0){let a=r.listOffset+i;r.annotations[i]=e,this.listElements[a].annotation=e,this.virtualListSource.changed.dispatch([{retainCount:a,deleteCount:1,insertCount:1}])}}this.resetOnUpdate()}deleteAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}let r=this.attachedAnnotationStates.get(t);if(r!==void 0){let{idToIndex:i}=r,a=i.get(e);if(a!==void 0){let o=r.listOffset+a,{annotations:l}=r;l.splice(a,1),i.delete(e);for(let c=a,d=l.length;c<d;++c)i.set(l[c].id,c);this.listElements.splice(o,1),this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:o,deleteCount:1,insertCount:0}])}}this.resetOnUpdate()}resetOnUpdate(){this.clearHoverClass(),this.clearSelectionClass(),this.updated=!0,this.updateHoverView(),this.updateSelectionView()}makeAnnotationListElement(e,t){let r=t.chunkTransform.value,i=document.createElement("div");i.classList.add("neuroglancer-annotation-list-entry"),i.dataset.color=t.displayState.color.toString(),i.style.gridTemplateColumns=this.gridTemplate;let a=document.createElement("div");a.className="neuroglancer-annotation-icon",a.textContent=Wn[e.type].icon,i.appendChild(a);let o,l=()=>{t.source.readonly||o===void 0&&(o=xi({title:"Delete annotation",onClick:p=>{p.stopPropagation(),p.preventDefault();let h=t.source.getReference(e.id);try{t.source.delete(h)}finally{h.dispose()}}}),o.classList.add("neuroglancer-annotation-list-entry-delete"),i.appendChild(o))},c=0;if(v_(e,r,(p,h)=>{++c;let g=document.createElement("div");g.className="neuroglancer-annotation-position",i.appendChild(g);let v=0,b=(x,C)=>{for(let T of x){let P=C[T];if(P!==-1){let I=Math.floor(p[P]),M=document.createElement("div"),D=I.toString();M.textContent=D,M.classList.add("neuroglancer-annotation-coordinate"),M.style.gridColumn=`dim ${v+1}`,this.setColumnWidth(v,D.length),g.appendChild(M)}++v}};b(this.globalDimensionIndices,r.modelTransform.globalToRenderLayerDimensions),b(this.localDimensionIndices,r.modelTransform.localToRenderLayerDimensions),l()}),e.description){++c;let p=document.createElement("div");p.classList.add("neuroglancer-annotation-description"),p.textContent=e.description,i.appendChild(p)}a.style.gridRow=`span ${c}`,o!==void 0&&(o.style.gridRow=`span ${c}`),i.addEventListener("mouseenter",()=>{this.displayState.hoverState.value={id:e.id,partIndex:0,annotationLayerState:t},this.layer.selectAnnotation(t,e.id,!1)}),i.addEventListener("action:select-position",p=>{p.stopPropagation(),this.layer.selectAnnotation(t,e.id,"toggle")}),i.addEventListener("action:pin-annotation",p=>{p.stopPropagation(),this.layer.selectAnnotation(t,e.id,!0)}),i.addEventListener("action:move-to-annotation",p=>{p.stopPropagation(),p.preventDefault();let{layerRank:h}=r,g=new Float32Array(h),v=new Float32Array(h);a5(g,e),Kr(v,r.chunkToLayerTransform,h+1,g,h),y_(this.layer,r,v)});let d=this.selectedAnnotationState.value;return d!==void 0&&d.annotationLayerState===t&&d.annotationId===e.id&&i.classList.add("neuroglancer-annotation-selected"),i}},S_=class extends Nt{constructor(e){super();this.layer=e;this.layerView=this.registerDisposer(new Ag(this.layer,this.layer.annotationDisplayState));let{element:t}=this;t.classList.add("neuroglancer-annotations-tab"),t.appendChild(this.layerView.element)}};function Mg(n){let e=[],{relationships:t}=n.source,{relationshipStates:r}=n.displayState;for(let i=0,a=t.length;i<a;++i){let o=r.get(t[i]).segmentationState.value;if(o!=null&&o.segmentSelectionState.hasSelectedSegment){e[i]=[o.segmentSelectionState.selectedSegment.clone()];continue}e[i]=[]}return e}var AC=class extends xp{constructor(e,t){super(e)}get annotationLayer(){for(let e of this.layer.annotationStates.states)if(!e.source.readonly)return e}},b_="annotatePoint",x_="annotateLine",C_="annotateBoundingBox",w_="annotateSphere",MC=class extends AC{trigger(e){let{annotationLayer:t}=this;if(t!==void 0&&e.updateUnconditionally()){let r=Op(e,t);if(r===void 0)return;let i={id:"",description:"",relatedSegments:Mg(t),point:r,type:Be.POINT,properties:t.source.properties.map(o=>o.default)},a=t.source.add(i,!0);this.layer.selectAnnotation(t,a.id,!0),a.dispose()}}get description(){return"annotate point"}toJSON(){return b_}};function Op(n,e){let t=e.chunkTransform.value;if(t.error!==void 0)return;let r=new Float32Array(t.modelTransform.unpaddedRank);if(!!Vi(r,n.unsnappedPosition,e.localPosition.value,t.layerRank,t.combinedGlobalLocalToChunkTransform))return r}var RC=class extends AC{trigger(e){let{annotationLayer:t}=this;if(t!==void 0&&e.updateUnconditionally()){let r=()=>{let i=this.inProgressAnnotation,a=i.reference,o=this.getUpdatedAnnotation(a.value,e,t);JSON.stringify(ph(o,t.source))!==JSON.stringify(ph(a.value,t.source))&&(i.annotationLayer.source.update(a,o),this.layer.selectAnnotation(t,a.id,!0))};if(this.inProgressAnnotation===void 0){let i=t.source.add(this.getInitialAnnotation(e,t),!1);this.layer.selectAnnotation(t,i.id,!0);let a=e.changed.add(r),o=()=>{a(),i.dispose()};this.inProgressAnnotation={annotationLayer:t,reference:i,disposer:o}}else r(),this.inProgressAnnotation.annotationLayer.source.commit(this.inProgressAnnotation.reference),this.inProgressAnnotation.disposer(),this.inProgressAnnotation=void 0}}disposed(){this.deactivate(),super.disposed()}deactivate(){this.inProgressAnnotation!==void 0&&(this.inProgressAnnotation.annotationLayer.source.delete(this.inProgressAnnotation.reference),this.inProgressAnnotation.disposer(),this.inProgressAnnotation=void 0)}},_C=class extends RC{getInitialAnnotation(e,t){let r=Op(e,t);return{id:"",type:this.annotationType,description:"",pointA:r,pointB:r,properties:t.source.properties.map(i=>i.default)}}getUpdatedAnnotation(e,t,r){let i=Op(t,r);return i===void 0?e:{...e,pointB:i}}},Rg=class extends _C{get description(){return"annotate bounding box"}getUpdatedAnnotation(e,t,r){let i=super.getUpdatedAnnotation(e,t,r),{pointA:a,pointB:o}=i,l=a.length;for(let c=0;c<l;++c)a[c]===o[c]&&(o[c]+=1);return i}toJSON(){return C_}};Rg.prototype.annotationType=Be.AXIS_ALIGNED_BOUNDING_BOX;var _g=class extends _C{get description(){return"annotate line"}getInitialAnnotation(e,t){let r=super.getInitialAnnotation(e,t);return this.initialRelationships=r.relatedSegments=Mg(t),r}getUpdatedAnnotation(e,t,r){let i=super.getUpdatedAnnotation(e,t,r),a=this.initialRelationships,o=Mg(r);return a===void 0?i.relatedSegments=o:i.relatedSegments=Array.from(o,(l,c)=>{let d=a[c];return l=l.filter(p=>d.findIndex(h=>X.equal(p,h))===-1),[...d,...l]}),i}toJSON(){return x_}};_g.prototype.annotationType=Be.LINE;var VC=class extends RC{getInitialAnnotation(e,t){let r=Op(e,t);return{type:Be.ELLIPSOID,id:"",description:"",segments:Mg(t),center:r,radii:K.fromValues(0,0,0),properties:t.source.properties.map(i=>i.default)}}getUpdatedAnnotation(e,t,r){let i=Op(t,r);if(i===void 0)return e;let a=e.center,o=a.length;for(let l=0;l<o;++l)i[l]=Math.abs(a[l]-i[l]);return{...e,radii:i}}get description(){return"annotate ellipsoid"}toJSON(){return w_}};Cp(b_,(n,e)=>new MC(n,e));Cp(C_,(n,e)=>new Rg(n,e));Cp(x_,(n,e)=>new _g(n,e));Cp(w_,(n,e)=>new VC(n,e));var o5=Ie.fromObject({enter:{action:"commit"},escape:{action:"cancel"}});function s5(n,e,t,r){return new Ln(t,(i,a,o)=>{let l=document.createElement("div");l.classList.add("neuroglancer-related-segment-list"),i!=null&&o.registerDisposer(os(i,l));let c=document.createElement("div");c.classList.add("neuroglancer-related-segment-list-header");let d=xr({title:"Copy segment IDs",onClick:()=>{br(e.map(b=>b.toString()).join(", "))}});c.appendChild(d);let p;if(i!=null&&(p=document.createElement("input"),p.type="checkbox",p.addEventListener("change",()=>{let{visibleSegments:b}=i.segmentationGroupState.value,x=e.some(C=>!b.has(C));for(let C of e)b.set(C,x)}),c.appendChild(p)),r!==void 0){let b=xi({title:"Remove all IDs",onClick:()=>{r([])}});c.appendChild(b)}let h=document.createElement("span");if(h.classList.add("neuroglancer-related-segment-list-title"),h.textContent=n,c.appendChild(h),r!==void 0){let b=hg({title:"Add related segment ID",onClick:()=>{let x=new H,C=o.registerDisposer(Uf(x)),T=document.createElement("div");T.classList.add("neuroglancer-segment-list-entry"),T.classList.add("neuroglancer-segment-list-entry-new");let P=xr({});if(P.classList.add("neuroglancer-segment-list-entry-copy"),T.appendChild(P),i!=null){let V=document.createElement("input");V.classList.add("neuroglancer-segment-list-entry-visible-checkbox"),V.type="checkbox",T.appendChild(V)}let I=xi({title:"Cancel adding new segment ID",onClick:()=>{C()}});I.classList.add("neuroglancer-segment-list-entry-delete"),T.appendChild(I);let M=document.createElement("input");M.autocomplete="off",M.spellcheck=!1,M.classList.add("neuroglancer-segment-list-entry-id");let D=x.registerDisposer(new jt(M,o5));D.allShortcutsAreGlobal=!0;let E=()=>{let V=new X;if(V.tryParseString(M.value))return M.dataset.valid="true",V;M.dataset.valid="false"};E(),M.addEventListener("input",()=>{E()}),M.addEventListener("blur",()=>{let V=E();V!==void 0&&r([...e,V]),C()}),ce(M,"cancel",C),ce(M,"commit",()=>{let V=E();V!==void 0&&r([...e,V]),C()}),T.appendChild(M),l.appendChild(T),M.focus(),x.registerDisposer(()=>{M.value="",T.remove()})}});c.appendChild(b)}l.appendChild(c);let g=[],v=wl.make(i!=null?i:void 0,!1);for(let b of e){let x=v.get(b);if(g.push(x),r!==void 0){let C=xi({title:"Remove ID",onClick:T=>{r(e.filter(P=>!X.equal(P,b))),T.stopPropagation()}});C.classList.add("neuroglancer-segment-list-entry-delete"),x.children[0].appendChild(C)}l.appendChild(x)}if(i!=null){let b=o.registerCancellable(We(()=>{let{visibleSegments:x}=i.segmentationGroupState.value,C=0;for(let T of e)x.has(T)&&++C;for(let T of g)v.update(T);p.checked=C===e.length&&C>0,p.indeterminate=C>0&&C<e.length}));b(),b.flush(),ss(i,o,b),o.registerDisposer(i.segmentationGroupState.changed.add(b))}a.appendChild(l)})}var T_="annotationColor";function du(n){class e extends n{constructor(...r){super(...r);this.annotationStates=this.registerDisposer(new Ig);this.annotationDisplayState=new _p;this.annotationCrossSectionRenderScaleHistogram=new La;this.annotationCrossSectionRenderScaleTarget=Gi(8);this.annotationProjectionRenderScaleHistogram=new La;this.annotationProjectionRenderScaleTarget=Gi(8);this.annotationDisplayState.color.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.shader.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.shaderControls.changed.add(this.specificationChanged.dispatch),this.tabs.add("annotations",{label:"Annotations",order:10,getter:()=>new S_(this)});let i,a=()=>{let l=this.isReady;l&&i!==void 0?(i(),i=void 0):!l&&i===void 0&&(i=this.annotationStates.markLoading())};this.readyStateChanged.add(a),a();let{mouseState:o}=this.manager.layerSelectedValues;this.registerDisposer(o.changed.add(()=>{if(o.active){let{pickedAnnotationLayer:l}=o;if(l!==void 0&&this.annotationStates.states.includes(l)){let c=this.annotationDisplayState.hoverState.value;(c===void 0||c.id!==o.pickedAnnotationId||c.partIndex!==o.pickedOffset||c.annotationLayerState!==l)&&(this.annotationDisplayState.hoverState.value={id:o.pickedAnnotationId,partIndex:o.pickedOffset,annotationLayerState:l});return}}this.annotationDisplayState.hoverState.value=void 0}))}initializeAnnotationLayerViewTab(r){}restoreState(r){super.restoreState(r),this.annotationDisplayState.color.restoreState(r[T_])}captureSelectionState(r,i){super.captureSelectionState(r,i);let a=i.pickedAnnotationLayer;a===void 0||!this.annotationStates.states.includes(a)||(r.annotationId=i.pickedAnnotationId,r.annotationType=i.pickedAnnotationType,r.annotationBuffer=new Uint8Array(i.pickedAnnotationBuffer,i.pickedAnnotationBufferBaseOffset),r.annotationIndex=i.pickedAnnotationIndex,r.annotationCount=i.pickedAnnotationCount,r.annotationPartIndex=i.pickedOffset,r.annotationSourceIndex=a.sourceIndex,r.annotationSubsource=a.subsourceId)}displayAnnotationState(r,i,a){if(r.annotationId===void 0)return!1;let o=this.annotationStates.states.find(c=>c.sourceIndex===r.annotationSourceIndex&&c.subsubsourceId===r.annotationSubsubsourceId&&(r.annotationSubsource===void 0||c.subsourceId===r.annotationSubsource));if(o===void 0)return!1;let l=a.registerDisposer(o.source.getReference(r.annotationId));return i.appendChild(a.registerDisposer(new Ln(a.registerDisposer(new fd(()=>({annotation:l,chunkTransform:o.chunkTransform}))),({annotation:c,chunkTransform:d},p,h)=>{let g;if(c==null)if(r.annotationType!==void 0&&r.annotationBuffer!==void 0){let v=Wn[r.annotationType],b=o.source.rank,x=v.serializedBytes(b),C=r.annotationBuffer.byteOffset,T=new DataView(r.annotationBuffer.buffer),P=nn.LITTLE===Pi,{properties:I}=o.source,M=new ch(b,x,I),D=r.annotationIndex,E=r.annotationCount;c=v.deserialize(T,C+M.propertyGroupBytes[0]*D,P,b,r.annotationId),M.deserialize(T,C,D,E,P,c.properties=new Array(I.length)),o.source.hasNonSerializedProperties()&&(g="Loading...")}else g=c===null?"Annotation not found":"Loading...";if(c!=null){let v=d.error===void 0?d.layerRank:0,b=document.createElement("div");b.classList.add("neuroglancer-selected-annotation-details-position-grid"),b.style.gridTemplateColumns=`[icon] 0fr [copy] 0fr repeat(${v}, [dim] 0fr [coord] 0fr) [move] 0fr [delete] 0fr`,p.appendChild(b);let x=Wn[c.type],C=document.createElement("div");if(C.className="neuroglancer-selected-annotation-details-icon",C.textContent=x.icon,b.appendChild(C),v!==0){let{layerDimensionNames:D}=d.modelTransform;for(let E=0;E<v;++E){let V=document.createElement("div");V.classList.add("neuroglancer-selected-annotation-details-position-dim"),V.textContent=D[E],V.style.gridColumn=`dim ${E+1}`,b.appendChild(V)}v_(c,d,(E,V)=>{let O=xr({title:"Copy position",onClick:()=>{br(E.map(B=>Math.floor(B)).join(", "))}});O.style.gridColumn="copy",b.appendChild(O);for(let B=0;B<v;++B){let z=document.createElement("div");z.classList.add("neuroglancer-selected-annotation-details-position-coord"),z.style.gridColumn=`coord ${B+1}`,z.textContent=Math.floor(E[B]).toString(),b.appendChild(z)}if(!V){let B=mm({title:"Move to position",onClick:()=>{y_(this,d,E)}});B.style.gridColumn="move",b.appendChild(B)}})}if(!o.source.readonly){let D=xi({title:"Delete annotation",onClick:()=>{o.source.delete(l)}});D.classList.add("neuroglancer-selected-annotation-details-delete"),b.appendChild(D)}let{relationships:T,properties:P}=o.source,I=o.source.readonly;for(let D=0,E=P.length;D<E;++D){let V=P[D],O=document.createElement("label");O.classList.add("neuroglancer-annotation-property");let B=document.createElement("span");B.classList.add("neuroglancer-annotation-property-label"),B.textContent=V.identifier,O.appendChild(B);let{description:z}=V;z!==void 0&&(O.title=z);let _=c.properties[D],F=document.createElement("span");switch(F.classList.add("neuroglancer-annotation-property-value"),V.type){case"rgb":{let N=qa(_),J=Sn(N);F.textContent=J,F.style.backgroundColor=J,F.style.color=Sd(N)?"white":"black";break}case"rgba":{let N=qa(_);F.textContent=Sn(vd(_)),F.style.backgroundColor=Sn(qa(_)),F.style.color=Sd(N)?"white":"black";break}default:F.textContent=Qv(V,_);break}O.appendChild(F),p.appendChild(O)}let{relatedSegments:M}=c;for(let D=0,E=T.length;D<E;++D){let V=M===void 0?[]:M[D];if(V.length===0&&I)continue;let O=D,B=T[D];p.appendChild(h.registerDisposer(s5(B,V,o.displayState.relationshipStates.get(B).segmentationState,I?void 0:z=>{let _=l.value;if(_==null)return;let{relatedSegments:F}=_;F===void 0?F=o.source.relationships.map(()=>[]):F=F.slice(),F[O]=z;let N={..._,relatedSegments:F};o.source.update(l,N),o.source.commit(l)})).element)}if(!o.source.readonly||c.description)if(o.source.readonly){let D=document.createElement("div");D.className="neuroglancer-annotation-details-description",D.textContent=c.description||"",p.appendChild(D)}else{let D=document.createElement("textarea");D.value=c.description||"",D.rows=3,D.className="neuroglancer-annotation-details-description",D.placeholder="Description",D.addEventListener("change",()=>{let E=D.value;o.source.update(l,{...c,description:E||void 0}),o.source.commit(l)}),p.appendChild(D)}}if(g!==void 0){let v=document.createElement("div");v.classList.add("neuroglancer-selection-annotation-status"),v.textContent=g,p.appendChild(v)}})).element),!0}displaySelectionState(r,i,a){let o=this.displayAnnotationState(r,i,a);return super.displaySelectionState(r,i,a)&&(o=!0),o}addLocalAnnotations(r,i,a){let{subsourceEntry:o}=r,l=new ys({localPosition:this.localPosition,transform:r.getRenderLayerTransform(),source:i,displayState:this.annotationDisplayState,dataSource:r.loadedDataSource.layerDataSource,subsourceIndex:r.subsourceIndex,subsourceId:o.id,role:a});this.addAnnotationLayerState(l,r)}addStaticAnnotations(r){let{subsourceEntry:i}=r,{staticAnnotations:a}=i.subsource;return a===void 0?!1:(r.activate(()=>{this.addLocalAnnotations(r,a,_n.DEFAULT_ANNOTATION)}),!0)}addAnnotationLayerState(r,i){let a=i.activated;a.registerDisposer(this.annotationStates.add(r));let o=new DC(this.manager.chunkManager,r.addRef());if(o.source instanceof Wi){let l=new h_({annotationLayer:o.addRef(),renderScaleTarget:this.annotationCrossSectionRenderScaleTarget,renderScaleHistogram:this.annotationCrossSectionRenderScaleHistogram});a.registerDisposer(i.messages.addChild(l.messages));let c=new f_({annotationLayer:o.addRef(),renderScaleTarget:this.annotationProjectionRenderScaleTarget,renderScaleHistogram:this.annotationProjectionRenderScaleHistogram});a.registerDisposer(i.messages.addChild(c.messages)),a.registerDisposer(Mn((d,p)=>{p&&(d.registerDisposer(this.addRenderLayer(l.addRef())),d.registerDisposer(this.addRenderLayer(c.addRef())))},this.annotationDisplayState.displayUnfiltered))}{let l=new m_(o,this.annotationCrossSectionRenderScaleHistogram);a.registerDisposer(this.addRenderLayer(l)),a.registerDisposer(i.messages.addChild(l.messages))}{let l=new IC(o.addRef(),this.annotationProjectionRenderScaleHistogram);a.registerDisposer(this.addRenderLayer(l)),a.registerDisposer(i.messages.addChild(l.messages))}}selectAnnotation(r,i,a){this.manager.root.selectionState.captureSingleLayerState(this,o=>(o.annotationId=i,o.annotationSourceIndex=r.sourceIndex,o.annotationSubsource=r.subsourceId,o.annotationSubsubsourceId=r.subsubsourceId,!0),a)}toJSON(){let r=super.toJSON();return r[T_]=this.annotationDisplayState.color.toJSON(),r}}return e}var Gg=Ye(gt()),B_=Ye(Ml());var l5=0,c5=1,u5=2;function pu(n){let e=0,{deltaMode:t}=n;switch(t){case l5:e=1/200;break;case c5:e=1/10;break;case u5:e=2;break}return Math.exp(n.deltaY*e)}var L_=Ie.fromObject({"shift?+mousedown0":{action:"set"},"shift?+alt+mousedown0":{action:"adjust-window-via-drag"},"shift?+wheel":{action:"zoom-via-wheel"}}),Vg=class extends H{constructor(e,t,r,i){super();this.element=e;this.dataType=t;this.getModel=r;this.setModel=i;e.title=L_.describe(),this.registerDisposer(new kn(e,L_)),ce(e,"set",a=>{let o=a.detail,l=this.getModel(),c=this.getTargetValue(o);if(c===void 0)return;let d=qs(l.window,l.range),p=NE(d,c),h=g=>{let v=this.getModel();this.setModel(Np(v,"range",p,g))};h(c),un(o,g=>{let v=this.getTargetValue(g);v!==void 0&&h(v)})}),ce(e,"adjust-window-via-drag",a=>{let o=a.detail,l=this.getTargetFraction(o),c=this.getWindowLerp(l),d=l<.5?0:1,p=h=>{let g=this.getModel();this.setModel(Np(g,"window",d,h))};un(o,h=>{let g=this.getModel().window,v=this.getTargetFraction(h);p(d===0?ma([c,g[1]],this.dataType,-v/(1-v)):ma([g[0],c],this.dataType,1/v))})}),ce(e,"zoom-via-wheel",a=>{let o=a.detail,l=pu(o),c=this.getTargetFraction(o),{dataType:d}=this,p=this.getModel(),h=ma(p.window,d,c*(1-l)),g=ma(p.window,d,(1-c)*l+c);this.setModel({...p,window:[h,g],range:p.range})})}getTargetFraction(e){let t=this.element.getBoundingClientRect();return(e.clientX-t.left)/t.width}getWindowLerp(e){return ma(this.getModel().window,this.dataType,e)}getTargetValue(e){let t=this.getTargetFraction(e);if(!!Number.isFinite(t))return this.getWindowLerp(t)}},k_=Symbol("histogramSamplerTexture");function Np(n,e,t,r,i=!1){let a={...n},o=n[e];if(a[e]=[o[0],o[1]],a[e][t]=r,e==="window"&&mr(r,o[1-t])*(2*t-1)<0&&(a[e][1-t]=r),e==="range"&&i){let l=[n.window[0],n.window[1]];for(let c=0;c<2;++c)mr(r,l[c])*(2*c-1)>0&&(l[c]=r);a.window=l}return a}var d5=254,Bp=d5+1,E_=class extends yh{constructor(e){super(e.display,document.createElement("div"),e.visibility);this.parent=e;this.controller=this.registerDisposer(new Vg(this.element,this.parent.dataType,()=>this.parent.trackable.value,e=>{this.parent.trackable.value=e}));this.dataValuesBuffer=this.registerDisposer(no(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>{let e=new Uint8Array(Bp*yi);for(let t=0;t<Bp;++t)for(let r=0;r<yi;++r)e[t*yi+r]=t;return e})).value;this.lineShader=this.registerDisposer((()=>{let e=new gr(this.gl);return rr(e),e.addTextureSampler("sampler2D","uHistogramSampler",k_),e.addOutputBuffer("vec4","out_color",0),e.addAttribute("uint","aDataValue"),e.addUniform("float","uBoundsFraction"),e.addVertexCode(`
float getCount(int i) {
  return texelFetch(uHistogramSampler, ivec2(i, 0), 0).x;
}
vec4 getVertex(float cdf, int i) {
  float x;
  if (i == 0) {
    x = -1.0;
  } else if (i == 255) {
    x = 1.0;
  } else {
    x = float(i) / 254.0 * uBoundsFraction * 2.0 - 1.0;
  }
  return vec4(x, cdf * (2.0 - uLineParams.y) - 1.0 + uLineParams.y * 0.5, 0.0, 1.0);
}
`),e.setVertexMain(`
int lineNumber = int(aDataValue);
int dataValue = lineNumber;
float cumSum = 0.0;
for (int i = 0; i <= dataValue; ++i) {
  cumSum += getCount(i);
}
float total = cumSum + getCount(dataValue + 1);
float cumSumEnd = dataValue == ${Bp-1} ? cumSum : total;
if (dataValue == ${Bp-1}) {
  cumSum + getCount(dataValue + 1);
}
for (int i = dataValue + 2; i < 256; ++i) {
  total += getCount(i);
}
total = max(total, 1.0);
float cdf1 = cumSum / total;
float cdf2 = cumSumEnd / total;
emitLine(getVertex(cdf1, lineNumber), getVertex(cdf2, lineNumber + 1), 1.0);
`),e.setFragmentMain(`
out_color = vec4(0.0, 1.0, 1.0, getLineAlpha());
`),e.build()})());this.regionCornersBuffer=Yo(this.gl,0,-1,1,1);this.regionShader=this.registerDisposer((()=>{let e=new gr(this.gl);return e.addAttribute("vec2","aVertexPosition"),e.addUniform("vec2","uBounds"),e.addUniform("vec4","uColor"),e.addOutputBuffer("vec4","out_color",0),e.setVertexMain(`
gl_Position = vec4(mix(uBounds[0], uBounds[1], aVertexPosition.x) * 2.0 - 1.0, aVertexPosition.y, 0.0, 1.0);
`),e.setFragmentMain(`
out_color = uColor;
`),e.build()})());let{element:t}=this;t.classList.add("neuroglancer-invlerp-cdfpanel")}get drawOrder(){return 100}drawIndirect(){let{lineShader:e,gl:t,regionShader:r,parent:{dataType:i,trackable:{value:a}}}=this;this.setGLLogicalViewport(),t.clearColor(0,0,0,0),t.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.enable(WebGL2RenderingContext.BLEND),t.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),t.disable(WebGL2RenderingContext.DEPTH_TEST),t.disable(WebGL2RenderingContext.STENCIL_TEST);{r.bind(),t.uniform4f(r.uniform("uColor"),.2,.2,.2,1);let o=Mr(a.window,a.range[0]),l=Mr(a.window,a.range[1]),c=Lc(i,a.window);t.uniform2f(r.uniform("uBounds"),Math.min(o,l)*c,Math.max(o,l)*c+(1-c));let d=r.attribute("aVertexPosition");this.regionCornersBuffer.bindToVertexAttrib(d,2,WebGL2RenderingContext.FLOAT),t.drawArrays(WebGL2RenderingContext.TRIANGLE_FAN,0,4),t.disableVertexAttribArray(d)}if(this.parent.histogramSpecifications.producerVisibility.visible){let{renderViewport:o}=this;e.bind(),ar(e,{width:o.logicalWidth,height:o.logicalHeight},1);let l=e.textureUnit(k_);t.uniform1f(e.uniform("uBoundsFraction"),Lc(i,a.window)),t.activeTexture(WebGL2RenderingContext.TEXTURE0+l),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,this.parent.texture),ro(t);let c=e.attribute("aDataValue");this.dataValuesBuffer.bindToVertexAttribI(c,1,WebGL2RenderingContext.UNSIGNED_BYTE),ir(t,Bp,1),t.disableVertexAttribArray(c),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}t.disable(WebGL2RenderingContext.BLEND)}isReady(){return!0}};function p5(){}var D_=class extends yh{constructor(e){super(e.display,document.createElement("div"),e.visibility);this.parent=e;this.cornersBuffer=Yo(this.gl,-1,-1,1,1);let{element:t}=this;t.classList.add("neuroglancer-invlerp-legend-panel");let r=this.shaderOptions=e.legendShaderOptions;this.shaderGetter=Zr(this,this.gl,{...r,memoizeKey:{id:"colorLegendShader",base:r.memoizeKey},defineShader:(i,a,o)=>{i.addOutputBuffer("vec4","v4f_fragData0",0),i.addAttribute("vec2","aVertexPosition"),i.addUniform("float","uLegendOffset"),i.addVarying("float","vLinearPosition"),i.setVertexMain(`
gl_Position = vec4(aVertexPosition, 0.0, 1.0);
vLinearPosition = -uLegendOffset + ((aVertexPosition.x + 1.0) * 0.5) * (1.0 + 2.0 * uLegendOffset);
`);let l=this.parent.dataType,c=Ot(l);i.addFragmentCode(pP(i,"ng_colorLegendLerp",l)),i.addFragmentCode(`
void emit(vec4 v) {
  v4f_fragData0 = v;
}
${c} getDataValue() {
  return ng_colorLegendLerp(vLinearPosition);
}
${c} getDataValue(int dummyChannel) {
  return getDataValue();
}
${c} getInterpolatedDataValue() {
  return getDataValue();
}
${c} getInterpolatedDataValue(int dummyChannel) {
  return getDataValue();
}
`),r.defineShader(i,a,o)}})}drawIndirect(){let e=this.shaderGetter(p5),{shader:t}=e;if(t===null)return;this.setGLLogicalViewport();let{gl:r}=this;r.clearColor(0,0,0,0),r.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.bind(),this.shaderOptions.initializeShader(e),r.enable(WebGL2RenderingContext.BLEND);let{trackable:{value:{window:i}},dataType:a}=this.parent;eo(t,"ng_colorLegendLerp",this.parent.dataType,i);let o=BE(a,i);r.uniform1f(t.uniform("uLegendOffset"),Number.isFinite(o)?o:0),r.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),r.disable(WebGL2RenderingContext.DEPTH_TEST),r.disable(WebGL2RenderingContext.STENCIL_TEST);let l=t.attribute("aVertexPosition");this.cornersBuffer.bindToVertexAttrib(l,2,WebGL2RenderingContext.FLOAT),r.drawArrays(WebGL2RenderingContext.TRIANGLE_FAN,0,4),r.disableVertexAttribArray(l)}isReady(){return!0}};function P_(n,e){let t=document.createElement("input");return t.addEventListener("focus",()=>{t.select()}),t.classList.add("neuroglancer-invlerp-widget-bound"),t.classList.add(`neuroglancer-invlerp-widget-${n}-bound`),t.type="text",t.spellcheck=!1,t.autocomplete="off",t.title=n==="range"?`Data value that maps to ${e}`:`${e===0?"Lower":"Upper"} bound for distribution`,t}function I_(n,e,t){let r=document.createElement("div");r.classList.add("neuroglancer-invlerp-widget-bounds"),r.classList.add(`neuroglancer-invlerp-widget-${n}-bounds`);let i=[P_(n,0),P_(n,1)];for(let o=0;o<2;++o){let l=i[o];l.addEventListener("input",()=>{A_(l)}),l.addEventListener("change",()=>{let c=t.value,d=c[n];try{let p=Ya(e,l.value);t.value=Np(c,n,o,p,!0)}catch{OC(l,d[o])}})}let a;return r.appendChild(i[0]),r.appendChild(i[1]),n==="range"&&(a=[document.createElement("div"),document.createElement("div"),document.createElement("div")],a[1].classList.add("neuroglancer-invlerp-widget-range-spacer"),r.insertBefore(a[0],i[0]),r.insertBefore(a[1],i[1]),r.appendChild(a[2])),{container:r,inputs:i,spacers:a}}function A_(n){Tn(n,Math.max(1,n.value.length+.1))}function OC(n,e){let t;e instanceof X||Number.isInteger(e)?t=e.toString():t=e.toPrecision(6),n.value=t,A_(n)}function M_(n){let e=n.value,{range:t}=e;n.value={...e,range:[t[1],t[0]]}}function f5(n,e,t){let r=e.value,i=ma(r.range,n,.5-t/2),a=ma(r.range,n,.5+t/2);e.value={...r,range:[i,a]}}function h5(n,e,t,r,i){let a=Math.exp(i),o=e.value,l=ma(t,n,.5-a/2+r),c=ma(t,n,.5+a/2+r);e.value={...o,range:[l,c]}}var Og=class extends Nt{constructor(e,t,r,i,a,o,l){super(e);this.display=t;this.dataType=r;this.trackable=i;this.histogramSpecifications=a;this.histogramIndex=o;this.legendShaderOptions=l;this.cdfPanel=this.registerDisposer(new E_(this));this.boundElements={range:I_("range",this.dataType,this.trackable),window:I_("window",this.dataType,this.trackable)};this.registerDisposer(a.visibility.add(this.visibility));let{element:c,boundElements:d}=this;if(l!==void 0){let h=this.registerDisposer(new D_(this));c.appendChild(h.element)}let p=h=>{let g=He({svg:h,title:"Invert range",onClick:()=>{this.invertRange()}});return d.range.spacers[1].appendChild(g),g};this.invertArrows=[p(cm),p(lm)],c.appendChild(d.range.container),c.appendChild(this.cdfPanel.element),c.classList.add("neuroglancer-invlerp-widget"),c.appendChild(d.window.container),this.updateView(),this.registerDisposer(i.changed.add(this.registerCancellable(We(()=>this.updateView()))))}get texture(){return this.histogramSpecifications.getFramebuffers(this.display.gl)[this.histogramIndex].colorBuffers[0].texture}invertRange(){M_(this.trackable)}updateView(){let{boundElements:e}=this,{trackable:{value:t},dataType:r}=this;for(let h=0;h<2;++h)OC(e.range.inputs[h],t.range[h]),OC(e.window.inputs[h],t.window[h]);let i=mr(t.range[0],t.range[1])>0;e.range.container.style.flexDirection=i?"row-reverse":"row";let a=qs(t.window,t.range),o=e.range.spacers,l=Lc(r,t.window),c=Mr(t.window,a[i?1:0])*l,d=Mr(t.window,a[i?0:1])*l+(1-l);o[i?2:0].style.width=`${c*100}%`,o[i?0:2].style.width=`${(1-d)*100}%`;let{invertArrows:p}=this;p[i?1:0].style.display="",p[i?0:1].style.display="none"}},NC=class extends Nt{constructor(e,t,r,i,a,o,l){super(e);this.display=t;this.watchableDataType=r;this.trackable=i;this.histogramSpecifications=a;this.histogramIndex=o;this.legendShaderOptions=l;this.invlerpWidget=this.makeInvlerpWidget(),this.registerDisposer(r.changed.add(()=>{Me(this.element),this.invlerpWidget.dispose(),this.invlerpWidget=this.makeInvlerpWidget()}))}get dataType(){return this.watchableDataType.value}disposed(){this.invlerpWidget.dispose(),super.disposed()}makeInvlerpWidget(){let{dataType:e}=this,t=new Og(this.visibility,this.display,e,this.trackable,this.histogramSpecifications,this.histogramIndex,this.legendShaderOptions);return this.element.appendChild(t.element),t}},m5=Ie.fromObject({"at:shift+wheel":{action:"adjust-contrast-via-wheel"},"at:shift+mousedown0":{action:"adjust-via-drag"},"at:shift+mousedown2":{action:"invert-range"}});function Ng(n,e){n.bindInputEventMap(m5),n.bindAction("adjust-contrast-via-wheel",t=>{t.stopPropagation();let r=pu(t.detail);f5(e.dataType,e.trackable,r)}),n.bindAction("adjust-via-drag",t=>{t.stopPropagation();let r=t.detail.screenX,i=t.detail.screenY,a=e.trackable.value.range,o=a,l=r,c=i;un(t.detail,d=>{let p=e.trackable.value.range,h=d.screenX,g=d.screenY;li(e.dataType,p,o)||(a=p,r=l,i=c),h5(e.dataType,e.trackable,a,(g-i)*2/screen.height,(h-r)*4/screen.width),o=e.trackable.value.range,l=h,c=g})}),n.bindAction("invert-range",t=>{t.stopPropagation(),M_(e.trackable)})}var Bg="mergeSegments",Fg="splitSegments",g5=Ie.fromObject({"at:shift?+mousedown0":{action:"merge-segments"},"at:shift?+mousedown2":{action:"set-anchor"}}),y5=Ie.fromObject({"at:shift?+mousedown0":{action:"split-segments"},"at:shift?+alt+mousedown0":{action:"split-and-select-segments"},"at:shift?+mousedown2":{action:"set-anchor"}}),R_=class extends Br{constructor(e){super(e);this.lastAnchorBaseSegment=new ke(void 0);let t=()=>{let r=e.anchorSegment.value;if(r===void 0)return;let{segmentSelectionState:i}=e.displayState;if(!i.hasSelectedSegment)return;let{segmentEquivalences:a}=e.displayState.segmentationGroupState.value,o=a.get(r);if(!X.equal(i.selectedSegment,o))return;let l=i.baseSelectedSegment,c=Uc(l),d=a.disjointSets.visibleSegmentEquivalencePolicy.value;d&Kt.NONREPRESENTATIVE_EXCLUDED&&c||d&Kt.REPRESENTATIVE_EXCLUDED&&!c||(this.lastAnchorBaseSegment.value=l.clone())};this.registerDisposer(e.displayState.segmentSelectionState.changed.add(t)),this.registerDisposer(e.anchorSegment.changed.add(t))}toJSON(){return Bg}activate(e){let t=this.layer.displayState.segmentationGroupState.value,r=()=>{let d=this.layer.anchorSegment.value,p=this.lastAnchorBaseSegment.value;if(d===void 0)return{anchorSegment:void 0,error:"Select anchor segment for merge"};let h=t.segmentEquivalences.get(d);return t.visibleSegments.has(h)?p===void 0||!X.equal(t.segmentEquivalences.get(p),h)?{anchorSegment:d,error:"Hover over base segment within anchor segment that is closest to merge location"}:{anchorSegment:p,error:void 0}:{anchorSegment:d,error:"Anchor segment must be in visible set"}},i=()=>{let{anchorSegment:d,error:p}=r();if(d===void 0||p!==void 0)return{anchorSegment:d,error:p,otherSegment:void 0,anchorSegmentValid:!1};let{displayState:h}=this.layer,g=h.segmentSelectionState.baseValue;return g===void 0||X.equal(h.segmentSelectionState.selectedSegment,t.segmentEquivalences.get(d))?{anchorSegment:d,otherSegment:void 0,error:"Hover over segment to merge",anchorSegmentValid:!0}:{anchorSegment:d,otherSegment:g,error:void 0,anchorSegmentValid:!0}},{body:a,header:o}=Ma(e);o.textContent="Merge segments",a.classList.add("neuroglancer-merge-segments-status"),e.bindInputEventMap(g5),e.registerDisposer(()=>{Cl(t)});let l=()=>{Me(a);let{displayState:d}=this.layer,{anchorSegment:p,otherSegment:h,anchorSegmentValid:g,error:v}=i(),b=C=>{let T=Tl(this.layer.displayState,C);return T.classList.add("neuroglancer-segment-list-entry-double-line"),T};if(p!==void 0&&a.appendChild(b(Ia(d,p))),v!==void 0){let C=document.createElement("span");C.textContent=v,a.appendChild(C)}if(h!==void 0){let C=document.createElement("span");C.textContent=" merge ",a.appendChild(C),a.appendChild(b(Ia(d,h)))}let{segmentEquivalences:x}=t;if(g){t.useTemporaryVisibleSegments.value=!0;let C=t.temporaryVisibleSegments;C.clear(),C.add(x.get(p)),h!==void 0&&C.add(x.get(h))}else{Cl(t);return}};l(),e.registerDisposer(os(this.layer.displayState,a));let c=e.registerCancellable(We(l));ss(this.layer.displayState,e,c),e.registerDisposer(this.layer.anchorSegment.changed.add(c)),e.registerDisposer(this.lastAnchorBaseSegment.changed.add(c)),e.bindAction("merge-segments",d=>{d.stopPropagation(),(async()=>{let{graph:{value:p}}=t;if(p===void 0)return;let{anchorSegment:h,otherSegment:g,error:v}=i();if(!(h===void 0||g===void 0||v!==void 0))try{await p.merge(h,g),Ee.showTemporaryMessage("Merge performed")}catch(b){Ee.showTemporaryMessage(`Merge failed: ${b}`)}})()}),e.bindAction("set-anchor",d=>{d.stopPropagation();let{segmentSelectionState:p}=this.layer.displayState,h=p.baseValue;if(h===void 0)return;let g=this.layer.anchorSegment.value;if(t.visibleSegments.add(h),g===void 0||!X.equal(g,h)){this.layer.anchorSegment.value=h.clone();return}})}get description(){return"merge"}},__=class extends Br{toJSON(){return Fg}activate(e){let t=this.layer.displayState.segmentationGroupState.value,r=()=>{let p=this.layer.anchorSegment.value;if(p===void 0)return{anchorSegment:void 0,error:"Select anchor segment for split"};let h=t.segmentEquivalences.get(p);return t.visibleSegments.has(h)?{anchorSegment:p,error:void 0}:{anchorSegment:p,error:"Anchor segment must be in visible set"}},{body:i,header:a}=Ma(e);a.textContent="Split segments",i.classList.add("neuroglancer-merge-segments-status"),e.bindInputEventMap(y5);let o=()=>{let{anchorSegment:p,error:h}=r();if(p===void 0||h!==void 0)return{anchorSegment:p,error:h,otherSegment:void 0,anchorSegmentValid:!1};let{displayState:g}=this.layer,v=g.segmentSelectionState.baseValue;return v===void 0||!X.equal(g.segmentSelectionState.selectedSegment,t.segmentEquivalences.get(p))||X.equal(v,p)?{anchorSegment:p,otherSegment:void 0,anchorSegmentValid:!0,error:"Hover over base segment to seed split"}:{anchorSegment:p,otherSegment:v,anchorSegmentValid:!0,error:void 0}};e.registerDisposer(()=>{Cl(t)});let l=()=>{Me(i);let{displayState:p}=this.layer,{anchorSegment:h,otherSegment:g,anchorSegmentValid:v,error:b}=o(),x,C;(()=>{let{segmentEquivalences:I}=t,{graphConnection:{value:M}}=this.layer;if(!v||M===void 0){Cl(t);return}else{if(t.useTemporaryVisibleSegments.value=!0,g!==void 0){let E=M.computeSplit(h,g);if(E!==void 0){x=new $i(h,E.includeRepresentative),C=new $i(g,E.excludeRepresentative),t.useTemporarySegmentEquivalences.value=!0;let V=E.includeRepresentative,O=E.excludeRepresentative,B=t.temporarySegmentEquivalences;B.clear();for(let _ of E.includeBaseSegments)B.link(_,V);for(let _ of E.excludeBaseSegments)B.link(_,O);let z=t.temporaryVisibleSegments;z.clear(),z.add(V),z.add(O);return}}t.useTemporarySegmentEquivalences.value=!1;let D=t.temporaryVisibleSegments;D.clear(),D.add(I.get(h))}})();let P=I=>{let M=Tl(this.layer.displayState,I);return M.classList.add("neuroglancer-segment-list-entry-double-line"),M};if(h!==void 0&&i.appendChild(P(x!=null?x:Ia(p,h))),b!==void 0){let I=document.createElement("span");I.textContent=b,i.appendChild(I)}if(C!==void 0){let I=document.createElement("span");I.textContent=" split ",i.appendChild(I),i.appendChild(P(C))}};e.registerDisposer(os(this.layer.displayState,i)),l();let c=e.registerCancellable(We(l));ss(this.layer.displayState,e,c),e.registerDisposer(this.layer.anchorSegment.changed.add(c));let d=async p=>{let{graph:{value:h}}=t;if(h===void 0)return;let{anchorSegment:g,otherSegment:v,error:b}=o();if(!(g===void 0||v===void 0||b!==void 0))try{await h.split(g,v),p&&t.visibleSegments.add(t.segmentEquivalences.get(v)),Ee.showTemporaryMessage("Split performed")}catch(x){Ee.showTemporaryMessage(`Split failed: ${x}`)}};e.bindAction("split-segments",p=>{p.stopPropagation(),d(!1)}),e.bindAction("split-and-select-segments",p=>{p.stopPropagation(),d(!0)}),e.bindAction("set-anchor",p=>{p.stopPropagation();let{segmentSelectionState:h}=this.layer.displayState,g=h.baseValue;if(g===void 0)return;t.visibleSegments.add(g);let v=this.layer.anchorSegment.value;if(v===void 0||!X.equal(v,g)){this.layer.anchorSegment.value=g.clone();return}})}get description(){return"split"}};function V_(){Si(Qt,Bg,n=>new R_(n)),Si(Qt,Fg,n=>new __(n))}var Ug="selectSegments",BC="mousedown0",v5=Ie.fromObject({[`at:alt?+shift?+${BC}`]:"drag-select-segments"}),wr;(function(r){r[r.IDLE=0]="IDLE",r[r.SELECT=1]="SELECT",r[r.DESELECT=2]="DESELECT"})(wr||(wr={}));var O_=class extends Br{constructor(e){super(e)}toJSON(){return Ug}activate(e){let{layer:t}=this,{body:r,header:i}=Ma(e),a=0,o=!1;e.bindInputEventMap(v5);let l=()=>Ep.value&Et.ALT?2:1,c=g=>{a!==g&&(a=g,o=!1,d())},d=()=>{Me(r);let g=document.createElement("span");switch(a){case 0:i.textContent="Select/Deselect segments",g.textContent=`${BC} to select segments; alt+${BC} to deselect segments.`;break;case 1:case 2:i.textContent=`${a==1?"Select":"Deselect"} segments`,g.textContent=`Drag to ${a==1?"select":"deselect"} segments (${t.displayState.segmentationGroupState.value.visibleSegments.size} selected).`}r.appendChild(g)};d();let p=()=>{if(a==0)return;let{segmentSelectionState:g}=t.displayState;if(g.hasSelectedSegment){let v=g.selectedSegment,{visibleSegments:b}=t.displayState.segmentationGroupState.value;switch(a){case 1:b.add(v);break;case 2:b.delete(v);break}}};e.registerDisposer(t.displayState.segmentSelectionState.changed.add(()=>{o&&p()})),e.registerDisposer(t.displayState.segmentationGroupState.value.visibleSegments.changed.add(d)),e.registerDisposer(Ep.changed.add(()=>{a!=0&&c(l())}));let h=(g,v)=>{g.stopPropagation(),c(v),p();let b=g.detail.screenX,x=g.detail.screenY;un(g.detail,(C,T,P)=>{if(!o){let I=C.screenX-b,M=C.screenY-x;I*I+M*M>25&&(p(),o=!0)}},C=>{o=!1,c(0)})};e.bindAction("drag-select-segments",g=>h(g,l()))}get description(){return"select"}};function N_(){Si(Qt,Ug,n=>new O_(n))}var S5=new X,F_=class extends H{constructor(e,t,r,i){super();this.query=e;this.segmentPropertyMap=t;this.segmentationDisplayState=r;this.parentElement=i;this.changed=new $e;this.explicitSegmentsVisible=!1;this.visibleSegmentsGeneration=-1;this.queryResult=new ke(void 0);this.statusText=new ke("");this.selectedMatches=0;this.matchStatusTextPrefix="";this.debouncedUpdate=(0,Gg.default)(()=>this.update(),0);this.render=e=>{let{explicitSegments:t}=this,r,i=!1;if(t!==void 0&&e<t.length)r=t[e],i=this.explicitSegmentsVisible;else{t!==void 0&&(e-=t.length),r=S5;let o=this.queryResult.value.indices[e],{ids:l}=this.segmentPropertyMap.segmentPropertyMap.inlineProperties;r.low=l[o*2],r.high=l[o*2+1]}let a=this.segmentWidgetFactory.get(r);return i&&(a.dataset.visibleList="true"),a};this.update(),this.registerDisposer(r.segmentationGroupState.value.visibleSegments.changed.add(this.debouncedUpdate)),this.registerDisposer(e.changed.add(this.debouncedUpdate))}get numMatches(){var e,t;return(t=(e=this.queryResult.value)==null?void 0:e.count)!=null?t:0}update(){var b;let e=this.query.value,{segmentPropertyMap:t}=this,r=this.queryResult.value,i;if(this.prevQuery===e)i=r;else{let x=QI(t,e);i=ZI(t,x)}let a=[],o=!1,l="",{visibleSegments:c}=this.segmentationDisplayState.segmentationGroupState.value,d=c.changed.count,p=this.visibleSegmentsGeneration,h=iA(i.query);if(h){if(p!==d||this.explicitSegments===void 0||!this.explicitSegmentsVisible){this.visibleSegmentsGeneration=d;let x=Array.from(c,T=>T.clone());x.sort(X.compare);let{explicitSegments:C}=this;C===void 0?(this.explicitSegments=x,a.push({retainCount:0,insertCount:x.length,deleteCount:0})):a.push(...YL(C,x,X.compare)),this.explicitSegments=x,o=!0}else a.push({retainCount:this.explicitSegments.length,deleteCount:0,insertCount:0});this.explicitSegmentsVisible=!0}else this.visibleSegmentsGeneration=d,this.explicitSegments!==void 0&&this.explicitSegmentsVisible&&(a.push({deleteCount:this.explicitSegments.length,retainCount:0,insertCount:0}),this.explicitSegments=void 0,o=!0),this.explicitSegmentsVisible=!1;let{explicitIds:g}=i;if(g!==void 0?this.explicitSegments=g:this.explicitSegmentsVisible||(this.explicitSegments=void 0),r!==i&&(a.push({retainCount:0,deleteCount:(b=r==null?void 0:r.count)!=null?b:0,insertCount:i.count}),o=!0,this.queryResult.value=i),i.explicitIds!==void 0?l=`${i.count} ids`:h?l=`${i.count} listed ids`:i.total>0&&(l=`${i.count}/${i.total} matches`),r!==i||d!==p){let x=l,C=0;t!==void 0&&i.count>0&&(C=rA(t,i,c),x+=` (${C} visible)`),this.selectedMatches=C,this.statusText.value=x}this.prevQuery=e,this.matchStatusTextPrefix=l;let{explicitSegments:v}=this;this.length=(this.explicitSegmentsVisible?v.length:0)+i.count,o&&this.changed.dispatch(a)}updateRendering(e){this.segmentWidgetFactory.update(e)}updateRenderedItems(e){e.forEachRenderedItem(t=>{this.updateRendering(t)})}},U_=Ie.fromObject({enter:{action:"toggle-listed"},"shift+enter":{action:"hide-listed"},"control+enter":{action:"hide-all"},escape:{action:"cancel"}}),b5=100;function G_(n){Tn(n,Math.max(1,n.value.length+.1))}function FC(n,e){let t;if(Number.isInteger(e))t=e.toString();else{let r=e.toString(),i=e.toPrecision(6);t=r.length<i.length?r:i}n.value=t,G_(n)}function x5(n,e){let t=document.createElement("input");return t.addEventListener("focus",()=>{t.select()}),t.classList.add(`neuroglancer-segment-query-result-numerical-plot-${n}-bound`),t.classList.add("neuroglancer-segment-query-result-numerical-plot-bound"),t.type="text",t.spellcheck=!1,t.autocomplete="off",t.title=(e===0?"Lower":"Upper")+" bound "+(n==="range"?"range":"for distribution"),t.addEventListener("input",()=>{G_(t)}),t}function C5(n,e,t){if(n===void 0||n.indices===void 0)return;let r=n.query,{sortBy:i,includeColumns:a}=r;zm(r,t)?(i=i.filter(l=>l.fieldId!==t),a=a.filter(l=>l!==t)):a.push(t),e({...r,sortBy:i,includeColumns:a})}function W_(n,e,t){var d;let r=n==null?void 0:n.query,i=r==null?void 0:r.sortBy;if(i===void 0)return;let{includeColumns:a}=r,l=((d=i.find(p=>p.fieldId===t))==null?void 0:d.order)==="<"?">":"<",c=a.filter(p=>p!==t);for(let p of i)p.fieldId!=="id"&&p.fieldId!=="label"&&p.fieldId!==t&&c.push(p.fieldId);e({...r,sortBy:[{fieldId:t,order:l}],includeColumns:c})}function z_(n,e,t){var a,o;let r=(a=n==null?void 0:n.query)==null?void 0:a.sortBy,i=(o=r==null?void 0:r.find(l=>l.fieldId===t))==null?void 0:o.order;e.textContent=i===">"?"\u25BC":"\u25B2",e.style.visibility=i===void 0?"":"visible",e.title=`Sort by ${t} in ${i==="<"?"descending":"ascending"} order`}var H_=class extends H{constructor(e,t,r){super();this.segmentPropertyMap=e;this.queryResult=t;this.setQuery=r;this.propertyHistograms=[];this.bounds={window:new ke([]),range:new ke([])};this.throttledUpdate=this.registerCancellable((0,B_.default)(()=>this.updateHistograms(),100));this.debouncedRender=this.registerCancellable(We(()=>this.updateHistogramRenderings()));this.debouncedSetQuery=this.registerCancellable((0,Gg.default)(()=>this.setQueryFromBounds(),200));let i=e==null?void 0:e.numericalProperties,a=[],o;if(i!==void 0&&i.length>0){o=document.createElement("details");let l=document.createElement("summary");l.textContent=`${i.length} numerical propert${i.length>1?"ies":"y"}`,o.appendChild(l),o.classList.add("neuroglancer-segment-query-result-numerical-list");let c=this.bounds.window.value;for(let d=0,p=i.length;d<p;++d){let h=i[d],g=this.makeNumericalPropertySummary(d,h);a.push(g),o.appendChild(g.element),c[d]=h.bounds}}this.listElement=o,this.properties=a,this.registerDisposer(this.queryResult.changed.add(()=>{this.handleNewQueryResult()})),this.registerDisposer(this.bounds.window.changed.add(this.throttledUpdate)),this.registerDisposer(this.bounds.window.changed.add(this.debouncedRender)),this.registerDisposer(this.bounds.range.changed.add(this.debouncedRender)),this.registerDisposer(this.bounds.range.changed.add(this.debouncedSetQuery)),this.handleNewQueryResult()}setQueryFromBounds(){let e=this.queryResult.value;if(e===void 0||e.indices===void 0)return;let t=e.query,r=[],i=this.bounds.range.value,{properties:a}=this;for(let o=0,l=a.length;o<l;++o){let c=a[o].property;r.push({fieldId:c.id,bounds:i[o]})}this.setQuery({...t,numericalConstraints:r})}getBounds(e){let{bounds:t}=this;return{range:t.range.value[e],window:t.window.value[e]}}setBounds(e,t){let{property:r}=this.properties[e],i=qs(r.bounds,t.range);mr(i[0],i[1])>0&&(i=[i[1],i[0]]);let a=qs(r.bounds,t.window),o=this.getBounds(e),{dataType:l}=this.properties[e].property;li(l,a,o.window)||(this.bounds.window.value[e]=a,this.bounds.window.changed.dispatch()),li(l,i,o.range)||(this.bounds.range.value[e]=i,this.bounds.range.changed.dispatch())}setBound(e,t,r,i){let o=this.segmentPropertyMap.numericalProperties[r].bounds;i=Js(o,i);let l=this.getBounds(r),c=Np(l,e,t,i,!0);this.setBounds(r,c)}handleNewQueryResult(){let e=this.queryResult.value,{listElement:t}=this;if(t!==void 0){if((e==null?void 0:e.indices)!==void 0){let{numericalConstraints:r}=e.query,{numericalProperties:i}=this.segmentPropertyMap,a=this.bounds.range.value,o=r.length,l=i.length;a.length=l;for(let c=0;c<l;++c)a[c]=i[c].bounds;for(let c=0;c<o;++c){let d=r[c],p=i.findIndex(h=>h.id===d.fieldId);a[p]=d.bounds}}this.updateHistograms(),this.throttledUpdate.cancel()}}updateHistograms(){let e=this.queryResult.value,{listElement:t}=this;t!==void 0&&(eA(this.segmentPropertyMap,e,this.propertyHistograms,this.bounds.window.value),this.updateHistogramRenderings())}updateHistogramRenderings(){this.debouncedRender.cancel();let{listElement:e}=this;if(e===void 0)return;let{propertyHistograms:t}=this;if(t.length===0){e.style.display="none";return}e.style.display="";let{properties:r}=this;for(let i=0,a=r.length;i<a;++i)this.updateNumericalPropertySummary(i,r[i],t[i])}makeNumericalPropertySummary(e,t){let r=document.createElement("div");r.classList.add("neuroglancer-segment-query-result-numerical-plot-container");let i=document.createElement("img");i.classList.add("neuroglancer-segment-query-result-numerical-plot");let a=new Vg(i,t.dataType,()=>this.getBounds(e),p=>this.setBounds(e,p)),o=document.createElement("span");o.classList.add("neuroglancer-segment-query-result-numerical-plot-sort");let l=document.createElement("input");l.type="checkbox",l.addEventListener("click",()=>{C5(this.queryResult.value,this.setQuery,t.id)});let c=p=>{let h=document.createElement("div");h.classList.add("neuroglancer-segment-query-result-numerical-plot-bounds"),h.classList.add(`neuroglancer-segment-query-result-numerical-plot-bounds-${p}`);let g=x=>{let C=x5(p,x);return C.addEventListener("change",()=>{if(this.bounds[p].value[e]!==void 0){try{let P=Ya(t.dataType,C.value);this.setBound(p,x,e,P),this.bounds[p].changed.dispatch()}catch{}FC(C,this.bounds[p].value[e][x])}}),C},v=[g(0),g(1)],b;if(p==="range"){b=[document.createElement("div"),document.createElement("div"),document.createElement("div")],b[1].classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-spacer"),b[1].appendChild(l);let x=document.createElement("span");x.classList.add("neuroglancer-segment-query-result-numerical-plot-label"),x.appendChild(document.createTextNode(t.id)),x.appendChild(o),x.addEventListener("click",()=>{W_(this.queryResult.value,this.setQuery,t.id)}),b[1].appendChild(x);let{description:C}=t;C&&(b[1].title=C),h.appendChild(b[0]),h.appendChild(v[0]);let T=document.createElement("div");T.textContent="\u2264",T.classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-symbol"),h.appendChild(T),h.appendChild(b[1]);let P=document.createElement("div");P.textContent="\u2264",P.classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-symbol"),h.appendChild(P),h.appendChild(v[1]),h.appendChild(b[2])}else h.appendChild(v[0]),h.appendChild(v[1]);return{container:h,spacers:b,inputs:v}},d={range:c("range"),window:c("window")};return r.appendChild(d.range.container),r.appendChild(i),r.appendChild(d.window.container),{property:t,controller:a,element:r,plotImg:i,boundElements:d,bounds:{window:[NaN,NaN],range:[NaN,NaN]},propertyHistogram:void 0,columnCheckbox:l,sortIcon:o}}updateNumericalPropertySummary(e,t,r){let i=t.bounds.window,a=this.bounds.window.value[e],o=t.bounds.range,l=this.bounds.range.value[e],{property:c}=t,d=this.queryResult.value,p=zm(d==null?void 0:d.query,c.id);if(t.columnCheckbox.checked=p,t.columnCheckbox.title=p?"Remove column from result table":"Add column to result table",z_(d,t.sortIcon,c.id),t.propertyHistogram===r&&li(c.dataType,i,a)&&li(c.dataType,o,l))return;let{histogram:h}=r,g="http://www.w3.org/2000/svg",v=document.createElementNS(g,"svg");v.setAttribute("width","1"),v.setAttribute("height","1"),v.setAttribute("preserveAspectRatio","none");let b=document.createElementNS(g,"rect"),x=Mr(a,l[0]),C=Mr(a,l[1]);b.setAttribute("x",`${x}`),b.setAttribute("y","0"),b.setAttribute("width",`${C-x}`),b.setAttribute("height","1"),b.setAttribute("fill","#4f4f4f"),v.appendChild(b);let T=h.length,P=(B,z,_)=>{let F=document.createElementNS(g,"polyline"),N="",J=0;for(let le=B;le<_;++le)J+=h[le];if(J===0)return;let ae=Mr(a,r.window[0]),pe=Mr(a,r.window[1]),me=(le,we)=>{let _e=le/(T-2);N+=` ${ae*(1-_e)+pe*_e},${1-we}`};B!==0&&me(B,0);let Ae=0;for(let le=B;le<z;++le)Ae+=h[le],me(le,Ae/J);return F.setAttribute("fill","none"),F.setAttribute("stroke-width","1px"),F.setAttribute("points",N),F.setAttribute("vector-effect","non-scaling-stroke"),F};{let B=P(0,T-1,T);B!==void 0&&(B.setAttribute("stroke","cyan"),v.appendChild(B))}if(!li(c.dataType,c.bounds,l)){let B=Math.floor(Math.max(0,Math.min(1,Mr(r.window,l[0])))*(T-2)),z=Math.ceil(Math.max(0,Math.min(1,Mr(r.window,l[1])))*(T-2)),_=P(B,z,z);_!==void 0&&(_.setAttribute("stroke","white"),v.appendChild(_))}let I=new XMLSerializer().serializeToString(v);t.plotImg.src=`data:image/svg+xml;base64,${btoa(I)}`,t.propertyHistogram=r;for(let B=0;B<2;++B)i[B]=a[B],FC(t.boundElements.window.inputs[B],a[B]),o[B]=l[B],FC(t.boundElements.range.inputs[B],l[B]);let M=t.boundElements.range.spacers,D=qs(a,l),E=Lc(c.dataType,a),V=Mr(a,D[0])*E,O=Mr(a,D[1])*E+(1-E);M[0].style.width=`${V*100}%`,M[2].style.width=`${(1-O)*100}%`}};function w5(n,e){let{tags:t}=n;if(t===void 0||t.length===0)return;let r=n.query,i=document.createElement("div");i.classList.add("neuroglancer-segment-query-result-tag-list");for(let{tag:a,count:o}of t){let l=document.createElement("div");l.classList.add("neuroglancer-segment-query-result-tag");let c=document.createElement("span");c.classList.add("neuroglancer-segment-query-result-tag-name"),c.textContent=a,i.appendChild(l);let d=r.includeTags.includes(a),p=r.excludeTags.includes(a),h;d?h="Remove tag from required set":p?h="Remove tag from excluded set":h="Add tag to required set",c.addEventListener("click",()=>{e(ux(r,a,!0,!d&&!p))}),c.title=h;let g=d||p,v=x=>{let C=x?o:n.count-o,T=document.createElement("div");if(T.classList.add("neuroglancer-segment-query-result-tag-toggle"),T.classList.add(`neuroglancer-segment-query-result-tag-${x?"include":"exclude"}`),l.appendChild(T),!g&&C===0)return;let P=x?d:p;T.appendChild(new nr({get value(){return P},set value(I){e(ux(r,a,x,I))},changed:Gf},{text:x?"+":"-",enableTitle:`Add tag to ${x?"required":"exclusion"} set`,disableTitle:`Remove tag from ${x?"required":"exclusion"} set`,backgroundScheme:"dark"}).element)};v(!0),v(!1),l.appendChild(c);let b=document.createElement("span");b.classList.add("neuroglancer-segment-query-result-tag-count"),g||(b.textContent=o.toString()),l.appendChild(b)}return i}var UC=class extends Nt{constructor(e){super();this.layer=e;let{element:t}=this;t.classList.add("neuroglancer-segment-display-tab"),t.appendChild(this.registerDisposer(new Ln(e.displayState.segmentationGroupState.value.graph,(c,d,p)=>{if(c===void 0)return;let h=document.createElement("div");h.className="neuroglancer-segmentation-toolbox",h.appendChild(Al(p,e,{toolJson:Bg,label:"Merge",title:"Merge segments"})),h.appendChild(Al(p,e,{toolJson:Fg,label:"Split",title:"Split segments"})),d.appendChild(h)})).element);let r=document.createElement("div");r.className="neuroglancer-segmentation-toolbox",r.appendChild(Al(this,e,{toolJson:Ug,label:"Select",title:"Select/Deselect segments"})),t.appendChild(r);let i=document.createElement("input");i.classList.add("neuroglancer-segment-list-query"),i.addEventListener("focus",()=>{i.select()});let a=this.registerDisposer(new jt(i,U_));a.allShortcutsAreGlobal=!0;let{segmentQuery:o}=this.layer.displayState,l=this.registerCancellable((0,Gg.default)(()=>{o.value=i.value},200));i.autocomplete="off",i.title=U_.describe(),i.spellcheck=!1,i.placeholder="Enter ID, name prefix or /regexp",this.registerDisposer(Ir(c=>{i.value=c},o)),this.registerDisposer(Ir(c=>{Date.now()-c<100&&(setTimeout(()=>{i.focus()},0),this.layer.segmentQueryFocusTime.value=Number.NEGATIVE_INFINITY)},this.layer.segmentQueryFocusTime)),t.appendChild(i),t.appendChild(this.registerDisposer(new Ln(e.displayState.segmentPropertyMap,(c,d,p)=>{let h=le=>{i.focus(),i.select();let we=nA(c,le);document.execCommand("insertText",!1,we),o.value=we,i.select()},g=p.registerDisposer(new F_(o,c,e.displayState,d)),v=e.displayState.segmentationGroupState.value,b=document.createElement("ul");b.classList.add("neuroglancer-segment-query-errors"),d.appendChild(b);let x=document.createElement("div");x.classList.add("neuroglancer-segment-query-result-statistics");let C=document.createElement("span"),T=document.createElement("input");T.type="checkbox",T.checked=!0,T.title="Deselect all segment IDs",T.addEventListener("change",()=>{v.visibleSegments.clear()});let P=xr({title:"Copy visible segment IDs",onClick:()=>{let le=Array.from(v.visibleSegments,we=>we.clone());le.sort(X.compare),br(le.join(", "))}}),I=document.createElement("span");C.appendChild(P),C.appendChild(T),C.appendChild(I);let M=document.createElement("span"),D=document.createElement("input"),E=xr({onClick:()=>{l(),l.flush(),g.debouncedUpdate.flush();let le=g.queryResult.value;if(le===void 0)return;let we=new Array(le.count);fp(c,le,(_e,Fe)=>{we[Fe]=_e.toString()}),br(we.join(", "))}});D.type="checkbox";let V=()=>{l(),l.flush(),g.debouncedUpdate.flush();let le=g.queryResult.value;if(le===void 0)return;let{visibleSegments:we}=v,{selectedMatches:_e}=g,Fe=_e!==le.count;if(Fe&&le.count-_e>b5){if(!F)return F=!0,O.textContent=`Confirm: show ${le.count-_e} segments?`,!1;F=!1,_()}return fp(c,le,rt=>{we.set(rt,Fe)}),!0};D.addEventListener("click",le=>{V()||le.preventDefault()});let O=document.createElement("span");M.appendChild(E),M.appendChild(D),M.appendChild(O),C.classList.add("neuroglancer-segment-list-status"),M.classList.add("neuroglancer-segment-list-status"),d.appendChild(x);let B=document.createElement("div");B.classList.add("neuroglancer-segment-query-result-statistics-separator"),d.appendChild(B),d.appendChild(M),d.appendChild(C);let z=-1,_=()=>{let le=v.visibleSegments.size;z!==le&&(z=le,I.textContent=`${le} visible in total`,T.checked=le>0,T.style.visibility=le?"visible":"hidden",P.style.visibility=le?"visible":"hidden"),O.textContent=g.statusText.value;let{numMatches:we,selectedMatches:_e}=g;E.style.visibility=we?"visible":"hidden",E.title=`Copy ${we} segment ID(s)`,D.style.visibility=we?"visible":"hidden",_e===0?(D.checked=!1,D.indeterminate=!1,D.title=`Show ${we} segment ID(s)`):_e===we?(D.checked=!0,D.indeterminate=!1,D.title=`Hide ${_e} segment ID(s)`):(D.checked=!0,D.indeterminate=!0,D.title=`Show ${we-_e} segment ID(s)`)};_(),g.statusText.changed.add(_),p.registerDisposer(v.visibleSegments.changed.add(_));let F=!1;p.registerEventListener(i,"input",()=>{l(),F&&(F=!1,_())}),p.registerDisposer(ce(i,"cancel",()=>{i.focus(),i.select(),document.execCommand("delete"),i.blur(),i.value="",o.value="",F=!1,_()})),p.registerDisposer(ce(i,"toggle-listed",V)),p.registerDisposer(ce(i,"hide-all",()=>{v.visibleSegments.clear()})),p.registerDisposer(ce(i,"hide-listed",()=>{l(),l.flush(),g.debouncedUpdate.flush();let{visibleSegments:le}=v;if(o.value==="")le.clear();else{let we=g.queryResult.value;if(we===void 0)return;fp(c,we,_e=>{le.delete(_e)})}}));let N=p.registerDisposer(new Ol({source:g,horizontalScroll:!0})),J=p.registerCancellable(We(()=>{g.updateRenderedItems(N)})),{displayState:ae}=this.layer;p.registerDisposer(ae.segmentSelectionState.changed.add(J)),p.registerDisposer(v.visibleSegments.changed.add(J)),p.registerDisposer(ae.segmentColorHash.changed.add(J)),p.registerDisposer(ae.segmentStatedColors.changed.add(J)),p.registerDisposer(ae.segmentDefaultColor.changed.add(J)),N.element.classList.add("neuroglancer-segment-list"),p.registerDisposer(e.bindSegmentListWidth(N.element)),p.registerDisposer(new kn(N.element,qc()));let pe=p.registerDisposer(new H_(c,g.queryResult,h));{let{listElement:le}=pe;le!==void 0&&x.appendChild(le)}let me,Ae=le=>{let we=le==null?void 0:le.errors;if(Me(b),we!==void 0)for(let _e of we){let Fe=document.createElement("li");Fe.textContent=_e.message,b.appendChild(Fe)}};Ir(le=>{if(g.segmentWidgetFactory=new Wb(g.segmentationDisplayState,g.parentElement,_e=>zm(le==null?void 0:le.query,_e.id)),N.scrollToTop(),Me(N.header),c!==void 0){let _e=g.segmentWidgetFactory.getHeader();_e.container.classList.add("neuroglancer-segment-list-header");for(let Fe of _e.propertyLabels){let{label:rt,sortIcon:ye,id:Le}=Fe;rt.addEventListener("click",()=>{W_(g.queryResult.value,h,Le)}),z_(le,ye,Le)}N.header.appendChild(_e.container)}if(Ae(le),B.style.display="none",me==null||me.remove(),le===void 0)return;let{query:we}=le;we.errors!==void 0||we.ids!==void 0||(me=w5(le,h),me!==void 0&&x.appendChild(me),(pe.properties.length>0||me!==void 0)&&(B.style.display=""))},g.queryResult),d.appendChild(N.element)})).element)}};var GC=Ye(gt());var Ss=class{static insertAfter(n,e){let t=n.next0;e.next0=t,e.prev0=n,n.next0=e,t.prev0=e}static insertBefore(n,e){let t=n.prev0;e.prev0=t,e.next0=n,n.prev0=e,t.next0=e}static front(n){let e=n.next0;return e===n?null:e}static back(n){let e=n.prev0;return e===n?null:e}static pop(n){let e=n.next0,t=n.prev0;return e.prev0=t,t.next0=e,n.next0=null,n.prev0=null,n}static*iterator(n){for(let e=n.next0;e!==n;e=e.next0)yield e}static*reverseIterator(n){for(let e=n.prev0;e!==n;e=e.prev0)yield e}static initializeHead(n){n.next0=n.prev0=n}};var $_=class{constructor(){Ss.initializeHead(this)}},WC=new $_,T5=window.top===window,zC=(0,GC.default)(()=>{if(!T5)return;let{activeElement:n}=document;if(n===null||n===document.body){let e=Ss.front(WC);e!==null&&e.element.focus({preventScroll:!0})}});window.addEventListener("focus",()=>{zC()},!0);window.addEventListener("blur",()=>{zC()},!0);var vo=class extends H{constructor(e){super();this.element=e;this.prev0=null;this.next0=null;this.lastFocusedElement=null;this.scheduleUpdateFocus=this.registerCancellable((0,GC.default)(()=>{let{activeElement:e}=document,{element:t}=this;t.contains(e)||Hd(e)||(e!=null&&(e===this.lastFocusedElement||e.contains(t))&&this.element.focus({preventScroll:!0}),this.lastFocusedElement=null)},0));e.tabIndex=-1,this.registerEventListener(e,"pointerdown",t=>{t.target===e&&(this.lastFocusedElement=null,e.focus({preventScroll:!0}))}),this.registerEventListener(e,"mouseenter",()=>{this.lastFocusedElement=document.activeElement,this.scheduleUpdateFocus()}),this.registerEventListener(e,"mouseleave",()=>{this.scheduleUpdateFocus.cancel()}),Ss.insertBefore(WC,this),this.registerEventListener(e,"focus",()=>{Ss.pop(this),Ss.insertAfter(WC,this)}),zC()}disposed(){Ss.pop(this),super.disposed()}};var Wg=0,L5=Ie.fromObject({escape:{action:"close"}}),Xi=class extends H{constructor(){super();this.keyMap=new Ie;this.keyMap.addParent(L5,Number.NEGATIVE_INFINITY),++Wg;let e=this.container=document.createElement("div");e.className="overlay";let t=this.content=document.createElement("div");this.registerDisposer(new vo(t)),t.className="overlay-content",e.appendChild(t),document.body.appendChild(e),this.registerDisposer(new jt(this.container,this.keyMap)),this.registerEventListener(e,"action:close",()=>{this.dispose()}),t.focus()}disposed(){--Wg,document.body.removeChild(this.container),super.disposed()}};function bs(n={}){return He({text:"?",...n})}function j_(n,e,t,r){let i=document.createElement("label");i.classList.add("neuroglancer-layer-control-container");let a=document.createElement("div");a.classList.add("neuroglancer-layer-control-label-container");let o=document.createElement("div");o.classList.add("neuroglancer-layer-control-label"),a.appendChild(o);let l=document.createElement("div");l.classList.add("neuroglancer-layer-control-label-text-container"),l.appendChild(document.createTextNode(t.label)),o.appendChild(l),t.title&&(o.title=t.title),i.appendChild(a);let{control:c,controlElement:d}=t.makeControl(e,n,{labelContainer:a,labelTextContainer:l,display:e.manager.root.display,visibility:r});return d.classList.add("neuroglancer-layer-control-control"),i.appendChild(d),{controlContainer:i,label:o,labelContainer:a,labelTextContainer:l,control:c}}var zg=class extends Br{constructor(e,t){super(e);this.options=t}activate(e){let{options:t}=this,{layer:r}=this,{isValid:i}=t;if(i!==void 0&&!i(r).value)return;let{header:a,body:o}=Ma(e),{controlContainer:l,control:c,labelContainer:d}=j_(e,r,t,new wt(wt.VISIBLE));a.appendChild(d),o.appendChild(l),t.activateTool(e,c)}get description(){var t;let{options:e}=this;return(t=e.toolDescription)!=null?t:e.label}toJSON(){return this.options.toolJson}};function J_(n,e,t,r){let{controlContainer:i,label:a}=j_(n,e,t,r);return i.classList.add("neuroglancer-layer-options-control-container"),a.prepend(n.registerDisposer(new sg(e,t.toolJson)).element),i}function fu(n,e,t,r){let{isValid:i}=r;return i===void 0?J_(n,e,r,t):n.registerDisposer(new Ln(i(e),(a,o,l)=>{!a||o.appendChild(J_(l,e,r,t))},t)).element}function Hg(n,e){let{toolJson:t}=e,r=typeof t=="string"?t:t.type;Si(n,r,i=>new zg(i,e))}var q_=Ye(gt());var $g=class extends H{constructor(e){super();this.group=e;this.element=document.createElement("div");this.topRow=document.createElement("div");this.label=document.createElement("label");this.selectElement=document.createElement("select");this.linkedLayers=document.createElement("div");this.unlinkButton=document.createElement("button");let{element:t,label:r,topRow:i,selectElement:a,linkedLayers:o,unlinkButton:l}=this;i.appendChild(r),i.appendChild(a),i.appendChild(l),l.textContent="Unlink",l.addEventListener("click",()=>{this.group.isolate()}),t.appendChild(i),t.appendChild(o),this.updateView();let c=(0,q_.default)(()=>this.updateView(),0);this.registerEventListener(a,"change",()=>{this.updateModel(),c()}),this.registerDisposer(this.group.changed.add(c)),this.registerDisposer(this.group.linkedLayersChanged.add(c)),this.registerDisposer(this.group.layerManager.layersChanged.add(c))}updateModel(){let e=this.selectElement.value;e===""&&this.group.root.value!==this.group.layer?this.group.isolate():this.group.linkByName(e)}updateView(){var l;let{selectElement:e,group:t}=this,{predicate:r}=t;Me(e);let i=this.group.rootGroup.linkedLayers.size!==0;this.unlinkButton.style.display=i?"":"none";let{linkedLayers:a}=this,o=t.linkedLayers.size!==0;if(a.style.display=o?"":"none",this.unlinkButton.textContent=o?"Unlink all":"Unlink",o){this.element.style.display="",e.style.display="none",Me(a);for(let c of t.linkedLayers){let d=document.createElement("div");d.classList.add("neuroglancer-linked-layer-widget-layer");let p=Kc({title:"Unlink layer",onClick:()=>{this.group.getGroup(c).isolate()}});d.appendChild(p),d.appendChild(document.createTextNode(c.managedLayer.name)),a.appendChild(d)}}else{e.style.display="";let c=document.createElement("option");e.appendChild(c);let d=0;for(let p of this.group.layerManager.managedLayers){let h=p.layer;if(h!==null&&h!==t.layer&&r(h)){++d;let g=document.createElement("option"),{name:v}=p;g.textContent=v,g.value=v,e.appendChild(g)}}e.value=(l=t.toJSON())!=null?l:"",this.element.style.display=d===0?"none":""}}};var Y_='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="maximiseIconTitle"><polyline points="21 16 21 21 16 21"></polyline><polyline points="8 21 3 21 3 16"></polyline><polyline points="16 3 21 3 21 8"></polyline><polyline points="3 8 3 3 8 3"></polyline></svg>';function xs(n={}){return He({svg:Y_,...n})}var gwe=Ye(Q_());var Gl=Ye(Cs()),tV=Ye(eV()),nV=Ye(gt());(0,tV.default)(Gl.default);var k5=500,So=class extends H{constructor(e){super();this.state=e;this.changingValue=!1;this.debouncedValueUpdater=(0,nV.default)(()=>{this.changingValue=!0;try{this.state.fragmentMain.value=this.textEditor.getValue()}finally{this.changingValue=!1}},k5);this.textEditor=(0,Gl.default)(i=>{},{value:this.state.fragmentMain.value,mode:"glsl",gutters:["CodeMirror-lint-markers"]}),this.textEditor.on("change",()=>{this.setValidState(void 0),this.debouncedValueUpdater()}),this.registerDisposer(this.state.fragmentMain.changed.add(()=>{this.changingValue||this.textEditor.setValue(this.state.fragmentMain.value)})),this.element.classList.add("neuroglancer-shader-code-widget"),this.registerDisposer(this.state.shaderError.changed.add(()=>{this.updateErrorState()}));let{shaderControlState:t}=this.state;t!==void 0&&this.registerDisposer(t.parseErrors.changed.add(()=>{this.updateErrorState()})),this.updateErrorState();let r=new IntersectionObserver(i=>{i.some(a=>a.isIntersecting)&&this.textEditor.refresh()},{root:document.body});r.observe(this.element),this.registerDisposer(()=>r.disconnect())}get element(){return this.textEditor.getWrapperElement()}updateErrorState(){let{sourceStringNumber:e=1}=this.state,t=this.state.shaderError.value,r,{shaderControlState:i}=this.state;i!==void 0?r=i.parseErrors.value:r=[],t===void 0&&r.length===0?this.setValidState(void 0):t!=null||r.length!==0?(this.textEditor.setOption("lint",{getAnnotations:()=>{let a=[];for(let o of r)a.push({message:o.message,severity:"error",from:Gl.default.Pos(o.line)});if(t!=null)if(t.name==="ShaderCompilationError")for(let o of t.errorMessages)a.push({message:o.message,severity:"error",from:Gl.default.Pos(o.file===e&&o.line||0)});else t.name==="ShaderLinkError"?a.push({message:t.log,severity:"error",from:Gl.default.Pos(0)}):a.push({message:t.message,severity:"error",from:Gl.default.Pos(0)});return a}}),this.setValidState(!1)):(this.textEditor.setOption("lint",void 0),this.setValidState(!0))}setValidState(e){let{element:t}=this;t.classList.remove("invalid-input"),t.classList.remove("valid-input"),e===!0?t.classList.add("valid-input"):e===!1&&t.classList.add("invalid-input")}disposed(){this.debouncedValueUpdater.flush(),this.debouncedValueUpdater=void 0,et(this.element),this.textEditor=void 0,super.disposed()}};var QC=Ye(gt());var Fp="neuroglancer-position",rV=Ie.fromObject({arrowup:{action:"adjust-up"},arrowdown:{action:"adjust-down"},arrowleft:{action:"maybe-tab-backward",preventDefault:!1},arrowright:{action:"maybe-tab-forward",preventDefault:!1},tab:{action:"tab-forward"},"shift+tab":{action:"tab-backward"},wheel:{action:"adjust-via-wheel"},backspace:{action:"delete-backward",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel"}}),E5=[n=>n.nameElement,n=>n.coordinate,n=>n.scaleElement];function jg(n,e){let t=n.coordinateArrays[e];return t===void 0?t:n.units[e]!=""||n.scales[e]!==1?null:t}var iV=class{constructor(e,t){this.coordinateSpace=e;this.container=document.createElement("div");this.nameContainer=document.createElement("span");this.nameElement=document.createElement("input");this.scaleContainer=document.createElement("span");this.scaleElement=document.createElement("input");this.coordinate=document.createElement("input");this.coordinateLabel=document.createElement("span");this.coordinateLabelWidth=0;this.dropdownOwner=void 0;this.modified=!1;this.draggingPosition=!1;this.hasFocus=!1;let{container:r,scaleElement:i,scaleContainer:a,coordinate:o,nameElement:l,nameContainer:c,coordinateLabel:d}=this;r.title="",r.classList.add("neuroglancer-position-dimension"),r.draggable=!0,r.tabIndex=-1,r.appendChild(c),r.appendChild(i),c.appendChild(l),c.title="Drag to reorder, double click to rename.  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",a.appendChild(i),l.classList.add("neuroglancer-position-dimension-name"),l.disabled=!0,l.spellcheck=!1,l.autocomplete="off",l.required=!0,l.placeholder=" ",a.classList.add("neuroglancer-position-dimension-scale-container"),i.classList.add("neuroglancer-position-dimension-scale"),i.disabled=!0,i.spellcheck=!1,i.autocomplete="off",r.appendChild(a),r.appendChild(o),o.type="text",o.classList.add("neuroglancer-position-dimension-coordinate"),o.spellcheck=!1,o.autocomplete="off",o.pattern=String.raw`(-?\d+(?:\.(?:\d+)?)?)`;let p=jg(e,t);if(p!=null){let h=0;for(let g of p.labels)h=Math.max(h,g.length);this.coordinateLabelWidth=h,d.style.width=`${h+2}ch`,r.appendChild(d)}o.required=!0,o.placeholder=" ",d.classList.add("neuroglancer-position-dimension-coordinate-label")}};function jC(n,e,t,r){return Math.floor((n-e)*(r-1)/(t-e))}function D5(n,e,t){let{boundingBoxes:r,bounds:i}=n,a=Math.floor(i.lowerBounds[e]),o=Math.ceil(i.upperBounds[e]-1);if(!Number.isFinite(a)||!Number.isFinite(o))return;let l=[],c=p=>jC(p,a,o,t),{rank:d}=n;for(let p of r){let h=hS(p,e,d);h!==void 0&&(h.lower=c(h.lower),h.upper=c(Math.ceil(h.upper-1)),l.push(h))}return l.sort((p,h)=>{let g=p.lower-h.lower;return g!==0?g:h.upper-h.upper}),Bf(l,(p,h)=>{if(h===0)return!0;let g=l[h-1];return g.lower!==p.lower||g.upper!==p.upper}),{lowerBound:a,upperBound:o,normalizedBounds:l}}var JC=10,qC=15,P5=10,YC=JC+qC+P5;function I5(n,e,t){e.clearRect(0,0,n.width,n.height);let{normalizedBounds:r}=t;function i(o){e.fillRect(0,o,JC,1)}e.fillStyle="#fff";for(let{lower:o,upper:l}of r)i(o),i(l);let a=r.length;e.fillStyle="#ccc";for(let o=0;o<a;++o){let{lower:l,upper:c}=r[o],d=Math.floor(o*qC/a),p=Math.max(1,qC/a);e.fillRect(d+JC,l,p,c+1-l)}}function aV(n,e){Tn(n,e.length+1)}function oV(n){let{value:e}=n;Tn(n),n.parentElement.dataset.isEmpty=e===""?"true":"false"}var ws=class extends H{constructor(e,t,{copyButton:r=!0}={}){super();this.position=e;this.combiner=t;this.element=document.createElement("div");this.dimensionContainer=document.createElement("div");this.coordinateSpace=void 0;this.dimensionWidgets=new Map;this.dimensionWidgetList=[];this.dragSource=void 0;let{element:i,dimensionContainer:a}=this;if(this.registerDisposer(e.coordinateSpace.changed.add(this.registerCancellable(We(()=>this.updateDimensions())))),i.className="neuroglancer-position-widget",a.style.display="contents",i.appendChild(a),r){let l=xr({title:"Copy position to clipboard",onClick:()=>{let c=br(this.getPositionText());Ee.showTemporaryMessage(c?"Position copied to clipboard":"Failed to copy position to clipboard")}});l.addEventListener("dragstart",c=>{c.dataTransfer.setData(Fp,JSON.stringify({position:e.toJSON(),dimensions:e.coordinateSpace.value.names})),c.dataTransfer.setData("text",this.getPositionText()),c.stopPropagation()}),l.draggable=!0,i.appendChild(l)}this.registerDisposer(e.changed.add(this.registerCancellable(We(()=>this.updateView()))));let o=this.registerDisposer(new jt(i,rV));o.allShortcutsAreGlobal=!0,this.registerDisposer(new kn(i,rV)),this.registerDisposer(ce(i,"cancel",l=>{this.coordinateSpace=void 0,this.updateView(),this.closeDropdown();let{target:c}=l;c instanceof HTMLElement&&c.blur()})),this.updateView()}openRegularDropdown(e,t){t.classList.add("neuroglancer-position-dimension-dropdown");let r=document.createElement("canvas"),i=r.getContext("2d"),a=document.createElement("div"),o=document.createElement("div");o.appendChild(a);let l=document.createTextNode("");a.appendChild(l);let c=document.createElement("div"),d=document.createElement("div");o.classList.add("neuroglancer-position-dimension-dropdown-lowerbound"),c.classList.add("neuroglancer-position-dimension-dropdown-upperbound"),d.classList.add("neuroglancer-position-dimension-dropdown-hoverposition"),t.appendChild(o),t.appendChild(c),t.appendChild(d),t.appendChild(r);let p=100;r.width=YC,r.height=p,c.style.marginTop=`${p-1}px`;let h,g,v,b=()=>{let I=this.dimensionWidgetList.indexOf(e);if(I===-1)return;let{coordinateSpace:M}=e,D=D5(M,I,p);if(D===void 0||M.bounds.lowerBounds[I]+1===M.bounds.upperBounds[I]){t.style.display="none",e.container.dataset.dropdownVisible=void 0;return}e.container.dataset.dropdownVisible="true",t.style.display="";let{lowerBound:E,upperBound:V}=D;h=E,g=V,l.textContent=E.toString(),c.textContent=V.toString(),I5(r,i,D);let O=this.position.value[I];if(O>=E&&O<=V&&(i.fillStyle="#f66",i.fillRect(0,jC(O,E,V,p),YC,1)),v!==void 0&&v>=E&&v<=V){i.fillStyle="#66f";let B=jC(v,E,V,p);i.fillRect(0,B,YC,1),d.textContent=v.toString();let z=a.clientHeight;a.style.visibility=B>z?"":"hidden",c.style.visibility=B<p-z?"":"hidden",d.style.display="",d.style.visibility="visible",d.style.marginTop=`${B}px`}else a.style.visibility="",d.style.display="none",c.style.visibility=""},x=e.dropdownOwner,C=x.registerCancellable(We(b));x.registerDisposer(this.position.changed.add(C));let T=I=>{if(h===void 0||g===void 0)return;let M=r.getBoundingClientRect(),D=(I.clientY-M.top)/M.height;return D=Math.max(0,D),D=Math.min(1,D),Math.round(D*(g-h))+h},P=I=>{let M=this.dimensionWidgetList.indexOf(e);if(M===-1)return;let D=T(I);if(D===void 0)return;let{position:E}=this,V=E.value;V[M]=D+.5,e.modified=!1,E.value=V};r.addEventListener("pointermove",I=>{v=T(I),C()}),r.addEventListener("pointerleave",()=>{v=void 0,C()}),r.addEventListener("pointerdown",I=>{I.preventDefault(),I.stopPropagation(),!(I.ctrlKey||I.altKey||I.shiftKey||I.metaKey)&&(un(I,M=>{e.dropdownOwner!==void 0&&(v=void 0,P(M),C(),e.draggingPosition=!0)},()=>{e.draggingPosition=!1,this.updateDropdownVisibility(e)}),P(I))}),b()}openCoordinateArrayDropdown(e,t,r){t.classList.add("neuroglancer-position-dimension-coordinate-dropdown");let{coordinates:i,labels:a}=r,o=[],l=i.length;t.style.setProperty("--neuroglancer-coordinate-label-width",`${e.coordinateLabelWidth}ch`);for(let c=0;c<l;++c){let d=document.createElement("div");d.classList.add("neuroglancer-dimension-dropdown-coordinate-entry");let p=document.createElement("div");p.classList.add("neuroglancer-dimension-dropdown-coordinate");let h=document.createElement("div");h.classList.add("neuroglancer-dimension-dropdown-coordinate-label"),h.textContent=a[c],p.textContent=i[c].toString(),d.appendChild(p),d.appendChild(h),d.addEventListener("click",()=>{let g=this.dimensionWidgetList.indexOf(e);if(g===-1)return;let{position:v}=this,b=v.value;b[g]=i[c]+.5,e.modified=!1,v.value=b}),t.appendChild(d),o.push({entryElement:d,coordinateElement:p,labelElement:h})}}openDropdown(e){if(e.dropdownOwner!==void 0)return;let t=this.dimensionWidgetList.indexOf(e);if(t===-1)return;this.closeDropdown();let r=e.dropdownOwner=new H,i=document.createElement("div");i.draggable=!0,i.addEventListener("dragstart",o=>{o.stopPropagation(),o.preventDefault()}),i.addEventListener("pointerenter",()=>{e.hasFocus=!0}),i.tabIndex=-1,e.container.appendChild(i);let a=jg(e.coordinateSpace,t);a==null?this.openRegularDropdown(e,i):this.openCoordinateArrayDropdown(e,i,a),this.widgetWithOpenDropdown=e,r.registerDisposer(()=>{et(i),e.dropdownOwner=void 0,delete e.container.dataset.dropdownVisible,this.widgetWithOpenDropdown=void 0}),r.registerEventListener(document,"pointerdown",o=>{let{target:l}=o;l instanceof Node&&e.container.contains(l)||this.closeDropdown(e)},{capture:!0})}closeDropdown(e=this.widgetWithOpenDropdown){if(e===void 0)return;let{dropdownOwner:t}=e;t!==void 0&&t.dispose()}pasteString(e,t){for(;;){e.coordinate.focus();let r=t.match(/^\s*(-?\d+(?:\.(?:\d+)?)?)((?:\s+(?![\s,]))|(?:\s*,\s*))?/);if(r===null)break;if(r[1]!==void 0&&document.execCommand("insertText",void 0,r[1]),r[2]!==void 0){let{dimensionWidgetList:i}=this,a=i.indexOf(e);if(a===-1||a+1===i.length)break;let o=t.substring(r[0].length);e=i[a+1],t=o;continue}break}}reorderDimensionTo(e,t){if(e===t)return;let{coordinateSpace:r}=this.position;r.value=Dh(r.value,e,t)}updateDropdownVisibility(e){e.hasFocus||e.draggingPosition?this.openDropdown(e):this.closeDropdown(e)}newDimension(e,t){let r=new iV(e,t);r.container.addEventListener("dragstart",i=>{this.dragSource=r,i.stopPropagation(),i.dataTransfer.setData("neuroglancer-dimension","")}),r.container.addEventListener("dragenter",i=>{let{dragSource:a}=this;if(a===void 0||a===r)return;let{dimensionWidgetList:o}=this,l=o.indexOf(a),c=o.indexOf(r);l===-1||c===-1||(i.preventDefault(),this.reorderDimensionTo(c,l))}),r.container.addEventListener("dragend",i=>{this.dragSource===r&&(this.dragSource=void 0)}),r.nameContainer.addEventListener("dblclick",()=>{r.nameElement.disabled=!1,r.nameElement.focus(),r.nameElement.select()}),r.scaleContainer.addEventListener("dblclick",()=>{r.scaleElement.disabled=!1,r.scaleElement.focus(),r.scaleElement.select()}),r.coordinate.addEventListener("focus",()=>{r.coordinate.select()}),r.container.addEventListener("focusin",()=>{r.hasFocus=!0,this.updateDropdownVisibility(r)}),r.container.addEventListener("focusout",i=>{let{relatedTarget:a}=i;a instanceof Node&&r.container.contains(a)||(r.hasFocus=!1,this.updateDropdownVisibility(r))}),r.container.addEventListener("click",i=>{(!(i.target instanceof HTMLInputElement)||i.target.disabled)&&r.coordinate.focus()}),r.coordinate.addEventListener("paste",i=>{let a=r.coordinate,o=a.value,{clipboardData:l}=i;if(l===null)return;let c=l.getData("text"),{selectionEnd:d,selectionStart:p}=a;if(p!==0||d!==o.length){p==null&&(p=0),d==null&&(d=0);let h=c.match(/[^\-0-9\.]/);h!==null&&(c=c.substring(0,h.index)),c.length>0&&document.execCommand("insertText",void 0,c)}else this.pasteString(r,c);i.preventDefault(),i.stopPropagation()}),r.coordinate.addEventListener("input",()=>{r.modified=!0;let i=r.coordinate,a=i.value,{selectionDirection:o,selectionEnd:l,selectionStart:c}=i;c===null&&(c=0),l===null&&(l=c);let d="",p=/[^\-0-9\.]/g;d+=a.substring(0,c).replace(p,"");let h=d.length;d+=a.substring(c,l).replace(p,"");let g=d.length;d+=a.substring(l).replace(p,""),i.value=d,i.selectionStart=h,i.selectionEnd=g,i.selectionDirection=o,aV(i,d),l===c&&l===a.length&&a.match(/^(-?\d+(?:\.(?:\d+)?)?)((?:\s+(?![\s,]))|(?:\s*,\s*))$/)&&this.selectAdjacentCoordinate(r,1)}),r.nameElement.addEventListener("input",()=>{let{nameElement:i}=r;Tn(i),this.updateNameValidity()}),r.scaleElement.addEventListener("input",()=>{let{scaleElement:i}=r;oV(i),this.updateScaleValidity(r)}),r.coordinate.addEventListener("blur",i=>{let{relatedTarget:a}=i;this.dimensionWidgetList.some(o=>o.coordinate===a)||r.modified&&this.updatePosition()}),r.nameElement.addEventListener("blur",i=>{r.nameElement.disabled=!0;let{relatedTarget:a}=i;this.dimensionWidgetList.some(o=>o.nameElement===a)||this.updateNames()||this.forceUpdateDimensions()}),r.scaleElement.addEventListener("blur",i=>{r.scaleElement.disabled=!0;let{relatedTarget:a}=i;this.dimensionWidgetList.some(o=>o.scaleElement===a)||this.updateScales()||this.forceUpdateDimensions()}),ce(r.container,"adjust-via-wheel",i=>{let a=i.detail,{deltaY:o}=a;o!==0&&this.adjustDimension(r,Math.sign(o))}),ce(r.container,"adjust-up",()=>{this.adjustDimension(r,-1)}),ce(r.container,"adjust-down",()=>{this.adjustDimension(r,1)});for(let i of E5){let a=i(r);ce(a,"maybe-tab-forward",o=>{this.handleLeftRightMovement(o,r,1,i)}),ce(a,"maybe-tab-backward",o=>{this.handleLeftRightMovement(o,r,-1,i)}),ce(a,"tab-forward",()=>{this.selectAdjacentField(r,1,i)}),ce(a,"tab-backward",()=>{this.selectAdjacentField(r,-1,i)})}return ce(r.coordinate,"commit",()=>{this.updatePosition()}),ce(r.nameElement,"commit",()=>{this.updateNames()}),ce(r.scaleElement,"commit",()=>{this.updateScales()}),ce(r.coordinate,"delete-backward",i=>{i.stopPropagation();let{coordinate:a}=r;a.selectionStart===a.selectionEnd&&a.selectionStart===0&&(i.preventDefault(),this.selectAdjacentCoordinate(r,-1))}),r}forceUpdateDimensions(){let{position:{coordinateSpace:{value:e}}}=this;e.valid||(e=Xr),this.coordinateSpace=e;let{dimensionWidgets:t,dimensionWidgetList:r}=this;r.length=0;let{names:i,ids:a,scales:o,units:l}=e;$n(this.dimensionContainer,a.map((c,d)=>{let p=t.get(c);p===void 0?(p=this.newDimension(e,d),t.set(c,p)):p.coordinateSpace=e;let h=i[d];p.nameElement.value=h,delete p.nameElement.dataset.isValid,Tn(p.nameElement);let g=jg(e,d);g===void 0?p.container.dataset.coordinateArray="none":g===null?p.container.dataset.coordinateArray="invalid":p.container.dataset.coordinateArray="valid",p.scaleContainer.title="Drag to reorder, double click to change scale",g===null&&(p.scaleContainer.title+=".  Coordinate array disabled.  To use the coordinate array, remove the unit/scale.");let{scale:v,prefix:b,unit:x}=dS(o[d],l[d]),C=`${v}${b}${x}`;return p.scaleElement.value=C,delete p.scaleElement.dataset.isValid,oV(p.scaleElement),r.push(p),p.container}));for(let[c,d]of t)d.coordinateSpace!==e&&(this.closeDropdown(d),t.delete(c))}updateDimensions(){let{position:{coordinateSpace:{value:e}}}=this;e!==this.coordinateSpace&&this.forceUpdateDimensions()}selectAdjacentField(e,t,r){let{dimensionWidgetList:i}=this,a=i.indexOf(e);if(a!==-1)for(;;){if(a+=t,a<0||a>=i.length)return!1;let o=i[a],l=r(o);if(l.style.display!=="none")return l.disabled=!1,l.focus(),l.selectionStart=0,l.selectionEnd=l.value.length,l.selectionDirection=t===1?"forward":"backward",!0}}selectAdjacentCoordinate(e,t){return this.selectAdjacentField(e,t,r=>r.coordinate)}handleLeftRightMovement(e,t,r,i){e.stopPropagation();let a=i(t);a.selectionStart!==a.selectionEnd||a.selectionStart!==(r===1?a.value.length:0)||this.selectAdjacentField(t,r,i)&&e.preventDefault()}updateNameValidity(){let{dimensionWidgetList:e}=this,t=e.map(a=>a.nameElement.value),r=t.length,i=this.combiner.getRenameValidity(t);for(let a=0;a<r;++a)e[a].nameElement.dataset.isValid=i[a]===!1?"false":"true"}updateScaleValidity(e){let t=Go(e.scaleElement.value)!==void 0;e.scaleElement.dataset.isValid=t.toString()}adjustDimension(e,t){let r=this.dimensionWidgetList.indexOf(e);if(r===-1)return;this.updatePosition();let{position:i}=this;if(!i.valid)return;let a=i.coordinateSpace.value,{bounds:o}=a,l=Float32Array.from(i.value),c=Math.floor(l[r]+t);if(t>0){let d=o.upperBounds[r];Number.isFinite(d)&&(c=Math.min(c,Math.ceil(d-1)))}else{let d=o.lowerBounds[r];Number.isFinite(d)&&(c=Math.max(c,Math.floor(d)))}l[r]=c+.5,this.position.value=l,this.updateView()}updatePosition(){let{dimensionWidgetList:e}=this,{position:t}=this,{value:r}=t;if(r===void 0)return;let i=e.length;for(let a=0;a<i;++a){let o=e[a];o.modified=!1;let l=Number(o.coordinate.value);Number.isFinite(l)&&(r[a]=l+(Number.isInteger(l)?.5:0))}t.value=r}updateNames(){let{dimensionWidgetList:e}=this,{position:{coordinateSpace:t}}=this,r=t.value,i=e.map(c=>c.nameElement.value);if(this.combiner.getRenameValidity(i).includes(!1))return!1;let a=r.names;if(xe(a,i))return!1;let o=r.timestamps.map((c,d)=>a[d]===i[d]?c:Date.now()),l={...r,names:i,timestamps:o};return t.value=l,!0}updateScales(){let{dimensionWidgetList:e}=this,{position:{coordinateSpace:t}}=this,r=t.value,i=e.map(h=>Go(h.scaleElement.value));if(i.includes(void 0))return!1;let a=Float64Array.from(i,h=>h.scale),o=Array.from(i,h=>h.unit),{scales:l,units:c}=r;if(xe(l,a)&&xe(c,o))return!1;let d=r.timestamps.map((h,g)=>a[g]===l[g]&&o[g]===c[g]?h:Date.now()),p=Oe({valid:r.valid,rank:r.rank,scales:a,units:o,timestamps:d,ids:r.ids,names:r.names,boundingBoxes:r.boundingBoxes,coordinateArrays:r.coordinateArrays});return t.value=p,!0}getPositionText(){let{position:e}=this;return e.valid?e.value.map(t=>Math.floor(t)).join(", "):""}updateView(){this.updateDimensions();let{position:{value:e},dimensionWidgetList:t}=this,r=t.length;if(e===void 0)return;let i=this.coordinateSpace;for(let a=0;a<r;++a){let o=t[a],l=o.coordinate,c=Math.floor(e[a]),d=c.toString();aV(l,d),l.value=d;let p=jg(i,a),h="";if(p!=null){let{coordinates:v}=p,b=HL(v,c,(x,C)=>x-C);b!==v.length&&(h=p.labels[b])}let g=o.coordinateLabel;g.textContent=h}}disposed(){this.closeDropdown(),et(this.element),super.disposed()}},KC=class extends H{constructor(e,t,r){super();this.element=e;this.mouseState=t;this.coordinateSpace=r;this.tempPosition=K.create();e.className="neuroglancer-mouse-position-widget";let i=this.registerCancellable(We(()=>this.updateView()));this.registerDisposer(t.changed.add(i)),this.registerDisposer(r.changed.add(i))}updateView(){let e="",{mouseState:t,coordinateSpace:{value:r}}=this;if(t.active&&r!==void 0){let i=t.position,{rank:a,names:o}=r;for(let l=0;l<a;++l)l!==0&&(e+="  "),e+=`${o[l]} ${Math.floor(i[l])}`}this.element.textContent=e}disposed(){et(this.element),super.disposed()}};function sV(n){return{makeControl:(e,t,r)=>{let{watchableValue:i,channelCoordinateSpaceCombiner:a,dataType:o,defaultChannel:l,histogramSpecifications:c,legendShaderOptions:d,histogramIndex:p}=n(e);if(a!==void 0&&l.length!==0){let g=t.registerDisposer(new qi(a.combined)),v=t.registerDisposer(new ws(g,a,{copyButton:!1}));t.registerDisposer(g.changed.add(()=>{let x=g.value,C=Array.from(x,P=>Math.floor(P)),T=i.value;xe(T.channel,C)||(i.value={...i.value,channel:C})}));let b=()=>{let x=g.value,C=i.value;xe(x,C.channel)||(x.set(C.channel),g.changed.dispatch())};b(),t.registerDisposer(i.changed.add(b)),r.labelContainer.appendChild(v.element)}let h=t.registerDisposer(new Og(r.visibility,r.display,o,i,c,p,l.length===0?d:void 0));return{control:h,controlElement:h.element}},activateTool:(e,t)=>{Ng(e,t)}}}function bo(n){return{makeControl:(e,t)=>{let r=n(e),i=t.registerDisposer(new zn(r));return{control:i,controlElement:i.element}},activateTool:(e,t)=>{t.model.value=!t.model.value}}}var A5=Ie.fromObject({"at:shift+wheel":{action:"adjust-hue-via-wheel"}});function Jg(n){return{makeControl:(e,t)=>{let r=n(e),i=t.registerDisposer(new Ul(r));return{control:i,controlElement:i.element}},activateTool:(e,t)=>{e.bindInputEventMap(A5),e.bindAction("adjust-via-wheel",r=>{r.stopPropagation(),r.preventDefault(),t.adjustHueViaWheel(r.detail)})}}}function lV(n){return{makeControl:(e,t,r)=>{let{watchableValue:i,properties:a,histogramSpecifications:o,legendShaderOptions:l,histogramIndex:c}=n(e);{let g=document.createElement("select");for(let[x,C]of a){let T=document.createElement("option");T.textContent=`${x} (${W[C].toLowerCase()})`,T.value=x,g.appendChild(T)}let v=()=>{let x=g.value,C=a.get(x),{window:T,range:P}=i.value;i.value={window:T!==void 0?kc(T,C):void 0,range:P!==void 0?kc(P,C):void 0,property:x,dataType:C}},b=()=>{g.value=i.value.property};t.registerEventListener(g,"change",v),t.registerDisposer(i.changed.add(b)),b(),r.labelContainer.appendChild(g)}let d={changed:i.changed,get value(){let{dataType:g,window:v,range:b}=i.value;return b===void 0&&(b=qr[g]),{window:lh(v!=null?v:b),range:b}},set value(g){let{window:v,range:b}=g;i.value={...i.value,window:v,range:b}}},p=Mt(g=>g.dataType,[i]),h=t.registerDisposer(new NC(r.visibility,r.display,p,d,o,c,l));return{control:h,controlElement:h.element}},activateTool:(e,t)=>{Ng(e,t)}}}var XC=class extends H{constructor(e,{min:t=0,max:r=1,step:i=.01}={}){super();this.value=e;this.element=document.createElement("label");this.inputElement=document.createElement("input");this.numericInputElement=document.createElement("input");let{element:a,inputElement:o,numericInputElement:l}=this;a.className="range-slider";let c=p=>{p.min=""+t,p.max=""+r,p.step=""+i,p.valueAsNumber=this.value.value,this.registerEventListener(p,"change",()=>this.inputValueChanged(p)),this.registerEventListener(p,"input",()=>this.inputValueChanged(p)),this.registerEventListener(p,"wheel",h=>{this.adjustViaWheel(p,h)})};o.type="range",c(o),l.type="number";let d=Math.max(t.toString().length,r.toString().length,Math.min(r,t+i).toString().length,Math.max(t,r-i).toString().length);l.style.width=d+2+"ch",c(l),a.appendChild(o),a.appendChild(l),e.changed.add(()=>{this.inputElement.valueAsNumber=this.value.value,this.numericInputElement.valueAsNumber=this.value.value})}inputValueChanged(e){this.value.value=e.valueAsNumber}adjustViaWheel(e,t){let r=this.inputElement,{deltaY:i}=t;i>0?(r.stepUp(),this.inputValueChanged(e)):i<0&&(r.stepDown(),this.inputValueChanged(e))}disposed(){et(this.element),super.disposed()}};var M5=Ie.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"}});function Qi(n){return{makeControl:(e,t)=>{let{value:r,options:i}=n(e),a=t.registerDisposer(new XC(r,i));return{control:a,controlElement:a.element}},activateTool:(e,t)=>{e.bindInputEventMap(M5),e.bindAction("adjust-via-wheel",r=>{r.stopPropagation(),r.preventDefault(),t.adjustViaWheel(t.inputElement,r.detail)})}}}function cV(n,e){let{shaderControlState:t}=n,r=t.state.get(e);if(r===void 0)return;let{control:i}=r;switch(i.type){case"slider":return Qi(()=>({value:r.trackable,options:{min:i.min,max:i.max,step:i.step}}));case"color":return Jg(()=>r.trackable);case"checkbox":return bo(()=>r.trackable);case"imageInvlerp":{let a=0;for(let[o,{control:{type:l}}]of t.state){if(o===e)break;l==="imageInvlerp"&&++a}return sV(()=>({dataType:i.dataType,defaultChannel:i.default.channel,watchableValue:r.trackable,channelCoordinateSpaceCombiner:t.channelCoordinateSpaceCombiner,histogramSpecifications:t.histogramSpecifications,histogramIndex:a,legendShaderOptions:n.legendShaderOptions}))}case"propertyInvlerp":{let a=0;for(let[o,{control:{type:l}}]of t.state){if(o===e)break;l==="propertyInvlerp"&&++a}return lV(()=>({properties:i.properties,watchableValue:r.trackable,histogramSpecifications:t.histogramSpecifications,histogramIndex:a,legendShaderOptions:n.legendShaderOptions}))}}}function uV(n,e,t){return{label:t,toolJson:R5(t,e),makeControl:(r,i,a)=>{let o=n(r);return cV(o,t).makeControl(r,i,a)},activateTool:(r,i)=>{let a=n(r.tool.layer);return cV(a,t).activateTool(r,i)}}}var xo=class extends Nt{constructor(e,t,r,i={}){super(i.visibility);this.state=e;this.display=t;this.layer=r;this.options=i;this.controlDisposer=void 0;let{toolId:a=dV}=i;this.toolId=a;let{element:o}=this;o.style.display="contents";let{controls:l}=e;this.registerDisposer(l.changed.add(this.registerCancellable((0,QC.default)(()=>this.updateControls(),0)))),this.updateControls()}updateControls(){let{element:e}=this;this.controlDisposer!==void 0&&(this.controlDisposer.dispose(),Me(e));let t=this.controlDisposer=new H,r=()=>({shaderControlState:this.state,legendShaderOptions:this.options.legendShaderOptions});for(let i of this.state.state.keys())e.appendChild(fu(t,this.layer,this.visibility,uV(r,this.toolId,i)))}disposed(){var e;(e=this.controlDisposer)==null||e.dispose(),super.disposed()}},dV="shaderControl",pV="control";function R5(n,e){return{type:e,[pV]:n}}var fV=class extends zg{constructor(e,t,r,i){super(e,uV(()=>t,r,i));this.layerShaderControls=t;this.control=i;this.registerDisposer(t.shaderControlState.controls.changed.add(this.registerCancellable((0,QC.default)(()=>{t.shaderControlState.state.get(i)===void 0&&this.unbind()}))))}activate(e){let{shaderControlState:t}=this.layerShaderControls;t.state.get(this.control)!==void 0&&super.activate(e)}};function Ts(n,e,t=dV){Si(n,t,(r,i)=>{let a=U(i,pV,Z);return new fV(r,e(r),t,a)})}function hV(n){return new So({fragmentMain:n.displayState.skeletonRenderingOptions.shader,shaderError:n.displayState.shaderError,shaderControlState:n.displayState.skeletonRenderingOptions.shaderControlState})}var ZC=class extends Nt{constructor(e){super();this.layer=e;let{element:t}=this;t.classList.add("neuroglancer-segmentation-rendering-tab");{let i=this.registerDisposer(new $g(e.displayState.linkedSegmentationGroup));i.label.textContent="Linked to: ",t.appendChild(i.element)}{let i=this.registerDisposer(new $g(e.displayState.linkedSegmentationColorGroup));i.label.textContent="Colors linked to: ",t.appendChild(i.element)}for(let i of tw)t.appendChild(fu(this,e,this.visibility,i));let r=this.registerDisposer(new Ln(e.hasSkeletonsLayer,(i,a,o)=>{if(!i)return;let l=document.createElement("div");l.className="neuroglancer-segmentation-dropdown-skeleton-shader-header";let c=document.createElement("div");c.style.flex="1",c.textContent="Skeleton shader:",l.appendChild(c),l.appendChild(xs({title:"Show larger editor view",onClick:()=>{new mV(this.layer)}})),l.appendChild(bs({title:"Documentation on skeleton rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/sliceview/image_layer_rendering.md"})),a.appendChild(l);let d=o.registerDisposer(hV(this.layer));a.appendChild(d.element),a.appendChild(o.registerDisposer(new xo(e.displayState.skeletonRenderingOptions.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility,toolId:ew})).element),d.textEditor.refresh()},this.visibility));t.appendChild(r.element)}},mV=class extends Xi{constructor(e){super();this.layer=e;this.codeWidget=this.registerDisposer(hV(this.layer));this.content.classList.add("neuroglancer-segmentation-layer-skeleton-shader-overlay"),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}};var Ls=class extends Za{constructor(){super(...arguments);this.hashTable=new jc;this.changed=new $e}get value(){return this}static makeWithCounterpart(e){let t=new Ls;return t.initializeCounterpart(e),t}set_(e,t){return this.hashTable.set(e,t)}set(e,t){if(this.set_(e,t)){let{rpc:r}=this;r&&r.invoke("Uint64Map.set",{id:this.rpcId,key:e,value:t}),this.changed.dispatch(e,!0)}}has(e){return this.hashTable.has(e)}get(e,t){return this.hashTable.get(e,t)}[Symbol.iterator](){return this.hashTable.entries()}unsafeEntries(){return this.hashTable.unsafeEntries()}delete_(e){return this.hashTable.delete(e)}delete(e){if(this.delete_(e)){let{rpc:t}=this;t&&t.invoke("Uint64Map.delete",{id:this.rpcId,key:e}),this.changed.dispatch(e,!1)}}get size(){return this.hashTable.size}assignFrom(e){this.clear();for(let[t,r]of e.unsafeEntries())this.set(t,r)}clear(){if(this.hashTable.clear()){let{rpc:e}=this;e&&e.invoke("Uint64Map.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){let e={};for(let[t,r]of this.hashTable.unsafeEntries())e[t.toString()]=r.toString();return e}};Ls=Pt([Ho("Uint64Map")],Ls);Lt("Uint64Map.set",function(n){let e=this.get(n.id);e.set_(n.key,n.value)&&e.changed.dispatch()});Lt("Uint64Map.delete",function(n){let e=this.get(n.id);e.delete_(n.key)&&e.changed.dispatch()});Lt("Uint64Map.clear",function(n){let e=this.get(n.id);e.hashTable.clear()&&e.changed.dispatch()});var ks=class extends Za{constructor(){super(...arguments);this.hashTable=new am;this.changed=new $e}get value(){return this}static makeWithCounterpart(e){let t=new ks;return t.initializeCounterpart(e),t}set(e,t){t?this.add(e):this.delete(e)}reserve_(e){return this.hashTable.reserve(e)}reserve(e){if(this.reserve_(e)){let{rpc:t}=this;t&&t.invoke("Uint64Set.reserve",{id:this.rpcId,value:e})}}add_(e){let t=!1;for(let r of e)t=this.hashTable.add(r)||t;return t}add(e){let t=Array().concat(e);if(this.add_(t)){let{rpc:r}=this;r&&r.invoke("Uint64Set.add",{id:this.rpcId,value:t}),this.changed.dispatch(e,!0)}}has(e){return this.hashTable.has(e)}[Symbol.iterator](){return this.hashTable.keys()}unsafeKeys(){return this.hashTable.unsafeKeys()}delete_(e){let t=!1;for(let r of e)t=this.hashTable.delete(r)||t;return t}delete(e){let t=Array().concat(e);if(this.delete_(Array().concat(e))){let{rpc:r}=this;r&&r.invoke("Uint64Set.delete",{id:this.rpcId,value:t}),this.changed.dispatch(e,!1)}}get size(){return this.hashTable.size}clear(){if(this.hashTable.clear()){let{rpc:e}=this;e&&e.invoke("Uint64Set.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){let e=new Array;for(let t of this.unsafeKeys())e.push(t.toString());return e.sort(),e}assignFrom(e){this.clear();for(let t of e.unsafeKeys())this.add(t)}};ks=Pt([Ho("Uint64Set")],ks);Lt("Uint64Set.reserve",function(n){let e=this.get(n.id);e.reserve_(n.value)&&e.changed.dispatch()});Lt("Uint64Set.add",function(n){let e=this.get(n.id);e.add_(n.value)&&e.changed.dispatch()});Lt("Uint64Set.delete",function(n){let e=this.get(n.id);e.delete_(n.value)&&e.changed.dispatch()});Lt("Uint64Set.clear",function(n){let e=this.get(n.id);e.hashTable.clear()&&e.changed.dispatch()});var Up=class extends H{constructor(e){super();this.model=e;this.element=document.createElement("select");this.valueIndexMap=new Map;let{element:t,valueIndexMap:r}=this,i=0;for(let a of Object.keys(e.enumType))if(isNaN(Number(a))){let o=document.createElement("option");o.textContent=o.value=a.toLowerCase(),t.appendChild(o),r.set(e.enumType[a],i),++i}this.registerDisposer(e.changed.add(()=>this.updateView())),this.registerEventListener(t,"change",()=>this.updateModel()),this.registerEventListener(t,"wheel",a=>{a.preventDefault(),a.stopPropagation(),this.adjustViaWheel(a)}),this.updateView()}adjustViaWheel(e){let{element:t}=this,{deltaY:r}=e;r>0?(t.selectedIndex=(t.options.length+t.selectedIndex-1)%t.options.length,this.updateModel()):r<0&&(t.selectedIndex=(t.options.length+t.selectedIndex+1)%t.options.length,this.updateModel())}updateView(){let{element:e}=this;e.selectedIndex=this.valueIndexMap.get(this.model.value)}updateModel(){this.model.restoreState(this.element.value)}};var _5=Ie.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"}});function qg(n){return{makeControl:(e,t)=>{let r=n(e),i=t.registerDisposer(new Up(r));return{control:i,controlElement:i.element}},activateTool:(e,t)=>{e.bindInputEventMap(_5),e.bindAction("adjust-via-wheel",r=>{r.stopPropagation(),r.preventDefault(),t.adjustViaWheel(r.detail)})}}}var gV=Ye(gt()),yV=Ye(Ml());function Yg(n,e){let t="";for(let r=0;r<=e&&(t=n.toFixed(r),parseFloat(t)!==n);++r);return t}var V5=200,vV=Ie.fromObject({mousedown0:{action:"set"},wheel:{action:"adjust-via-wheel"},dblclick0:{action:"reset"}});function O5(n){if(n<1||n>1024){let e=Math.log2(n)|0,t=n/2**e;return`${Yg(t,1)}p${e}`}return Math.round(n)+""}var Gp=class extends H{constructor(e,t){super();this.histogram=e;this.target=t;this.label=document.createElement("div");this.element=document.createElement("div");this.canvas=document.createElement("canvas");this.legend=document.createElement("div");this.legendRenderScale=document.createElement("div");this.legendSpatialScale=document.createElement("div");this.legendChunks=document.createElement("div");this.ctx=this.canvas.getContext("2d");this.hoverTarget=new ke(void 0);this.throttledUpdateView=this.registerCancellable((0,yV.default)(()=>this.debouncedUpdateView(),V5,{leading:!0,trailing:!0}));this.debouncedUpdateView=this.registerCancellable((0,gV.default)(()=>this.updateView(),0));let{canvas:r,label:i,element:a,legend:o,legendRenderScale:l,legendSpatialScale:c,legendChunks:d}=this;i.className="neuroglancer-render-scale-widget-prompt",a.className="neuroglancer-render-scale-widget",a.title=vV.describe(),o.className="neuroglancer-render-scale-widget-legend",a.appendChild(i),a.appendChild(r),a.appendChild(o),l.title="Target resolution of data in screen pixels",d.title="Number of chunks rendered",o.appendChild(l),o.appendChild(d),o.appendChild(c),this.registerDisposer(e.changed.add(this.throttledUpdateView)),this.registerDisposer(e.visibility.changed.add(this.debouncedUpdateView)),this.registerDisposer(t.changed.add(this.debouncedUpdateView)),this.registerDisposer(new kn(r,vV)),this.registerDisposer(t.changed.add(this.debouncedUpdateView)),this.registerDisposer(this.hoverTarget.changed.add(this.debouncedUpdateView));let p=g=>{let v=g.offsetX/r.width*ln;return i1(v)};this.registerEventListener(r,"pointermove",g=>{this.hoverTarget.value=[p(g),g.offsetY]}),this.registerEventListener(r,"pointerleave",()=>{this.hoverTarget.value=void 0}),this.registerDisposer(ce(r,"set",g=>{this.target.value=p(g.detail)})),this.registerDisposer(ce(r,"adjust-via-wheel",g=>{this.adjustViaWheel(g.detail)})),this.registerDisposer(ce(r,"reset",g=>{this.reset(),g.preventDefault()}));let h=new ResizeObserver(()=>this.debouncedUpdateView());h.observe(r),this.registerDisposer(()=>h.disconnect()),this.updateView()}adjustViaWheel(e){let{deltaY:t}=e;t!==0&&(this.hoverTarget.value=void 0,this.target.value*=2**Math.sign(t),e.preventDefault())}reset(){this.hoverTarget.value=void 0,this.target.reset()}updateView(){let{ctx:e}=this,{canvas:t}=this,r=t.width=t.offsetWidth,i=t.height=t.offsetHeight,a=this.target.value,o=this.hoverTarget.value;{let{legendRenderScale:E}=this,V=o===void 0?a:o[0],O=O5(V);E.textContent=O+" px"}function l(E){return E*r/ln}e.clearRect(0,0,r,i);let{histogram:c}=this,{value:d,spatialScales:p}=c;c.visibility.visible||d.fill(0);let h=Array.from(p.keys());h.sort();let g=K.create(),v=1,b=p.size,x=0,C=0;for(let E=0;E<ln;++E){let V=0;for(let O=0;O<b;++O){let B=O*ln*2+E,z=d[B],_=d[B+ln];x+=z,C+=_,V+=z+_}v=Math.max(V,v)}let P=i/Math.log(1+v);function I(E){return i-Math.log(1+E)*P}let M;if(o!==void 0){let E=Math.floor(Jd(o[0]));if(E>=0&&E<ln){let V=0,O=o[1];for(let B=b-1;B>=0;--B){let z=h[B],_=p.get(z),F=2*_*ln+E,N=d[F]+d[F+ln];if(N===0)continue;let J=Math.round(I(V));if(V+=N,Math.round(I(V))<=O&&O<=J){M=z;break}}}}if(M!==void 0){x=0,C=0;let E=p.get(M),V=2*E*ln;for(let O=0;O<ln;++O){let B=V+O;x+=d[B],C+=d[B+ln]}Number.isFinite(M)?this.legendSpatialScale.textContent=Ri(M,"m",{precision:2,elide1:!1}):this.legendSpatialScale.textContent="unknown"}else this.legendSpatialScale.textContent="";this.legendChunks.textContent=`${x}/${x+C}`;let D=h.map(E=>{let V=E===M?.5:1,O;Number.isFinite(E)?O=(Math.log2(E)*.1%1+1)%1:O=0,bl(g,O,V,1);let B=Sn(g);bl(g,O,V,.5);let z=Sn(g);return[B,z]});for(let E=0;E<ln;++E){let V=0;for(let O=b-1;O>=0;--O){let B=h[O],_=p.get(B)*ln*2+E,F=d[_],N=d[_+ln],J=F+N;if(J===0)continue;let ae=Math.round(l(E)),pe=Math.round(l(E+1)),me=Math.round(I(V));V+=J;let Ae=Math.round(I(V)),le=(F*Ae+N*me)/J;e.fillStyle=D[O][1],e.fillRect(ae,Ae,pe-ae,le-Ae),e.fillStyle=D[O][0],e.fillRect(ae,le,pe-ae,me-le)}}{let E=a;e.fillStyle="#fff";let V=l(Jd(E)),O=1;e.fillRect(Math.floor(V),0,O,i)}if(o!==void 0){let E=o[0];e.fillStyle="#888";let V=l(Jd(E)),O=1;e.fillRect(Math.floor(V),0,O,i)}}},N5=Ie.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"},"at:shift+dblclick0":{action:"reset"}});function hu(n){return{makeControl:(e,t)=>{let{histogram:r,target:i}=n(e),a=t.registerDisposer(new Gp(r,i));return{control:a,controlElement:a.element}},activateTool:(e,t)=>{e.bindInputEventMap(N5),e.bindAction("adjust-via-wheel",r=>{r.stopPropagation(),r.preventDefault(),t.adjustViaWheel(r.detail)}),e.bindAction("reset",r=>{r.stopPropagation(),r.preventDefault(),t.reset()})}}}var SV='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="rotateIconTitle"><path d="M22 12l-3 3-3-3"></path><path d="M2 12l3-3 3 3"></path><path d="M19.016 14v-1.95A7.05 7.05 0 0 0 8 6.22"></path><path d="M16.016 17.845A7.05 7.05 0 0 1 5 12.015V10"></path><path stroke-linecap="round" d="M5 10V9"></path><path stroke-linecap="round" d="M19 15v-1"></path></svg>';var Wp=class extends H{constructor(e){super();this.model=e;this.element=document.createElement("input");this.registerDisposer(e.changed.add(()=>this.updateView()));let{element:t}=this;t.type="text",this.registerEventListener(t,"change",()=>this.updateModel()),this.updateView()}disposed(){et(this.element)}updateView(){var e;this.element.value=((e=this.model.value)!=null?e:"")+""}updateModel(){try{this.model.restoreState(this.element.value)}catch{}this.updateView()}};function Kg(n,e){e?n.displayState.segmentDefaultColor.value=K.fromValues(1,0,0):n.displayState.segmentDefaultColor.value=void 0}function bV(){let n=e=>{e.displayState.segmentationColorGroupState.value.segmentColorHash.randomize()};return{makeControl:(e,t,{labelTextContainer:r})=>{let i=document.createElement("input");i.type="radio",i.addEventListener("change",()=>{Kg(e,!i.checked)}),r.prepend(i);let a=document.createElement("div");a.classList.add("neuroglancer-segmentation-color-seed-control");let o=t.registerDisposer(new Wp(e.displayState.segmentColorHash));a.appendChild(o.element);let l=He({svg:SV,title:"Randomize",onClick:()=>n(e)});return a.appendChild(l),t.registerDisposer(Ir(c=>{let d=c===void 0;a.style.visibility=d?"":"hidden",i.checked=d},e.displayState.segmentDefaultColor)),{controlElement:a,control:o}},activateTool:e=>{let{layer:t}=e.tool;Kg(t,!1),n(t)}}}function xV(){let n=Jg(e=>e.displayState.segmentDefaultColor);return{...n,makeControl:(e,t,r)=>{let i=n.makeControl(e,t,r),{controlElement:a}=i,o=document.createElement("input");return o.type="radio",o.addEventListener("change",()=>{Kg(e,o.checked),o.checked&&a.click()}),r.labelTextContainer.prepend(o),t.registerDisposer(Ir(l=>{let c=l!==void 0;a.style.visibility=c?"":"hidden",o.checked=c},e.displayState.segmentDefaultColor)),i},activateTool:(e,t)=>{Kg(e.tool.layer,!0),n.activateTool(e,t)}}}var nw=class extends jn{constructor(){super();this.changed=new ne;this.set_color_val=new Ce("",Z,"");this.clNeuronColor=new Ce("",Z,"");this.clClearBeforeLoad=new Xe(!1,!1);this.clAlsoLoadNeurons=new Xe(!1,!1);this.state={set_color_val:this.set_color_val,clNeuronColor:this.clNeuronColor,clClearBeforeLoad:this.clClearBeforeLoad,clAlsoLoadNeurons:this.clAlsoLoadNeurons};super.add("set_color_val",this.state.set_color_val),super.add("clNeuronColor",this.state.clNeuronColor),super.add("clClearBeforeLoad",this.state.clClearBeforeLoad),super.add("clAlsoLoadNeurons",this.state.clAlsoLoadNeurons)}reset(){super.reset()}toJSON(){return super.toJSON()}restoreState(e){if(e!=null)try{this.state=e,super.restoreState(this.state),this.changed.dispatch()}catch(t){this.reset()}}};var rw=class extends H{constructor(e,t,r,i={}){super();this.model=e;this.element=document.createElement("label");this.inputElement=document.createElement("textarea");let{validator:a,label:o}=i,{element:l,inputElement:c}=this;a===void 0&&(e instanceof Ce?a=e.validator:a=d=>d),this.validator=a,o!==void 0&&(l.textContent=o),l.appendChild(c),l.className="neuroglancer-string-input",c.rows=t,c.cols=r,this.registerDisposer(this.model.changed.add(()=>this.updateView())),this.registerEventListener(c,"change",()=>this.updateModel()),this.updateView()}updateView(){this.inputElement.value=""+this.model.value}updateModel(){let e=this.inputElement.value.trim();if(typeof e!="string"){this.updateView();return}try{e=this.validator(e),this.model.value=e}catch{this.updateView()}}disposed(){et(this.element),super.disposed()}};var Wl=class extends Nt{constructor(e){super();this.model=e}addButton(e,t,r,i){let a=document.createElement("br"),o=e,l=document.createElement("DIV");l.setAttribute("align","right"),o.type=r,o.name=t,o.value=t,o.textContent=t,o.title=t,l.appendChild(o),l.appendChild(a),l.appendChild(a),this.element.appendChild(l),i&&(o.id=i),o.addEventListener("mousedown",()=>{document.dispatchEvent(new Event(o.id))})}addCheckbox(e,t){let r=document.createElement("br"),i=document.createElement("DIV");i.setAttribute("align","right");let a=document.createElement("label");a.textContent=e;let o=this.registerDisposer(new zn(t));a.appendChild(o.element),i.appendChild(a),i.appendChild(r),i.appendChild(r),this.element.appendChild(i)}addTextArea(e,t,r=1,i=24){let a=document.createElement("DIV");a.setAttribute("align","right");let o=document.createElement("H3");o.textContent=e,o.style.padding="0",o.style.margin="0";let l=this.registerDisposer(new rw(t,r,i));a.appendChild(o),a.appendChild(l.element),this.element.appendChild(a)}};var iw=class extends Wl{constructor(e){super(e);this.transform=e;this.clSetVal=document.createElement("input");this.clClear=document.createElement("input");this.clNeuronColorButton=document.createElement("input");let{element:t}=this;t.classList.add("neuroglancer-Color-widget"),this.addTextArea("Color value",e.set_color_val),this.addButton(this.clSetVal,"Set color to selections","button","clSetVal"),this.addButton(this.clClear,"Clear colors","button","clClear"),this.addTextArea("Neuron color mapping",e.clNeuronColor,14,28),this.addButton(this.clNeuronColorButton,"Set color","button","clNeuronColorButton"),this.addCheckbox("Also load neurons",e.clAlsoLoadNeurons),this.addCheckbox("Clear segments before load",e.clClearBeforeLoad)}};var CV="Colors",wV="colors";function TV(n){class e extends n{constructor(...r){super(...r);this.cl=new nw;this.cl.changed.add(this.specificationChanged.dispatch),this.tabs.add(CV,{label:CV,order:100,getter:()=>new iw(this.cl)})}restoreState(r){super.restoreState(r),this.cl.restoreState(r[wV])}toJSON(){let r=super.toJSON();return r[wV]=this.cl.toJSON(),r}}return e}var aw=class extends jn{constructor(){super();this.changed=new ne;this.dbNeuronPrefix=new Ce("",Z,"");this.dbFindAnnotator=new Ce("",Z,"");this.dbFindType=new Ce("",Z,"");this.dbFindTags=new Ce("",Z,"");this.dbFindFinished=new Xe(!1,!1);this.dbFindReviewed=new Xe(!1,!1);this.dbFindResult=new Ce("",Z,"");this.dbLoadNeuronName=new Ce("",Z,"");this.dbLoadNeuronName1=new Ce("",Z,"");this.dbLoadNeuronName2=new Ce("",Z,"");this.dbLoadNeuronName3=new Ce("",Z,"");this.dbLoadWithoutChildren=new Xe(!1,!1);this.state={dbNeuronPrefix:this.dbNeuronPrefix,dbFindAnnotator:this.dbFindAnnotator,dbFindType:this.dbFindType,dbFindTags:this.dbFindTags,dbFindFinished:this.dbFindFinished,dbFindReviewed:this.dbFindReviewed,dbFindResult:this.dbFindResult,dbLoadNeuronName:this.dbLoadNeuronName,dbLoadNeuronName1:this.dbLoadNeuronName1,dbLoadNeuronName2:this.dbLoadNeuronName2,dbLoadNeuronName3:this.dbLoadNeuronName3,dbLoadWithoutChildren:this.dbLoadWithoutChildren};super.add("dbNeuronPrefix",this.dbNeuronPrefix),super.add("dbFindAnnotator",this.dbFindAnnotator),super.add("dbFindType",this.dbFindType),super.add("dbFindTags",this.dbFindTags),super.add("dbFindFinished",this.dbFindFinished),super.add("dbFindReviewed",this.dbFindReviewed),super.add("dbFindResult",this.dbFindResult),super.add("dbLoadNeuronName",this.dbLoadNeuronName),super.add("dbLoadNeuronName1",this.dbLoadNeuronName1),super.add("dbLoadNeuronName2",this.dbLoadNeuronName2),super.add("dbLoadNeuronName3",this.dbLoadNeuronName3),super.add("dbLoadWithoutChildren",this.dbLoadWithoutChildren)}reset(){super.reset()}toJSON(){return super.toJSON()}restoreState(e){if(e!=null)try{this.state=e,super.restoreState(this.state),this.changed.dispatch()}catch(t){this.reset()}}};var ow=class extends Wl{constructor(e){super(e);this.transform=e;this.dbSearchButton=document.createElement("input");this.dbLoadNeuronNameButton=document.createElement("input");this.dbLoadNeuronNameButton1=document.createElement("input");this.dbLoadNeuronNameButton2=document.createElement("input");this.dbLoadNeuronNameButton3=document.createElement("input");let{element:t}=this;t.classList.add("neuroglancer-Proofread-widget"),this.addTextArea("Prefix",e.dbNeuronPrefix),this.addTextArea("Annotator",e.dbFindAnnotator),this.addTextArea("Type",e.dbFindType),this.addTextArea("Tags",e.dbFindTags),this.addCheckbox("Finished",e.dbFindFinished),this.addCheckbox("Reviewed",e.dbFindReviewed),this.addButton(this.dbSearchButton,"Search","button","dbSearchButton"),this.addTextArea("Result",e.dbFindResult,14,28),this.addTextArea("Load Neuron",e.dbLoadNeuronName),this.addButton(this.dbLoadNeuronNameButton,"Load","button","dbLoadNeuronNameButton"),this.addTextArea("",e.dbLoadNeuronName1),this.addButton(this.dbLoadNeuronNameButton1,"Load","button","dbLoadNeuronNameButton1"),this.addTextArea("",e.dbLoadNeuronName2),this.addButton(this.dbLoadNeuronNameButton2,"Load","button","dbLoadNeuronNameButton2"),this.addTextArea("",e.dbLoadNeuronName3),this.addButton(this.dbLoadNeuronNameButton3,"Load","button","dbLoadNeuronNameButton3"),this.addCheckbox("Load without children",e.dbLoadWithoutChildren)}};var LV="neurondb",kV="Search DB";function EV(n){class e extends n{constructor(...r){super(...r);this.sr=new aw;this.sr.changed.add(this.specificationChanged.dispatch),this.tabs.add(kV,{label:kV,order:100,getter:()=>new ow(this.sr)})}restoreState(r){super.restoreState(r),this.sr.restoreState(r[LV])}toJSON(){let r=super.toJSON();return r[LV]=this.sr.toJSON(),r}}return e}var sw=class extends jn{constructor(){super();this.changed=new ne;this.prNeuronName=new Ce("",Z,"");this.prCellType=new Ce("",Z,"");this.prTags=new Ce("",Z,"");this.prLocTags=new Ce("",Z,"");this.prUncertainCon=new Ce("",Z,"");this.prMergers=new Ce("",Z,"");this.prAnnotator=new Ce("",Z,"");this.prNotes=new Ce("",Z,"");this.prFinished=new Xe(!1,!1);this.prReviewed=new Xe(!1,!1);this.prSomaLoc=new Ce("",Z,"");this.prOverrideSuperSetCheck=new Xe(!1,!1);this.prOverrideConflictCheck=new Xe(!1,!1);this.prGrowThreshold=new Ce("",Z,"");this.prSuperGrowThreshold=new Ce("",Z,"");this.state={prNeuronName:this.prNeuronName,prCellType:this.prCellType,prTags:this.prTags,prLocTags:this.prLocTags,prUncertainCon:this.prUncertainCon,prMergers:this.prMergers,prAnnotator:this.prAnnotator,prNotes:this.prNotes,prFinished:this.prFinished,prReviewed:this.prReviewed,prSomaLoc:this.prSomaLoc,prOverrideSuperSetCheck:this.prOverrideSuperSetCheck,prOverrideConflictCheck:this.prOverrideConflictCheck,prGrowThreshold:this.prGrowThreshold,prSuperGrowThreshold:this.prSuperGrowThreshold};super.add("prNeuronName",this.prNeuronName),super.add("prCellType",this.prCellType),super.add("prTags",this.prTags),super.add("prLocTags",this.prLocTags),super.add("prUncertainCon",this.prUncertainCon),super.add("prMergers",this.prMergers),super.add("prAnnotator",this.prAnnotator),super.add("prNotes",this.prNotes),super.add("prFinished",this.prFinished),super.add("prReviewed",this.prReviewed),super.add("prSomaLoc",this.prSomaLoc),super.add("prOverrideSuperSetCheck",this.prOverrideSuperSetCheck),super.add("prOverrideConflictCheck",this.prOverrideConflictCheck),super.add("prGrowThreshold",this.prGrowThreshold),super.add("prSuperGrowThreshold",this.prSuperGrowThreshold)}reset(){super.reset()}toJSON(){return super.toJSON()}restoreState(e){if(e!=null)try{this.state=e,super.restoreState(this.state),this.changed.dispatch()}catch(t){this.reset()}}};var lw=class extends Wl{constructor(e){super(e);this.transform=e;this.prSomaLocCopyLoc=document.createElement("input");this.prSaveNeuron=document.createElement("input");let{element:t}=this;t.classList.add("neuroglancer-Proofread-widget"),this.addTextArea("Neuron Name",e.prNeuronName,2),this.addTextArea("Cell Type",e.prCellType),this.addTextArea("Tags",e.prTags),this.addTextArea("Location Tags",e.prLocTags,2),this.addTextArea("Uncertain Continuation",e.prUncertainCon,4),this.addTextArea("Merge Locations",e.prMergers,4),this.addTextArea("Notes",e.prNotes,8,28),this.addTextArea("Grow Threshold",e.prGrowThreshold),this.addTextArea("Super Grow Threshold",e.prSuperGrowThreshold),this.addCheckbox("Finished",e.prFinished),this.addCheckbox("Reviewed",e.prReviewed),this.addTextArea("Soma Location",e.prSomaLoc),this.addButton(this.prSomaLocCopyLoc,"Copy Location","button","prSomaLocCopyLoc"),this.addCheckbox("Override Set Check",e.prOverrideSuperSetCheck),this.addCheckbox("Override Conflict Check",e.prOverrideConflictCheck),this.addTextArea("Annotator",e.prAnnotator),this.addButton(this.prSaveNeuron,"Save Neuron","button","prSaveNeuron")}};var DV="Proofread",PV="pr";function IV(n){class e extends n{constructor(...r){super(...r);this.pr=new sw;this.pr.changed.add(this.specificationChanged.dispatch),this.tabs.add(DV,{label:DV,order:100,getter:()=>new lw(this.pr)})}restoreState(r){super.restoreState(r),this.pr.restoreState(r[PV])}toJSON(){let r=super.toJSON();return r[PV]=this.pr.toJSON(),r}}return e}var cw="selectedAlpha",uw="notSelectedAlpha",dw="objectAlpha",pw="saturation",fw="hoverHighlight",hw="hideSegmentZero",mw="baseSegmentColoring",gw="ignoreNullVisibleSet",B5="mesh",F5="skeletons",AV="segments",Xg="equivalences",yw="colorSeed",MV="segmentColors",vw="meshRenderScale",Sw="crossSectionRenderScale",Qg="skeletonRendering",U5="skeletonShader",RV="segmentQuery",bw="meshSilhouetteRendering",_V="linkedSegmentationGroup",VV="linkedSegmentationColorGroup",xw="segmentDefaultColor",OV="anchorSegment",ew="skeletonShaderControl",NV=class extends H{constructor(e){super();this.layer=e;this.specificationChanged=new $e;this.localGraph=new mC;this.visibleSegments=this.registerDisposer(ks.makeWithCounterpart(this.layer.manager.rpc));this.segmentPropertyMap=new ke(void 0);this.graph=new ke(void 0);this.segmentEquivalences=this.registerDisposer(Va.makeWithCounterpart(this.layer.manager.rpc,this.layer.registerDisposer(Mt(e=>e&&e.visibleSegmentEquivalencePolicy||Kt.MIN_REPRESENTATIVE,[this.graph]))));this.localSegmentEquivalences=!1;this.maxIdLength=new ke(1);this.hideSegmentZero=new Xe(!0,!0);this.segmentQuery=new Ce("",Z);this.temporaryVisibleSegments=this.layer.registerDisposer(ks.makeWithCounterpart(this.layer.manager.rpc));this.temporarySegmentEquivalences=this.layer.registerDisposer(Va.makeWithCounterpart(this.layer.manager.rpc,this.segmentEquivalences.disjointSets.visibleSegmentEquivalencePolicy));this.useTemporaryVisibleSegments=this.layer.registerDisposer(bt.make(this.layer.manager.rpc,!1));this.useTemporarySegmentEquivalences=this.layer.registerDisposer(bt.make(this.layer.manager.rpc,!1));let{specificationChanged:t}=this;this.visibleSegments.changed.add(t.dispatch),this.hideSegmentZero.changed.add(t.dispatch),this.segmentQuery.changed.add(t.dispatch)}restoreState(e){ie(e,hw,t=>this.hideSegmentZero.restoreState(t)),ie(e,Xg,t=>{this.localGraph.restoreState(t)}),ie(e,AV,t=>{let{segmentEquivalences:r,visibleSegments:i}=this;ge(t,a=>{let o=X.parseString(String(a),10);i.add(r.get(o))})}),ie(e,RV,t=>this.segmentQuery.restoreState(t))}toJSON(){let e={};e[hw]=this.hideSegmentZero.toJSON();let{visibleSegments:t}=this;t.size>0&&(e[AV]=t.toJSON());let{segmentEquivalences:r}=this;return this.localSegmentEquivalences&&r.size>0&&(e[Xg]=r.toJSON()),e[RV]=this.segmentQuery.toJSON(),e}assignFrom(e){this.maxIdLength.value=e.maxIdLength.value,this.hideSegmentZero.value=e.hideSegmentZero.value,this.visibleSegments.assignFrom(e.visibleSegments),this.segmentEquivalences.assignFrom(e.segmentEquivalences)}},BV=class extends H{constructor(e){super();this.layer=e;this.specificationChanged=new $e;this.segmentColorHash=ep.getDefault();this.segmentStatedColors=this.registerDisposer(new Ls);this.tempSegmentStatedColors2d=this.registerDisposer(new Ls);this.segmentDefaultColor=new Hv;this.tempSegmentDefaultColor2d=new ke(void 0);this.highlightColor=new ke(void 0);let{specificationChanged:t}=this;this.segmentColorHash.changed.add(t.dispatch),this.segmentStatedColors.changed.add(t.dispatch),this.tempSegmentStatedColors2d.changed.add(t.dispatch),this.segmentDefaultColor.changed.add(t.dispatch),this.tempSegmentDefaultColor2d.changed.add(t.dispatch),this.highlightColor.changed.add(t.dispatch)}restoreState(e){ie(e,yw,t=>this.segmentColorHash.restoreState(t)),ie(e,xw,t=>this.segmentDefaultColor.restoreState(t)),ie(e,MV,t=>{let r=Ii(t,i=>fa(String(i)));for(let[i,a]of r){let o=X.parseString(String(i)),l=new X(Ja(a));this.segmentStatedColors.set(o,l)}})}toJSON(){let e={};e[yw]=this.segmentColorHash.toJSON(),e[xw]=this.segmentDefaultColor.toJSON();let{segmentStatedColors:t}=this;if(t.size>0){let r=e[MV]={};for(let[i,a]of t.unsafeEntries())r[i.toString()]=Sn(qa(a.low))}return e}assignFrom(e){this.segmentColorHash.value=e.segmentColorHash.value,this.segmentStatedColors.assignFrom(e.segmentStatedColors),this.tempSegmentStatedColors2d.assignFrom(e.tempSegmentStatedColors2d),this.segmentDefaultColor.value=e.segmentDefaultColor.value,this.highlightColor.value=e.highlightColor.value}},Cw=class extends H{constructor(e,t){super();this.linkedGroup=e;this.propertyName=t;this.value}get changed(){return this.linkedGroup.root.changed}get value(){let e=this.linkedGroup.root.value;if(e!==this.curRoot){this.curRoot=e;let t=e.displayState[this.propertyName];if(e===this.linkedGroup.layer){let{curGroupState:r}=this;r!==void 0&&(t.assignFrom(r),r.dispose())}this.curGroupState=t.addRef()}return this.curGroupState}disposed(){var e;(e=this.curGroupState)==null||e.dispose()}},FV=class{constructor(e){this.layer=e;this.segmentSelectionState=new Fb;this.selectedAlpha=Bl(.5);this.saturation=Bl(1);this.notSelectedAlpha=Bl(0);this.hoverHighlight=new Xe(!0,!0);this.silhouetteRendering=new Ce(0,nh,0);this.objectAlpha=Bl(1);this.ignoreNullVisibleSet=new Xe(!0,!0);this.skeletonRenderingOptions=new Kb;this.shaderError=ga();this.renderScaleHistogram=new La;this.renderScaleTarget=Gi(1);this.selectSegment=this.layer.selectSegment;this.transparentPickEnabled=this.layer.pick;this.baseSegmentColoring=new Xe(!1,!1);this.baseSegmentHighlighting=new Xe(!1,!1);this.useTempSegmentStatedColors2d=this.layer.registerDisposer(bt.make(this.layer.manager.rpc,!1));this.filterBySegmentLabel=this.layer.filterBySegmentLabel;this.moveToSegment=e=>{this.layer.moveToSegment(e)};this.linkedSegmentationGroup=this.layer.registerDisposer(new xg(this.layer.manager.rootLayers,this.layer,e=>e instanceof Qt,e=>e.displayState.linkedSegmentationGroup));this.linkedSegmentationColorGroup=this.layer.registerDisposer(new xg(this.layer.manager.rootLayers,this.layer,e=>e instanceof Qt,e=>e.displayState.linkedSegmentationColorGroup));this.originalSegmentationGroupState=this.layer.registerDisposer(new NV(this.layer));this.originalSegmentationColorGroupState=this.layer.registerDisposer(new BV(this.layer));e.displayState=this,this.segmentationGroupState=this.layer.registerDisposer(new Cw(this.linkedSegmentationGroup,"originalSegmentationGroupState")),this.segmentationColorGroupState=this.layer.registerDisposer(new Cw(this.linkedSegmentationColorGroup,"originalSegmentationColorGroupState")),this.hideSegmentZero=this.layer.registerDisposer(new bc(this.segmentationGroupState,t=>t.hideSegmentZero)),this.segmentColorHash=this.layer.registerDisposer(new Oo(this.segmentationColorGroupState,t=>t.segmentColorHash)),this.segmentStatedColors=this.layer.registerDisposer(new Oo(this.segmentationColorGroupState,t=>t.segmentStatedColors)),this.tempSegmentStatedColors2d=this.layer.registerDisposer(new Oo(this.segmentationColorGroupState,t=>t.tempSegmentStatedColors2d)),this.segmentDefaultColor=this.layer.registerDisposer(new Oo(this.segmentationColorGroupState,t=>t.segmentDefaultColor)),this.tempSegmentDefaultColor2d=this.layer.registerDisposer(new Oo(this.segmentationColorGroupState,t=>t.tempSegmentDefaultColor2d)),this.highlightColor=this.layer.registerDisposer(new Oo(this.segmentationColorGroupState,t=>t.highlightColor)),this.segmentQuery=this.layer.registerDisposer(new bc(this.segmentationGroupState,t=>t.segmentQuery)),this.segmentPropertyMap=this.layer.registerDisposer(new bc(this.segmentationGroupState,t=>t.segmentPropertyMap))}},G5=du(TV(EV(IV(bi)))),Qt=class extends G5{constructor(e){super(e);this.sliceViewRenderScaleHistogram=new La;this.sliceViewRenderScaleTarget=Gi(1);this.graphConnection=new ke(void 0);this.segmentQueryFocusTime=new ke(Number.NEGATIVE_INFINITY);this.selectSegment=(e,t)=>{this.manager.root.selectionState.captureSingleLayerState(this,r=>(r.value=e.clone(),!0),t)};this.filterBySegmentLabel=e=>{let t=Ia(this.displayState,e),{label:r}=t;!r||this.filterSegments(r)};this.filterSegments=e=>{this.displayState.segmentationGroupState.value.segmentQuery.value=e,this.segmentQueryFocusTime.value=Date.now(),this.tabs.value="segments",this.manager.root.selectedLayer.layer=this.managedLayer};this.displayState=new FV(this);this.anchorSegment=new Ce(void 0,e=>e===void 0?void 0:X.parseString(e));this.has2dLayer=this.registerDisposer(vn(e=>e.some(t=>t instanceof Eg),{changed:this.layersChanged,value:this.renderLayers}));this.has3dLayer=this.registerDisposer(vn(e=>e.some(t=>t instanceof gm||t instanceof ip||t instanceof sp||t instanceof bm),{changed:this.layersChanged,value:this.renderLayers}));this.hasSkeletonsLayer=this.registerDisposer(vn(e=>e.some(t=>t instanceof sp),{changed:this.layersChanged,value:this.renderLayers}));this.registerDisposer(ja((r,i)=>{r.registerDisposer(i.specificationChanged.add(this.specificationChanged.dispatch)),this.specificationChanged.dispatch()},this.displayState.segmentationGroupState)),this.registerDisposer(ja((r,i)=>{r.registerDisposer(i.specificationChanged.add(this.specificationChanged.dispatch)),this.specificationChanged.dispatch()},this.displayState.segmentationColorGroupState)),this.displayState.segmentSelectionState.bindTo(this.manager.layerSelectedValues,this),this.displayState.selectedAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.saturation.changed.add(this.specificationChanged.dispatch),this.displayState.notSelectedAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.objectAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.hoverHighlight.changed.add(this.specificationChanged.dispatch),this.displayState.baseSegmentColoring.changed.add(this.specificationChanged.dispatch),this.displayState.ignoreNullVisibleSet.changed.add(this.specificationChanged.dispatch),this.displayState.skeletonRenderingOptions.changed.add(this.specificationChanged.dispatch),this.displayState.renderScaleTarget.changed.add(this.specificationChanged.dispatch),this.displayState.silhouetteRendering.changed.add(this.specificationChanged.dispatch),this.anchorSegment.changed.add(this.specificationChanged.dispatch),this.sliceViewRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.displayState.originalSegmentationGroupState.localGraph.changed.add(this.specificationChanged.dispatch),this.displayState.linkedSegmentationGroup.changed.add(()=>this.updateDataSubsourceActivations()),this.tabs.add("rendering",{label:"Render",order:-100,getter:()=>new ZC(this)}),this.tabs.add("segments",{label:"Seg.",order:-50,getter:()=>new UC(this)});let t=this.registerDisposer(Mt(r=>r===void 0,[this.displayState.segmentationGroupState.value.graph]));this.tabs.add("graph",{label:"Graph",order:-25,getter:()=>new ib(this),hidden:t}),this.tabs.default="rendering"}bindSegmentListWidth(e){return os(this.displayState,e)}get volumeOptions(){return{volumeType:dt.SEGMENTATION}}activateDataSubsources(e){let t=[],r=this.displayState.linkedSegmentationGroup.root.value===this,i;for(let a of e){if(this.addStaticAnnotations(a))continue;let{volume:o,mesh:l,segmentPropertyMap:c,segmentationGraph:d,local:p}=a.subsourceEntry.subsource;if(o instanceof Bt){switch(o.dataType){case W.FLOAT32:a.deactivate("Data type not compatible with segmentation layer");continue}a.activate(()=>a.addRenderLayer(new Eg(o,{...this.displayState,transform:a.getRenderLayerTransform(),renderScaleTarget:this.sliceViewRenderScaleTarget,renderScaleHistogram:this.sliceViewRenderScaleHistogram,localPosition:this.localPosition})),this.displayState.segmentationGroupState.value)}else l!==void 0?a.activate(()=>{let h={...this.displayState,transform:a.getRenderLayerTransform()};if(l instanceof Vn)a.addRenderLayer(new gm(this.manager.chunkManager,l,h));else if(l instanceof fo)a.addRenderLayer(new ip(this.manager.chunkManager,l,h));else{let g=new Xb(this.manager.chunkManager,l,h);a.addRenderLayer(new sp(g.addRef())),a.addRenderLayer(new bm(g))}},this.displayState.segmentationGroupState.value):c!==void 0?r?(a.activate(()=>{}),t.push(c)):a.deactivate("Not supported on non-root linked segmentation layers"):d!==void 0?r?i!==void 0?a.deactivate("Only one segmentation graph is supported"):(i=d,a.activate(h=>{let g=d.connect(this);h.registerDisposer(()=>{g.dispose(),this.graphConnection.value=void 0});let v={...this.displayState,transform:a.getRenderLayerTransform()},b=g.createRenderLayers(this.manager.chunkManager,v,this.localPosition);this.graphConnection.value=g;for(let x of b)a.addRenderLayer(x)})):a.deactivate("Not supported on non-root linked segmentation layers"):p===pi.equivalences?r?i!==void 0?a.deactivate("Only one segmentation graph is supported"):(i=this.displayState.originalSegmentationGroupState.localGraph,a.activate(h=>{this.graphConnection.value=h.registerDisposer(i.connect(this)),h.registerDisposer(()=>{this.graphConnection.value=void 0})})):a.deactivate("Not supported on non-root linked segmentation layers"):a.deactivate("Not compatible with segmentation layer")}this.displayState.originalSegmentationGroupState.segmentPropertyMap.value=XI(this.manager.chunkManager,t),this.displayState.originalSegmentationGroupState.graph.value=i}getLegacyDataSourceSpecifications(e,t,r,i){let a=super.getLegacyDataSourceSpecifications(e,t,r,i),o=ie(t,B5,c=>c===null?null:Z(c)),l=ie(t,F5,c=>c===null?null:Z(c));if(o!==void 0||l!==void 0)for(let c of a)c.enableDefaultSubsources=!1,c.subsources=new Map([["default",{enabled:!0}],["bounds",{enabled:!0}]]);return o!=null&&a.push(Rl(this.manager.dataSourceProviderRegistry.convertLegacyUrl({url:o,type:"mesh"}))),l!=null&&a.push(Rl(this.manager.dataSourceProviderRegistry.convertLegacyUrl({url:l,type:"skeletons"}))),t[Xg]!==void 0&&i.find(c=>c.url===Yh)===void 0&&a.push({url:Yh,enableDefaultSubsources:!0,transform:{outputSpace:_i,sourceRank:0,transform:void 0,inputSpace:_i},subsources:new Map}),a}restoreState(e){super.restoreState(e),this.displayState.selectedAlpha.restoreState(e[cw]),this.displayState.saturation.restoreState(e[pw]),this.displayState.notSelectedAlpha.restoreState(e[uw]),this.displayState.hoverHighlight.restoreState(e[fw]),this.displayState.objectAlpha.restoreState(e[dw]),this.displayState.baseSegmentColoring.restoreState(e[mw]),this.displayState.silhouetteRendering.restoreState(e[bw]),this.displayState.ignoreNullVisibleSet.restoreState(e[gw]);let{skeletonRenderingOptions:t}=this.displayState;t.restoreState(e[Qg]);let r=e[U5];r!==void 0&&t.shader.restoreState(r),this.displayState.renderScaleTarget.restoreState(e[vw]),this.anchorSegment.restoreState(e[OV]),this.sliceViewRenderScaleTarget.restoreState(e[Sw]);let i=ie(e,_V,Z);i!==void 0&&this.displayState.linkedSegmentationGroup.linkByName(i);let a=ie(e,VV,o=>o===!1?void 0:Z(o),i);a!==void 0&&this.displayState.linkedSegmentationColorGroup.linkByName(a),this.displayState.segmentationGroupState.value.restoreState(e),this.displayState.segmentationColorGroupState.value.restoreState(e)}toJSON(){var i;let e=super.toJSON();e[cw]=this.displayState.selectedAlpha.toJSON(),e[uw]=this.displayState.notSelectedAlpha.toJSON(),e[pw]=this.displayState.saturation.toJSON(),e[dw]=this.displayState.objectAlpha.toJSON(),e[fw]=this.displayState.hoverHighlight.toJSON(),e[mw]=this.displayState.baseSegmentColoring.toJSON(),e[gw]=this.displayState.ignoreNullVisibleSet.toJSON(),e[bw]=this.displayState.silhouetteRendering.toJSON(),e[OV]=this.anchorSegment.toJSON(),e[Qg]=this.displayState.skeletonRenderingOptions.toJSON(),e[vw]=this.displayState.renderScaleTarget.toJSON(),e[Sw]=this.sliceViewRenderScaleTarget.toJSON();let{linkedSegmentationGroup:t,linkedSegmentationColorGroup:r}=this.displayState;return e[_V]=t.toJSON(),r.root.value!==t.root.value&&(e[VV]=(i=r.toJSON())!=null?i:!1),e[Xg]=this.displayState.originalSegmentationGroupState.localGraph.toJSON(),t.root.value===this&&Object.assign(e,this.displayState.segmentationGroupState.value.toJSON()),r.root.value===this&&Object.assign(e,this.displayState.segmentationColorGroupState.value.toJSON()),e}transformPickedValue(e){return e==null?e:Ub(this.displayState,e,!0)}handleAction(e,t){switch(e){case"recolor":{this.displayState.segmentationColorGroupState.value.segmentColorHash.randomize();break}case"clear-segments":{if(!this.pick.value)break;this.displayState.segmentationGroupState.value.visibleSegments.clear();break}case"select":{if(!this.pick.value)break;let{segmentSelectionState:r}=this.displayState;if(r.hasSelectedSegment){let i=r.selectedSegment,{visibleSegments:a}=this.displayState.segmentationGroupState.value,o=!a.has(i);(o||t.segmentationToggleSegmentState===void 0)&&(t.segmentationToggleSegmentState=o),t.defer(()=>{t.segmentationToggleSegmentState===o&&a.set(i,o)})}break}}}selectionStateFromJson(e,t){super.selectionStateFromJson(e,t);let r=new X,{value:i}=e;typeof i=="number"&&(i=i.toString()),typeof i!="string"||!r.tryParseString(i)?e.value=void 0:e.value=r}selectionStateToJson(e,t){let r=super.selectionStateToJson(e,t),{value:i}=e;return i instanceof $i?t?r.value={key:i.key.toString(),value:i.value?i.value.toString():void 0,label:i.label}:r.value=(i.value||i.key).toString():i instanceof X&&(r.value=i.toString()),r}displaySegmentationSelection(e,t,r){let{value:i}=e,a;if((typeof i=="number"||typeof i=="string")&&(a=new X,!a.tryParseString(i.toString())))return!1;if(i instanceof X)a=i.clone();else if(i instanceof $i)a=i.key.clone();else return!1;let{displayState:o}=this,l=Ia(o,a),{segmentEquivalences:c,segmentPropertyMap:{value:d}}=this.displayState.segmentationGroupState.value,p=c.get(a),h=Tl(this.displayState,l);if(ss(o,r,r.redraw),r.registerDisposer(os(o,h)),h.classList.add("neuroglancer-selection-details-segment"),t.appendChild(h),d!==void 0){let{inlineProperties:g}=d.segmentPropertyMap;if(g!==void 0){let v=d.getSegmentInlineIndex(p);if(v!==-1){for(let b of g.properties)if(b.type!=="label"){if(b.type==="description"){let x=b.values[v];if(!x)continue;let C=document.createElement("div");C.classList.add("neuroglancer-selection-details-segment-description"),C.textContent=x,t.appendChild(C)}else if(b.type==="number"||b.type==="string"){let x=b.values[v];if(b.type==="number"?isNaN(x):!x)continue;let C=document.createElement("div");C.classList.add("neuroglancer-selection-details-segment-property");let T=document.createElement("div");T.classList.add("neuroglancer-selection-details-segment-property-name"),T.textContent=b.id,b.description&&(T.title=b.description);let P=document.createElement("div");P.classList.add("neuroglancer-selection-details-segment-property-value"),P.textContent=x.toString(),C.appendChild(T),C.appendChild(P),t.appendChild(C)}}}}}return!0}displaySelectionState(e,t,r){let i=this.displaySegmentationSelection(e,t,r);return super.displaySelectionState(e,t,r)&&(i=!0),i}moveToSegment(e){for(let t of this.renderLayers){if(!(t instanceof ip))continue;let r=t.getObjectPosition(e);if(r!==void 0){this.setLayerPosition(t.displayState.transform.value,r);return}}Ee.showTemporaryMessage(`No position information loaded for segment ${e}`)}};Qt.type="segmentation",Qt.typeAbbreviation="seg",Qt.supportsPickOption=!0;var W5=10;function UV(n){return[{label:`Skeleton mode (${n})`,toolJson:`${Qg}.mode${n}`,isValid:e=>e.hasSkeletonsLayer,...qg(e=>e.displayState.skeletonRenderingOptions[`params${n}`].mode)},{label:`Line width (${n})`,toolJson:`${Qg}.lineWidth${n}`,isValid:e=>e.hasSkeletonsLayer,toolDescription:`Skeleton line width (${n})`,title:`Skeleton line width (${n})`,...Qi(e=>({value:e.displayState.skeletonRenderingOptions[`params${n}`].lineWidth,options:{min:1,max:40,step:1}}))}]}var tw=[{label:"Color seed",title:"Color segments based on a hash of their id",toolJson:yw,...bV()},{label:"Fixed color",title:"Use a fixed color for all segments without an explicitly-specified color",toolJson:xw,...xV()},{label:"Saturation",toolJson:pw,title:"Saturation of segment colors",...Qi(n=>({value:n.displayState.saturation}))},{label:"Opacity (on)",toolJson:cw,isValid:n=>n.has2dLayer,title:"Opacity in cross-section views of segments that are selected",...Qi(n=>({value:n.displayState.selectedAlpha}))},{label:"Opacity (off)",toolJson:uw,isValid:n=>n.has2dLayer,title:"Opacity in cross-section views of segments that are not selected",...Qi(n=>({value:n.displayState.notSelectedAlpha}))},{label:"Resolution (slice)",toolJson:Sw,isValid:n=>n.has2dLayer,...hu(n=>({histogram:n.sliceViewRenderScaleHistogram,target:n.sliceViewRenderScaleTarget}))},{label:"Resolution (mesh)",toolJson:vw,isValid:n=>n.has3dLayer,...hu(n=>({histogram:n.displayState.renderScaleHistogram,target:n.displayState.renderScaleTarget}))},{label:"Opacity (3d)",toolJson:dw,isValid:n=>n.has3dLayer,title:"Opacity of meshes and skeletons",...Qi(n=>({value:n.displayState.objectAlpha}))},{label:"Silhouette (3d)",toolJson:bw,isValid:n=>n.has3dLayer,title:"Set to a non-zero value to increase transparency of object faces perpendicular to view direction",...Qi(n=>({value:n.displayState.silhouetteRendering,options:{min:0,max:W5,step:.1}}))},{label:"Hide segment ID 0",toolJson:hw,title:"Disallow selection and display of segment id 0",...bo(n=>n.displayState.hideSegmentZero)},{label:"Base segment coloring",toolJson:mw,title:"Color base segments individually",...bo(n=>n.displayState.baseSegmentColoring)},{label:"Show all by default",title:"Show all segments if none are selected",toolJson:gw,...bo(n=>n.displayState.ignoreNullVisibleSet)},{label:"Highlight on hover",toolJson:fw,title:"Highlight the segment under the mouse pointer",...bo(n=>n.displayState.hoverHighlight)},...UV("2d"),...UV("3d")];for(let n of tw)Hg(Qt,n);Ki(Qt);Cg(dt.SEGMENTATION,Qt);gs(n=>{if(n.mesh!==void 0)return{layerConstructor:Qt,priority:1}});Ts(Qt,n=>({shaderControlState:n.displayState.skeletonRenderingOptions.shaderControlState}),ew);V_();N_();function Zg(n,e=0){let t=an.clone([...n]);return t[3]=e,t}var ww=K.fromValues(1,0,0),Tw=K.fromValues(0,0,1),z5=Zg(ww,.5),H5=Zg(Tw,.5),$5=Zg(ww,.25),j5=Zg(Tw,.25),J5=an.fromValues(.5,.5,.5,.01),q5=new X(Ja(z5)),Y5=new X(Ja(H5)),K5=new X(Ja(J5)),X5=an.fromValues(0,0,0,.5),GV=class extends nt(ut()(Vn),ag){getFragmentKey(e,t){return gM(t)}},WV=class{constructor(e,t){let r=/^(https?:\/\/[.\w:\-\/]+)\/segmentation\/(?:1\.0|table)\/([^\/]+)\/?$/,i=e.match(r);if(i===null)throw Error(`Graph URL invalid: ${e}`);this.segmentationUrl=`${i[1]}/segmentation/api/v${Sp}/table/${i[2]}`,this.meshingUrl=`${i[1]}/meshing/api/v${Sp}/table/${i[2]}`;try{Q(t),this.supported_api_versions=U(t,"supported_api_versions",a=>ge(a,DE))}catch(a){this.supported_api_versions=[0]}if(!(Sp in this.supported_api_versions)){let a=`This Neuroglancer branch requires Graph Server version ${Sp}, but the server only supports version(s) ${this.supported_api_versions}.`;throw new Error(a)}}},Q5=8,zV=class{constructor(e){Q(e),this.chunkSize=U(e,"chunk_size",t=>Pe(K.create(),t,ct)),this.nBitsForLayerId=ie(e,"n_bits_for_layer_id",ct,Q5)}};function Z5(n,e,t){let r=dx(n),i=U(n,"data_dir",l=>Dn(l,t)).url,a=U(n,"app",l=>new WV(e,l)),o=U(n,"graph",l=>new zV(l));return{...r,app:a,graph:o,dataUrl:i}}var HV=class extends $m{constructor(e,t,r){super(e,void 0,r.dataUrl,r);this.chunkedGraphCredentialsProvider=t;this.info=r}getChunkedGraphSource(){let{rank:e}=this,t=this.info.scales[0],r=SM({rank:e,dataType:this.info.dataType,upperVoxelBound:t.size,chunkDataSize:Uint32Array.from(this.info.graph.chunkSize),baseVoxelOffset:t.voxelOffset}),i=e+1,a=new Float32Array(i*i);a[a.length-1]=1;let{lowerBounds:o,upperBounds:l}=this.info.modelSpace.boundingBoxes[0].box,c=new Float32Array(e),d=new Float32Array(e);for(let p=0;p<3;++p){let h=1;a[i*p+p]=h,a[i*e+p]=t.voxelOffset[p],c[p]=o[p],d[p]=l[p]}return{chunkSource:this.chunkManager.getChunkSource(s2,{spec:r,credentialsProvider:this.chunkedGraphCredentialsProvider,parameters:{url:`${this.info.app.segmentationUrl}/node`}}),chunkToMultiscaleTransform:a,lowerClipBound:c,upperClipBound:d}}};function $V(n){return U(n,"transform",e=>{let t=oe.create();return e!==void 0&&Pe(t.subarray(0,12),e,Ke),oe.transpose(t,t),t})}function eJ(n){Q(n);let e=U(n,"@type",Z),t;if(e==="neuroglancer_legacy_mesh"){let i=U(n,"sharding",JV);if(i===void 0)t=void 0;else{let a=0,o=10,l=$V(n);t={lodScaleMultiplier:a,transform:l,sharding:i,vertexQuantizationBits:o}}}else{if(e!=="neuroglancer_multilod_draco")throw new Error(`Unsupported mesh type: ${JSON.stringify(e)}`);{let i=U(n,"lod_scale_multiplier",ot),a=U(n,"vertex_quantization_bits",ct),o=$V(n),l=U(n,"sharding",JV);t={lodScaleMultiplier:i,transform:o,sharding:l,vertexQuantizationBits:a}}}let r=U(n,"segment_properties",Vt);return{metadata:t,segmentPropertyMap:r}}async function tJ(n,e,t){let r;try{r=await Lw(n,e,t)}catch(i){if(zi(i))return{metadata:void 0};throw i}return eJ(r)}function jV(n){return n===void 0?fs.RAW:yt(n,fs)}function nJ(n){if(n===void 0)return;Q(n);let e=U(n,"@type",Z);if(e!=="neuroglancer_uint64_sharded_v1")throw new Error(`Unsupported sharding format: ${JSON.stringify(e)}`);let t=U(n,"hash",c=>yt(c,eu)),r=U(n,"preshift_bits",ze),i=U(n,"shard_bits",ze),a=U(n,"minishard_bits",ze),o=U(n,"minishard_index_encoding",jV),l=U(n,"data_encoding",jV);return{hash:t,preshiftBits:r,shardBits:i,minishardBits:a,minishardIndexEncoding:o,dataEncoding:l}}function JV(n){if(n===void 0)return;Q(n);let e=new Array;for(let t in n){let r=Number(t);e[r]=nJ(n[r])}return e}function rJ(n,e,t){return n.getChunkSource(GV,{parameters:e,credentialsProvider:t})}async function iJ(n,e,t,r,i){let{metadata:a,segmentPropertyMap:o}=await tJ(n,void 0,r),l={manifestUrl:t,fragmentUrl:r,lod:0,sharding:a==null?void 0:a.sharding,nBitsForLayerId:i},c=(a==null?void 0:a.transform)||oe.create();return{source:rJ(n,l,e),transform:c,segmentPropertyMap:o}}function Lw(n,e,t){return n.memoize.getUncounted({type:"graphene:metadata",url:t,credentialsProvider:lt(e)},async()=>await On(e,`${t}/info`,{},kt))}function aJ(n){let e=oe.create(),t=n.scales[0].resolution;for(let r=0;r<3;++r)e[5*r]=1/t[r];return e}async function oJ(n,e,t,r){let i=Z5(r,t,n.credentialsManager),a=new HV(n.chunkManager,e,i),o=new n2;n.state&&o.restoreState(n.state);let l=new Dw(i,e,a,o),{modelSpace:c}=i,d=[{id:"default",default:!0,subsource:{volume:a}},{id:"graph",default:!0,subsource:{segmentationGraph:l}},{id:"bounds",default:!0,subsource:{staticAnnotations:sn(c.bounds)}}];if(i.segmentPropertyMap!==void 0){let p=Aa(t,i.segmentPropertyMap),h=await Lw(n.chunkManager,e,p),g=nu(n.chunkManager,e,h,p);d.push({id:"properties",default:!0,subsource:{segmentPropertyMap:g}})}if(i.mesh!==void 0){let{source:p,transform:h}=await iJ(n.chunkManager,e,i.app.meshingUrl,Aa(i.dataUrl,i.mesh),i.graph.nBitsForLayerId),g=aJ(i);oe.multiply(g,g,h),d.push({id:"mesh",default:!0,subsource:{mesh:p},subsourceToModelSubspaceTransform:g})}return{modelTransform:vt(c),subsources:d,state:o}}var kw=class extends gp{get description(){return"Graphene file-backed data source"}get(e){let{url:t,parameters:r}=mp(e.providerUrl);return e.chunkManager.memoize.getUncounted({type:"graphene:get",providerUrl:t,parameters:r},async()=>{let{url:i,credentialsProvider:a}=Dn(t,e.credentialsManager),o;try{o=await Lw(e.chunkManager,a,i)}catch(d){throw zi(d)&&r.type==="mesh"&&console.log("does this happen?"),d}Q(o);let l=ie(o,"redirect",Z);if(l!==void 0)throw new zc(l);let c=ie(o,"@type",Z);switch(c){case"neuroglancer_multiscale_volume":case void 0:return await oJ(e,a,i,o);default:throw new Error(`Invalid type: ${JSON.stringify(c)}`)}})}};function ey(n){for(let e of n.dataSources){let{loadState:t}=e;if(!(t===void 0||t.error!==void 0)){for(let r of t.subsources)if(r.enabled&&r.subsourceEntry.id==="graph")return r}}}function qV(n,e,t,r){let{subsourceEntry:i}=e,a=new kd(e.loadedDataSource.transform,[],[]),o=new _p;o.color.value.set(r);let l=new ys({localPosition:n.localPosition,transform:e.getRenderLayerTransform(),source:a,displayState:o,dataSource:e.loadedDataSource.layerDataSource,subsourceIndex:e.subsourceIndex,subsourceId:i.id,subsubsourceId:t,role:_n.ANNOTATION});return n.addAnnotationLayerState(l,e),l}function sJ(n){function e(a){return U(n,a,o=>X.parseString(String(o)))}let t=e(ZV),r=e(e2),i=U(n,t2,a=>oh(a));return{segmentId:t,rootId:r,position:i}}var YV="multicut",KV="focusSegment",XV="sinks",QV="sources",ZV="segmentId",e2="rootId",t2="position",n2=class{constructor(){this.changed=new ne;this.multicutState=new r2;this.multicutState.changed.add(()=>{this.changed.dispatch()})}reset(){this.multicutState.reset()}toJSON(){return{[YV]:this.multicutState.toJSON()}}restoreState(e){ie(e,YV,t=>{this.multicutState.restoreState(t)})}},r2=class extends H{constructor(e=new Ce(void 0,r=>r),t=new ke(!1)){super();this.focusSegment=e;this.blueGroup=t;this.changed=new ne;this.sinks=new Sc;this.sources=new Sc;let r=()=>{this.sinks.size===0&&this.sources.size===0&&(this.focusSegment.value=void 0)};this.registerDisposer(e.changed.add(this.changed.dispatch)),this.registerDisposer(this.sinks.changed.add(r)),this.registerDisposer(this.sources.changed.add(r)),this.registerDisposer(this.blueGroup.changed.add(this.changed.dispatch)),this.registerDisposer(this.sinks.changed.add(this.changed.dispatch)),this.registerDisposer(this.sources.changed.add(this.changed.dispatch))}reset(){this.focusSegment.value=void 0,this.blueGroup.value=!1,this.sinks.clear(),this.sources.clear()}toJSON(){let{focusSegment:e,sinks:t,sources:r}=this,i=a=>({[ZV]:a.segmentId.toJSON(),[e2]:a.rootId.toJSON(),[t2]:[...a.position]});return{[KV]:e.toJSON(),[XV]:[...t].map(i),[QV]:[...r].map(i)}}restoreState(e){let t=a=>ge(a,o=>sJ(o));ie(e,KV,a=>{this.focusSegment.restoreState(X.parseString(String(a)))});let r=U(e,XV,t),i=U(e,QV,t);for(let a of r)this.sinks.add(a);for(let a of i)this.sources.add(a)}swapGroup(){this.blueGroup.value=!this.blueGroup.value}get activeGroup(){return this.blueGroup.value?this.sources:this.sinks}get segments(){return[...this.redSegments,...this.blueSegments]}get redSegments(){return[...this.sinks].filter(e=>!X.equal(e.segmentId,e.rootId)).map(e=>e.segmentId)}get blueSegments(){return[...this.sources].filter(e=>!X.equal(e.segmentId,e.rootId)).map(e=>e.segmentId)}},ty=class extends ll{constructor(e,t,r,i){super(e,t.displayState.segmentationGroupState.value);this.graph=e;this.chunkSource=r;this.state=i;this.annotationLayerStates=[];this.lastDeselectionMessageExists=!1;t.displayState.segmentationGroupState.value.visibleSegments.changed.add((h,g)=>{h!==null&&(h=Array().concat(h)),this.visibleSegmentsChanged(h,g)});let{annotationLayerStates:o,state:{multicutState:l}}=this,c=ey(t),d=qV(t,c,"sinks",ww),p=qV(t,c,"sources",Tw);u2(l.sinks,d),u2(l.sources,p),o.push(d,p)}createRenderLayers(e,t,r){return[new l2(e,this.chunkSource.getChunkedGraphSource(),t,r,this.graph.info.graph.nBitsForLayerId)]}visibleSegmentsChanged(e,t){let{segmentsState:r}=this;if(e===null){let i=this.segmentsState.visibleSegments.size;this.segmentsState.segmentEquivalences.clear(),Ee.showTemporaryMessage(`Deselected all ${i} segments.`,3e3);return}for(let i of e){let a=mM(i,this.graph.info.graph.nBitsForLayerId),o=i.clone();if(t)a&&this.graph.getRoot(o).then(l=>{r.visibleSegments.delete(o),r.visibleSegments.add(l)});else if(!a){let{focusSegment:{value:l}}=this.graph.state.multicutState;if(l&&X.equal(i,l)){r.visibleSegments.add(i),Ee.showTemporaryMessage("Can't deselect active multicut segment.",3e3);return}let c=[...r.segmentEquivalences.setElements(i)].length;r.segmentEquivalences.deleteSet(i),this.lastDeselectionMessage&&this.lastDeselectionMessageExists&&(this.lastDeselectionMessage.dispose(),this.lastDeselectionMessageExists=!1),this.lastDeselectionMessage=Ee.showMessage(`Deselected ${c} segments.`),this.lastDeselectionMessageExists=!0,setTimeout(()=>{this.lastDeselectionMessageExists&&(this.lastDeselectionMessage.dispose(),this.lastDeselectionMessageExists=!1)},2e3)}}}computeSplit(e,t){}async submitMulticut(e){let{state:{multicutState:t}}=this,{sinks:r,sources:i}=t;if(r.size===0||i.size===0)return Ee.showTemporaryMessage("Must select both red and blue groups to perform a multi-cut.",7e3),!1;{let a=await this.graph.graphServer.splitSegments([...r],[...i],e);if(a.length===0)return Ee.showTemporaryMessage("No split found.",3e3),!1;{let o=t.focusSegment.value;t.reset();let{segmentsState:l}=this;return l.visibleSegments.delete(o),l.visibleSegments.add(a),!0}}}};async function Ew(n,e){let t=new Ee(!0);t.setText(e.initialMessage);let r=t.dispose.bind(t);try{let i=await n;return r(),i}catch(i){if(i instanceof Sr&&i.response){let a;i.response.headers.get("content-type")==="application/json"?a=(await i.response.json()).message:a=await i.response.text();let{errorPrefix:o=""}=e;throw t.setErrorMessage(o+a),t.setVisible(!0),new Error(`[${i.response.status}] ${o}${a}`)}throw i}}var i2=Symbol("Graph Server Not Specified."),a2=class{constructor(e,t){this.url=e;this.credentialsProvider=t}async getRoot(e,t=""){let r=new Date(t).valueOf()/1e3,i=`${this.url}/node/${String(e)}/root?int64_as_str=1${Number.isNaN(r)?"":`&timestamp=${r}`}`,a=On(this.credentialsProvider,i,{},og),l=await(await Ew(a,{initialMessage:`Retrieving root for segment ${e}`,errorPrefix:"Could not fetch root: "})).json();return X.parseString(l.root_id)}async mergeSegments(e,t,r){let{url:i}=this;if(i==="")return Promise.reject(i2);let a=On(this.credentialsProvider,`${i}/merge?int64_as_str=1`,{method:"POST",body:JSON.stringify([[String(e.segmentId),...e.position.map((c,d)=>c*r[d])],[String(t.segmentId),...t.position.map((c,d)=>c*r[d])]])},og),l=await(await Ew(a,{initialMessage:`Merging ${e.segmentId} and ${t.segmentId}`,errorPrefix:"Merge failed: "})).json();return X.parseString(l.new_root_ids[0])}async splitSegments(e,t,r){let{url:i}=this;if(i==="")return Promise.reject(i2);let a=On(this.credentialsProvider,`${i}/split?int64_as_str=1`,{method:"POST",body:JSON.stringify({sources:e.map(d=>[String(d.segmentId),...d.position.map((p,h)=>p*r[h])]),sinks:t.map(d=>[String(d.segmentId),...d.position.map((p,h)=>p*r[h])])})},og),l=await(await Ew(a,{initialMessage:`Splitting ${e.length} sources from ${t.length} sinks`,errorPrefix:"Split failed: "})).json(),c=new Array(l.new_root_ids.length);for(let d=0;d<c.length;++d)c[d]=X.parseString(l.new_root_ids[d]);return c}},Dw=class extends sl{constructor(e,t,r,i){super();this.info=e;this.chunkSource=r;this.state=i;this.connections=new Set;this.graphServer=new a2(e.app.segmentationUrl,t)}connect(e){let t=new ty(this,e,this.chunkSource,this.state);return this.connections.add(t),t.registerDisposer(()=>{this.connections.delete(t)}),t}get visibleSegmentEquivalencePolicy(){return Kt.MAX_REPRESENTATIVE|Kt.NONREPRESENTATIVE_EXCLUDED}getRoot(e){return this.graphServer.getRoot(e)}tabContents(e,t,r){let i=document.createElement("div");i.style.display="contents";let a=document.createElement("div");a.className="neuroglancer-segmentation-toolbox",a.appendChild(Al(t,e,{toolJson:Pw,label:"Multicut",title:"Multicut segments"})),a.appendChild(Al(t,e,{toolJson:Iw,label:"Merge",title:"Merge segments"})),i.appendChild(a),i.appendChild(t.registerDisposer(new c2(e,e.annotationDisplayState)).element);let o=r.element;return o.classList.add("neuroglancer-annotations-tab"),o.classList.add("neuroglancer-graphene-tab"),i}async merge(e,t){return new X}async split(e,t){return{include:e,exclude:t}}trackSegment(e,t){return()=>{console.log("trackSegment... do nothing",e,t)}}},o2=class extends dl{constructor(e,t){super(e,t)}},s2=class extends nt(ut()(o2),ig){},l2=class extends di{constructor(e,t,r,i,a){super();this.chunkManager=e;this.source=t;this.displayState=r;this.localPosition=i;this.layerChunkProgressInfo=new so;this.leafRequestsActive=this.registerDisposer(bt.make(e.rpc,!0)),this.chunkTransform=this.registerDisposer(vn(l=>Il(()=>el(bp(l))),this.displayState.transform));let o=this.sharedObject=this.backend=this.registerDisposer(new ls(e,r,this.layerChunkProgressInfo));o.RPC_TYPE_ID=yM,o.initializeCounterpartWithChunkManager({source:t.chunkSource.addCounterpartRef(),localPosition:this.registerDisposer(bt.makeFromExisting(e.rpc,this.localPosition)).rpcId,leafRequestsActive:this.leafRequestsActive.rpcId,nBitsForLayerId:this.registerDisposer(bt.make(e.rpc,a)).rpcId}),this.registerDisposer(o.visibility.add(this.visibility)),this.registerDisposer(this.leafRequestsActive.changed.add(()=>{this.showOrHideMessage(this.leafRequestsActive.value)}))}attach(e){super.attach(e);let t=this.chunkTransform.value,r=e.view.displayDimensionRenderInfo.value;e.state={chunkTransform:t,displayDimensionRenderInfo:r},e.state.source=e.registerDisposer(Mn((i,a,o)=>{let l=fl(o,a,c=>[[this.source]],e.messages,this);return e.view.flushBackendProjectionParameters(),this.sharedObject.rpc.invoke(vM,{layer:this.sharedObject.rpcId,view:e.view.rpcId,displayDimensionRenderInfo:o,sources:ul(l)}),l[0][0]},this.displayState.transform,e.view.displayDimensionRenderInfo))}isReady(){return!0}showOrHideMessage(e){this.leafRequestsStatusMessage&&e?(this.leafRequestsStatusMessage.dispose(),this.leafRequestsStatusMessage=void 0,Ee.showTemporaryMessage("Loading chunked graph segmentation...",3e3)):!this.leafRequestsStatusMessage&&!e&&(this.leafRequestsStatusMessage=Ee.showMessage("At this zoom level, chunked graph segmentation will not be loaded. Please zoom in if you wish to load it."))}},Pw="grapheneMulticutSegments",Iw="grapheneMergeSegments",c2=class extends Ag{constructor(e,t){super(e,t);this.layer=e;this.displayState=t;let{graphConnection:{value:r}}=e;if(r instanceof ty)for(let i of r.annotationLayerStates)this.annotationStates.add(i)}get annotationStates(){return this._annotationStates===void 0&&(this._annotationStates=this.registerDisposer(new Ig)),this._annotationStates}},u2=(n,e)=>{let t=e.source;t.childDeleted.add(i=>{let a=[...n].find(o=>{var l;return((l=o.annotationReference)==null?void 0:l.id)===i});a&&n.delete(a)});let r=i=>{let a={id:"",point:i.position,type:Be.POINT,properties:[],relatedSegments:[[i.segmentId,i.rootId]]},o=t.add(a);i.annotationReference=o};n.changed.add((i,a)=>{if(i===null){for(let o of t)t.delete(t.getReference(o.id));return}a?r(i):i.annotationReference&&t.delete(i.annotationReference)});for(let i of n)r(i)};function lJ(n,e){let r=ey(e).getRenderLayerTransform(),i=Il(()=>el(bp(r.value)));if(i.error!==void 0)return;let a=new Float32Array(i.modelTransform.unpaddedRank);if(!!Vi(a,n,e.localPosition.value,i.layerRank,i.combinedGlobalLocalToChunkTransform))return a}var cJ=(n,e)=>{if(e.updateUnconditionally())return lJ(e.unsnappedPosition,n)},uJ=Ie.fromObject({"at:shift?+control+mousedown0":{action:"set-anchor"},"at:shift?+keys":{action:"swap-group"}}),d2=class extends Br{toJSON(){return Pw}activate(e){let{layer:t}=this,{graphConnection:{value:r}}=t;if(!r||!(r instanceof ty))return;let{state:{multicutState:i},segmentsState:a}=r;if(i===void 0)return;let{body:o,header:l}=Ma(e);l.textContent="Multicut segments",o.classList.add("graphene-multicut-status"),o.appendChild(He({text:"Swap",title:"Swap group",onClick:()=>{i.swapGroup()}})),o.appendChild(He({text:"Clear",title:"Clear multicut",onClick:()=>{i.reset()}})),o.appendChild(He({text:"Submit",title:"Submit multicut",onClick:()=>{let C=ey(this.layer).loadedDataSource.transform.inputSpace.value.scales.map(T=>T/1e-9);r.submitMulticut(C).then(T=>{T&&e.cancel()})}}));let c=document.createElement("div");c.className="activeGroupIndicator",c.innerHTML="Active Group: ",o.appendChild(c);let{displayState:d}=this.layer,p=d.segmentationGroupState.value,h=d.baseSegmentHighlighting.value,g=d.highlightColor.value;e.bindInputEventMap(uJ),e.registerDisposer(()=>{v(),d.baseSegmentHighlighting.value=h,d.highlightColor.value=g});let v=()=>{Cl(p),d.useTempSegmentStatedColors2d.value=!1,d.tempSegmentStatedColors2d.value.clear(),d.tempSegmentDefaultColor2d.value=void 0,d.highlightColor.value=void 0},b=()=>{v(),c.classList.toggle("blueGroup",i.blueGroup.value);let x=i.focusSegment.value;if(x!==void 0){d.baseSegmentHighlighting.value=!0,d.highlightColor.value=i.blueGroup.value?j5:$5,a.useTemporaryVisibleSegments.value=!0,a.useTemporarySegmentEquivalences.value=!0,a.temporaryVisibleSegments.add(x);for(let C of i.segments)a.temporaryVisibleSegments.add(C);for(let C of a.segmentEquivalences.setElements(x))a.temporaryVisibleSegments.has(C)||a.temporarySegmentEquivalences.link(x,C);d.tempSegmentDefaultColor2d.value=X5,d.tempSegmentStatedColors2d.value.set(x,K5);for(let C of i.redSegments)d.tempSegmentStatedColors2d.value.set(C,q5);for(let C of i.blueSegments)d.tempSegmentStatedColors2d.value.set(C,Y5);d.useTempSegmentStatedColors2d.value=!0}};b(),e.registerDisposer(i.changed.add(b)),e.bindAction("swap-group",x=>{x.stopPropagation(),i.swapGroup()}),e.bindAction("set-anchor",x=>{x.stopPropagation();let C=Aw(this,p.visibleSegments);if(!C)return;let{rootId:T,segmentId:P}=C,{focusSegment:I,segments:M}=i;if(I.value===void 0&&(I.value=T.clone()),!X.equal(I.value,T)){Ee.showTemporaryMessage(`The selected supervoxel has root segment ${T.toString()}, but the supervoxels already selected have root ${I.value.toString()}`,12e3);return}if(!X.equal(T,P)){for(let E of M)if(X.equal(E,P)){Ee.showTemporaryMessage(`Supervoxel ${P.toString()} has already been selected`,7e3);return}}i.activeGroup.add(C)})}get description(){return"multicut"}},Aw=(n,e)=>{let{layer:t,mouseState:r}=n,{segmentSelectionState:{value:i,baseValue:a}}=t.displayState;if(!a||!i)return;if(!e.has(i)){Ee.showTemporaryMessage("The selected supervoxel is of an unselected segment",7e3);return}let o=cJ(t,r);if(o!==void 0)return{rootId:i.clone(),segmentId:a.clone(),position:o}},dJ=Ie.fromObject({"at:shift?+mousedown0":{action:"merge-segments"}}),p2=class extends Br{constructor(){super(...arguments);this.lastAnchorSelection=new ke(void 0)}activate(e){let t=this.layer.displayState.segmentationGroupState.value,{graph:{value:r}}=t;if(!(r instanceof Dw))return;let{body:i,header:a}=Ma(e);a.textContent="Merge segments",i.classList.add("graphene-merge-segments-status");let o=document.createElement("div");o.style.display="contents",i.appendChild(o);let l=v=>{let b=Tl(this.layer.displayState,v);return b.classList.add("neuroglancer-segment-list-entry-double-line"),b},c=(v,b)=>{let x=document.createElement("div");x.classList.add("graphene-merge-segments-point");let C=document.createElement("span");C.textContent=b,x.appendChild(C);let T=l(Ia(this.layer.displayState,v));x.appendChild(T),o.appendChild(x)},d=He({text:"Clear",title:"Clear selection",onClick:()=>{for(this.lastAnchorSelection.value=void 0;o.firstChild;)o.removeChild(o.firstChild);i.removeChild(d)}}),p=v=>{c(v,"Sink: "),i.appendChild(d)},h=v=>{i.removeChild(d),c(v,"Source: ")};e.bindInputEventMap(dJ),e.registerDisposer(()=>{this.lastAnchorSelection.value=void 0});let g=!1;e.bindAction("merge-segments",v=>{v.stopPropagation(),(async()=>{let b=this.lastAnchorSelection.value;if(b){if(!g){let x=Aw(this,t.visibleSegments);if(x){g=!0,h(x.rootId);let T=ey(this.layer).loadedDataSource.transform.inputSpace.value.scales.map(M=>M/1e-9),P=await r.graphServer.mergeSegments(b,x,T),{visibleSegments:I}=t;I.delete(b.rootId),I.delete(x.rootId),I.add(P),this.lastAnchorSelection.value=void 0,e.cancel()}}}else{let x=Aw(this,t.visibleSegments);x&&(this.lastAnchorSelection.value=x,p(x.rootId))}})()})}toJSON(){return Iw}get description(){return"merge segments"}};Si(Qt,Pw,n=>new d2(n,!0));Si(Qt,Iw,n=>new p2(n,!0));Ft("graphene",()=>new kw);var ny;(function(r){r[r.JPEG=0]="JPEG",r[r.NPZ=1]="NPZ",r[r.RAW=2]="RAW"})(ny||(ny={}));var ry=class{},iy=class extends ry{};iy.RPC_ID="python/VolumeChunkSource";var ay=class extends ry{};ay.RPC_ID="python/MeshSource";var oy=class extends ry{};oy.RPC_ID="python/SkeletonSource";function Mw(n){class e extends n{constructor(...r){super(...r);let i=r[1],a=this.dataSource=this.registerDisposer(i.dataSource.addRef());this.generation=i.generation;let o=i.parameters.key;a.registerSource(o,this)}static encodeOptions(r){let i=super.encodeOptions(r);return i.dataSource=lt(r.dataSource),i}}return e}var f2=class extends Mw(nt(En,iy)){},Rw=class extends Mw(nt(Vn,ay)){};function h2(n,e,t,r,i,a){let o=n.length,l=new Float32Array(o);l.fill(1);let c=[l.slice()],d=1,p=e.length;if(p===0)return c;for(;!(c.length>=i||d>=r||l.every((b,x)=>n[x]/b<=a));){let h=e[0],g=b=>l[b]*t[b];for(let b=1;b<p;++b){let x=e[b];g(x)<g(h)&&(h=x)}l[h]*=2,d*=2;let v=g(h);for(let b=0;b<p&&d<r;++b){let x=e[b];if(x===h)continue;let C=g(x);Math.abs(C-v)>Math.abs(C*2-v)&&(l[x]*=2,d*=2)}c.push(new Float32Array(l))}return c}function m2(n){Q(n);let e={...U(n,"coordinateSpace",Qs),valid:!0},{rank:t}=e;e.coordinateArrays.forEach(a=>{a!==void 0&&(a.explicit=!1)});let r=lS(new Float32Array((t+1)*(t+1)),t+1,t+1),i=U(n,"voxelOffset",a=>Pe(new Float64Array(t),a,Ke));for(let a=0;a<t;++a)r[(t+1)*t+a]=i[a];return{subsourceToModelTransform:r,baseModelSpace:e,voxelOffset:i}}var g2=class extends Bt{constructor(e,t,r,i){super(t);this.dataSource=e;this.key=r;this.response=i;let{baseModelSpace:a,subsourceToModelTransform:o,voxelOffset:l}=m2(i);this.dataType=U(i,"dataType",g=>yt(g,W)),this.volumeType=U(i,"volumeType",g=>yt(g,dt)),this.encoding=U(i,"encoding",g=>yt(g,ny));let c=a.rank;this.subsourceToModelTransform=o;let d=U(i,"shape",g=>Pe(new Float32Array(c),g,ct));this.shape=d,this.maxDownsampling=U(i,"maxDownsampling",g=>g===null?Number.POSITIVE_INFINITY:ze(g)),this.maxDownsampledSize=U(i,"maxDownsampledSize",g=>g===null?Number.POSITIVE_INFINITY:ze(g)),this.maxDownsamplingScales=U(i,"maxDownsamplingScales",g=>g===null?Number.POSITIVE_INFINITY:ze(g)),this.downsamplingLayout=U(i,"downsamplingLayout",g=>g==="2d"?Qr.FLAT:Qr.ISOTROPIC),this.chunkLayoutPreference=U(i,"chunkLayout",g=>yt(g,Qr));let p={lowerBounds:l,upperBounds:Pc(new Float64Array(c),l,d)},h=Oe({rank:c,names:a.names,scales:a.scales,units:a.units,boundingBoxes:[Rn(p)],coordinateArrays:a.coordinateArrays});this.modelSpace=h,this.generation=U(i,"generation",g=>g),this.maxVoxelsPerChunkLog2=ie(i,"maxVoxelsPerChunkLog2",ct,AS)}get rank(){return this.modelSpace.rank}getSources(e){let t=[],{rank:r,volumeType:i,dataType:a,shape:o,encoding:l}=this,c=new Float32Array(r),{multiscaleToViewTransform:d,modelChannelDimensionIndices:p}=e;for(let b=0;b<r;++b){let x=0;for(let C=0;C<3;++C){let T=d[b*3+C];x+=T*T}x!==0&&t.push(b),c[b]=Math.sqrt(x)}let h=(b,x,C)=>{let T=new Float32Array((r+1)**2);T[T.length-1]=1;for(let D=0;D<r;++D)T[(r+2)*D]=b[D];let P=new Float32Array(r),I=new Float32Array(r);for(let D=0;D<r;++D)P[D]=Math.ceil(o[D]/b[D]),I[D]=o[D]/b[D];let M=new Uint32Array(r);M.fill(1);for(let D of x)M[D]=4294967295;for(let D of p)M[D]=4294967295;return Nr({chunkToMultiscaleTransform:T,rank:r,dataType:a,volumeType:i,maxBlockSize:M,upperVoxelBound:P,volumeSourceOptions:e,chunkLayoutPreference:C}).map(D=>({chunkSource:this.chunkManager.getChunkSource(f2,{spec:D,dataSource:this.dataSource,generation:this.generation,parameters:{key:this.key,scaleKey:b.join(),encoding:l}}),chunkToMultiscaleTransform:T,upperClipBound:I}))},g=b=>h2(this.shape,b,c,this.maxDownsampling,this.maxDownsamplingScales,this.maxDownsampledSize).map(x=>h(x,b,Qr.ISOTROPIC)[0]),{downsamplingLayout:v}=this;return v===Qr.FLAT?[g([t[0],t[1]]),g([t[0],t[2]]),g([t[1],t[2]])]:Qn(h2(this.shape,t,c,this.maxDownsampling,this.maxDownsamplingScales,this.maxDownsampledSize).map(b=>h(b,t,this.chunkLayoutPreference)))}getMeshSource(){let{skeletonVertexAttributes:e}=this;return e!==void 0?this.chunkManager.getChunkSource(_w,{dataSource:this.dataSource,generation:this.generation,parameters:{key:this.key,vertexAttributes:e}}):this.chunkManager.getChunkSource(Rw,{dataSource:this.dataSource,generation:this.generation,parameters:{key:this.key}})}},_w=class extends Mw(nt(Ji,oy)){get vertexAttributes(){return this.parameters.vertexAttributes}};function pJ(n){return Q(n),{dataType:U(n,"dataType",e=>yt(e,W)),numComponents:U(n,"numComponents",ct)}}function fJ(n,e,t){return e.chunkManager.memoize.getUncounted({type:"python:VolumeDataSource",key:t},async()=>{let r=await(await co(`../../neuroglancer/info/${t}`)).json(),i=new g2(n,e.chunkManager,t,r),a={modelTransform:vt(i.modelSpace),subsources:[{id:"default",default:!0,subsource:{volume:i},subsourceToModelSubspaceTransform:i.subsourceToModelTransform},{id:"bounds",default:!0,subsource:{staticAnnotations:sn(i.modelSpace.bounds)}}]};if(i.rank===3&&i.dataType!==W.FLOAT32){let o=new Float32Array(i.subsourceToModelTransform),{scales:l,rank:c}=i.modelSpace;for(let d=0;d<c;++d)o[(c+2)*d]=1/l[d];a.subsources.push({id:"meshes",default:!0,subsourceToModelSubspaceTransform:o,subsource:{mesh:e.chunkManager.getChunkSource(Rw,{dataSource:n,generation:i.generation,parameters:{key:t}})}})}return a})}function hJ(n,e,t){return e.chunkManager.memoize.getUncounted({type:"python:SkeletonDataSource",key:t},async()=>{let r=await(await co(`../../neuroglancer/skeletoninfo/${t}`)).json(),{baseModelSpace:i,subsourceToModelTransform:a}=m2(r),o=U(r,"attributes",p=>Ii(p,pJ)),l=U(r,"generation",p=>p),c=e.chunkManager.getChunkSource(_w,{dataSource:n,generation:l,parameters:{key:t,vertexAttributes:o}});return{modelTransform:vt(i),subsources:[{id:"default",subsourceToModelSubspaceTransform:a,default:!0,subsource:{mesh:c}}]}})}var Vw=class extends Rt{constructor(){super(...arguments);this.sources=new Map;this.sourceGenerations=new Map}registerSource(e,t){let r=this.sources.get(e);r===void 0&&(r=new Set,this.sources.set(e,r));let i=this.sourceGenerations.get(e);i!==void 0&&(t.generation=i),r.add(t),t.registerDisposer(()=>{r.delete(t),r.size===0&&this.sources.delete(e)})}setSourceGeneration(e,t){let{sourceGenerations:r}=this;if(r.get(e)===t)return;r.set(e,t);let i=this.sources.get(e);if(i!==void 0)for(let a of i)a.generation!==t&&(a.generation=t,a.invalidateCache())}deleteSourceGeneration(e){this.sourceGenerations.delete(e)}get description(){return"Python-served volume"}get(e){let t=e.providerUrl.match("^(volume|skeleton)/(.*)$");if(t===null)throw new Error(`Invalid Python data source URL: ${JSON.stringify(e.providerUrl)}`);let r=t[2];return t[1]==="volume"?fJ(this,e,r):hJ(this,e,r)}};var Es;(function(t){t[t.DEFAULT=0]="DEFAULT",t[t.ADDITIVE=1]="ADDITIVE"})(Es||(Es={}));var y2=new Map([[0,n=>{n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA)}],[1,n=>{n.blendFunc(n.SRC_ALPHA,n.ONE)}]]);function v2(n=0){return new cs(Es,n)}var S2=`#uicontrol invlerp normalized
void main() {
  emitGrayscale(normalized());
}
`;function b2(n=S2){return Jo(n)}function Ow(n,e){n.addFragmentCode(`
#define VOLUME_RENDERING false

void emitRGBA(vec4 rgba) {
  emit(vec4(rgba.rgb, rgba.a * uOpacity));
}
void emitRGB(vec3 rgb) {
  emit(vec4(rgb, uOpacity));
}
void emitGrayscale(float value) {
  emit(vec4(value, value, value, uOpacity));
}
void emitTransparent() {
  emit(vec4(0.0, 0.0, 0.0, 0.0));
}
`),n.addFragmentCode(Oi),Fi(e,n),n.setFragmentMainFunction(Ni(e.parseResult.code))}var Nw=class extends Rp{constructor(e,t){var o,l,c;let{opacity:r,blendMode:i,shaderControlState:a}=t;super(e,{...t,fallbackShaderParameters:new ke(Ko(io(S2,{imageData:{dataType:e.dataType,channelRank:(c=(l=(o=t.channelCoordinateSpace)==null?void 0:o.value)==null?void 0:l.rank)!=null?c:0}}))),encodeShaderParameters:d=>d.key,shaderParameters:a.builderState,dataHistogramSpecifications:a.histogramSpecifications});this.shaderControlState=a,this.opacity=r,this.blendMode=i,this.registerDisposer(r.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(i.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(a.changed.add(this.redrawNeeded.dispatch))}defineShader(e,t){if(t.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");e.addUniform("highp float","uOpacity"),Ow(e,t)}initializeShader(e,t,r){let{gl:i}=this;i.uniform1f(t.uniform("uOpacity"),this.opacity.value),ei(i,t,this.shaderControlState,r.parseResult.controls)}setGLBlendMode(e,t){let r=this.blendMode.value;r===Es.ADDITIVE||t>0?(e.enable(e.BLEND),y2.get(r)(e)):e.disable(WebGL2RenderingContext.BLEND)}};var x2="volume_rendering/VolumeRenderingRenderLayer",C2="volume_rendering/VolumeRenderingRenderLayer/update",sy=64,mJ=It.create();function w2(n,e,t){let r=0,i=0;for(let d=0;d<3;++d){let p=n[16+d],h=p*e[d],g=p*t[d];r+=Math.min(h,g),i+=Math.max(h,g)}let a=-n[19],o=Math.max(a,r),l=n[23],c=Math.min(l,i);return{near:a,far:l,adjustedNear:o,adjustedFar:c}}function Bw(n,e,t,r,i,a){if(r.length===0)return;let{viewMatrix:o,projectionMat:l,displayDimensionRenderInfo:c}=n,{voxelPhysicalScales:d}=c,p=yd(d),g=(Zf(l)/sy)**3,v=It.determinant(Hs(mJ,o)),b=D=>{let E=r[D];return Math.abs(E.chunkLayout.detTransform*v)},x=r.length-1,C=b(x);for(let D=x-1;D>=0;--D){let E=b(D);if(Math.abs(E-g)<Math.abs(C-g))C=E,x=D;else break}let T=Math.pow(C*p/v,1/3),P=Math.pow(C,1/3)*n.width/(2*l[0]),I=!0,M=r[x];Vh(n,e,M,(D,E)=>{I&&(i(M,x,T,P,E),I=!1),a(M,x,D)})}var gJ=oe.create(),yJ=new Float32Array(24),Fw=class extends Vr{get gl(){return this.multiscaleSource.chunkManager.gl}get isTransparent(){return!0}get isVolumeRendering(){return!0}constructor(e){super();this.multiscaleSource=e.multiscaleSource,this.transform=e.transform,this.channelCoordinateSpace=e.channelCoordinateSpace,this.shaderControlState=e.shaderControlState,this.localPosition=e.localPosition,this.renderScaleTarget=e.renderScaleTarget,this.renderScaleHistogram=e.renderScaleHistogram,this.registerDisposer(this.renderScaleHistogram.visibility.add(this.visibility));let t=this.registerDisposer(Mt(o=>o.rank,[this.channelCoordinateSpace]));this.shaderGetter=Vd(this,this.gl,{memoizeKey:"VolumeRenderingRenderLayer",parameters:e.shaderControlState.builderState,getContextKey:({emitter:o,chunkFormat:l})=>`${lt(o)}:${l.shaderKey}`,shaderError:e.shaderError,extraParameters:t,defineShader:(o,{emitter:l,chunkFormat:c},d,p)=>{if(d.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");Cr(o),o.addFragmentCode(`
#define VOLUME_RENDERING true
`),l(o),o.addUniform("highp float","uNearLimitFraction"),o.addUniform("highp float","uFarLimitFraction"),o.addUniform("highp int","uMaxSteps"),o.addUniform("highp vec3","uTranslation"),o.addUniform("highp mat4","uModelViewProjectionMatrix"),o.addUniform("highp mat4","uInvModelViewProjectionMatrix"),o.addUniform("highp vec3","uChunkDataSize"),o.addUniform("highp vec3","uLowerClipBound"),o.addUniform("highp vec3","uUpperClipBound"),o.addUniform("highp float","uBrightnessFactor"),o.addVarying("highp vec4","vNormalizedPosition"),o.addVertexCode(FR),o.setVertexMain(`
vec3 boxVertex = getBoxFaceVertexPosition(gl_VertexID);
vec3 position = max(uLowerClipBound, min(uUpperClipBound, uTranslation + boxVertex * uChunkDataSize));
vNormalizedPosition = gl_Position = uModelViewProjectionMatrix * vec4(position, 1.0);
gl_Position.z = 0.0;
`),o.addFragmentCode(`
vec3 curChunkPosition;
vec4 outputColor;
void userMain();
`),Cm(o,c,p,"curChunkPosition"),o.addFragmentCode(`
void emitRGBA(vec4 rgba) {
  float alpha = rgba.a * uBrightnessFactor;
  outputColor += vec4(rgba.rgb * alpha, alpha);
}
void emitRGB(vec3 rgb) {
  emitRGBA(vec4(rgb, 1.0));
}
void emitGrayscale(float value) {
  emitRGB(vec3(value, value, value));
}
void emitTransparent() {
  emitRGBA(vec4(0.0, 0.0, 0.0, 0.0));
}
`),o.setFragmentMainFunction(`
void main() {
  vec2 normalizedPosition = vNormalizedPosition.xy / vNormalizedPosition.w;
  vec4 nearPointH = uInvModelViewProjectionMatrix * vec4(normalizedPosition, -1.0, 1.0);
  vec4 farPointH = uInvModelViewProjectionMatrix * vec4(normalizedPosition, 1.0, 1.0);
  vec3 nearPoint = nearPointH.xyz / nearPointH.w;
  vec3 farPoint = farPointH.xyz / farPointH.w;
  vec3 rayVector = farPoint - nearPoint;
  vec3 boxStart = max(uLowerClipBound, uTranslation);
  vec3 boxEnd = min(boxStart + uChunkDataSize, uUpperClipBound);
  float intersectStart = uNearLimitFraction;
  float intersectEnd = uFarLimitFraction;
  for (int i = 0; i < 3; ++i) {
    float startPt = nearPoint[i];
    float endPt = farPoint[i];
    float boxLower = boxStart[i];
    float boxUpper = boxEnd[i];
    float r = rayVector[i];
    float startFraction;
    float endFraction;
    if (startPt >= boxLower && startPt <= boxUpper) {
      startFraction = 0.0;
    } else {
      startFraction = min((boxLower - startPt) / r, (boxUpper - startPt) / r);
    }
    if (endPt >= boxLower && endPt <= boxUpper) {
      endFraction = 1.0;
    } else {
      endFraction = max((boxLower - startPt) / r, (boxUpper - startPt) / r);
    }
    intersectStart = max(intersectStart, startFraction);
    intersectEnd = min(intersectEnd, endFraction);
  }
  float stepSize = (uFarLimitFraction - uNearLimitFraction) / float(uMaxSteps - 1);
  int startStep = int(floor((intersectStart - uNearLimitFraction) / stepSize));
  int endStep = min(uMaxSteps, int(floor((intersectEnd - uNearLimitFraction) / stepSize)) + 1);
  outputColor = vec4(0, 0, 0, 0);
  for (int step = startStep; step < endStep; ++step) {
    vec3 position = mix(nearPoint, farPoint, uNearLimitFraction + float(step) * stepSize);
    curChunkPosition = position - uTranslation;
    userMain();
  }
  emit(outputColor, 0u);
}
`),o.addFragmentCode(Oi),Fi(d,o),o.addFragmentCode(`
#define main userMain
`+Ni(d.parseResult.code)+`
#undef main
`)}}),this.vertexIdHelper=this.registerDisposer(Jn.get(this.gl)),this.registerDisposer(this.renderScaleTarget.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.shaderControlState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.localPosition.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.transform.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.shaderControlState.fragmentMain.changed.add(this.redrawNeeded.dispatch));let{chunkManager:r}=this.multiscaleSource,i=this.registerDisposer(new wa(this.layerChunkProgressInfo)),a=r.rpc;i.RPC_TYPE_ID=x2,i.initializeCounterpart(a,{chunkManager:r.rpcId,localPosition:this.registerDisposer(bt.makeFromExisting(a,this.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(bt.makeFromExisting(a,this.renderScaleTarget)).rpcId}),this.backend=i}get dataType(){return this.multiscaleSource.dataType}attach(e){super.attach(e),e.state={sources:e.registerDisposer(Mn((t,r,i)=>{let a=fl(i,r,o=>this.multiscaleSource.getSources(o),e.messages,this);for(let o of a)for(let l of o)t.registerDisposer(l.source);return e.view.flushBackendProjectionParameters(),this.backend.rpc.invoke(C2,{layer:this.backend.rpcId,view:e.view.rpcId,sources:ul(a)}),this.redrawNeeded.dispatch(),a},this.transform,e.view.displayDimensionRenderInfo))}}get chunkManager(){return this.multiscaleSource.chunkManager}draw(e,t){if(!e.emitColor)return;let r=t.state.sources.value;if(r.length===0)return;let i=0,a=0,o=null,l,c,d=K.create(),{gl:p}=this;this.vertexIdHelper.enable();let{renderScaleHistogram:h}=this;h.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);let g=()=>{o!==null&&(l!==null&&l.endDrawing(p,o),(C!==0||T!==0)&&h.add(i,a,C,T))},v=!0,{projectionParameters:b}=e,x,C=0,T=0,P,I=this.multiscaleSource.rank,M=K.create();p.enable(WebGL2RenderingContext.CULL_FACE),p.cullFace(WebGL2RenderingContext.FRONT),Bw(e.projectionParameters,this.localPosition.value,this.renderScaleTarget.value,r[0],(D,E,V,O)=>{i=V,a=O;let B=Nc(b,D.chunkLayout),z=D.source,{fixedPositionWithinChunk:_,chunkDisplayDimensionIndices:F}=D;for(let ye of F)_[ye]=0;let N=z.chunkFormat;if(N!==l&&(l=N,g(),c=this.shaderGetter({emitter:e.emitter,chunkFormat:N}),o=c.shader,o!==null&&(o.bind(),N!==null&&(ei(p,o,this.shaderControlState,c.parameters.parseResult.controls),N.beginDrawing(p,o),N.beginSource(p,o)))),P=void 0,o===null)return;x=z.chunks,d.fill(1);let J=oe.multiply(gJ,b.viewProjectionMat,B.transform);p.uniformMatrix4fv(o.uniform("uModelViewProjectionMatrix"),!1,J);let ae=yJ;$s(ae,J),oe.invert(J,J),p.uniformMatrix4fv(o.uniform("uInvModelViewProjectionMatrix"),!1,J);let{near:pe,far:me,adjustedNear:Ae,adjustedFar:le}=w2(ae,D.lowerClipDisplayBound,D.upperClipDisplayBound),_e=(le-Ae)/(sy-1)/(me-pe);p.uniform1f(o.uniform("uBrightnessFactor"),_e);let Fe=(Ae-pe)/(me-pe),rt=(le-pe)/(me-pe);p.uniform1f(o.uniform("uNearLimitFraction"),Fe),p.uniform1f(o.uniform("uFarLimitFraction"),rt),p.uniform1i(o.uniform("uMaxSteps"),sy),p.uniform3fv(o.uniform("uLowerClipBound"),D.lowerClipDisplayBound),p.uniform3fv(o.uniform("uUpperClipBound"),D.upperClipDisplayBound)},D=>{if(o===null)return;let E=D.curPositionInChunks.join(),V=x.get(E);if(V!==void 0&&V.state===tt.GPU_MEMORY){let O=D.chunkLayout.size,B=V.chunkDataSize,{chunkDisplayDimensionIndices:z,fixedPositionWithinChunk:_,chunkTransform:{channelToChunkDimensionIndices:F}}=D,{}=D;if(B!==P){P=B;for(let J=0;J<3;++J){let ae=z[J];d[J]=ae===-1||ae>=I?1:P[ae]}p.uniform3fv(o.uniform("uChunkDataSize"),d)}let{chunkGridPosition:N}=V;for(let J=0;J<3;++J){let ae=z[J];M[J]=ae===-1||ae>=I?0:O[J]*N[ae]}l!=null&&l.bindChunk(p,o,V,_,z,F,v),v=!1,p.uniform3fv(o.uniform("uTranslation"),M),UR(p,1,1),++C}else++T}),p.disable(WebGL2RenderingContext.CULL_FACE),g(),this.vertexIdHelper.disable()}isReady(e,t){let r=t.state.sources.value;if(r.length===0)return!0;let i=!1;return Bw(e.projectionParameters,this.localPosition.value,this.renderScaleTarget.value,r[0],()=>{},a=>{let o=a.source.chunks.get(a.curPositionInChunks.join());(o===void 0||o.state!==tt.GPU_MEMORY)&&(i=!0)}),i}};var vJ=Ie.fromObject({arrowup:{action:"tab-backward"},arrowdown:{action:"tab-forward"},tab:{action:"tab-forward"},"shift+tab":{action:"tab-backward"},enter:{action:"commit"},escape:{action:"cancel"}}),T2=class{constructor(e){this.id=e;this.element=document.createElement("div");this.nameContainer=document.createElement("div");this.nameElement=document.createElement("input");this.lowerElement=document.createElement("div");this.upperElement=document.createElement("div");let{element:t,nameContainer:r,nameElement:i,lowerElement:a,upperElement:o}=this;t.classList.add("neuroglancer-channel-dimensions-widget-dim"),r.classList.add("neuroglancer-channel-dimensions-widget-name-container"),i.classList.add("neuroglancer-channel-dimensions-widget-name"),r.appendChild(i),a.classList.add("neuroglancer-channel-dimensions-widget-lower"),o.classList.add("neuroglancer-channel-dimensions-widget-upper"),t.appendChild(r),t.appendChild(a),t.appendChild(o),r.draggable=!0,i.disabled=!0,i.spellcheck=!1,i.autocomplete="off",i.required=!0,i.placeholder=" ",r.title="Drag to reorder, double click to rename.  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",r.addEventListener("dblclick",()=>{i.disabled=!1,i.focus(),i.select()}),i.addEventListener("focus",()=>{i.select()})}},Uw=class extends H{constructor(e){super();this.combiner=e;this.element=document.createElement("div");this.dimensionWidgets=[];this.curCoordinateSpace=void 0;this.dragSource=void 0;this.coordinateSpace=this.combiner.combined;let{element:t}=this;t.classList.add("neuroglancer-channel-dimensions-widget");let r=this.registerCancellable(We(()=>this.updateView()));this.registerDisposer(e.combined.changed.add(r));let i=this.registerDisposer(new jt(t,vJ));i.allShortcutsAreGlobal=!0,this.registerDisposer(ce(t,"cancel",a=>{this.forceUpdateView();let{target:o}=a;o instanceof HTMLElement&&o.blur()})),this.updateView()}reorderDimensionTo(e,t){if(e===t)return;let{coordinateSpace:r}=this;r.value=Dh(r.value,e,t)}makeNewDimensionWidget(e){let t=new T2(e);return t.nameContainer.addEventListener("dragstart",r=>{this.dragSource=t,r.stopPropagation(),r.dataTransfer.setData("neuroglancer-dimension","")}),t.nameContainer.addEventListener("dragenter",r=>{let{dragSource:i}=this;if(i===void 0||i===t)return;let{dimensionWidgets:a}=this,o=a.indexOf(i),l=a.indexOf(t);o===-1||l===-1||(r.preventDefault(),this.reorderDimensionTo(l,o))}),t.nameContainer.addEventListener("dragend",r=>{this.dragSource===t&&(this.dragSource=void 0)}),t.nameElement.addEventListener("blur",r=>{t.nameElement.disabled=!0;let{relatedTarget:i}=r;this.dimensionWidgets.some(a=>a.nameElement===i)||this.updateNames()||this.forceUpdateView()}),t.nameElement.addEventListener("input",()=>{let{nameElement:r}=t;Tn(r),this.updateNameValidity()}),ce(t.nameElement,"commit",()=>{this.updateNames()}),ce(t.nameElement,"tab-forward",r=>this.selectAdjacentField(r,t,1)),ce(t.nameElement,"tab-backward",r=>this.selectAdjacentField(r,t,-1)),t}selectAdjacentField(e,t,r){e.stopPropagation();let{dimensionWidgets:i}=this,a=i.indexOf(t);if(a===-1)return;let o=a+r;if(o<0||o>=i.length)return;let l=i[o];l.nameElement.disabled=!1,l.nameElement.focus(),e.preventDefault()}updateNames(){let{dimensionWidgets:e,coordinateSpace:t}=this,r=t.value,i=e.map(c=>c.nameElement.value);if(this.combiner.getRenameValidity(i).includes(!1))return!1;let a=r.names;if(xe(a,i))return!1;let o=r.timestamps.map((c,d)=>a[d]===i[d]?c:Date.now()),l={...r,names:i,timestamps:o};return t.value=l,!0}updateNameValidity(){let{dimensionWidgets:e}=this,t=e.map(a=>a.nameElement.value),r=t.length,i=this.combiner.getRenameValidity(t);for(let a=0;a<r;++a)e[a].nameElement.dataset.isValid=i[a]===!1?"false":"true"}forceUpdateView(){this.curCoordinateSpace=void 0,this.updateView()}updateView(){let{coordinateSpace:{value:e}}=this;if(this.curCoordinateSpace===e)return;this.curCoordinateSpace=e;let{element:t}=this,r=this.dimensionWidgets,i=this.dimensionWidgets=e.ids.map(o=>r.find(l=>l.id===o)||this.makeNewDimensionWidget(o));function*a(){let{names:o,rank:l,bounds:{lowerBounds:c,upperBounds:d}}=e;for(let p=0;p<l;++p){let h=i[p];h.nameElement.value=o[p],delete h.nameElement.dataset.isValid,Tn(h.nameElement),h.lowerElement.textContent=c[p].toString(),h.upperElement.textContent=d[p].toString(),yield h.element}}$n(t,a.call(this))}};var Gw="opacity",Ww="blend",L2="shader",k2="shaderControls",zw="crossSectionRenderScale",E2="channelDimensions",Hw="volumeRendering",SJ="volumeRenderScale",bJ=du(bi),Ds=class extends bJ{constructor(e){super(e);this.opacity=Bl(.5);this.blendMode=v2();this.fragmentMain=b2();this.shaderError=ga();this.dataType=new ke(void 0);this.sliceViewRenderScaleHistogram=new La;this.sliceViewRenderScaleTarget=Gi(1);this.volumeRenderingRenderScaleHistogram=new La;this.volumeRenderingRenderScaleTarget=Gi(1);this.channelCoordinateSpace=new Zs;this.channelCoordinateSpaceCombiner=new Vc(this.channelCoordinateSpace,nD);this.channelSpace=this.registerDisposer(vn(e=>Il(()=>sD(e)),this.channelCoordinateSpace));this.volumeRendering=new Xe(!1,!1);this.shaderControlState=this.registerDisposer(new ao(this.fragmentMain,this.registerDisposer(Mt((e,t)=>e===void 0?null:{imageData:{dataType:e,channelRank:t.rank}},[this.dataType,this.channelCoordinateSpace],(e,t)=>JSON.stringify(e)===JSON.stringify(t))),this.channelCoordinateSpaceCombiner));this.localCoordinateSpaceCombiner.includeDimensionPredicate=Wo,this.blendMode.changed.add(this.specificationChanged.dispatch),this.opacity.changed.add(this.specificationChanged.dispatch),this.fragmentMain.changed.add(this.specificationChanged.dispatch),this.shaderControlState.changed.add(this.specificationChanged.dispatch),this.sliceViewRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.volumeRendering.changed.add(this.specificationChanged.dispatch),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new I2(this)}),this.tabs.default="rendering"}markLoading(){let e=super.markLoading(),t=this.channelCoordinateSpaceCombiner.retain();return()=>{e(),t()}}addCoordinateSpace(e){let t=super.addCoordinateSpace(e),r=this.channelCoordinateSpaceCombiner.bind(e);return()=>{t(),r()}}activateDataSubsources(e){let t;for(let r of e){if(this.addStaticAnnotations(r))continue;let{subsourceEntry:i}=r,{subsource:a}=i,{volume:o}=a;if(!(o instanceof Bt)){r.deactivate("Not compatible with image layer");continue}if(t&&o.dataType!==t){r.deactivate(`Data type must be ${W[o.dataType].toLowerCase()}`);continue}t=o.dataType,r.activate(l=>{r.addRenderLayer(new Nw(o,{opacity:this.opacity,blendMode:this.blendMode,shaderControlState:this.shaderControlState,shaderError:this.shaderError,transform:r.getRenderLayerTransform(this.channelCoordinateSpace),renderScaleTarget:this.sliceViewRenderScaleTarget,renderScaleHistogram:this.sliceViewRenderScaleHistogram,localPosition:this.localPosition,channelCoordinateSpace:this.channelCoordinateSpace}));let c=l.registerDisposer(new Fw({multiscaleSource:o,shaderControlState:this.shaderControlState,shaderError:this.shaderError,transform:r.getRenderLayerTransform(this.channelCoordinateSpace),renderScaleTarget:this.volumeRenderingRenderScaleTarget,renderScaleHistogram:this.volumeRenderingRenderScaleHistogram,localPosition:this.localPosition,channelCoordinateSpace:this.channelCoordinateSpace}));l.registerDisposer(r.messages.addChild(c.messages)),l.registerDisposer(Mn((d,p)=>{!p||d.registerDisposer(this.addRenderLayer(c.addRef()))},this.volumeRendering)),this.shaderError.changed.dispatch()})}this.dataType.value=t}restoreState(e){super.restoreState(e),this.opacity.restoreState(e[Gw]),ie(e,Ww,t=>this.blendMode.restoreState(t)),this.fragmentMain.restoreState(e[L2]),this.shaderControlState.restoreState(e[k2]),this.sliceViewRenderScaleTarget.restoreState(e[zw]),this.channelCoordinateSpace.restoreState(e[E2]),this.volumeRendering.restoreState(e[Hw])}toJSON(){let e=super.toJSON();return e[Gw]=this.opacity.toJSON(),e[Ww]=this.blendMode.toJSON(),e[L2]=this.fragmentMain.toJSON(),e[k2]=this.shaderControlState.toJSON(),e[zw]=this.sliceViewRenderScaleTarget.toJSON(),e[E2]=this.channelCoordinateSpace.toJSON(),e[Hw]=this.volumeRendering.toJSON(),e}displayImageSelectionState(e,t){let{value:r}=e;if(r==null)return!1;let i=this.channelSpace.value;if(i.error!==void 0)return!1;let{numChannels:a,coordinates:o,channelCoordinateSpace:{names:l,rank:c}}=i,d=document.createElement("div");d.classList.add("neuroglancer-selection-details-value-grid");let p="[copy] 0fr ";c!==0&&(p+=`repeat(${c}, [dim] 0fr [coord] 0fr) `),p+="[value] 1fr",d.style.gridTemplateColumns=p;for(let h=0;h<a;++h){let g=c===0?r:r[h],v=g==null?"":g.toString(),b=xr({title:"Copy value",onClick:()=>{br(v)}});d.appendChild(b);for(let C=0;C<c;++C){let T=document.createElement("div");T.classList.add("neuroglancer-selection-details-value-grid-dim"),T.textContent=l[C],d.appendChild(T);let P=document.createElement("div");P.classList.add("neuroglancer-selection-details-value-grid-coord"),P.textContent=o[h*c+C].toString(),d.appendChild(P)}let x=document.createElement("div");x.classList.add("neuroglancer-selection-details-value-grid-value"),x.textContent=v,d.appendChild(x)}return t.appendChild(d),!0}displaySelectionState(e,t,r){let i=this.displayImageSelectionState(e,t);return super.displaySelectionState(e,t,r)&&(i=!0),i}getLegendShaderOptions(){return{memoizeKey:"ImageUserLayer",parameters:this.shaderControlState.builderState,encodeParameters:e=>e.key,defineShader:(e,t)=>{e.addFragmentCode(`
#define uOpacity 1.0
`),Ow(e,t)},initializeShader:e=>{let t=e.shader;ei(this.manager.root.display.gl,t,this.shaderControlState,e.parameters.parseResult.controls)}}}};Ds.type="image",Ds.typeAbbreviation="img";function D2(n){return new So({shaderError:n.shaderError,fragmentMain:n.fragmentMain,shaderControlState:n.shaderControlState})}var P2=[{label:"Resolution (slice)",toolJson:zw,...hu(n=>({histogram:n.sliceViewRenderScaleHistogram,target:n.sliceViewRenderScaleTarget}))},{label:"Blending",toolJson:Ww,...qg(n=>n.blendMode)},{label:"Volume rendering (experimental)",toolJson:Hw,...bo(n=>n.volumeRendering)},{label:"Resolution (3d)",toolJson:SJ,isValid:n=>n.volumeRendering,...hu(n=>({histogram:n.volumeRenderingRenderScaleHistogram,target:n.volumeRenderingRenderScaleTarget}))},{label:"Opacity",toolJson:Gw,...Qi(n=>({value:n.opacity}))}];for(let n of P2)Hg(Ds,n);var I2=class extends Nt{constructor(e){super();this.layer=e;this.codeWidget=this.registerDisposer(D2(this.layer));let{element:t}=this;t.classList.add("neuroglancer-image-dropdown");for(let a of P2)t.appendChild(fu(this,e,this.visibility,a));let r=document.createElement("div");r.style.flex="1";let i=document.createElement("div");i.className="neuroglancer-image-dropdown-top-row",i.appendChild(document.createTextNode("Shader")),i.appendChild(r),i.appendChild(xs({title:"Show larger editor view",onClick:()=>{new A2(this.layer)}})),i.appendChild(bs({title:"Documentation on image layer rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/sliceview/image_layer_rendering.md"})),t.appendChild(i),t.appendChild(this.registerDisposer(new Uw(e.channelCoordinateSpaceCombiner)).element),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new xo(e.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility,legendShaderOptions:this.layer.getLegendShaderOptions()})).element)}},A2=class extends Xi{constructor(e){super();this.layer=e;this.codeWidget=this.registerDisposer(D2(this.layer));this.content.classList.add("neuroglancer-image-layer-shader-overlay"),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}};Ki(Ds);Cg(dt.IMAGE,Ds);gs(n=>{let{volume:e}=n;if(e!==void 0&&e.volumeType===dt.UNKNOWN)return{layerConstructor:Ds,priority:-100}});Ts(Ds,n=>({shaderControlState:n.shaderControlState,legendShaderOptions:n.getLegendShaderOptions()}));var M2="shader",R2="shaderControls",mu=class extends bi{constructor(e){super(e);this.managedLayer=e;this.displayState=new vx;this.vertexAttributes=new ke(void 0);this.registerDisposer(this.displayState.shaderControlState.changed.add(this.specificationChanged.dispatch)),this.registerDisposer(this.displayState.fragmentMain.changed.add(this.specificationChanged.dispatch)),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new N2(this)}),this.tabs.default="rendering"}restoreState(e){super.restoreState(e),this.displayState.fragmentMain.restoreState(e[M2]),this.displayState.shaderControlState.restoreState(e[R2])}activateDataSubsources(e){let t=!1;for(let r of e){let{subsourceEntry:i}=r,{subsource:a}=i,{singleMesh:o}=a;if(o!==void 0){if(t){r.deactivate("Only one single-mesh source supported");continue}t=!0,r.activate(l=>{r.addRenderLayer(new xx(o,this.displayState,r.getRenderLayerTransform())),this.vertexAttributes.value=o.info.vertexAttributes,l.registerDisposer(()=>{this.vertexAttributes.value=void 0})});continue}r.deactivate("Not compatible with image layer")}}toJSON(){let e=super.toJSON();return e[M2]=this.displayState.fragmentMain.toJSON(),e[R2]=this.displayState.shaderControlState.toJSON(),e}};mu.type="mesh",mu.typeAbbreviation="mesh";function _2(n){return new So({fragmentMain:n.displayState.fragmentMain,shaderError:n.displayState.shaderError,shaderControlState:n.displayState.shaderControlState})}var V2=class extends H{constructor(e){super();this.attributes=e;this.element=document.createElement("div");this.element.className="neuroglancer-single-mesh-attribute-widget",this.updateView(),this.registerDisposer(e.changed.add(()=>{this.updateView()}))}updateView(){let{element:e}=this,t=this.attributes.value;if(t===void 0){Me(e);return}let r=bx(t.map(a=>a.name)),i=t.length;for(let a=0;a<i;++a){let o=t[a],l=document.createElement("div");l.className="neuroglancer-single-mesh-attribute";let c=document.createElement("div");c.className="neuroglancer-single-mesh-attribute-type",c.textContent=Sx(o);let d=document.createElement("div");if(d.className="neuroglancer-single-mesh-attribute-name",d.textContent=r[a],l.appendChild(c),l.appendChild(d),o.min!==void 0&&o.max!==void 0){let p=document.createElement("neuroglancer-single-mesh-attribute-minmax");p.className="neuroglancer-single-mesh-attribute-range",p.textContent=`[${o.min.toPrecision(6)}, ${o.max.toPrecision(6)}]`,l.appendChild(p)}e.appendChild(l)}}disposed(){et(this.element)}};function O2(n){return new V2(n.vertexAttributes)}var N2=class extends Nt{constructor(e){super();this.layer=e;this.attributeWidget=this.registerDisposer(O2(this.layer));this.codeWidget=this.registerDisposer(_2(this.layer));let{element:t}=this;t.classList.add("neuroglancer-single-mesh-dropdown");let r=document.createElement("div");r.className="neuroglancer-single-mesh-dropdown-top-row";let i=document.createElement("div");i.style.flex="1",r.appendChild(i),r.appendChild(xs({title:"Show larger editor view",onClick:()=>{new B2(this.layer)}})),r.appendChild(bs({title:"Documentation on single mesh layer rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/sliceview/image_layer_rendering.md"})),t.appendChild(r),t.appendChild(this.attributeWidget.element),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new xo(e.displayState.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility})).element)}},B2=class extends Xi{constructor(e){super();this.layer=e;this.attributeWidget=this.registerDisposer(O2(this.layer));this.codeWidget=this.registerDisposer(_2(this.layer));this.content.classList.add("neuroglancer-single-mesh-layer-shader-overlay"),this.content.appendChild(this.attributeWidget.element),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}};Ki(mu);gs(n=>{if(n.singleMesh!==void 0)return{layerConstructor:mu,priority:2}});Ts(mu,n=>({shaderControlState:n.displayState.shaderControlState}));var F2=Ye(gt());var $w=class extends H{constructor(e){super();this.ref=e;this.element=document.createElement("label");this.selectElement=document.createElement("select");this.registerDisposer(e);let{element:t,selectElement:r}=this;t.appendChild(r),this.updateView(),this.registerEventListener(r,"change",()=>this.updateModel()),this.registerDisposer(this.ref.changed.add((0,F2.default)(()=>this.updateView(),0)))}updateModel(){this.ref.layerName=this.selectElement.value||void 0}updateView(){let{selectElement:e,ref:t}=this,{filter:r}=t;Me(e);let i=document.createElement("option");e.appendChild(i);for(let a of this.ref.layerManager.managedLayers)if(r(a)){let o=document.createElement("option"),{name:l}=a;o.textContent=l,o.value=l,e.appendChild(o)}e.value=t.layerName||""}};var xJ="points",jw="annotations",U2="annotationProperties",G2="annotationRelationships",W2="crossSectionAnnotationSpacing",z2="projectionAnnotationSpacing",H2="shader",$2="shaderControls";function CJ(n,e){e!==void 0&&ge(e,(t,r)=>{n.add({type:Be.POINT,id:""+r,point:oh(t),properties:[]})})}function wJ(n){let e=n.layer;return e===null||e instanceof Qt}function TJ(n){if(n===void 0)return null;let e=n.layer;return e===null||!(e instanceof Qt)?null:e.displayState}var j2="linkedSegmentationLayer",J2="filterBySegmentation",q2="ignoreNullSegmentFilter",Y2=class extends H{constructor(e,t,r){super();this.layerManager=e;this.annotationStates=t;this.annotationDisplayState=r;this.changed=new ne;this.curGeneration=-1;this.wasLoading=void 0;this.map=new Map;this.registerDisposer(t.changed.add(()=>this.update())),this.registerDisposer(t.isLoadingChanged.add(()=>this.update())),this.update()}update(){let e=this.annotationStates.changed.count,t=this.annotationStates.isLoading;if(this.curGeneration===e&&t===this.wasLoading)return;this.wasLoading=t,this.curGeneration=e;let{map:r}=this,i=!1;for(let a of this.annotationStates.relationships){let o=r.get(a);o===void 0&&(o=this.addRelationship(a),i=!0),o.seenGeneration=e}if(!t)for(let[a,o]of r)o.seenGeneration!==e&&(r.delete(a),i=!0);i&&this.changed.dispatch()}addRelationship(e){let t=this.annotationDisplayState.relationshipStates.get(e),r=new lC(this.layerManager.addRef(),wJ);r.registerDisposer(r.changed.add(()=>{t.segmentationState.value=r.layerName===void 0?void 0:TJ(r.layer)}));let{showMatches:i}=t,a={layerRef:r,showMatches:i,seenGeneration:-1};return r.changed.add(this.changed.dispatch),i.changed.add(this.changed.dispatch),this.map.set(e,a),a}get(e){return this.update(),this.map.get(e)}unbind(e){e.layerRef.changed.remove(this.changed.dispatch),e.showMatches.changed.remove(this.changed.dispatch)}reset(){for(let e of this.map.values())e.showMatches.reset()}toJSON(){let{map:e}=this;if(e.size===0)return{};let t,r=[];for(let[i,a]of e){a.showMatches.value&&r.push(i);let{layerName:o}=a.layerRef;o!==void 0&&((t=t||{})[i]=o)}return r.sort(),{[j2]:t,[J2]:r.length===0?void 0:r}}restoreState(e){let{isLoading:t}=this.annotationStates;ie(e,j2,r=>{typeof r=="string"&&(r={segments:r}),Q(r);for(let i of Object.keys(r)){let a=Z(r[i]),o=this.map.get(i);if(o===void 0){if(!t)continue;o=this.addRelationship(i)}o.layerRef.layerName=a}for(let[i,a]of this.map)Object.prototype.hasOwnProperty.call(r,i)||(a.layerRef.layerName=void 0)}),ie(e,J2,r=>{typeof r=="boolean"&&(r=r===!0?["segments"]:[]);for(let i of on(r)){let a=this.map.get(i);if(a===void 0){if(!t)continue;a=this.addRelationship(i)}a.showMatches.value=!0}})}disposed(){let{map:e}=this;for(let t of e.values())this.unbind(t);e.clear(),super.disposed()}},K2=class extends H{constructor(e,t){super();this.relationship=e;this.state=t;this.element=document.createElement("label");this.seenGeneration=-1;let{element:r}=this,i=this.registerDisposer(new zn(t.showMatches)),a=new $w(t.layerRef);r.appendChild(i.element),r.appendChild(document.createTextNode(e)),r.appendChild(a.element)}},X2=class extends H{constructor(e){super();this.linkedSegmentationLayers=e;this.widgets=new Map;this.element=document.createElement("div");this.element.style.display="contents";let t=this.registerCancellable(We(()=>this.updateView()));this.registerDisposer(this.linkedSegmentationLayers.annotationStates.changed.add(t)),this.updateView()}updateView(){let{linkedSegmentationLayers:e}=this,{annotationStates:t}=e,r=t.changed.count,{widgets:i}=this;function*a(){for(let o of t.relationships){let l=i.get(o);l===void 0&&(l=new K2(o,e.get(o))),l.seenGeneration=r,yield l.element}}for(let[o,l]of i)l.seenGeneration!==r&&(l.dispose(),i.delete(o));$n(this.element,a.call(this))}disposed(){super.disposed();for(let e of this.widgets.values())e.dispose()}},LJ=du(bi),Ps=class extends LJ{constructor(e){super(e);this.localAnnotationsJson=void 0;this.pointAnnotationsJson=void 0;this.linkedSegmentationLayers=this.registerDisposer(new Y2(this.manager.rootLayers,this.annotationStates,this.annotationDisplayState));this.linkedSegmentationLayers.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.ignoreNullSegmentFilter.changed.add(this.specificationChanged.dispatch),this.annotationCrossSectionRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.annotationProjectionRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new eO(this)}),this.tabs.default="annotations"}disposed(){let{localAnnotations:e}=this;e!==void 0&&e.dispose(),super.disposed()}restoreState(e){super.restoreState(e),this.linkedSegmentationLayers.restoreState(e),this.localAnnotationsJson=e[jw],this.localAnnotationProperties=ie(e,U2,dh),this.localAnnotationRelationships=ie(e,G2,on,["segments"]),this.pointAnnotationsJson=e[xJ],this.annotationCrossSectionRenderScaleTarget.restoreState(e[W2]),this.annotationProjectionRenderScaleTarget.restoreState(e[z2]),this.annotationDisplayState.ignoreNullSegmentFilter.restoreState(e[q2]),this.annotationDisplayState.shader.restoreState(e[H2]),this.annotationDisplayState.shaderControls.restoreState(e[$2])}getLegacyDataSourceSpecifications(e,t,r,i){if(Object.prototype.hasOwnProperty.call(t,"source"))return super.getLegacyDataSourceSpecifications(e,t,r,i);let a=ie(t,"voxelSize",l=>Pe(new Float64Array(3),l,c=>ot(c)/1e9)),o=["m","m","m"];if(a!==void 0){let l=Oe({rank:3,units:o,scales:a,names:["x","y","z"]});r===void 0?r={outputSpace:l,sourceRank:3,transform:void 0,inputSpace:l}:r={...r,inputSpace:l}}return[{url:mb,transform:r,enableDefaultSubsources:!0,subsources:new Map}]}activateDataSubsources(e){var a;let t=!1,r;for(let o of e){let{subsourceEntry:l}=o,{local:c}=l.subsource,d=h=>r!==void 0&&xn(h)!==xn(r)?(o.deactivate("Annotation properties are not compatible"),!1):(r=h,!0);if(c===pi.annotations){if(t){o.deactivate("Only one local annotations source per layer is supported");continue}if(t=!0,!d((a=this.localAnnotationProperties)!=null?a:[]))continue;o.activate(h=>{var b;let g=this.localAnnotations=new kd(o.loadedDataSource.transform,(b=this.localAnnotationProperties)!=null?b:[],this.localAnnotationRelationships);try{g.restoreState(this.localAnnotationsJson)}catch{}h.registerDisposer(()=>{g.dispose(),this.localAnnotations=void 0}),h.registerDisposer(this.localAnnotations.changed.add(this.specificationChanged.dispatch));try{CJ(this.localAnnotations,this.pointAnnotationsJson)}catch{}this.pointAnnotationsJson=void 0,this.localAnnotationsJson=void 0;let v=new ys({localPosition:this.localPosition,transform:h.registerDisposer(Ph(this.manager.root.coordinateSpace,this.localPosition.coordinateSpace,o.loadedDataSource.transform,void 0)),source:g.addRef(),displayState:this.annotationDisplayState,dataSource:o.loadedDataSource.layerDataSource,subsourceIndex:o.subsourceIndex,subsourceId:l.id,role:_n.ANNOTATION});this.addAnnotationLayerState(v,o)});continue}let{annotation:p}=l.subsource;if(p!==void 0){if(!d(p.properties))continue;o.activate(()=>{let h=new ys({localPosition:this.localPosition,transform:o.getRenderLayerTransform(),source:p,displayState:this.annotationDisplayState,dataSource:o.loadedDataSource.layerDataSource,subsourceIndex:o.subsourceIndex,subsourceId:l.id,role:_n.ANNOTATION});this.addAnnotationLayerState(h,o)});continue}o.deactivate("Not compatible with annotation layer")}let i=this.annotationDisplayState.annotationProperties.value;xn(i)!==xn(r)&&(this.annotationDisplayState.annotationProperties.value=r)}initializeAnnotationLayerViewTab(e){let t=e.registerDisposer(vn(i=>i.some(a=>a.source instanceof Wi),this.annotationStates)),r=e.registerDisposer(new Ln(t,(i,a,o)=>{if(!!i){{let l=o.registerDisposer(new Gp(this.annotationCrossSectionRenderScaleHistogram,this.annotationCrossSectionRenderScaleTarget));l.label.textContent="Spacing (cross section)",a.appendChild(l.element)}{let l=o.registerDisposer(new Gp(this.annotationProjectionRenderScaleHistogram,this.annotationProjectionRenderScaleTarget));l.label.textContent="Spacing (projection)",a.appendChild(l.element)}}}));e.element.insertBefore(r.element,e.element.firstChild);{let i=e.registerDisposer(new zn(this.annotationDisplayState.ignoreNullSegmentFilter)),a=document.createElement("label");a.appendChild(document.createTextNode("Ignore null related segment filter")),a.title="Display all annotations if filtering by related segments is enabled but no segments are selected",a.appendChild(i.element),e.element.appendChild(a)}e.element.appendChild(e.registerDisposer(new X2(this.linkedSegmentationLayers)).element)}toJSON(){let e=super.toJSON();e[W2]=this.annotationCrossSectionRenderScaleTarget.toJSON(),e[z2]=this.annotationProjectionRenderScaleTarget.toJSON(),this.localAnnotations!==void 0?e[jw]=this.localAnnotations.toJSON():this.localAnnotationsJson!==void 0&&(e[jw]=this.localAnnotationsJson),e[U2]=GE(this.localAnnotationProperties);let{localAnnotationRelationships:t}=this;return e[G2]=t.length===1&&t[0]==="segments"?void 0:t,e[q2]=this.annotationDisplayState.ignoreNullSegmentFilter.toJSON(),e[H2]=this.annotationDisplayState.shader.toJSON(),e[$2]=this.annotationDisplayState.shaderControls.toJSON(),Object.assign(e,this.linkedSegmentationLayers.toJSON()),e}};Ps.type="annotation",Ps.typeAbbreviation="ann";function Q2(n){return new So({shaderError:n.annotationDisplayState.shaderError,fragmentMain:n.annotationDisplayState.shader,shaderControlState:n.annotationDisplayState.shaderControls})}var Z2=class extends Xi{constructor(e){super();this.layer=e;this.codeWidget=this.registerDisposer(Q2(this.layer));this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}},eO=class extends Nt{constructor(e){super();this.layer=e;this.codeWidget=this.registerDisposer(Q2(this.layer));let{element:t}=this;t.classList.add("neuroglancer-annotation-rendering-tab"),t.appendChild(this.registerDisposer(new Ln(e.annotationDisplayState.annotationProperties,(a,o)=>{if(a===void 0||a.length===0)return;let l=document.createElement("div");o.appendChild(l),l.classList.add("neuroglancer-annotation-shader-property-list");for(let c of a){let d=document.createElement("div");d.classList.add("neuroglancer-annotation-shader-property");let p=document.createElement("span");p.classList.add("neuroglancer-annotation-shader-property-type"),p.textContent=c.type;let h=document.createElement("span");h.classList.add("neuroglancer-annotation-shader-property-identifier"),h.textContent=`prop_${c.identifier}`,d.appendChild(p),d.appendChild(h);let{description:g}=c;g!==void 0&&(d.title=g),l.appendChild(d)}})).element);let r=document.createElement("div");r.className="neuroglancer-segmentation-dropdown-skeleton-shader-header";let i=document.createElement("div");i.style.flex="1",i.textContent="Annotation shader:",r.appendChild(i),r.appendChild(xs({title:"Show larger editor view",onClick:()=>{new Z2(this.layer)}})),r.appendChild(bs({title:"Documentation on annotation rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/annotation/rendering.md"})),t.appendChild(r),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new xo(e.annotationDisplayState.shaderControls,this.layer.manager.root.display,this.layer,{visibility:this.visibility})).element)}};Ki(Ps);Ki(Ps,"pointAnnotation");gs(n=>{if(n.local===pi.annotations)return{layerConstructor:Ps,priority:100};if(n.annotation!==void 0)return{layerConstructor:Ps,priority:1}});Ts(Ps,n=>({shaderControlState:n.annotationDisplayState.shaderControls}));var G0=Ye(gt());var tO=Ye(gt()),nO=Ye(Ml());var rO=!1;function kJ(){let n=window.location.pathname.match(/^(.*)\/v\/([^\/]+)/);if(n===null)throw new Error("Failed to determine token from URL.");let e=`${window.location.origin}${n[1]}`.replace(/\/+$/,""),t=n[2];return{socket:`${e}/socket/${t}`,action:`${e}/action/${t}`,events:`${e}/events/${t}`,state:`${e}/state/${t}`,credentials:`${e}/credentials/${t}`}}var ly=class extends H{constructor(e,t,r){super();this.client=e;this.state=t;this.clientGeneration=-1;this.lastServerState="";this.lastServerGeneration="";this.needUpdate=!1;this.updateInProgress=!1;r!==null&&this.registerDisposer(t.changed.add(this.registerCancellable((0,nO.default)(this.registerCancellable((0,tO.default)(()=>this.handleStateChanged(),0)),r,{leading:!1}))))}async handleStateChanged(){if(this.needUpdate=!0,!this.updateInProgress)for(;this.needUpdate;){this.needUpdate=!1;let e=this.state.changed.count;if(e==this.clientGeneration)return;let t=Ht(this.state).value,r=JSON.stringify(t);if(r===this.lastServerState){this.clientGeneration=e;return}rO&&console.log("Sending update due to mismatch: ",{newStateEncoded:r,lastServerState:this.lastServerState,lastServerGeneration:this.lastServerGeneration});try{this.updateInProgress=!0;let i=await fetch(this.client.urls.state,{method:"POST",body:JSON.stringify({s:t,g:e,pg:this.lastServerGeneration,c:this.client.clientId})});if(this.updateInProgress=!1,i.status===200){let a=await i.json();this.lastServerState=r,this.lastServerGeneration=a.g,this.clientGeneration=e}else if(i.status===412){let a=await i.json(),o=a.s,l=a.g;this.setServerState(o,l)}else throw Sr.fromResponse(i)}catch(i){this.updateInProgress=!1,console.log("Failed to send state update",i);return}}}setServerState(e,t){let r=this.state;r.reset(),r.restoreState(e),this.lastServerState=JSON.stringify(e),this.clientGeneration=r.changed.count,this.lastServerGeneration=t}},Jw=class extends H{constructor(e,t){super();this.client=e;this.states=t;this.numConnectionFailures=0;this.status=this.registerDisposer(new Ee(!0));this.waitingToReconnect=-1;this.connect()}disposed(){var e;(e=this.eventSource)==null||e.close(),this.waitingToReconnect!==-1&&(clearInterval(this.waitingToReconnect),this.waitingToReconnect=-1)}connect(){this.status.setText("Connecting to Python server"),this.status.setVisible(!0);let e=new URL(this.client.urls.events);e.searchParams.set("c",this.client.clientId);for(let[r,i]of this.states)e.searchParams.set(`g${r}`,i.lastServerGeneration);let t=this.eventSource=new EventSource(e.toString());t.onmessage=r=>{let i=JSON.parse(r.data);rO&&console.log("got message",i);let a=i.g,o=i.k,l=i.s,c=this.states.get(o);if(c===void 0){console.log("unexpected state update for key: ",o);return}c.setServerState(l,a)},t.onerror=()=>{console.log("python state event source disconnected"),t.close(),this.eventSource=void 0;let r=Math.min(3e4,100*Math.pow(2,Math.min(20,this.numConnectionFailures))),i=Date.now()+r;++this.numConnectionFailures,this.status.setVisible(!0);let a=o=>{this.status.setText(`Disconnected from Python server.  Retrying in ${Math.ceil(o/1e3)} seconds.`)};this.waitingToReconnect=window.setInterval(()=>{let o=i-Date.now();o<0?(window.clearInterval(this.waitingToReconnect),this.waitingToReconnect=-1,this.connect()):a(o)},1e3),a(r)},t.onopen=()=>{this.status.setVisible(!1),console.log("python state event source connected"),this.numConnectionFailures=0}}},qw=class{constructor(){this.urls=kJ();this.clientId=Ks()}sendActionNotification(e,t){fetch(this.urls.action,{method:"POST",body:JSON.stringify({action:e,state:t})})}};var iO=class extends ms{constructor(e,t,r){super();this.client=e;this.key=t;this.parameters=r;this.get=Zm(async e=>{let r=await(await co(this.client.urls.credentials,{method:"POST",body:JSON.stringify({key:this.key,parameters:this.parameters,invalid:e==null?void 0:e.generation})})).json();Q(r);let i=U(r,"generation",ze),a=r.credentials;return{generation:i,credentials:a}})}},aO=class extends Lx{constructor(e){super(e,{accessToken:"",tokenType:""})}},Yw=class{constructor(e){this.client=e;this.memoize=new Ec}getCredentialsProvider(e,t){t===void 0&&(t=null);let r=xn({key:e,parameters:t});return this.memoize.get(r,()=>{let i=new iO(this.client,e,t);return e==="gcs"?new aO(i):i})}};var gu=class{constructor(){this.eventActionMap=new Ie;this.changed=new ne}reset(){this.eventActionMap.clear(),this.changed.dispatch()}restoreState(e){Q(e);let{eventActionMap:t}=this;for(let r of Object.keys(e)){let i=Z(e[r]);t.set(r,i)}this.changed.dispatch()}toJSON(){let e={};for(let[t,r]of this.eventActionMap.bindings)e[t]=r.action;return e}};var bN=Ye(gt());var cy='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-labelledby="controlsAltIconTitle"><circle cx="9" cy="6" r="2"></circle><path d="M4 6H7"></path><path d="M11 6H20"></path><circle cx="9" cy="18" r="2"></circle><path d="M4 18H7"></path><path d="M11 18H20"></path><circle cx="15" cy="12" r="2"></circle><path d="M4 12H13"></path><path d="M17 12L20 12"></path></svg>';var oO='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-labelledby="layersIconTitle"><path d="M12 4L20 8.00004L12 12L4 8.00004L12 4Z"></path><path d="M20 12L12 16L4 12"></path><path d="M20 16L12 20L4 16"></path></svg>';var sO='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="listIconTitle"><path d="M10 7L18 7M10 12L18 12M10 17L18 17"></path><line x1="7" y1="7" x2="7" y2="7"></line><line x1="7" y1="12" x2="7" y2="12"></line><line x1="7" y1="17" x2="7" y2="17"></line></svg>';var lO='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="settingsIconTitle"><path d="M5.03506429,12.7050339 C5.01187484,12.4731696 5,12.2379716 5,12 C5,11.7620284 5.01187484,11.5268304 5.03506429,11.2949661 L3.20577137,9.23205081 L5.20577137,5.76794919 L7.9069713,6.32070904 C8.28729123,6.0461342 8.69629298,5.80882212 9.12862533,5.61412402 L10,3 L14,3 L14.8713747,5.61412402 C15.303707,5.80882212 15.7127088,6.0461342 16.0930287,6.32070904 L18.7942286,5.76794919 L20.7942286,9.23205081 L18.9649357,11.2949661 C18.9881252,11.5268304 19,11.7620284 19,12 C19,12.2379716 18.9881252,12.4731696 18.9649357,12.7050339 L20.7942286,14.7679492 L18.7942286,18.2320508 L16.0930287,17.679291 C15.7127088,17.9538658 15.303707,18.1911779 14.8713747,18.385876 L14,21 L10,21 L9.12862533,18.385876 C8.69629298,18.1911779 8.28729123,17.9538658 7.9069713,17.679291 L5.20577137,18.2320508 L3.20577137,14.7679492 L5.03506429,12.7050339 Z"></path><circle cx="12" cy="12" r="1"></circle></svg>';var mN=Ye(gt());var uy=new Tx;var CO=Ye(gt());function ni(n,e){return t=>{t.style.flex=n,e(t)}}function Is(n,e){return t=>{t.style.display="flex",t.style.flexDirection=n;for(let r of e){let i=t.ownerDocument.createElement("div");t.appendChild(i),r(i)}}}var EJ=oe.create();function dy(n,e){let t=oe.identity(EJ),{globalPosition:r,displayDimensionRenderInfo:{canonicalVoxelFactors:i,displayDimensionIndices:a}}=n;for(let o=0;o<3;++o){let l=a[o];t[12+o]=l===-1?0:r[l],t[5*o]=e/i[o]}return oe.multiply(t,n.viewProjectionMat,t),t}var zl=class extends H{constructor(e){super();this.gl=e;this.vertexBuffer=this.registerDisposer(Gt.fromData(e,new Float32Array([0,0,0,1,1,0,0,1,0,0,0,1,0,1,0,1,0,0,0,1,0,0,1,1]),e.ARRAY_BUFFER,e.STATIC_DRAW));let t=.5;this.colorBuffer=this.registerDisposer(Gt.fromData(e,new Float32Array([1,0,0,t,1,0,0,t,0,1,0,t,0,1,0,t,0,0,1,t,0,0,1,t]),e.ARRAY_BUFFER,e.STATIC_DRAW)),this.trivialColorShader=this.registerDisposer(SP(e))}static get(e){return e.memoize.get("SliceViewPanel:AxesLineHelper",()=>new zl(e))}draw(e,t=!0){let r=this.trivialColorShader,i=this.gl;r.bind(),i.uniformMatrix4fv(r.uniform("uProjectionMatrix"),!1,e);let a=r.attribute("aVertexPosition");this.vertexBuffer.bindToVertexAttrib(a,4);let o=r.attribute("aColor");this.colorBuffer.bindToVertexAttrib(o,4),t&&(i.colorMask(!1,!1,!1,!0),i.clearColor(0,0,0,0),i.clear(i.COLOR_BUFFER_BIT),i.colorMask(!0,!0,!0,!0),i.enable(i.BLEND),i.blendFunc(i.ONE_MINUS_DST_ALPHA,i.DST_ALPHA)),i.lineWidth(1),i.drawArrays(i.LINES,0,6),t&&i.disable(i.BLEND),i.disableVertexAttribArray(a),i.disableVertexAttribArray(o)}};var cO="perspective_view/PerspectiveView";var uO=!1,zp=class{constructor(){this.renderLayers=[null];this.pickData=[null];this.values=[0,0,0];this.nextPickID=1}clear(){this.renderLayers.length=1,this.pickData.length=1,this.values.length=3,this.nextPickID=1}registerUint64(e,t,r=1,i=null){return this.register(e,r,t.low,t.high,i)}register(e,t=1,r=0,i=0,a=null){let{renderLayers:o,values:l}=this,c=this.nextPickID;this.nextPickID+=t;let d=o.length;o[d]=e;let p=d*3;return l[p]=c,l[p+1]=r,l[p+2]=i,this.pickData[d]=a,c}setMouseState(e,t){let{renderLayers:r,values:i}=this,a=0,o=r.length-1;for(;a<o;){let g=Math.ceil(a+(o-a)/2);i[g*3]>t?o=g-1:a=g}let l=e.pickedRenderLayer=r[a],c=a*3,d=e.pickedOffset=t-i[c];uO&&console.log(`Looking up pick ID ${t}: renderLayer`,l,`offset=${d}`);let{pickedValue:p}=e;p.low=i[c+1],p.high=i[c+2],e.pickedAnnotationId=void 0,e.pickedAnnotationLayer=void 0,e.pickedAnnotationBuffer=void 0,e.pickedAnnotationBufferBaseOffset=void 0,e.pickedAnnotationIndex=void 0,e.pickedAnnotationCount=void 0,e.pickedAnnotationType=void 0;let h=this.pickData[a];l!==null&&(uO&&console.log(`Picked value=${p}, offset=${d}, data=${this.pickData[a]}`),l.updateMouseState(e,p,d,h))}};var dO=Ye(Ml());var pO=10,DJ=1e3,PJ=400,IJ=500,AJ=Math.PI/20,MJ=20,RJ=10;function fO(n,e){return Math.sqrt(n*n+e*e)}function hO(n){let[e,t]=n;e.identifier>t.identifier&&([t,e]=[e,t]);let r=e.clientX-t.clientX,i=e.clientY-t.clientY,a=fO(r,i),o=Math.atan2(r,i);return{distance:a,angle:o}}function _J(n,e){let t=Math.PI*2,r=Math.abs(n-e)%t;return Math.min(r,t-r)}var Kw=class extends H{constructor(e,t){super();this.target=e;this.eventMap=t;this.prevTouches=new Map;this.moved=!1;this.prevAngle=0;this.rotated=!1;this.prevDistance=0;this.pinched=!1;this.prevCenterX=0;this.prevCenterY=0;this.translated=!1;this.startHold=this.registerCancellable((0,dO.default)((e,t,r,i)=>{let a={event:e,centerX:r,centerY:i};this.dispatch(`touchhold${e.targetTouches.length}`,e,a,t)},DJ,{leading:!1,trailing:!0}));this.numPriorTaps=0;this.priorTapNumTouches=0;this.tapStartTime=0;this.tapEndTime=0;this.curTapNumTouches=0;this.registerEventListener(e,"touchstart",r=>{this.handleTouchEvent(r)}),this.registerEventListener(e,"touchmove",r=>{this.handleTouchEvent(r)}),this.registerEventListener(e,"touchend",r=>{this.handleTouchEvent(r)})}dispatch(e,t,r,i=t.eventPhase){Pb(e,t,i,r,this.eventMap)}handleTouchEvent(e){if(e.target===this.target)e.preventDefault();else return;let t=new Map,{prevTouches:r,prevEvent:i}=this,a=0,o=0;for(let g of e.targetTouches)t.set(g.identifier,g),a+=g.clientX,o+=g.clientY;a/=t.size,o/=t.size;for(let[g,v]of r.entries()){let b=t.get(g);if(b===void 0)r.delete(g);else{let x=b.clientX-v.clientX,C=b.clientY-v.clientY;(Math.abs(x)>=pO||Math.abs(C)>=pO)&&(this.moved=!0)}}if(i===void 0||i.targetTouches.length!==t.size||t.size==0){if(this.moved=!1,e.type==="touchstart")this.startHold(e,e.eventPhase,a,o),(i===void 0||i.targetTouches.length===0)&&(this.tapStartTime=Date.now(),this.curTapNumTouches=0),this.curTapNumTouches=Math.max(this.curTapNumTouches,e.targetTouches.length);else{if(e.type=="touchend"){let g=Date.now();if(e.targetTouches.length===0&&g-this.tapStartTime<PJ){(this.curTapNumTouches!==this.priorTapNumTouches||g-this.tapEndTime>=IJ)&&(this.numPriorTaps=0),++this.numPriorTaps,this.tapEndTime=g,this.priorTapNumTouches=this.curTapNumTouches;let v={event:e,centerX:a,centerY:o};this.dispatch(`touchtap${this.curTapNumTouches}x${this.numPriorTaps}`,e,v)}}this.startHold.cancel()}if(this.prevTouches=t,this.prevEvent=e,this.prevCenterX=a,this.prevCenterY=o,this.translated=!1,t.size===2){let{distance:g,angle:v}=hO(t.values());this.prevDistance=g,this.prevAngle=v,this.rotated=!1,this.pinched=!1}return}if(!this.moved)return;this.tapStartTime=0,this.startHold.cancel(),this.prevTouches=t,this.prevEvent=e;let{prevCenterX:l,prevCenterY:c,translated:d}=this,p=a-l,h=o-c;if(d===!1&&fO(p,h)>=RJ&&(d=this.translated=!0),d===!0&&(p!==0||h!==0)){this.prevCenterX=a,this.prevCenterY=o;let g={event:e,deltaX:p,deltaY:h,centerX:a,centerY:o};this.dispatch(`touchtranslate${t.size}`,e,g)}if(t.size===2){let{distance:g,angle:v}=hO(t.values()),{pinched:b,rotated:x,prevDistance:C,prevAngle:T}=this;b===!1&&Math.abs(g-C)>=MJ&&(this.pinched=b=!0);let P=_J(v,T);if(x===!1&&P>=AJ&&(this.rotated=x=!0),b===!0&&g!=C){this.prevDistance=g;let I={event:e,distance:g,prevDistance:C,centerX:a,centerY:o};this.dispatch("touchpinch",e,I)}x===!0&&v!==T&&(this.prevAngle=v,this.dispatch("touchrotate",e,{event:e,centerX:a,centerY:o,angle:v,prevAngle:T}))}}};var Xw=K.create(),Qw=class{constructor(){this.pickIDs=new zp;this.viewportWidth=0;this.viewportHeight=0;this.invTransform=oe.create();this.frameNumber=-1}},Zw=class{constructor(){this.buffer=null;this.glWindowX=0;this.glWindowY=0}},VJ=30,pn=5,pt=1+pn*2,yu=(()=>{let n=pn**2,e=(i,a)=>(i-pn)**2+(a-pn)**2,t=new Uint32Array(pt*pt),r=0;for(let i=0;i<pt;++i)for(let a=0;a<pt;++a)e(i,a)>n||(t[r++]=a*pt+i);return t=t.subarray(0,r),t.sort((i,a)=>{let o=i%pt,l=(i-o)/pt,c=a%pt,d=(a-c)/pt;return e(o,l)-e(c,d)}),t})();function py(n,e,t,r,i,a,o){let l=r-pn,c=i-pn;if(!(l>=0&&c>=0&&l+pt<=a&&c+pt<=o))for(let d=0;d<pt;++d)for(let p=0;p<pt;++p){let h=l+p,g=c+d;(h<0||g<0||h>=a||g>=o)&&(n[e+(g*pt+h)*t]=0)}}var Hp=class extends gh{constructor(e,t,r){super(e,t,r.visibility);this.viewer=r;this.mouseX=-1;this.mouseY=-1;this.pickRequestPending=!1;this.mouseStateForcer=()=>this.blockOnPickRequest();this.pickingData=[new Qw,new Qw];this.pickRequests=[new Zw,new Zw];this.pickBufferContents=new Float32Array(2*4*pt*pt);this.pickTimerId=-1;this.nextPickRequestTime=0;this.pendingPickRequestTimerId=-1;this.pendingPickRequestTimerExpired=()=>{this.pendingPickRequestTimerId=-1,!!this.pickRequestPending&&this.attemptToIssuePickRequest()};this.inputEventMap=r.inputEventMap,t.classList.add("neuroglancer-rendered-data-panel"),t.classList.add("neuroglancer-panel"),t.classList.add("neuroglancer-noselect"),typeof NEUROGLANCER_SHOW_OBJECT_SELECTION_TOOLTIP!="undefined"&&NEUROGLANCER_SHOW_OBJECT_SELECTION_TOOLTIP===!0&&(t.title="Double click to toggle display of object under mouse pointer.  Control+rightclick to pin/unpin selection."),this.registerDisposer(new vo(t)),this.registerDisposer(new jt(t,this.inputEventMap)),this.registerDisposer(new kn(t,this.inputEventMap,i=>{this.onMousemove(i)})),this.registerDisposer(new Kw(t,this.inputEventMap)),this.registerEventListener(t,"mousemove",this.onMousemove.bind(this)),this.registerEventListener(t,"touchstart",this.onTouchstart.bind(this)),this.registerEventListener(t,"mouseleave",()=>this.onMouseout()),this.registerEventListener(t,"mouseover",i=>{i.target!==t&&this.onMouseout()},!0),ce(t,"select-position",()=>{this.viewer.selectionDetailsState.select()}),ce(t,"snap",()=>{this.navigationState.pose.snap()}),ce(t,"zoom-in",()=>{this.navigationState.zoomBy(.5)}),ce(t,"zoom-out",()=>{this.navigationState.zoomBy(2)}),ce(t,"depth-range-decrease",()=>{this.navigationState.depthRange.value*=.5}),ce(t,"depth-range-increase",()=>{this.navigationState.depthRange.value*=2});for(let i=0;i<3;++i){let a=mE[i];for(let o of[-1,1]){let l=o<0?"-":"+";ce(t,`rotate-relative-${a}${l}`,()=>{this.navigationState.pose.rotateRelative($r[i],o*.1)});let c=K.create();ce(t,`${a}${l}`,()=>{let{navigationState:d}=this,p=c;p[0]=0,p[1]=0,p[2]=0,p[i]=o,d.pose.translateVoxelsRelative(p,!0)})}}ce(t,"zoom-via-wheel",i=>{let a=i.detail;this.onMousemove(a,!1),this.zoomByMouse(pu(a))}),ce(t,"adjust-depth-range-via-wheel",i=>{let a=i.detail;this.navigationState.depthRange.value*=pu(a)}),ce(t,"translate-via-mouse-drag",i=>{un(i.detail,(a,o,l)=>{this.translateByViewportPixels(o,l)})}),ce(t,"translate-in-plane-via-touchtranslate",i=>{let{detail:a}=i;this.translateByViewportPixels(a.deltaX,a.deltaY)}),ce(t,"translate-z-via-touchtranslate",i=>{let{detail:a}=i,{navigationState:o}=this,l=Xw;l[0]=0,l[1]=0,l[2]=a.deltaY+a.deltaX,o.pose.translateVoxelsRelative(l,!0)});for(let i of[1,10])ce(t,`z+${i}-via-wheel`,a=>{let o=a.detail,{navigationState:l}=this,c=Xw,d=o.deltaY!==0?o.deltaY:o.deltaX;c[0]=0,c[1]=0,c[2]=(d>0?-1:1)*i,l.pose.translateVoxelsRelative(c,!0)});ce(t,"move-to-mouse-position",()=>{let{mouseState:i}=this.viewer;i.updateUnconditionally()&&(this.navigationState.position.value=i.position)}),ce(t,"snap",()=>this.navigationState.pose.snap()),ce(t,"move-annotation",i=>{let{mouseState:a}=this.viewer,o=a.pickedAnnotationId,l=a.pickedAnnotationLayer;if(l!==void 0&&o!==void 0){i.stopPropagation();let c=l.source.getReference(o),d=c.value,p=Qo(d.type),h=a.pickedOffset,{chunkTransform:{value:g}}=l;if(g.error!==void 0)return;let{layerRank:v}=g,b=new Float32Array(v);p.getRepresentativePoint(b,d,a.pickedOffset);let x=hr.set(hr.create(),0,0);a.updateUnconditionally()&&un(i.detail,(C,T,P)=>{hr.add(x,x,[T,P]);let I=new Float32Array(v);Kr(I,g.chunkToLayerTransform,v+1,b,v);let M=Xw,{displayDimensionIndices:D}=this.navigationState.pose.displayDimensions.value;lD(M,I,g.modelTransform,D),this.translateDataPointByViewportPixels(M,M,x[0],x[1]),cD(I,M,g.modelTransform,D);let E=new Float32Array(v);Kr(E,g.layerToChunkTransform,v+1,I,v);let V=p.updateViaRepresentativePoint(d,E,h);l.source.update(c,V)},C=>{l.source.commit(c),c.dispose()})}}),ce(t,"delete-annotation",()=>{let{mouseState:i}=this.viewer,a=i.pickedAnnotationId,o=i.pickedAnnotationLayer;if(o!==void 0&&!o.source.readonly&&a!==void 0){let l=o.source.getReference(a);try{o.source.delete(l)}finally{l.dispose()}}}),ce(t,"zoom-via-touchpinch",i=>{let{detail:a}=i;this.handleMouseMove(a.centerX,a.centerY);let o=a.prevDistance/a.distance;o>.1&&o<10&&this.zoomByMouse(o)})}cancelPickRequests(){let{gl:e}=this;for(let t of this.pickRequests){let{sync:r}=t;r!==null&&e.deleteSync(r),t.sync=null}clearTimeout(this.pickTimerId),this.pickTimerId=-1}issuePickRequestInternal(e){let{gl:t}=this,{buffer:r}=e;r===null?(r=e.buffer=t.createBuffer(),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,r),t.bufferData(WebGL2RenderingContext.PIXEL_PACK_BUFFER,2*4*4*pt*pt,WebGL2RenderingContext.STREAM_READ)):t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,r);let{renderViewport:i}=this,a=this.mouseX-i.visibleLeftFraction*i.logicalWidth,o=i.height-(this.mouseY-i.visibleTopFraction*i.logicalHeight);this.issuePickRequest(a,o),e.sync=t.fenceSync(WebGL2RenderingContext.SYNC_GPU_COMMANDS_COMPLETE,0),e.frameNumber=this.context.frameNumber,e.glWindowX=a,e.glWindowY=o,t.flush(),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,null),this.pickTimerId===-1&&this.scheduleCheckForPickRequestCompletion(),this.pickRequestPending=!1;let{pickRequests:l}=this;e!==l[0]&&(l[1]=l[0],l[0]=e),this.nextPickRequestTime=Date.now()+VJ}completePickInternal(e){let{gl:t}=this,{pickBufferContents:r}=this;t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,e.buffer),t.getBufferSubData(WebGL2RenderingContext.PIXEL_PACK_BUFFER,0,r),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,null);let{pickingData:i}=this,{frameNumber:a}=e;this.completePickRequest(e.glWindowX,e.glWindowY,r,i[0].frameNumber===a?i[0]:i[1])}scheduleCheckForPickRequestCompletion(){this.pickTimerId=window.setTimeout(()=>{this.pickTimerId=-1,this.checkForPickRequestCompletion()},0)}checkForPickRequestCompletion(e=!1,t=!1){let r=this.context.frameNumber,i=-1;e&&(--r,i=r-1);let{pickRequests:a}=this,{gl:o}=this,l=!1,c=!1,d;for(let h of a){let{sync:g}=h;if(g===null)continue;let{frameNumber:v}=h;if(!c&&v>=r-1){if(t||o.getSyncParameter(g,WebGL2RenderingContext.SYNC_STATUS)===WebGL2RenderingContext.SIGNALED)this.completePickInternal(h),c=!0;else if(v!==i){l=!0;continue}}o.deleteSync(g),h.sync=null,d=h}let{pickTimerId:p}=this;l&&p===-1?this.scheduleCheckForPickRequestCompletion():!l&&p!==-1&&(window.clearTimeout(p),this.pickTimerId=-1),!e&&d!==void 0&&this.pickRequestPending&&this.canIssuePickRequest()&&this.issuePickRequestInternal(d)}blockOnPickRequest(){this.pickRequestPending&&(this.cancelPickRequests(),this.nextPickRequestTime=0,this.attemptToIssuePickRequest()),this.checkForPickRequestCompletion(!1,!0)}draw(){let{width:e,height:t}=this.renderViewport;this.checkForPickRequestCompletion(!0);let{pickingData:r}=this;r[0]=r[1];let i=this.context.frameNumber,a=r[1];if(a.frameNumber=i,a.viewportWidth=e,a.viewportHeight=t,a.pickIDs.clear(),!this.drawWithPicking(a)){a.frameNumber=-1;return}this.nextPickRequestTime=0,this.mouseX>=0&&this.attemptToIssuePickRequest()}canIssuePickRequest(){let e=Date.now(),{nextPickRequestTime:t,pendingPickRequestTimerId:r}=this;return e<t?(r==-1&&(this.pendingPickRequestTimerId=window.setTimeout(this.pendingPickRequestTimerExpired,t-e)),!1):!0}attemptToIssuePickRequest(){if(!this.canIssuePickRequest())return;let e=this.context.frameNumber,{gl:t}=this,{pickRequests:r}=this;for(let i of r){let{sync:a}=i;if(a!==null)if(i.frameNumber<e-1)t.deleteSync(a);else continue;this.issuePickRequestInternal(i);return}}updateMousePosition(e,t){if(e===this.mouseX&&t===this.mouseY)return;if(this.mouseX=e,this.mouseY=t,e<0){this.pickRequestPending=!1,this.cancelPickRequests();return}let r=this.context.frameNumber,i=this.pickingData[1];i.frameNumber!==r||this.renderViewport.width!==i.viewportWidth||this.renderViewport.height!==i.viewportHeight||(this.pickRequestPending=!0,this.attemptToIssuePickRequest())}onMouseout(){this.updateMousePosition(-1,-1),this.viewer.mouseState.setForcer(void 0)}handleMouseMove(e,t){let{element:r}=this,i=r.getBoundingClientRect(),a=e-(i.left+r.clientLeft),o=t-(i.top+r.clientTop),{mouseState:l}=this.viewer;l.pageX=e+window.scrollX,l.pageY=t+window.scrollY,l.setForcer(this.mouseStateForcer),this.updateMousePosition(a,o)}onMousemove(e,t=!0){let{element:r}=this;t&&e.target!==r||this.handleMouseMove(e.clientX,e.clientY)}onTouchstart(e){let{element:t}=this;if(e.target!==t||e.targetTouches.length!==1)return;let{clientX:r,clientY:i}=e.targetTouches[0];this.handleMouseMove(r,i)}disposed(){let{mouseState:e}=this.viewer;e.removeForcer(this.mouseStateForcer);let{gl:t}=this;this.cancelPickRequests();let{pendingPickRequestTimerId:r}=this;r!==-1&&window.clearTimeout(r);for(let i of this.pickRequests)t.deleteBuffer(i.buffer);super.disposed()}};var OJ=[1.5,2,3,5,7.5,10];var mO=class{constructor(){this.allowedSignificands=OJ;this.targetLengthInPixels=0;this.physicalSizePerPixel=0;this.prevPhysicalSizePerPixel=0;this.prevTargetLengthInPixels=0;this.prevPhysicalUnit="\0"}update(){let{physicalSizePerPixel:e,targetLengthInPixels:t}=this;if(this.prevPhysicalSizePerPixel===e&&this.prevTargetLengthInPixels===t&&this.prevPhysicalUnit===this.physicalUnit)return!1;this.prevPhysicalSizePerPixel=e,this.prevTargetLengthInPixels=t,this.prevPhysicalUnit=this.physicalUnit;let r=t*e,i=Math.floor(Math.log10(r)),a=10**i,o=r/a,l=1;for(let p of this.allowedSignificands)if(Math.abs(p-o)<Math.abs(l-o))l=p;else break;let c=l*a,d=uS(c);return this.lengthInPixels=Math.round(c/e),this.physicalUnit=`${d.prefix}${this.physicalBaseUnit}`,this.physicalLength=l*10**(i-d.exponent),!0}};function NJ(n,e,t,r,i){let a=document.createElement("canvas"),o=a.getContext("2d"),l=i.textHeightInPixels*i.scaleFactor,c=`bold ${l}px ${i.fontName}`;o.font=c,o.fillStyle="white";let d=`${r}${n.physicalLength} ${n.physicalUnit}`,p=o.measureText(d),h=Math.max(n.lengthInPixels,p.width),g=i.barHeightInPixels*i.scaleFactor,v=i.barTopMarginInPixels*i.scaleFactor,b=g+v+l,x=i.paddingInPixels*i.scaleFactor,C=b+2*x,T=h+2*x;return a.width=T,a.height=C,o.font=c,o.textAlign="center",o.fillStyle="rgba(0, 0, 0, 0.3)",o.fillRect(0,0,T,C),o.fillStyle="white",o.fillText(d,T/2,C-x-g-v),o.fillRect(x,C-x-g,n.lengthInPixels,g),yP(e,t,a),{width:T,height:C}}var gO=class extends H{constructor(e,t=new mO){super();this.gl=e;this.dimensions=t;this.texture=null;this.width=0;this.height=0;this.label="";this.factor=1;this.priorOptions=void 0;this.prevLabel=""}update(e){let{dimensions:t,label:r}=this,{texture:i}=this;if(!t.update()&&i!==null&&e===this.priorOptions&&r==this.prevLabel)return;i===null&&(i=this.texture=this.gl.createTexture());let{width:a,height:o}=NJ(t,this.gl,i,r,e);this.priorOptions=e,this.prevLabel=r,this.width=a,this.height=o}disposed(){this.gl.deleteTexture(this.texture),this.texture=null,super.disposed()}},$p=class extends H{constructor(e){super();this.gl=e;this.scaleBarCopyHelper=this.registerDisposer(Sa.get(this.gl));this.scaleBars=[];for(let t=0;t<3;++t)this.scaleBars.push(this.registerDisposer(new gO(e)))}draw(e,t,r,i,a){let{scaleBars:o}=this,{displayRank:l,displayDimensionIndices:c,canonicalVoxelFactors:d,globalDimensionNames:p,displayDimensionUnits:h,displayDimensionScales:g}=t,{factors:v}=r,b=Math.min(a.maxWidthFraction*e.logicalWidth,a.maxWidthInPixels*a.scaleFactor),x=0;for(let I=0;I<l;++I){let M=c[I],D=h[I],E=v[M],V,O,B;for(V=0;V<x&&(O=o[V],B=O.dimensions,!(B.physicalBaseUnit===D&&O.factor===E));++V);V===x&&(++x,O=o[V],O.label="",B=O.dimensions,O.factor=E,B.physicalBaseUnit=D,B.targetLengthInPixels=b,B.physicalSizePerPixel=g[I]*i/d[I]),O.label+=`${p[M]} `}let{gl:C,scaleBarCopyHelper:T}=this,P=a.bottomPixelOffset*a.scaleFactor;for(let I=x-1;I>=0;--I){let M=o[I];x===1?M.label="":M.label+=": ",M.update(a),C.viewport(a.leftPixelOffset*a.scaleFactor-e.visibleLeftFraction*e.logicalWidth,P-(1-(e.visibleTopFraction+e.visibleHeightFraction))*e.logicalHeight,M.width,M.height),T.draw(M.texture),P+=M.height+a.marginPixelsBetweenScaleBars*a.scaleFactor}}},BJ={scaleFactor:1,textHeightInPixels:15,barHeightInPixels:8,barTopMarginInPixels:5,fontName:"sans-serif",paddingInPixels:2},yO={...BJ,maxWidthInPixels:100,maxWidthFraction:.25,leftPixelOffset:10,bottomPixelOffset:10,marginPixelsBetweenScaleBars:5};function FJ(n){let e={...yO};for(let t of["textHeightInPixels","barTopMarginInPixels","barHeightInPixels","paddingInPixels","scaleFactor","maxWidthInPixels","maxWidthFraction","leftPixelOffset","bottomPixelOffset"])U(n,t,r=>{r!==void 0&&(e[t]=bn(r))});return U(n,"fontName",t=>{t!==void 0&&(e.fontName=Z(t))}),e}var e0=class extends Ce{constructor(){super(yO,FJ)}};var ri;(function(i){i[i.COLOR=0]="COLOR",i[i.Z=1]="Z",i[i.PICK=2]="PICK",i[i.NUM_TEXTURES=3]="NUM_TEXTURES"})(ri||(ri={}));var UJ=`
void emit(vec4 color, highp uint pickId) {
  out_color = color;
  float zValue = 1.0 - gl_FragCoord.z;
  out_z = vec4(zValue, zValue, zValue, 1.0);
  float pickIdFloat = float(pickId);
  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);
}
`,GJ=`
float computeOITWeight(float alpha) {
  float a = min(1.0, alpha) * 8.0 + 0.01;
  float b = -gl_FragCoord.z * 0.95 + 1.0;
  return a * a * a * b * b * b;
}
`,WJ=[GJ,`
void emit(vec4 color, highp uint pickId) {
  float weight = computeOITWeight(color.a);
  vec4 accum = color * weight;
  v4f_fragData0 = vec4(accum.rgb, color.a);
  v4f_fragData1 = vec4(accum.a, 0.0, 0.0, 0.0);
}
`];function t0(n){n.addOutputBuffer("vec4","out_color",0),n.addOutputBuffer("highp vec4","out_z",1),n.addOutputBuffer("highp vec4","out_pickId",2),n.addFragmentCode(UJ)}function zJ(n){n.addOutputBuffer("vec4","v4f_fragData0",0),n.addOutputBuffer("vec4","v4f_fragData1",1),n.addFragmentCode(WJ)}var Co=K.create(),vO=an.create(),HJ=oe.create();function $J(n){n.addOutputBuffer("vec4","v4f_fragColor",null),n.setFragmentMain(`
vec4 v0 = getValue0();
vec4 v1 = getValue1();
vec4 accum = vec4(v0.rgb, v1.r);
float revealage = v0.a;

v4f_fragColor = vec4(accum.rgb / accum.a, revealage);
`)}var jJ=ya(Cn),SO=class extends jJ{constructor(e){super();this.panel=e}initializeCounterpart(e,t){this.sharedProjectionParameters=this.registerDisposer(new cl(e,this.panel.projectionParameters)),t.projectionParameters=this.sharedProjectionParameters.rpcId,super.initializeCounterpart(e,t)}},jp=class extends Hp{constructor(e,t,r){super(e,t,r);this.sliceViews=this.registerDisposer(new Fl((e,t,r)=>{e.registerDisposer(r),e.registerDisposer(r.visibility.add(this.visibility))}));this.axesLineHelper=this.registerDisposer(zl.get(this.gl));this.sliceViewRenderHelper=this.registerDisposer(pl.get(this.gl,t0));this.offscreenFramebuffer=this.registerDisposer(new Bi(this.gl,{colorBuffers:[new va(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new va(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT),new va(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)],depthBuffer:new qS(this.gl)}));this.offscreenCopyHelper=this.registerDisposer(Sa.get(this.gl));this.transparencyCopyHelper=this.registerDisposer(Sa.get(this.gl,$J,2));this.scaleBars=this.registerDisposer(new $p(this.gl));this.projectionParameters=this.registerDisposer(new jd({navigationState:this.navigationState,update:(a,o)=>{let{invViewMatrix:l,projectionMat:c,logicalWidth:d,logicalHeight:p}=a,h=d/p,g=Math.PI/4,{relativeDepthRange:v}=o,x=o.zoomFactor.value/2;if(this.viewer.orthographicProjection.value){let C=Math.max(.1,1-v),T=1+v;oe.ortho(c,-h,h,-1,1,C,T)}else{let C=1/Math.tan(g/2);v/=C;let T=Math.max(.1,1-v),P=1+v;x*=C,oe.perspective(c,g,h,T,P)}hh(a,c),o.pose.toMat4(l,x),oe.scale(l,l,K.set(Co,1,-1,-1)),oe.translate(l,l,$r[2]),Sh(a)}})),this.projectionParameters.changed.add(()=>this.context.scheduleRedraw());let i=this.sharedObject=this.registerDisposer(new SO(this));if(i.RPC_TYPE_ID=cO,i.initializeCounterpart(r.rpc,{}),i.visibility.add(this.visibility),this.visibleLayerTracker=bg(this.viewer.layerManager,Vr,this.viewer.visibleLayerRoles,this),ce(t,"rotate-via-mouse-drag",a=>{un(a.detail,(o,l,c)=>{this.navigationState.pose.rotateRelative($r[1],l/4*Math.PI/180),this.navigationState.pose.rotateRelative($r[0],-c/4*Math.PI/180)})}),ce(t,"rotate-in-plane-via-touchrotate",a=>{let{detail:o}=a;this.navigationState.pose.rotateRelative($r[2],o.angle-o.prevAngle)}),ce(t,"rotate-out-of-plane-via-touchtranslate",a=>{let{detail:o}=a;this.navigationState.pose.rotateRelative($r[1],o.deltaX/4*Math.PI/180),this.navigationState.pose.rotateRelative($r[0],-o.deltaY/4*Math.PI/180)}),r.showSliceViewsCheckbox){let a=this.registerDisposer(new zn(r.showSliceViews));a.element.className="perspective-panel-show-slice-views neuroglancer-noselect";let o=document.createElement("label");o.className="perspective-panel-show-slice-views neuroglancer-noselect",o.appendChild(document.createTextNode("Sections")),o.appendChild(a.element),this.element.appendChild(o)}this.registerDisposer(r.orthographicProjection.changed.add(()=>{this.projectionParameters.update(),this.scheduleRedraw()})),this.registerDisposer(r.showScaleBar.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.scaleBarOptions.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.showSliceViews.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.showAxisLines.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.crossSectionBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.perspectiveViewBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.wireFrame.changed.add(()=>this.scheduleRedraw())),this.sliceViews.changed.add(()=>this.scheduleRedraw())}get rpc(){return this.sharedObject.rpc}get rpcId(){return this.sharedObject.rpcId}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}flushBackendProjectionParameters(){this.sharedObject.sharedProjectionParameters.flush()}translateByViewportPixels(e,t){let r=Co,{viewProjectionMat:i,invViewProjectionMat:a,logicalWidth:o,logicalHeight:l}=this.projectionParameters.value,{pose:c}=this.viewer.navigationState;c.updateDisplayPosition(d=>{K.transformMat4(r,d,i),r[0]+=-2*e/o,r[1]+=2*t/l,K.transformMat4(d,r,a)})}get navigationState(){return this.viewer.navigationState}ensureBoundsUpdated(){super.ensureBoundsUpdated(),this.projectionParameters.setViewport(this.renderViewport)}isReady(){if(!this.visible)return!0;for(let[o,l]of this.sliceViews)if((l||this.viewer.showSliceViews.value)&&!o.isReady())return!1;this.ensureBoundsUpdated();let{width:e,height:t}=this.renderViewport;if(e===0||t===0)return!0;let i={projectionParameters:this.projectionParameters.value},{visibleLayers:a}=this.visibleLayerTracker;for(let[o,l]of a)if(!o.isReady(i,l))return!1;return!0}disposed(){this.sliceViews.clear(),super.disposed()}getDepthArray(){if(!this.navigationState.valid)return;let{offscreenFramebuffer:e,renderViewport:{width:t,height:r}}=this,i=t*r,a=new Float32Array(i*4);try{e.bindSingle(1),this.gl.readPixels(0,0,t,r,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,a)}finally{e.framebuffer.unbind()}let o=new Float32Array(i);for(let l=0;l<i;++l)o[l]=a[l*4];return o}issuePickRequest(e,t){let{offscreenFramebuffer:r}=this;r.readPixelFloat32IntoBuffer(1,e-pn,t-pn,0,pt,pt),r.readPixelFloat32IntoBuffer(2,e-pn,t-pn,4*4*pt*pt,pt,pt)}completePickRequest(e,t,r,i){let{mouseState:a}=this.viewer;a.pickedRenderLayer=null,py(r,0,4,e,t,i.viewportWidth,i.viewportHeight);let o=yu.length;for(let l=0;l<o;++l){let c=yu[l],d=r[4*c];if(d===0)continue;let p=c%pt,h=(c-p)/pt,g=1-d;Co[0]=2*(e+p-pn)/i.viewportWidth-1,Co[1]=2*(t+h-pn)/i.viewportHeight-1,Co[2]=2*g-1,K.transformMat4(Co,Co,i.invTransform);let{position:v,unsnappedPosition:b}=a,{value:x}=this.navigationState.position,C=x.length;v.length!==C&&(v=a.position=new Float32Array(C)),b.length!==C&&(b=a.unsnappedPosition=new Float32Array(C)),v.set(x),a.coordinateSpace=this.navigationState.coordinateSpace.value;let T=this.navigationState.pose.displayDimensions.value,{displayDimensionIndices:P}=T;for(let M=0,D=P.length;M<D;++M)v[P[M]]=Co[M];b.set(v);let I=r[4*pt*pt+4*c];i.pickIDs.setMouseState(a,I),a.displayDimensions=T,a.setActive(!0);return}a.setActive(!1)}translateDataPointByViewportPixels(e,t,r,i){let a=Co,{viewProjectionMat:o,invViewProjectionMat:l,width:c,height:d}=this.projectionParameters.value;return K.transformMat4(a,t,o),a[0]+=2*r/c,a[1]+=-2*i/d,K.transformMat4(e,a,l)}get transparentConfiguration(){let e=this.transparentConfiguration_;return e===void 0&&(e=this.transparentConfiguration_=this.registerDisposer(new Bi(this.gl,{colorBuffers:ol(this.gl,2,this.gl.RGBA32F,this.gl.RGBA,this.gl.FLOAT),depthBuffer:this.offscreenFramebuffer.depthBuffer.addRef()}))),e}drawWithPicking(e){if(!this.navigationState.valid)return!1;let{width:t,height:r}=this.renderViewport,i=this.viewer.showSliceViews.value;for(let[C,T]of this.sliceViews)(T||i)&&C.updateRendering();let a=this.gl,o=()=>{this.offscreenFramebuffer.bind(t,r)};o(),a.disable(a.SCISSOR_TEST),a.enable(WebGL2RenderingContext.STENCIL_TEST),a.stencilMask(4294967295),a.clearStencil(0),a.clear(WebGL2RenderingContext.STENCIL_BUFFER_BIT),a.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.REPLACE),a.stencilFunc(WebGL2RenderingContext.ALWAYS,1,1);let l=this.viewer.perspectiveViewBackgroundColor.value;this.gl.clearColor(l[0],l[1],l[2],0),a.clear(a.DEPTH_BUFFER_BIT),a.clearBufferfv(WebGL2RenderingContext.COLOR,0,[l[0],l[1],l[2],0]),a.clearBufferfv(WebGL2RenderingContext.COLOR,1,gd),a.clearBufferfv(WebGL2RenderingContext.COLOR,2,gd),a.enable(a.DEPTH_TEST);let c=this.projectionParameters.value,d=K.create();K.transformQuat(d,$r[2],this.navigationState.pose.orientation.orientation),K.scale(d,d,-1);let p=.2,h=1-p,g={wireFrame:this.viewer.wireFrame.value,projectionParameters:c,lightDirection:d,ambientLighting:p,directionalLighting:h,pickIDs:e.pickIDs,emitter:t0,emitColor:!0,emitPickID:!0,alreadyEmittedPickID:!1,bindFramebuffer:o,frameNumber:this.context.frameNumber};oe.copy(e.invTransform,c.invViewProjectionMat);let{visibleLayers:v}=this.visibleLayerTracker,b=!1,x=!1;for(let[C,T]of v)C.isTransparent?b=!0:C.isAnnotation?x=!0:C.draw(g,T);if(this.drawSliceViews(g),x){a.enable(WebGL2RenderingContext.BLEND),a.depthFunc(WebGL2RenderingContext.LEQUAL),a.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);for(let[C,T]of v)C.isAnnotation&&C.draw(g,T);a.depthFunc(WebGL2RenderingContext.LESS),a.disable(WebGL2RenderingContext.BLEND)}if(this.viewer.showAxisLines.value&&this.drawAxisLines(),a.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP),b){a.depthMask(!1),a.enable(WebGL2RenderingContext.BLEND);let{transparentConfiguration:C}=this;g.bindFramebuffer=()=>{C.bind(t,r)},g.bindFramebuffer(),this.gl.clearColor(0,0,0,1),a.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),g.emitter=zJ,a.blendFuncSeparate(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE,WebGL2RenderingContext.ZERO,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),g.emitPickID=!1;for(let[T,P]of v)T.isTransparent&&T.draw(g,P);a.disable(WebGL2RenderingContext.DEPTH_TEST),this.offscreenFramebuffer.bindSingle(0),a.blendFunc(WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA,WebGL2RenderingContext.SRC_ALPHA),this.transparencyCopyHelper.draw(C.colorBuffers[0].texture,C.colorBuffers[1].texture),a.depthMask(!0),a.disable(WebGL2RenderingContext.BLEND),a.enable(WebGL2RenderingContext.DEPTH_TEST),g.bindFramebuffer=o,o(),a.enable(WebGL2RenderingContext.STENCIL_TEST),a.drawBuffers([a.NONE,a.COLOR_ATTACHMENT1,a.COLOR_ATTACHMENT2]),g.emitter=t0,g.emitPickID=!0,g.emitColor=!1,a.stencilFunc(WebGL2RenderingContext.NOTEQUAL,3,1),a.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.REPLACE),a.stencilMask(2);for(let[T,P]of v)!T.isTransparent||!T.transparentPickEnabled||T.draw(g,P);a.stencilFunc(WebGL2RenderingContext.EQUAL,0,3),a.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP),a.stencilMask(0);for(let[T,P]of v)!T.isTransparent||T.transparentPickEnabled||T.draw(g,P)}if(a.stencilMask(4294967295),a.disable(WebGL2RenderingContext.STENCIL_TEST),this.viewer.showScaleBar.value&&this.viewer.orthographicProjection.value){a.drawBuffers([a.COLOR_ATTACHMENT0]),a.disable(WebGL2RenderingContext.DEPTH_TEST),a.enable(WebGL2RenderingContext.BLEND),a.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);let{scaleBars:C}=this,T=this.viewer.scaleBarOptions.value;C.draw(this.renderViewport,this.navigationState.displayDimensionRenderInfo.value,this.navigationState.relativeDisplayScales.value,this.navigationState.zoomFactor.value/this.renderViewport.logicalHeight,T),a.disable(WebGL2RenderingContext.BLEND)}return this.offscreenFramebuffer.unbind(),this.setGLClippedViewport(),this.offscreenCopyHelper.draw(this.offscreenFramebuffer.colorBuffers[0].texture),!0}drawSliceViews(e){let{sliceViewRenderHelper:t}=this,{lightDirection:r,ambientLighting:i,directionalLighting:a,projectionParameters:{viewProjectionMat:o}}=e,l=this.viewer.showSliceViews.value;for(let[c,d]of this.sliceViews){if(!d&&!l)continue;let{width:p,height:h,invViewMatrix:g,viewportNormalInCanonicalCoordinates:v}=c.projectionParameters.value;if(p===0||h===0||!c.valid)continue;let b=Math.abs(K.dot(r,v)),x=i+b*a,C=HJ;oe.identity(C),C[0]=p/2,C[5]=-h/2,oe.multiply(C,g,C),oe.multiply(C,o,C);let T=vO,P=this.viewer.crossSectionBackgroundColor.value;T[0]=P[0],T[1]=P[1],T[2]=P[2],T[3]=1,t.draw(c.offscreenFramebuffer.colorBuffers[0].texture,C,an.fromValues(x,x,x,1),vO,0,0,1,1)}}drawAxisLines(){let{zoomFactor:{value:e}}=this.viewer.navigationState,t=this.projectionParameters.value,r=Math.min(t.logicalWidth,t.logicalHeight)/this.renderViewport.logicalHeight/4,i=e*r,{gl:a}=this;a.drawBuffers([a.COLOR_ATTACHMENT0]),this.axesLineHelper.draw(dy(t,i),!1)}zoomByMouse(e){this.navigationState.zoomBy(e)}};var vu;(function(r){r[r.COLOR=0]="COLOR",r[r.PICK=1]="PICK",r[r.NUM_TEXTURES=2]="NUM_TEXTURES"})(vu||(vu={}));function JJ(n){n.addOutputBuffer("vec4","out_fragColor",0),n.addOutputBuffer("highp vec4","out_pickId",1),n.addFragmentCode(`
void emit(vec4 color, highp uint pickId) {
  out_fragColor = color;
  float pickIdFloat = float(pickId);
  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);
}
`)}function qJ(n){n.addOutputBuffer("vec4","out_fragColor",null),n.addFragmentCode(`
void emit(vec4 color, highp uint pickId) {
  out_fragColor = color;
}
`)}var Hl=K.create(),YJ=K.create(),KJ=an.create(),Su=class extends Hp{constructor(e,t,r,i){super(e,t,i);this.sliceView=r;this.axesLineHelper=this.registerDisposer(zl.get(this.gl));this.sliceViewRenderHelper=this.registerDisposer(pl.get(this.gl,qJ));this.colorFactor=an.fromValues(1,1,1,1);this.pickIDs=new zp;this.offscreenFramebuffer=this.registerDisposer(new Bi(this.gl,{colorBuffers:[new va(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new va(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)]}));this.offscreenCopyHelper=this.registerDisposer(Sa.get(this.gl));this.scaleBars=this.registerDisposer(new $p(this.gl));i.wireFrame.changed.add(()=>this.scheduleRedraw()),ce(t,"rotate-via-mouse-drag",a=>{let{mouseState:o}=this.viewer;if(o.updateUnconditionally()){let l=Float32Array.from(o.position);un(a.detail,(c,d,p)=>{let{pose:h}=this.navigationState,g=K.transformQuat(Hl,$r[0],h.orientation.orientation),v=K.transformQuat(YJ,$r[1],h.orientation.orientation);this.viewer.navigationState.pose.rotateAbsolute(v,-d/4*Math.PI/180,l),this.viewer.navigationState.pose.rotateAbsolute(g,-p/4*Math.PI/180,l)})}}),ce(t,"rotate-in-plane-via-touchrotate",a=>{let{detail:o}=a,{mouseState:l}=this.viewer;this.handleMouseMove(o.centerX,o.centerY),l.updateUnconditionally()&&this.navigationState.pose.rotateAbsolute(this.sliceView.projectionParameters.value.viewportNormalInCanonicalCoordinates,o.angle-o.prevAngle,l.position)}),this.registerDisposer(r),this.visibleLayerTracker=bg(this.viewer.layerManager,di,this.viewer.visibleLayerRoles,this),this.registerDisposer(i.crossSectionBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.visibility.add(this.visibility)),this.registerDisposer(r.viewChanged.add(()=>{this.visible&&e.scheduleRedraw()})),this.registerDisposer(i.showAxisLines.changed.add(()=>{this.visible&&this.scheduleRedraw()})),this.registerDisposer(i.showScaleBar.changed.add(()=>{this.visible&&this.context.scheduleRedraw()})),this.registerDisposer(i.scaleBarOptions.changed.add(()=>{this.visible&&this.context.scheduleRedraw()}))}flushBackendProjectionParameters(){this.sliceView.flushBackendProjectionParameters()}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}get rpc(){return this.sliceView.rpc}get rpcId(){return this.sliceView.rpcId}get navigationState(){return this.sliceView.navigationState}translateByViewportPixels(e,t){let{pose:r}=this.viewer.navigationState;r.updateDisplayPosition(i=>{K.set(i,-e,-t,0),K.transformMat4(i,i,this.sliceView.projectionParameters.value.invViewMatrix)})}translateDataPointByViewportPixels(e,t,r,i){let a=this.sliceView.projectionParameters.value;return K.transformMat4(e,t,a.viewMatrix),K.set(e,e[0]+r,e[1]+i,e[2]),K.transformMat4(e,e,a.invViewMatrix),e}isReady(){if(!this.visible)return!1;let{sliceView:e}=this;if(this.ensureBoundsUpdated(),!e.isReady())return!1;let t={projectionParameters:e.projectionParameters.value,sliceView:e};for(let[r,i]of this.visibleLayerTracker.visibleLayers)if(!r.isReady(t,i))return!1;return!0}drawWithPicking(e){let{sliceView:t}=this;if(!t.valid)return!1;t.updateRendering();let r=t.projectionParameters.value,{width:i,height:a,invViewProjectionMat:o}=r;oe.copy(e.invTransform,o);let{gl:l}=this;this.offscreenFramebuffer.bind(i,a),l.disable(WebGL2RenderingContext.SCISSOR_TEST),this.gl.clearColor(0,0,0,0),l.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);let c=KJ,d=this.viewer.crossSectionBackgroundColor.value;c[0]=d[0],c[1]=d[1],c[2]=d[2],c[3]=1,this.offscreenFramebuffer.bindSingle(0),this.sliceViewRenderHelper.draw(t.offscreenFramebuffer.colorBuffers[0].texture,Yf,this.colorFactor,c,0,0,1,1);let{visibleLayers:p}=this.visibleLayerTracker,{pickIDs:h}=this;h.clear();let g=()=>{l.disable(WebGL2RenderingContext.SCISSOR_TEST),l.enable(WebGL2RenderingContext.BLEND),l.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),this.offscreenFramebuffer.bind(i,a)};g();let v={wireFrame:this.viewer.wireFrame.value,projectionParameters:r,pickIDs:h,emitter:JJ,emitColor:!0,emitPickID:!0,sliceView:t,bindFramebuffer:g,frameNumber:this.context.frameNumber};for(let[b,x]of p)b.draw(v,x);if(l.disable(WebGL2RenderingContext.BLEND),this.viewer.showAxisLines.value||this.viewer.showScaleBar.value){if(this.offscreenFramebuffer.bindSingle(0),this.viewer.showAxisLines.value){let b=Math.min(r.logicalWidth,r.logicalHeight)/4*1.5,{zoomFactor:{value:x}}=this.viewer.navigationState;this.axesLineHelper.draw(bE(dy(r,b*x)))}this.viewer.showScaleBar.value&&(l.enable(WebGL2RenderingContext.BLEND),l.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),this.scaleBars.draw(r,this.navigationState.displayDimensionRenderInfo.value,this.navigationState.relativeDisplayScales.value,this.navigationState.zoomFactor.value,this.viewer.scaleBarOptions.value),l.disable(WebGL2RenderingContext.BLEND))}return this.offscreenFramebuffer.unbind(),this.setGLClippedViewport(),this.offscreenCopyHelper.draw(this.offscreenFramebuffer.colorBuffers[0].texture),!0}ensureBoundsUpdated(){super.ensureBoundsUpdated(),this.sliceView.projectionParameters.setViewport(this.renderViewport)}issuePickRequest(e,t){let{offscreenFramebuffer:r}=this;r.readPixelFloat32IntoBuffer(1,e-pn,t-pn,0,pt,pt)}completePickRequest(e,t,r,i){let{mouseState:a}=this.viewer;a.pickedRenderLayer=null,py(r,0,4,e,t,i.viewportWidth,i.viewportHeight);let{viewportWidth:o,viewportHeight:l}=i,c=yu.length,{value:d}=this.navigationState.position,p=d.length,h=this.navigationState.pose.displayDimensions.value,{displayRank:g,displayDimensionIndices:v}=h,b=(T,P,I)=>{let M=e+T,D=t+P;Hl[0]=2*M/o-1,Hl[1]=2*D/l-1,Hl[2]=0,K.transformMat4(Hl,Hl,i.invTransform),I.set(d);for(let E=0;E<g;++E)I[v[E]]=Hl[E]},{unsnappedPosition:x}=a;x.length!==p&&(x=a.unsnappedPosition=new Float32Array(p)),a.coordinateSpace=this.navigationState.coordinateSpace.value,a.displayDimensions=h,b(0,0,x);let C=(T,P,I)=>{let{position:M}=a;M.length!==p&&(M=a.position=new Float32Array(p)),b(T-pn,P-pn,M),this.pickIDs.setMouseState(a,I),a.setActive(!0)};for(let T=0;T<c;++T){let P=yu[T],I=r[4*T];if(I===0)continue;let M=P%pt,D=(P-M)/pt;C(M,D,I);return}C(pn,pn,0)}zoomByMouse(e){let{navigationState:t}=this;if(!t.valid)return;let{sliceView:r}=this,{width:i,height:a,invViewMatrix:o,displayDimensionRenderInfo:{displayDimensionIndices:l,displayRank:c}}=r.projectionParameters.value,{mouseX:d,mouseY:p}=this;d-=i/2,p-=a/2;let h=this.navigationState.position.value;for(let g=0;g<c;++g){let v=l[g],b=o[g]*d+o[4+g]*p;h[v]+=b*(1-e)}this.navigationState.position.changed.dispatch(),t.zoomBy(e)}};var bO=Ye(gt());var XJ=["#f00","#0f0","#00f"],xO=Ie.fromObject({arrowup:{action:"move-up"},arrowdown:{action:"move-down"},wheel:{action:"adjust-via-wheel"},enter:{action:"commit"},escape:{action:"cancel"}});function QJ(n){if(n<1||n>1024){let e=Math.log2(n)|0,t=n/2**e;return`${Yg(t,1)}p${e}`}return n.toString()}var ZJ=[n=>n.name,n=>n.scaleFactor],eq=2e3,n0=class extends H{constructor(e,t,r,i="px"){super();this.displayDimensionRenderInfo=e;this.zoom=t;this.depthRange=r;this.displayUnit=i;this.element=document.createElement("div");this.dimensionGridContainer=document.createElement("div");this.depthGridContainer=document.createElement("div");this.defaultCheckbox=document.createElement("input");this.dimensionElements=Array.from(Array(3),(e,t)=>{let r=document.createElement("div");r.classList.add("neuroglancer-display-dimensions-widget-dimension"),r.style.display="contents",ce(r,"adjust-via-wheel",d=>{let p=d.detail,{deltaY:h}=p;h!==0&&this.zoomDimension(t,Math.sign(h))});let i=document.createElement("input");i.classList.add("neuroglancer-display-dimensions-widget-name"),i.title="Change display dimensions",i.spellcheck=!1,i.autocomplete="off",i.style.color=XJ[t],i.style.gridColumn="1",i.style.gridRow=`${t+1}`,i.addEventListener("focus",()=>{i.select()}),r.appendChild(i);let a=document.createElement("span");a.classList.add("neuroglancer-display-dimensions-widget-scale-factor");let o=document.createElement("input");o.spellcheck=!1,o.title="Change relative scale at which dimension is displayed",o.autocomplete="off",a.style.gridColumn="2",a.style.gridRow=`${t+1}`,o.addEventListener("focus",()=>{o.select()}),a.appendChild(o),r.appendChild(a);let l=document.createElement("span");l.classList.add("neuroglancer-display-dimensions-widget-scale"),l.style.gridColumn="3",l.style.gridRow=`${t+1}`,r.appendChild(l),this.dimensionGridContainer.appendChild(r);let c={name:i,container:r,scaleFactor:o,scale:l,scaleFactorModified:!1};i.addEventListener("input",()=>{Tn(i),this.updateNameValidity()}),ce(i,"commit",()=>{this.updateNames()}),i.addEventListener("blur",d=>{let{relatedTarget:p}=d;this.dimensionElements.some(h=>h.name===p)||this.updateNames()||this.updateView()}),a.addEventListener("click",d=>{let{target:p}=d;p!==o&&(o.focus(),d.preventDefault())}),o.addEventListener("input",()=>{Tn(o),c.scaleFactorModified=!0}),ce(o,"commit",()=>{this.updateScaleFactors()}),o.addEventListener("blur",()=>{this.updateScaleFactors()||this.updateView()});for(let d of ZJ)ce(d(c),"move-up",()=>{t!==0&&d(this.dimensionElements[t-1]).focus()}),ce(d(c),"move-down",()=>{t!==2&&d(this.dimensionElements[t+1]).focus()});return c});this.scheduleUpdateView=We(()=>this.updateView());let{element:a,dimensionGridContainer:o,defaultCheckbox:l}=this,c=document.createElement("label"),d=this.registerCancellable((0,bO.default)(()=>{a.dataset.active="false"},eq)),p=()=>{a.dataset.active="true",d()};this.registerDisposer(t.changed.add(p)),this.registerDisposer(e.relativeDisplayScales.changed.add(p)),this.registerDisposer(r.changed.add(p)),a.classList.add("neuroglancer-display-dimensions-widget"),a.appendChild(o),o.classList.add("neuroglancer-display-dimensions-widget-dimension-grid"),a.addEventListener("pointerleave",()=>{let x=document.activeElement;x instanceof HTMLElement&&a.contains(x)&&x.blur()}),l.type="checkbox",c.appendChild(l),c.appendChild(document.createTextNode("Default")),c.title="Display first 3 dimensions",c.classList.add("neuroglancer-display-dimensions-widget-default"),l.addEventListener("change",()=>{this.updateDefault()}),o.appendChild(c),this.registerDisposer(e),this.registerDisposer(r),this.registerDisposer(t.changed.add(this.scheduleUpdateView)),this.registerDisposer(e.changed.add(this.scheduleUpdateView));let h=this.registerDisposer(new jt(a,xO));h.allShortcutsAreGlobal=!0,this.registerDisposer(new kn(a,xO)),ce(o,"cancel",()=>{this.updateView();let x=document.activeElement;x instanceof HTMLElement&&a.contains(x)&&x.blur()});let{depthGridContainer:g}=this;g.classList.add("neuroglancer-depth-range-widget-grid"),a.appendChild(g);let v=document.createElement("label"),b=document.createElement("input");b.type="checkbox",v.classList.add("neuroglancer-depth-range-relative-checkbox-label"),b.classList.add("neuroglancer-depth-range-relative-checkbox"),v.appendChild(b),v.appendChild(document.createTextNode("Zoom-relative")),b.addEventListener("change",()=>{let x=b.checked,C=this.depthRange.value;x!==C<0&&(x?C=-C/this.zoom.value:C=-C*this.zoom.value,this.depthRange.value=C)}),v.title="Depth range is multiplied by scale",a.appendChild(v),ce(g,"adjust-via-wheel",x=>{let C=x.detail,{deltaY:T}=C;if(T===0)return;let P=this.depthRange.value;this.depthRange.value=P*2**Math.sign(T)}),this.registerDisposer(Mn((x,C,{factors:T})=>{Me(g);let{displayRank:P,globalDimensionNames:I,displayDimensionIndices:M,displayDimensionUnits:D,displayDimensionScales:E,canonicalVoxelFactors:V}=C,O=[],B=()=>{b.checked=this.depthRange.value<0;let F=this.depthRange.value;F<0&&(F*=-this.zoom.value);for(let N of O){let{input:J}=N;J.value=Ri(F*N.scale,N.unit,{precision:2,elide1:!1}),Tn(J)}},z=F=>{let N=Go(F.input.value);if(N===void 0||N.unit!==F.unit)return!1;let J=N.scale/F.scale;return this.depthRange.value<0&&(J=-J/this.zoom.value),this.depthRange.value=J,!0};for(let F=0;F<P;++F){let N=M[F],J=I[N],ae=D[F],pe=T[N],me=O.find(Ae=>Ae.unit===ae&&Ae.factor===pe);if(me===void 0){let Ae=document.createElement("div");Ae.title="Visible depth range",Ae.style.display="contents",g.appendChild(Ae);let le=document.createElement("span");le.textContent="\xB1",Ae.appendChild(le);let we=document.createElement("input");we.spellcheck=!1,we.autocomplete="off",we.addEventListener("focus",()=>{we.select()}),ce(we,"commit",()=>{z(me)}),we.addEventListener("change",()=>{z(me)||B()}),we.addEventListener("input",()=>{Tn(we)}),Ae.appendChild(we);let _e=document.createElement("span");_e.classList.add("neuroglancer-depth-range-widget-dimension-names"),Ae.appendChild(_e),me={unit:ae,factor:pe,dimensionNames:[],input:we,label:_e,scale:E[F]/V[F]},O.push(me)}me.dimensionNames.push(J)}for(let F of O)F.dimensionNames.length!==P&&(F.label.textContent=F.dimensionNames.join(" "));x.registerDisposer(ce(g,"cancel",()=>{B();let F=document.activeElement;F instanceof HTMLElement&&g.contains(F)&&F.blur()}));let _=x.registerCancellable(We(B));x.registerDisposer(this.depthRange.changed.add(_)),x.registerDisposer(this.zoom.changed.add(_)),B()},e,this.relativeDisplayScales)),this.updateView()}zoomDimension(e,t){this.updateScaleFactors();let{displayDimensions:r}=this,{relativeDisplayScales:i}=this,{displayDimensionIndices:a}=r.value,o=a[e];if(o===-1)return;let{factors:l}=i.value,c=new Float64Array(l);c[o]*=2**-t,i.setFactors(c)}updateNameValidity(){let{dimensionElements:e}=this,{displayDimensionIndices:t}=this.displayDimensions.value,r=e.map(c=>c.name.value),i=Ad(r),a=this.displayDimensions.coordinateSpace.value,{names:o}=a,l=r.length;for(let c=0;c<l;++c){let d=i[c],p=r[c],h=-1;p.length===0?d=!0:(h=o.indexOf(p),h===-1&&(d=!1));let g=e[c];g.name.dataset.isValid=d.toString(),g.container.dataset.isModified=(h!==t[c]).toString()}}get displayDimensions(){return this.displayDimensionRenderInfo.displayDimensions}get relativeDisplayScales(){return this.displayDimensionRenderInfo.relativeDisplayScales}updateNames(){let e=this.dimensionElements.map(l=>l.name.value).filter(l=>l.length>0);if(!_c(e))return!1;let{displayDimensions:t}=this.displayDimensionRenderInfo;if(e.length===0)return t.reset(),!0;let r=new Int32Array(3);r.fill(-1);let i=t.coordinateSpace.value,{names:a}=i,o=e.length;for(let l=0;l<o;++l){let c=a.indexOf(e[l]);if(c===-1)return!1;r[l]=c}return xe(r,t.value.displayDimensionIndices)||t.setDimensionIndices(o,r),!0}updateDefault(){this.displayDimensions.default=this.defaultCheckbox.checked}updateScaleFactors(){let{displayDimensions:e}=this,{relativeDisplayScales:t}=this,{displayDimensionIndices:r,displayRank:i}=e.value,{factors:a}=t.value,{dimensionElements:o}=this,l=new Float64Array(a);for(let c=0;c<i;++c){let d=o[c];if(!d.scaleFactorModified)continue;let p=Number(d.scaleFactor.value),h=r[c];!Number.isFinite(p)||p<=0||(l[h]=p)}return xe(l,a)||t.setFactors(l),!0}updateView(){let{dimensionElements:e,displayDimensions:{default:t}}=this,{displayDimensionIndices:r,canonicalVoxelFactors:i,displayDimensionUnits:a,displayDimensionScales:o,globalDimensionNames:l}=this.displayDimensionRenderInfo.value,{factors:c}=this.relativeDisplayScales.value;this.defaultCheckbox.checked=t;let d=this.zoom.value,p=r[0],h=!0;if(p!==-1){let g=a[0],v=c[p];for(let b=1;b<3;++b){let x=r[b];if(x!==-1&&(a[b]!==g||c[x]!==v)){h=!1;break}}}for(let g=0;g<3;++g){let v=r[g],b=e[g];if(delete b.name.dataset.isValid,b.container.dataset.isModified=(v===-1).toString(),v===-1)b.name.value="",b.scale.textContent="",b.scaleFactor.value="";else{b.name.value=l[v];let x=o[g]*d/i[g];if(g===0||!h){let C=Ri(x,a[g],{precision:2,elide1:!1});b.scale.textContent=`${C}/${this.displayUnit}`}else b.scale.textContent="";b.scaleFactor.value=QJ(c[v])}Tn(b.name),Tn(b.scaleFactor)}}disposed(){et(this.element),super.disposed()}};var wO=new Map([["xy",void 0],["xz",Qe.rotateX(Qe.create(),Qe.create(),Math.PI/2)],["yz",Qe.rotateY(Qe.create(),Qe.create(),Math.PI/2)]]),TO="\u25FB",r0=new Map([["4panel","\u25F1"],["3d",TO]]);function tq(n,e){let t;return e===void 0?t=n.navigationState.addRef():t=new _a(new Ra(n.navigationState.pose.position.addRef(),n.navigationState.pose.displayDimensionRenderInfo.addRef(),go.makeRelative(n.navigationState.pose.orientation,e)),n.navigationState.zoomFactor.addRef(),n.navigationState.depthRange.addRef()),new Wc(n.chunkManager,n.layerManager,t,n.wireFrame)}function Jp(n,e){return tq(n,wO.get(e))}function nq(n){return new Map([["xy",Jp(n,"xy")],["xz",Jp(n,"xz")],["yz",Jp(n,"yz")]])}function LO(n){return{crossSectionBackgroundColor:n.crossSectionBackgroundColor,perspectiveViewBackgroundColor:n.perspectiveViewBackgroundColor,selectionDetailsState:n.selectionDetailsState,mouseState:n.mouseState,layerManager:n.layerManager,showAxisLines:n.showAxisLines,wireFrame:n.wireFrame,visibleLayerRoles:n.visibleLayerRoles,selectedLayer:n.selectedLayer,visibility:n.visibility,scaleBarOptions:n.scaleBarOptions}}function i0(n){let{viewer:e}=n;return{...LO(e),navigationState:e.perspectiveNavigationState,inputEventMap:e.inputEventBindings.perspectiveView,orthographicProjection:n.specification.orthographicProjection,showScaleBar:e.showScaleBar,rpc:e.chunkManager.rpc}}function fy(n){return{...LO(n),navigationState:n.navigationState,inputEventMap:n.inputEventBindings.sliceView}}function bu(n,e){let{navigationState:t}=e;e.element.appendChild(n.registerDisposer(new n0(t.pose.displayDimensionRenderInfo.addRef(),t.zoomFactor,t.depthRange.addRef(),e instanceof Su?"px":"vh")).element)}function xu(n,e,t){let r=document.createElement("div");r.className="neuroglancer-data-panel-layout-controls",n.registerDisposer(()=>et(r));for(let i=0;i<2;++i){let a=t[Math.min(t.length-1,i)];n.registerDisposer(ce(e.element,i===0?"toggle-layout":"toggle-layout-alternative",o=>{n.container.name=a,o.stopPropagation()}))}for(let i of t){let a=document.createElement("button"),o=document.createElement("div");a.appendChild(o),o.textContent=r0.get(i),a.title=`Switch to ${i} layout.`,a.addEventListener("click",()=>{n.container.name=i}),r.appendChild(a)}e.element.appendChild(r)}function rq(n,e){let t=new Wc(n.chunkManager,n.layerManager,e.navigationState.addRef(),n.wireFrame),r=()=>{let{width:{value:i},height:{value:a}}=e;t.projectionParameters.setViewport({width:i,height:a,logicalWidth:i,logicalHeight:a,visibleLeftFraction:0,visibleTopFraction:0,visibleWidthFraction:1,visibleHeightFraction:1})};return t.registerDisposer(e.width.changed.add(r)),t.registerDisposer(e.height.changed.add(r)),r(),t}function a0(n,e,t){let r=new Map;(()=>{let a=new Set;for(let o of t.values()){if(a.add(o),r.has(o))continue;let l=rq(n,o);e.sliceViews.set(l,!0),r.set(o,l)}for(let[o,l]of r)a.has(o)||e.sliceViews.delete(l)})()}var kO=class extends H{constructor(e,t,r,i){super();this.container=e;this.rootElement=t;this.viewer=r;let a=nq(r),{display:o}=r,l={...i0(e),showSliceViews:r.showPerspectiveSliceViews,showSliceViewsCheckbox:!0},c={...fy(r),showScaleBar:r.showScaleBar},d={...fy(r),showScaleBar:new Xe(!1,!1)},p=(g,v,b,x)=>{let C=this.registerDisposer(new Su(o,v,a.get(g),b));return x&&bu(this,C),xu(this,C,[g,`${g}-3d`]),C},h=[ni(1,Is("column",[ni(1,Is("row",[ni(1,g=>{p("xy",g,c,!0)}),ni(1,g=>{p("xz",g,d,!1)})])),ni(1,Is("row",[ni(1,g=>{let v=this.registerDisposer(new jp(o,g,l));for(let b of a.values())v.sliceViews.set(b.addRef(),!1);bu(this,v),a0(r,v,i),xu(this,v,["3d"])}),ni(1,g=>{p("yz",g,d,!1)})]))]))];Is("row",h)(t)}disposed(){Me(this.rootElement),super.disposed()}},EO=class extends H{constructor(e,t,r,i,a,o){super();this.container=e;this.rootElement=t;this.viewer=r;this.direction=i;let l=Jp(r,a),{display:c}=r,d={...i0(e),showSliceViews:r.showPerspectiveSliceViews,showSliceViewsCheckbox:!0},p={...fy(r),showScaleBar:r.showScaleBar};ni(1,Is(i,[ni(1,h=>{let g=this.registerDisposer(new Su(c,h,l,p));bu(this,g),xu(this,g,[a,"4panel"])}),ni(1,h=>{let g=this.registerDisposer(new jp(c,h,d));g.sliceViews.set(l.addRef(),!1),a0(r,g,o),bu(this,g),xu(this,g,["3d","4panel"])})]))(t)}disposed(){Me(this.rootElement),super.disposed()}},DO=class extends H{constructor(e,t,r,i){super();this.container=e;this.rootElement=t;this.viewer=r;let a=Jp(r,i),o={...fy(r),showScaleBar:r.showScaleBar};Is("row",[ni(1,l=>{let c=this.registerDisposer(new Su(r.display,l,a,o));bu(this,c),xu(this,c,["4panel",`${i}-3d`])})])(t)}disposed(){Me(this.rootElement),super.disposed()}},PO=class extends H{constructor(e,t,r,i){super();this.container=e;this.rootElement=t;this.viewer=r;let a={...i0(e),showSliceViews:new Xe(!1,!1)};Is("row",[ni(1,o=>{let l=this.registerDisposer(new jp(r.display,o,a));a0(r,l,i),bu(this,l),xu(this,l,["4panel"])})])(t)}disposed(){Me(this.rootElement),super.disposed()}},o0=new Map([["4panel",{factory:(n,e,t,r)=>new kO(n,e,t,r)}],["3d",{factory:(n,e,t,r)=>new PO(n,e,t,r)}]]);for(let n of wO.keys()){o0.set(n,{factory:(t,r,i)=>new DO(t,r,i,n)});let e=`${n}-3d`;r0.set(n,TO),r0.set(e,"\u25EB"),o0.set(e,{factory:(t,r,i,a)=>new EO(t,r,i,"row",n,a)})}function IO(n){let e=o0.get(n);if(e===void 0)throw new Error(`Invalid layout name: ${JSON.stringify(n)}.`);return e}function iq(n){return IO(n),n}var AO=class extends H{constructor(e){super();this.width=new Ce(1e3,ct);this.height=new Ce(1e3,ct);this.changed=new ne;this.position=new Tp(e.position.addRef()),this.position.changed.add(this.changed.dispatch),this.orientation=new au(e.pose.orientation.addRef()),this.orientation.changed.add(this.changed.dispatch),this.width.changed.add(this.changed.dispatch),this.height.changed.add(this.changed.dispatch),this.scale=new ou(e.zoomFactor.addRef(),e.zoomFactor.displayDimensionRenderInfo.addRef()),this.scale.changed.add(this.changed.dispatch),this.navigationState=this.registerDisposer(new _a(new Ra(this.position.value,e.pose.displayDimensionRenderInfo.addRef(),this.orientation.value),this.scale.value,e.depthRange.addRef()))}restoreState(e){Q(e),dn(e,"width",this.width),dn(e,"height",this.height),dn(e,"position",_l(this.position)),dn(e,"orientation",this.orientation),dn(e,"scale",this.scale),dn(e,"zoom",_l(this.scale))}reset(){this.width.reset(),this.height.reset(),this.position.reset(),this.orientation.reset(),this.scale.reset()}toJSON(){return{width:this.width.toJSON(),height:this.height.toJSON(),position:this.position.toJSON(),orientation:this.orientation.toJSON(),scale:this.scale.toJSON()}}},MO=class extends Fl{constructor(e){super((t,r)=>t.registerDisposer(t.registerDisposer(r).changed.add(this.changed.dispatch)));this.parentNavigationState=e;this.registerDisposer(e)}restoreState(e){Q(e);for(let t of Object.keys(e)){let r=new AO(this.parentNavigationState);try{this.set(t,r.addRef()),r.restoreState(e[t])}finally{r.dispose()}}}reset(){this.clear()}toJSON(){if(this.size===0)return;let e={};for(let[t,r]of this)e[t]=r.toJSON();return e}},RO=class extends H{constructor(e,t){super();this.changed=new ne;this.orthographicProjection=new Xe(!1);this.type=new Ce(t,iq),this.type.changed.add(this.changed.dispatch),this.crossSections=this.registerDisposer(new MO(e.addRef())),this.crossSections.changed.add(this.changed.dispatch),this.orthographicProjection.changed.add(this.changed.dispatch),this.registerDisposer(e)}reset(){this.crossSections.clear(),this.orthographicProjection.reset(),this.type.reset()}restoreState(e){this.crossSections.clear(),this.orthographicProjection.reset(),typeof e=="string"?this.type.restoreState(e):(Q(e),U(e,"type",t=>this.type.restoreState(t)),U(e,"orthographicProjection",t=>this.orthographicProjection.restoreState(t)),U(e,"crossSections",t=>t!==void 0&&this.crossSections.restoreState(t)))}toJSON(){let{type:e,crossSections:t,orthographicProjection:r}=this,i=r.toJSON();return t.size===0&&i===void 0?e.value:{type:e.value,crossSections:t.toJSON(),orthographicProjection:i}}},s0=class extends H{constructor(e,t){super();this.viewer=e;this.element=document.createElement("div");this.specification=this.registerDisposer(new RO(this.viewer.navigationState.addRef(),t)),this.element.style.flex="1";let r=this.registerCancellable((0,CO.default)(()=>this.updateLayout(),0));this.specification.type.changed.add(r),ce(this.element,"toggle-orthographic-projection",()=>this.specification.orthographicProjection.toggle()),this.registerDisposer(this.viewer.display.updateStarted.add(()=>r.flush())),r()}get name(){return this.specification.type.value}set name(e){this.specification.type.value=e}get changed(){return this.specification.changed}toJSON(){return this.specification.toJSON()}restoreState(e){this.specification.restoreState(e)}reset(){this.specification.reset()}disposeLayout(){let{layout:e}=this;e!==void 0&&(e.dispose(),this.layout=void 0)}updateLayout(){this.disposeLayout(),this.layout=IO(this.name).factory(this,this.element,this.viewer,this.specification.crossSections)}disposed(){this.disposeLayout(),super.disposed()}};var _O=typeof STATE_SERVERS!="undefined"&&Object.keys(STATE_SERVERS).length>0,l0=class extends H{constructor(e){super();this.element=document.createElement("div");this.button=He({text:"Share",title:"Share State"});if(typeof STATE_SERVERS=="undefined")throw new Error("Cannot construct StateSare without defining STATE_SERVERS");if(Object.keys(STATE_SERVERS).length>1){let t=document.createElement("select");t.style.marginRight="5px",this.registerDisposer(e.selectedStateServer.changed.add(()=>{let r=e.selectedStateServer.value;Object.values(STATE_SERVERS).map(i=>i.url).includes(r)&&(t.value=r)})),this.registerEventListener(t,"change",()=>{e.selectedStateServer.value=t.value});for(let[r,i]of Object.entries(STATE_SERVERS)){let a=document.createElement("option");a.textContent=r,a.value=i.url,a.selected=!!i.default,t.appendChild(a)}this.element.appendChild(t),this.selectStateServerElement=t}this.element.appendChild(this.button),this.registerEventListener(this.button,"click",()=>{let t=this.selectStateServerElement?this.selectStateServerElement.value:Object.values(STATE_SERVERS)[0].url,r=new URL(t).protocol,{url:i,credentialsProvider:a}=Dn(t,uy);Ee.forPromise(On(a,i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.state.toJSON())},kt).then(o=>{let l=new URL(o);l.protocol=r;let c=`${window.location.origin}/#!${l}`;navigator.clipboard.writeText(c).then(()=>{Ee.showTemporaryMessage("Share link copied to clipboard")})}).catch(()=>{Ee.showTemporaryMessage("Could not access state server.",4e3)}),{initialMessage:`Posting state to ${t}.`,delay:!0,errorPrefix:""})})}disposed(){this.element.remove(),super.disposed()}};function aq(n){return n.startsWith("key")?n.substring(3):n.startsWith("digit")||n.startsWith("arrow")?n.substring(5):n}function oq(n){return n.split("+").map(aq).join("+")}var sq={...mi,side:"left",row:1},c0=class{constructor(){this.location=new tr(sq)}get changed(){return this.location.changed}toJSON(){return Ai(this.location.toJSON())}reset(){this.location.reset()}restoreState(e){this.location.restoreState(e)}},u0=class extends Or{constructor(e,t,r,i,a){super(e,t.location);this.bindings=r;this.toolBinder=a;this.scroll=document.createElement("div");this.addTitleBar({title:"Help"});let o=document.createElement("div");o.classList.add("neuroglancer-help-body");let{scroll:l}=this;l.classList.add("neuroglancer-help-scroll-container"),o.appendChild(l),this.addBody(o);let c=this.registerCancellable(We(()=>this.updateView()));this.registerDisposer(a.changed.add(c)),this.registerDisposer(i.layersChanged.add(c)),this.updateView()}updateView(){let{scroll:e,bindings:t,toolBinder:r}=this;Me(e);let i=new Map;function a(p,h){for(let g of p.parents)g.label!==void 0?o(g.label,g):a(g,h);for(let[g,v]of p.bindings.entries()){let b=g.indexOf(":"),x=g.substring(b+1);h.set(x,v.action)}}function o(p,h){if(i.has(h))return;let g={label:p,entries:new Map};a(h,g.entries),i.set(h,g)}for(let[p,h]of t)o(p,h);let l=(p,h)=>{let g=document.createElement("h2");g.textContent=p,e.appendChild(g);for(let[v,b]of h){let x=document.createElement("div");x.className="dt",x.textContent=oq(v);let C=document.createElement("div");C.className="dd",C.textContent=b,e.appendChild(x),e.appendChild(C)}},c=new Map;for(let[p,h]of r.bindings){let g=c.get(h.layer);g===void 0&&(g=[],c.set(h.layer,g)),g.push([`shift+key${p.toLowerCase()}`,h.description])}let d=Array.from(c.entries());d.length>0&&(d[0][0].manager.root.layerManager.updateNonArchivedLayerIndices(),d.sort((p,h)=>p[0].managedLayer.nonArchivedLayerIndex-h[0].managedLayer.nonArchivedLayerIndex));for(let[p,h]of d)h.sort(),l(`Tool bindings for layer ${p.managedLayer.nonArchivedLayerIndex+1}: ${p.managedLayer.name}`,h);for(let p of i.values())l(p.label,p.entries)}};var v0=Ye(gt());var HO=Ye(gt());function lq(n,e){n.style.display="block";let{offsetWidth:t,offsetHeight:r}=n,i=document.documentElement.clientWidth,a=document.documentElement.clientHeight,o=document.documentElement.scrollLeft+Math.min(i-t,e.clientX),l=document.documentElement.scrollTop+Math.min(a-r,e.clientY);n.style.left=o+"px",n.style.top=l+"px"}var d0=class extends H{constructor(e){super();this.element=document.createElement("div");this.parentDisposers=new Map;this.disabledValue=!1;this.opened=new ne;this.closed=new ne;let{element:t}=this;t.className="neuroglancer-context-menu",t.style.display="none",t.tabIndex=-1,document.body.appendChild(t),e!==void 0&&this.registerParent(e)}get disabled(){return this.disabledValue}set disabled(e){this.disabledValue!==e&&(this.disabledValue=e,e&&this.hide())}get open(){return this.menuDisposer!==void 0}registerParent(e){let{parentDisposers:t}=this;t.has(e)||t.set(e,An(e,"contextmenu",r=>{this.show(r),r.stopPropagation(),r.preventDefault()}))}show(e){if(this.disabledValue)return;this.hide();let{element:t}=this,r=An(document,"mousedown",o=>{o.target instanceof Node&&!t.contains(o.target)&&this.hide()},!0),i=An(document,"keydown",o=>{o.code==="Escape"&&this.hide()},!0),a=()=>{i(),r(),t.style.display="none"};this.opened.dispatch(),lq(t,e),this.menuDisposer=a}unregisterParent(e){let{parentDisposers:t}=this,r=t.get(e);r!==void 0&&(r(),t.delete(e))}disposed(){let{parentDisposers:e}=this;for(let t of e.values())t();e.clear(),et(this.element)}hide(){this.menuDisposer!==void 0&&(this.menuDisposer(),this.menuDisposer=void 0,this.closed.dispatch())}};function cq(n){return CE(new TextEncoder().encode(n))}function uq(n){return new TextDecoder().decode(wE(n))}function dq(n,e){if(!!n.startsWith(e))try{let t=uq(n.substring(e.length));return JSON.parse(t)}catch{return}}function VO(n,e){return n+cq(JSON.stringify(e))}function OO(n,e){for(let t of n){let r=dq(t,e);if(r!==void 0)return{parameters:r,dragType:t}}}var NO;function qp(n,e){return n.dataTransfer.dropEffect=e,NO=e,e}function Yp(){return NO}function BO(n){return n.draggable=!0,An(n,"dragstart",e=>{e.stopPropagation(),e.preventDefault()})}var FO="neuroglancer-layer\0",Ci;function p0(n,e){var i;n.dataTransfer.setData(VO(FO,e.layers.map(a=>({name:a.name,visible:a.visible}))),JSON.stringify({layers:e.layers.map(a=>a.toJSON()),layout:e.layoutSpec})),Ci!==void 0&&Ci.disposer();let t,r=()=>{e.manager.unregisterDisposer(r);for(let a of e.layers)a.dispose();e.manager.dispose(),Ci===t&&(Ci=void 0)};Ci=t={manager:e.manager.addRef(),layers:e.layers.map(a=>a.addRef()),layoutSpec:e.layoutSpec,isLayerListPanel:(i=e.isLayerListPanel)!=null?i:!1,disposer:r}}function Cu(n="none"){if(Ci!==void 0){if(n==="move"){let e=new Set(Ci.layers);Ci.manager.layerManager.filter(t=>!e.has(t))}Ci.disposer()}}function Kp(n){return OO(n.dataTransfer.types,FO)}function UO(n){if(Ci!==void 0&&Ci.manager.rootLayers===n.rootLayers)return Ci}var f0=class{initializeExternalLayers(e){let{dragType:t}=this;if(t!==void 0)try{let{layers:r,layout:i}=JSON.parse(e.dataTransfer.getData(t));if(!Array.isArray(r)||this.numSourceLayers!==r.length)throw new Error("Invalid layer drop data");this.layoutSpec=i;for(let[a,o]of this.layers)vR(a,r[o])}catch{return!1}return!0}updateArchiveStates(e){let{targetIsLayerListPanel:t}=this,r=e.dataTransfer.dropEffect;for(let i of this.layers.keys()){let a=t;t&&!i.archived&&r!=="copy"&&this.sourceIsLayerListPanel&&(a=!1),(i.archived!==a||a&&i.visible)&&(i.archived=a,a&&(i.visible=!1),i.layerChanged.dispatch())}}get method(){return this.sourceManager!==void 0?this.manager===this.sourceManager&&this.sourceIsLayerListPanel===this.targetIsLayerListPanel?"move":"link":"copy"}compatibleWithMethod(e){return this.method===e?!0:this.forceCopy&&e!=="copy"?!1:!this.moveSupported&&e==="move"}};function h0(n,e,t){let r;n.shiftKey?r="copy":n.ctrlKey&&t?r="move":r=e;let i="",a=o=>{i!==""&&(i+=", "),i+=o};return e!=="none"&&r!==e&&(n.shiftKey?a(`release SHIFT to ${e}`):a(`release CONTROL to ${e}`)),r!=="copy"&&a("hold SHIFT to copy"),r!=="move"&&t&&e!=="move"&&a("hold CONTROL to move"),{dropEffect:r,dropEffectMessage:i}}function GO(n,e,t,r){let i=UO(e),a=!1,o;return i===void 0?o="copy":r?(i.isLayerListPanel||(a=!0),o="link"):i.manager===e&&i.isLayerListPanel===t?(o="move",a=!0):t?o="none":(i.isLayerListPanel||(a=!0),o="link"),h0(n,o,a)}function WO(n,e,t,r){let i=GO(n,e,t,r);return qp(n,i.dropEffect),i}function hy(n,e,t){let{forceCopy:r,newTarget:i,isLayerListPanel:a=!1}=t,o=UO(e);if(!r&&o!==void 0){let c=!i&&o.manager===e&&(o.isLayerListPanel===a||o.isLayerListPanel),d=new f0;return d.manager=e,d.numSourceLayers=o.layers.length,d.sourceManager=o.manager,d.targetIsLayerListPanel=a,d.sourceIsLayerListPanel=o.isLayerListPanel,d.moveSupported=c,d.layers=new Map,d.forceCopy=!1,d.layoutSpec=o.layoutSpec,c?o.layers.forEach((p,h)=>{d.layers.set(p,h)}):o.layers.forEach((p,h)=>{(i||!e.layerManager.has(p))&&d.layers.set(p.addRef(),h)}),d}let l=Kp(n);if(l!==void 0)try{let c=ge(l.parameters,(p,h)=>{let g=U(p,"name",Z),v=U(p,"visible",ha),b=new Ip(g,e);return a&&(v=!1),b.visible=v,b.archived=a,[b,h]}),d=new f0;return d.numSourceLayers=c.length,d.targetIsLayerListPanel=a,d.sourceIsLayerListPanel=!1,d.sourceManager=void 0,d.moveSupported=!1,d.forceCopy=o!==void 0,d.manager=e,d.dragType=l.dragType,d.layers=new Map(c),d}catch{}}function m0(n,e){return n.moveSupported?!1:(n.manager.layerManager.filter(t=>!n.layers.has(t)),e!==void 0&&n.layers.has(e))}function wu(n,e,t,r=!1){function i(a,o){let l=n.dropLayers,{dropEffect:c,dropEffectMessage:d}=o?GO(a,n.manager,r,!1):{dropEffect:Yp(),dropEffectMessage:""};if(c===void 0)return;qp(a,c);let p=!0;if(!(l!==void 0&&!l.compatibleWithMethod(c)&&(n.dropLayers=void 0,m0(l,t)))){if(l===void 0){if(l=n.dropLayers=hy(a,n.manager,{forceCopy:c==="copy",newTarget:!1,isLayerListPanel:r}),l===void 0)return;p=l.method==="move"}if(t!==void 0&&l.layers.has(t))return{dropLayers:l,dropEffect:c,dropEffectMessage:d};if(p){let{layerManager:h}=n.manager,g=new Set,v=Number.POSITIVE_INFINITY,b=h.managedLayers=h.managedLayers.filter((C,T)=>l.layers.has(C)?(v===Number.POSITIVE_INFINITY&&(v=T),g.add(C),!1):!0),x;t!==void 0?(x=b.indexOf(t),v<=x&&++x):x=b.length;for(let C of l.layers.keys())g.has(C)||l.layers.delete(C);b.splice(x,0,...l.layers.keys()),h.layersChanged.dispatch()}else{let h;t!==void 0&&(h=n.manager.layerManager.managedLayers.indexOf(t));for(let g of l.layers.keys())n.manager.add(g,h)}return{dropLayers:l,dropEffect:c,dropEffectMessage:d}}}e.addEventListener("dragenter",a=>{i(a,!0)!==void 0?a.preventDefault():Xt(n.element,"drop")}),e.addEventListener("drop",a=>{var l;a.preventDefault(),n.dragEnterCount=0,Xt(n.element,"drop");let o=(l=i(a,!1))==null?void 0:l.dropLayers;if(n.dropLayers=void 0,o!==void 0){if(!o.initializeExternalLayers(a)){m0(o);return}o.updateArchiveStates(a),Cu(o.method==="move"?void 0:a.dataTransfer.dropEffect)}}),e.addEventListener("dragover",a=>{let o=i(a,!0);if(o===void 0){Xt(n.element,"drop");return}let{dropLayers:l,dropEffect:c,dropEffectMessage:d}=o,p=l.layers.size,h="",g=l.numSourceLayers===1?"":"s",v=l.numSourceLayers;if(c==="none")h=`Cannot link dragged layer${g} here`;else{let b=v===p?`${v}`:`${p}/${v}`;h=`Drop to ${c} ${b} layer${g}`}d&&(h+=` (${d})`),er(n.element,"drop",h),a.preventDefault(),a.stopPropagation()})}function my(n,e,t,r){e.draggable=!0,e.addEventListener("dragstart",i=>{er(e,"drag","Drag layer to another layer bar/panel (including in another Neuroglancer window), or to the left/top/right/bottom edge of a layer group"),p0(i,{manager:n.manager,layers:[t],layoutSpec:r.getLayoutSpec(),isLayerListPanel:r.isLayerListPanel}),i.stopPropagation()}),e.addEventListener("dragend",()=>{Xt(e,"drag"),Cu()})}function gy(n){n.element.addEventListener("dragenter",()=>{++n.dragEnterCount}),n.element.addEventListener("dragleave",()=>{if(--n.dragEnterCount!=0)return;Xt(n.element,"drop");let{dropLayers:e}=n;e!==void 0&&(m0(e),n.manager.layerManager.layersChanged.dispatch(),n.dropLayers=void 0)})}var zO=class extends H{constructor(e,t){super();this.layer=e;this.panel=t;this.element=document.createElement("div");this.layerNumberElement=document.createElement("div");this.labelElement=document.createElement("div");this.visibleProgress=document.createElement("div");this.prefetchProgress=document.createElement("div");this.labelElementText=document.createTextNode("");this.valueElement=document.createElement("div");this.maxLength=0;this.prevValueText="";let{element:r,labelElement:i,layerNumberElement:a,valueElement:o,visibleProgress:l,prefetchProgress:c,labelElementText:d}=this;r.className="neuroglancer-layer-item neuroglancer-noselect",r.appendChild(l),r.appendChild(c),i.className="neuroglancer-layer-item-label",i.appendChild(d),l.className="neuroglancer-layer-item-visible-progress",c.className="neuroglancer-layer-item-prefetch-progress",a.className="neuroglancer-layer-item-number",o.className="neuroglancer-layer-item-value";let p=document.createElement("div");p.className="neuroglancer-layer-item-value-container";let h=document.createElement("div");h.className="neuroglancer-layer-item-button-container";let g=Kc();g.title="Remove layer from this layer group",g.addEventListener("click",x=>{this.panel.layerManager===this.panel.manager.rootLayers?this.layer.setArchived(!0):this.layer.containers.size>2?this.panel.layerManager.removeManagedLayer(this.layer):this.layer.setArchived(!0),x.stopPropagation()});let v=xi();v.title="Delete this layer",v.addEventListener("click",x=>{yo(this.layer),x.stopPropagation()}),r.appendChild(a),p.appendChild(o),p.appendChild(h),h.appendChild(g),h.appendChild(v),r.appendChild(i),r.appendChild(p);let b=this.registerDisposer(new ws(e.localPosition,e.localCoordinateSpaceCombiner,{copyButton:!1}));r.appendChild(b.element),b.element.addEventListener("click",x=>{x.stopPropagation()}),b.element.addEventListener("dblclick",x=>{x.stopPropagation()}),r.addEventListener("click",x=>{x.ctrlKey?t.selectedLayer.toggle(e):x.altKey?e.pickEnabled=!e.pickEnabled:e.setVisible(!e.visible)}),r.addEventListener("contextmenu",x=>{t.selectedLayer.layer=e,t.selectedLayer.visible=!0,x.stopPropagation(),x.preventDefault()}),my(t,r,e,{getLayoutSpec:()=>t.getLayoutSpecForDrag()}),wu(this.panel,r,this.layer)}update(){let{layer:e,element:t}=this;this.labelElementText.textContent=e.name,t.dataset.visible=e.visible.toString(),t.dataset.selected=(e===this.panel.selectedLayer.layer).toString(),t.dataset.pick=e.pickEnabled.toString();let r=`Click to ${e.visible?"hide":"show"}, control+click to show side panel`;e.supportsPickOption&&(r+=`, alt+click to ${e.pickEnabled?"disable":"enable"} spatial object selection`),r+=", drag to move, shift+drag to copy",t.title=r}disposed(){this.element.remove(),super.disposed()}},g0=class extends H{constructor(e,t,r,i,a,o){super();this.display=e;this.manager=t;this.viewerNavigationState=r;this.selectedLayer=i;this.getLayoutSpecForDrag=a;this.showLayerHoverValues=o;this.layerWidgets=new Map;this.element=document.createElement("div");this.layerUpdateNeeded=!0;this.valueUpdateNeeded=!1;this.layerWidgetInsertionPoint=document.createElement("div");this.positionWidget=this.registerDisposer(new ws(this.viewerNavigationState.position.value,this.manager.root.coordinateSpaceCombiner));this.dragEnterCount=0;this.scheduleUpdate=this.registerCancellable(We(()=>this.update()));this.registerDisposer(i);let{element:l}=this;l.className="neuroglancer-layer-panel",this.registerDisposer(t.layerSelectedValues.changed.add(()=>{this.handleLayerValuesChanged()})),this.registerDisposer(t.layerManager.layersChanged.add(()=>{this.handleLayersChanged()})),this.registerDisposer(i.changed.add(()=>{this.handleLayersChanged()})),this.registerDisposer(o.changed.add(()=>{this.handleLayerItemValueChanged()})),this.element.dataset.showHoverValues=this.showLayerHoverValues.value.toString(),this.layerWidgetInsertionPoint.style.display="none",this.element.appendChild(this.layerWidgetInsertionPoint);let c=He({svg:Vl,title:"Click to add layer, control+click/right click/\u2318+click to add local annotation layer."});c.classList.add("neuroglancer-layer-add-button");let d=this.dropZone=document.createElement("div");d.className="neuroglancer-layer-panel-drop-zone";let p=g=>{if(g.ctrlKey||g.metaKey||g.type==="contextmenu"){let v=cC(this.manager,"annotation",{type:"annotation",source:"local://annotations"});this.manager.add(v),this.selectedLayer.layer=v,this.selectedLayer.visible=!0}else this.addLayerMenu()};this.registerEventListener(c,"click",p),this.registerEventListener(c,"contextmenu",p),l.appendChild(c),l.appendChild(d),this.registerDisposer(BO(c)),l.appendChild(this.positionWidget.element);let h=()=>{let g=this.viewerNavigationState.position.link.value;this.positionWidget.element.style.display=g===$t.LINKED?"none":""};this.registerDisposer(this.viewerNavigationState.position.link.changed.add(h)),h(),this.update(),this.updateChunkStatistics(),gy(this),wu(this,d,void 0),this.registerDisposer(e.updateStarted.add(()=>this.updateLayers())),this.registerDisposer(t.chunkManager.layerChunkStatisticsUpdated.add(this.registerCancellable(We(()=>this.updateChunkStatistics()))))}get layerManager(){return this.manager.layerManager}disposed(){this.layerWidgets.forEach(e=>e.dispose()),this.layerWidgets=void 0,et(this.element),super.disposed()}handleLayersChanged(){this.layerUpdateNeeded=!0,this.handleLayerValuesChanged()}handleLayerValuesChanged(){this.valueUpdateNeeded||(this.valueUpdateNeeded=!0,this.scheduleUpdate())}handleLayerItemValueChanged(){this.element.dataset.showHoverValues=this.showLayerHoverValues.value.toString()}update(){if(this.valueUpdateNeeded=!1,this.updateLayers(),this.showLayerHoverValues.value===!1)return;let e=this.manager.layerSelectedValues;for(let[t,r]of this.layerWidgets){let i=t.layer,a="";if(i!==null){let o=e.get(i);if(o!==void 0){let{value:l}=o;l!==void 0&&(a=""+l)}}if(a!==r.prevValueText){if(r.prevValueText=a,a.length>r.maxLength){let o=r.maxLength=a.length;r.valueElement.style.width=`${o}ch`}r.valueElement.textContent=a}}}updateChunkStatistics(){for(let[e,t]of this.layerWidgets){let r=0,i=0,a=0,o=0,l=e.layer;if(l!==null)for(let{layerChunkProgressInfo:c}of l.renderLayers)r+=c.numVisibleChunksNeeded,i+=c.numVisibleChunksAvailable,a+=c.numPrefetchChunksNeeded,o+=c.numPrefetchChunksAvailable;t.visibleProgress.style.width=`${i/Math.max(1,r)*100}%`,t.prefetchProgress.style.width=`${o/Math.max(1,a)*100}%`}}updateLayers(){var i;if(!this.layerUpdateNeeded)return;this.layerUpdateNeeded=!1;let e=this.element,t=new Set,r=this.layerWidgetInsertionPoint.nextElementSibling;this.manager.rootLayers.updateNonArchivedLayerIndices();for(let a of this.manager.layerManager.managedLayers){if(a.archived&&!((i=this.dropLayers)==null?void 0:i.layers.has(a)))continue;t.add(a);let o=this.layerWidgets.get(a),l=a.nonArchivedLayerIndex;o===void 0&&(o=new zO(a,this),this.layerWidgets.set(a,o)),o.layerNumberElement.textContent=""+(1+l),o.update();let{element:c}=o;c!==r&&e.insertBefore(o.element,r),r=c.nextElementSibling}for(let[a,o]of this.layerWidgets)t.has(a)||(this.layerWidgets.delete(a),o.dispose())}addLayerMenu(){Tg(this.manager,this.selectedLayer)}};function yy(n,e){let t=An(n,"drop",o=>{if(o.preventDefault(),o.dataTransfer.types.indexOf(Fp)!==-1){o.stopPropagation();let l=Q(JSON.parse(o.dataTransfer.getData(Fp))),c=U(l,"dimensions",Md),d=U(l,"position",v=>ge(v,Ke));if(d.length!==c.length)throw new Error("length mismatch between position and dimensions");let p=d.length,{coordinateSpace:{value:{names:h}},value:g}=e;for(let v=0;v<p;++v){let b=h.indexOf(c[v]);b!==-1&&(g[b]=d[v])}e.changed.dispatch()}}),r=o=>{o.dataTransfer.types.indexOf(Fp)!==-1&&(o.dataTransfer.dropEffect="link",o.preventDefault(),o.stopPropagation())},i=An(n,"dragenter",r),a=An(n,"dragover",r);return()=>{i(),a(),t()}}var vy="neuroglancer-layer-group-viewer";function y0(n){return n.dataTransfer.types.indexOf(vy)!==-1}var Oa;function pq(n){if(Oa&&Oa.viewer.layerSpecification.rootLayers===n.rootLayers)return Oa.viewer}function $O(n,e){let t=pq(e),r,i=!1;return t===void 0||t.layerSpecification===t.layerSpecification.root?r="copy":(i=!0,r="move"),h0(n,r,i)}var jO=class extends H{constructor(e){super();this.relativeDisplayScales=new Wx(e.navigationState.pose.relativeDisplayScales.addRef()),this.displayDimensions=new zx(e.navigationState.pose.displayDimensions.addRef()),this.position=new Tp(e.navigationState.position.addRef()),this.crossSectionOrientation=new au(e.navigationState.pose.orientation.addRef()),this.displayDimensionRenderInfo=this.registerDisposer(new Lp(this.relativeDisplayScales.value,this.displayDimensions.value)),this.crossSectionScale=new ou(e.navigationState.zoomFactor.addRef(),this.displayDimensionRenderInfo.addRef()),this.crossSectionDepthRange=new fg(e.navigationState.depthRange.addRef(),this.displayDimensionRenderInfo),this.projectionDepthRange=new fg(e.perspectiveNavigationState.depthRange.addRef(),this.displayDimensionRenderInfo),this.navigationState=this.registerDisposer(new _a(new Ra(this.position.value,this.displayDimensionRenderInfo.addRef(),this.crossSectionOrientation.value),this.crossSectionScale.value,this.crossSectionDepthRange.value)),this.projectionOrientation=new au(e.perspectiveNavigationState.pose.orientation.addRef()),this.projectionScale=new ou(e.perspectiveNavigationState.zoomFactor.addRef(),this.displayDimensionRenderInfo.addRef()),this.projectionNavigationState=this.registerDisposer(new _a(new Ra(this.position.value.addRef(),this.displayDimensionRenderInfo.addRef(),this.projectionOrientation.value),this.projectionScale.value,this.projectionDepthRange.value))}copyToParent(){for(let e of[this.relativeDisplayScales,this.displayDimensions,this.position,this.crossSectionOrientation,this.crossSectionScale,this.projectionOrientation,this.projectionScale])e.copyToPeer()}register(e){e.add("dimensionRenderScales",this.relativeDisplayScales),e.add("displayDimensions",this.displayDimensions),e.add("position",_l(this.position)),e.add("crossSectionOrientation",this.crossSectionOrientation),e.add("crossSectionScale",this.crossSectionScale),e.add("crossSectionDepth",this.crossSectionDepthRange),e.add("projectionOrientation",this.projectionOrientation),e.add("projectionScale",this.projectionScale),e.add("projectionDepth",this.projectionDepthRange)}};function fq(n,e){let t=new d0(n),r=t.element;r.classList.add("neuroglancer-layer-group-viewer-context-menu");let i=document.createElement("button");i.textContent="Remove layer group",r.appendChild(i),t.registerEventListener(i,"click",()=>{e.layerSpecification.layerManager.clear()});let{viewerNavigationState:a}=e;for(let[o,l]of[["Render scale factors",a.relativeDisplayScales.link],["Render dimensions",a.displayDimensions.link],["Position",a.position.link],["Cross-section orientation",a.crossSectionOrientation.link],["Cross-section zoom",a.crossSectionScale.link],["Cross-section depth range",a.crossSectionDepthRange.link],["3-D projection orientation",a.projectionOrientation.link],["3-D projection zoom",a.projectionScale.link],["3-D projection depth range",a.projectionDepthRange.link]]){let c=t.registerDisposer(new Up(l)),d=document.createElement("label");d.style.display="flex",d.style.flexDirection="row",d.style.whiteSpace="nowrap",d.textContent=o,d.appendChild(c.element),r.appendChild(d)}return t}var Tu=class extends H{constructor(e,t,r={}){super();this.element=e;this.viewerState=t;this.state=new jn;this.options={showLayerPanel:new Xe(!0),showViewerMenu:!1,showLayerHoverValues:new Xe(!0),...r},this.layerSpecification=this.registerDisposer(t.layerSpecification),this.viewerNavigationState=this.registerDisposer(new jO(t)),this.viewerNavigationState.register(this.state),this.layerSpecification instanceof Ap?this.state.add("layers",this.layerSpecification):this.state.add("layers",{changed:this.layerSpecification.changed,toJSON:()=>this.layerSpecification.layerManager.managedLayers.map(i=>i.name),reset:()=>{throw new Error("not implemented")},restoreState:()=>{throw new Error("not implemented")}}),e.classList.add("neuroglancer-layer-group-viewer"),this.registerDisposer(new vo(e)),this.layout=this.registerDisposer(new s0(this,"xy")),this.state.add("layout",this.layout),this.registerActionBindings(),this.registerDisposer(this.layerManager.useDirectly()),this.registerDisposer(yy(e,this.navigationState.position)),this.registerDisposer(this.options.showLayerPanel.changed.add(this.registerCancellable((0,HO.default)(()=>this.updateUI(),0)))),this.makeUI()}get perspectiveNavigationState(){return this.viewerNavigationState.projectionNavigationState}get navigationState(){return this.viewerNavigationState.navigationState}get selectionDetailsState(){return this.layerSpecification.root.selectionState}get display(){return this.viewerState.display}get selectedLayer(){return this.viewerState.selectedLayer}get layerManager(){return this.layerSpecification.layerManager}get chunkManager(){return this.layerSpecification.chunkManager}get mouseState(){return this.viewerState.mouseState}get showAxisLines(){return this.viewerState.showAxisLines}get wireFrame(){return this.viewerState.wireFrame}get showScaleBar(){return this.viewerState.showScaleBar}get showPerspectiveSliceViews(){return this.viewerState.showPerspectiveSliceViews}get inputEventBindings(){return this.viewerState.inputEventBindings}get visibility(){return this.viewerState.visibility}get visibleLayerRoles(){return this.viewerState.visibleLayerRoles}get crossSectionBackgroundColor(){return this.viewerState.crossSectionBackgroundColor}get perspectiveViewBackgroundColor(){return this.viewerState.perspectiveViewBackgroundColor}get scaleBarOptions(){return this.viewerState.scaleBarOptions}get changed(){return this.state.changed}bindAction(e,t){this.registerDisposer(ce(this.element,e,t))}registerActionBindings(){this.bindAction("add-layer",()=>{this.layerPanel&&this.layerPanel.addLayerMenu()}),this.bindAction("t-",()=>{this.navigationState.pose.translateNonDisplayDimension(0,-1)}),this.bindAction("t+",()=>{this.navigationState.pose.translateNonDisplayDimension(0,1)})}toJSON(){return{type:"viewer",...this.state.toJSON()}}reset(){this.state.reset()}restoreState(e){this.state.restoreState(e),dn(e,"crossSectionZoom",_l(this.viewerNavigationState.crossSectionScale)),dn(e,"perspectiveZoom",_l(this.viewerNavigationState.projectionScale)),dn(e,"perspectiveOrientation",this.viewerNavigationState.projectionOrientation)}makeUI(){this.element.style.flex="1",this.element.style.display="flex",this.element.style.flexDirection="column",this.element.appendChild(this.layout.element),this.updateUI()}updateUI(){let{options:e}=this,t=e.showLayerPanel.value;if(this.layerPanel!==void 0&&!t){this.layerPanel.dispose(),this.layerPanel=void 0;return}if(t&&this.layerPanel===void 0){let r=this.layerPanel=new g0(this.display,this.layerSpecification,this.viewerNavigationState,this.viewerState.selectedLayer.addRef(),()=>this.layout.toJSON(),this.options.showLayerHoverValues);if(e.showViewerMenu?(r.registerDisposer(fq(r.element,this)),r.element.title="Right click for options, drag to move/copy layer group."):r.element.title="Drag to move/copy layer group.",typeof NEUROGLANCER_SHOW_LAYER_BAR_EXTRA_BUTTONS!="undefined"&&NEUROGLANCER_SHOW_LAYER_BAR_EXTRA_BUTTONS===!0){{let a=document.createElement("button");a.textContent="Clear segments",a.title='De-select all objects ("x")',a.addEventListener("click",o=>{Db(o,o,{action:"clear-segments"})}),r.element.appendChild(a)}for(let a of["3d","xy","xz","yz"]){let o=document.createElement("button");o.textContent=a,o.title=`Switch to ${a} layout`,o.addEventListener("click",()=>{let l;this.layout.name===a?a!=="3d"?l=`${a}-3d`:l="4panel":l=a,this.layout.name=l}),r.element.appendChild(o)}}r.element.draggable=!0;let i=r.element;i.addEventListener("dragstart",a=>{er(r.element,"drag","Drag layer group to the left/top/right/bottom edge of a layer group, or to another layer bar/panel (including in another Neuroglancer window)"),p0(a,{manager:this.layerSpecification,layers:this.layerManager.managedLayers,layoutSpec:this.layout.toJSON()});let o=()=>{Oa&&Oa.viewer===this&&(Oa=void 0),this.unregisterDisposer(o)};Oa={viewer:this,disposer:o},this.registerDisposer(o);let l=this.toJSON();delete l.layers,a.dataTransfer.setData(vy,JSON.stringify(l)),r.element.style.backgroundColor="black",setTimeout(()=>{r.element.style.backgroundColor=""},0)}),r.element.addEventListener("dragend",()=>{Xt(i,"drag"),Cu(),Oa!==void 0&&Oa.viewer===this&&Oa.disposer()}),this.element.insertBefore(i,this.element.firstChild)}}disposed(){Me(this.element);let{layerPanel:e}=this;e!==void 0&&(e.dispose(),this.layerPanel=void 0),super.disposed()}};var JO=Symbol("layoutComponentContainer"),$l=class extends H{constructor(e,t,r){super();this.viewer=e;this.parent=r;this.changed=new ne;this.flex=new Ce(1,ot);this.element=document.createElement("div");let{element:i}=this;i.style.display="flex",i.style.flex="1",i.style.position="relative",i.style.alignItems="stretch",i[JO]=this,this.flex.changed.add(()=>{i.style.flexGrow=""+this.flex.value,this.changed.dispatch()}),this.setSpecification(t);let a=[],o=c=>{let d=document.createElement("div");d.className="neuroglancer-layout-split-drop-zone";let p;switch(d.style[c]="0",c){case"left":case"right":p="row",d.style.width="10px",d.style.height="100%";break;case"top":case"bottom":p="column",d.style.height="10px",d.style.width="100%";break}d.style.display="none",a.push({element:d,direction:p,orientation:c}),i.appendChild(d),YO(d,this.viewer.layerSpecification,()=>this.split(c).newContainer.component,p==="row"?"column":"row")};o("left"),o("right"),o("top"),o("bottom");let l=!1;i.addEventListener("dragenter",c=>{if(!l&&Kp(c)!==void 0){l=!0;for(let{element:d,direction:p,orientation:h}of a){if(r!==void 0&&p===r.direction&&((h==="left"||h==="top")&&r.get(0)!==this||(h==="bottom"||h==="right")&&r.get(r.length-1)!==this))continue;let{component:g}=this;g instanceof Xp&&g.direction===p||(d.style.display="block")}}},!0),i.addEventListener("drop",c=>{if(!!l){l=!1;for(let{element:d}of a)d.style.display="none"}},!0),i.addEventListener("dragleave",c=>{let{relatedTarget:d}=c;if(!!l&&!(d instanceof HTMLElement&&this.element.contains(d))){l=!1;for(let{element:p}of a)p.style.display="none"}},!0)}unsetComponent(){let e=this.componentValue;e!==void 0&&(e.changed.remove(this.changed.dispatch),this.element.removeChild(e.element),e.dispose())}get component(){return this.componentValue}setComponent(e){if(this.unsetComponent(),this.componentValue=e,e.changed.add(this.changed.dispatch),this.element.appendChild(e.element),e instanceof Tu){let{layerManager:t}=e,r=e.registerCancellable((0,v0.default)(()=>{t.managedLayers.length===0&&this.dispose()},0));e.registerDisposer(t.layersChanged.add(()=>{t.managedLayers.length===0&&r()})),r()}else if(e instanceof Xp){let t=e.registerCancellable((0,v0.default)(()=>{let{length:r}=e;if(r===0&&this.parent!==void 0)this.dispose();else if(r===1){let i=e.get(0).component,a;if(this.parent===void 0&&i instanceof Tu){a=i.layout.specification.toJSON(),i.viewerNavigationState.copyToParent();let o=i.layerManager.managedLayers,l=new Set(o),{layerSpecification:c}=i;c.rootLayers.filter(h=>l.has(h)||h.archived);let d=[],{managedLayers:p}=c.rootLayers;for(let h=0,g=p.length;h<g;++h)l.has(p[h])&&d.push(h);for(let h=0,g=o.length;h<g;++h)p[d[h]]=o[h];c.rootLayers.layersChanged.dispatch()}else a=i.toJSON();this.setSpecification(a)}},0));e.registerDisposer(e.changed.add(()=>{e.length<2&&t()})),t()}this.changed.dispatch()}toJSON(){let e=this.component.toJSON();return this.parent instanceof Xp&&(e.flex=this.flex.toJSON()),e}setSpecification(e){this.setComponent(hq(this,e)),this.flex.value=ie(e,"flex",ot,1)}static getFromElement(e){return e[JO]}disposed(){this.unsetComponent(),this.componentValue=void 0,super.disposed()}split(e){let t={type:"viewer"},{parent:r}=this;if(r!==void 0){if(e==="left"&&r.direction==="row"||e==="top"&&r.direction==="column")return{newContainer:r.insertChild(t,this),existingContainer:this};if(e==="right"&&r.direction==="row"||e==="bottom"&&r.direction==="column")return{newContainer:r.insertChild(t),existingContainer:this}}let i,a=this.component;a instanceof Sy?i=a.layerGroupViewer.toJSON():i=a.toJSON();let o,l,c=e==="left"||e==="right"?"row":"column";switch(e){case"left":case"top":o={type:c,children:[t,i]},l=0;break;case"right":case"bottom":o={type:c,children:[i,t]},l=1;break}this.setSpecification(o);let d=this.component;return{newContainer:d.get(l),existingContainer:d.get(1-l)}}};function qO(n){return{mouseState:n.mouseState,showAxisLines:n.showAxisLines,wireFrame:n.wireFrame,showScaleBar:n.showScaleBar,scaleBarOptions:n.scaleBarOptions,showPerspectiveSliceViews:n.showPerspectiveSliceViews,inputEventBindings:n.inputEventBindings,visibility:n.visibility,selectedLayer:n.selectedLayer,visibleLayerRoles:n.visibleLayerRoles,navigationState:n.navigationState.addRef(),perspectiveNavigationState:n.perspectiveNavigationState.addRef(),crossSectionBackgroundColor:n.crossSectionBackgroundColor,perspectiveViewBackgroundColor:n.perspectiveViewBackgroundColor}}var Sy=class extends H{constructor(e,t,r){super();this.element=e;this.layerGroupViewer=this.registerDisposer(new Tu(e,{display:r.display,layerSpecification:r.layerSpecification.addRef(),...qO(r)},{showLayerPanel:r.uiControlVisibility.showLayerPanel,showViewerMenu:!1,showLayerHoverValues:r.uiControlVisibility.showLayerHoverValues})),this.layerGroupViewer.layout.restoreState(t)}toJSON(){return this.layerGroupViewer.layout.specification.toJSON()}get changed(){return this.layerGroupViewer.layout.changed}};function YO(n,e,t,r){n.addEventListener("dragenter",i=>{Kp(i)!==void 0&&n.classList.add("neuroglancer-drag-over")}),n.addEventListener("dragleave",()=>{Xt(n,"drop"),n.classList.remove("neuroglancer-drag-over")}),n.addEventListener("dragover",i=>{let a=(o,l)=>{o.dropEffectMessage&&(l+=` (${o.dropEffectMessage})`),er(n,"drop",l),i.stopPropagation(),i.preventDefault()};if(y0(i)){let o=$O(i,e);qp(i,o.dropEffect),a(o,`Drop to ${o.dropEffect} layer group as new ${r}`);return}if(Kp(i)!==void 0){let o=WO(i,e,!1,!0);a(o,`Drop to ${o.dropEffect} layer as new ${r}`);return}}),n.addEventListener("drop",i=>{n.classList.remove("neuroglancer-drag-over"),Xt(n,"drop");let a,o;if(y0(i)){i.stopPropagation();try{o=JSON.parse(i.dataTransfer.getData(vy))}catch(d){return}if(a=hy(i,e,{forceCopy:!1,newTarget:!0}),a===void 0)return}else{if(a=hy(i,e,{forceCopy:Yp()==="copy",newTarget:!0}),a===void 0)return;o=a.layoutSpec}if(!a.initializeExternalLayers(i)){if(!a.moveSupported)for(let d of a.layers.keys())d.dispose();return}i.preventDefault();let l=i.dataTransfer.dropEffect=Yp();Cu(l);let c=t();a.updateArchiveStates(i);for(let d of a.layers.keys())c.layerSpecification.add(d);try{c.restoreState(o)}catch{c.layout.reset()}})}var Xp=class extends H{constructor(e,t,r,i){super();this.element=e;this.direction=t;this.container=i;this.changed=new ne;e.classList.add("neuroglancer-stack-layout"),e.classList.add(`neuroglancer-stack-layout-${t}`),e.style.display="flex",e.style.flexDirection=t,e.appendChild(this.makeDropPlaceholder(this));for(let a of r)this.insertChild(a)}get length(){return(this.element.childElementCount-1)/2}makeDropPlaceholder(e){let t=document.createElement("div");return t.className="neuroglancer-stack-layout-drop-placeholder",YO(t,this.viewer.layerSpecification,()=>{let r=t.nextElementSibling,i;return r!==null&&(i=$l.getFromElement(r)),this.insertChild({type:"viewer",layers:[]},i).component},this.direction==="row"?"column":"row"),e.registerDisposer(()=>{et(t)}),t.addEventListener("pointerdown",r=>{if("button"in r&&r.button!==0)return;let i=t.nextElementSibling;if(i===null)return;let a=$l.getFromElement(i),o=t.previousElementSibling;if(o===null)return;let l=$l.getFromElement(o);r.preventDefault();let c=()=>{er(t,"drag",`Drag to resize, current ${as[this.direction]} ratio is ${l.flex.value} : ${a.flex.value}`)};c(),un(r,d=>{let p=l.element.getBoundingClientRect(),h=a.element.getBoundingClientRect(),g=Math.max(.1,Math.min(.9,this.direction==="column"?(d.clientY-p.top)/(h.bottom-p.top):(d.clientX-p.left)/(h.right-p.left))),v=Number(l.flex.value)+Number(a.flex.value);l.flex.value=Math.round(g*v*100)/100,a.flex.value=Math.round((1-g)*v*100)/100,c()},()=>{Xt(t,"drag")})}),t}get viewer(){return this.container.viewer}get(e){return $l.getFromElement(this.element.children[e*2+1])}insertChild(e,t){let r=new $l(this.viewer,e,this),i=this.makeDropPlaceholder(r);r.element.classList.add("neuroglancer-stack-layout-child"),r.registerDisposer(r.changed.add(this.changed.dispatch)),r.registerDisposer(()=>{this.element.removeChild(r.element),this.changed.dispatch()});let a=t!==void 0?t.element:null;return this.element.insertBefore(r.element,a),this.element.insertBefore(i,a),this.changed.dispatch(),r}disposed(){this.clear(),super.disposed()}clear(){for(;this.length!==0;)this.get(0).dispose()}*[Symbol.iterator](){let{length:e}=this;for(let t=0;t<e;++t)yield this.get(t)}toJSON(){return{type:this.direction,children:Array.from(this).map(e=>e.toJSON())}}};function hq(n,e){let t=document.createElement("div");if(t.style.flex="1",t.style.width="0px",typeof e=="string"){if(n.parent!==void 0)throw new Error(`Invalid layout component specification: ${JSON.stringify(e)}`);return new Sy(t,e,n.viewer)}Q(e);let r=U(e,"type",Z);switch(r){case"row":case"column":return new Xp(t,r,U(e,"children",i=>{let a=ge(i,o=>o);if(n.parent===void 0&&a.length===0)throw new Error("Stack layout requires at least one child.");return a}),n);case"viewer":{let i=n.viewer,a=new Ap(i.layerSpecification.addRef()),o=new Tu(t,{display:i.display,layerSpecification:a,...qO(i)},{showLayerPanel:i.uiControlVisibility.showLayerPanel,showViewerMenu:!0,showLayerHoverValues:i.uiControlVisibility.showLayerHoverValues});try{o.restoreState(e)}catch(l){throw o.dispose(),l}return o}default:return new Sy(t,e,n.viewer)}}var S0=class extends H{constructor(e,t){super();this.viewer=e;this.defaultSpecification=t;this.container=this.registerDisposer(new $l(this.viewer,this.defaultSpecification,void 0))}get changed(){return this.container.changed}get element(){return this.container.element}reset(){this.container.setSpecification(this.defaultSpecification)}restoreState(e){this.container.setSpecification(e)}disposed(){super.disposed()}toJSON(){return this.container.toJSON()}};var KO='<svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-labelledby="eyeCrossedIconTitle"><path d="M22 12C22 12 19 18 12 18C5 18 2 12 2 12C2 12 5 6 12 6C19 6 22 12 22 12Z"></path><circle cx="12" cy="12" r="3"></circle><path d="M3 21L20 4"></path></svg>';var XO='<svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-labelledby="eyeIconTitle"><path d="M22 12C22 12 19 18 12 18C5 18 2 12 2 12C2 12 5 6 12 6C19 6 22 12 22 12Z"></path><circle cx="12" cy="12" r="3"></circle></svg>';var QO='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="cursorIconTitle"><polygon points="7 20 7 4 19 16 12 16 7 21"></polygon></svg>';var mq=Ie.fromObject({escape:{action:"cancel"}}),by=class extends H{constructor(e){super();this.layer=e;this.element=document.createElement("input");let{element:t}=this;t.classList.add("neuroglancer-layer-side-panel-name"),t.spellcheck=!1,t.autocomplete="off";let r=this.registerDisposer(new jt(t,mq));r.allShortcutsAreGlobal=!0,ce(t,"cancel",i=>{this.updateView(),t.blur(),i.stopPropagation(),i.preventDefault()}),t.title="Rename layer",this.registerDisposer(e.layerChanged.add(()=>this.updateView())),t.addEventListener("change",()=>this.updateModel()),t.addEventListener("blur",()=>this.updateModel()),this.updateView()}updateView(){this.element.value=this.layer.name}updateModel(){gg(this.layer,this.element.value)}},ZO=class extends H{constructor(e){super();this.layer=e;this.element=document.createElement("select");this.measureElement=document.createElement("div");let{element:t,measureElement:r}=this;t.classList.add("neuroglancer-layer-side-panel-type"),r.classList.add("neuroglancer-layer-side-panel-type-measure"),t.title="Change layer type",document.body.appendChild(r);for(let[i,a]of Mp){if(a.type!==i)continue;let o=document.createElement("option");o.textContent=a.typeAbbreviation,o.value=i,t.appendChild(o)}t.addEventListener("change",()=>{let i=t.value,a=Mp.get(i);Pp(this.layer.managedLayer,a)}),this.updateView()}updateView(){let e=this.layer.type,{element:t,measureElement:r}=this;r.textContent=this.layer.constructor.typeAbbreviation,t.value=e,t.style.width=`${r.offsetWidth}px`}disposed(){this.measureElement.remove()}},Qp=class extends Or{constructor(e,t){super(e,t.location);this.panelState=t;let r=this.layer=t.layer,{element:i}=this,{titleBar:a}=this.addTitleBar({});a.classList.add("neuroglancer-layer-side-panel-title"),a.appendChild(this.registerDisposer(new ZO(r)).element),a.appendChild(this.registerDisposer(new by(r.managedLayer)).element),this.registerDisposer(Ir(c=>{i.dataset.neuroglancerLayerVisible=c.toString()},{get value(){return r.managedLayer.visible},changed:r.managedLayer.layerChanged}));let o=this.registerDisposer(new nr({get value(){return r.managedLayer.pickEnabled},set value(c){r.managedLayer.pickEnabled=c},changed:r.managedLayer.layerChanged},{svg:QO,enableTitle:"Spatial object selection: disabled",disableTitle:"Spatial object selection: enabled"}));this.registerDisposer(new Zn({get value(){return r.managedLayer.supportsPickOption},changed:r.managedLayer.layerChanged},o.element)),a.appendChild(o.element);let l={get value(){return t!==r.panels.panels[0]},set value(c){c?t.pin():t.unpin()},changed:r.manager.root.layerManager.layersChanged};a.appendChild(this.registerDisposer(new nr(l,{text:"\u{1F4CC}\uFE0E",enableTitle:"Pin panel to this layer",disableTitle:"Unpin panel to this layer"})).element),this.registerDisposer(Ir(c=>{i.dataset.neuroglancerLayerPanelPinned=c.toString()},l)),a.appendChild(xi({title:"Delete layer",onClick:()=>{yo(this.layer.managedLayer)}})),this.tabView=new rb({makeTab:c=>r.tabs.options.get(c).getter(),selectedTab:t.selectedTab,tabs:this.registerDisposer(new Wf({get value(){return t.tabs.map(c=>{let{label:d,hidden:p}=r.tabs.options.get(c);return{id:c,label:d,hidden:(p==null?void 0:p.value)||!1}})},changed:t.tabsChanged})),handleTabElement:(c,d)=>{d.draggable=!0,d.addEventListener("dragstart",p=>{p.stopPropagation(),p.dataTransfer.setData("neuroglancer-side-panel","");let h="Drag tab to dock as new panel to the left/right/top/bottom of another panel";t.panels.panels.find(v=>v!==t&&v.location.visible)&&(h+=`, or move tab to other ${JSON.stringify(r.managedLayer.name)} panel`),er(d,"drag",h),this.sidePanelManager.startDrag({dropAsNewPanel:v=>{this.panelState.splitOffTab(c,{...eC,...v})},canDropAsTabs:v=>v instanceof Qp&&v.layer===this.layer&&v!==this?1:0,dropAsTab:v=>{this.panelState.moveTabTo(c,v.panelState)}},p)}),d.addEventListener("dragend",p=>{Xt(d,"drag"),this.sidePanelManager.endDrag()})}},this.visibility),this.tabView.element.style.flex="1",this.tabView.element.classList.add("neuroglancer-layer-side-panel-tab-view"),this.tabView.element.style.position="relative",this.tabView.element.appendChild(this.makeTabDropZone()),this.addBody(this.tabView.element),this.registerDisposer(t.tabsChanged.add(()=>{t.tabs.length===0&&(this.location.visible=!1)}))}makeDragSource(){return{...super.makeDragSource(),canDropAsTabs:e=>e instanceof Qp&&e.layer===this.layer&&e!==this?this.panelState.tabs.length:0,dropAsTab:e=>{this.panelState.mergeInto(e.panelState)}}}makeTabDropZone(){let e=document.createElement("div");return e.className="neuroglancer-side-panel-drop-zone",e.style.position="absolute",e.style.left="20px",e.style.right="20px",e.style.bottom="20px",e.style.top="20px",e.addEventListener("dragenter",t=>{var a;let{dragSource:r}=this.sidePanelManager,i=(a=r==null?void 0:r.canDropAsTabs)==null?void 0:a.call(r,this);!i||(e.classList.add(xl),er(e,"drop",`Move ${i} ${i===1?"tab":"tabs"} to this panel`),t.preventDefault())}),e.addEventListener("dragleave",()=>{Xt(e,"drop"),e.classList.remove(xl)}),e.addEventListener("dragover",t=>{var i;let{dragSource:r}=this.sidePanelManager;!((i=r==null?void 0:r.canDropAsTabs)==null?void 0:i.call(r,this))||t.preventDefault()}),e.addEventListener("drop",t=>{var i;Xt(e,"drop");let{dragSource:r}=this.sidePanelManager;!((i=r==null?void 0:r.canDropAsTabs)==null?void 0:i.call(r,this))||(e.classList.remove(xl),r.dropAsTab(this),t.preventDefault(),t.stopPropagation())}),e}},b0=class extends H{constructor(e,t){super();this.sidePanelManager=e;this.selectedLayerState=t;this.layerSidePanels=new Map;this.generation=0;this.layersNeedUpdate=!0;let r=()=>{this.layersNeedUpdate=!0,this.sidePanelManager.display.scheduleRedraw()};this.registerDisposer(t.changed.add(r)),this.registerDisposer(t.layerManager.layersChanged.add(r)),this.registerDisposer(e.beforeRender.add(()=>this.update()))}getSelectedUserLayer(){var e,t;return(t=(e=this.selectedLayerState.layer)==null?void 0:e.layer)!=null?t:void 0}update(){var a;if(!this.layersNeedUpdate)return;let{layerManager:e}=this.selectedLayerState,t=++this.generation;this.layersNeedUpdate=!1;let{layerSidePanels:r}=this,i=o=>{let l=r.get(o);l===void 0?(l={generation:t,unregister:this.sidePanelManager.registerPanel({location:o.location,makePanel:()=>new Qp(this.sidePanelManager,o)})},r.set(o,l)):l.generation=t};{let o=this.getSelectedUserLayer(),{location:l}=this.selectedLayerState;if(o===void 0||!l.visible)this.placeholderSelectedLayerPanel===void 0&&(this.placeholderSelectedLayerPanel=this.sidePanelManager.registerPanel({location:l,makePanel:()=>new Or(this.sidePanelManager,l)}));else{(a=this.placeholderSelectedLayerPanel)==null||a.call(this),this.placeholderSelectedLayerPanel=void 0;let c=o.panels.panels[0];c.location.value=l.value,i(c)}}for(let o of e.managedLayers){let l=o.layer;if(l===null)continue;let{panels:c}=l.panels;for(let d=1,p=c.length;d<p;++d)i(c[d])}for(let[o,l]of r)l.generation!==t&&(l.unregister(),r.delete(o))}disposed(){var e;(e=this.placeholderSelectedLayerPanel)==null||e.call(this);for(let{unregister:t}of this.layerSidePanels.values())t()}};var gq={...mi,side:"left",row:0},x0=class{constructor(){this.location=new tr(gq)}get changed(){return this.location.changed}restoreState(e){e!==void 0&&this.location.restoreState(e)}reset(){this.location.reset()}toJSON(){return Ai(this.location.toJSON())}},eN=class extends H{constructor(e){super();this.layer=e;this.element=document.createElement("div");let{element:t}=this,r=He({svg:XO,title:"Hide layer",onClick:()=>{this.layer.setVisible(!1)}}),i=He({svg:KO,title:"Show layer",onClick:()=>{this.layer.setVisible(!0)}});t.appendChild(i),t.appendChild(r);let a=()=>{let o=this.layer.visible;r.style.display=o?"":"none",i.style.display=o?"none":""};a(),this.registerDisposer(e.layerChanged.add(a))}};function yq(n){let{selectedLayer:e}=n.manager.root,t=new nr({get value(){return e.layer===n&&e.visible},set value(r){r?(e.layer=n,e.visible=!0):e.visible=!1},changed:e.changed},{backgroundScheme:"dark",enableTitle:"Show layer side panel",disableTitle:"Hide layer side panel",svg:cy});return t.element.classList.add("neuroglancer-layer-list-panel-item-controls"),t}var tN=class extends H{constructor(e,t){super();this.panel=e;this.layer=t;this.element=document.createElement("div");this.numberElement=document.createElement("div");this.generation=-1;let{element:r,numberElement:i}=this;r.classList.add("neuroglancer-layer-list-panel-item"),i.classList.add("neuroglancer-layer-list-panel-item-number"),r.appendChild(this.registerDisposer(new zn({get value(){return!t.archived},set value(o){t.setArchived(!o)},changed:t.layerChanged},{enableTitle:"Archive layer (disable and remove from layer groups)",disableTitle:"Unarchive layer (enable and add to all layer groups)"})).element),r.appendChild(i),r.appendChild(this.registerDisposer(new eN(t)).element),r.appendChild(this.registerDisposer(new by(t)).element),r.appendChild(this.registerDisposer(yq(t)).element);let a=xi({title:"Delete layer",onClick:()=>{yo(this.layer)}});a.classList.add("neuroglancer-layer-list-panel-item-delete"),r.appendChild(a),my(e,r,t,{isLayerListPanel:!0,getLayoutSpec:()=>{}}),wu(e,r,t,!0),r.addEventListener("click",o=>{o.ctrlKey?(e.selectedLayer.toggle(t),o.preventDefault()):o.altKey&&(t.pickEnabled=!t.pickEnabled,o.preventDefault())}),r.addEventListener("contextmenu",o=>{e.selectedLayer.toggle(t),o.stopPropagation(),o.preventDefault()})}},C0=class extends Or{constructor(e,t,r){super(e,r.location);this.manager=t;this.state=r;this.items=new Map;this.itemContainer=document.createElement("div");this.layerDropZone=document.createElement("div");this.dragEnterCount=0;this.generation=-1;let{itemContainer:i,layerDropZone:a}=this,{titleElement:o}=this.addTitleBar({title:""});this.titleElement=o,i.classList.add("neuroglancer-layer-list-panel-items"),this.addBody(i),a.style.flex="1";let l=this.registerCancellable(We(()=>this.render()));this.visibility.changed.add(l),this.registerDisposer(this.layerManager.layersChanged.add(l)),this.registerDisposer(this.selectedLayer.changed.add(l)),gy(this),wu(this,a,void 0,!0),this.render()}get layerManager(){return this.manager.layerManager}get selectedLayer(){return this.manager.selectedLayer}render(){let e=this,t=this.selectedLayer.layer,r=++this.generation,i=0,a=0,o=0;this.layerManager.updateNonArchivedLayerIndices();function*l(){let{items:d}=e,p=0;for(let g of e.layerManager.managedLayers)g.archived||++p;let h=`${(p+1).toString().length}ch`;for(let g of e.layerManager.managedLayers){g.visible?++i:g.archived?++o:++a;let v=d.get(g);v===void 0&&(v=e.registerDisposer(new tN(e,g)),d.set(g,v)),v.generation=r;let{nonArchivedLayerIndex:b}=g;v.numberElement.style.width=h,b===-1?v.numberElement.style.visibility="hidden":(v.numberElement.style.visibility="",v.numberElement.textContent=`${b+1}`),v.element.dataset.selected=(g===t).toString(),v.element.dataset.archived=g.archived.toString(),yield v.element}for(let[g,v]of d)r!==v.generation&&(d.delete(g),e.unregisterDisposer(v),v.dispose());yield e.layerDropZone}$n(this.itemContainer,l());let c="Layers";if(i||a||o){c+=" (";let d="";i+a&&(c+=`${i}/${a+i} visible`,d=", "),o&&(c+=`${d}${o} archived`),c+=")"}this.titleElement.textContent=c}},w0=class extends H{constructor(e){super();this.layerManager=e;this.element=document.createElement("div");let t=this.registerCancellable(We(()=>this.render()));this.registerDisposer(e.layersChanged.add(t)),this.render()}render(){let e=0,{managedLayers:t}=this.layerManager;for(let i of t)i.archived&&++e;let{element:r}=this;if(e!==0){let i=t.length;r.textContent=`${i-e}/${i}`}else r.textContent=""}};var Q2e=Ye(iN()),Z2e=Ye(T0()),eOe=Ye(cN()),tOe=Ye(pN());var L0=Ye(Cs()),fN=Ye(gt());var vq=100,k0=class extends Xi{constructor(e){super();this.viewer=e;this.parsedValue=null;this.debouncedValueUpdater=(0,fN.default)(()=>{let e=this.textEditor.getValue();try{let t=JSON.parse(e);this.parsedValue=t,this.applyButton.disabled=!1,this.textEditor.setOption("lint",void 0)}catch(t){this.parsedValue=null,this.applyButton.disabled=!0;let r=0,i=0,a="Unknown parse error";if(t instanceof Error){let o=t.message.match(/^((?:.|\n)*) in JSON at position ([0-9]+)$/);if(o!==null){a=o[1];let l=parseInt(o[2],10),d=e.substring(0,l).split(`
`);r=d.length-1,i=d[d.length-1].length}else a=t.message}this.textEditor.setOption("lint",{getAnnotations:()=>[{message:a,severity:"error",from:L0.default.Pos(r,i)}]})}},vq);this.content.classList.add("neuroglancer-state-editor");let t=this.applyButton=document.createElement("button");t.textContent="Apply changes",this.content.appendChild(t),t.addEventListener("click",()=>this.applyChanges()),t.disabled=!0;let r=this.closeButton=document.createElement("button");r.classList.add("close-button"),r.textContent="Close",this.content.appendChild(r),r.addEventListener("click",()=>this.dispose());let i=this.downloadButton=document.createElement("button");i.textContent="Download",i.title="Download state as a JSON file",this.content.appendChild(i),i.addEventListener("click",()=>this.downloadState()),this.textEditor=(0,L0.default)(a=>{},{value:"",mode:{name:"javascript",json:!0},foldGutter:!0,gutters:["CodeMirror-lint-markers","CodeMirror-foldgutter"]}),this.updateView(),this.textEditor.on("change",()=>{this.debouncedValueUpdater()}),this.content.appendChild(this.textEditor.getWrapperElement()),this.textEditor.refresh()}downloadState(){let e=document.createElement("a"),t=new Blob([this.getJson()],{type:"text/json"}),r=URL.createObjectURL(t);e.href=r,e.download="state.json",e.click(),document.body.removeChild(e)}applyChanges(){this.parsedValue!==null&&(this.viewer.state.reset(),this.viewer.state.restoreState(this.parsedValue)),this.applyButton.disabled=!0}updateView(){this.textEditor.setValue(this.getJson()),this.textEditor.execCommand("foldAll"),this.textEditor.execCommand("unfold")}getJson(){return JSON.stringify(Ht(this.viewer.state).value,null,"  ")}};var hN=Ye(gt());var Sq={side:"bottom",size:100,minSize:50,row:0,col:0,flex:1,visible:!1},E0=class{constructor(){this.location=new tr(Sq)}get changed(){return this.location.changed}restoreState(e){this.location.restoreState(e)}reset(){this.location.reset()}toJSON(){return Ai(this.location.toJSON())}};function bq(n){let e=new Map;function t(r,i){if(typeof r!="object"){e.set(i,""+r);return}for(let a of Object.keys(r))t(r[a],i+"."+a)}return t(n,""),e}function xq(n){let e=new Set;e.add(".type");let t=new Set;function r(i,a){for(let o of e)if(n[i].get(o)!==n[a].get(o))return!0;return!1}for(let i=0,a=n.length;i<a;++i){for(let l of n[i].keys())t.add(l);let o=[];for(let l=0;l<i;++l)r(i,l)||o.push(l);for(;o.length>0;){let l=o,c;for(let d of t){if(e.has(d))continue;let p=[];for(let h of o)n[h].get(d)===n[i].get(d)&&p.push(h);if(p.length<l.length&&(l=p,c=d),p.length===0)break}if(c===void 0)break;o=l,e.add(c)}}return Array.from(e)}function Cq(n,e){let t={};for(let r of e){let i=n.get(r);if(i!==void 0){if(r==="")return i;t[r]=i}}return JSON.stringify(t)}function xy(n){return Object.assign({type:n.RPC_TYPE_ID},n.key||{})}function D0(n){let e=n.map(bq),t=xq(e);return e.map(r=>Cq(r,t))}var wq=1e3,Lu=[{label:"Visible chunks/T",key:"visibleChunksTotal",getter:n=>{let e=0;for(let t=0;t<Uh;++t)e+=n[Zo(t,ba.VISIBLE)*Ca+xa.numChunks];return e}},{label:"Visible chunks/D",key:"visibleChunksDownloading",getter:n=>n[Zo(tt.DOWNLOADING,ba.VISIBLE)*Ca+xa.numChunks]},{label:"Visible chunks/M",key:"visibleChunksSystemMemory",getter:n=>n[Zo(tt.SYSTEM_MEMORY,ba.VISIBLE)*Ca+xa.numChunks]+n[Zo(tt.SYSTEM_MEMORY_WORKER,ba.VISIBLE)*Ca+xa.numChunks]},{label:"Visible chunks/G",key:"visibleChunksGpuMemory",getter:n=>n[Zo(tt.GPU_MEMORY,ba.VISIBLE)*Ca+xa.numChunks]},{label:"Visible chunks/F",key:"visibleChunksFailed",getter:n=>n[Zo(tt.FAILED,ba.VISIBLE)*Ca+xa.numChunks]},{label:"Visible memory",key:"visibleGpuMemory",getter:n=>n[Zo(tt.GPU_MEMORY,ba.VISIBLE)*Ca+xa.gpuMemoryBytes]},{label:"Download latency",key:"downloadLatency",getter:n=>n[tb(Gd.totalTime)]/n[tb(Gd.totalChunks)]}],P0=class extends Or{constructor(e,t,r){super(e,r.location);this.chunkQueueManager=t;this.displayState=r;this.data=void 0;this.requestDataTimerId=-1;this.dataRequested=!1;this.body=document.createElement("div");this.debouncedUpdateView=this.registerCancellable((0,hN.default)(()=>this.updateView(),0));let{body:i}=this;i.classList.add("neuroglancer-statistics-panel-body"),this.addTitleBar({title:"Chunk statistics"}),this.addBody(i),this.requestData()}disposed(){window.clearTimeout(this.requestDataTimerId),super.disposed()}requestData(){if(this.dataRequested)return;let{chunkQueueManager:e}=this;this.dataRequested=!0,e.getStatistics().then(t=>{this.dataRequested=!1,this.data=t,this.debouncedUpdateView(),this.requestDataTimerId=window.setTimeout(()=>{this.requestDataTimerId=-1,this.requestData()},wq)})}updateView(){let{data:e}=this;if(e===void 0)return;let t=document.createElement("table"),r=[];for(let[l,c]of e){let d=[l];for(let{getter:p}of Lu)d.push(p(c));r.push(d)}let i=D0(r.map(l=>xy(l[0]))),a=new Map;i.forEach((l,c)=>{a.set(r[c][0],l)});{let l=document.createElement("thead"),c=document.createElement("tr");l.appendChild(c);let d=h=>{let g=document.createElement("td");g.textContent=h,c.appendChild(g)};d("Name");let p;for(let{label:h}of Lu){let g=h.indexOf("/"),v=h;if(g!==-1){if(v=h.substring(0,g),v===p){++c.lastElementChild.colSpan;continue}p=v}d(v)}c=document.createElement("tr"),l.appendChild(c);{let h=document.createElement("td");c.appendChild(h)}for(let{label:h}of Lu){let g=h.indexOf("/"),v="";g!==-1&&(v=h.substring(g+1));let b=document.createElement("td");b.textContent=v,c.appendChild(b)}t.appendChild(l)}let o=document.createElement("tbody");for(let[l,...c]of r){let d=document.createElement("tr"),p=h=>{let g=document.createElement("td");g.textContent=h,d.appendChild(g)};p(a.get(l));for(let h of c)p(""+h);o.appendChild(d)}t.appendChild(o),Me(this.body),this.body.appendChild(t)}};var I0=class extends H{constructor(e,t={}){super();this.model=e;this.element=document.createElement("label");this.inputElement=document.createElement("input");let{validator:r,label:i}=t,{element:a,inputElement:o}=this;r===void 0&&(e instanceof Ce?r=e.validator:r=l=>l),this.validator=r,i!==void 0&&(a.textContent=i),a.appendChild(o),a.className="neuroglancer-number-input",o.type="text",this.registerDisposer(this.model.changed.add(()=>this.updateView())),this.registerEventListener(o,"change",()=>this.updateModel()),this.updateView()}updateView(){this.inputElement.value=""+this.model.value}updateModel(){let e=parseFloat(this.inputElement.value.trim());if(Number.isNaN(e)){this.updateView();return}try{e=this.validator(e),this.model.value=e}catch{this.updateView()}}disposed(){et(this.element),super.disposed()}};var Tq={...mi,side:"left",row:2},A0=class{constructor(){this.location=new tr(Tq)}get changed(){return this.location.changed}toJSON(){return Ai(this.location.toJSON())}reset(){this.location.reset()}restoreState(e){this.location.restoreState(e)}},M0=class extends Or{constructor(e,t,r){super(e,t.location);this.addTitleBar({title:"Settings"});let i=document.createElement("div");i.classList.add("neuroglancer-settings-body");let a=document.createElement("div");a.classList.add("neuroglancer-settings-scroll-container"),i.appendChild(a),this.addBody(i);{let d=this.registerDisposer(new Wp(r.title));d.element.placeholder="Title",d.element.classList.add("neuroglancer-settings-title"),a.appendChild(d.element)}let o=(d,p)=>{let h=this.registerDisposer(new I0(p,{label:d}));h.element.classList.add("neuroglancer-settings-limit-widget"),a.appendChild(h.element)};o("GPU memory limit",r.chunkQueueManager.capacities.gpuMemory.sizeLimit),o("System memory limit",r.chunkQueueManager.capacities.systemMemory.sizeLimit),o("Concurrent chunk requests",r.chunkQueueManager.capacities.download.itemLimit);let l=(d,p)=>{let h=document.createElement("label");h.textContent=d;let g=this.registerDisposer(new zn(p));h.appendChild(g.element),a.appendChild(h)};l("Show axis lines",r.showAxisLines),l("Show scale bar",r.showScaleBar),l("Show cross sections in 3-d",r.showPerspectiveSliceViews),l("Show default annotations",r.showDefaultAnnotations),l("Show chunk statistics",r.statisticsDisplayState.location.watchableVisible),l("Wire frame rendering",r.wireFrame),l("Enable prefetching",r.chunkQueueManager.enablePrefetch);let c=(d,p)=>{let h=document.createElement("label");h.textContent=d;let g=this.registerDisposer(new Ul(p));h.appendChild(g.element),a.appendChild(h)};c("Cross-section background",r.crossSectionBackgroundColor),c("Projection background",r.perspectiveViewBackgroundColor)}};var R0=class extends H{constructor(e,t){super();this.selectedLayer=e;this.toolBinder=t;this.element=document.createElement("div");this.viewContext=void 0;this.updateView=this.registerCancellable(We(()=>{let{viewContext:e}=this;e!==void 0&&(this.unregisterDisposer(e),e.dispose()),this.viewContext=e=this.registerDisposer(new H),Me(this.element);let{selectedTool:t}=this;t!==void 0&&this.element.appendChild(this.makeWidget(e,t));let r=Array.from(this.toolBinder.bindings);r.sort(([i],[a])=>lo(i,a));for(let[,i]of r)this.element.appendChild(this.makeWidget(e,i))}));let{element:r}=this;r.className="neuroglancer-annotation-tool-status",this.registerDisposer(e.changed.add(()=>this.selectedLayerChanged())),this.registerDisposer(t.changed.add(this.updateView)),this.registerDisposer(this.selectedLayer.layerManager.layersChanged.add(this.updateView)),this.selectedLayerChanged()}get selectedTool(){let e=this.selectedLayer.layer;if(e===void 0)return;let t=e.layer;if(t!==null)return t.tool.value}selectedLayerChanged(){let{unbindPreviousLayer:e}=this;e!==void 0&&e();let t=this.selectedLayer.layer;t!==void 0&&(this.unbindPreviousLayer=t.specificationChanged.add(()=>{this.updateView()})),this.updateView()}disposed(){let{unbindPreviousLayer:e}=this;e!==void 0&&e(),this.unbindPreviousLayer=void 0}makeWidget(e,t){let r=document.createElement("div");r.title="dblclick \u2192 unbind",t instanceof Br&&(r.title+=", click \u2192 bind key"),r.className="neuroglancer-annotation-tool-status-widget";let i=document.createElement("div");i.className="neuroglancer-annotation-tool-status-widget-layer-number";let{managedLayer:a}=t.layer;a.manager.rootLayers.updateNonArchivedLayerIndices();let o=a.nonArchivedLayerIndex;i.textContent=(o+1).toString();let l=document.createElement("div");if(l.className="neuroglancer-annotation-tool-status-widget-description",l.textContent=t.description,r.addEventListener("dblclick",()=>{t instanceof xp?t.layer.tool.value=void 0:this.toolBinder.set(t.keyBinding,void 0)}),t instanceof Br){let c=document.createElement("div");c.className="neuroglancer-annotation-tool-status-widget-key",c.textContent=t.keyBinding,r.appendChild(c),Fx(e,r,d=>t.layer.toolBinder.set(d,t.addRef()))}return r.appendChild(i),r.appendChild(l),r}};var gN=class extends H{constructor(e,t,r=""){super();this.gl=e;this.frameNumberCounter=t;let i=r+"chunk_worker.bundle.js";this.worker=new Worker(i),this.chunkQueueManager=this.registerDisposer(new Wd(new DS(this.worker),this.gl,this.frameNumberCounter,{gpuMemory:new Fc({defaultItemLimit:1e6,defaultSizeLimit:1e9}),systemMemory:new Fc({defaultItemLimit:1e7,defaultSizeLimit:2e9}),download:new Fc({defaultItemLimit:100,defaultSizeLimit:Number.POSITIVE_INFINITY}),compute:new Fc({defaultItemLimit:128,defaultSizeLimit:5e8})})),this.chunkQueueManager.registerDisposer(()=>this.worker.terminate()),this.chunkManager=this.registerDisposer(new zd(this.chunkQueueManager))}get rpc(){return this.chunkQueueManager.rpc}};var yN=["showHelpButton","showSettingsButton","showEditStateButton","showLayerListPanelButton","showSelectionPanelButton","showLayerSidePanelButton","showLocation","showAnnotationToolStatus"],vN=[...yN,"showLayerPanel","showLayerHoverValues"],Cy=[...vN,"showUIControls","showPanelBorders"];function Lq(){return Object.fromEntries(Cy.map(n=>[n,new Xe(!0)]))}function kq(n,e){for(let t of Cy){let r=e[t];r!==void 0&&(n[t].value=r)}}var Eq=typeof NEUROGLANCER_OVERRIDE_DEFAULT_VIEWER_OPTIONS!="undefined"?NEUROGLANCER_OVERRIDE_DEFAULT_VIEWER_OPTIONS:{showLayerDialog:!0,resetStateWhenEmpty:!0},SN=class extends jn{constructor(e){super();this.viewer=e;this.add("title",e.title),this.add("dimensions",e.coordinateSpace),this.add("relativeDisplayScales",e.relativeDisplayScales),this.add("displayDimensions",e.displayDimensions),this.add("position",e.position),this.add("crossSectionOrientation",e.crossSectionOrientation),this.add("crossSectionScale",e.crossSectionScale),this.add("crossSectionDepth",e.crossSectionDepthRange),this.add("projectionOrientation",e.projectionOrientation),this.add("projectionScale",e.projectionScale),this.add("projectionDepth",e.projectionDepthRange),this.add("layers",e.layerSpecification),this.add("showAxisLines",e.showAxisLines),this.add("wireFrame",e.wireFrame),this.add("showScaleBar",e.showScaleBar),this.add("showDefaultAnnotations",e.showDefaultAnnotations),this.add("showSlices",e.showPerspectiveSliceViews),this.add("gpuMemoryLimit",e.dataContext.chunkQueueManager.capacities.gpuMemory.sizeLimit),this.add("prefetch",e.dataContext.chunkQueueManager.enablePrefetch),this.add("systemMemoryLimit",e.dataContext.chunkQueueManager.capacities.systemMemory.sizeLimit),this.add("concurrentDownloads",e.dataContext.chunkQueueManager.capacities.download.itemLimit),this.add("selectedLayer",e.selectedLayer),this.add("crossSectionBackgroundColor",e.crossSectionBackgroundColor),this.add("projectionBackgroundColor",e.perspectiveViewBackgroundColor),this.add("layout",e.layout),this.add("statistics",e.statisticsDisplayState),this.add("helpPanel",e.helpPanelState),this.add("settingsPanel",e.settingsPanelState),this.add("selection",e.selectionDetailsState),this.add("layerListPanel",e.layerListPanelState),this.add("partialViewport",e.partialViewport),this.add("selectedStateServer",e.selectedStateServer)}restoreState(e){let{viewer:t}=this;super.restoreState(e),ie(e,"navigation",r=>{Q(r),ie(r,"pose",i=>{Q(i),ie(i,"position",a=>{Q(a),dn(a,"voxelCoordinates",t.position),ie(a,"voxelSize",o=>{let l=Pe(new Float64Array(3),o,ot);for(let c=0;c<3;++c)l[c]*=1e-9;t.coordinateSpace.value=Oe({valid:!1,names:["x","y","z"],units:["m","m","m"],scales:l})})}),dn(i,"orientation",t.crossSectionOrientation)}),dn(r,"zoomFactor",t.crossSectionScale.legacyJsonView)}),dn(e,"perspectiveOrientation",t.projectionOrientation),dn(e,"perspectiveZoom",t.projectionScale.legacyJsonView),dn(e,"perspectiveViewBackgroundColor",t.perspectiveViewBackgroundColor)}},Zp=class extends H{constructor(e,t={}){super();this.display=e;this.title=new Ce(void 0,Z);this.coordinateSpace=new Zs;this.position=this.registerDisposer(new qi(this.coordinateSpace));this.relativeDisplayScales=this.registerDisposer(new dg(this.coordinateSpace));this.displayDimensions=this.registerDisposer(new pg(this.coordinateSpace));this.displayDimensionRenderInfo=this.registerDisposer(new Lp(this.relativeDisplayScales.addRef(),this.displayDimensions.addRef()));this.crossSectionOrientation=this.registerDisposer(new go);this.crossSectionScale=this.registerDisposer(new $x(this.displayDimensionRenderInfo.addRef()));this.projectionOrientation=this.registerDisposer(new go);this.crossSectionDepthRange=this.registerDisposer(new kp(-10,this.displayDimensionRenderInfo));this.projectionDepthRange=this.registerDisposer(new kp(-50,this.displayDimensionRenderInfo));this.projectionScale=this.registerDisposer(new jx(this.displayDimensionRenderInfo.addRef()));this.navigationState=this.registerDisposer(new _a(new Ra(this.position.addRef(),this.displayDimensionRenderInfo.addRef(),this.crossSectionOrientation.addRef()),this.crossSectionScale.addRef(),this.crossSectionDepthRange.addRef()));this.perspectiveNavigationState=this.registerDisposer(new _a(new Ra(this.position.addRef(),this.displayDimensionRenderInfo.addRef(),this.projectionOrientation.addRef()),this.projectionScale.addRef(),this.projectionDepthRange.addRef()));this.mouseState=new rC;this.layerManager=this.registerDisposer(new Sg);this.selectedLayer=this.registerDisposer(new sC(this.layerManager.addRef()));this.showAxisLines=new Xe(!0,!0);this.wireFrame=new Xe(!1,!1);this.showScaleBar=new Xe(!0,!0);this.showPerspectiveSliceViews=new Xe(!0,!0);this.visibleLayerRoles=t1();this.showDefaultAnnotations=new Xe(!0,!0);this.crossSectionBackgroundColor=new Bo(K.fromValues(.5,.5,.5));this.perspectiveViewBackgroundColor=new Bo(K.fromValues(0,0,0));this.scaleBarOptions=new e0;this.partialViewport=new aS;this.statisticsDisplayState=new E0;this.helpPanelState=new c0;this.settingsPanelState=new A0;this.layerSelectedValues=this.registerDisposer(new iC(this.layerManager,this.mouseState));this.selectionDetailsState=this.registerDisposer(new oC(this.coordinateSpace,this.layerSelectedValues));this.selectedStateServer=new Ce("",Z);this.layerListPanelState=new x0;this.resetInitiated=new ne;this.uiControlVisibility={};this.visible=!0;this.toolInputEventMapBinder=(e,t)=>{t.registerDisposer(this.inputEventBindings.sliceView.addParent(e,Number.POSITIVE_INFINITY)),t.registerDisposer(this.inputEventBindings.perspectiveView.addParent(e,Number.POSITIVE_INFINITY))};this.toolBinder=this.registerDisposer(new Nx(this.toolInputEventMapBinder));let{dataContext:r=new gN(e.gl,e,t.bundleRoot),visibility:i=new wt(wt.VISIBLE),inputEventBindings:a={global:new Ie,sliceView:new Ie,perspectiveView:new Ie},element:o=e.makeCanvasOverlayElement(),dataSourceProvider:l=Lm({credentialsManager:uy}),uiConfiguration:c=Lq()}=t;this.visibility=i,this.inputEventBindings=a,this.element=o,this.dataSourceProvider=l,this.uiConfiguration=c,this.registerDisposer(Ir(v=>{this.display.applyWindowedViewportToElement(o,v)},this.partialViewport)),this.registerDisposer(()=>et(this.element)),this.dataContext=this.registerDisposer(r),kq(c,t);let d={...Eq,...t},{resetStateWhenEmpty:p,showLayerDialog:h}=d;for(let v of vN)this.uiControlVisibility[v]=this.makeUiControlVisibilityState(v);this.registerDisposer(this.uiConfiguration.showPanelBorders.changed.add(()=>{this.updateShowBorders()})),this.showLayerDialog=h,this.resetStateWhenEmpty=p,this.layerSpecification=new dC(this.display,this.dataSourceProvider,this.layerManager,this.chunkManager,this.selectionDetailsState,this.selectedLayer,this.navigationState.coordinateSpace,this.navigationState.pose.position,this.toolBinder),this.registerDisposer(e.updateStarted.add(()=>{this.onUpdateDisplay()})),this.showDefaultAnnotations.changed.add(()=>{this.showDefaultAnnotations.value?this.visibleLayerRoles.add(_n.DEFAULT_ANNOTATION):this.visibleLayerRoles.delete(_n.DEFAULT_ANNOTATION)}),this.registerDisposer(this.navigationState.changed.add(()=>{this.handleNavigationStateChanged()}));let g=this.registerCancellable((0,mN.default)(()=>{!this.wasDisposed&&this.layerManager.managedLayers.length===0&&this.resetStateWhenEmpty&&(this.navigationState.reset(),this.perspectiveNavigationState.pose.orientation.reset(),this.perspectiveNavigationState.zoomFactor.reset(),this.resetInitiated.dispatch(),!Wg&&this.showLayerDialog&&this.visibility.visible&&Tg(this.layerSpecification,this.selectedLayer))}));this.layerManager.layersChanged.add(g),g(),this.registerDisposer(this.dataContext.chunkQueueManager.visibleChunksChanged.add(()=>{this.layerSelectedValues.handleLayerChange()})),this.registerDisposer(this.dataContext.chunkQueueManager.visibleChunksChanged.add(()=>{this.visible&&e.scheduleRedraw()})),this.makeUI(),this.updateShowBorders(),this.registerActionListeners(),this.registerEventActionBindings(),this.registerDisposer(yy(o,this.navigationState.position)),this.state=new SN(this)}get chunkManager(){return this.dataContext.chunkManager}get chunkQueueManager(){return this.dataContext.chunkQueueManager}makeUiControlVisibilityState(e){let t=this.uiConfiguration.showUIControls,r=this.uiConfiguration[e];return this.registerDisposer(Tv((i,a)=>i&&a,t,r))}get inputEventMap(){return this.inputEventBindings.global}updateShowBorders(){let{element:e}=this,t="neuroglancer-show-panel-borders";this.uiConfiguration.showPanelBorders.value?e.classList.add(t):e.classList.remove(t)}makeUI(){let e=this.element;e.classList.add("neuroglancer-viewer"),e.classList.add("neuroglancer-noselect"),e.style.display="flex",e.style.flexDirection="column";let t=document.createElement("div");t.classList.add("neuroglancer-viewer-top-row"),t.style.display="flex",t.style.flexDirection="row",t.style.alignItems="stretch";let r=this.registerDisposer(new ws(this.navigationState.position,this.layerSpecification.coordinateSpaceCombiner));this.registerDisposer(new Zn(this.uiControlVisibility.showLocation,r.element)),t.appendChild(r.element);let i=this.registerDisposer(new KC(document.createElement("div"),this.mouseState,this.navigationState.coordinateSpace));if(i.element.style.flex="1",i.element.style.alignSelf="center",this.registerDisposer(new Zn(this.uiControlVisibility.showLocation,i.element)),t.appendChild(i.element),typeof NEUROGLANCER_CREDIT_LINK!="undefined"){let l=NEUROGLANCER_CREDIT_LINK;Array.isArray(l)||(l=[l]);for(let{url:c,text:d}of l){let p=document.createElement("a");p.style.marginRight="5px",p.href=c,p.textContent=d,p.style.fontFamily="sans-serif",p.style.color="yellow",p.target="_blank",t.appendChild(p)}}let a=this.registerDisposer(new R0(this.selectedLayer,this.toolBinder));if(t.appendChild(a.element),this.registerDisposer(new Zn(this.uiControlVisibility.showAnnotationToolStatus,a.element)),_O){let l=this.registerDisposer(new l0(this));t.appendChild(l.element)}{let{layerListPanelState:l}=this,c=this.registerDisposer(new nr(l.location.watchableVisible,{svg:oO,backgroundScheme:"dark",enableTitle:"Show layer list panel",disableTitle:"Hide layer list panel"}));c.element.insertAdjacentElement("afterbegin",this.registerDisposer(new w0(this.layerManager)).element),this.registerDisposer(new Zn(this.uiControlVisibility.showLayerListPanelButton,c.element)),t.appendChild(c.element)}{let{selectionDetailsState:l}=this,c=this.registerDisposer(new nr(l.location.watchableVisible,{svg:sO,backgroundScheme:"dark",enableTitle:"Show selection details panel",disableTitle:"Hide selection details panel"}));this.registerDisposer(new Zn(this.uiControlVisibility.showSelectionPanelButton,c.element)),t.appendChild(c.element)}{let{selectedLayer:l}=this,c=this.registerDisposer(new nr({get value(){return l.visible},set value(d){l.visible=d},changed:l.location.locationChanged},{svg:cy,backgroundScheme:"dark",enableTitle:"Show layer side panel",disableTitle:"Hide layer side panel"}));this.registerDisposer(new Zn(this.uiControlVisibility.showLayerSidePanelButton,c.element)),t.appendChild(c.element)}{let l=He({text:"{}",title:"Edit JSON state"});this.registerEventListener(l,"click",()=>{this.editJsonState()}),this.registerDisposer(new Zn(this.uiControlVisibility.showEditStateButton,l)),t.appendChild(l)}{let{helpPanelState:l}=this,c=this.registerDisposer(new nr(l.location.watchableVisible,{text:"?",backgroundScheme:"dark",enableTitle:"Show help panel",disableTitle:"Hide help panel"}));this.registerDisposer(new Zn(this.uiControlVisibility.showHelpButton,c.element)),t.appendChild(c.element)}{let{settingsPanelState:l}=this,c=this.registerDisposer(new nr(l.location.watchableVisible,{svg:lO,backgroundScheme:"dark",enableTitle:"Show settings panel",disableTitle:"Hide settings panel"}));this.registerDisposer(new Zn(this.uiControlVisibility.showSettingsButton,c.element)),t.appendChild(c.element)}this.registerDisposer(new Zn(Tv((...l)=>l.reduce((c,d)=>c||d,!1),...yN.map(l=>this.uiControlVisibility[l])),t)),e.appendChild(t),this.layout=this.registerDisposer(new S0(this,"4panel")),this.sidePanelManager=this.registerDisposer(new Ob(this.display,this.layout.element,this.visibility)),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.layerListPanelState.location,makePanel:()=>new C0(this.sidePanelManager,this.layerSpecification,this.layerListPanelState)})),this.registerDisposer(new b0(this.sidePanelManager,this.selectedLayer.addRef())),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.selectionDetailsState.location,makePanel:()=>new Bb(this.sidePanelManager,this.selectionDetailsState,this.layerSpecification,this.selectedLayer)})),e.appendChild(this.sidePanelManager.element),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.statisticsDisplayState.location,makePanel:()=>new P0(this.sidePanelManager,this.chunkQueueManager,this.statisticsDisplayState)})),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.helpPanelState.location,makePanel:()=>{let{inputEventBindings:l}=this;return new u0(this.sidePanelManager,this.helpPanelState,[["Global",l.global],["Cross section view",l.sliceView],["3-D projection view",l.perspectiveView]],this.layerManager,this.toolBinder)}})),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.settingsPanelState.location,makePanel:()=>new M0(this.sidePanelManager,this.settingsPanelState,this)}));let o=()=>{let l=this.visibility.visible;l!==this.visible&&(e.style.visibility=l?"inherit":"hidden",this.visible=l)};o(),this.registerDisposer(this.visibility.changed.add(o))}registerEventActionBindings(){let{element:e}=this;this.registerDisposer(new jt(e,this.inputEventMap)),this.registerDisposer(new vo(e))}bindAction(e,t){this.registerDisposer(ce(this.element,e,t))}registerActionListeners(){for(let e of["recolor","clear-segments"])this.bindAction(e,()=>{this.layerManager.invokeAction(e)});for(let e of["select"])this.bindAction(e,()=>{this.mouseState.updateUnconditionally(),this.layerManager.invokeAction(e)});this.bindAction("help",()=>this.toggleHelpPanel());for(let e=1;e<=9;++e)this.bindAction(`toggle-layer-${e}`,()=>{let t=this.layerManager.getLayerByNonArchivedIndex(e-1);t!==void 0&&t.setVisible(!t.visible)}),this.bindAction(`toggle-pick-layer-${e}`,()=>{let t=this.layerManager.getLayerByNonArchivedIndex(e-1);t!==void 0&&(t.pickEnabled=!t.pickEnabled)}),this.bindAction(`select-layer-${e}`,()=>{let t=this.layerManager.getLayerByNonArchivedIndex(e-1);t!==void 0&&(this.selectedLayer.layer=t,this.selectedLayer.visible=!0)});for(let e=0;e<26;++e){let t=String.fromCharCode(65+e);this.bindAction(`tool-${t}`,()=>{this.activateTool(t)})}this.bindAction("annotate",()=>{let e=this.selectedLayer.layer;if(e===void 0){Ee.showTemporaryMessage("The annotate command requires a layer to be selected.");return}let t=e.layer;if(t===null||t.tool.value===void 0){Ee.showTemporaryMessage(`The selected layer (${JSON.stringify(e.name)}) does not have an active annotation tool.`);return}t.tool.value.trigger(this.mouseState)}),this.bindAction("toggle-axis-lines",()=>this.showAxisLines.toggle()),this.bindAction("toggle-scale-bar",()=>this.showScaleBar.toggle()),this.bindAction("toggle-default-annotations",()=>this.showDefaultAnnotations.toggle()),this.bindAction("toggle-show-slices",()=>this.showPerspectiveSliceViews.toggle()),this.bindAction("toggle-show-statistics",()=>this.showStatistics())}toggleHelpPanel(){this.helpPanelState.location.visible=!this.helpPanelState.location.visible}activateTool(e){this.toolBinder.activate(e)}editJsonState(){new k0(this)}showStatistics(e=void 0){e===void 0&&(e=!this.statisticsDisplayState.location.visible),this.statisticsDisplayState.location.visible=e}get gl(){return this.display.gl}onUpdateDisplay(){this.visible&&(this.dataContext.chunkQueueManager.chunkUpdateDeadline=null)}handleNavigationStateChanged(){if(this.visible){let{chunkQueueManager:e}=this.dataContext;e.chunkUpdateDeadline===null&&(e.chunkUpdateDeadline=Date.now()+10)}}};var _0=class extends H{constructor(e,t,r,i){super();this.display=e;this.dataSourceProvider=t;this.dataContext=r;this.uiConfiguration=i;this.prefetchStates=new Map;this.changed=new ne;this.specification=[];this.updatePrefetchStates=this.registerCancellable((0,bN.default)(()=>{let{specification:e,prefetchStates:t}=this,r=new Set;for(let{state:i,priority:a}of e){let o=JSON.stringify(i);r.add(o);let l=t.get(o);l===void 0?(l=this.makePrefetchState(i,a),t.set(o,l)):l.visibility.value=a}for(let[i,a]of t)r.has(i)||(t.delete(i),a.dispose())},0));this.registerDisposer(r)}makePrefetchState(e,t){let r=new Zp(this.display,{showLayerDialog:!1,resetStateWhenEmpty:!1,dataSourceProvider:this.dataSourceProvider,dataContext:this.dataContext.addRef(),visibility:new wt(t),uiConfiguration:this.uiConfiguration});try{r.state.restoreState(e)}catch(i){console.log(`Error setting prefetch state: ${i.message}`)}return r}reset(){this.specification=[],this.changed.dispatch(),this.updatePrefetchStates()}restoreState(e){this.specification=ge(e,t=>{Q(t);let r=U(t,"state",Q),i=U(t,"priority",a=>a===void 0?0:ze(a));return{state:r,priority:i}}),this.changed.dispatch(),this.updatePrefetchStates()}toJSON(){let{specification:e}=this;return e.length===0?void 0:this.specification}};var xN=Ye(gt());var V0=class extends H{constructor(e){super();this.viewer=e;this.actionSet=new Ce(new Set,e=>new Set(on(e)));this.actionDisposers=[];this.sendActionRequested=new $e;this.actionSet.changed.add((0,xN.default)(()=>this.updateActions(),0))}clearListeners(){for(let e of this.actionDisposers)e();this.actionDisposers.length=0}disposed(){this.clearListeners(),super.disposed()}updateActions(){this.clearListeners();for(let e of this.actionSet.value)this.actionDisposers.push(ce(this.viewer.element,e,()=>this.handleAction(e)))}handleAction(e){let{mouseState:t,layerSelectedValues:r}=this.viewer,i={};t.updateUnconditionally()&&(i.mousePosition=Array.prototype.slice.call(t.position)),i.selectedValues=r.toJSON(),i.viewerState=Ht(this.viewer.state).value,this.sendActionRequested.dispatch(e,JSON.parse(JSON.stringify(i)))}};var CN=Ye(gt());var O0=class extends H{constructor(){super();this.existingMessages=new Map;this.changed=new ne;this.messages=new Map;this.changed.add(this.registerCancellable((0,CN.default)(()=>this.updateMessages(),0)))}reset(){this.messages.clear(),this.changed.dispatch()}restoreState(e){Q(e),this.messages.clear();for(let t of Object.keys(e)){let r=e[t],i=Z(r);this.messages.set(t,i)}this.changed.dispatch()}disposed(){for(let e of this.existingMessages.values())e.dispose();this.existingMessages.clear()}updateMessages(){let{existingMessages:e}=this,t=this.messages;for(let[r,i]of e){let a=t.get(r);a===void 0?(i.dispose(),e.delete(r)):i.setText(a)}for(let[r,i]of t){if(e.has(r))continue;let a=new Ee;a.setText(i),e.set(r,a)}}toJSON(){let e={};for(let[t,r]of this.messages)e[t]=r;return e}};var TN=Ye(gt()),LN=Ye(Ml());function wN(n){return new Promise(e=>{let t=new Blob([n],{type:"application/octet-stream"}),r=new FileReader;r.onload=function(i){let a=i.target.result;e(a.substr(a.indexOf(",")+1))},r.readAsDataURL(t)})}var N0=class extends H{constructor(e){super();this.viewer=e;this.sendScreenshotRequested=new $e;this.sendStatisticsRequested=new $e;this.requestState=new Ce(void 0,Vt);this.wasAlreadyVisible=!1;this.previousRequest=void 0;this.debouncedMaybeSendScreenshot=this.registerCancellable((0,TN.default)(()=>this.maybeSendScreenshot(),0));this.statisticsRequested=!1;this.throttledSendStatistics=this.registerCancellable((0,LN.default)(async e=>{if(this.requestState.value!==e||this.previousRequest===e||(this.throttledSendStatistics(e),this.statisticsRequested))return;this.statisticsRequested=!0;let t=await this.viewer.chunkQueueManager.getStatistics();if(this.statisticsRequested=!1,this.wasDisposed||this.requestState.value!==e||this.previousRequest===e)return;let r=D0(Array.from(t,d=>xy(d[0]))),i=0,a=[],o=new Float64Array(eb);for(let[d,p]of t){for(let g=0;g<eb;++g)o[g]+=p[g];let h={};h.id=xy(d),h.distinctId=r[i];for(let g of Lu)h[g.key]=g.getter(p);++i,a.push(h)}let l={};for(let d of Lu)l[d.key]=d.getter(o);let c={viewerState:JSON.parse(JSON.stringify(Ht(this.viewer.state).value)),selectedValues:JSON.parse(JSON.stringify(this.viewer.layerSelectedValues)),screenshotStatistics:{id:e,chunkSources:a,total:l}};this.sendStatisticsRequested.dispatch(c)},1e3,{leading:!1,trailing:!0}));this.requestState.changed.add(this.debouncedMaybeSendScreenshot),this.registerDisposer(e.display.updateFinished.add(this.debouncedMaybeSendScreenshot))}isReady(){let{viewer:e}=this;if(e.chunkQueueManager.flushPendingChunkUpdates(),!e.display.isReady())return!1;for(let t of e.layerManager.managedLayers)if(!t.isReady())return!1;return!0}async maybeSendScreenshot(){let e=this.requestState.value,{previousRequest:t}=this,{layerSelectedValues:r}=this.viewer;if(e===void 0||e===t){this.wasAlreadyVisible=!1,this.throttledSendStatistics.cancel();return}let{viewer:i}=this;if(!this.isReady()){this.wasAlreadyVisible=!1,this.throttledSendStatistics(e);return}if(!this.wasAlreadyVisible){this.throttledSendStatistics(e),this.wasAlreadyVisible=!0,this.debouncedMaybeSendScreenshot();return}this.wasAlreadyVisible=!1,this.previousRequest=e,this.throttledSendStatistics.cancel(),i.display.draw();let a=i.display.canvas.toDataURL(),{width:o,height:l}=i.display.canvas,c="data:image/png;base64,",d,p,h;if(!a.startsWith(c))d="",p="";else if(d="image/png",p=a.substring(c.length),e.endsWith("_includeDepth")){let v=i.display.getDepthArray();LE(v,nn.LITTLE),h=await wN(v)}let g={viewerState:JSON.parse(JSON.stringify(Ht(this.viewer.state).value)),selectedValues:JSON.parse(JSON.stringify(r)),screenshot:{id:e,image:p,imageType:d,depthData:h,width:o,height:l}};this.sendScreenshotRequested.dispatch(g)}};function kN(n){n.registerEventListener(document,"copy",e=>{if(Hd(e.target))return;let t=document.getSelection();if(t!==null&&t.type==="Range")return;let{mouseState:r}=n,{clipboardData:i}=e;r.updateUnconditionally()&&i!==null&&i.setData("text/plain",Array.prototype.slice.call(r.position)),e.preventDefault()})}function Dq(n,e){let t=String.raw`^[\[\]{}()\s,]*`;for(let a=0;a<e;++a)a!==0&&(t+=String.raw`[,\s]+`),t+=String.raw`(\d+(?:\.\d+)?)`;t+=String.raw`[\[\]{}()\s,]*$`;let r=n.match(t);if(r===null)return;let i=new Float32Array(e);for(let a=0;a<e;++a){let o=Number(r[a+1]);if(!Number.isFinite(o))return;i[a]=o}return i}function EN(n){n.registerEventListener(document,"paste",e=>{if(Hd(e.target))return;let{clipboardData:t}=e;if(t!==null){let r=t.getData("text/plain"),i=Dq(r,n.coordinateSpace.value.rank);i!==void 0&&(n.navigationState.position.value=i)}e.preventDefault()})}function DN(){return An(document,"contextmenu",n=>{n.preventDefault()})}function PN(){return An(document,"wheel",n=>{n.ctrlKey&&n.preventDefault()},{passive:!1})}var IN=Symbol("SingleTextureVolumeChunk.textureUnit"),wy=Symbol("SingleTextureVolumeChunk.textureLayout"),ef=class extends H{constructor(e,t){super();this.shaderKey=e;this.dataType=t}defineShader(e,t){e.addTextureSampler(this.shaderSamplerType,"uVolumeChunkSampler",IN)}beginDrawing(e,t){let r=t.textureUnit(IN);e.activeTexture(WebGL2RenderingContext.TEXTURE0+r),t[wy]=null}endDrawing(e,t){e.bindTexture(jo[this.shaderSamplerType],null),t[wy]=null}bindChunk(e,t,r,i,a,o,l){let c=r.textureLayout;(t[wy]!==c||l)&&(t[wy]=c,this.setupTextureLayout(e,t,c,i,a,o)),e.bindTexture(jo[this.shaderSamplerType],r.texture)}beginSource(e,t){}},tf=class extends Zb{constructor(e,t){super(e,t);this.texture=null;this.data=t.data}copyToGPU(e){if(super.copyToGPU(e),this.data===null)return;let t=this.texture=e.createTexture(),r=jo[this.chunkFormat.shaderSamplerType];e.bindTexture(r,t),this.setTextureData(e),e.bindTexture(r,null)}freeGPUMemory(e){super.freeGPUMemory(e),this.data!==null&&(e.deleteTexture(this.texture),this.texture=null,this.textureLayout.dispose(),this.textureLayout=null)}};var nf=class extends H{constructor(e,t,r){super();this.chunkDataSize=t;this.textureDims=r;this.textureShape=new Uint32Array(this.textureDims);let i=t.length,a=0;for(let h of t)h!==1&&++a;let o=this.strides=new Uint32Array(i*r),l=r===3?e.max3dTextureSize:e.maxTextureSize,c=0,d=1,{textureShape:p}=this;p.fill(1);for(let h=0;h<i;++h){let g=t[h];if(g===1)continue;let v=g*d,b;v>l||d!==1&&c+a<r?(++c,d=g,b=1):(b=d,d=v),o[r*h+c]=b,p[c]=d}}static get(e,t,r){return e.memoize.get(`sliceview.UncompressedTextureLayout:${t.join()}:${r}`,()=>new nf(e,t,r))}},B0=new Uint32Array(3*5),Ty=class extends ef{constructor(e,t,r,i){super(r,t);this.textureDims=i;hi(this,t),this.shaderSamplerType=`${this.samplerPrefix}sampler${i}D`,this.textureAccessHelper=new xb("chunkData",i)}static get(e,t,r){let i=`sliceview.UncompressedChunkFormat:${t}:${r}`;return e.memoize.get(i,()=>new Ty(e,t,i,r))}defineShader(e,t){super.defineShader(e,t);let{textureDims:r}=this,i=`ivec${this.textureDims}`,{textureAccessHelper:a}=this,o=(4+t)*r;B0.length<o&&(B0=new Uint32Array(o)),e.addUniform(`highp ${i}`,"uVolumeChunkStrides",4+t),e.addFragmentCode(a.getAccessor("readVolumeData","uVolumeChunkSampler",this.dataType));let c=`
${Ot(this.dataType)} getDataValueAt(highp ivec3 p`;for(let d=0;d<t;++d)c+=`, highp int channelIndex${d}`;c+=`) {
  highp ${i} offset = uVolumeChunkStrides[0]
                     + p.x * uVolumeChunkStrides[1]
                     + p.y * uVolumeChunkStrides[2]
                     + p.z * uVolumeChunkStrides[3];
`;for(let d=0;d<t;++d)c+=`
  offset += channelIndex${d} * uVolumeChunkStrides[${4+d}];
`;c+=`
  return readVolumeData(offset);
}
`,e.addFragmentCode(c)}setupTextureLayout(e,t,r,i,a,o){let l=B0,c=o.length,{strides:d}=r,p=i.length,{textureDims:h}=this;for(let v=0;v<h;++v){let b=0;for(let x=0;x<p;++x)b+=i[x]*d[x*h+v];l[v]=b}for(let v=0;v<3;++v){let b=a[v];if(!(b>=p))for(let x=0;x<h;++x)l[(v+1)*h+x]=d[b*h+x]}for(let v=0;v<c;++v){let b=o[v];if(b===-1)l.fill(0,(4+v)*h,(4+v+1)*h);else for(let x=0;x<h;++x)l[(4+v)*h+x]=d[b*h+x]}let g=(4+c)*h;h===3?e.uniform3iv(t.uniform("uVolumeChunkStrides"),l,0,g):e.uniform2iv(t.uniform("uVolumeChunkStrides"),l,0,g)}getTextureLayout(e,t){return nf.get(e,t,this.textureDims)}setTextureData(e,t,r){let{textureShape:i}=t;(this.textureDims===3?D1:E1)(e,this,r,i[0],i[1],i[2])}},AN=class extends tf{setTextureData(e){let{source:t}=this,{chunkFormatHandler:r}=t,{chunkFormat:i}=r,a;this.chunkDataSize===t.spec.chunkDataSize?this.textureLayout=a=r.textureLayout.addRef():this.textureLayout=a=i.getTextureLayout(e,this.chunkDataSize),this.chunkFormat.setTextureData(e,a,this.data)}getValueAt(e){let{data:t}=this;if(t===null)return this.source.spec.fillValue;let{chunkFormat:r}=this,{chunkDataSize:i}=this,a=0,o=1,l=e.length;for(let d=0;d<l;++d)a+=o*e[d],o*=i[d];switch(r.dataType){case W.UINT8:case W.INT8:case W.FLOAT32:case W.UINT16:case W.INT16:case W.UINT32:case W.INT32:return t[a];case W.UINT64:{let d=a*2;return new X(t[d],t[d+1])}}}},MN=class extends H{};function Pq(n,e,t,r,i){let{dataType:a}=e,o=new th[a](TE[a]);a===W.UINT64?(o[0]=t.low,o[1]=t.high):o[0]=t;let l=new Uint32Array(r);l.fill(1);let c=new nf(n,l,i);c.strides.fill(0);let d=n.createTexture(),p=jo[e.shaderSamplerType];n.bindTexture(p,d),e.setTextureData(n,c,o),n.bindTexture(p,null);let h=new MN;return h.textureLayout=c,h.texture=d,h}var RN=class extends H{constructor(e,t){super();let r=0;for(let a of t.chunkDataSize)a>1&&++r;let i=r>=3?3:2;this.chunkFormat=this.registerDisposer(Ty.get(e,t.dataType,i)),this.textureLayout=this.registerDisposer(this.chunkFormat.getTextureLayout(e,t.chunkDataSize)),this.fillValueChunk=this.registerDisposer(e.memoize.get(`sliceview.UncompressedChunkFormat.fillValue:${t.chunkDataSize.length}:${t.dataType}:${t.fillValue}:${i}`,()=>Pq(e,this.chunkFormat,t.fillValue,t.chunkDataSize.length,i)))}getChunk(e,t){let r=new AN(e,t);return r.data===null&&(r.texture=this.fillValueChunk.texture,r.textureLayout=this.fillValueChunk.textureLayout),r}};wm((n,e)=>e.compressedSegmentationBlockSize==null?new RN(n,e):null);function Ly(n,e,t,r,i,a){let o=0,l=0,c=1,d=1;for(let x=0;x<3;++x){let C=i[x],T=r[x],P=Math.floor(C/T),I=C%T;o+=P*c,c*=Math.ceil(t[x]/T),l+=I*d,d*=T}let p=e+o*2,h=n[p],g=n[p+1],v=h&16777215,b=h>>24&255;if(b>0){let C=(e+g&16777215)+Math.floor(l*b/32),T=n[C],P=l*b%32,I=T>>P&(1<<b)-1;v+=a*I}return v}function _N(n,e,t,r,i){let a=Ly(n,e,t,r,i,1)+e;return n[a]}function VN(n,e,t,r,i,a){let o=Ly(e,t,r,i,a,2)+t;return n.low=e[o],n.high=e[o+1],n}var rf=class extends H{constructor(e,t){super();let r=this.subchunkGridSize=K.create();for(let i=0;i<3;++i)r[i]=Math.ceil(e[i]/t[i]);this.singleton=!1}static get(e,t,r){return e.memoize.get(`sliceview.CompressedSegmentationTextureLayout:${No(t)},${No(r)}`,()=>new rf(t,r))}},Iq=hi(new Hi,W.UINT32),F0=new Uint32Array(4*4),ky=class extends ef{constructor(e,t,r,i){super(i,e);this.subchunkSize=t;this.numChannels=r;this.textureAccessHelper=new po("chunkData")}static get(e,t,r,i){let a=`sliceview.CompressedSegmentationChunkFormat:${t}:${i}`,o=`${a}:${No(r)}`;return e.memoize.get(o,()=>new ky(t,r,i,a))}get shaderSamplerType(){return"usampler2D"}defineShader(e,t){super.defineShader(e,t);let r=4*(4+t);F0.length<r&&(F0=new Uint32Array(r));let{textureAccessHelper:i}=this;i.defineShader(e);let a=d=>"compressedSegmentationChunkFormat_"+d;e.addUniform("highp ivec3","uSubchunkGridSize"),e.addUniform("highp ivec3","uSubchunkSize"),e.addUniform("highp ivec4","uVolumeChunkStrides",4+t),e.addFragmentCode(eP);let{dataType:o}=this,l=Ot(o);o===W.UINT64?e.addFragmentCode(At):e.addFragmentCode(nl),e.addFragmentCode(i.getAccessor(a("readTextureValue"),"uVolumeChunkSampler",W.UINT32,1));let c=`
uint ${a("getChannelOffset")}(int channelIndex) {
  if (channelIndex == 0) {
    return ${this.numChannels}u;
  }
  return ${a("readTextureValue")}(uint(channelIndex)).value;
}
${l} getDataValueAt(highp ivec3 p`;for(let d=0;d<t;++d)c+=`, highp int channelIndex${d}`;c+=`) {
  highp ivec4 chunkPositionFull = uVolumeChunkStrides[0] +
                     + p.x * uVolumeChunkStrides[1]
                     + p.y * uVolumeChunkStrides[2]
                     + p.z * uVolumeChunkStrides[3];
`;for(let d=0;d<t;++d)c+=`
  chunkPositionFull += channelIndex${d} * uVolumeChunkStrides[${4+d}];
`;c+=`
  highp ivec3 chunkPosition = chunkPositionFull.xyz;

  // TODO: maybe premultiply this and store as uniform.
  ivec3 subchunkGridPosition = chunkPosition / uSubchunkSize;
  int subchunkGridOffset = getFortranOrderIndex(subchunkGridPosition, uSubchunkGridSize);

  int channelOffset = int(${a("getChannelOffset")}(chunkPositionFull[3]));

  // TODO: Maybe just combine this offset into subchunkGridStrides.
  int subchunkHeaderOffset = subchunkGridOffset * 2 + channelOffset;

  highp uint subchunkHeader0 = ${a("readTextureValue")}(uint(subchunkHeaderOffset)).value;
  highp uint subchunkHeader1 = ${a("readTextureValue")}(uint(subchunkHeaderOffset + 1)).value;
  highp uint outputValueOffset = (subchunkHeader0 & 0xFFFFFFu) + uint(channelOffset);
  highp uint encodingBits = subchunkHeader0 >> 24u;
  if (encodingBits > 0u) {
    ivec3 subchunkPosition = chunkPosition - subchunkGridPosition * uSubchunkSize;
    int subchunkOffset = getFortranOrderIndex(subchunkPosition, uSubchunkSize);
    uint encodedValueBaseOffset = subchunkHeader1 + uint(channelOffset);
    uint encodedValueOffset = encodedValueBaseOffset + uint(subchunkOffset) * encodingBits / 32u;
    uint encodedValue = ${a("readTextureValue")}(encodedValueOffset).value;
    uint wordOffset = uint(subchunkOffset) * encodingBits % 32u;
    uint encodedValueShifted = encodedValue >> wordOffset;
    uint decodedValue = encodedValueShifted - (encodedValueShifted >> encodingBits << encodingBits);
    outputValueOffset += decodedValue * ${this.dataType===W.UINT64?"2u":"1u"};
  }
  ${l} result;
`,o===W.UINT64?c+=`
  result.value[0] = ${a("readTextureValue")}(outputValueOffset).value;
  result.value[1] = ${a("readTextureValue")}(outputValueOffset+1u).value;
`:c+=`
  result.value = ${a("readTextureValue")}(outputValueOffset).value;
`,c+=`
  return result;
}
`,e.addFragmentCode(c)}setupTextureLayout(e,t,r,i,a,o){let{subchunkGridSize:l}=r;e.uniform3i(t.uniform("uSubchunkGridSize"),l[0],l[1],l[2]);let c=F0,d=o.length;if(c.fill(0),!r.singleton){for(let p=0;p<3;++p){c[p]=i[p];let h=a[p];h!==-1&&(c[4*(p+1)+h]=1)}for(let p=0;p<d;++p){let h=o[p];h!==-1&&(c[4*(4+p)+h]=1)}}e.uniform4iv(t.uniform("uVolumeChunkStrides"),c,0,(d+4)*4)}setTextureData(e,t,r){rs(e,Iq,r)}getTextureLayout(e,t){return rf.get(e,t,this.subchunkSize)}beginSource(e,t){super.beginSource(e,t);let{subchunkSize:r}=this;e.uniform3i(t.uniform("uSubchunkSize"),r[0],r[1],r[2])}},ON=class extends tf{setTextureData(e){let{data:t}=this,{chunkFormat:r}=this,i=this.textureLayout=r.getTextureLayout(e,this.chunkDataSize);r.setTextureData(e,i,t)}getValueAt(e){let{chunkDataSize:t,chunkFormat:r}=this,{data:i}=this;if(i===null)return this.source.spec.fillValue;let a=i[e[3]||0];if(r.dataType===W.UINT64){let o=new X;return VN(o,i,a,t,r.subchunkSize,e),o}else return _N(i,a,t,r.subchunkSize,e)}},NN=class extends H{};function Aq(n,e,t){let{dataType:r,numChannels:i}=e,a=new Uint32Array(i+2+(r===W.UINT64?2:1));a[0]=i,a[i]=2,r===W.UINT64?(a[i+2]=t.low,a[i+3]=t.high):a[i+2]=t;let o=new rf(Uint32Array.of(1,1,1),K.fromValues(1,1,1));o.singleton=!0;let l=n.createTexture(),c=jo[e.shaderSamplerType];n.bindTexture(c,l),e.setTextureData(n,o,a),n.bindTexture(c,null);let d=new NN;return d.textureLayout=o,d.texture=l,d}var BN=class extends H{constructor(e,t){super();let{dataType:r}=t;if(r!==W.UINT64&&r!==W.UINT32)throw new Error(`Unsupported compressed segmentation data type: ${W[r]}`);this.chunkFormat=this.registerDisposer(ky.get(e,t.dataType,t.compressedSegmentationBlockSize,t.chunkDataSize[3]||1)),this.fillValueChunk=this.registerDisposer(e.memoize.get(`sliceview.CompressedSegmentationChunkFormat.fillValue:${t.dataType}:${t.fillValue}:${this.chunkFormat.numChannels}`,()=>Aq(e,this.chunkFormat,t.fillValue)))}getChunk(e,t){let r=new ON(e,t);return r.data===null&&(r.texture=this.fillValueChunk.texture,r.textureLayout=this.fillValueChunk.textureLayout),r}};wm((n,e)=>e.compressedSegmentationBlockSize!=null?new BN(n,e):null);function FN(n,e=document.getElementById("neuroglancer-container")){try{let t=new oS(e);return new Zp(t,n)}catch(t){throw Ee.showMessage(`Error: ${t.message}`),t}}function UN(n){return DN(),PN(),FN(n)}function GN(n){let e=We(()=>{var i;let r=(i=n.value)==null?void 0:i.trim();r?document.title=`${r} - neuroglancer`:document.title="neuroglancer"}),t=n.changed.add(e);return e(),e.flush(),()=>{t(),e.cancel()}}var WN=Ye(gt());function Mq(n){return encodeURI(n).replace(/[!'()*;,]/g,function(e){return"%"+e.charCodeAt(0).toString(16).toUpperCase()})}var U0=class extends H{constructor(e,t,r={}){super();this.root=e;this.credentialsManager=t;this.parseError=new ke(void 0);let{updateDelayMilliseconds:i=200,defaultFragment:a="{}"}=r;this.registerEventListener(window,"hashchange",()=>this.updateFromUrlHash());let o=(0,WN.default)(()=>this.setUrlHash(),i);this.registerDisposer(e.changed.add(o)),this.registerDisposer(()=>o.cancel()),this.defaultFragment=a}setUrlHash(){let e=Ht(this.root),{generation:t}=e;if(t!==this.prevStateGeneration){this.prevStateGeneration=e.generation;let r=Mq(JSON.stringify(e.value));r!==this.prevStateString&&(this.prevStateString=r,decodeURIComponent(r)==="{}"?history.replaceState(null,"","#"):history.replaceState(null,"","#!"+r))}}updateFromUrlHash(){try{let e=location.href.replace(/^[^#]+/,"");if((e===""||e==="#"||e==="#!")&&(e="#!"+this.defaultFragment),e.match(/^#!([a-z][a-z\d+-.]*):\/\//)){let t=e.substring(2),{url:r,credentialsProvider:i}=Dn(t,this.credentialsManager);Ee.forPromise(On(i,r,{},kt).then(a=>{Q(a),this.root.reset(),this.root.restoreState(a)}),{initialMessage:`Loading state from ${t}`,errorPrefix:"Error loading state:"})}else if(e.startsWith("#!+")){e=e.slice(3),e=decodeURIComponent(e);let t=rh(e);Q(t),this.root.restoreState(t),this.prevStateString=void 0}else if(e.startsWith("#!")){if(e=e.slice(2),e=decodeURIComponent(e),e===this.prevStateString)return;this.prevStateString=e,this.root.reset();let t=rh(e);Q(t),this.root.restoreState(t)}else throw new Error('URL hash is expected to be of the form "#!{...}" or "#!+{...}".');this.parseError.value=void 0}catch(e){this.parseError.value=e}}};function Rq(n){let e=new jn,t=new gu;e.add("viewer",t),n.global.addParent(t.eventActionMap,1e3);let r=new gu;e.add("sliceView",r),n.sliceView.addParent(r.eventActionMap,1e3);let i=new gu;e.add("perspectiveView",i),n.perspectiveView.addParent(i.eventActionMap,1e3);let a=new gu;return e.add("dataView",a),n.perspectiveView.addParent(a.eventActionMap,999),n.sliceView.addParent(a.eventActionMap,999),e}function _q(n){let e=new Ce({},t=>{for(let r of Object.keys(t)){let i=t[r];if(typeof i!="number")throw new Error(`Expected key ${JSON.stringify(r)} to have a numeric value, but received: ${JSON.stringify(i)}.`)}return t});return e.changed.add((0,G0.default)(()=>{let t=e.value;for(let r of Object.keys(t))n.setSourceGeneration(r,t[r]);for(let r of n.sourceGenerations.keys())t.hasOwnProperty(r)||n.deleteSourceGeneration(r)},0)),e}window.addEventListener("DOMContentLoaded",()=>{let n=new jn,e=new qw,t=new Yw(e),r=Lm({credentialsManager:new tg(t)}),i=new Vw;r.register("python",i),n.add("sourceGenerations",_q(i));let a=window.viewer=UN({showLayerDialog:!1,resetStateWhenEmpty:!1,dataSourceProvider:r});N1(a.inputEventBindings),n.add("inputEventBindings",Rq(a.inputEventBindings));let o=new V0(a);window.remoteActionHandler=o,n.add("actions",o.actionSet),n.add("statusMessages",new O0);let l=new N0(a);n.add("screenshot",l.requestState);let c=a.state;window.location.hash&&(a.registerDisposer(new U0(a.state,t)).updateFromUrlHash(),c=void 0);let d=new _0(a.display,r,a.dataContext.addRef(),a.uiConfiguration);n.add("prefetch",d);for(let v of Cy)n.add(v,a.uiConfiguration[v]);n.add("scaleBarOptions",a.scaleBarOptions);let p=new Ce(void 0,v=>v==null?void 0:Pe([0,0],v,ze));n.add("viewerSize",p);let h=()=>{let v=a.display.container,b=p.value;if(b===void 0)v.style.position="relative",v.style.width="",v.style.height="",v.style.transform="",v.style.transformOrigin="";else{v.style.position="absolute",v.style.width=`${b[0]}px`,v.style.height=`${b[1]}px`;let x=document.documentElement.clientWidth,C=document.documentElement.clientHeight,T=x/b[0],P=C/b[1],I=Math.min(T,P);v.style.transform=`scale(${I})`,v.style.transformOrigin="top left"}};h(),window.addEventListener("resize",h),p.changed.add((0,G0.default)(()=>h(),0));let g=new Map;g.set("c",new ly(e,n,null)),c!==void 0&&g.set("s",new ly(e,c,100)),new Jw(e,g),o.sendActionRequested.add((v,b)=>e.sendActionNotification(v,b)),l.sendScreenshotRequested.add(v=>e.sendActionNotification("screenshot",v)),l.sendStatisticsRequested.add(v=>e.sendActionNotification("screenshotStatistics",v)),document.addEventListener("clSetVal",()=>{o.sendActionRequested.dispatch("set-color",JSON.parse(JSON.stringify(Ht(a.state).value)))}),document.addEventListener("clClear",()=>{o.sendActionRequested.dispatch("clear-color",JSON.parse(JSON.stringify(Ht(a.state).value)))}),document.addEventListener("prSomaLocCopyLoc",()=>{o.sendActionRequested.dispatch("prSomaLocCopyLocEvent",JSON.parse(JSON.stringify(Ht(a.state).value)))}),document.addEventListener("prSaveNeuron",()=>{o.sendActionRequested.dispatch("save-neuron",JSON.parse(JSON.stringify(Ht(a.state).value)))}),document.addEventListener("dbLoadNeuronNameButton",()=>{o.sendActionRequested.dispatch("dbLoadNeuronNameButtonEvent",JSON.parse(JSON.stringify(Ht(a.state).value)))}),document.addEventListener("dbLoadNeuronNameButton1",()=>{o.sendActionRequested.dispatch("dbLoadNeuronNameButton1Event",JSON.parse(JSON.stringify(Ht(a.state).value)))}),document.addEventListener("dbLoadNeuronNameButton2",()=>{o.sendActionRequested.dispatch("dbLoadNeuronNameButton2Event",JSON.parse(JSON.stringify(Ht(a.state).value)))}),document.addEventListener("dbLoadNeuronNameButton3",()=>{o.sendActionRequested.dispatch("dbLoadNeuronNameButton3Event",JSON.parse(JSON.stringify(Ht(a.state).value)))}),document.addEventListener("dbSearchButton",()=>{o.sendActionRequested.dispatch("search-neuron",JSON.parse(JSON.stringify(Ht(a.state).value)))}),document.addEventListener("clNeuronColorButton",()=>{o.sendActionRequested.dispatch("clNeuronColorButton",JSON.parse(JSON.stringify(Ht(a.state).value)))}),kN(a),EN(a),a.registerDisposer(GN(a.title))});})();
/**
 * /**
 * @license
 * This work is a derivative of the Google Neuroglancer project,
 * Copyright 2016 Google Inc.
 * The Derivative Work is covered by
 * Copyright 2021 Howard Hughes Medical Institute
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2017-2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2018 The Neuroglancer Authors
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2019 The Neuroglancer Authors
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2022 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * This work is a derivative of the Google Neuroglancer project,
 * Copyright 2016 Google Inc.
 * The Derivative Work is covered by
 * Copyright 2019 Howard Hughes Medical Institute
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
//# sourceMappingURL=main.bundle.js.map
